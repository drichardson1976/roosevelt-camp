<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Roosevelt Basketball Day Camp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .font-display { font-family: 'Bebas Neue', sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script src="config.js"></script>
  <script src="release-notes.js"></script>
  <script src="utils.js"></script>
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ==================== VERSION INFO ====================
    const VERSION = "13.164";
    // BUILD_DATE - update this timestamp when committing changes
    const BUILD_DATE = new Date("2026-02-16T00:56:00");

    // ==================== CONSTANTS ====================

    // Camp runs specific weeks in July and August 2026:
    // Week 1: July 13-17, 2026
    // Week 2: August 10-14, 2026
    // Week 3: August 17-21, 2026
    // Week 4: August 24-28, 2026
    const generateCampDates = () => {
      const weeks = [
        // July Week 1: July 13-17, 2026
        ['2026-07-13', '2026-07-14', '2026-07-15', '2026-07-16', '2026-07-17'],
        // August Week 1: August 10-14, 2026
        ['2026-08-10', '2026-08-11', '2026-08-12', '2026-08-13', '2026-08-14'],
        // August Week 2: August 17-21, 2026
        ['2026-08-17', '2026-08-18', '2026-08-19', '2026-08-20', '2026-08-21'],
        // August Week 3: August 24-28, 2026
        ['2026-08-24', '2026-08-25', '2026-08-26', '2026-08-27', '2026-08-28']
      ];
      return weeks.flat();
    };
    const CAMP_DATES = generateCampDates();

    // Format camp date range for display
    const getCampDateRange = () => {
      if (CAMP_DATES.length === 0) return '';
      const start = new Date(CAMP_DATES[0] + 'T12:00:00');
      const end = new Date(CAMP_DATES[CAMP_DATES.length - 1] + 'T12:00:00');
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      return `${months[start.getMonth()]} ${start.getDate()} - ${months[end.getMonth()]} ${end.getDate()}, ${end.getFullYear()}`;
    };
    const CAMP_DATE_RANGE = getCampDateRange();
    
    const getWeeks = () => {
      const weeks = [];
      let currentWeek = [];
      let weekStart = null;
      CAMP_DATES.forEach((date, idx) => {
        const d = new Date(date + 'T12:00:00');
        if (d.getDay() === 1 || idx === 0) {
          if (currentWeek.length > 0) weeks.push({ start: weekStart, dates: currentWeek });
          currentWeek = [date];
          weekStart = date;
        } else {
          currentWeek.push(date);
        }
      });
      if (currentWeek.length > 0) weeks.push({ start: weekStart, dates: currentWeek });
      return weeks;
    };
    const CAMP_WEEKS = getWeeks();

    // ==================== DEFAULT DATA ====================
    const DEFAULT_CONTENT = {
      heroTitle: "Roosevelt Girls Basketball",
      heroSubtitle: "Summer Daycamp 2026",
      heroTagline: "Build Skills. Build Friendships. Build Your Future.",
      heroImage: null,
      venmoImage: null,
      venmoUsername: "@RHSDayCamp",
      aboutText: "Join us for an incredible summer of basketball at Roosevelt High School! Our camp is designed for young athletes who want to develop their basketball skills while having fun and making lasting friendships.",
      contactEmail: "rhsdaycamp@gmail.com",
      contactPhone: "(206) 384-1872",
      sessionMorning: "9:00 AM - 12:00 PM",
      sessionAfternoon: "12:00 PM - 3:00 PM",
      sessionCost: "$60",
      campDates: "Weekdays from July 13-17 & August 10-28, 2026",
      ageRange: "Completed 3rd - 8th Grade",
      // Location details
      locationName: "Roosevelt High School",
      locationAddress: "1410 NE 66th St",
      locationCity: "Seattle",
      locationState: "WA",
      locationZip: "98115",
      locationDetails: "Roosevelt High School Gymnasium - Enter through the main gym entrance on the east side of the building.",
      // Pricing tiers
      singleSessionCost: 60,
      weekDiscount: 10, // percent off for booking full week (10 sessions)
      multiWeekDiscount: 15, // percent off for 2+ weeks
      // Policies
      cancellationPolicy: "All cancellation requests must be submitted at least 14 days (2 weeks) before the scheduled session to receive a full refund. Cancellations made less than 14 days in advance are non-refundable but may be credited toward a future session at the camp director's discretion. No-shows are non-refundable.",
      latePickupPolicy: "Camp sessions end promptly at the scheduled time. Our counselors volunteer their time and have other commitments after camp. If you anticipate being late, please call us immediately. As a gesture of appreciation for counselors who stay late due to delayed pickups, we kindly suggest purchasing a small Starbucks gift card ($5-10) for the counselor who waited with your child. Repeated late pickups may result in dismissal from the camp.",
      scholarshipInfo: "We believe every child deserves the chance to experience our camp. Apply for scholarship assistance through your Parent Dashboard.",
      // Pickup policy illustration images
      pickupPolicyFacePhoto: null,
      pickupPolicyIdPhoto: null
    };

    const DEFAULT_COUNSELORS = [
      { id: 'c1', name: 'Sarah Mitchell', email: 'sarah.mitchell@roosevelt.edu', phone: '(206) 555-0101', position: 'Point Guard', year: 'Senior', bio: 'Team captain with 3 years varsity experience.', photo: null, visible: true, order: 0 },
      { id: 'c2', name: 'Maya Johnson', email: 'maya.johnson@roosevelt.edu', phone: '(206) 555-0102', position: 'Shooting Guard', year: 'Senior', bio: 'Sharpshooter with excellent 3-point range.', photo: null, visible: true, order: 1 },
      { id: 'c3', name: 'Emma Chen', email: 'emma.chen@roosevelt.edu', phone: '(206) 555-0103', position: 'Small Forward', year: 'Junior', bio: 'Versatile player known for lockdown defense.', photo: null, visible: true, order: 2 },
      { id: 'c4', name: 'Jasmine Williams', email: 'jasmine.williams@roosevelt.edu', phone: '(206) 555-0104', position: 'Center', year: 'Junior', bio: 'Starting center with strong post moves.', photo: null, visible: true, order: 3 },
    ];

    const DEFAULT_ADMINS = [
      { id: 'admin_1', username: 'admin', password: 'admin', name: 'Camp Director', email: 'director@rooseveltcamp.com', createdAt: new Date().toISOString() }
    ];

    // Calculate discounted total based on sessions selected
    // - 10% discount for booking a full week (both AM and PM for all 5 days = 10 sessions)
    // - 15% discount for booking 2+ full weeks
    const calculateDiscountedTotal = (selectedDates, numChildren, content) => {
      const basePrice = content.singleSessionCost || 60;
      const weekDiscount = (content.weekDiscount || 10) / 100;
      const multiWeekDiscount = (content.multiWeekDiscount || 15) / 100;

      // Group sessions by week
      const sessionsByWeek = {};
      Object.entries(selectedDates).forEach(([date, sessions]) => {
        if (!sessions?.length) return;
        // Find which week this date belongs to
        const weekIdx = CAMP_WEEKS.findIndex(w => w.dates.includes(date));
        if (weekIdx >= 0) {
          if (!sessionsByWeek[weekIdx]) sessionsByWeek[weekIdx] = { dates: {}, totalSessions: 0 };
          sessionsByWeek[weekIdx].dates[date] = sessions;
          sessionsByWeek[weekIdx].totalSessions += sessions.length;
        }
      });

      // Count full weeks (5 days with both AM and PM = 10 sessions)
      let fullWeeks = 0;
      let fullWeekSessions = 0;
      let partialSessions = 0;

      Object.values(sessionsByWeek).forEach(week => {
        const daysCount = Object.keys(week.dates).length;
        const hasBothSessions = Object.values(week.dates).every(s => s.includes('morning') && s.includes('afternoon'));

        if (daysCount === 5 && hasBothSessions && week.totalSessions === 10) {
          fullWeeks++;
          fullWeekSessions += 10;
        } else {
          partialSessions += week.totalSessions;
        }
      });

      // Calculate pricing
      const children = Math.max(1, numChildren);
      let subtotal = 0;
      let discount = 0;

      if (fullWeeks >= 2) {
        // Multi-week discount applies to all full weeks
        const fullWeekCost = fullWeekSessions * basePrice * children;
        discount = fullWeekCost * multiWeekDiscount;
        subtotal = fullWeekCost - discount + (partialSessions * basePrice * children);
      } else if (fullWeeks === 1) {
        // Single week discount
        const fullWeekCost = fullWeekSessions * basePrice * children;
        discount = fullWeekCost * weekDiscount;
        subtotal = fullWeekCost - discount + (partialSessions * basePrice * children);
      } else {
        // No discount - partial weeks only
        subtotal = (fullWeekSessions + partialSessions) * basePrice * children;
      }

      const totalSessions = fullWeekSessions + partialSessions;
      const originalTotal = totalSessions * basePrice * children;

      return {
        totalSessions,
        fullWeeks,
        partialSessions,
        originalTotal,
        discount,
        discountPercent: fullWeeks >= 2 ? multiWeekDiscount * 100 : fullWeeks === 1 ? weekDiscount * 100 : 0,
        finalTotal: Math.round(subtotal)
      };
    };

    // ==================== STABLE INPUT COMPONENTS ====================
    const StableInput = React.memo(({ value, onSave, type = 'text', className = '', placeholder = '' }) => {
      const [local, setLocal] = useState(value || '');
      const inputRef = useRef(null);
      const initialValue = useRef(value);

      useEffect(() => {
        if (value !== initialValue.current && document.activeElement !== inputRef.current) {
          setLocal(value || '');
          initialValue.current = value;
        }
      }, [value]);

      const handleBlur = () => {
        if (local !== value) {
          onSave(local);
          initialValue.current = local;
        }
      };

      return (
        <input
          ref={inputRef}
          type={type}
          value={local}
          onChange={(e) => setLocal(e.target.value)}
          onBlur={handleBlur}
          className={className}
          placeholder={placeholder}
          autoComplete="off"
          data-1p-ignore="true"
          data-lpignore="true"
          data-form-type="other"
        />
      );
    });

    const StableTextarea = React.memo(({ value, onSave, className = '', placeholder = '', rows = 3 }) => {
      const [local, setLocal] = useState(value || '');
      const ref = useRef(null);
      const initialValue = useRef(value);

      useEffect(() => {
        if (value !== initialValue.current && document.activeElement !== ref.current) {
          setLocal(value || '');
          initialValue.current = value;
        }
      }, [value]);

      const handleBlur = () => {
        if (local !== value) {
          onSave(local);
          initialValue.current = local;
        }
      };

      return (
        <textarea
          ref={ref}
          value={local}
          onChange={(e) => setLocal(e.target.value)}
          onBlur={handleBlur}
          className={className}
          placeholder={placeholder}
          rows={rows}
          autoComplete="off"
          data-1p-ignore="true"
          data-lpignore="true"
          data-form-type="other"
        />
      );
    });

    // ==================== COUNSELOR EDIT FORM ====================
    const CounselorEditForm = ({ counselor, onSave, onCancel, onDelete }) => {
      const [form, setForm] = useState({ ...counselor });
      const [showPhotoModal, setShowPhotoModal] = useState(false);

      const update = (field, value) => {
        setForm(prev => ({ ...prev, [field]: value }));
      };

      return (
        <div className="space-y-4">
          <div className="flex items-center gap-4">
            {getDisplayPhoto(form.photo) ? (
              <img
                src={getDisplayPhoto(form.photo)}
                className="w-20 h-20 rounded-full object-cover border-2 border-green-600 cursor-pointer hover:opacity-80"
                onClick={() => setShowPhotoModal(true)}
              />
            ) : (
              <div onClick={() => setShowPhotoModal(true)} className="w-20 h-20 rounded-full bg-gray-200 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300">
                <svg className="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                <span className="text-[8px] text-gray-500 font-medium">add photo</span>
              </div>
            )}
            <div className="flex-1 text-sm text-gray-500">{getDisplayPhoto(form.photo) ? 'Click photo to update' : 'Click to add photo'}</div>
            {showPhotoModal && (
              <PhotoUploadModal
                currentPhoto={form.photo}
                onSave={(img) => { update('photo', img); setShowPhotoModal(false); }}
                onCancel={() => setShowPhotoModal(false)}
              />
            )}
          </div>

          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
              <input
                value={form.name || ''}
                onChange={e => update('name', e.target.value)}
                className="w-full px-3 py-2 border rounded-lg"
                placeholder="Full name"
                autoComplete="off"
                data-1p-ignore="true"
                data-lpignore="true"
                data-form-type="other"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input
                value={form.email || ''}
                onChange={e => update('email', e.target.value)}
                className="w-full px-3 py-2 border rounded-lg"
                placeholder="email@example.com"
                autoComplete="off"
                data-1p-ignore="true"
                data-lpignore="true"
                data-form-type="other"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
              <input
                value={form.phone || ''}
                onChange={e => update('phone', formatPhone(e.target.value))}
                className="w-full px-3 py-2 border rounded-lg"
                placeholder="(555) 555-1234"
                autoComplete="off"
                data-1p-ignore="true"
                data-lpignore="true"
                data-form-type="other"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Position</label>
              <input
                value={form.position || ''}
                onChange={e => update('position', e.target.value)}
                className="w-full px-3 py-2 border rounded-lg"
                placeholder="Point Guard"
                autoComplete="off"
                data-1p-ignore="true"
                data-lpignore="true"
                data-form-type="other"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Year</label>
              <select value={form.year || ''} onChange={e => update('year', e.target.value)} className="w-full px-3 py-2 border rounded-lg">
                <option value="">Select year</option>
                <option value="Freshman">Freshman</option>
                <option value="Sophomore">Sophomore</option>
                <option value="Junior">Junior</option>
                <option value="Senior">Senior</option>
              </select>
            </div>
            <div className="flex items-center gap-2">
              <input type="checkbox" checked={form.visible !== false} onChange={e => update('visible', e.target.checked)} className="w-5 h-5" />
              <label className="text-sm font-medium text-gray-700">Visible on website</label>
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Bio</label>
            <textarea
              value={form.bio || ''}
              onChange={e => update('bio', e.target.value)}
              className="w-full px-3 py-2 border rounded-lg"
              rows={3}
              placeholder="Short bio..."
              autoComplete="off"
              data-1p-ignore="true"
              data-lpignore="true"
              data-form-type="other"
            />
          </div>

          <div className="flex gap-4 pt-4">
            <button onClick={onCancel} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
            <button onClick={() => onSave(form)} className="flex-1 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Save</button>
          </div>

          {onDelete && counselor?.id && (
            <div className="pt-4 mt-4 border-t">
              <button onClick={() => onDelete(counselor)} className="w-full py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 border border-red-200">
                Delete Counselor
              </button>
            </div>
          )}
        </div>
      );
    };

    // ==================== POLICY CONSTANTS ====================
    const PICKUP_POLICY = `
Only authorized emergency contacts may pick up your child.

Upload a photo for the emergency contact, or remind the emergency contact that they will need to show a valid Photo ID.
    `.trim();

    const DROPOFF_POLICY = `
Please sign in your child with the counselor on duty at the main gym entrance.

Morning sessions: Drop-off is between 8:45 AM - 9:00 AM
Afternoon sessions: Drop-off is between 11:45 AM - 12:00 PM
    `.trim();

    // ==================== PARENT ONBOARDING WIZARD ====================
    const ParentOnboarding = ({ onComplete, onBack, users, saveUsers, saveEmergencyContacts, emergencyContacts, saveOnboardingProgress, campers, saveCampers, saveCamperParentLinks, camperParentLinks }) => {
      const [step, setStep] = useState(1);
      const [userData, setUserData] = useState({ name: '', email: '', phone: '', password: '', photo: null });
      const [showPassword, setShowPassword] = useState(false);
      const [campersData, setCampersData] = useState([]);
      const [emergencyData, setEmergencyData] = useState([]);
      const [policiesAccepted, setPoliciesAccepted] = useState({ pickup: false, dropoff: false });
      const [cardData, setCardData] = useState({ number: '', expiry: '', cvc: '', name: '' });
      const [error, setError] = useState('');
      const [submitting, setSubmitting] = useState(false); // Prevents flash during submission
      // State for adding campers/contacts (moved to parent level to avoid re-renders)
      const [showAddCamper, setShowAddCamper] = useState(false);
      const [newCamper, setNewCamper] = useState({ name: '', birthdate: '', birthYear: '', birthMonth: '', birthDay: '', grade: '', phone: '' });
      const [showAddContact, setShowAddContact] = useState(false);
      const [newContact, setNewContact] = useState({ name: '', phone: '', relationship: '', otherRelationship: '', photo: null });
      // Photo cropping state
      const [showCropper, setShowCropper] = useState(false);
      const [tempImage, setTempImage] = useState(null);
      const [cropTarget, setCropTarget] = useState(null); // 'parent', 'contact', or contact id
      const parentPhotoRef = useRef(null);
      const contactPhotoRef = useRef(null);
      const contactNameRef = useRef(null);

      const totalSteps = 6;

      const steps = [
        { num: 1, title: 'Your Account', icon: 'üë§' },
        { num: 2, title: 'Add Campers', icon: 'üèÄ' },
        { num: 3, title: 'Emergency Contacts', icon: 'üìû' },
        { num: 4, title: 'Payment', icon: 'üí≥' },
        { num: 5, title: 'Policies', icon: 'üìã' },
        { num: 6, title: 'Complete', icon: '‚úÖ' }
      ];

      // Photo upload handler
      const handlePhotoUpload = (e, target) => {
        const file = e.target.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setTempImage(reader.result);
            setCropTarget(target);
            setShowCropper(true);
          };
          reader.readAsDataURL(file);
        }
        if (e.target) e.target.value = '';
      };

      const handleCropSave = (croppedImage) => {
        if (cropTarget === 'parent') {
          setUserData({ ...userData, photo: croppedImage });
        } else if (cropTarget === 'newContact') {
          setNewContact({ ...newContact, photo: croppedImage });
        }
        setShowCropper(false);
        setTempImage(null);
        setCropTarget(null);
      };

      // Credit card number formatting
      const formatCardNumber = (value) => {
        const v = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        const matches = v.match(/\d{4,16}/g);
        const match = matches && matches[0] || '';
        const parts = [];
        for (let i = 0, len = match.length; i < len; i += 4) {
          parts.push(match.substring(i, i + 4));
        }
        return parts.length ? parts.join(' ') : value;
      };

      // Expiry formatting
      const formatExpiry = (value) => {
        const v = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        if (v.length >= 2) {
          return v.substring(0, 2) + '/' + v.substring(2, 4);
        }
        return v;
      };

      // Helper functions for campers
      const addCamper = () => {
        if (!newCamper.name || !newCamper.birthdate || !newCamper.grade) return;
        setCampersData([...campersData, { ...newCamper, id: 'camper_' + Date.now() }]);
        setNewCamper({ name: '', birthdate: '', birthYear: '', birthMonth: '', birthDay: '', grade: '', phone: '' });
        setShowAddCamper(false);
      };

      const removeCamper = (id) => {
        setCampersData(campersData.filter(c => c.id !== id));
      };

      const getEligibility = (grade, birthdate) => {
        const gradeNum = parseInt(grade);
        if (gradeNum >= 3 && gradeNum <= 8) return { eligible: true, status: 'Eligible', color: 'green' };
        if (gradeNum < 3) return { eligible: false, status: 'Too young - must be in 3rd grade or higher', color: 'yellow' };
        return { eligible: false, status: 'Too old - camp is for grades 3-8', color: 'orange' };
      };

      // Helper functions for emergency contacts
      const [contactError, setContactError] = useState('');
      const addContact = () => {
        setContactError('');
        if (!newContact.name || !newContact.phone || !newContact.relationship) return;
        if (newContact.relationship === 'Other' && !newContact.otherRelationship) return;
        if (!isValidPhone(newContact.phone)) {
          setContactError('Please enter a valid 10-digit phone number');
          return;
        }
        setEmergencyData([...emergencyData, {
          ...newContact,
          id: 'contact_' + Date.now(),
          isParent: false,
          priority: emergencyData.length + 2
        }]);
        setNewContact({ name: '', phone: '', relationship: '', otherRelationship: '', photo: null });
        setShowAddContact(false);
      };

      const removeContact = (id) => {
        setEmergencyData(emergencyData.filter(c => c.id !== id));
      };

      const hasNonParentContact = emergencyData.some(c => !c.isParent);

      // Auto-focus on contact name input when adding a new contact
      useEffect(() => {
        if (showAddContact && contactNameRef.current) {
          setTimeout(() => contactNameRef.current?.focus(), 100);
        }
      }, [showAddContact]);

      const validateStep = () => {
        setError('');
        if (step === 1) {
          if (!userData.name || !userData.email || !userData.phone || !userData.password) {
            setError('Please fill in all required fields');
            return false;
          }
          if (!isValidPhone(userData.phone)) {
            setError('Please enter a valid 10-digit phone number: (555) 555-1234');
            return false;
          }
          if (users.some(u => u.email === userData.email)) {
            setError('An account with this email already exists');
            return false;
          }
        }
        // Step 2: Require at least one camper
        if (step === 2) {
          if (campersData.length === 0) {
            setError('Please add at least one camper before continuing');
            return false;
          }
        }
        // Steps 3-4 are skippable, step 5 (Policies) is required
        if (step === 5) {
          if (!policiesAccepted.pickup || !policiesAccepted.dropoff) {
            setError('You must accept both the drop-off and pick-up policies before continuing.');
            return false;
          }
        }
        // Emergency contact phone validation (if adding contacts)
        if (step === 3 && emergencyData.length > 0) {
          const invalidContact = emergencyData.find(c => !isValidPhone(c.phone));
          if (invalidContact) {
            setError(`Please enter a valid 10-digit phone for ${invalidContact.name}`);
            return false;
          }
        }
        return true;
      };

      // Allow completing registration early (skip remaining steps)
      const handleComplete = async () => {
        // Show submitting screen to prevent flash
        setSubmitting(true);

        // Create user account with whatever data we have
        const newUser = {
          email: userData.email,
          name: userData.name,
          phone: userData.phone,
          photo: userData.photo,
          role: 'parent',
          roles: ['parent'],
          onboardingComplete: true,
          onboardingCompletedAt: new Date().toISOString(),
          policiesAccepted: policiesAccepted.pickup && policiesAccepted.dropoff ? {
            pickup: true,
            dropoff: true,
            acceptedAt: new Date().toISOString()
          } : null
        };
        if (userData.password) {
          try {
            const hashRes = await fetch('/.netlify/functions/hash-password', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ password: userData.password })
            });
            const hashData = await hashRes.json();
            if (hashRes.ok) newUser.passwordHash = hashData.passwordHash;
          } catch (e) { /* Continue without hash */ }
        }
        await saveUsers([...users, newUser]);

        // Save campers and create parent links
        if (campersData.length > 0 && saveCampers && saveCamperParentLinks) {
          const newCampers = campersData.map(c => ({
            ...c,
            createdAt: new Date().toISOString()
          }));
          await saveCampers([...(campers || []), ...newCampers]);

          // Create links between campers and this parent
          const newLinks = campersData.map(c => ({
            camperId: c.id,
            parentEmail: userData.email
          }));
          await saveCamperParentLinks([...(camperParentLinks || []), ...newLinks]);
        }

        // Save emergency contacts if any were added
        if (emergencyData.length > 0) {
          const allContacts = [
            { id: 'ec_' + Date.now(), name: userData.name, phone: userData.phone, relationship: 'Parent', isParent: true, priority: 1, userEmail: userData.email },
            ...emergencyData.map((c, i) => ({ ...c, userEmail: userData.email, priority: i + 2 }))
          ];
          await saveEmergencyContacts([...emergencyContacts, ...allContacts]);
        }

        onComplete(newUser);
      };

      const handleNext = async () => {
        if (!validateStep()) return;

        if (step === totalSteps) {
          await handleComplete();
          return;
        }

        setStep(step + 1);
      };

      const handleBack = () => {
        if (step === 1) {
          onBack();
        } else {
          setStep(step - 1);
        }
      };

      // Submitting screen - prevents flash during async operations
      if (submitting) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-green-50 to-green-100 flex items-center justify-center">
            <div className="bg-white rounded-2xl shadow-xl p-8 text-center max-w-md">
              <div className="text-6xl mb-4">üèÄ</div>
              <h2 className="font-display text-2xl text-green-800 mb-2">Creating Your Account...</h2>
              <p className="text-gray-600">Please wait while we save your information.</p>
              <div className="mt-4 flex justify-center">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-green-50 to-green-100 py-8">
          {/* Image Cropper Modal */}
          {showCropper && tempImage && (
            <ImageCropper
              image={tempImage}
              onSave={handleCropSave}
              onCancel={() => { setShowCropper(false); setTempImage(null); setCropTarget(null); }}
              shape="circle"
            />
          )}
          <div className="max-w-lg mx-auto px-4">
            {/* Progress Bar */}
            <div className="mb-6">
              <div className="flex justify-between items-center mb-2">
                {steps.map((s) => (
                  <div
                    key={s.num}
                    className={`flex flex-col items-center ${s.num <= step ? 'text-green-600' : 'text-gray-400'}`}
                  >
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg ${
                      s.num < step ? 'bg-green-600 text-white' :
                      s.num === step ? 'bg-green-100 border-2 border-green-600' : 'bg-gray-200'
                    }`}>
                      {s.num < step ? '‚úì' : s.icon}
                    </div>
                    <span className="text-xs mt-1 hidden sm:block">{s.title}</span>
                  </div>
                ))}
              </div>
              <div className="h-2 bg-gray-200 rounded-full">
                <div
                  className="h-2 bg-green-600 rounded-full transition-all"
                  style={{ width: `${((step - 1) / (totalSteps - 1)) * 100}%` }}
                />
              </div>
            </div>

            {/* Content Card */}
            <div className="bg-white rounded-2xl shadow-xl p-8">
              <h2 className="font-display text-2xl text-green-800 mb-6">
                {steps[step - 1].title}
              </h2>

              {error && (
                <div className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm">
                  {error}
                </div>
              )}

              {/* Step 1: Account Setup */}
              {step === 1 && (
                <div className="space-y-4">
                  <p className="text-gray-600 mb-4">Let's start by creating your account.</p>

                  {/* Photo Upload */}
                  <div className="flex justify-center mb-4">
                    {getDisplayPhoto(userData.photo) ? (
                      <div className="relative">
                        <img src={getDisplayPhoto(userData.photo)} className="w-24 h-24 rounded-full object-cover border-4 border-green-500" />
                        <button onClick={() => parentPhotoRef.current?.click()} className="absolute -bottom-1 -right-1 w-8 h-8 bg-green-600 rounded-full text-white flex items-center justify-center text-sm hover:bg-green-700">‚úé</button>
                        <button onClick={() => setUserData({ ...userData, photo: null })} className="absolute -top-1 -right-1 w-6 h-6 bg-red-500 rounded-full text-white text-xs flex items-center justify-center">√ó</button>
                      </div>
                    ) : (
                      <div onClick={() => parentPhotoRef.current?.click()} className="w-24 h-24 rounded-full bg-gray-200 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300">
                        <svg className="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                        <span className="text-[8px] text-gray-500 font-medium">add photo</span>
                      </div>
                    )}
                    <input ref={parentPhotoRef} type="file" accept="image/*" onChange={(e) => handlePhotoUpload(e, 'parent')} className="hidden" />
                  </div>
                  <p className="text-xs text-gray-500 text-center -mt-2 mb-4">Photo is optional but helps counselors recognize you at drop-off</p>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                    <input
                      value={userData.name}
                      onChange={e => setUserData({ ...userData, name: e.target.value })}
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-green-500 focus:outline-none"
                      placeholder="Your full name"
                      autoComplete="off" data-1p-ignore="true"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                    <input
                      type="email"
                      value={userData.email}
                      onChange={e => setUserData({ ...userData, email: e.target.value })}
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-green-500 focus:outline-none"
                      placeholder="your@email.com"
                      autoComplete="off" data-1p-ignore="true"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                    <input
                      value={userData.phone}
                      onChange={e => setUserData({ ...userData, phone: formatPhone(e.target.value) })}
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-green-500 focus:outline-none"
                      placeholder="(555) 555-1234"
                      autoComplete="off" data-1p-ignore="true"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                    <div className="relative">
                      <input
                        type={showPassword ? 'text' : 'password'}
                        value={userData.password}
                        onChange={e => setUserData({ ...userData, password: e.target.value })}
                        className="w-full px-4 py-3 border-2 rounded-lg focus:border-green-500 focus:outline-none pr-12"
                        placeholder="Create a password"
                        autoComplete="off" data-1p-ignore="true"
                      />
                      <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 text-sm">{showPassword ? 'Hide' : 'Show'}</button>
                    </div>
                  </div>
                </div>
              )}

              {/* Step 2: Add Campers */}
              {step === 2 && (
                <div className="space-y-4">
                  <p className="text-gray-600 mb-4">Add the campers you want to register. You'll select their camp sessions after setup.</p>

                  {campersData.length > 0 && (
                    <div className="space-y-3 mb-4">
                      {campersData.map(camper => {
                        const elig = getEligibility(camper.grade, camper.birthdate);
                        return (
                          <div key={camper.id} className="flex items-center justify-between p-4 bg-gray-50 rounded-lg border">
                            <div>
                              <div className="font-medium">{camper.name}</div>
                              <div className="text-sm text-gray-500">
                                {camper.grade} Grade ‚Ä¢ Age {calculateAge(camper.birthdate)}
                              </div>
                              <span className={`text-xs px-2 py-0.5 rounded ${elig.eligible ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                                {elig.status}
                              </span>
                            </div>
                            <button onClick={() => removeCamper(camper.id)} className="text-red-500 hover:text-red-700 p-2">‚úï</button>
                          </div>
                        );
                      })}
                    </div>
                  )}

                  {showAddCamper ? (
                    <div className="border-2 border-dashed border-green-300 rounded-lg p-4 bg-green-50">
                      <h4 className="font-medium mb-3">Add Camper</h4>
                      <div className="space-y-3">
                        <input
                          value={newCamper.name}
                          onChange={e => setNewCamper({ ...newCamper, name: e.target.value })}
                          placeholder="Camper's full name"
                          className="w-full px-3 py-2 border rounded-lg"
                          autoComplete="off" data-1p-ignore="true"
                        />
                        <div className="space-y-3">
                          {/* Birthdate with year/month/day dropdowns */}
                          <div className="relative border rounded-lg p-3 bg-white">
                            <label className="absolute -top-2 left-2 bg-green-50 px-1 text-xs text-gray-500">Birthdate</label>
                            <div className="grid grid-cols-3 gap-2">
                              <select
                                value={newCamper.birthYear || ''}
                                onChange={e => setNewCamper({ ...newCamper, birthYear: e.target.value, birthdate: e.target.value && newCamper.birthMonth && newCamper.birthDay ? `${e.target.value}-${newCamper.birthMonth}-${newCamper.birthDay}` : '' })}
                                className="w-full px-2 py-1.5 border rounded text-sm"
                              >
                                <option value="">Year</option>
                                {Array.from({ length: 27 }, (_, i) => 2026 - i).map(y => (
                                  <option key={y} value={y}>{y}</option>
                                ))}
                              </select>
                              <select
                                value={newCamper.birthMonth || ''}
                                onChange={e => setNewCamper({ ...newCamper, birthMonth: e.target.value, birthdate: newCamper.birthYear && e.target.value && newCamper.birthDay ? `${newCamper.birthYear}-${e.target.value}-${newCamper.birthDay}` : '' })}
                                className="w-full px-2 py-1.5 border rounded text-sm"
                              >
                                <option value="">Month</option>
                                {['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].map((m, i) => (
                                  <option key={m} value={String(i + 1).padStart(2, '0')}>{m}</option>
                                ))}
                              </select>
                              <select
                                value={newCamper.birthDay || ''}
                                onChange={e => setNewCamper({ ...newCamper, birthDay: e.target.value, birthdate: newCamper.birthYear && newCamper.birthMonth && e.target.value ? `${newCamper.birthYear}-${newCamper.birthMonth}-${e.target.value}` : '' })}
                                className="w-full px-2 py-1.5 border rounded text-sm"
                              >
                                <option value="">Day</option>
                                {Array.from({ length: 31 }, (_, i) => i + 1).map(d => (
                                  <option key={d} value={String(d).padStart(2, '0')}>{d}</option>
                                ))}
                              </select>
                            </div>
                          </div>
                          <select
                            value={newCamper.grade}
                            onChange={e => setNewCamper({ ...newCamper, grade: e.target.value })}
                            className="w-full px-3 py-2 border rounded-lg"
                          >
                            <option value="">Grade (Fall 2026)</option>
                            <option value="K">Kindergarten</option>
                            <option value="1st">1st Grade</option>
                            <option value="2nd">2nd Grade</option>
                            <option value="3rd">3rd Grade</option>
                            <option value="4th">4th Grade</option>
                            <option value="5th">5th Grade</option>
                            <option value="6th">6th Grade</option>
                            <option value="7th">7th Grade</option>
                            <option value="8th">8th Grade</option>
                            <option value="9th">9th Grade</option>
                          </select>
                        </div>
                        <input
                          value={newCamper.phone}
                          onChange={e => setNewCamper({ ...newCamper, phone: formatPhone(e.target.value) })}
                          placeholder="(555) 555-1234 (optional)"
                          className="w-full px-3 py-2 border rounded-lg"
                          autoComplete="off" data-1p-ignore="true"
                        />
                        <div className="flex gap-2">
                          <button onClick={addCamper} disabled={!newCamper.name || !newCamper.birthdate || !newCamper.grade} className="flex-1 py-2 bg-green-600 text-white rounded-lg disabled:bg-gray-300">Add Camper</button>
                          <button onClick={() => setShowAddCamper(false)} className="px-4 py-2 border rounded-lg">Cancel</button>
                        </div>
                      </div>
                    </div>
                  ) : (
                    <button onClick={() => setShowAddCamper(true)} className="w-full py-4 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-green-500 hover:text-green-600">+ Add a Camper</button>
                  )}

                  {campersData.length === 0 && (
                    <p className="text-sm text-gray-500 text-center mt-4">Add at least one camper to continue. You can add more campers later.</p>
                  )}
                </div>
              )}

              {/* Step 3: Emergency Contacts */}
              {step === 3 && (
                <div className="space-y-4">
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm text-yellow-800">
                    <strong>Required:</strong> At least 3 emergency contacts, including at least 1 who is not a parent (grandparent, neighbor, etc.)
                  </div>

                  {/* Parent auto-contact */}
                  <div className="p-4 bg-green-50 rounded-lg border border-green-200">
                    <div className="flex items-center gap-3">
                      {getDisplayPhoto(userData.photo) ? (
                        <img src={getDisplayPhoto(userData.photo)} className="w-10 h-10 rounded-full object-cover border-2 border-green-500" />
                      ) : (
                        <div className="w-10 h-10 rounded-full bg-gray-200 flex flex-col items-center justify-center">
                          <svg className="w-3 h-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                          <span className="text-[5px] text-gray-500 font-medium">add photo</span>
                        </div>
                      )}
                      <div>
                        <div className="font-medium">{userData.name}</div>
                        <div className="text-sm text-gray-500">{userData.phone} ‚Ä¢ Parent (you)</div>
                      </div>
                      <span className="ml-auto text-green-600 text-sm">‚úì Auto-added</span>
                    </div>
                  </div>

                  {/* Additional contacts */}
                  {emergencyData.map((contact, idx) => (
                    <div key={contact.id} className="p-4 bg-gray-50 rounded-lg border flex items-center gap-3">
                      {getDisplayPhoto(contact.photo) ? (
                        <img src={getDisplayPhoto(contact.photo)} className="w-10 h-10 rounded-full object-cover border-2 border-gray-400" />
                      ) : (
                        <div className="w-10 h-10 rounded-full bg-gray-200 flex flex-col items-center justify-center">
                          <svg className="w-3 h-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                          <span className="text-[5px] text-gray-500 font-medium">add photo</span>
                        </div>
                      )}
                      <div>
                        <div className="font-medium">{contact.name}</div>
                        <div className="text-sm text-gray-500">{contact.phone} ‚Ä¢ {contact.relationship === 'Other' && contact.otherRelationship ? `Other: ${contact.otherRelationship}` : contact.relationship}</div>
                      </div>
                      <button onClick={() => removeContact(contact.id)} className="ml-auto text-red-500 hover:text-red-700 p-2">‚úï</button>
                    </div>
                  ))}

                  {showAddContact ? (
                    <div className="border-2 border-dashed border-blue-300 rounded-lg p-4 bg-blue-50">
                      <h4 className="font-medium mb-3">Add Emergency Contact</h4>
                      <div className="space-y-3">
                        {/* Photo Upload */}
                        <div className="flex justify-center mb-2">
                          {getDisplayPhoto(newContact.photo) ? (
                            <div className="relative">
                              <img src={getDisplayPhoto(newContact.photo)} className="w-16 h-16 rounded-full object-cover border-2 border-blue-500" />
                              <button onClick={() => contactPhotoRef.current?.click()} className="absolute -bottom-1 -right-1 w-6 h-6 bg-blue-600 rounded-full text-white flex items-center justify-center text-xs hover:bg-blue-700">‚úé</button>
                              <button onClick={() => setNewContact({ ...newContact, photo: null })} className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-white text-xs flex items-center justify-center">√ó</button>
                            </div>
                          ) : (
                            <div onClick={() => contactPhotoRef.current?.click()} className="w-16 h-16 rounded-full bg-gray-200 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300">
                              <svg className="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                              <span className="text-[8px] text-gray-500 font-medium">add photo</span>
                            </div>
                          )}
                          <input ref={contactPhotoRef} type="file" accept="image/*" onChange={(e) => handlePhotoUpload(e, 'newContact')} className="hidden" />
                        </div>
                        <p className="text-xs text-gray-500 text-center -mt-1 mb-2">Photo helps identify authorized pickup (optional)</p>
                        <input
                          ref={contactNameRef}
                          value={newContact.name}
                          onChange={e => setNewContact({ ...newContact, name: e.target.value })}
                          placeholder="Contact's full name"
                          className="w-full px-3 py-2 border rounded-lg"
                          autoComplete="off" data-1p-ignore="true"
                        />
                        <input
                          value={newContact.phone}
                          onChange={e => setNewContact({ ...newContact, phone: formatPhone(e.target.value) })}
                          placeholder="(555) 555-1234"
                          className="w-full px-3 py-2 border rounded-lg"
                          autoComplete="off" data-1p-ignore="true"
                        />
                        <select
                          value={newContact.relationship}
                          onChange={e => setNewContact({ ...newContact, relationship: e.target.value })}
                          className="w-full px-3 py-2 border rounded-lg"
                        >
                          <option value="">Relationship to child</option>
                          <option value="Parent">Parent</option>
                          <option value="Legal Guardian">Legal Guardian</option>
                          <option value="Relative">Relative</option>
                          <option value="Caretaker">Caretaker</option>
                          <option value="Family Friend">Family Friend</option>
                          <option value="Other">Other</option>
                        </select>
                        {newContact.relationship === 'Other' && (
                          <input
                            value={newContact.otherRelationship}
                            onChange={e => setNewContact({ ...newContact, otherRelationship: e.target.value })}
                            placeholder="Please specify relationship"
                            className="w-full px-3 py-2 border rounded-lg"
                            autoComplete="off" data-1p-ignore="true"
                          />
                        )}
                        {contactError && (
                          <p className="text-sm text-red-600">{contactError}</p>
                        )}
                        <div className="flex gap-2">
                          <button onClick={addContact} disabled={!newContact.name || !newContact.phone || !newContact.relationship || (newContact.relationship === 'Other' && !newContact.otherRelationship)} className="flex-1 py-2 bg-blue-600 text-white rounded-lg disabled:bg-gray-300">Add Contact</button>
                          <button onClick={() => { setShowAddContact(false); setNewContact({ name: '', phone: '', relationship: '', otherRelationship: '', photo: null }); setContactError(''); }} className="px-4 py-2 border rounded-lg">Cancel</button>
                        </div>
                      </div>
                    </div>
                  ) : (
                    <button onClick={() => { setShowAddContact(true); setContactError(''); }} className="w-full py-4 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-500 hover:text-blue-600">+ Add Emergency Contact</button>
                  )}

                </div>
              )}

              {/* Step 4: Payment (Optional) */}
              {step === 4 && (
                <div className="space-y-6">
                  <p className="text-gray-600">Add a payment method for faster checkout. You can skip this for now.</p>

                  <div className="bg-gradient-to-r from-slate-800 to-slate-900 rounded-xl p-6 text-white">
                    <div className="flex justify-between items-start mb-8">
                      <div className="text-xs uppercase tracking-wider opacity-60">Credit Card</div>
                      <div className="flex gap-2">
                        <div className="w-10 h-6 bg-gradient-to-r from-blue-500 to-blue-700 rounded flex items-center justify-center text-xs font-bold">VISA</div>
                        <div className="w-10 h-6 bg-gradient-to-r from-red-500 to-yellow-500 rounded flex items-center justify-center text-xs font-bold">MC</div>
                      </div>
                    </div>
                    <div className="font-mono text-xl tracking-wider mb-6">
                      {cardData.number || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}
                    </div>
                    <div className="flex justify-between text-sm">
                      <div>
                        <div className="text-xs opacity-60 uppercase">Card Holder</div>
                        <div>{cardData.name || 'YOUR NAME'}</div>
                      </div>
                      <div>
                        <div className="text-xs opacity-60 uppercase">Expires</div>
                        <div>{cardData.expiry || 'MM/YY'}</div>
                      </div>
                    </div>
                  </div>

                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Card Number</label>
                      <input
                        value={cardData.number}
                        onChange={e => setCardData({ ...cardData, number: formatCardNumber(e.target.value) })}
                        className="w-full px-4 py-3 border-2 rounded-lg focus:border-green-500 focus:outline-none font-mono"
                        placeholder="1234 5678 9012 3456"
                        maxLength={19}
                        autoComplete="off" data-1p-ignore="true"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Cardholder Name</label>
                      <input
                        value={cardData.name}
                        onChange={e => setCardData({ ...cardData, name: e.target.value.toUpperCase() })}
                        className="w-full px-4 py-3 border-2 rounded-lg focus:border-green-500 focus:outline-none"
                        placeholder="JOHN DOE"
                        autoComplete="off" data-1p-ignore="true"
                      />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
                        <input
                          value={cardData.expiry}
                          onChange={e => setCardData({ ...cardData, expiry: formatExpiry(e.target.value) })}
                          className="w-full px-4 py-3 border-2 rounded-lg focus:border-green-500 focus:outline-none"
                          placeholder="MM/YY"
                          maxLength={5}
                          autoComplete="off" data-1p-ignore="true"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">CVC</label>
                        <input
                          value={cardData.cvc}
                          onChange={e => setCardData({ ...cardData, cvc: e.target.value.replace(/\D/g, '').slice(0, 4) })}
                          className="w-full px-4 py-3 border-2 rounded-lg focus:border-green-500 focus:outline-none"
                          placeholder="123"
                          maxLength={4}
                          type="password"
                          autoComplete="off" data-1p-ignore="true"
                        />
                      </div>
                    </div>
                  </div>

                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <p className="text-yellow-800 text-sm">
                      <strong>üîê Secure Payment:</strong> Card payments will be processed through Stripe (coming soon). For now, you can skip this step and pay via Venmo.
                    </p>
                  </div>

                  <button
                    onClick={() => setStep(5)}
                    className="w-full py-3 text-gray-500 hover:text-gray-700 text-sm"
                  >
                    Skip for now ‚Üí
                  </button>
                </div>
              )}

              {/* Step 5: Policies */}
              {step === 5 && (
                <div className="space-y-6">
                  <p className="text-gray-600">Please review and acknowledge our camp policies.</p>

                  <div className="bg-white border rounded-lg overflow-hidden">
                    <div className="bg-green-100 px-4 py-2 font-medium text-green-800">üì• Drop-off Policy</div>
                    <div className="p-4">
                      <pre className="whitespace-pre-wrap text-sm text-gray-600 font-sans">{DROPOFF_POLICY}</pre>
                      <label className="flex items-center gap-3 mt-4 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={policiesAccepted.dropoff}
                          onChange={e => setPoliciesAccepted({ ...policiesAccepted, dropoff: e.target.checked })}
                          className="w-5 h-5 text-green-600"
                        />
                        <span className="text-sm">I have read and agree to the drop-off policy</span>
                      </label>
                    </div>
                  </div>

                  <div className="bg-white border rounded-lg overflow-hidden">
                    <div className="bg-blue-100 px-4 py-2 font-medium text-blue-800">üì§ Pick-up Policy</div>
                    <div className="p-4">
                      <pre className="whitespace-pre-wrap text-sm text-gray-600 font-sans">{PICKUP_POLICY}</pre>
                      <label className="flex items-center gap-3 mt-4 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={policiesAccepted.pickup}
                          onChange={e => setPoliciesAccepted({ ...policiesAccepted, pickup: e.target.checked })}
                          className="w-5 h-5 text-blue-600"
                        />
                        <span className="text-sm">I have read and agree to the pick-up policy</span>
                      </label>
                    </div>
                  </div>
                </div>
              )}

              {/* Step 6: Complete */}
              {step === 6 && (
                <div className="text-center space-y-6">
                  <div className="text-6xl">üéâ</div>
                  <h3 className="font-display text-2xl text-green-800">You're All Set!</h3>
                  <p className="text-gray-600">Your account is ready. You can now register your campers for sessions!</p>

                  <div className="bg-gray-50 rounded-lg p-4 text-left">
                    <h4 className="font-medium mb-2">Account Summary:</h4>
                    <p className="text-sm text-gray-600">‚Ä¢ {userData.name} ({userData.email})</p>
                    <p className="text-sm text-gray-600">‚Ä¢ {campersData.length} camper{campersData.length !== 1 ? 's' : ''} added</p>
                    <p className="text-sm text-gray-600">‚Ä¢ {emergencyData.length + 1} emergency contact{emergencyData.length !== 0 ? 's' : ''}</p>
                    {cardData.number && <p className="text-sm text-gray-600">‚Ä¢ Payment method saved</p>}
                  </div>

                  <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                    <p className="text-green-800 font-medium">Next Step: Register for Sessions</p>
                    <p className="text-sm text-green-700 mt-1">Go to the Register tab to sign up your campers for camp dates!</p>
                  </div>
                </div>
              )}

              {/* Navigation */}
              <div className="flex flex-col gap-3 mt-8">
                <div className="flex gap-4">
                  <button
                    onClick={handleBack}
                    className="flex-1 py-3 border-2 border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
                  >
                    {step === 1 ? '‚Üê Back' : '‚Üê Previous'}
                  </button>
                  <button
                    onClick={handleNext}
                    className="flex-1 py-3 bg-green-700 hover:bg-green-800 text-white font-bold rounded-lg"
                  >
                    {step === totalSteps ? 'Complete Setup' : 'Continue ‚Üí'}
                  </button>
                </div>
                {/* Skip to Policies option for steps 2-4 (Policies step 5 is required) */}
                {step > 1 && step < 5 && (
                  <button
                    onClick={() => setStep(5)}
                    className="w-full py-2 text-gray-500 hover:text-green-700 text-sm border border-gray-200 rounded-lg hover:border-green-300"
                  >
                    Skip to policies & finish setup ‚Üí
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ==================== PARENTS TAB ====================
    const ParentsTab = ({ parents, registrations, onUpdateParents, onDeleteParent, onUpdateRegistrations, onDeleteRegistration, showToast, addToHistory, campers, camperParentLinks, onSaveLinks, onSaveCampers, onSaveCamperParentLinks, emergencyContacts, saveEmergencyContacts, saveOnboardingProgress }) => {
      const [searchTerm, setSearchTerm] = useState('');
      const [selectedParents, setSelectedParents] = useState([]);
      const [expandedParent, setExpandedParent] = useState(null);
      // Admin edit/delete state
      const [editingParent, setEditingParent] = useState(null);
      const [editingChild, setEditingChild] = useState(null);
      const [editingReg, setEditingReg] = useState(null);
      const [confirmDelete, setConfirmDelete] = useState(null); // { type: 'parent'|'child'|'registration', data: ... }
      // Add parent state - use full onboarding flow
      const [showAddParent, setShowAddParent] = useState(false);
      // Manage campers for parent
      const [managingCampers, setManagingCampers] = useState(null);
      // Create registration for parent
      const [creatingRegFor, setCreatingRegFor] = useState(null); // parent object
      const [newReg, setNewReg] = useState({ camperId: '', date: '', sessions: [] });

      // Get all campers
      const getAllCampers = () => campers || [];

      // Get campers linked to a parent
      const getParentCampers = (parentEmail) => {
        const linkedCamperIds = (camperParentLinks || [])
          .filter(l => l.parentEmail === parentEmail)
          .map(l => l.camperId);
        return (campers || []).filter(c => linkedCamperIds.includes(c.id));
      };

      
      const toggleCamperLink = (parentEmail, camperId) => {
        const exists = (camperParentLinks || []).some(l => l.camperId === camperId && l.parentEmail === parentEmail);
        if (exists) {
          onSaveLinks(camperParentLinks.filter(l => !(l.camperId === camperId && l.parentEmail === parentEmail)));
        } else {
          onSaveLinks([...(camperParentLinks || []), { camperId, parentEmail }]);
        }
      };

      const parentUsers = parents; // Now using separate parents table
      const filteredUsers = parentUsers.filter(u =>
        u.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        u.email?.toLowerCase().includes(searchTerm.toLowerCase())
      );

      const getParentRegs = (email) => registrations.filter(r => r.parentEmail === email);

      const toggleSelectParent = (email) => {
        setSelectedParents(prev =>
          prev.includes(email) ? prev.filter(e => e !== email) : [...prev, email]
        );
      };

      const selectAll = () => {
        if (selectedParents.length === filteredUsers.length) {
          setSelectedParents([]);
        } else {
          setSelectedParents(filteredUsers.map(u => u.email));
        }
      };

      return (
        <div className="space-y-6">
          {/* Header with search and actions */}
          <div className="bg-white rounded-xl shadow p-6">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
              <div>
                <h3 className="font-bold text-xl text-green-800">üë®‚Äçüë©‚Äçüëß Parents</h3>
                <p className="text-sm text-gray-500">{parentUsers.length} registered parents</p>
              </div>
              <div className="flex gap-2">
                <button
                  onClick={() => setShowAddParent(true)}
                  className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                >
                  + Add Parent
                </button>
              </div>
            </div>

            {/* Search */}
            <div className="flex gap-4 items-center">
              <input
                value={searchTerm}
                onChange={e => setSearchTerm(e.target.value)}
                placeholder="Search parents by name or email..."
                className="flex-1 px-4 py-2 border rounded-lg"
                autoComplete="off"
                data-1p-ignore="true"
              />
              <label className="flex items-center gap-2 text-sm text-gray-600">
                <input
                  type="checkbox"
                  checked={selectedParents.length === filteredUsers.length && filteredUsers.length > 0}
                  onChange={selectAll}
                  className="w-4 h-4"
                />
                Select All
              </label>
            </div>
          </div>

          {/* Parents List */}
          {filteredUsers.length === 0 ? (
            <div className="bg-white rounded-xl shadow p-12 text-center text-gray-500">
              <p className="text-4xl mb-4">üë®‚Äçüë©‚Äçüëß</p>
              <p>{parentUsers.length === 0 ? 'No parents have registered yet' : 'No parents match your search'}</p>
            </div>
          ) : (
            <div className="space-y-4">
              {filteredUsers.map(parent => {
                const regs = getParentRegs(parent.email);
                const isExpanded = expandedParent === parent.email;
                const countParentOrders = (filterFn) => new Set(regs.filter(filterFn).map(r => r.orderId || r.id)).size;
                const newRegs = countParentOrders(r => r.status === 'pending' && r.paymentStatus === 'unpaid');
                const pendingRegs = countParentOrders(r => r.status === 'pending' && ['sent', 'submitted'].includes(r.paymentStatus));
                const approvedRegs = countParentOrders(r => r.status === 'approved');
                const campersList = getParentCampers(parent.email);

                return (
                  <div key={parent.email} className="bg-white rounded-xl shadow overflow-hidden">
                    {/* Parent Header */}
                    <div className="p-4 flex items-center gap-4">
                      <input
                        type="checkbox"
                        checked={selectedParents.includes(parent.email)}
                        onChange={() => toggleSelectParent(parent.email)}
                        className="w-5 h-5"
                      />

                      <div
                        className="flex-1 cursor-pointer"
                        onClick={() => setExpandedParent(isExpanded ? null : parent.email)}
                      >
                        <div className="flex items-center gap-3">
                          <div className="w-12 h-12 rounded-full bg-green-200 flex items-center justify-center text-xl font-bold text-green-700">
                            {parent.name?.[0]?.toUpperCase() || '?'}
                          </div>
                          <div>
                            <div className="flex items-center gap-2">
                              <span className="font-bold text-gray-800">{parent.name}</span>
                              {(() => {
                                const hasGoogle = parent.googleLinked || parent.lastLoginMethod === 'Google';
                                const hasPassword = !!parent.password;
                                if (hasGoogle && hasPassword) return <span className="text-xs px-2 py-0.5 rounded-full font-medium bg-purple-100 text-purple-700">üîë Google + Email/Password</span>;
                                if (hasGoogle) return <span className="text-xs px-2 py-0.5 rounded-full font-medium bg-purple-100 text-purple-700">G Google</span>;
                                if (hasPassword) return <span className="text-xs px-2 py-0.5 rounded-full font-medium bg-blue-100 text-blue-700">üîë Email/Password</span>;
                                return <span className="text-xs px-2 py-0.5 rounded-full font-medium bg-gray-100 text-gray-500">‚ö†Ô∏è No Login</span>;
                              })()}
                            </div>
                            <div className="text-sm text-gray-500">{parent.email}</div>
                            {parent.phone && <div className="text-sm text-gray-500">{parent.phone}</div>}
                          </div>
                        </div>
                      </div>

                      {/* Stats */}
                      <div className="flex gap-3 text-center flex-wrap">
                        <div title="Campers linked to this parent">
                          <div className="text-lg font-bold text-teal-600">{campersList.length}</div>
                          <div className="text-xs text-gray-500">Campers</div>
                        </div>
                        <div title="New registrations (unpaid)">
                          <div className={`text-lg font-bold ${newRegs > 0 ? 'text-red-600' : 'text-gray-400'}`}>{newRegs}</div>
                          <div className="text-xs text-gray-500">New</div>
                        </div>
                        <div title="Pending approval (payment sent)">
                          <div className={`text-lg font-bold ${pendingRegs > 0 ? 'text-yellow-600' : 'text-gray-400'}`}>{pendingRegs}</div>
                          <div className="text-xs text-gray-500">Pending</div>
                        </div>
                        <div title="Paid registrations">
                          <div className={`text-lg font-bold ${approvedRegs > 0 ? 'text-green-600' : 'text-gray-400'}`}>{approvedRegs}</div>
                          <div className="text-xs text-gray-500">Paid</div>
                        </div>
                      </div>

                      {/* Actions */}
                      <div className="flex gap-2">
                        <button
                          onClick={() => setExpandedParent(isExpanded ? null : parent.email)}
                          className="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-sm"
                        >
                          {isExpanded ? '‚ñ≤ Less' : '‚ñº More'}
                        </button>
                      </div>
                    </div>

                    {/* Expanded Details */}
                    {isExpanded && (
                      <div className="border-t bg-gray-50 p-4">
                        {/* Admin Actions Bar */}
                        <div className="flex gap-2 mb-4 pb-4 border-b">
                          <button
                            onClick={() => setEditingParent({ ...parent, originalEmail: parent.email })}
                            className="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm"
                          >
                            ‚úèÔ∏è Edit Parent
                          </button>
                          <button
                            onClick={() => setConfirmDelete({ type: 'parent', data: parent })}
                            className="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 text-sm"
                          >
                            üóëÔ∏è Delete Parent
                          </button>
                          {(parent.password || parent.lastLoginMethod) && (
                            <button
                              onClick={async () => {
                                try {
                                  const hasGoogle = parent.googleLinked || parent.lastLoginMethod === 'Google';
                                  const hasPassword = !!parent.password;
                                  let methodHtml = '';
                                  if (hasGoogle && hasPassword) {
                                    methodHtml = '<p><strong>Login methods:</strong></p><ul><li>Sign in with Google (using your Google account)</li><li>Email &amp; Password (using your email and password)</li></ul><p>If you\'ve forgotten your password, you can reset it from the login page by clicking "Forgot Password?"</p>';
                                  } else if (hasGoogle) {
                                    methodHtml = '<p><strong>Login method:</strong> Sign in with Google</p><p>Click the "Sign in with Google" button on the login page and use your Google account.</p>';
                                  } else {
                                    methodHtml = '<p><strong>Login method:</strong> Email &amp; Password</p><p>If you\'ve forgotten your password, you can reset it from the login page by clicking "Forgot Password?"</p>';
                                  }
                                  const res = await fetch('/.netlify/functions/send-email', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                      to: parent.email,
                                      subject: 'Your Roosevelt Basketball Day Camp Login Info',
                                      html: `<div style="font-family: Arial, sans-serif; max-width: 500px; margin: 0 auto;"><h2 style="color: #15803d;">Your Login Information</h2><p>Hi ${parent.name},</p><p>Here's a reminder of how to log in to Roosevelt Basketball Day Camp:</p><p><strong>Email:</strong> ${parent.email}</p>${methodHtml}<p><a href="https://rhsbasketballdaycamp.com/#login" style="display: inline-block; background-color: #15803d; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; font-weight: bold;">Go to Login</a></p></div>`
                                    })
                                  });
                                  if (res.ok) showToast(`Login reminder sent to ${parent.email}`);
                                  else showToast('Failed to send reminder');
                                } catch (err) { showToast('Failed to send reminder'); }
                              }}
                              className="px-3 py-1.5 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 text-sm"
                            >
                              üìß Send Login Reminder
                            </button>
                          )}
                        </div>

                        <div className="grid md:grid-cols-2 gap-6">
                          {/* Children */}
                          <div>
                            <div className="flex justify-between items-center mb-3">
                              <h4 className="font-bold text-gray-700">üèÄ Campers ({getParentCampers(parent.email).length})</h4>
                              <button
                                onClick={() => setManagingCampers(parent)}
                                className="text-xs text-blue-600 hover:underline"
                              >
                                Manage Campers
                              </button>
                            </div>
                            {getParentCampers(parent.email).length === 0 ? (
                              <p className="text-gray-500 text-sm">No campers linked yet. Click "Manage Campers" to add.</p>
                            ) : (
                              <div className="space-y-2">
                                {getParentCampers(parent.email).map(camper => (
                                  <div key={camper.id} className="flex items-center gap-3 p-2 bg-white rounded-lg">
                                    {getDisplayPhoto(camper.photo) ? (
                                      <img src={getDisplayPhoto(camper.photo)} className="w-10 h-10 rounded-full object-cover" />
                                    ) : (
                                      <div className="w-10 h-10 rounded-full bg-gray-200 flex flex-col items-center justify-center">
                                        <svg className="w-3 h-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                                        <span className="text-[5px] text-gray-500 font-medium">add photo</span>
                                      </div>
                                    )}
                                    <div className="flex-1">
                                      <div className="font-medium">{camper.name}</div>
                                      <div className="text-xs text-gray-500">
                                        {camper.grade && `Grade ${camper.grade}`}
                                        {camper.birthdate && ` ‚Ä¢ ${calculateAge(camper.birthdate)} years old`}
                                      </div>
                                    </div>
                                    <div className="flex gap-1">
                                      <button
                                        onClick={() => setEditingChild({ child: { ...camper }, parentEmail: parent.email, originalChildId: camper.id })}
                                        className="p-1 text-blue-600 hover:bg-blue-50 rounded"
                                        title="Edit camper"
                                      >‚úèÔ∏è</button>
                                      <button
                                        onClick={() => setConfirmDelete({ type: 'camper', data: { camper, parentEmail: parent.email } })}
                                        className="p-1 text-red-600 hover:bg-red-50 rounded"
                                        title="Delete camper"
                                      >üóëÔ∏è</button>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>

                          {/* Registrations */}
                          <div>
                            <div className="flex justify-between items-center mb-3">
                              <h4 className="font-bold text-gray-700">üìã Registrations ({new Set(regs.map(r => r.orderId || r.id)).size})</h4>
                              {campersList.length > 0 && (
                                <button
                                  onClick={() => { setCreatingRegFor(parent); setNewReg({ camperId: '', date: '', sessions: [] }); }}
                                  className="text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200"
                                >
                                  + Create Registration
                                </button>
                              )}
                            </div>
                            {regs.length === 0 ? (
                              <p className="text-gray-500 text-sm">{campersList.length === 0 ? 'Add campers first to create registrations' : 'No registrations yet'}</p>
                            ) : (() => {
                              const byOrder = {};
                              regs.forEach(r => { const k = r.orderId || r.id; if (!byOrder[k]) byOrder[k] = []; byOrder[k].push(r); });
                              return (
                                <div className="space-y-2 max-h-64 overflow-y-auto">
                                  {Object.entries(byOrder).map(([orderKey, orderRegs]) => {
                                    const status = orderRegs[0]?.status || 'pending';
                                    const paymentStatus = orderRegs[0]?.paymentStatus || 'unpaid';
                                    const byCamper = {};
                                    orderRegs.forEach(r => { const n = r.childName || r.camperName || 'Unknown'; if (!byCamper[n]) byCamper[n] = []; byCamper[n].push(r); });
                                    const camperNames = Object.keys(byCamper);
                                    const totalDays = new Set(orderRegs.map(r => r.date)).size;
                                    const statusLabel = status === 'approved' ? 'paid' : paymentStatus === 'unpaid' ? 'new' : 'pending';
                                    return (
                                      <div key={orderKey} className="p-3 bg-white rounded-lg text-sm">
                                        <div className="flex items-center justify-between mb-1">
                                          <div className="font-medium">{camperNames.join(' & ')}</div>
                                          <div className="flex items-center gap-2">
                                            <span className={`px-2 py-0.5 rounded text-xs ${
                                              statusLabel === 'paid' ? 'bg-green-100 text-green-700' :
                                              statusLabel === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                                              'bg-red-100 text-red-700'
                                            }`}>{statusLabel}</span>
                                            <button onClick={() => setEditingReg(orderRegs[0])} className="p-1 text-blue-600 hover:bg-blue-50 rounded" title="Edit registration">‚úèÔ∏è</button>
                                            <button onClick={() => setConfirmDelete({ type: 'registration', data: orderRegs[0] })} className="p-1 text-red-600 hover:bg-red-50 rounded" title="Delete registration">üóëÔ∏è</button>
                                          </div>
                                        </div>
                                        <div className="text-xs text-gray-500">
                                          {camperNames.length} camper{camperNames.length > 1 ? 's' : ''} ‚Ä¢ {totalDays} day{totalDays > 1 ? 's' : ''} ‚Ä¢ {orderRegs[0]?.sessions?.join(' + ') || ''}
                                        </div>
                                      </div>
                                    );
                                  })}
                                </div>
                              );
                            })()}
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )}

          {/* Edit Parent Modal */}
          {editingParent && (
            <AdminEditModal
              title="Edit Parent"
              onClose={() => setEditingParent(null)}
              onSave={() => {
                onUpdateUsers(users.map(u => u.email === editingParent.originalEmail ? { ...u, name: editingParent.name, email: editingParent.email, phone: editingParent.phone } : u));
                addToHistory('Admin Edit', `Updated parent: ${editingParent.name}`, [editingParent.email]);
                showToast('Parent updated!');
                setEditingParent(null);
              }}
            >
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
                  <input
                    value={editingParent.name || ''}
                    onChange={e => setEditingParent({ ...editingParent, name: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                    autoComplete="off" data-1p-ignore="true"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                  <input
                    value={editingParent.email || ''}
                    onChange={e => setEditingParent({ ...editingParent, email: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                    autoComplete="off" data-1p-ignore="true"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                  <input
                    value={editingParent.phone || ''}
                    onChange={e => setEditingParent({ ...editingParent, phone: formatPhone(e.target.value) })}
                    className="w-full px-3 py-2 border rounded-lg"
                    autoComplete="off" data-1p-ignore="true"
                  />
                </div>
              </div>
            </AdminEditModal>
          )}

          {/* Edit Child Modal */}
          {editingChild && (
            <AdminEditModal
              title="Edit Child"
              onClose={() => setEditingChild(null)}
              onSave={() => {
                const parent = users.find(u => u.email === editingChild.parentEmail);
                if (parent) {
                  const updatedChildren = parent.children.map(c => c.id === editingChild.originalChildId ? { ...editingChild.child } : c);
                  onUpdateUsers(users.map(u => u.email === editingChild.parentEmail ? { ...u, children: updatedChildren } : u));
                  addToHistory('Admin Edit', `Updated child: ${editingChild.child.name}`, [editingChild.parentEmail]);
                  showToast('Child updated!');
                }
                setEditingChild(null);
              }}
            >
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
                  <input
                    value={editingChild.child.name || ''}
                    onChange={e => setEditingChild({ ...editingChild, child: { ...editingChild.child, name: e.target.value } })}
                    className="w-full px-3 py-2 border rounded-lg"
                    autoComplete="off" data-1p-ignore="true"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Birthdate</label>
                  <input
                    type="date"
                    value={editingChild.child.birthdate || ''}
                    onChange={e => setEditingChild({ ...editingChild, child: { ...editingChild.child, birthdate: e.target.value } })}
                    className="w-full px-3 py-2 border rounded-lg"
                    min={new Date(new Date().getFullYear() - 15, 0, 1).toISOString().split('T')[0]}
                    max={new Date().toISOString().split('T')[0]}
                    data-1p-ignore="true"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Grade</label>
                  <select
                    value={editingChild.child.grade || ''}
                    onChange={e => setEditingChild({ ...editingChild, child: { ...editingChild.child, grade: e.target.value } })}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="">Select grade</option>
                    {['3rd', '4th', '5th', '6th', '7th', '8th'].map(g => <option key={g} value={g}>{g} Grade</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Phone (optional)</label>
                  <input
                    value={editingChild.child.phone || ''}
                    onChange={e => setEditingChild({ ...editingChild, child: { ...editingChild.child, phone: formatPhone(e.target.value) } })}
                    className="w-full px-3 py-2 border rounded-lg"
                    autoComplete="off" data-1p-ignore="true"
                  />
                </div>
              </div>
            </AdminEditModal>
          )}

          {/* Create Registration Modal */}
          {creatingRegFor && (
            <AdminEditModal
              title={`Create Registration for ${creatingRegFor.name}`}
              onClose={() => setCreatingRegFor(null)}
              onSave={async () => {
                if (!newReg.camperId || !newReg.date || newReg.sessions.length === 0) return;
                const camper = getParentCampers(creatingRegFor.email).find(c => c.id === newReg.camperId);
                const registration = {
                  id: 'reg_' + Date.now(),
                  camperId: newReg.camperId,
                  camperName: camper?.name || 'Unknown',
                  parentEmail: creatingRegFor.email,
                  parentName: creatingRegFor.name,
                  date: newReg.date,
                  sessions: newReg.sessions,
                  status: 'pending',
                  paymentStatus: 'unpaid',
                  createdAt: new Date().toISOString(),
                  createdBy: 'admin'
                };
                onUpdateRegistrations(registration);
                addToHistory('Admin', `Created registration for ${camper?.name} on ${newReg.date}`, [creatingRegFor.email]);
                showToast('Registration created!');
                setCreatingRegFor(null);
              }}
            >
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Select Camper *</label>
                  <select
                    value={newReg.camperId}
                    onChange={e => setNewReg({ ...newReg, camperId: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="">-- Select a camper --</option>
                    {getParentCampers(creatingRegFor.email).map(camper => (
                      <option key={camper.id} value={camper.id}>{camper.name}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Select Date *</label>
                  <select
                    value={newReg.date}
                    onChange={e => setNewReg({ ...newReg, date: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="">-- Select a date --</option>
                    {CAMP_DATES.map(date => (
                      <option key={date} value={date}>{new Date(date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Sessions *</label>
                  <div className="flex gap-4">
                    <button
                      type="button"
                      onClick={() => {
                        const sessions = newReg.sessions.includes('morning')
                          ? newReg.sessions.filter(s => s !== 'morning')
                          : [...newReg.sessions, 'morning'];
                        setNewReg({ ...newReg, sessions });
                      }}
                      className={`flex-1 py-3 rounded-lg border-2 font-medium ${
                        newReg.sessions.includes('morning')
                          ? 'bg-amber-100 border-amber-400 text-amber-800'
                          : 'bg-white border-gray-200 text-gray-600 hover:border-amber-300'
                      }`}
                    >
                      ‚òÄÔ∏è AM {newReg.sessions.includes('morning') && '‚úì'}
                    </button>
                    <button
                      type="button"
                      onClick={() => {
                        const sessions = newReg.sessions.includes('afternoon')
                          ? newReg.sessions.filter(s => s !== 'afternoon')
                          : [...newReg.sessions, 'afternoon'];
                        setNewReg({ ...newReg, sessions });
                      }}
                      className={`flex-1 py-3 rounded-lg border-2 font-medium ${
                        newReg.sessions.includes('afternoon')
                          ? 'bg-indigo-100 border-indigo-400 text-indigo-800'
                          : 'bg-white border-gray-200 text-gray-600 hover:border-indigo-300'
                      }`}
                    >
                      üåô PM {newReg.sessions.includes('afternoon') && '‚úì'}
                    </button>
                  </div>
                </div>
                {(!newReg.camperId || !newReg.date || newReg.sessions.length === 0) && (
                  <p className="text-sm text-gray-500 text-center">Please select a camper, date, and at least one session</p>
                )}
              </div>
            </AdminEditModal>
          )}

          {/* Edit Registration Modal */}
          {editingReg && (
            <AdminEditModal
              title="Edit Registration"
              onClose={() => setEditingReg(null)}
              onSave={() => {
                onUpdateRegistrations(editingReg);
                addToHistory('Admin Edit', `Updated registration for ${editingReg.camperName || editingReg.childName} on ${editingReg.date}`, [editingReg.parentEmail]);
                showToast('Registration updated!');
                setEditingReg(null);
              }}
            >
              <div className="space-y-4">
                <div className="p-3 bg-gray-50 rounded-lg">
                  <p className="font-medium">{editingReg.camperName || editingReg.childName}</p>
                  <p className="text-sm text-gray-500">{editingReg.date}</p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Status</label>
                  <select
                    value={editingReg.status || ''}
                    onChange={e => setEditingReg({ ...editingReg, status: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                    <option value="cancelled">Cancelled</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                  <select
                    value={editingReg.paymentStatus || 'unpaid'}
                    onChange={e => setEditingReg({ ...editingReg, paymentStatus: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="unpaid">Unpaid</option>
                    <option value="submitted">Submitted</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="paid">Paid (Legacy)</option>
                    <option value="refunded">Refunded</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Sessions</label>
                  <div className="flex gap-4">
                    <label className="flex items-center gap-2">
                      <input
                        type="checkbox"
                        checked={editingReg.sessions?.includes('morning')}
                        onChange={e => {
                          const sessions = e.target.checked
                            ? [...(editingReg.sessions || []), 'morning']
                            : (editingReg.sessions || []).filter(s => s !== 'morning');
                          setEditingReg({ ...editingReg, sessions });
                        }}
                        className="w-4 h-4"
                      />
                      Morning
                    </label>
                    <label className="flex items-center gap-2">
                      <input
                        type="checkbox"
                        checked={editingReg.sessions?.includes('afternoon')}
                        onChange={e => {
                          const sessions = e.target.checked
                            ? [...(editingReg.sessions || []), 'afternoon']
                            : (editingReg.sessions || []).filter(s => s !== 'afternoon');
                          setEditingReg({ ...editingReg, sessions });
                        }}
                        className="w-4 h-4"
                      />
                      Afternoon
                    </label>
                  </div>
                </div>
              </div>
            </AdminEditModal>
          )}

          {/* Confirm Delete Modal */}
          {confirmDelete && (
            <AdminConfirmDelete
              type={confirmDelete.type}
              data={confirmDelete.data}
              onCancel={() => setConfirmDelete(null)}
              onConfirm={async () => {
                if (confirmDelete.type === 'parent') {
                  if (onDeleteParent) {
                    await onDeleteParent(confirmDelete.data.email, confirmDelete.data.name);
                  } else {
                    onUpdateUsers(users.filter(u => u.email !== confirmDelete.data.email));
                    addToHistory('Admin Delete', `Deleted parent: ${confirmDelete.data.name}`, [confirmDelete.data.email]);
                    showToast('Parent deleted');
                  }
                  setExpandedParent(null);
                } else if (confirmDelete.type === 'child') {
                  const { child, parentEmail } = confirmDelete.data;
                  const parent = users.find(u => u.email === parentEmail);
                  if (parent) {
                    const updatedChildren = parent.children.filter(c => c.id !== child.id);
                    onUpdateUsers(users.map(u => u.email === parentEmail ? { ...u, children: updatedChildren } : u));
                    addToHistory('Admin Delete', `Deleted child: ${child.name}`, [parentEmail]);
                    showToast('Child deleted');
                  }
                } else if (confirmDelete.type === 'registration') {
                  onDeleteRegistration(confirmDelete.data);
                  addToHistory('Admin Delete', `Deleted registration: ${confirmDelete.data.childName} on ${confirmDelete.data.date}`, [confirmDelete.data.parentEmail]);
                  showToast('Registration deleted');
                }
                setConfirmDelete(null);
              }}
            />
          )}

          {/* Add Parent - Full Onboarding Flow */}
          {showAddParent && (
            <div className="fixed inset-0 z-50 bg-white overflow-auto">
              <div className="sticky top-0 bg-purple-600 text-white px-4 py-3 flex items-center justify-between z-10">
                <h2 className="font-display text-xl">Add New Parent (Admin)</h2>
                <button onClick={() => setShowAddParent(false)} className="px-4 py-1 bg-purple-500 hover:bg-purple-400 rounded">Cancel</button>
              </div>
              <ParentOnboarding
                onComplete={(newUser) => {
                  addToHistory('Parent', `Added parent ${newUser.name} via onboarding`, [newUser.email]);
                  setShowAddParent(false);
                  showToast(`Parent ${newUser.name} added successfully!`);
                }}
                onBack={() => setShowAddParent(false)}
                users={users}
                saveUsers={onUpdateUsers}
                saveEmergencyContacts={saveEmergencyContacts}
                emergencyContacts={emergencyContacts}
                saveOnboardingProgress={saveOnboardingProgress}
                campers={campers}
                saveCampers={onSaveCampers}
                saveCamperParentLinks={onSaveCamperParentLinks}
                camperParentLinks={camperParentLinks}
              />
            </div>
          )}

          {/* Manage Campers for Parent Modal */}
          {managingCampers && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                <h3 className="font-bold text-xl mb-2">Manage Campers for {managingCampers.name}</h3>
                <p className="text-sm text-gray-500 mb-4">Select which campers belong to this parent. A camper can have multiple parents.</p>

                {getAllCampers().length === 0 ? (
                  <p className="text-gray-500 text-center py-8">No campers exist yet. Add campers during parent onboarding or in the Campers tab.</p>
                ) : (
                  <div className="space-y-2 mb-4">
                    {getAllCampers().map(camper => {
                      const isLinked = (camperParentLinks || []).some(l => l.camperId === camper.id && l.parentEmail === managingCampers.email);
                      return (
                        <label key={camper.id} className={`flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 ${isLinked ? 'border-green-500 bg-green-50' : ''}`}>
                          <input
                            type="checkbox"
                            checked={isLinked}
                            onChange={() => toggleCamperLink(managingCampers.email, camper.id)}
                            className="w-5 h-5"
                          />
                          <div className="flex items-center gap-3">
                            {getDisplayPhoto(camper.photo) ? (
                              <img src={getDisplayPhoto(camper.photo)} alt={camper.name} className="w-8 h-8 rounded-full object-cover" />
                            ) : (
                              <div className="w-8 h-8 rounded-full bg-gray-200 flex flex-col items-center justify-center">
                                <svg className="w-3 h-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                                <span className="text-[5px] text-gray-500 font-medium">add photo</span>
                              </div>
                            )}
                            <div>
                              <div className="font-medium">{camper.name}</div>
                              <div className="text-xs text-gray-500">{camper.grade || 'No grade'} {camper.birthdate ? `‚Ä¢ Age ${calculateAge(camper.birthdate)}` : ''}</div>
                            </div>
                          </div>
                        </label>
                      );
                    })}
                  </div>
                )}

                <button onClick={() => setManagingCampers(null)} className="w-full px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">
                  Done
                </button>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ==================== ADMIN EDIT MODAL ====================
    const AdminEditModal = ({ title, children, onClose, onSave }) => {
      const mouseDownTarget = useRef(null);

      return (
        <div
          className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
          onMouseDown={e => mouseDownTarget.current = e.target}
          onClick={e => e.target === e.currentTarget && mouseDownTarget.current === e.currentTarget && onClose()}
        >
          <div className="bg-white rounded-xl max-w-md w-full overflow-hidden">
            <div className="bg-blue-600 text-white px-6 py-4 flex justify-between items-center">
              <h2 className="font-display text-xl">‚úèÔ∏è {title}</h2>
              <button onClick={onClose} className="text-2xl hover:bg-blue-500 rounded px-2">√ó</button>
            </div>
            <div className="p-6">
              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                <p className="text-sm text-yellow-800">‚ö†Ô∏è <strong>Warning:</strong> Changes made here cannot be automatically undone. Please verify all information before saving.</p>
              </div>
              {children}
              <div className="flex gap-4 mt-6">
                <button onClick={onClose} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                <button onClick={onSave} className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ==================== ADMIN CONFIRM DELETE ====================
    const AdminConfirmDelete = ({ type, data, onCancel, onConfirm }) => {
      const [confirmText, setConfirmText] = useState('');
      const requiredText = 'DELETE';

      const getDescription = () => {
        if (type === 'parent') return `parent account "${data.name}" and all their data`;
        if (type === 'child') return `child "${data.child.name}" from ${data.parentEmail}`;
        if (type === 'registration') return `registration for ${data.childName} on ${data.date}`;
        return 'this item';
      };

      return (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-xl max-w-md w-full overflow-hidden" onClick={e => e.stopPropagation()}>
            <div className="bg-red-600 text-white px-6 py-4">
              <h2 className="font-display text-xl">‚ö†Ô∏è Confirm Deletion</h2>
            </div>
            <div className="p-6">
              <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                <p className="text-red-800 font-medium mb-2">You are about to permanently delete:</p>
                <p className="text-red-700">{getDescription()}</p>
              </div>

              <p className="text-gray-700 mb-4">This action <strong>cannot be undone</strong>. All associated data will be permanently removed.</p>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Type <span className="font-mono bg-gray-100 px-1">DELETE</span> to confirm:
                </label>
                <input
                  value={confirmText}
                  onChange={e => setConfirmText(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg"
                  placeholder="DELETE"
                  autoComplete="off"
                  data-1p-ignore="true"
                />
              </div>

              <div className="flex gap-4">
                <button onClick={onCancel} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                <button
                  onClick={onConfirm}
                  disabled={confirmText !== requiredText}
                  className="flex-1 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                >
                  Delete Permanently
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ==================== ADMINS TAB ====================
    const AdminsTab = ({ admins, currentAdminId, onSave, showToast }) => {
      const [editingAdmin, setEditingAdmin] = useState(null);
      const [showAddForm, setShowAddForm] = useState(false);
      const [confirmDelete, setConfirmDelete] = useState(null);
      const [deleteConfirmText, setDeleteConfirmText] = useState('');

      const [formData, setFormData] = useState({
        username: '', password: '', name: '', email: ''
      });

      const resetForm = () => {
        setFormData({ username: '', password: '', name: '', email: '' });
        setShowAddForm(false);
        setEditingAdmin(null);
      };

      const handleSave = () => {
        if (!formData.username || !formData.password || !formData.name) {
          showToast('Username, password, and name are required', 'error');
          return;
        }
        // Check for duplicate username
        if (admins.some(a => a.username === formData.username && a.id !== editingAdmin?.id)) {
          showToast('Username already exists', 'error');
          return;
        }

        if (editingAdmin) {
          const updated = admins.map(a => a.id === editingAdmin.id ? { ...a, ...formData } : a);
          onSave(updated, `Updated admin ${formData.name}`);
        } else {
          const newAdmin = {
            id: 'admin_' + Date.now(),
            ...formData,
            createdAt: new Date().toISOString()
          };
          onSave([...admins, newAdmin], `Added admin ${formData.name}`);
        }
        resetForm();
        showToast(editingAdmin ? 'Admin updated!' : 'Admin added!');
      };

      const handleDelete = (admin) => {
        if (admins.length <= 1) {
          showToast('Cannot delete the last admin!', 'error');
          return;
        }
        if (admin.id === currentAdminId) {
          showToast('Cannot delete yourself!', 'error');
          return;
        }
        setConfirmDelete(admin);
      };

      const confirmDeleteAdmin = () => {
        if (deleteConfirmText !== 'DELETE') {
          showToast('Please type DELETE to confirm', 'error');
          return;
        }
        const updated = admins.filter(a => a.id !== confirmDelete.id);
        onSave(updated, `Deleted admin ${confirmDelete.name}`);
        setConfirmDelete(null);
        setDeleteConfirmText('');
        showToast('Admin deleted');
      };

      const startEdit = (admin) => {
        setFormData({
          username: admin.username,
          password: admin.password,
          name: admin.name,
          email: admin.email || ''
        });
        setEditingAdmin(admin);
        setShowAddForm(true);
      };

      return (
        <div className="space-y-6">
          <div className="bg-white rounded-xl shadow p-6">
            <div className="flex justify-between items-center mb-4">
              <div>
                <h3 className="font-bold text-xl text-purple-800">üëë Admin Accounts</h3>
                <p className="text-sm text-gray-500">{admins.length} admin{admins.length !== 1 ? 's' : ''} ‚Ä¢ At least 1 admin required</p>
              </div>
              <button
                onClick={() => setShowAddForm(true)}
                className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
              >
                + Add Admin
              </button>
            </div>

            {/* Admin List */}
            <div className="space-y-3">
              {admins.map(admin => (
                <div key={admin.id} className="border rounded-lg p-4 flex justify-between items-center hover:bg-gray-50">
                  <div>
                    <div className="font-bold text-lg">{admin.name}</div>
                    <div className="text-sm text-gray-600">
                      Username: <span className="font-mono bg-gray-100 px-2 rounded">{admin.username}</span>
                      {admin.email && <span className="ml-3">‚Ä¢ {admin.email}</span>}
                    </div>
                    <div className="text-xs text-gray-400">
                      Created: {new Date(admin.createdAt).toLocaleDateString()}
                      {admin.id === currentAdminId && <span className="ml-2 px-2 py-0.5 bg-green-100 text-green-700 rounded">You</span>}
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={() => startEdit(admin)}
                      className="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
                    >
                      Edit
                    </button>
                    <button
                      onClick={() => handleDelete(admin)}
                      disabled={admins.length <= 1 || admin.id === currentAdminId}
                      className="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      Delete
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Add/Edit Form Modal */}
          {showAddForm && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-md w-full p-6" onClick={e => e.stopPropagation()}>
                <h3 className="font-bold text-xl mb-4">{editingAdmin ? 'Edit Admin' : 'Add New Admin'}</h3>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Name *</label>
                    <input
                      value={formData.name}
                      onChange={e => setFormData({ ...formData, name: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg"
                      placeholder="Full Name"
                      autoComplete="off"
                      data-1p-ignore="true"
                    />
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Username *</label>
                    <input
                      value={formData.username}
                      onChange={e => setFormData({ ...formData, username: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg font-mono"
                      placeholder="login_username"
                      autoComplete="off"
                      data-1p-ignore="true"
                    />
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Password *</label>
                    <input
                      type="text"
                      value={formData.password}
                      onChange={e => setFormData({ ...formData, password: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg font-mono"
                      placeholder="password"
                      autoComplete="off"
                      data-1p-ignore="true"
                    />
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Email (optional)</label>
                    <input
                      type="email"
                      value={formData.email}
                      onChange={e => setFormData({ ...formData, email: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg"
                      placeholder="admin@example.com"
                      autoComplete="off"
                      data-1p-ignore="true"
                    />
                  </div>
                </div>
                <div className="flex gap-3 mt-6">
                  <button onClick={resetForm} className="flex-1 px-4 py-2 border rounded-lg">Cancel</button>
                  <button onClick={handleSave} className="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                    {editingAdmin ? 'Save Changes' : 'Add Admin'}
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Delete Confirmation Modal */}
          {confirmDelete && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-md w-full p-6 text-center" onClick={e => e.stopPropagation()}>
                <div className="text-5xl mb-4">‚ö†Ô∏è</div>
                <h3 className="font-bold text-xl text-red-600 mb-2">Delete Admin Account</h3>
                <p className="text-gray-600 mb-4">
                  Are you sure you want to delete <strong>{confirmDelete.name}</strong>?
                  <br />This cannot be undone.
                </p>
                <p className="text-sm text-gray-500 mb-2">Type DELETE to confirm:</p>
                <input
                  value={deleteConfirmText}
                  onChange={e => setDeleteConfirmText(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg text-center font-mono mb-4"
                  placeholder="DELETE"
                  autoComplete="off"
                  data-1p-ignore="true"
                />
                <div className="flex gap-3">
                  <button onClick={() => { setConfirmDelete(null); setDeleteConfirmText(''); }} className="flex-1 px-4 py-2 border rounded-lg">Cancel</button>
                  <button onClick={confirmDeleteAdmin} disabled={deleteConfirmText !== 'DELETE'} className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-300">
                    Delete Admin
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ==================== GYM RENTAL DAYS TAB ====================
    const GymRentalDaysTab = ({ gymRentals, allDates, onSaveGymRentals, showToast, selectedMonth, setSelectedMonth }) => {
      // Generate all weekdays (Mon-Fri) in July and August 2026
      const getAllWeekdays = () => {
        const weekdays = [];
        const months = [6, 7]; // July (6) and August (7) - 0-indexed
        const year = 2026;

        months.forEach(month => {
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dayOfWeek = date.getDay(); // 0=Sunday, 6=Saturday
            // Only include weekdays (Mon-Fri)
            if (dayOfWeek >= 1 && dayOfWeek <= 5) {
              const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
              weekdays.push(dateStr);
            }
          }
        });
        return weekdays;
      };

      const allWeekdays = getAllWeekdays();

      // Initialize selected month if not set
      React.useEffect(() => {
        if (!selectedMonth) {
          setSelectedMonth('2026-07'); // Default to July 2026
        }
      }, [selectedMonth, setSelectedMonth]);

      // Get months (July and August 2026)
      const getMonths = () => {
        return [
          { key: '2026-07', name: 'July 2026', year: 2026, month: 6 },
          { key: '2026-08', name: 'August 2026', year: 2026, month: 7 }
        ];
      };

      const months = getMonths();

      // Get weekdays for selected month
      const getMonthDates = () => {
        if (!selectedMonth) return [];
        const [year, month] = selectedMonth.split('-').map(Number);
        return allWeekdays.filter(date => {
          const d = new Date(date + 'T12:00:00');
          return d.getFullYear() === year && d.getMonth() === month - 1;
        });
      };

      const monthDates = getMonthDates();

      // Get weeks for selected month (group weekdays into weeks)
      const getMonthWeeks = () => {
        if (!selectedMonth) return [];
        const dates = getMonthDates();
        const weeks = [];
        let currentWeek = [];

        dates.forEach((date, idx) => {
          const d = new Date(date + 'T12:00:00');
          const dayOfWeek = d.getDay(); // 1=Mon, 5=Fri

          currentWeek.push(date);

          // End of week (Friday) or last date
          if (dayOfWeek === 5 || idx === dates.length - 1) {
            if (currentWeek.length > 0) {
              weeks.push({
                start: currentWeek[0],
                end: currentWeek[currentWeek.length - 1],
                dates: [...currentWeek]
              });
              currentWeek = [];
            }
          }
        });

        return weeks;
      };

      const monthWeeks = getMonthWeeks();

      // Check if a session is booked
      const isSessionBooked = (date, session) => {
        return gymRentals[date]?.[session] === true;
      };

      // Check if whole day is booked
      const isDayFullyBooked = (date) => {
        return isSessionBooked(date, 'morning') && isSessionBooked(date, 'afternoon');
      };

      // Check if day is partially booked
      const isDayPartiallyBooked = (date) => {
        const am = isSessionBooked(date, 'morning');
        const pm = isSessionBooked(date, 'afternoon');
        return (am || pm) && !(am && pm);
      };

      // Check if not booked
      const isDayNotBooked = (date) => {
        return !isSessionBooked(date, 'morning') && !isSessionBooked(date, 'afternoon');
      };

      // Toggle a single session
      const toggleSession = (date, session) => {
        const isBooked = isSessionBooked(date, session);
        const newRentals = { ...gymRentals };
        if (!newRentals[date]) newRentals[date] = {};

        if (isBooked) {
          // Unbook
          delete newRentals[date][session];
          if (Object.keys(newRentals[date]).length === 0) {
            delete newRentals[date];
          }
          onSaveGymRentals(newRentals, `Unmarked ${session} on ${date} as not booked`);
          showToast(`${session} on ${date} is now not booked`);
        } else {
          // Book
          newRentals[date][session] = true;
          onSaveGymRentals(newRentals, `Marked ${session} on ${date} as gym booked`);
          showToast(`${session} on ${date} is now gym booked`);
        }
      };

      // Toggle whole day (both sessions)
      const toggleDay = (date) => {
        const fullyBooked = isDayFullyBooked(date);
        const newRentals = { ...gymRentals };

        if (fullyBooked) {
          // Unbook whole day
          delete newRentals[date];
          onSaveGymRentals(newRentals, `Unmarked ${date} as not booked`);
          showToast(`${date} is now not booked`);
        } else {
          // Book whole day
          newRentals[date] = { morning: true, afternoon: true };
          onSaveGymRentals(newRentals, `Marked ${date} as fully gym booked`);
          showToast(`${date} is now fully gym booked`);
        }
      };

      // Toggle whole week
      const toggleWeek = (week) => {
        const newRentals = { ...gymRentals };
        const allBooked = week.dates.every(d => isDayFullyBooked(d));

        if (allBooked) {
          // Unbook whole week
          week.dates.forEach(date => delete newRentals[date]);
          onSaveGymRentals(newRentals, `Unmarked week ${week.start} as not booked`);
          showToast(`Week ${week.start} is now not booked`);
        } else {
          // Book whole week
          week.dates.forEach(date => {
            newRentals[date] = { morning: true, afternoon: true };
          });
          onSaveGymRentals(newRentals, `Marked week ${week.start} as fully gym booked`);
          showToast(`Week ${week.start} is now fully gym booked`);
        }
      };

      // Helper functions
      const getDayName = (date) => {
        const d = new Date(date + 'T12:00:00');
        return d.toLocaleDateString('en-US', { weekday: 'short' });
      };

      const formatDateShort = (date) => {
        const d = new Date(date + 'T12:00:00');
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      };

      const formatWeekRange = (week) => {
        const startD = new Date(week.start + 'T12:00:00');
        const endD = new Date(week.end + 'T12:00:00');
        return `${startD.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endD.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
      };

      // Stats
      const totalSessions = allWeekdays.length * 2;
      const bookedCount = Object.values(gymRentals).reduce((sum, day) =>
        sum + (day.morning ? 1 : 0) + (day.afternoon ? 1 : 0), 0);
      const unbookedCount = totalSessions - bookedCount;

      return (
        <div className="space-y-6">
          {/* Summary Stats */}
          <div className="grid grid-cols-3 gap-4">
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-3xl font-bold text-gray-600">{allWeekdays.length}</div>
              <div className="text-gray-600 text-sm">Total Weekdays</div>
            </div>
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-3xl font-bold text-blue-600">{bookedCount}</div>
              <div className="text-gray-600 text-sm">Gym Booked Sessions</div>
            </div>
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-3xl font-bold text-green-600">{unbookedCount}</div>
              <div className="text-gray-600 text-sm">Not Booked Sessions</div>
            </div>
          </div>

          {/* Month Selector */}
          <div className="bg-white rounded-xl shadow p-4">
            <div className="flex flex-wrap gap-2 mb-4">
              {months.map(m => (
                <button
                  key={m.key}
                  onClick={() => setSelectedMonth(m.key)}
                  className={`px-4 py-2 rounded-lg text-sm ${
                    selectedMonth === m.key
                      ? 'bg-green-600 text-white'
                      : 'bg-gray-100 hover:bg-gray-200'
                  }`}
                >
                  {m.name}
                </button>
              ))}
            </div>

            {/* Instructions */}
            <p className="text-sm text-gray-500 mb-4">
              Mark days/sessions when the gym is booked for DayCamp. Click AM/PM to toggle individual sessions, or the date header to toggle the whole day.
            </p>

            {/* Legend */}
            <div className="flex flex-wrap gap-4 text-sm mb-4 p-3 bg-gray-50 rounded-lg">
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-green-200 border-2 border-green-400 rounded"></div>
                <span>Fully Booked (both AM & PM)</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-yellow-200 border-2 border-yellow-400 rounded"></div>
                <span>Partially Booked (AM or PM only)</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-red-200 border-2 border-red-400 rounded"></div>
                <span>Not Booked (gym not secured)</span>
              </div>
            </div>

            {/* Date Grid - Mon to Fri rows */}
            <div className="space-y-1">
              {/* Day-of-week headers */}
              <div className="grid grid-cols-5 gap-2 mb-2">
                {['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].map(day => (
                  <div key={day} className="text-center text-xs font-bold text-gray-500 uppercase">{day}</div>
                ))}
              </div>
              {monthWeeks.map((week, weekIdx) => (
                <div key={weekIdx} className="grid grid-cols-5 gap-2 mb-2">
                  {[1, 2, 3, 4, 5].map(dayOfWeek => {
                    const date = week.dates.find(d => new Date(d + 'T12:00:00').getDay() === dayOfWeek);
                    if (!date) return <div key={dayOfWeek} className="rounded-lg bg-gray-50 min-h-[90px]"></div>;

                    const fullyBooked = isDayFullyBooked(date);
                    const partiallyBooked = isDayPartiallyBooked(date);
                    const amBooked = isSessionBooked(date, 'morning');
                    const pmBooked = isSessionBooked(date, 'afternoon');

                    return (
                      <div
                        key={date}
                        className={`rounded-lg border-2 overflow-hidden ${
                          fullyBooked ? 'border-green-400 bg-green-50' :
                          partiallyBooked ? 'border-yellow-400 bg-yellow-50' :
                          'border-red-400 bg-red-50'
                        }`}
                      >
                        {/* Date Header - Click to toggle whole day */}
                        <button
                          onClick={() => toggleDay(date)}
                          className={`w-full p-1 text-center font-bold transition-colors text-sm ${
                            fullyBooked ? 'bg-green-200 hover:bg-green-300' :
                            partiallyBooked ? 'bg-yellow-200 hover:bg-yellow-300' :
                            'bg-red-200 hover:bg-red-300'
                          }`}
                        >
                          <div>{formatDateShort(date)}</div>
                        </button>

                        {/* Session Buttons */}
                        <div className="p-1 space-y-1">
                          <button
                            onClick={() => toggleSession(date, 'morning')}
                            className={`w-full p-1 rounded text-xs transition-colors ${
                              amBooked ? 'bg-green-100 hover:bg-green-200 text-green-800' : 'bg-red-100 hover:bg-red-200 text-red-800 border border-red-200'
                            }`}
                          >
                            <div className="flex justify-between items-center">
                              <span>‚òÄÔ∏è AM</span>
                              <span>{amBooked ? '‚úì' : '‚óã'}</span>
                            </div>
                          </button>
                          <button
                            onClick={() => toggleSession(date, 'afternoon')}
                            className={`w-full p-1 rounded text-xs transition-colors ${
                              pmBooked ? 'bg-green-100 hover:bg-green-200 text-green-800' : 'bg-red-100 hover:bg-red-200 text-red-800 border border-red-200'
                            }`}
                          >
                            <div className="flex justify-between items-center">
                              <span>üåô PM</span>
                              <span>{pmBooked ? '‚úì' : '‚óã'}</span>
                            </div>
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // ==================== SESSIONS TAB ====================
    const SessionsTab = ({ blockedSessions, allDates, onSaveBlockedSessions, registrations, counselors, availability, assignments, showToast, selectedMonth, setSelectedMonth }) => {
      const [confirmBlock, setConfirmBlock] = useState(null);

      // Initialize selected month if not set
      React.useEffect(() => {
        if (!selectedMonth && allDates.length > 0) {
          const d = new Date(allDates[0] + 'T12:00:00');
          setSelectedMonth(`${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`);
        }
      }, [selectedMonth, allDates, setSelectedMonth]);

      // Get months that have camp dates
      const getMonths = () => {
        const months = [];
        allDates.forEach(date => {
          const d = new Date(date + 'T12:00:00');
          const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
          if (!months.some(m => m.key === monthKey)) {
            months.push({
              key: monthKey,
              name: d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
              year: d.getFullYear(),
              month: d.getMonth()
            });
          }
        });
        return months;
      };

      const months = getMonths();

      // Get dates for selected month
      const getMonthDates = () => {
        if (!selectedMonth) return [];
        const [year, month] = selectedMonth.split('-').map(Number);
        return allDates.filter(date => {
          const d = new Date(date + 'T12:00:00');
          return d.getFullYear() === year && d.getMonth() === month - 1;
        });
      };

      const monthDates = getMonthDates();

      // Check if a session is blocked
      const isSessionBlocked = (date, session) => {
        return blockedSessions[date]?.[session] === true;
      };

      // Check if whole day is blocked
      const isDayFullyBlocked = (date) => {
        return isSessionBlocked(date, 'morning') && isSessionBlocked(date, 'afternoon');
      };

      // Check if day is partially blocked
      const isDayPartiallyBlocked = (date) => {
        const am = isSessionBlocked(date, 'morning');
        const pm = isSessionBlocked(date, 'afternoon');
        return (am || pm) && !(am && pm);
      };

      // Get registration stats for a date/session
      const getSessionStats = (date, session) => {
        const regs = registrations.filter(r =>
          r.date === date &&
          r.sessions?.includes(session) &&
          r.status !== 'cancelled'
        );
        return { count: regs.length };
      };

      // Get counselor availability for a date/session
      const getCounselorStats = (date, session) => {
        let available = 0;
        let total = counselors.filter(c => c.visible).length;

        Object.entries(availability).forEach(([email, avail]) => {
          const counselor = counselors.find(c => c.email === email && c.visible);
          if (!counselor) return;

          const dateAvail = avail[date];
          if (dateAvail?.available?.includes(session) ||
              (Array.isArray(dateAvail) && dateAvail.includes(session))) {
            available++;
          }
        });

        return { available, total };
      };

      // Get assigned campers for a date/session
      const getAssignedStats = (date, session) => {
        const key = `${date}_${session}`;
        const sessionAssignments = assignments[key] || {};
        const assigned = Object.values(sessionAssignments).flat().length;
        return { assigned };
      };

      // Get pod information for a date/session
      const getPodStats = (date, session) => {
        const key = `${date}_${session}`;
        const sessionAssignments = assignments[key] || {};
        const pods = Object.entries(sessionAssignments).map(([counselorId, camperIds]) => ({
          counselorId,
          camperCount: camperIds.length
        }));
        const totalCapacity = pods.length * KIDS_PER_COUNSELOR;
        return { pods, totalCapacity };
      };

      // Toggle a single session
      const toggleSession = (date, session) => {
        const isBlocked = isSessionBlocked(date, session);
        const stats = getSessionStats(date, session);

        if (!isBlocked && stats.count > 0) {
          // Blocking with registrations - confirm first
          setConfirmBlock({ date, session, count: stats.count });
          return;
        }

        const newBlocked = { ...blockedSessions };
        if (!newBlocked[date]) newBlocked[date] = {};

        if (isBlocked) {
          delete newBlocked[date][session];
          if (Object.keys(newBlocked[date]).length === 0) {
            delete newBlocked[date];
          }
          onSaveBlockedSessions(newBlocked, `Unblocked ${session} on ${date}`);
          showToast(`${session} on ${date} is now available`);
        } else {
          newBlocked[date][session] = true;
          onSaveBlockedSessions(newBlocked, `Blocked ${session} on ${date}`);
          showToast(`${session} on ${date} is now blocked`);
        }
      };

      // Toggle whole day (both sessions)
      const toggleDay = (date) => {
        const fullyBlocked = isDayFullyBlocked(date);
        const morningStats = getSessionStats(date, 'morning');
        const afternoonStats = getSessionStats(date, 'afternoon');
        const totalRegs = morningStats.count + afternoonStats.count;

        if (!fullyBlocked && totalRegs > 0) {
          // Blocking with registrations - confirm first
          setConfirmBlock({ date, session: 'both', count: totalRegs });
          return;
        }

        const newBlocked = { ...blockedSessions };

        if (fullyBlocked) {
          // Unblock whole day
          delete newBlocked[date];
          onSaveBlockedSessions(newBlocked, `Unblocked whole day ${date}`);
          showToast(`${date} is now fully available`);
        } else {
          // Block whole day
          newBlocked[date] = { morning: true, afternoon: true };
          onSaveBlockedSessions(newBlocked, `Blocked whole day ${date}`);
          showToast(`${date} is now fully blocked`);
        }
      };

      // Handle confirm block
      const handleConfirmBlock = () => {
        const { date, session } = confirmBlock;
        const newBlocked = { ...blockedSessions };
        if (!newBlocked[date]) newBlocked[date] = {};

        if (session === 'both') {
          newBlocked[date] = { morning: true, afternoon: true };
          onSaveBlockedSessions(newBlocked, `Blocked whole day ${date} (had registrations)`);
          showToast(`${date} is now fully blocked`);
        } else {
          newBlocked[date][session] = true;
          onSaveBlockedSessions(newBlocked, `Blocked ${session} on ${date} (had registrations)`);
          showToast(`${session} on ${date} is now blocked`);
        }
        setConfirmBlock(null);
      };

      // Get week days for a date
      const getDayName = (date) => {
        const d = new Date(date + 'T12:00:00');
        return d.toLocaleDateString('en-US', { weekday: 'short' });
      };

      const formatDateShort = (date) => {
        const d = new Date(date + 'T12:00:00');
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      };

      // Stats
      const totalSessions = allDates.length * 2;
      const blockedCount = Object.values(blockedSessions).reduce((sum, day) =>
        sum + (day.morning ? 1 : 0) + (day.afternoon ? 1 : 0), 0);
      const availableCount = totalSessions - blockedCount;

      return (
        <div className="space-y-6">
          {/* Summary Stats */}
          <div className="grid grid-cols-3 gap-4">
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-3xl font-bold text-blue-600">{totalSessions}</div>
              <div className="text-gray-600 text-sm">Total Sessions</div>
            </div>
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-3xl font-bold text-green-600">{availableCount}</div>
              <div className="text-gray-600 text-sm">Available</div>
            </div>
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-3xl font-bold text-red-600">{blockedCount}</div>
              <div className="text-gray-600 text-sm">Blocked</div>
            </div>
          </div>

          {/* Month Selector */}
          <div className="bg-white rounded-xl shadow p-4">
            <div className="flex flex-wrap gap-2 mb-4">
              {months.map(m => (
                <button
                  key={m.key}
                  onClick={() => setSelectedMonth(m.key)}
                  className={`px-4 py-2 rounded-lg text-sm ${
                    selectedMonth === m.key
                      ? 'bg-green-600 text-white'
                      : 'bg-gray-100 hover:bg-gray-200'
                  }`}
                >
                  {m.name}
                </button>
              ))}
            </div>

            {/* Instructions */}
            <p className="text-sm text-gray-500 mb-4">
              Click AM/PM to toggle individual sessions, or the date header to toggle the whole day. Blocked sessions will not appear as options for registration.
            </p>

            {/* Date Grid */}
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
              {monthDates.map(date => {
                const fullyBlocked = isDayFullyBlocked(date);
                const partiallyBlocked = isDayPartiallyBlocked(date);
                const amBlocked = isSessionBlocked(date, 'morning');
                const pmBlocked = isSessionBlocked(date, 'afternoon');
                const amStats = getSessionStats(date, 'morning');
                const pmStats = getSessionStats(date, 'afternoon');
                const amCounselors = getCounselorStats(date, 'morning');
                const pmCounselors = getCounselorStats(date, 'afternoon');
                const amAssigned = getAssignedStats(date, 'morning');
                const pmAssigned = getAssignedStats(date, 'afternoon');
                const amPods = getPodStats(date, 'morning');
                const pmPods = getPodStats(date, 'afternoon');

                return (
                  <div
                    key={date}
                    className={`rounded-lg border-2 overflow-hidden ${
                      fullyBlocked ? 'border-red-300 bg-red-50' :
                      partiallyBlocked ? 'border-yellow-300 bg-yellow-50' :
                      'border-green-300 bg-green-50'
                    }`}
                  >
                    {/* Date Header - Click to toggle whole day */}
                    <button
                      onClick={() => toggleDay(date)}
                      className={`w-full p-2 text-center font-bold transition-colors ${
                        fullyBlocked ? 'bg-red-200 hover:bg-red-300' :
                        partiallyBlocked ? 'bg-yellow-200 hover:bg-yellow-300' :
                        'bg-green-200 hover:bg-green-300'
                      }`}
                    >
                      <div className="text-xs text-gray-600">{getDayName(date)}</div>
                      <div>{formatDateShort(date)}</div>
                    </button>

                    {/* Session Buttons */}
                    <div className="p-2 space-y-2">
                      {/* Morning Session */}
                      <button
                        onClick={() => toggleSession(date, 'morning')}
                        className={`w-full p-2 rounded text-left text-sm transition-colors ${
                          amBlocked ? 'bg-red-100 hover:bg-red-200' : 'bg-white hover:bg-gray-50'
                        }`}
                      >
                        <div className="flex justify-between items-center">
                          <span className="font-medium">‚òÄÔ∏è AM</span>
                          <span className={amBlocked ? 'text-red-600' : 'text-green-600'}>
                            {amBlocked ? 'üö´' : '‚úì'}
                          </span>
                        </div>
                        <div className="text-xs text-gray-500 mt-1">
                          <div className="flex items-center gap-1">
                            <span title="Campers registered">üèïÔ∏è {amStats.count}</span>
                            {amStats.count > amPods.totalCapacity && amPods.totalCapacity > 0 && (
                              <span className="text-red-600 font-bold" title="Not enough counselors!">‚ö†Ô∏è</span>
                            )}
                          </div>
                          {amPods.pods.length > 0 ? (
                            <div className="mt-1 text-xs">
                              <span className="text-gray-600">Pods: </span>
                              {amPods.pods.map((pod, idx) => (
                                <span key={idx} className="mr-1">
                                  {pod.camperCount}/{KIDS_PER_COUNSELOR}{idx < amPods.pods.length - 1 ? ',' : ''}
                                </span>
                              ))}
                            </div>
                          ) : (
                            <div className="mt-1 text-xs text-gray-400">No pods assigned</div>
                          )}
                        </div>
                      </button>

                      {/* Afternoon Session */}
                      <button
                        onClick={() => toggleSession(date, 'afternoon')}
                        className={`w-full p-2 rounded text-left text-sm transition-colors ${
                          pmBlocked ? 'bg-red-100 hover:bg-red-200' : 'bg-white hover:bg-gray-50'
                        }`}
                      >
                        <div className="flex justify-between items-center">
                          <span className="font-medium">üåô PM</span>
                          <span className={pmBlocked ? 'text-red-600' : 'text-green-600'}>
                            {pmBlocked ? 'üö´' : '‚úì'}
                          </span>
                        </div>
                        <div className="text-xs text-gray-500 mt-1">
                          <div className="flex items-center gap-1">
                            <span title="Campers registered">üèïÔ∏è {pmStats.count}</span>
                            {pmStats.count > pmPods.totalCapacity && pmPods.totalCapacity > 0 && (
                              <span className="text-red-600 font-bold" title="Not enough counselors!">‚ö†Ô∏è</span>
                            )}
                          </div>
                          {pmPods.pods.length > 0 ? (
                            <div className="mt-1 text-xs">
                              <span className="text-gray-600">Pods: </span>
                              {pmPods.pods.map((pod, idx) => (
                                <span key={idx} className="mr-1">
                                  {pod.camperCount}/{KIDS_PER_COUNSELOR}{idx < pmPods.pods.length - 1 ? ',' : ''}
                                </span>
                              ))}
                            </div>
                          ) : (
                            <div className="mt-1 text-xs text-gray-400">No pods assigned</div>
                          )}
                        </div>
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Legend */}
          <div className="bg-white rounded-xl shadow p-4">
            <h4 className="font-bold text-gray-700 mb-2">Legend</h4>
            <div className="flex flex-wrap gap-4 text-sm">
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-green-50 border-2 border-green-300 rounded"></div>
                <span>Fully available</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-yellow-50 border-2 border-yellow-300 rounded"></div>
                <span>Partially blocked</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-red-50 border-2 border-red-300 rounded"></div>
                <span>Fully blocked</span>
              </div>
            </div>
            <div className="mt-3 text-xs text-gray-500">
              <strong>Stats:</strong> üèïÔ∏è = Campers registered ‚Ä¢ Pods show campers/capacity for each counselor (e.g., "3/5" means 3 campers in a pod of 5) ‚Ä¢ ‚ö†Ô∏è = Not enough counselors for registered campers
            </div>
          </div>

          {/* Confirm Block Modal */}
          {confirmBlock && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-md w-full p-6 text-center" onClick={e => e.stopPropagation()}>
                <div className="text-5xl mb-4">‚ö†Ô∏è</div>
                <h3 className="font-bold text-xl text-orange-600 mb-2">Block Session with Registrations?</h3>
                <p className="text-gray-600 mb-4">
                  <strong>{confirmBlock.date}</strong> {confirmBlock.session === 'both' ? '(both sessions)' : `(${confirmBlock.session})`} has <strong>{confirmBlock.count}</strong> existing registration{confirmBlock.count !== 1 ? 's' : ''}.
                  <br /><br />
                  Blocking will prevent new registrations but won't affect existing ones.
                </p>
                <div className="flex gap-3">
                  <button onClick={() => setConfirmBlock(null)} className="flex-1 px-4 py-2 border rounded-lg">Cancel</button>
                  <button onClick={handleConfirmBlock} className="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                    Block Anyway
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ==================== CHILDREN TAB (All Child Profiles) ====================
    const ChildrenTab = ({ children, childParentLinks, users, registrations, onSaveChildren, onSaveLinks, showToast }) => {
      const [searchTerm, setSearchTerm] = useState('');

      // Get all children profiles from BOTH sources:
      // 1. Standalone children from camp_children table
      // 2. Legacy children embedded in user accounts
      const getAllChildren = () => {
        // Start with standalone children
        const standaloneChildren = children.map(child => ({
          ...child,
          source: 'standalone',
          parents: childParentLinks
            .filter(link => link.childId === child.id)
            .map(link => users.find(u => u.email === link.parentEmail))
            .filter(Boolean),
          hasRegistrations: registrations.some(r => r.childId === child.id)
        }));

        // Add legacy children from users (avoid duplicates)
        const legacyChildren = users.flatMap(user =>
          (user.children || [])
            .filter(child => !children.some(c => c.id === child.id)) // Don't duplicate
            .map(child => ({
              ...child,
              source: 'legacy',
              parents: [user],
              parentEmail: user.email,
              parentName: user.name,
              hasRegistrations: registrations.some(r => r.childId === child.id)
            }))
        );

        return [...standaloneChildren, ...legacyChildren];
      };

      const allChildren = getAllChildren();
      const filteredChildren = allChildren.filter(c =>
        c.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        c.parents?.some(p => p?.name?.toLowerCase().includes(searchTerm.toLowerCase()))
      );

      // Separate into registered (campers) and not registered (children)
      const unregisteredChildren = filteredChildren.filter(c => !c.hasRegistrations);
      const registeredChildren = filteredChildren.filter(c => c.hasRegistrations);

      const getAge = (birthdate) => {
        if (!birthdate) return null;
        const today = new Date();
        const birth = new Date(birthdate);
        let age = today.getFullYear() - birth.getFullYear();
        const m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
        return age;
      };

      const ChildCard = ({ child }) => {
        const age = getAge(child.birthdate);
        return (
          <div className="border rounded-xl p-4 hover:shadow-md transition-shadow">
            <div className="flex items-start gap-4">
              <div className="w-16 h-16 rounded-full overflow-hidden flex-shrink-0">
                {getDisplayPhoto(child.photo) ? (
                  <img src={getDisplayPhoto(child.photo)} alt={child.name} className="w-full h-full object-cover" />
                ) : (
                  <div className="w-16 h-16 rounded-full bg-gray-200 flex flex-col items-center justify-center">
                    <svg className="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                    <span className="text-[8px] text-gray-500 font-medium">add photo</span>
                  </div>
                )}
              </div>
              <div className="flex-1 min-w-0">
                <h4 className="font-bold text-gray-800 truncate">{child.name}</h4>
                <div className="text-sm text-gray-600">
                  {age && <span>Age {age}</span>}
                  {child.grade && <span className="ml-2">‚Ä¢ Grade {child.grade}</span>}
                </div>
                {child.parents?.length > 0 && (
                  <div className="text-xs text-gray-500 mt-1">
                    Parents: {child.parents.map(p => p.name).join(', ')}
                  </div>
                )}
              </div>
              <div className="flex-shrink-0">
                {child.hasRegistrations ? (
                  <span className="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full font-medium">
                    ‚úì Registered
                  </span>
                ) : (
                  <span className="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full font-medium">
                    Not Registered
                  </span>
                )}
              </div>
            </div>
          </div>
        );
      };

      return (
        <div className="space-y-6">
          <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg">
            <p className="text-blue-800">
              <strong>Children &amp; Campers:</strong> All child profiles are shown here. When children register for camp sessions, they become "campers" but remain in this list. Children are never deleted when they become campers - they simply gain registered status.
            </p>
          </div>

          <div className="bg-white rounded-xl shadow p-6">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-bold text-lg text-green-800">üë∂ All Children Profiles ({allChildren.length})</h3>
              <input
                type="text"
                placeholder="Search children or parents..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="px-4 py-2 border rounded-lg w-64"
              />
            </div>

            {unregisteredChildren.length > 0 && (
              <div className="mb-6">
                <h4 className="font-medium text-yellow-700 mb-3 flex items-center gap-2">
                  <span className="w-3 h-3 bg-yellow-400 rounded-full"></span>
                  Not Yet Registered ({unregisteredChildren.length})
                </h4>
                <div className="grid md:grid-cols-2 gap-4">
                  {unregisteredChildren.map(child => (
                    <ChildCard key={child.id} child={child} />
                  ))}
                </div>
              </div>
            )}

            {registeredChildren.length > 0 && (
              <div>
                <h4 className="font-medium text-green-700 mb-3 flex items-center gap-2">
                  <span className="w-3 h-3 bg-green-500 rounded-full"></span>
                  üèïÔ∏è Registered as Campers ({registeredChildren.length})
                </h4>
                <div className="grid md:grid-cols-2 gap-4">
                  {registeredChildren.map(child => (
                    <ChildCard key={child.id} child={child} />
                  ))}
                </div>
              </div>
            )}

            {allChildren.length === 0 && (
              <p className="text-gray-500 text-center py-8">No children profiles found. Children are created when parents complete onboarding.</p>
            )}
          </div>
        </div>
      );
    };

    // ==================== CAMPERS TAB ====================
    const CampersTab = ({ parents, registrations, campers, camperParentLinks, emergencyContacts, onSaveCampers, onSaveLinks, onDeleteCamper, onSaveEmergencyContacts, showToast, addToHistory, assignments }) => {
      const [searchTerm, setSearchTerm] = useState('');
      const [sortBy, setSortBy] = useState('name');
      const [editingCamper, setEditingCamper] = useState(null);
      const [showAddForm, setShowAddForm] = useState(false);
      const [confirmDelete, setConfirmDelete] = useState(null);
      const [deleteConfirmText, setDeleteConfirmText] = useState('');
      const [managingParents, setManagingParents] = useState(null);
      const [viewingContacts, setViewingContacts] = useState(null);
      const [ecPhotoModal, setEcPhotoModal] = useState(null); // { type: 'camper' | 'ec', id, currentPhoto }
      const [viewingLargePhoto, setViewingLargePhoto] = useState(null); // url string for full-size view
      const [expandedCamper, setExpandedCamper] = useState(null); // camper id for expanded card

      const [formData, setFormData] = useState({
        name: '', birthdate: '', grade: '', phone: '', photo: null
      });

      // Get all campers
      const getAllCampers = () => {
        // All campers from the campers collection with their linked parents and registrations
        return campers.map(c => ({
          ...c,
          parents: camperParentLinks
            .filter(link => link.camperId === c.id)
            .map(link => parents.find(u => u.email === link.parentEmail))
            .filter(Boolean),
          registrations: registrations.filter(r => r.camperId === c.id || r.childId === c.id)
        }));
      };

      const allCampers = getAllCampers();

      const filteredCampers = allCampers.filter(c =>
        c.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        c.parents?.some(p => p?.name?.toLowerCase().includes(searchTerm.toLowerCase()))
      );

      const sortedCampers = [...filteredCampers].sort((a, b) => {
        switch (sortBy) {
          case 'name': return (a.name || '').localeCompare(b.name || '');
          case 'age': return (a.birthdate || '').localeCompare(b.birthdate || '');
          case 'grade': return (a.grade || '').localeCompare(b.grade || '');
          case 'registrations': return b.registrations.length - a.registrations.length;
          default: return 0;
        }
      });

      const getAge = (birthdate) => {
        if (!birthdate) return null;
        const today = new Date();
        const birth = new Date(birthdate);
        let age = today.getFullYear() - birth.getFullYear();
        const m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
        return age;
      };

      const resetForm = () => {
        setFormData({ name: '', birthdate: '', grade: '', phone: '', photo: null });
        setShowAddForm(false);
        setEditingCamper(null);
      };

      const handleSave = () => {
        if (!formData.name) {
          showToast('Name is required', 'error');
          return;
        }

        if (editingCamper) {
          // Update existing camper
          if (editingCamper.isStandalone) {
            const updated = campers.map(c => c.id === editingCamper.id ? { ...c, ...formData } : c);
            onSaveCampers(updated, `Updated camper ${formData.name}`);
          } else {
            // Legacy camper - migrate to standalone
            const newCamper = { id: editingCamper.id, ...formData, createdAt: new Date().toISOString() };
            onSaveCampers([...campers, newCamper], `Migrated and updated camper ${formData.name}`);
            // Add link to original parent
            if (editingCamper.parentEmail) {
              onSaveLinks([...camperParentLinks, { camperId: editingCamper.id, parentEmail: editingCamper.parentEmail }]);
            }
          }
        } else {
          // Add new camper
          const newCamper = {
            id: 'camper_' + Date.now(),
            ...formData,
            createdAt: new Date().toISOString()
          };
          onSaveCampers([...campers, newCamper], `Added camper ${formData.name}`);
        }
        resetForm();
        showToast(editingCamper ? 'Camper updated!' : 'Camper added!');
      };

      const handleDelete = async () => {
        if (deleteConfirmText !== 'DELETE') {
          showToast('Please type DELETE to confirm', 'error');
          return;
        }
        const camper = confirmDelete;
        if (onDeleteCamper) {
          await onDeleteCamper(camper.id, camper.name);
        } else if (camper.isStandalone) {
          onSaveCampers(campers.filter(c => c.id !== camper.id), `Deleted camper ${camper.name}`);
          onSaveLinks(camperParentLinks.filter(l => l.camperId !== camper.id));
          showToast('Camper deleted');
        }
        setConfirmDelete(null);
        setDeleteConfirmText('');
      };

      const startEdit = (camper) => {
        setFormData({
          name: camper.name || '',
          birthdate: camper.birthdate || '',
          grade: camper.grade || '',
          phone: camper.phone || '',
          photo: camper.photo || null
        });
        setEditingCamper(camper);
        setShowAddForm(true);
      };

      const toggleParentLink = (camperId, parentEmail) => {
        const exists = camperParentLinks.some(l => l.camperId === camperId && l.parentEmail === parentEmail);
        if (exists) {
          onSaveLinks(camperParentLinks.filter(l => !(l.camperId === camperId && l.parentEmail === parentEmail)));
        } else {
          onSaveLinks([...camperParentLinks, { camperId, parentEmail }]);
        }
      };

      const getCamperParents = (camperId) => {
        return camperParentLinks
          .filter(l => l.camperId === camperId)
          .map(l => users.find(u => u.email === l.parentEmail))
          .filter(Boolean);
      };

      return (
        <div className="space-y-6">
          {/* Header with search and actions */}
          <div className="bg-white rounded-xl shadow p-6">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
              <div>
                <h3 className="font-bold text-xl text-green-800">üèÄ Campers</h3>
                <p className="text-sm text-gray-500">{allCampers.length} campers registered</p>
              </div>
              <div className="flex gap-2 items-center">
                <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="px-3 py-2 border rounded-lg">
                  <option value="name">Sort by Name</option>
                  <option value="age">Sort by Age</option>
                  <option value="grade">Sort by Grade</option>
                  <option value="registrations">Sort by Registrations</option>
                </select>
                <button onClick={() => setShowAddForm(true)} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                  + Add Camper
                </button>
              </div>
            </div>

            <input
              value={searchTerm}
              onChange={e => setSearchTerm(e.target.value)}
              placeholder="Search campers or parents..."
              className="w-full px-4 py-2 border rounded-lg"
              autoComplete="off"
              data-1p-ignore="true"
            />
          </div>

          {/* Campers List */}
          {sortedCampers.length === 0 ? (
            <div className="bg-white rounded-xl shadow p-12 text-center text-gray-500">
              <p className="text-4xl mb-4">üèÄ</p>
              <p>{allCampers.length === 0 ? 'No campers yet. Campers are added when parents complete onboarding.' : 'No campers match your search'}</p>
            </div>
          ) : (
            <div className="space-y-4">
              {sortedCampers.map(camper => {
                const isExpanded = expandedCamper === camper.id;
                const camperParentEmails = (camper.parents || []).map(p => p?.email).filter(Boolean);
                const camperContacts = emergencyContacts.filter(ec => camperParentEmails.includes(ec.userEmail));
                const parentCount = camper.parents?.length || 0;
                const activeRegs = camper.registrations.filter(r => r.status !== 'cancelled');
                const totalSessions = activeRegs.reduce((sum, r) => sum + (r.sessions?.length || 0), 0);
                const paidSessions = camper.registrations.filter(r => r.status === 'approved').reduce((sum, r) => sum + (r.sessions?.length || 0), 0);
                const inPods = (() => {
                  let count = 0;
                  const asgn = assignments || {};
                  Object.keys(asgn).forEach(key => {
                    const counselors = asgn[key] || {};
                    Object.values(counselors).forEach(camperIds => {
                      if ((camperIds || []).includes(camper.id)) count++;
                    });
                  });
                  return count;
                })();

                return (
                  <div key={camper.id} className="bg-white rounded-xl shadow overflow-hidden">
                    {/* Camper Header */}
                    <div className="p-4 flex items-center gap-4">
                      <div
                        className="flex-1 cursor-pointer"
                        onClick={() => setExpandedCamper(isExpanded ? null : camper.id)}
                      >
                        <div className="flex items-center gap-3">
                          {getDisplayPhoto(camper.photo) ? (
                            <img src={getDisplayPhoto(camper.photo)} alt={camper.name} className="w-12 h-12 rounded-full object-cover" />
                          ) : (
                            <div className="w-12 h-12 rounded-full bg-teal-200 flex items-center justify-center text-xl font-bold text-teal-700">
                              {camper.name?.[0]?.toUpperCase() || '?'}
                            </div>
                          )}
                          <div>
                            <div className="flex items-center gap-2">
                              <span className="font-bold text-gray-800">{camper.name}</span>
                              {camper.grade && (
                                <span className="text-xs px-2 py-0.5 rounded-full font-medium bg-teal-100 text-teal-700">Grade {camper.grade}</span>
                              )}
                            </div>
                            <div className="text-sm text-gray-500">
                              {getAge(camper.birthdate) ? `${getAge(camper.birthdate)} years old` : ''}
                              {getAge(camper.birthdate) && camper.parents?.length > 0 ? ' ‚Ä¢ ' : ''}
                              {camper.parents?.length > 0 ? camper.parents.map(p => p?.name).filter(Boolean).join(', ') : 'No parents linked'}
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Stats */}
                      <div className="flex gap-3 text-center flex-wrap">
                        <div title="Parents linked to this camper">
                          <div className={`text-lg font-bold ${parentCount > 0 ? 'text-teal-600' : 'text-gray-400'}`}>{parentCount}</div>
                          <div className="text-xs text-gray-500">Parents</div>
                        </div>
                        <div title="Total registered session slots (non-cancelled)">
                          <div className={`text-lg font-bold ${totalSessions > 0 ? 'text-blue-600' : 'text-gray-400'}`}>{totalSessions}</div>
                          <div className="text-xs text-gray-500">Sessions</div>
                        </div>
                        <div title="Paid session slots (approved)">
                          <div className={`text-lg font-bold ${paidSessions > 0 ? 'text-green-600' : 'text-gray-400'}`}>{paidSessions}</div>
                          <div className="text-xs text-gray-500">Paid</div>
                        </div>
                        <div title="Pod assignments (date+session slots assigned to a counselor)">
                          <div className={`text-lg font-bold ${inPods > 0 ? 'text-purple-600' : 'text-gray-400'}`}>{inPods}</div>
                          <div className="text-xs text-gray-500">In Pods</div>
                        </div>
                      </div>

                      {/* Actions */}
                      <div className="flex gap-2">
                        <button
                          onClick={(e) => { e.stopPropagation(); startEdit(camper); }}
                          className="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 text-sm"
                        >
                          ‚úèÔ∏è Edit
                        </button>
                        <button
                          onClick={() => setExpandedCamper(isExpanded ? null : camper.id)}
                          className="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-sm"
                        >
                          {isExpanded ? '‚ñ≤ Less' : '‚ñº More'}
                        </button>
                      </div>
                    </div>

                    {/* Expanded Details */}
                    {isExpanded && (
                      <div className="border-t bg-gray-50 p-4">
                        {/* Admin Actions Bar */}
                        <div className="flex gap-2 mb-4 pb-4 border-b">
                          <button
                            onClick={() => startEdit(camper)}
                            className="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm"
                          >
                            ‚úèÔ∏è Edit Camper
                          </button>
                          <button
                            onClick={() => setManagingParents(camper)}
                            className="px-3 py-1.5 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 text-sm"
                          >
                            üë®‚Äçüë©‚Äçüëß Manage Parents
                          </button>
                          {camperContacts.length > 0 && (
                            <button
                              onClick={() => {
                                const resolvedContacts = camperContacts.map(contact => {
                                  if (contact.isParent && contact.parentEmail) {
                                    const p = (parents || []).find(pr => pr.email === contact.parentEmail);
                                    if (p) return { ...contact, name: p.name };
                                  }
                                  if (contact.isAutoCreated && contact.sourceEmail) {
                                    const p = (parents || []).find(pr => pr.email === contact.sourceEmail);
                                    if (p) return { ...contact, name: p.name };
                                  }
                                  return contact;
                                });
                                setViewingContacts({ camper, contacts: resolvedContacts });
                              }}
                              className="px-3 py-1.5 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 text-sm"
                            >
                              üìû View Emergency Contacts
                            </button>
                          )}
                          <button
                            onClick={() => setConfirmDelete(camper)}
                            className="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 text-sm"
                          >
                            üóëÔ∏è Delete Camper
                          </button>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6">
                          {/* Parents */}
                          <div>
                            <div className="flex justify-between items-center mb-3">
                              <h4 className="font-bold text-gray-700">üë®‚Äçüë©‚Äçüëß Parents ({camper.parents?.length || 0})</h4>
                              <button
                                onClick={() => setManagingParents(camper)}
                                className="text-xs text-blue-600 hover:underline"
                              >
                                Manage Parents
                              </button>
                            </div>
                            {(!camper.parents || camper.parents.length === 0) ? (
                              <p className="text-gray-500 text-sm">No parents linked yet. Click "Manage Parents" to add.</p>
                            ) : (
                              <div className="space-y-2">
                                {camper.parents.map(p => p && (
                                  <div key={p.email} className="flex items-center gap-3 p-2 bg-white rounded-lg">
                                    <div className="w-8 h-8 rounded-full bg-green-200 flex items-center justify-center text-sm font-bold text-green-700">
                                      {p.name?.[0]?.toUpperCase() || '?'}
                                    </div>
                                    <div className="flex-1">
                                      <div className="font-medium text-sm">{p.name}</div>
                                      <div className="text-xs text-gray-500">{p.email}</div>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>

                          {/* Registrations */}
                          <div>
                            <h4 className="font-bold text-gray-700 mb-3">üìã Registrations ({camper.registrations.length})</h4>
                            {camper.registrations.length === 0 ? (
                              <p className="text-gray-500 text-sm">No registrations yet</p>
                            ) : (
                              <div className="space-y-2 max-h-48 overflow-y-auto">
                                {camper.registrations.map(reg => (
                                  <div key={reg.id} className="flex items-center gap-2 p-2 bg-white rounded-lg text-sm">
                                    <div className="flex-1">
                                      <div className="font-medium">{new Date(reg.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div>
                                      <div className="text-xs text-gray-500">{reg.sessions?.map(s => s === 'morning' ? 'AM' : 'PM').join(' + ')}</div>
                                    </div>
                                    <span className={`px-2 py-0.5 rounded text-xs ${
                                      reg.status === 'approved' ? 'bg-green-100 text-green-700' :
                                      reg.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                                      'bg-gray-100 text-gray-600'
                                    }`}>{reg.status}</span>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>

                        {/* Emergency Contacts */}
                        {camperContacts.length > 0 && (
                          <div className="mt-4 pt-4 border-t">
                            <h4 className="font-bold text-gray-700 mb-3">üìû Emergency Contacts ({camperContacts.length})</h4>
                            <div className="flex gap-2 flex-wrap">
                              {camperContacts.map((contact, idx) => (
                                <div key={idx} className="text-sm px-3 py-1.5 bg-white rounded-lg border">
                                  <span className="font-medium">{contact.name}</span>
                                  <span className="text-gray-500 ml-1">‚Ä¢ {contact.relationship}</span>
                                  <span className="text-gray-500 ml-1">‚Ä¢ {contact.phone}</span>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )}

          {/* Add/Edit Camper Modal */}
          {showAddForm && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                <h3 className="font-bold text-xl mb-4">{editingCamper ? 'Edit Camper' : 'Add New Camper'}</h3>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Name *</label>
                    <input
                      value={formData.name}
                      onChange={e => setFormData({ ...formData, name: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg"
                      placeholder="Camper's full name"
                      autoComplete="off"
                      data-1p-ignore="true"
                    />
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Birthdate</label>
                    <input
                      type="date"
                      value={formData.birthdate}
                      onChange={e => setFormData({ ...formData, birthdate: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg"
                      min={new Date(new Date().getFullYear() - 15, 0, 1).toISOString().split('T')[0]}
                      max={new Date().toISOString().split('T')[0]}
                    />
                    {formData.birthdate && (
                      <p className="text-sm text-gray-500 mt-1">Age: {getAge(formData.birthdate)} years old</p>
                    )}
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Grade (Fall 2026)</label>
                    <select
                      value={formData.grade}
                      onChange={e => setFormData({ ...formData, grade: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg"
                    >
                      <option value="">Select grade...</option>
                      <option value="3rd">3rd Grade</option>
                      <option value="4th">4th Grade</option>
                      <option value="5th">5th Grade</option>
                      <option value="6th">6th Grade</option>
                      <option value="7th">7th Grade</option>
                      <option value="8th">8th Grade</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Phone (optional)</label>
                    <input
                      value={formData.phone}
                      onChange={e => setFormData({ ...formData, phone: formatPhone(e.target.value) })}
                      className="w-full px-3 py-2 border rounded-lg"
                      placeholder="(555) 555-5555"
                      autoComplete="off"
                      data-1p-ignore="true"
                    />
                  </div>
                </div>

                {/* Emergency Contacts for Editing Camper */}
                {editingCamper && (() => {
                  const camperContacts = emergencyContacts.filter(ec =>
                    editingCamper.parents?.some(p => ec.userEmail === p?.email)
                  );
                  return camperContacts.length > 0 ? (
                    <div className="mt-4 pt-4 border-t">
                      <h4 className="font-medium text-gray-700 mb-2">Emergency Contacts ({camperContacts.length})</h4>
                      <div className="space-y-2">
                        {camperContacts.map((contact, idx) => (
                          <div key={idx} className="text-sm p-2 bg-gray-50 rounded border">
                            <div className="font-medium">{contact.name} {contact.isParent && <span className="text-xs text-blue-600">(Parent)</span>}</div>
                            <div className="text-gray-600">{contact.relationship} ‚Ä¢ {contact.phone}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                  ) : null;
                })()}

                <div className="flex gap-3 mt-6">
                  <button onClick={resetForm} className="flex-1 px-4 py-2 border rounded-lg">Cancel</button>
                  <button onClick={handleSave} className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    {editingCamper ? 'Save Changes' : 'Add Camper'}
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Delete Confirmation Modal */}
          {confirmDelete && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-md w-full p-6 text-center" onClick={e => e.stopPropagation()}>
                <div className="text-5xl mb-4">‚ö†Ô∏è</div>
                <h3 className="font-bold text-xl text-red-600 mb-2">Delete Camper</h3>
                <p className="text-gray-600 mb-4">
                  Are you sure you want to delete <strong>{confirmDelete.name}</strong>?
                  <br />This will also remove all their registrations.
                </p>
                <p className="text-sm text-gray-500 mb-2">Type DELETE to confirm:</p>
                <input
                  value={deleteConfirmText}
                  onChange={e => setDeleteConfirmText(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg text-center font-mono mb-4"
                  placeholder="DELETE"
                  autoComplete="off"
                  data-1p-ignore="true"
                />
                <div className="flex gap-3">
                  <button onClick={() => { setConfirmDelete(null); setDeleteConfirmText(''); }} className="flex-1 px-4 py-2 border rounded-lg">Cancel</button>
                  <button onClick={handleDelete} disabled={deleteConfirmText !== 'DELETE'} className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-300">
                    Delete Camper
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Manage Parents Modal */}
          {managingParents && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                <h3 className="font-bold text-xl mb-2">Manage Parents for {managingParents.name}</h3>
                <p className="text-sm text-gray-500 mb-4">Select which parents are associated with this camper. A camper can have multiple parents.</p>

                {parents.length === 0 ? (
                  <p className="text-gray-500 text-center py-8">No parent accounts exist yet.</p>
                ) : (
                  <div className="space-y-2 mb-4">
                    {parents.map(parent => {
                      const isLinked = managingParents.isStandalone
                        ? camperParentLinks.some(l => l.camperId === managingParents.id && l.parentEmail === parent.email)
                        : managingParents.parentEmail === parent.email;
                      return (
                        <label key={parent.email} className={`flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 ${isLinked ? 'border-green-500 bg-green-50' : ''}`}>
                          <input
                            type="checkbox"
                            checked={isLinked}
                            onChange={() => {
                              if (managingParents.isStandalone) {
                                toggleParentLink(managingParents.id, parent.email);
                              } else {
                                showToast('Migrate camper to standalone first by editing', 'error');
                              }
                            }}
                            className="w-5 h-5"
                            disabled={!managingParents.isStandalone}
                          />
                          <div>
                            <div className="font-medium">{parent.name}</div>
                            <div className="text-sm text-gray-500">{parent.email}</div>
                          </div>
                        </label>
                      );
                    })}
                  </div>
                )}

                {!managingParents.isStandalone && (
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4 text-sm text-yellow-800">
                    ‚ö†Ô∏è This is a legacy camper. Edit and save to enable multi-parent support.
                  </div>
                )}

                <button onClick={() => setManagingParents(null)} className="w-full px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">
                  Done
                </button>
              </div>
            </div>
          )}

          {/* Emergency Contacts Viewing Modal */}
          {viewingContacts && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={() => setViewingContacts(null)}>
              <div className="bg-white rounded-xl max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                <h3 className="font-bold text-xl mb-4">Emergency Contacts for {viewingContacts.camper.name}</h3>

                {/* Camper Photo */}
                <div className="flex items-center gap-4 mb-5 p-4 bg-green-50 border-2 border-green-300 rounded-lg">
                  <div className="flex-shrink-0">
                    {getDisplayPhoto(viewingContacts.camper.photo) ? (
                      <img
                        src={getDisplayPhoto(viewingContacts.camper.photo)}
                        className="w-20 h-20 rounded-full object-cover border-2 border-green-600 cursor-pointer hover:opacity-80"
                        onClick={() => setViewingLargePhoto(getDisplayPhoto(viewingContacts.camper.photo))}
                        title="Click to view larger"
                      />
                    ) : (
                      <div
                        onClick={() => setEcPhotoModal({ type: 'camper', id: viewingContacts.camper.id, currentPhoto: viewingContacts.camper.photo })}
                        className="w-20 h-20 rounded-full bg-gray-200 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300"
                      >
                        <svg className="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                        <span className="text-[8px] text-gray-500 font-medium">add photo</span>
                      </div>
                    )}
                  </div>
                  <div>
                    <div className="font-bold text-lg text-green-800">{viewingContacts.camper.name}</div>
                    <div className="text-sm text-green-600">Camper</div>
                    <button
                      onClick={() => setEcPhotoModal({ type: 'camper', id: viewingContacts.camper.id, currentPhoto: viewingContacts.camper.photo })}
                      className="text-xs text-blue-600 hover:text-blue-800 mt-1"
                    >
                      {getDisplayPhoto(viewingContacts.camper.photo) ? 'Change photo' : 'Add photo'}
                    </button>
                  </div>
                </div>

                <p className="text-sm text-gray-500 mb-3">{viewingContacts.contacts.length} emergency contact{viewingContacts.contacts.length > 1 ? 's' : ''}</p>

                <div className="space-y-3">
                  {viewingContacts.contacts.map((contact, idx) => (
                    <div key={idx} className="border rounded-lg p-4 bg-gray-50">
                      <div className="flex items-start gap-4">
                        {/* EC Photo */}
                        <div className="flex-shrink-0">
                          {getDisplayPhoto(contact.photo) ? (
                            <img
                              src={getDisplayPhoto(contact.photo)}
                              className="w-16 h-16 rounded-full object-cover border-2 border-gray-400 cursor-pointer hover:opacity-80"
                              onClick={() => setViewingLargePhoto(getDisplayPhoto(contact.photo))}
                              title="Click to view larger"
                            />
                          ) : (
                            <div
                              onClick={() => setEcPhotoModal({ type: 'ec', id: contact.id, currentPhoto: contact.photo })}
                              className="w-16 h-16 rounded-full bg-gray-200 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300"
                            >
                              <svg className="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                              <span className="text-[6px] text-gray-500 font-medium">add photo</span>
                            </div>
                          )}
                        </div>
                        {/* EC Info */}
                        <div className="flex-1 min-w-0">
                          <div className="flex items-start justify-between mb-2">
                            <div className="font-medium text-lg">{contact.name}</div>
                            {contact.isParent && (
                              <span className="px-2 py-1 rounded text-xs bg-blue-100 text-blue-700 flex-shrink-0">Parent</span>
                            )}
                          </div>
                          <div className="space-y-1 text-sm">
                            <div className="flex items-center gap-2">
                              <span className="text-gray-500 w-24">Relationship:</span>
                              <span className="font-medium">{contact.relationship}</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <span className="text-gray-500 w-24">Phone:</span>
                              <span className="font-medium">{contact.phone}</span>
                            </div>
                            {contact.email && (
                              <div className="flex items-center gap-2">
                                <span className="text-gray-500 w-24">Email:</span>
                                <span className="font-medium">{contact.email}</span>
                              </div>
                            )}
                          </div>
                          <button
                            onClick={() => setEcPhotoModal({ type: 'ec', id: contact.id, currentPhoto: contact.photo })}
                            className="text-xs text-blue-600 hover:text-blue-800 mt-2"
                          >
                            {getDisplayPhoto(contact.photo) ? 'Change photo' : 'Add photo'}
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                <button onClick={() => setViewingContacts(null)} className="w-full px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 mt-4">
                  Close
                </button>
              </div>
            </div>
          )}

          {/* Large Photo Viewer */}
          {viewingLargePhoto && (
            <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4" onClick={() => setViewingLargePhoto(null)}>
              <div className="relative max-w-md w-full" onClick={e => e.stopPropagation()}>
                <img src={viewingLargePhoto} className="w-full rounded-xl object-cover" />
                <button
                  onClick={() => setViewingLargePhoto(null)}
                  className="absolute top-2 right-2 w-8 h-8 bg-white/80 rounded-full flex items-center justify-center text-gray-700 hover:bg-white text-lg font-bold"
                >
                  ‚úï
                </button>
              </div>
            </div>
          )}

          {/* Photo Upload Modal for EC popup */}
          {ecPhotoModal && (
            <PhotoUploadModal
              currentPhoto={ecPhotoModal.currentPhoto}
              onSave={(img) => {
                if (ecPhotoModal.type === 'camper') {
                  const updated = campers.map(c => c.id === ecPhotoModal.id ? { ...c, photo: img } : c);
                  onSaveCampers(updated, `Updated photo for camper`);
                  setViewingContacts(prev => prev ? { ...prev, camper: { ...prev.camper, photo: img } } : null);
                } else {
                  const updated = (emergencyContacts || []).map(ec => ec.id === ecPhotoModal.id ? { ...ec, photo: img } : ec);
                  onSaveEmergencyContacts(updated, `Updated photo for emergency contact`);
                  setViewingContacts(prev => prev ? {
                    ...prev,
                    contacts: prev.contacts.map(c => c.id === ecPhotoModal.id ? { ...c, photo: img } : c)
                  } : null);
                }
                setEcPhotoModal(null);
                showToast('Photo updated!', 'success');
              }}
              onCancel={() => setEcPhotoModal(null)}
            />
          )}
        </div>
      );
    };

    // ==================== ASSIGNMENTS TAB ====================
    const AssignmentsTab = ({ registrations, counselors, users, assignments, availability, onSaveAssignments, showToast, selectedMonth, setSelectedMonth, campers: allCampers, selectedDate, setSelectedDate, selectedSession, setSelectedSession, sessionPods, setSessionPods, podCalWeeks, setPodCalWeeks, podCalDates, setPodCalDates, podCamperView, setPodCamperView, podSelectedCamper, setPodSelectedCamper, counselorSchedule }) => {
      const [draggedItem, setDraggedItem] = useState(null); // { type: 'camper' | 'counselor', data: ... }
      const [dragOverTarget, setDragOverTarget] = useState(null); // { podId, type: 'camper' | 'counselor' }

      // Get months that have camp dates
      const getMonths = () => {
        const months = [];
        CAMP_DATES.forEach(date => {
          const d = new Date(date + 'T12:00:00');
          const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
          if (!months.some(m => m.key === monthKey)) {
            months.push({
              key: monthKey,
              name: d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
              year: d.getFullYear(),
              month: d.getMonth()
            });
          }
        });
        return months;
      };

      const months = getMonths();

      // Initialize selected month if not set
      React.useEffect(() => {
        if (!selectedMonth && months.length > 0) {
          setSelectedMonth(months[0].key);
        }
      }, [selectedMonth, months, setSelectedMonth]);

      // Auto-initialize week filter when month changes
      // All dates for selected month (unfiltered)
      const allPodMonthDates = React.useMemo(() => {
        if (!selectedMonth) return [];
        const [year, month] = selectedMonth.split('-').map(Number);
        return CAMP_DATES.filter(date => {
          const d = new Date(date + 'T12:00:00');
          return d.getFullYear() === year && d.getMonth() === month - 1;
        });
      }, [selectedMonth]);

      const podAvailableWeeks = React.useMemo(() => {
        if (!selectedMonth) return [];
        const [year, month] = selectedMonth.split('-').map(Number);
        return CAMP_WEEKS.filter(w => {
          const d = new Date(w.start + 'T12:00:00');
          return d.getFullYear() === year && d.getMonth() === month - 1;
        });
      }, [selectedMonth]);
      const podAvailableWeekStarts = podAvailableWeeks.map(w => w.start);
      // Re-init when month changes (reset to all selected for the new month)
      const prevMonthRef = React.useRef(selectedMonth);
      React.useEffect(() => {
        if (selectedMonth !== prevMonthRef.current || podCalWeeks === null) {
          prevMonthRef.current = selectedMonth;
          if (podAvailableWeekStarts.length > 0) setPodCalWeeks([...podAvailableWeekStarts]);
          if (allPodMonthDates.length > 0) setPodCalDates([...allPodMonthDates]);
        }
      }, [selectedMonth]);

      const safePodWeeks = podCalWeeks || [];
      const safePodDates = podCalDates || [];

      // Dates filtered by week selection (for date pill display)
      const podWeekFilteredDates = allPodMonthDates.filter(d => {
        const week = CAMP_WEEKS.find(w => w.dates.includes(d));
        return !week || safePodWeeks.length === 0 || safePodWeeks.includes(week.start);
      });

      // Final filtered dates
      const monthDates = podWeekFilteredDates.filter(d => safePodDates.includes(d));

      // Get session key
      const getSessionKey = () => selectedDate ? `${selectedDate}_${selectedSession}` : '';

      // Get or initialize pods for current session
      const getCurrentPods = () => {
        const key = getSessionKey();
        if (!key) return [];

        // If we have pods stored in state, use them
        if (sessionPods[key] && Array.isArray(sessionPods[key]) && sessionPods[key].length > 0) {
          return sessionPods[key];
        }

        // Otherwise, initialize from existing assignments
        const existingAssignments = assignments[key] || {};
        const pods = Object.entries(existingAssignments).map(([counselorId, camperIds]) => ({
          id: 'pod_' + counselorId,
          counselorId,
          camperIds: camperIds || []
        }));

        // If no existing assignments, start with one empty pod
        if (pods.length === 0) {
          pods.push({ id: 'pod_empty_1', counselorId: null, camperIds: [] });
        }

        // Store initialized pods so subsequent calls return the same data
        setSessionPods(prev => ({ ...prev, [key]: pods }));
        return pods;
      };

      // Save pods and sync to assignments
      const savePods = (newPods) => {
        const key = getSessionKey();
        if (!key) return;

        // Normalize pod IDs: pods with counselors should have ID based on counselorId
        const normalizedPods = newPods.map(pod => {
          if (pod.counselorId && !pod.id.startsWith('pod_' + pod.counselorId)) {
            // Update pod ID to be consistent with counselor ID
            return { ...pod, id: 'pod_' + pod.counselorId };
          }
          return pod;
        });

        setSessionPods(prev => ({ ...prev, [key]: normalizedPods }));

        // Sync to assignments format
        const newAssignments = { ...assignments };
        newAssignments[key] = {};
        normalizedPods.forEach(pod => {
          // Save any pod that has a counselor assigned (even if no campers yet)
          if (pod.counselorId) {
            newAssignments[key][pod.counselorId] = pod.camperIds || [];
          }
        });
        onSaveAssignments(newAssignments, 'Updated pod assignments');
      };

      // Add new empty pod
      const addPod = () => {
        const pods = getCurrentPods();
        const newPod = { id: 'pod_empty_' + Date.now(), counselorId: null, camperIds: [] };
        savePods([...pods, newPod]);
        showToast('New pod added');
      };

      // Remove pod (counselors and campers are automatically returned to unassigned sections)
      const removePod = (podId) => {
        const pods = getCurrentPods();
        const pod = pods.find(p => p.id === podId);

        // Don't allow removing the last pod
        if (pods.length === 1) {
          showToast('Cannot remove the last pod', 'error');
          return;
        }

        // Remove the pod (counselor and campers will automatically appear as unassigned)
        savePods(pods.filter(p => p.id !== podId));

        if (pod?.counselorId || pod?.camperIds?.length > 0) {
          showToast('Pod removed - counselor and campers returned to unassigned');
        } else {
          showToast('Pod removed');
        }
      };

      // Get approved registrations for the selected date/session
      const getSessionRegs = () => {
        if (!selectedDate) return [];
        return registrations.filter(r =>
          r.date === selectedDate &&
          r.sessions?.includes(selectedSession) &&
          r.status === 'approved'
        );
      };

      // Get all assigned camper IDs across all pods
      const getAssignedCamperIds = () => {
        const pods = getCurrentPods();
        return pods.flatMap(p => p.camperIds);
      };

      // Get all assigned counselor IDs across all pods
      const getAssignedCounselorIds = () => {
        const pods = getCurrentPods();
        return pods.map(p => p.counselorId).filter(Boolean);
      };

      // Get unassigned campers
      const getUnassignedCampers = () => {
        const assigned = getAssignedCamperIds();
        return getSessionRegs().filter(r => !assigned.includes(r.childId) && !assigned.includes(r.camperId));
      };

      // Check if counselor is eligible (marked available for this date/session)
      const isCounselorEligible = (counselor) => {
        if (!selectedDate) return false;
        const counselorAvail = availability[counselor.email];
        if (!counselorAvail) return false;
        const dateAvail = counselorAvail[selectedDate];
        if (!dateAvail) return false;
        // Check both new format and legacy format
        return dateAvail.available?.includes(selectedSession) ||
               (Array.isArray(dateAvail) && dateAvail.includes(selectedSession));
      };

      // Get eligible counselors (marked available for this session, not yet assigned to a pod)
      const getEligibleCounselors = () => {
        const assigned = getAssignedCounselorIds();
        return counselors.filter(c => c.visible && !assigned.includes(c.id) && isCounselorEligible(c));
      };

      // Get not-eligible counselors (NOT marked available for this session, not yet assigned to a pod)
      const getNotEligibleCounselors = () => {
        const assigned = getAssignedCounselorIds();
        return counselors.filter(c => c.visible && !assigned.includes(c.id) && !isCounselorEligible(c));
      };

      // Get all unassigned counselors (for backward compatibility)
      const getUnassignedCounselors = () => {
        const assigned = getAssignedCounselorIds();
        return counselors.filter(c => c.visible && !assigned.includes(c.id));
      };

      // Calculate summary stats
      const getSummary = () => {
        const regs = getSessionRegs();
        const pods = getCurrentPods();
        const assignedCampers = getAssignedCamperIds().length;
        const podsWithCounselors = pods.filter(p => p.counselorId).length;
        const totalCapacity = podsWithCounselors * KIDS_PER_COUNSELOR;

        return {
          totalCampers: regs.length,
          assignedCount: assignedCampers,
          unassignedCount: regs.length - assignedCampers,
          podCount: pods.length,
          podsWithCounselors,
          totalCapacity,
          overCapacity: regs.length > totalCapacity && totalCapacity > 0
        };
      };

      // Handle drag start for campers
      const handleCamperDragStart = (e, camper) => {
        setDraggedItem({ type: 'camper', data: camper });
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', ''); // Required for Firefox
      };

      // Handle drag start for counselors
      const handleCounselorDragStart = (e, counselor) => {
        setDraggedItem({ type: 'counselor', data: counselor });
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', ''); // Required for Firefox
      };

      // Handle drag end (cleanup)
      const handleDragEnd = () => {
        setDragOverTarget(null);
      };

      // Click-to-select (works on touch devices where drag doesn't work)
      const handleItemClick = (type, data) => {
        if (draggedItem && draggedItem.type === type && draggedItem.data.id === data.id) {
          // Clicking same item again deselects it
          setDraggedItem(null);
        } else {
          setDraggedItem({ type, data });
        }
      };

      // Click on pod slot to place selected item
      const handlePodCounselorClick = (podId) => {
        if (!draggedItem || draggedItem.type !== 'counselor') return;
        const pods = getCurrentPods();
        const counselor = draggedItem.data;
        const existingPod = pods.find(p => p.counselorId === counselor.id);
        if (existingPod && existingPod.id !== podId) {
          existingPod.counselorId = null;
        }
        const targetPod = pods.find(p => p.id === podId);
        if (targetPod) {
          targetPod.counselorId = counselor.id;
        }
        savePods([...pods]);
        setDraggedItem(null);
        showToast(counselor.name + ' assigned to pod');
      };

      const handlePodCamperClick = (podId) => {
        if (!draggedItem || draggedItem.type !== 'camper') return;
        const pods = getCurrentPods();
        const camper = draggedItem.data;
        const camperId = camper.childId || camper.camperId;
        const targetPod = pods.find(p => p.id === podId);
        if (!targetPod) return;
        if (targetPod.camperIds.length >= KIDS_PER_COUNSELOR && !targetPod.camperIds.includes(camperId)) {
          showToast('Pod is at capacity (' + KIDS_PER_COUNSELOR + ' campers max)', 'error');
          setDraggedItem(null);
          return;
        }
        pods.forEach(p => { p.camperIds = p.camperIds.filter(id => id !== camperId); });
        if (!targetPod.camperIds.includes(camperId)) {
          targetPod.camperIds.push(camperId);
        }
        savePods([...pods]);
        setDraggedItem(null);
        showToast('Camper assigned to pod');
      };

      // Handle drop on pod's counselor slot
      const handleDropCounselor = (e, podId) => {
        e.preventDefault();
        setDragOverTarget(null);
        if (!draggedItem || draggedItem.type !== 'counselor') return;

        const pods = getCurrentPods();
        const counselor = draggedItem.data;

        // Check if counselor is already assigned to another pod
        const existingPod = pods.find(p => p.counselorId === counselor.id);
        if (existingPod && existingPod.id !== podId) {
          existingPod.counselorId = null;
        }

        // Assign to new pod
        const targetPod = pods.find(p => p.id === podId);
        if (targetPod) {
          targetPod.counselorId = counselor.id;
        }

        savePods([...pods]);
        setDraggedItem(null);
        showToast(`${counselor.name} assigned to pod`);
      };

      // Handle drop on pod's camper area
      const handleDropCamper = (e, podId, slotIndex) => {
        e.preventDefault();
        setDragOverTarget(null);
        if (!draggedItem || draggedItem.type !== 'camper') return;

        const pods = getCurrentPods();
        const camper = draggedItem.data;
        const camperId = camper.childId || camper.camperId;

        const targetPod = pods.find(p => p.id === podId);
        if (!targetPod) return;

        // Check capacity
        if (targetPod.camperIds.length >= KIDS_PER_COUNSELOR && !targetPod.camperIds.includes(camperId)) {
          showToast(`Pod is at capacity (${KIDS_PER_COUNSELOR} campers max)`, 'error');
          setDraggedItem(null);
          return;
        }

        // Remove camper from any existing pod
        pods.forEach(p => {
          p.camperIds = p.camperIds.filter(id => id !== camperId);
        });

        // Add to target pod
        if (!targetPod.camperIds.includes(camperId)) {
          targetPod.camperIds.push(camperId);
        }

        savePods([...pods]);
        setDraggedItem(null);
        showToast('Camper assigned to pod');
      };

      // Remove a counselor from a pod (click-based, for touch devices)
      const removeCounselorFromPod = (podId) => {
        const pods = getCurrentPods();
        const pod = pods.find(p => p.id === podId);
        if (!pod || !pod.counselorId) return;
        const counselor = counselors.find(c => c.id === pod.counselorId);
        pod.counselorId = null;
        savePods([...pods]);
        showToast((counselor?.name || 'Counselor') + ' removed from pod');
      };

      // Remove a camper from a pod (click-based, for touch devices)
      const removeCamperFromPod = (podId, camperId) => {
        const pods = getCurrentPods();
        const pod = pods.find(p => p.id === podId);
        if (!pod) return;
        pod.camperIds = pod.camperIds.filter(id => id !== camperId);
        savePods([...pods]);
        showToast('Camper removed from pod');
      };

      // Handle drop on unassigned area (remove from pod)
      const handleDropUnassigned = (e) => {
        e.preventDefault();
        setDragOverTarget(null);
        if (!draggedItem) return;

        const pods = getCurrentPods();

        if (draggedItem.type === 'camper') {
          const camperId = draggedItem.data.childId || draggedItem.data.camperId;
          pods.forEach(p => {
            p.camperIds = p.camperIds.filter(id => id !== camperId);
          });
          savePods([...pods]);
          showToast('Camper removed from pod');
        } else if (draggedItem.type === 'counselor') {
          const counselorId = draggedItem.data.id;
          pods.forEach(p => {
            if (p.counselorId === counselorId) {
              p.counselorId = null;
            }
          });
          savePods([...pods]);
          showToast('Counselor removed from pod');
        }

        setDraggedItem(null);
      };

      // Get camper name from ID
      const getCamperName = (camperId) => {
        const reg = registrations.find(r => r.childId === camperId || r.camperId === camperId);
        return reg?.camperName || reg?.childName || 'Unknown';
      };

      // Get camper info for display
      const getCamperInfo = (camperId) => {
        const reg = registrations.find(r => r.childId === camperId || r.camperId === camperId);
        return reg;
      };

      // Get full camper profile (photo, grade, birthdate)
      const getCamperProfile = (camperId) => {
        return (allCampers || []).find(c => c.id === camperId);
      };

      // Get counselor by ID
      const getCounselor = (counselorId) => counselors.find(c => c.id === counselorId);

      const summary = getSummary();
      const formatDate = (dateStr) => {
        const d = new Date(dateStr + 'T12:00:00');
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return `${days[d.getDay()]}, ${months[d.getMonth()]} ${d.getDate()}`;
      };

      // Helper to get stats for a date/session (campers, counselors, pods)
      const getDateSessionStats = (date, session) => {
        const regs = registrations.filter(r =>
          r.date === date &&
          r.sessions?.includes(session) &&
          r.status === 'approved'
        );
        const key = `${date}_${session}`;
        const sessionAssignments = assignments[key] || {};
        const assignedCampers = Object.values(sessionAssignments).flat().length;
        const assignedCounselors = Object.keys(sessionAssignments).filter(cId => sessionAssignments[cId]?.length > 0 || Object.keys(sessionAssignments).includes(cId)).length;
        const podCount = Object.keys(sessionAssignments).length;
        // Count eligible counselors for this date/session
        const eligibleCounselors = counselors.filter(c => {
          if (!c.visible) return false;
          const counselorAvail = availability[c.email];
          if (!counselorAvail) return false;
          const dateAvail = counselorAvail[date];
          if (!dateAvail) return false;
          return dateAvail.available?.includes(session) ||
                 (Array.isArray(dateAvail) && dateAvail.includes(session));
        }).length;
        return { registered: regs.length, assigned: assignedCampers, assignedCounselors, eligibleCounselors, podCount };
      };

      const getDayName = (date) => {
        const d = new Date(date + 'T12:00:00');
        return d.toLocaleDateString('en-US', { weekday: 'short' });
      };

      const formatDateShort = (date) => {
        const d = new Date(date + 'T12:00:00');
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      };

      const pods = getCurrentPods();

      // === CAMPER VIEW HELPERS ===
      const getCampersWithApprovedRegs = () => {
        const camperMap = {};
        registrations.filter(r => r.status === 'approved').forEach(r => {
          const id = r.camperId || r.childId;
          const name = r.camperName || r.childName || 'Unknown';
          if (!camperMap[id]) camperMap[id] = { id, name, regs: [] };
          camperMap[id].regs.push(r);
        });
        return Object.values(camperMap).sort((a, b) => a.name.localeCompare(b.name));
      };

      const getCamperSessions = (camperId) => {
        const camperRegs = registrations.filter(r =>
          (r.camperId === camperId || r.childId === camperId) && r.status === 'approved'
        );
        const sessions = [];
        camperRegs.forEach(r => {
          (r.sessions || []).forEach(session => {
            const key = `${r.date}_${session}`;
            const sessionAssignments = assignments[key] || {};
            let assignedCounselorId = null;
            Object.entries(sessionAssignments).forEach(([cId, camperIds]) => {
              if ((camperIds || []).includes(camperId)) assignedCounselorId = cId;
            });
            const assignedCounselor = assignedCounselorId ? counselors.find(c => c.id === assignedCounselorId) : null;
            const eligible = counselors.filter(c => {
              const cs = counselorSchedule[c.id] || {};
              const daySchedule = cs[r.date] || {};
              return daySchedule[session] === true;
            });
            sessions.push({ date: r.date, session, key, assignedCounselorId, assignedCounselor, eligibleCounselors: eligible });
          });
        });
        return sessions.sort((a, b) => a.date.localeCompare(b.date) || a.session.localeCompare(b.session));
      };

      const handleCamperSessionAssign = (camperId, sessionInfo, newCounselorId) => {
        const key = sessionInfo.key;
        const newAssignments = JSON.parse(JSON.stringify(assignments));
        if (newAssignments[key]) {
          Object.keys(newAssignments[key]).forEach(cId => {
            newAssignments[key][cId] = (newAssignments[key][cId] || []).filter(id => id !== camperId);
            if (newAssignments[key][cId].length === 0) delete newAssignments[key][cId];
          });
        }
        if (newCounselorId) {
          if (!newAssignments[key]) newAssignments[key] = {};
          if (!newAssignments[key][newCounselorId]) newAssignments[key][newCounselorId] = [];
          newAssignments[key][newCounselorId].push(camperId);
        }
        onSaveAssignments(newAssignments, `Assigned camper for ${key}`);
        setSessionPods(prev => { const u = { ...prev }; delete u[key]; return u; });
      };

      const handleBulkAssign = (camperId) => {
        const sessions = getCamperSessions(camperId);
        const unassigned = sessions.filter(s => !s.assignedCounselorId);
        if (unassigned.length === 0) { showToast('All sessions already assigned'); return; }
        const newAssignments = JSON.parse(JSON.stringify(assignments));
        let assignedCount = 0;
        const affectedKeys = [];
        unassigned.forEach(s => {
          if (s.eligibleCounselors.length === 0) return;
          const withLoad = s.eligibleCounselors.map(c => ({
            counselor: c,
            load: ((newAssignments[s.key] || {})[c.id] || []).length
          }));
          withLoad.sort((a, b) => a.load - b.load);
          const best = withLoad.find(w => w.load < KIDS_PER_COUNSELOR);
          if (!best) return;
          if (!newAssignments[s.key]) newAssignments[s.key] = {};
          if (!newAssignments[s.key][best.counselor.id]) newAssignments[s.key][best.counselor.id] = [];
          newAssignments[s.key][best.counselor.id].push(camperId);
          affectedKeys.push(s.key);
          assignedCount++;
        });
        if (assignedCount > 0) {
          onSaveAssignments(newAssignments, `Bulk assigned camper to ${assignedCount} sessions`);
          setSessionPods(prev => { const u = { ...prev }; affectedKeys.forEach(k => delete u[k]); return u; });
          showToast(`Assigned ${assignedCount} session${assignedCount > 1 ? 's' : ''}`);
        } else {
          showToast('No eligible counselors for unassigned sessions');
        }
      };

      return (
        <div className="space-y-6">
          {/* View Mode Toggle */}
          <div className="flex gap-2">
            <button onClick={() => { setPodCamperView(false); setPodSelectedCamper(null); }}
              className={`px-4 py-2 rounded-lg text-sm font-medium ${!podCamperView ? 'bg-green-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>
              Date View
            </button>
            <button onClick={() => setPodCamperView(true)}
              className={`px-4 py-2 rounded-lg text-sm font-medium ${podCamperView ? 'bg-purple-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>
              Camper View
            </button>
          </div>

          {/* === CAMPER VIEW === */}
          {podCamperView && (
            <div className="space-y-4">
              <div className="bg-white rounded-xl shadow p-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">Select a Camper:</label>
                <select value={podSelectedCamper || ''}
                  onChange={e => setPodSelectedCamper(e.target.value || null)}
                  className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                  <option value="">-- Choose a camper --</option>
                  {getCampersWithApprovedRegs().map(c => (
                    <option key={c.id} value={c.id}>{c.name} ({c.regs.length} session{c.regs.length !== 1 ? 's' : ''})</option>
                  ))}
                </select>
              </div>

              {podSelectedCamper && (() => {
                const sessions = getCamperSessions(podSelectedCamper);
                const camperProfile = (allCampers || []).find(c => c.id === podSelectedCamper);
                const camperName = camperProfile?.name || getCampersWithApprovedRegs().find(c => c.id === podSelectedCamper)?.name || 'Unknown';
                const unassignedCount = sessions.filter(s => !s.assignedCounselorId).length;
                const assignedCount = sessions.filter(s => s.assignedCounselorId).length;

                return (
                  <div className="bg-white rounded-xl shadow p-4 space-y-4">
                    <div className="flex items-center justify-between flex-wrap gap-2">
                      <div>
                        <h3 className="font-bold text-lg">{camperName}</h3>
                        <p className="text-sm text-gray-500">{sessions.length} total sessions ‚Äî {assignedCount} assigned, {unassignedCount} unassigned</p>
                      </div>
                      {unassignedCount > 0 && (
                        <button onClick={() => handleBulkAssign(podSelectedCamper)}
                          className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-medium">
                          Assign All Unassigned ({unassignedCount})
                        </button>
                      )}
                    </div>

                    {sessions.length === 0 ? (
                      <p className="text-gray-500 text-sm">No approved sessions found for this camper.</p>
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="border-b bg-gray-50">
                              <th className="text-left py-2 px-3 font-medium text-gray-600">Date</th>
                              <th className="text-left py-2 px-3 font-medium text-gray-600">Day</th>
                              <th className="text-left py-2 px-3 font-medium text-gray-600">Session</th>
                              <th className="text-left py-2 px-3 font-medium text-gray-600">Status</th>
                              <th className="text-left py-2 px-3 font-medium text-gray-600">Assigned To</th>
                            </tr>
                          </thead>
                          <tbody>
                            {sessions.map(s => {
                              const dt = new Date(s.date + 'T12:00:00');
                              const dayName = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()];
                              const dateLabel = dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                              return (
                                <tr key={s.key} className="border-b hover:bg-gray-50">
                                  <td className="py-2 px-3">{dateLabel}</td>
                                  <td className="py-2 px-3">{dayName}</td>
                                  <td className="py-2 px-3">{s.session === 'morning' ? '‚òÄÔ∏è AM' : 'üåô PM'}</td>
                                  <td className="py-2 px-3">
                                    {s.assignedCounselor
                                      ? <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">Assigned</span>
                                      : <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700">Unassigned</span>}
                                  </td>
                                  <td className="py-2 px-3">
                                    <select value={s.assignedCounselorId || ''}
                                      onChange={e => handleCamperSessionAssign(podSelectedCamper, s, e.target.value || null)}
                                      className="border border-gray-300 rounded px-2 py-1 text-sm w-full max-w-xs">
                                      <option value="">Unassigned</option>
                                      {s.eligibleCounselors.map(c => (
                                        <option key={c.id} value={c.id}>{c.name || c.firstName + ' ' + c.lastName}</option>
                                      ))}
                                      {s.assignedCounselor && !s.eligibleCounselors.find(c => c.id === s.assignedCounselorId) && (
                                        <option value={s.assignedCounselorId}>{s.assignedCounselor.name} (not eligible)</option>
                                      )}
                                    </select>
                                  </td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>
                );
              })()}
            </div>
          )}

          {/* === DATE VIEW === */}
          {!podCamperView && <>
          {/* Month Selector */}
          <div className="bg-white rounded-xl shadow p-4">
            <div className="flex flex-wrap gap-2 mb-4">
              {months.map(m => (
                <button
                  key={m.key}
                  onClick={() => { setSelectedMonth(m.key); setSelectedDate(null); }}
                  className={`px-4 py-2 rounded-lg text-sm ${
                    selectedMonth === m.key
                      ? 'bg-green-600 text-white'
                      : 'bg-gray-100 hover:bg-gray-200'
                  }`}
                >
                  {m.name}
                </button>
              ))}
            </div>

            {/* Week / Date filters */}
            <div className="space-y-2 mb-4">
              <div className="flex items-center gap-2 flex-wrap">
                <span className="text-sm font-medium text-gray-700 w-14">Weeks:</span>
                <button onClick={() => { setPodCalWeeks([...podAvailableWeekStarts]); setPodCalDates([...allPodMonthDates]); }} className={'px-2 py-0.5 rounded text-xs font-medium ' + (safePodWeeks.length === podAvailableWeekStarts.length ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')}>All</button>
                <button onClick={() => { setPodCalWeeks([]); setPodCalDates([]); }} className={'px-2 py-0.5 rounded text-xs font-medium ' + (safePodWeeks.length === 0 ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')}>None</button>
                {podAvailableWeeks.map(w => {
                  const wd = new Date(w.start + 'T12:00:00');
                  const label = wd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                  const isActive = safePodWeeks.includes(w.start);
                  return (
                    <button key={w.start} onClick={() => {
                      const newWeeks = isActive ? safePodWeeks.filter(x => x !== w.start) : [...safePodWeeks, w.start].sort();
                      setPodCalWeeks(newWeeks);
                      if (isActive) {
                        setPodCalDates(prev => (prev || []).filter(d => !w.dates.includes(d)));
                      } else {
                        setPodCalDates(prev => [...new Set([...(prev || []), ...w.dates])].sort());
                      }
                    }}
                      className={`px-3 py-1 rounded-lg text-xs font-medium transition border ${isActive ? 'bg-green-100 text-green-700 border-green-300' : 'bg-gray-100 text-gray-500 border-gray-200'}`}>
                      {label}
                    </button>
                  );
                })}
              </div>
              <div className="flex items-center gap-2 flex-wrap">
                <span className="text-sm font-medium text-gray-700 w-14">Dates:</span>
                <button onClick={() => setPodCalDates([...podWeekFilteredDates])} className={'px-2 py-0.5 rounded text-xs font-medium ' + (safePodDates.length === podWeekFilteredDates.length ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')}>All</button>
                <button onClick={() => setPodCalDates([])} className={'px-2 py-0.5 rounded text-xs font-medium ' + (safePodDates.length === 0 ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')}>None</button>
                {podWeekFilteredDates.map(d => {
                  const dt = new Date(d + 'T12:00:00');
                  const dayName = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()];
                  const label = `${dayName} ${dt.getMonth() + 1}/${dt.getDate()}`;
                  const isActive = safePodDates.includes(d);
                  return (
                    <button key={d} onClick={() => setPodCalDates(prev => { const s = prev || []; return s.includes(d) ? s.filter(x => x !== d) : [...s, d].sort(); })}
                      className={`px-2 py-1 rounded-lg text-xs font-medium transition border ${isActive ? 'bg-green-100 text-green-700 border-green-300' : 'bg-gray-100 text-gray-500 border-gray-200'}`}>
                      {label}
                    </button>
                  );
                })}
              </div>
            </div>

            <p className="text-sm text-gray-500 mb-4">
              Select a date and session below to manage pod assignments. Drag counselors and campers to build your pods.
            </p>

            {/* Date Grid */}
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
              {monthDates.map(date => {
                const amStats = getDateSessionStats(date, 'morning');
                const pmStats = getDateSessionStats(date, 'afternoon');
                const isAmSelected = selectedDate === date && selectedSession === 'morning';
                const isPmSelected = selectedDate === date && selectedSession === 'afternoon';

                return (
                  <div key={date} className="rounded-lg border-2 border-gray-200 overflow-hidden">
                    {/* Date Header */}
                    <div className="p-2 text-center font-bold bg-gray-100">
                      <div className="text-xs text-gray-600">{getDayName(date)}</div>
                      <div>{formatDateShort(date)}</div>
                    </div>

                    {/* Session Buttons */}
                    <div className="p-2 space-y-2">
                      {/* Morning Session */}
                      <button
                        onClick={() => { if (isAmSelected) { setSelectedDate(null); } else { setSelectedDate(date); setSelectedSession('morning'); } }}
                        className={`w-full p-2 rounded text-left text-xs transition-colors border-2 ${
                          isAmSelected ? 'bg-yellow-100 border-yellow-500' : 'bg-white border-transparent hover:bg-gray-50'
                        }`}
                      >
                        <div className="flex justify-between items-center mb-1">
                          <span className="font-medium text-sm">‚òÄÔ∏è AM</span>
                          {isAmSelected && <span className="text-yellow-600">‚úì</span>}
                        </div>
                        <div className="text-xs text-gray-500 space-y-0.5">
                          <div title="Campers: Assigned / Registered">üèïÔ∏è {amStats.assigned}/{amStats.registered}</div>
                          <div title="Counselors: Assigned / Eligible">üë• {amStats.assignedCounselors}/{amStats.eligibleCounselors}</div>
                          <div title="Pods created">üìã {amStats.podCount} pods</div>
                        </div>
                      </button>

                      {/* Afternoon Session */}
                      <button
                        onClick={() => { if (isPmSelected) { setSelectedDate(null); } else { setSelectedDate(date); setSelectedSession('afternoon'); } }}
                        className={`w-full p-2 rounded text-left text-xs transition-colors border-2 ${
                          isPmSelected ? 'bg-blue-100 border-blue-500' : 'bg-white border-transparent hover:bg-gray-50'
                        }`}
                      >
                        <div className="flex justify-between items-center mb-1">
                          <span className="font-medium text-sm">üåô PM</span>
                          {isPmSelected && <span className="text-blue-600">‚úì</span>}
                        </div>
                        <div className="text-xs text-gray-500 space-y-0.5">
                          <div title="Campers: Assigned / Registered">üèïÔ∏è {pmStats.assigned}/{pmStats.registered}</div>
                          <div title="Counselors: Assigned / Eligible">üë• {pmStats.assignedCounselors}/{pmStats.eligibleCounselors}</div>
                          <div title="Pods created">üìã {pmStats.podCount} pods</div>
                        </div>
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* No date selected message */}
          {!selectedDate && (
            <div className="bg-white rounded-xl shadow p-8 text-center">
              <div className="text-5xl mb-4">üìÖ</div>
              <h3 className="font-bold text-lg text-gray-700 mb-2">Select a Session</h3>
              <p className="text-gray-500">Click on a date and session above to start building pods.</p>
            </div>
          )}

          {/* Selected Session Header */}
          {selectedDate && (
            <div className={`rounded-xl shadow p-4 ${selectedSession === 'morning' ? 'bg-yellow-50 border-2 border-yellow-400' : 'bg-blue-50 border-2 border-blue-400'}`}>
              <div className="flex items-center justify-between">
                <div className="flex-1" />
                <h3 className="font-bold text-xl text-center flex-1">
                  {selectedSession === 'morning' ? '‚òÄÔ∏è' : 'üåô'} {formatDate(selectedDate)} - {selectedSession === 'morning' ? 'Morning' : 'Afternoon'} Session
                </h3>
                <div className="flex-1 flex justify-end">
                  <button
                    onClick={() => setSelectedDate(null)}
                    className="px-3 py-1 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-100 text-gray-600"
                  >
                    ‚úï Deselect
                  </button>
                </div>
              </div>
              <p className="text-center text-sm text-gray-600 mt-1">
                Drag counselors and campers to build pods, or tap to select then tap a slot to assign.
              </p>
            </div>
          )}

          {/* Summary Stats */}
          {selectedDate && (
          <div className="grid md:grid-cols-4 gap-4">
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-2xl font-bold text-green-600">{summary.totalCampers}</div>
              <div className="text-sm text-gray-600">Registered Campers</div>
            </div>
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-2xl font-bold text-blue-600">{summary.assignedCount}</div>
              <div className="text-sm text-gray-600">Assigned to Pods</div>
            </div>
            <div className={`rounded-xl shadow p-4 text-center ${summary.unassignedCount > 0 ? 'bg-yellow-50' : 'bg-white'}`}>
              <div className={`text-2xl font-bold ${summary.unassignedCount > 0 ? 'text-yellow-600' : 'text-gray-400'}`}>{summary.unassignedCount}</div>
              <div className="text-sm text-gray-600">Unassigned</div>
            </div>
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-2xl font-bold text-purple-600">{summary.podCount}</div>
              <div className="text-sm text-gray-600">Pods</div>
            </div>
          </div>
          )}

          {/* Selection hint for touch devices */}
          {draggedItem && (
            <div className="bg-blue-100 border border-blue-300 rounded-lg p-3 mb-4 flex items-center justify-between">
              <span className="text-blue-800 text-sm font-medium">
                {draggedItem.type === 'counselor' ? 'üëÜ ' + draggedItem.data.name + ' selected ‚Äî tap an empty counselor slot in a pod to assign' : 'üëÜ Camper selected ‚Äî tap a pod to assign'}
              </span>
              <button onClick={() => setDraggedItem(null)} className="text-blue-600 hover:text-blue-800 text-sm font-bold px-2">‚úï Cancel</button>
            </div>
          )}

          {/* Main Assignment Area */}
          {selectedDate && (
          <div className="grid lg:grid-cols-4 gap-6">
            {/* Unassigned Sidebar */}
            <div className="space-y-4">
              {/* Eligible Counselors */}
              <div
                className="bg-white rounded-xl shadow p-4"
                onDragOver={e => e.preventDefault()}
                onDrop={handleDropUnassigned}
              >
                <h4 className="font-bold text-green-700 mb-3 flex items-center gap-2">
                  <span className="w-3 h-3 bg-green-500 rounded-full"></span>
                  Eligible Counselors ({getEligibleCounselors().length})
                </h4>
                <p className="text-xs text-gray-500 mb-2">Available for this session</p>
                <div className="space-y-2 min-h-16">
                  {getEligibleCounselors().length === 0 ? (
                    <div className="text-gray-400 text-sm text-center py-2">
                      {getAssignedCounselorIds().length > 0 ? 'All eligible counselors assigned' : 'No eligible counselors'}
                    </div>
                  ) : (
                    getEligibleCounselors().map(counselor => (
                      <div
                        key={counselor.id}
                        draggable
                        onDragStart={e => handleCounselorDragStart(e, counselor)}
                        onDragEnd={handleDragEnd}
                        onClick={() => handleItemClick('counselor', counselor)}
                        className={'p-2 rounded-lg cursor-pointer hover:bg-green-100 transition-colors flex items-center gap-2 ' + (draggedItem?.type === 'counselor' && draggedItem?.data?.id === counselor.id ? 'bg-purple-100 border-2 border-purple-400 ring-2 ring-purple-300' : 'bg-green-50 border border-green-200')}
                      >
                        {getDisplayPhoto(counselor.photo) ? (
                          <img src={getDisplayPhoto(counselor.photo)} alt={counselor.name} className="w-8 h-8 rounded-full object-cover" />
                        ) : (
                          <div className="w-8 h-8 rounded-full bg-gray-200 flex flex-col items-center justify-center">
                            <svg className="w-3 h-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                            <span className="text-[5px] text-gray-500 font-medium">add photo</span>
                          </div>
                        )}
                        <div className="font-medium text-sm">{counselor.name}</div>
                      </div>
                    ))
                  )}
                </div>
              </div>

              {/* Not Eligible Counselors */}
              {getNotEligibleCounselors().length > 0 && (
                <div
                  className="bg-white rounded-xl shadow p-4"
                  onDragOver={e => e.preventDefault()}
                  onDrop={handleDropUnassigned}
                >
                  <h4 className="font-bold text-gray-500 mb-3 flex items-center gap-2">
                    <span className="w-3 h-3 bg-gray-400 rounded-full"></span>
                    Not Eligible ({getNotEligibleCounselors().length})
                  </h4>
                  <p className="text-xs text-gray-500 mb-2">Not available for this session</p>
                  <div className="space-y-2">
                    {getNotEligibleCounselors().map(counselor => (
                      <div
                        key={counselor.id}
                        draggable
                        onDragStart={e => handleCounselorDragStart(e, counselor)}
                        onDragEnd={handleDragEnd}
                        className="p-2 bg-gray-50 border border-gray-200 rounded-lg cursor-move hover:bg-gray-100 transition-colors flex items-center gap-2 opacity-60"
                      >
                        {getDisplayPhoto(counselor.photo) ? (
                          <img src={getDisplayPhoto(counselor.photo)} alt={counselor.name} className="w-8 h-8 rounded-full object-cover grayscale" />
                        ) : (
                          <div className="w-8 h-8 rounded-full bg-gray-200 flex flex-col items-center justify-center">
                            <svg className="w-3 h-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                            <span className="text-[5px] text-gray-500 font-medium">add photo</span>
                          </div>
                        )}
                        <div className="font-medium text-sm text-gray-500">{counselor.name}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Registered Campers to Assign */}
              <div
                className="bg-white rounded-xl shadow p-4"
                onDragOver={e => e.preventDefault()}
                onDrop={handleDropUnassigned}
              >
                <h4 className="font-bold text-yellow-700 mb-3 flex items-center gap-2">
                  <span className="w-3 h-3 bg-yellow-500 rounded-full"></span>
                  Campers to Assign ({getUnassignedCampers().length})
                </h4>
                <p className="text-xs text-gray-500 mb-2">Registered for this session</p>
                <div className="space-y-2 min-h-32 max-h-96 overflow-y-auto">
                  {getUnassignedCampers().length === 0 ? (
                    <div className="text-gray-400 text-sm text-center py-4">
                      {getSessionRegs().length === 0 ? 'No registrations for this session' : 'All campers assigned! üéâ'}
                    </div>
                  ) : (
                    getUnassignedCampers().map(reg => {
                      const camperId = reg.childId || reg.camperId;
                      const profile = getCamperProfile(camperId);
                      return (
                      <div
                        key={reg.id}
                        draggable
                        onDragStart={e => handleCamperDragStart(e, reg)}
                        onDragEnd={handleDragEnd}
                        onClick={() => handleItemClick('camper', { ...reg, id: reg.childId || reg.camperId })}
                        className={'p-2 rounded-lg cursor-pointer hover:bg-yellow-100 transition-colors flex items-center gap-2 ' + (draggedItem?.type === 'camper' && (draggedItem?.data?.childId || draggedItem?.data?.camperId) === (reg.childId || reg.camperId) ? 'bg-green-100 border-2 border-green-400 ring-2 ring-green-300' : 'bg-yellow-50 border border-yellow-200')}
                      >
                        {getDisplayPhoto(profile?.photo) ? (
                          <img src={getDisplayPhoto(profile?.photo)} className="w-8 h-8 rounded-full object-cover flex-shrink-0" />
                        ) : (
                          <div className="w-8 h-8 rounded-full bg-gray-200 flex flex-col items-center justify-center flex-shrink-0">
                            <svg className="w-3 h-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                            <span className="text-[5px] text-gray-500 font-medium">add photo</span>
                          </div>
                        )}
                        <div className="min-w-0">
                          <div className="font-medium text-sm truncate">{reg.camperName || reg.childName}</div>
                          <div className="text-xs text-gray-500">
                            {profile?.grade ? `${profile.grade} Grade` : ''}{profile?.birthdate ? ` ‚Ä¢ Age ${calculateAge(profile.birthdate)}` : ''}
                          </div>
                        </div>
                      </div>
                      );
                    })
                  )}
                </div>
              </div>
            </div>

            {/* Pods Grid */}
            <div className="lg:col-span-3">
              <div className="flex items-center justify-between mb-4">
                <h4 className="font-bold text-lg text-green-800">üë• Pods</h4>
                <div className="flex gap-2">
                  <button
                    onClick={addPod}
                    className="px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm flex items-center gap-1"
                  >
                    <span>+</span> Add Pod
                  </button>
                </div>
              </div>

              <div className="grid md:grid-cols-2 xl:grid-cols-3 gap-4">
                {pods.map((pod, podIndex) => {
                  const counselor = pod.counselorId ? getCounselor(pod.counselorId) : null;
                  const camperCount = pod.camperIds.length;
                  const isEmpty = !pod.counselorId && camperCount === 0;

                  return (
                    <div key={pod.id} className="bg-white rounded-xl shadow border-2 border-gray-200 overflow-hidden">
                      {/* Pod Header with Remove Button */}
                      <div className="bg-gray-50 px-3 py-2 flex items-center justify-between border-b">
                        <span className="font-bold text-sm text-gray-600">Pod {podIndex + 1}</span>
                        {pods.length > 1 && (
                          <button
                            onClick={() => removePod(pod.id)}
                            className="text-red-500 hover:text-red-700 text-sm font-bold"
                            title={isEmpty ? "Remove empty pod" : "Remove pod (counselor and campers will be returned to unassigned)"}
                          >
                            ‚úï
                          </button>
                        )}
                      </div>

                      {/* Counselor Slot (Top) */}
                      <div
                        className={`p-3 border-b-2 border-dashed transition-all ${
                          counselor ? 'bg-purple-50 border-purple-200' :
                          draggedItem?.type === 'counselor' ? 'bg-purple-50 border-purple-300 cursor-pointer' :
                          dragOverTarget?.podId === pod.id && dragOverTarget?.type === 'counselor' ? 'bg-purple-100 border-purple-400 border-solid' :
                          'bg-gray-50 border-gray-300'
                        }`}
                        onClick={() => !counselor && handlePodCounselorClick(pod.id)}
                        onDragOver={e => {
                          e.preventDefault();
                          e.dataTransfer.dropEffect = 'move';
                          if (!counselor && draggedItem?.type === 'counselor') {
                            setDragOverTarget({ podId: pod.id, type: 'counselor' });
                          }
                        }}
                        onDragLeave={(e) => {
                          if (!e.currentTarget.contains(e.relatedTarget)) {
                            setDragOverTarget(null);
                          }
                        }}
                        onDrop={e => handleDropCounselor(e, pod.id)}
                      >
                        <div className="text-xs text-gray-500 mb-2 font-medium">COUNSELOR</div>
                        {counselor ? (
                          <div
                            draggable
                            onDragStart={e => handleCounselorDragStart(e, counselor)}
                            onDragEnd={handleDragEnd}
                            className="flex items-center gap-3 p-2 bg-white rounded-lg border border-purple-200 cursor-move hover:bg-purple-50 transition-colors"
                          >
                            {getDisplayPhoto(counselor.photo) ? (
                              <img src={getDisplayPhoto(counselor.photo)} alt={counselor.name} className="w-12 h-12 rounded-full object-cover border-2 border-purple-300" />
                            ) : (
                              <div className="w-12 h-12 rounded-full bg-gray-200 flex flex-col items-center justify-center">
                                <svg className="w-3 h-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                                <span className="text-[5px] text-gray-500 font-medium">add photo</span>
                              </div>
                            )}
                            <div className="flex-1">
                              <div className="font-bold">{counselor.name}</div>
                              <div className="text-xs text-gray-500">{counselor.position}</div>
                            </div>
                            <button
                              onClick={e => { e.stopPropagation(); removeCounselorFromPod(pod.id); }}
                              className="w-6 h-6 rounded-full bg-red-100 hover:bg-red-200 text-red-500 hover:text-red-700 flex items-center justify-center text-xs font-bold flex-shrink-0 transition-colors"
                              title="Remove from pod"
                            >‚úï</button>
                          </div>
                        ) : (
                          <div className={`h-16 flex items-center justify-center border-2 border-dashed rounded-lg transition-all ${
                            dragOverTarget?.podId === pod.id && dragOverTarget?.type === 'counselor'
                              ? 'border-purple-400 bg-purple-50 text-purple-600 scale-[1.02]'
                              : 'border-gray-300 bg-white text-gray-400'
                          }`}>
                            <span className="text-sm">{dragOverTarget?.podId === pod.id && dragOverTarget?.type === 'counselor' ? 'Drop here' : 'Drop counselor here'}</span>
                          </div>
                        )}
                      </div>

                      {/* Camper Slots (5 slots below) */}
                      <div
                        className={`p-3 transition-all ${draggedItem?.type === 'camper' ? 'cursor-pointer' : ''} ${dragOverTarget?.podId === pod.id && dragOverTarget?.type === 'camper' ? 'bg-green-50' : ''}`}
                        onClick={() => handlePodCamperClick(pod.id)}
                        onDragOver={e => {
                          e.preventDefault();
                          e.dataTransfer.dropEffect = 'move';
                          if (draggedItem?.type === 'camper') {
                            setDragOverTarget({ podId: pod.id, type: 'camper' });
                          }
                        }}
                        onDragLeave={(e) => {
                          if (!e.currentTarget.contains(e.relatedTarget)) {
                            setDragOverTarget(null);
                          }
                        }}
                        onDrop={e => handleDropCamper(e, pod.id)}
                      >
                        <div className="text-xs text-gray-500 mb-2 font-medium">CAMPERS ({camperCount}/{KIDS_PER_COUNSELOR})</div>
                        <div className="space-y-2">
                          {[...Array(KIDS_PER_COUNSELOR)].map((_, slotIndex) => {
                            const camperId = pod.camperIds[slotIndex];
                            const camperInfo = camperId ? getCamperInfo(camperId) : null;
                            const profile = camperId ? getCamperProfile(camperId) : null;
                            const isDragOver = dragOverTarget?.podId === pod.id && dragOverTarget?.type === 'camper' && !camperId && slotIndex === (pod.camperIds.length);

                            return (
                              <div
                                key={slotIndex}
                                className={`h-10 rounded-lg border-2 transition-all ${
                                  camperId
                                    ? 'bg-green-50 border-green-200'
                                    : isDragOver
                                    ? 'bg-green-100 border-green-400 border-solid scale-[1.02]'
                                    : 'bg-gray-50 border-dashed border-gray-300'
                                }`}
                                onDragOver={e => {
                                  e.preventDefault();
                                  e.dataTransfer.dropEffect = 'move';
                                  if (!camperId && draggedItem?.type === 'camper') {
                                    setDragOverTarget({ podId: pod.id, type: 'camper' });
                                  }
                                }}
                                onDragLeave={(e) => {
                                  if (!e.currentTarget.contains(e.relatedTarget)) {
                                    setDragOverTarget(null);
                                  }
                                }}
                                onDrop={e => handleDropCamper(e, pod.id, slotIndex)}
                              >
                                {camperId ? (
                                  <div
                                    draggable
                                    onDragStart={e => handleCamperDragStart(e, camperInfo || { childId: camperId, camperId })}
                                    onDragEnd={handleDragEnd}
                                    className="h-full flex items-center gap-2 px-2 cursor-move hover:bg-green-100 transition-colors rounded-lg"
                                  >
                                    {getDisplayPhoto(profile?.photo) ? (
                                      <img src={getDisplayPhoto(profile?.photo)} className="w-6 h-6 rounded-full object-cover flex-shrink-0" />
                                    ) : (
                                      <div className="w-6 h-6 rounded-full bg-green-200 flex items-center justify-center text-xs text-green-700 font-medium flex-shrink-0">
                                        {getCamperName(camperId)?.charAt(0)}
                                      </div>
                                    )}
                                    <span className="text-sm font-medium truncate flex-1">{getCamperName(camperId)}</span>
                                    {profile?.grade && <span className="text-xs text-gray-400 flex-shrink-0">{profile.grade}</span>}
                                    <button
                                      onClick={e => { e.stopPropagation(); removeCamperFromPod(pod.id, camperId); }}
                                      className="w-5 h-5 rounded-full bg-red-100 hover:bg-red-200 text-red-500 hover:text-red-700 flex items-center justify-center text-[10px] font-bold flex-shrink-0 transition-colors"
                                      title="Remove from pod"
                                    >‚úï</button>
                                  </div>
                                ) : (
                                  <div className={`h-full flex items-center justify-center text-xs ${isDragOver ? 'text-green-600 font-medium' : 'text-gray-400'}`}>
                                    {isDragOver ? 'Drop here' : 'Empty slot'}
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                      </div>

                      {/* Pod Status Footer */}
                      <div className={`px-3 py-2 text-center text-xs font-medium ${
                        !counselor ? 'bg-gray-100 text-gray-500' :
                        camperCount === 0 ? 'bg-yellow-50 text-yellow-600' :
                        camperCount <= 3 ? 'bg-green-50 text-green-600' :
                        camperCount <= 5 ? 'bg-blue-50 text-blue-600' :
                        'bg-red-50 text-red-600'
                      }`}>
                        {!counselor ? 'Needs counselor' :
                         camperCount === 0 ? 'Ready for campers' :
                         `${camperCount} camper${camperCount !== 1 ? 's' : ''} assigned`}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
          )}
          </>}

        </div>
      );
    };

    // (ParentMessagesTab removed ‚Äî messaging feature deprecated)
    const _ParentMessagesTab_REMOVED = ({ userEmail, userName, messages, onSendReply, markAsRead, showToast }) => {
      const [replyText, setReplyText] = useState('');
      const [selectedMsg, setSelectedMsg] = useState(null);
      const messagesEndRef = useRef(null);

      // Get messages for this parent (sent to them or to all, or from them)
      const myMessages = messages
        .filter(m => m.to === 'all' || m.to?.includes(userEmail) || m.from === userEmail)
        .sort((a, b) => new Date(b.sentAt) - new Date(a.sentAt));

      const unreadMessages = myMessages.filter(m => m.from !== userEmail && !m.readBy?.includes(userEmail));

      useEffect(() => {
        // Mark messages as read when viewing
        if (selectedMsg && !selectedMsg.readBy?.includes(userEmail)) {
          markAsRead(selectedMsg.id, userEmail);
        }
      }, [selectedMsg]);

      const handleSendReply = () => {
        if (!replyText.trim() || !selectedMsg) return;
        const msg = {
          id: 'msg_' + Date.now(),
          threadId: selectedMsg.threadId || selectedMsg.from === 'admin' ? userEmail : selectedMsg.threadId,
          from: userEmail,
          to: ['admin'],
          subject: selectedMsg.subject ? `Re: ${selectedMsg.subject}` : '',
          body: replyText.trim(),
          sentAt: new Date().toISOString(),
          readBy: [userEmail]
        };
        onSendReply(msg);
        setReplyText('');
        showToast('Reply sent!');
      };

      return (
        <div className="space-y-6">
          {/* Unread Alert */}
          {unreadMessages.length > 0 && (
            <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 flex items-center gap-4">
              <div className="text-3xl">üì¨</div>
              <div>
                <div className="font-bold text-blue-800">You have {unreadMessages.length} unread message{unreadMessages.length > 1 ? 's' : ''}</div>
                <div className="text-sm text-blue-600">Click on a message to read and reply</div>
              </div>
            </div>
          )}

          <div className="grid md:grid-cols-2 gap-6">
            {/* Message List */}
            <div className="bg-white rounded-xl shadow p-6">
              <h3 className="font-bold text-lg text-green-800 mb-4">üí¨ Messages from Camp</h3>
              {myMessages.length === 0 ? (
                <div className="text-center py-8 text-gray-500">
                  <p className="text-4xl mb-2">üì≠</p>
                  <p>No messages yet</p>
                </div>
              ) : (
                <div className="space-y-2 max-h-96 overflow-y-auto">
                  {myMessages.map(msg => {
                    const isUnread = msg.from !== userEmail && !msg.readBy?.includes(userEmail);
                    const isSelected = selectedMsg?.id === msg.id;
                    const isFromMe = msg.from === userEmail;

                    return (
                      <div
                        key={msg.id}
                        onClick={() => setSelectedMsg(msg)}
                        className={`p-3 rounded-lg cursor-pointer transition-colors ${
                          isSelected ? 'bg-green-100 border-2 border-green-500' :
                          isUnread ? 'bg-blue-50 border-2 border-blue-300' :
                          'bg-gray-50 hover:bg-gray-100'
                        }`}
                      >
                        <div className="flex justify-between items-start mb-1">
                          <span className={`text-sm ${isUnread ? 'font-bold text-blue-800' : 'text-gray-600'}`}>
                            {isFromMe ? 'üì§ You' : 'üì• Camp Admin'}
                            {msg.to === 'all' && !isFromMe && <span className="ml-1 text-xs text-purple-600">(Broadcast)</span>}
                          </span>
                          <span className="text-xs text-gray-400">{formatTimestamp(msg.sentAt)}</span>
                        </div>
                        {msg.subject && <div className={`text-sm ${isUnread ? 'font-bold' : 'font-medium'}`}>{msg.subject}</div>}
                        <div className="text-sm text-gray-600 truncate">{msg.body}</div>
                        {isUnread && <span className="inline-block mt-1 px-2 py-0.5 bg-blue-500 text-white text-xs rounded">New</span>}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {/* Message Detail / Reply */}
            <div className="bg-white rounded-xl shadow p-6">
              {!selectedMsg ? (
                <div className="text-center py-12 text-gray-500">
                  <p className="text-4xl mb-2">üëà</p>
                  <p>Select a message to read</p>
                </div>
              ) : (
                <div className="flex flex-col h-full">
                  <div className="mb-4">
                    <div className="flex justify-between items-start mb-2">
                      <span className="font-bold text-lg">
                        {selectedMsg.from === userEmail ? 'üì§ You sent' : 'üì• From Camp Admin'}
                      </span>
                      <span className="text-sm text-gray-500">{formatTimestamp(selectedMsg.sentAt)}</span>
                    </div>
                    {selectedMsg.subject && (
                      <div className="font-medium text-gray-800 mb-2">{selectedMsg.subject}</div>
                    )}
                    {selectedMsg.to === 'all' && selectedMsg.from !== userEmail && (
                      <span className="inline-block px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded mb-2">
                        üì¢ Sent to all parents
                      </span>
                    )}
                  </div>

                  <div className="flex-1 bg-gray-50 rounded-lg p-4 mb-4 whitespace-pre-wrap overflow-y-auto max-h-48">
                    {selectedMsg.body}
                  </div>

                  {/* Reply section - only show for messages from admin */}
                  {selectedMsg.from !== userEmail && (
                    <div className="border-t pt-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Reply:</label>
                      <textarea
                        value={replyText}
                        onChange={e => setReplyText(e.target.value)}
                        className="w-full px-4 py-2 border rounded-lg resize-none"
                        rows={3}
                        placeholder="Type your reply..."
                        autoComplete="off"
                        data-1p-ignore="true"
                      />
                      <button
                        onClick={handleSendReply}
                        disabled={!replyText.trim()}
                        className="mt-2 w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300"
                      >
                        Send Reply
                      </button>
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ==================== VERSION BANNER ====================
    const VersionBanner = ({ isVisible, isDev }) => {
      const [elapsed, setElapsed] = useState('0s');
      const [dbStatus, setDbStatus] = useState('checking');
      const [showNotes, setShowNotes] = useState(false);

      // Format BUILD_DATE as "Sun Feb 8 7:40 AM PST"
      const formatBuildDate = () => {
        const d = BUILD_DATE;
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        let hours = d.getHours();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12 || 12;
        const min = String(d.getMinutes()).padStart(2, '0');
        return `${days[d.getDay()]} ${months[d.getMonth()]} ${d.getDate()} ${hours}:${min} ${ampm} PST`;
      };

      useEffect(() => {
        const update = () => {
          const diff = Math.floor((new Date() - BUILD_DATE) / 1000);
          const h = Math.floor(diff / 3600), m = Math.floor((diff % 3600) / 60), s = diff % 60;
          setElapsed((h > 0 ? h + 'h ' : '') + (m > 0 ? m + 'm ' : '') + s + 's');
        };
        update();
        const i = setInterval(update, 1000);
        supabase.from('camp_content').select('id').limit(1).then(({ error }) => setDbStatus(error ? 'error' : 'connected')).catch(() => setDbStatus('error'));
        return () => clearInterval(i);
      }, []);

      if (!isVisible) return null;

      return (
        <React.Fragment>
          <div className={(isDev ? 'bg-red-600' : 'bg-green-600') + ' text-white text-center py-2 text-sm font-mono'}>
            <span className="font-bold">{isDev ? 'DEVELOPMENT' : 'PRODUCTION'}</span>
            <span className="mx-2">‚Ä¢</span>
            <span>v{VERSION}</span>
            <span className="mx-2">‚Ä¢</span>
            <span>{dbStatus === 'connected' ? '‚úì DB (' + SCHEMA + ')' : dbStatus === 'checking' ? '‚è≥...' : '‚úó DB Error'}</span>
            <span className="mx-2">‚Ä¢</span>
            <span>Built: {formatBuildDate()} ({elapsed} ago)</span>
            <span className="mx-2">‚Ä¢</span>
            <button onClick={() => setShowNotes(true)} className="underline">Notes</button>
          </div>
          {showNotes && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={() => setShowNotes(false)}>
              <div className="bg-white rounded-xl max-w-lg w-full max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                <div className="p-6 pb-2">
                  <h2 className="font-bold text-xl">Release Notes</h2>
                </div>
                <div className="flex-1 overflow-y-auto px-6 pb-2">
                  {RELEASE_NOTES.map((r, i) => (
                    <div key={r.version} className={i > 0 ? 'mt-3 pt-3 border-t' : ''}>
                      <div className="font-mono text-green-700">v{r.version} <span className="text-gray-400 text-sm">{r.date}{r.time && ` at ${r.time}`}</span>{r.author && <span className="text-blue-600 text-sm ml-2">by {r.author}</span>}</div>
                      <ul className="text-sm text-gray-600 mt-1">{r.changes.map((c, j) => <li key={j}>‚Ä¢ {c}</li>)}</ul>
                    </div>
                  ))}
                </div>
                <div className="p-6 pt-2">
                  <button onClick={() => setShowNotes(false)} className="w-full py-2 bg-green-600 text-white rounded-lg">Close</button>
                </div>
              </div>
            </div>
          )}
        </React.Fragment>
      );
    };

    // ==================== UI COMPONENTS ====================
    const Toast = ({ message, type, onDone }) => {
      useEffect(() => {
        const t = setTimeout(onDone, 3000);
        return () => clearTimeout(t);
      }, []);
      return <div className={'fixed top-16 left-1/2 -translate-x-1/2 z-50 px-6 py-3 rounded-lg shadow-lg text-white ' + (type === 'error' ? 'bg-red-500' : 'bg-green-600')}>{message}</div>;
    };

    const Modal = ({ isOpen, onClose, title, children }) => {
      const mouseDownTarget = useRef(null);

      if (!isOpen) return null;

      const handleMouseDown = (e) => {
        mouseDownTarget.current = e.target;
      };

      const handleClick = (e) => {
        // Only close if both mousedown and click happened on the backdrop itself
        if (e.target === e.currentTarget && mouseDownTarget.current === e.currentTarget) {
          onClose();
        }
        mouseDownTarget.current = null;
      };

      return (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onMouseDown={handleMouseDown} onClick={handleClick}>
          <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div className="bg-green-800 text-white px-6 py-4 flex justify-between items-center">
              <h2 className="font-display text-2xl">{title}</h2>
              <button onClick={onClose} className="text-2xl hover:bg-green-700 rounded px-2">√ó</button>
            </div>
            <div className="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">{children}</div>
          </div>
        </div>
      );
    };

    // ==================== SCROLLABLE TABS ====================
    const _tabScrollCache = {};
    const ScrollableTabs = ({ children, className = '', persistKey = '' }) => {
      const containerRef = useRef(null);
      const [canScrollLeft, setCanScrollLeft] = useState(false);
      const [canScrollRight, setCanScrollRight] = useState(false);
      const [isDragging, setIsDragging] = useState(false);
      const [startX, setStartX] = useState(0);
      const [scrollLeft, setScrollLeft] = useState(0);

      const checkScroll = () => {
        const el = containerRef.current;
        if (!el) return;
        setCanScrollLeft(el.scrollLeft > 0);
        setCanScrollRight(el.scrollLeft < el.scrollWidth - el.clientWidth - 1);
        if (persistKey) _tabScrollCache[persistKey] = el.scrollLeft;
      };

      useEffect(() => {
        if (persistKey && containerRef.current && _tabScrollCache[persistKey] !== undefined) {
          containerRef.current.scrollLeft = _tabScrollCache[persistKey];
        }
        checkScroll();
        window.addEventListener('resize', checkScroll);
        return () => window.removeEventListener('resize', checkScroll);
      }, [children]);

      const onMouseDown = (e) => {
        setIsDragging(true);
        setStartX(e.pageX - containerRef.current.offsetLeft);
        setScrollLeft(containerRef.current.scrollLeft);
      };

      const onMouseMove = (e) => {
        if (!isDragging) return;
        e.preventDefault();
        const x = e.pageX - containerRef.current.offsetLeft;
        const walk = (x - startX) * 1.5;
        containerRef.current.scrollLeft = scrollLeft - walk;
      };

      const onMouseUp = () => setIsDragging(false);
      const onMouseLeave = () => setIsDragging(false);

      // Touch support
      const onTouchStart = (e) => {
        setIsDragging(true);
        setStartX(e.touches[0].pageX - containerRef.current.offsetLeft);
        setScrollLeft(containerRef.current.scrollLeft);
      };

      const onTouchMove = (e) => {
        if (!isDragging) return;
        const x = e.touches[0].pageX - containerRef.current.offsetLeft;
        const walk = (x - startX) * 1.5;
        containerRef.current.scrollLeft = scrollLeft - walk;
      };

      const onTouchEnd = () => setIsDragging(false);

      return (
        <div className="relative">
          {/* Left fade indicator */}
          {canScrollLeft && (
            <div className="absolute left-0 top-0 bottom-0 w-8 bg-gradient-to-r from-white to-transparent z-10 pointer-events-none flex items-center">
              <span className="text-gray-400 text-lg ml-1">‚Äπ</span>
            </div>
          )}

          {/* Scrollable container */}
          <div
            ref={containerRef}
            className={`flex gap-1 overflow-x-auto scrollbar-hide ${isDragging ? 'cursor-grabbing' : 'cursor-grab'} ${className}`}
            style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}
            onScroll={checkScroll}
            onMouseDown={onMouseDown}
            onMouseMove={onMouseMove}
            onMouseUp={onMouseUp}
            onMouseLeave={onMouseLeave}
            onTouchStart={onTouchStart}
            onTouchMove={onTouchMove}
            onTouchEnd={onTouchEnd}
          >
            {children}
          </div>

          {/* Right fade indicator */}
          {canScrollRight && (
            <div className="absolute right-0 top-0 bottom-0 w-8 bg-gradient-to-l from-white to-transparent z-10 pointer-events-none flex items-center justify-end">
              <span className="text-gray-400 text-lg mr-1">‚Ä∫</span>
            </div>
          )}
        </div>
      );
    };

    // shape: 'circle' | 'square' | 'rectangle'
    // aspectRatio: only used for rectangle (width/height ratio, e.g. 16/9)
    // initialTransform: optional { zoom, posX, posY, rotation } to restore previous editing state
    const ImageCropper = ({ image, onSave, onCancel, shape = 'circle', aspectRatio = 1, initialTransform = null }) => {
      const canvasRef = useRef(null);
      const [zoom, setZoom] = useState(initialTransform?.zoom ?? 1);
      const [pos, setPos] = useState({ x: initialTransform?.posX ?? 0, y: initialTransform?.posY ?? 0 });
      const [rotation, setRotation] = useState(initialTransform?.rotation ?? 0);
      const [dragging, setDragging] = useState(false);
      const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
      const [img, setImg] = useState(null);

      // Canvas dimensions - high resolution for export, displayed smaller via CSS
      const exportW = shape === 'rectangle' ? 1200 : 400;
      const exportH = shape === 'rectangle' ? Math.round(1200 / aspectRatio) : 400;
      const displayW = shape === 'rectangle' ? 300 : 250;
      const displayH = shape === 'rectangle' ? Math.round(300 / aspectRatio) : 250;
      const canvasW = exportW;
      const canvasH = exportH;

      useEffect(() => {
        const i = new Image();
        i.onload = () => setImg(i);
        i.src = image;
      }, [image]);

      useEffect(() => {
        if (!img || !canvasRef.current) return;
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        canvas.width = canvasW;
        canvas.height = canvasH;
        ctx.clearRect(0, 0, canvasW, canvasH);
        ctx.save();

        // Clip based on shape (with rounded corners for square to match website)
        ctx.beginPath();
        if (shape === 'circle') {
          ctx.arc(canvasW / 2, canvasH / 2, Math.min(canvasW, canvasH) / 2, 0, Math.PI * 2);
        } else {
          // Rounded rectangle (12px radius to match rounded-xl)
          const radius = 12;
          ctx.moveTo(radius, 0);
          ctx.lineTo(canvasW - radius, 0);
          ctx.quadraticCurveTo(canvasW, 0, canvasW, radius);
          ctx.lineTo(canvasW, canvasH - radius);
          ctx.quadraticCurveTo(canvasW, canvasH, canvasW - radius, canvasH);
          ctx.lineTo(radius, canvasH);
          ctx.quadraticCurveTo(0, canvasH, 0, canvasH - radius);
          ctx.lineTo(0, radius);
          ctx.quadraticCurveTo(0, 0, radius, 0);
        }
        ctx.clip();

        // Draw image with rotation
        ctx.translate(canvasW / 2, canvasH / 2);
        ctx.rotate((rotation * Math.PI) / 180);
        const scale = zoom * Math.min(canvasW, canvasH) / Math.max(img.width, img.height);
        const w = img.width * scale, h = img.height * scale;
        ctx.drawImage(img, -w / 2 + pos.x, -h / 2 + pos.y, w, h);
        ctx.restore();

        // Draw border
        ctx.beginPath();
        if (shape === 'circle') {
          ctx.arc(canvasW / 2, canvasH / 2, Math.min(canvasW, canvasH) / 2 - 2, 0, Math.PI * 2);
        } else {
          // Rounded rectangle border (matching the clip)
          const radius = 10;
          const offset = 2;
          ctx.moveTo(radius + offset, offset);
          ctx.lineTo(canvasW - radius - offset, offset);
          ctx.quadraticCurveTo(canvasW - offset, offset, canvasW - offset, radius + offset);
          ctx.lineTo(canvasW - offset, canvasH - radius - offset);
          ctx.quadraticCurveTo(canvasW - offset, canvasH - offset, canvasW - radius - offset, canvasH - offset);
          ctx.lineTo(radius + offset, canvasH - offset);
          ctx.quadraticCurveTo(offset, canvasH - offset, offset, canvasH - radius - offset);
          ctx.lineTo(offset, radius + offset);
          ctx.quadraticCurveTo(offset, offset, radius + offset, offset);
        }
        ctx.strokeStyle = '#16a34a';
        ctx.lineWidth = 4;
        ctx.stroke();
      }, [img, zoom, pos, rotation, shape, canvasW, canvasH]);

      // Scale factor for mouse movements (display is smaller than export)
      const scaleFactor = exportW / displayW;
      const onMouseDown = (e) => { setDragging(true); setDragStart({ x: e.clientX - pos.x / scaleFactor, y: e.clientY - pos.y / scaleFactor }); };
      const onMouseMove = (e) => { if (dragging) setPos({ x: (e.clientX - dragStart.x) * scaleFactor, y: (e.clientY - dragStart.y) * scaleFactor }); };
      const onMouseUp = () => setDragging(false);
      const rotate90 = () => setRotation((r) => (r + 90) % 360);

      const containerClass = shape === 'circle' ? 'rounded-full' : 'rounded-xl';

      return (
        <div className="flex flex-col items-center gap-4">
          <div className="relative">
            <div
              className={`overflow-hidden cursor-move bg-gray-100 shadow-md ${containerClass}`}
              style={{ width: displayW, height: displayH }}
              onMouseDown={onMouseDown}
              onMouseMove={onMouseMove}
              onMouseUp={onMouseUp}
              onMouseLeave={onMouseUp}
            >
              <canvas ref={canvasRef} style={{ width: displayW, height: displayH }} />
            </div>
            {/* Red face silhouette overlay for circle shape */}
            {shape === 'circle' && (
              <div className="absolute inset-0 pointer-events-none flex items-center justify-center">
                <svg width={displayW} height={displayH} viewBox="0 0 100 100" className="opacity-40">
                  <ellipse cx="50" cy="50" rx="28" ry="35" fill="none" stroke="#dc2626" strokeWidth="1.5" />
                  <path d="M 36 42 Q 42 37 48 42 Q 42 47 36 42 Z" fill="none" stroke="#dc2626" strokeWidth="1.2" />
                  <path d="M 52 42 Q 58 37 64 42 Q 58 47 52 42 Z" fill="none" stroke="#dc2626" strokeWidth="1.2" />
                  <path d="M 38 60 Q 44 66 50 66 Q 56 66 62 60" fill="none" stroke="#dc2626" strokeWidth="1.2" strokeLinecap="round" />
                </svg>
              </div>
            )}
          </div>
          <div className="flex flex-col gap-2 w-64">
            <div className="flex items-center gap-2">
              <span className="text-xs text-gray-500 w-12">Zoom</span>
              <input type="range" min="0.5" max="3" step="0.1" value={zoom} onChange={e => setZoom(parseFloat(e.target.value))} className="flex-1" />
            </div>
            <div className="flex items-center gap-2">
              <span className="text-xs text-gray-500 w-16">Rotate</span>
              <input type="range" min="0" max="360" step="1" value={rotation} onChange={e => setRotation(parseInt(e.target.value))} className="flex-1" />
              <button onClick={rotate90} className="px-6 py-3 bg-gray-200 rounded-lg text-2xl hover:bg-gray-300" title="Rotate 90¬∞">‚Üª</button>
            </div>
          </div>
          <div className="flex gap-3">
            <button onClick={onCancel} className="px-4 py-2 bg-gray-200 rounded-lg">Cancel</button>
            <button onClick={() => onSave(canvasRef.current.toDataURL('image/jpeg', 0.95), { zoom, posX: pos.x, posY: pos.y, rotation })} className="px-4 py-2 bg-green-600 text-white rounded-lg">Save</button>
          </div>
        </div>
      );
    };

    const ImageUpload = ({ currentImage, onImageChange, label, circular = false }) => {
      const inputRef = useRef(null);
      const [temp, setTemp] = useState(null);
      const [showCrop, setShowCrop] = useState(false);

      const onFile = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => { setTemp(reader.result); setShowCrop(true); };
          reader.readAsDataURL(file);
        }
        e.target.value = '';
      };

      if (showCrop && temp) {
        return <ImageCropper image={temp} onSave={(img) => { onImageChange(img); setShowCrop(false); }} onCancel={() => setShowCrop(false)} />;
      }

      return (
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">{label}</label>
          <div className="flex items-center gap-4">
            {currentImage ? <img src={currentImage} className={'w-20 h-20 object-cover border ' + (circular ? 'rounded-full' : 'rounded-lg')} /> : <div className={'w-20 h-20 bg-gray-100 border-2 border-dashed flex items-center justify-center text-gray-400 text-xs ' + (circular ? 'rounded-full' : 'rounded-lg')}>No image</div>}
            <div className="flex flex-col gap-2">
              <button onClick={() => inputRef.current?.click()} className="px-3 py-1 bg-green-600 text-white rounded text-sm">{currentImage ? 'Change' : 'Upload'}</button>
              {currentImage && <button onClick={() => onImageChange(null)} className="px-3 py-1 bg-red-100 text-red-600 rounded text-sm">Remove</button>}
            </div>
          </div>
          <input ref={inputRef} type="file" accept="image/*" onChange={onFile} className="hidden" />
        </div>
      );
    };

    // ==================== PHOTO UPLOAD MODAL ====================
    const PhotoUploadModal = ({ currentPhoto, onSave, onCancel, shape = 'circle' }) => {
      const fileInputRef = useRef(null);
      const [tempImage, setTempImage] = useState(null);
      const [showCropper, setShowCropper] = useState(false);
      const [isNewUpload, setIsNewUpload] = useState(false);

      const displayPhoto = getDisplayPhoto(currentPhoto);
      const originalPhoto = currentPhoto && typeof currentPhoto === 'object' ? currentPhoto.original : currentPhoto;
      const savedTransform = currentPhoto && typeof currentPhoto === 'object' ? currentPhoto.transform : null;

      const handleFileSelect = (e) => {
        const file = e.target.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setTempImage(reader.result);
            setIsNewUpload(true);
            setShowCropper(true);
          };
          reader.readAsDataURL(file);
        }
        if (e.target) e.target.value = '';
      };

      return (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={onCancel}>
          <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
            {showCropper && tempImage ? (
              <div>
                <h3 className="text-lg font-bold text-center mb-4">Adjust Photo</h3>
                <ImageCropper
                  image={tempImage}
                  onSave={(croppedImg, transform) => { onSave({ cropped: croppedImg, original: isNewUpload ? tempImage : (originalPhoto || tempImage), transform }); setShowCropper(false); setTempImage(null); }}
                  onCancel={() => { setShowCropper(false); setTempImage(null); }}
                  shape={shape}
                  initialTransform={!isNewUpload ? savedTransform : null}
                />
              </div>
            ) : (
              <div>
                <h3 className="text-lg font-bold text-center mb-4">
                  {displayPhoto ? 'Update Photo' : 'Add Photo'}
                </h3>
                <div className="flex justify-center mb-6">
                  {displayPhoto ? (
                    <img src={displayPhoto} className={`w-32 h-32 object-cover border-2 border-gray-300 ${shape === 'circle' ? 'rounded-full' : 'rounded-xl'}`} />
                  ) : (
                    <div onClick={() => fileInputRef.current?.click()} className={`w-32 h-32 bg-gray-200 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300 transition-colors ${shape === 'circle' ? 'rounded-full' : 'rounded-xl'}`}>
                      <svg className="w-8 h-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                      <span className="text-xs text-gray-500 font-medium">add photo</span>
                    </div>
                  )}
                </div>
                <div className="space-y-3">
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700"
                  >
                    {displayPhoto ? 'Upload New Photo' : 'Choose Photo'}
                  </button>
                  {displayPhoto && (
                    <button
                      onClick={() => { setTempImage(originalPhoto || displayPhoto); setIsNewUpload(false); setShowCropper(true); }}
                      className="w-full py-3 bg-blue-50 text-blue-600 font-medium rounded-xl hover:bg-blue-100"
                    >
                      Adjust Current Photo
                    </button>
                  )}
                  {displayPhoto && (
                    <button
                      onClick={() => onSave(null)}
                      className="w-full py-2 text-red-500 font-medium hover:text-red-600"
                    >
                      Remove Photo
                    </button>
                  )}
                  <button
                    onClick={onCancel}
                    className="w-full py-2 text-gray-500 hover:text-gray-700"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            )}
            <input ref={fileInputRef} type="file" accept="image/*" onChange={handleFileSelect} className="hidden" />
          </div>
        </div>
      );
    };

    // ==================== FOOD PHOTOS MANAGER ====================
    const FoodPhotosManager = ({ foodPhotos, getFoodPhoto, onSave }) => {
      const [editingPhoto, setEditingPhoto] = useState(null); // { key, label }
      const [showCropper, setShowCropper] = useState(false);
      const [cropImage, setCropImage] = useState(null);
      const inputRef = useRef(null);

      const FOOD_ITEMS = {
        snacks: [
          { key: 'snack_fruit', label: 'Fresh Fruit' },
          { key: 'snack_granola', label: 'Granola Bars' },
          { key: 'snack_cheese', label: 'Cheese & Crackers' },
          { key: 'snack_veggie', label: 'Veggie Sticks' }
        ],
        drinks: [
          { key: 'drink_water', label: 'Water' },
          { key: 'drink_gatorade', label: 'Gatorade' },
          { key: 'drink_orange', label: 'Orange Juice' },
          { key: 'drink_apple', label: 'Apple Juice' }
        ]
      };

      const handleUploadClick = () => {
        inputRef.current?.click();
      };

      const handleFileSelect = (e) => {
        const file = e.target.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setCropImage(reader.result);
            setShowCropper(true);
          };
          reader.readAsDataURL(file);
        }
        e.target.value = '';
      };

      const handleEditClick = () => {
        setCropImage(getFoodPhoto(editingPhoto.key));
        setShowCropper(true);
      };

      const handleCropSave = (croppedImage) => {
        onSave({ ...foodPhotos, [editingPhoto.key]: croppedImage });
        setShowCropper(false);
        setCropImage(null);
        setEditingPhoto(null);
      };

      const handleDelete = () => {
        const updated = { ...foodPhotos };
        delete updated[editingPhoto.key];
        onSave(updated);
        setEditingPhoto(null);
      };

      const renderPhotoGrid = (items, title, colorClass) => (
        <div className={title === 'Snacks' ? 'mb-6' : ''}>
          <h4 className={`font-medium ${colorClass} mb-3`}>{title}</h4>
          <div className="grid grid-cols-4 gap-4">
            {items.map(item => (
              <div key={item.key} className="text-center">
                <div
                  className="relative group cursor-pointer"
                  onClick={() => setEditingPhoto(item)}
                >
                  <img
                    src={getFoodPhoto(item.key)}
                    alt={item.label}
                    className="w-full aspect-square object-cover rounded-xl mb-1 shadow-sm"
                    onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/150x150/gray/white?text=No+Image'; }}
                  />
                  <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity rounded-xl flex items-center justify-center">
                    <span className="text-white font-medium text-sm">Edit</span>
                  </div>
                  {foodPhotos[item.key] && (
                    <div className="absolute top-1 right-1 w-2 h-2 bg-green-500 rounded-full" title="Custom photo" />
                  )}
                </div>
                <span className="text-xs text-gray-600 block">{item.label}</span>
              </div>
            ))}
          </div>
        </div>
      );

      return (
        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="font-bold mb-4">üçé Snacks & Drinks Photos</h3>
          <p className="text-sm text-gray-600 mb-4">
            Click any photo to edit. Green dot indicates a custom uploaded photo.
          </p>
          {renderPhotoGrid(FOOD_ITEMS.snacks, 'Snacks', 'text-green-700')}
          {renderPhotoGrid(FOOD_ITEMS.drinks, 'Beverages', 'text-blue-700')}

          {/* Photo Edit Modal */}
          {editingPhoto && !showCropper && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-sm w-full overflow-hidden" onClick={e => e.stopPropagation()}>
                <div className="bg-green-600 text-white px-6 py-4 flex justify-between items-center">
                  <h2 className="font-display text-lg">Edit: {editingPhoto.label}</h2>
                  <button onClick={() => setEditingPhoto(null)} className="text-2xl hover:bg-green-500 rounded px-2">√ó</button>
                </div>
                <div className="p-6">
                  <div className="mb-4">
                    <p className="text-xs text-gray-500 mb-2 text-center">Preview (exactly as shown on website)</p>
                    <img
                      src={getFoodPhoto(editingPhoto.key)}
                      alt={editingPhoto.label}
                      className="w-full aspect-square object-cover rounded-xl shadow-md"
                      onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/300x300/gray/white?text=No+Image'; }}
                    />
                  </div>
                  <div className="space-y-2">
                    <button
                      onClick={handleUploadClick}
                      className="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"
                    >
                      üì∑ Upload New Photo
                    </button>
                    <button
                      onClick={handleEditClick}
                      className="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center gap-2"
                    >
                      ‚úÇÔ∏è Adjust Position, Zoom & Rotate
                    </button>
                    {foodPhotos[editingPhoto.key] && (
                      <button
                        onClick={handleDelete}
                        className="w-full py-3 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 flex items-center justify-center gap-2"
                      >
                        üóëÔ∏è Reset to Default
                      </button>
                    )}
                    <button
                      onClick={() => setEditingPhoto(null)}
                      className="w-full py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
              <input
                ref={inputRef}
                type="file"
                accept="image/*"
                className="hidden"
                onChange={handleFileSelect}
              />
            </div>
          )}

          {/* Image Cropper Modal */}
          {showCropper && cropImage && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-md w-full overflow-hidden" onClick={e => e.stopPropagation()}>
                <div className="bg-green-600 text-white px-6 py-4 flex justify-between items-center">
                  <h2 className="font-display text-lg">Adjust: {editingPhoto.label}</h2>
                  <button onClick={() => { setShowCropper(false); setCropImage(null); }} className="text-2xl hover:bg-green-500 rounded px-2">√ó</button>
                </div>
                <div className="p-6">
                  <ImageCropper
                    image={cropImage}
                    shape="square"
                    onSave={handleCropSave}
                    onCancel={() => { setShowCropper(false); setCropImage(null); }}
                  />
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ==================== SITE PHOTOS MANAGER ====================
    const SitePhotosManager = ({ sitePhotos, onSave }) => {
      const [editingPhoto, setEditingPhoto] = useState(null);
      const [showCropper, setShowCropper] = useState(false);
      const [cropImage, setCropImage] = useState(null);
      const [cropTransform, setCropTransform] = useState(null);
      const [isNewUpload, setIsNewUpload] = useState(false);
      const inputRef = useRef(null);

      const SITE_PHOTO_CONFIG = [
        { key: 'hero', label: 'Hero Background', description: 'Large banner image behind the camp title', aspectRatio: 16/9 },
        { key: 'dropoff', label: 'Drop-off Photo', description: 'Camper being dropped off at gym entrance', aspectRatio: 4/3 },
        { key: 'layups', label: 'Skills Training Photo', description: 'Counselor working with kids on layups/drills', aspectRatio: 4/3 },
        { key: 'lunch', label: 'Lunch Photo', description: 'Kids sitting together eating lunch', aspectRatio: 4/3 }
      ];

      // Helper to get cropped image (handles both old string format and new object format)
      const getCroppedImage = (key) => {
        const data = sitePhotos?.[key];
        if (!data) return null;
        return typeof data === 'string' ? data : data.cropped;
      };

      // Helper to get photo data for re-editing
      const getPhotoData = (key) => {
        const data = sitePhotos?.[key];
        if (!data) return null;
        if (typeof data === 'string') return { cropped: data, original: null, transform: null };
        return data;
      };

      const handleFileSelect = (e) => {
        const file = e.target.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setCropImage(reader.result);
            setCropTransform(null);
            setIsNewUpload(true);
            setShowCropper(true);
          };
          reader.readAsDataURL(file);
        }
        if (e.target) e.target.value = '';
      };

      const handleReEdit = () => {
        const photoData = getPhotoData(editingPhoto.key);
        if (photoData?.original) {
          setCropImage(photoData.original);
          setCropTransform(photoData.transform);
        } else {
          setCropImage(photoData?.cropped || getCroppedImage(editingPhoto.key));
          setCropTransform(null);
        }
        setIsNewUpload(false);
        setShowCropper(true);
      };

      const handleCropSave = (croppedImage, transform) => {
        const photoData = {
          cropped: croppedImage,
          original: isNewUpload ? cropImage : (getPhotoData(editingPhoto.key)?.original || cropImage),
          transform: transform
        };
        onSave({ ...sitePhotos, [editingPhoto.key]: photoData }, editingPhoto.label);
        setShowCropper(false);
        setCropImage(null);
        setCropTransform(null);
        setIsNewUpload(false);
        setEditingPhoto(null);
      };

      const handleDelete = () => {
        const updated = { ...sitePhotos };
        delete updated[editingPhoto.key];
        onSave(updated, editingPhoto.label);
        setEditingPhoto(null);
      };

      return (
        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="font-bold text-lg text-green-800 mb-2">üì∏ Site Photos</h3>
          <p className="text-sm text-gray-500 mb-4">Upload photos that appear throughout the website. Photos will be displayed exactly as cropped.</p>

          <div className="grid md:grid-cols-2 gap-6">
            {SITE_PHOTO_CONFIG.map(photo => (
              <div key={photo.key} className="border rounded-xl p-4 hover:border-green-400 transition-colors">
                <div className="flex justify-between items-start mb-2">
                  <div>
                    <h4 className="font-medium text-gray-800">{photo.label}</h4>
                    <p className="text-xs text-gray-500">{photo.description}</p>
                  </div>
                  {getCroppedImage(photo.key) && (
                    <span className="w-3 h-3 bg-green-500 rounded-full" title="Custom photo uploaded" />
                  )}
                </div>

                {getCroppedImage(photo.key) ? (
                  <div
                    className="relative group cursor-pointer rounded-xl overflow-hidden"
                    style={{ aspectRatio: photo.aspectRatio }}
                    onClick={() => setEditingPhoto(photo)}
                  >
                    <img
                      src={getCroppedImage(photo.key)}
                      alt={photo.label}
                      className="w-full h-full object-cover"
                    />
                    <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                      <span className="text-white font-bold text-lg">Edit</span>
                    </div>
                  </div>
                ) : (
                  <div
                    className="bg-gray-100 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-gray-200 transition-colors"
                    style={{ aspectRatio: photo.aspectRatio }}
                    onClick={() => {
                      setEditingPhoto(photo);
                      setTimeout(() => inputRef.current?.click(), 100);
                    }}
                  >
                    <span className="text-4xl mb-2">üì∑</span>
                    <span className="text-sm text-gray-500">Click to upload</span>
                  </div>
                )}
              </div>
            ))}
          </div>

          {/* Edit Modal */}
          {editingPhoto && !showCropper && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-lg w-full overflow-hidden" onClick={e => e.stopPropagation()}>
                <div className="bg-green-600 text-white px-6 py-4 flex justify-between items-center">
                  <h2 className="font-display text-lg">{editingPhoto.label}</h2>
                  <button onClick={() => setEditingPhoto(null)} className="text-2xl hover:bg-green-500 rounded px-2">√ó</button>
                </div>
                <div className="p-6">
                  {getCroppedImage(editingPhoto.key) && (
                    <div className="mb-4">
                      <p className="text-sm text-gray-500 mb-2 font-medium">Preview (exactly as shown on website)</p>
                      <img
                        src={getCroppedImage(editingPhoto.key)}
                        alt={editingPhoto.label}
                        className="w-full object-cover rounded-xl shadow"
                        style={{ aspectRatio: editingPhoto.aspectRatio }}
                      />
                    </div>
                  )}

                  <div className="space-y-3">
                    <button
                      onClick={() => inputRef.current?.click()}
                      className="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium flex items-center justify-center gap-2"
                    >
                      <span>üì§</span> {getCroppedImage(editingPhoto.key) ? 'Upload New Photo' : 'Upload Photo'}
                    </button>

                    {getCroppedImage(editingPhoto.key) && (
                      <>
                        <button
                          onClick={handleReEdit}
                          className="w-full py-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 font-medium flex items-center justify-center gap-2"
                        >
                          <span>‚úÇÔ∏è</span> Adjust Position / Zoom
                        </button>
                        <button
                          onClick={handleDelete}
                          className="w-full py-3 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 font-medium flex items-center justify-center gap-2"
                        >
                          <span>üóëÔ∏è</span> Remove Photo
                        </button>
                      </>
                    )}

                    <button
                      onClick={() => setEditingPhoto(null)}
                      className="w-full py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
              <input
                ref={inputRef}
                type="file"
                accept="image/*"
                className="hidden"
                onChange={handleFileSelect}
              />
            </div>
          )}

          {/* Image Cropper Modal */}
          {showCropper && cropImage && editingPhoto && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-lg w-full overflow-hidden" onClick={e => e.stopPropagation()}>
                <div className="bg-green-600 text-white px-6 py-4 flex justify-between items-center">
                  <h2 className="font-display text-lg">Adjust: {editingPhoto.label}</h2>
                  <button onClick={() => { setShowCropper(false); setCropImage(null); setCropTransform(null); }} className="text-2xl hover:bg-green-500 rounded px-2">√ó</button>
                </div>
                <div className="p-6">
                  <p className="text-sm text-gray-500 mb-4 text-center">The preview below shows exactly how the photo will appear on the website.</p>
                  <ImageCropper
                    image={cropImage}
                    shape="rectangle"
                    aspectRatio={editingPhoto.aspectRatio}
                    initialTransform={cropTransform}
                    onSave={handleCropSave}
                    onCancel={() => { setShowCropper(false); setCropImage(null); setCropTransform(null); }}
                  />
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ==================== MAIN APP ====================
    function RooseveltCamp() {
      const [page, setPage] = useState('home');
      const [user, setUser] = useState(null);
      const [toast, setToast] = useState(null);
      const [loading, setLoading] = useState(true);
      const [showBanner, setShowBanner] = useState(false);
      const [transitioning, setTransitioning] = useState(false); // Global transition state for login/registration
      
      const [content, setContent] = useState(DEFAULT_CONTENT);
      const [counselors, setCounselors] = useState(DEFAULT_COUNSELORS);
      const [registrations, setRegistrations] = useState([]);
      const [parents, setParents] = useState([]);
      const [counselorUsers, setCounselorUsers] = useState([]);
      const [availability, setAvailability] = useState({});
      const [changeHistory, setChangeHistory] = useState([]);
      const [admins, setAdmins] = useState(DEFAULT_ADMINS);
      const [assignments, setAssignments] = useState({}); // { "date_session": { counselorId: [childId, ...] } }
      const [campers, setCampers] = useState([]); // Standalone campers collection
      const [camperParentLinks, setCamperParentLinks] = useState([]); // { camperId, parentEmail } associations
      const [foodPhotos, setFoodPhotos] = useState({}); // Admin-uploadable food photos { snack_fruit: base64, ... }
      const [sitePhotos, setSitePhotos] = useState({}); // Site-wide photos { hero, dropoff, layups, lunch }

      // New state for onboarding system
      const [emergencyContacts, setEmergencyContacts] = useState([]); // Emergency contact records
      const [onboardingProgress, setOnboardingProgress] = useState({}); // { email: { step, complete, ... } }
      const [pendingCounselors, setPendingCounselors] = useState([]); // Counselors awaiting admin approval
      const [availabilityChangeRequests, setAvailabilityChangeRequests] = useState([]); // Counselor availability change requests
      const [profileChangeRequests, setProfileChangeRequests] = useState([]); // Counselor profile change requests
      const [blockedSessions, setBlockedSessions] = useState({}); // { date: { morning: bool, afternoon: bool } }
      const [counselorSchedule, setCounselorSchedule] = useState({}); // { counselorId: { date: { morning: bool, afternoon: bool } } }
      const [gymRentals, setGymRentals] = useState({}); // { date: { morning: bool, afternoon: bool } }
      const [gymRentalsTabMonth, setGymRentalsTabMonth] = useState(null); // Persist selected month in Gym Rentals tab

      const [adminParentTab, setAdminParentTab] = useState('dashboard');
      const [showPaidRegs, setShowPaidRegs] = useState(false);

      // Backward compatibility: Combined users array for components not yet refactored
      const users = [...parents, ...counselorUsers];
      const [adminChildTab, setAdminChildTab] = useState({
        family: 'parents',
        counselor: 'counselors',
        pod: 'assignments',
        camp: 'gymrentals'
      });
      const [sessionsTabMonth, setSessionsTabMonth] = useState(null); // Persist selected month in Sessions tab
      const [assignmentsTabMonth, setAssignmentsTabMonth] = useState(null); // Persist selected month in Assignments tab
      const [podSelectedDate, setPodSelectedDate] = useState(null); // Persist selected date in Pod Setup
      const [podSelectedSession, setPodSelectedSession] = useState('morning'); // Persist selected session in Pod Setup
      const [podSessionPods, setPodSessionPods] = useState({}); // Persist pod data in Pod Setup
      const [podCalWeeks, setPodCalWeeks] = useState(null); // Week filter for Pod Setup date grid (null = not yet initialized)
      const [podCalDates, setPodCalDates] = useState(null); // Specific date filter for Pod Setup (null = not yet initialized)
      const [podCamperView, setPodCamperView] = useState(false); // Camper-centric view toggle
      const [podSelectedCamper, setPodSelectedCamper] = useState(null); // Selected camper in camper view
      const [counselorScheduleModal, setCounselorScheduleModal] = useState(null); // Counselor being edited (availability modal)
      const [counselorScheduleMonths, setCounselorScheduleMonths] = useState([]); // Months selected in availability modal (array for multi-select)
      const [counselorAvailDraft, setCounselorAvailDraft] = useState(null); // Draft copy of availability for Save/Cancel
      const [counselorDashMonth, setCounselorDashMonth] = useState(6); // Persist selected month in Counselor Dashboard (6 = July)
      const [bulkRegModal, setBulkRegModal] = useState(null); // Bulk registration creation: { parentEmail, camperIds, selectedDates: { date: ['morning','afternoon'] } }
      const [bulkRegMonth, setBulkRegMonth] = useState(null); // Selected month for bulk registration
      const [viewRegModal, setViewRegModal] = useState(null); // Registration details view/edit modal
      const [deleteRegConfirm, setDeleteRegConfirm] = useState(null); // Registration to delete confirmation
      // (messaging state variables removed ‚Äî feature deprecated)

      const isDevEnv = isDev();
      const showToast = useCallback((msg, type = 'success') => setToast({ msg, type }), []);
      const sessionCost = getSessionCost(content);

      useEffect(() => {
        const load = async () => {
          setLoading(true);
          try {
            // Parallel fetch all tables at once for faster loading
            const [cd, cs, rg, pr, cu, av, ch, ad, as2, cp, cpl, fp, sp, ec, op, acr, pcr, bs, csch, gr] = await Promise.all([
              storage.get('camp_content'),
              storage.get('camp_counselors'),
              storage.get('camp_registrations'),
              storage.get('camp_parents'),
              storage.get('camp_counselor_users'),
              storage.get('camp_counselor_availability'),
              storage.get('camp_change_history'),
              storage.get('camp_admins'),
              storage.get('camp_assignments'),
              storage.get('camp_campers'),
              storage.get('camp_camper_parent_links'),
              storage.get('camp_food_photos'),
              storage.get('camp_site_photos'),
              storage.get('camp_emergency_contacts'),
              storage.get('camp_onboarding_progress'),
              storage.get('camp_availability_change_requests'),
              storage.get('camp_profile_change_requests'),
              storage.get('camp_blocked_sessions'),
              storage.get('camp_counselor_schedule'),
              storage.get('camp_gym_rentals'),
            ]);
            if (cd?.[0]?.data) setContent({ ...DEFAULT_CONTENT, ...cd[0].data });
            if (cs?.length) setCounselors(cs.map(c => c.data).filter(Boolean).sort((a, b) => (a.order || 0) - (b.order || 0)));
            if (rg?.length) setRegistrations(rg.map(r => r.data).filter(Boolean));
            if (pr?.[0]?.data) setParents(Array.isArray(pr[0].data) ? pr[0].data : []);
            if (cu?.[0]?.data) setCounselorUsers(Array.isArray(cu[0].data) ? cu[0].data : []);
            if (av?.[0]?.data) setAvailability(av[0].data);
            if (ch?.[0]?.data) setChangeHistory(Array.isArray(ch[0].data) ? ch[0].data : []);
            if (ad?.[0]?.data) setAdmins(Array.isArray(ad[0].data) ? ad[0].data : DEFAULT_ADMINS);
            if (as2?.[0]?.data) setAssignments(as2[0].data);
            if (cp?.[0]?.data) setCampers(Array.isArray(cp[0].data) ? cp[0].data : []);
            if (cpl?.[0]?.data) setCamperParentLinks(Array.isArray(cpl[0].data) ? cpl[0].data : []);
            if (fp?.[0]?.data) setFoodPhotos(fp[0].data);
            if (sp?.[0]?.data) setSitePhotos(sp[0].data);
            if (ec?.[0]?.data) setEmergencyContacts(Array.isArray(ec[0].data) ? ec[0].data : []);
            if (op?.[0]?.data) setOnboardingProgress(op[0].data || {});
            if (acr?.[0]?.data) setAvailabilityChangeRequests(Array.isArray(acr[0].data) ? acr[0].data : []);
            if (pcr?.[0]?.data) setProfileChangeRequests(Array.isArray(pcr[0].data) ? pcr[0].data : []);
            if (bs?.[0]?.data) setBlockedSessions(typeof bs[0].data === 'object' && !Array.isArray(bs[0].data) ? bs[0].data : {});
            if (csch?.[0]?.data) setCounselorSchedule(typeof csch[0].data === 'object' && !Array.isArray(csch[0].data) ? csch[0].data : {});
            if (gr?.[0]?.data) setGymRentals(typeof gr[0].data === 'object' && !Array.isArray(gr[0].data) ? gr[0].data : {});
          } catch (e) { console.error('Load error:', e); }
          setLoading(false);
        };
        load();
      }, []);

      const addToHistory = useCallback(async (action, details, relatedEmails = []) => {
        const entry = {
          id: Date.now(),
          timestamp: new Date().toISOString(),
          action,
          details,
          changedBy: user?.name || user?.email || 'Admin',
          ...(relatedEmails.length > 0 ? { relatedEmails } : {})
        };
        const newHistory = [entry, ...changeHistory].slice(0, 500);
        setChangeHistory(newHistory);
        await storage.set('camp_change_history', 'main', newHistory);
      }, [changeHistory, user]);

      const saveContent = async (c, field = null) => {
        setContent(c);
        await storage.set('camp_content', 'main', c);
        if (field) {
          addToHistory('Content Updated', `Changed "${field}"`);
        }
        showToast('Saved!');
      };

      const saveCounselors = async (cs, action = null) => {
        setCounselors(cs);
        for (const c of cs) await storage.set('camp_counselors', c.id, c);
        if (action) addToHistory('Counselor', action);
        showToast('Saved!');
      };

      const deleteCounselor = async (counselorId, counselorName) => {
        // Remove from state
        const updated = counselors.filter(c => c.id !== counselorId).map((c, i) => ({ ...c, order: i }));
        setCounselors(updated);
        // Remove from database
        try {
          await supabase.from('camp_counselors').delete().eq('id', counselorId);
        } catch (e) { console.error('Error deleting counselor:', e); }
        // Clean up assignments that reference this counselor
        const cleanedAssignments = { ...assignments };
        Object.keys(cleanedAssignments).forEach(key => {
          if (cleanedAssignments[key][counselorId]) {
            delete cleanedAssignments[key][counselorId];
          }
        });
        await saveAssignments(cleanedAssignments);
        // Clean up availability
        const cleanedAvail = { ...availability };
        if (cleanedAvail[counselorId]) {
          delete cleanedAvail[counselorId];
          await saveAvail(cleanedAvail);
        }
        addToHistory('Counselor', `Deleted counselor ${counselorName}`);
        showToast('Counselor deleted');
      };

      const saveReg = async (r, action = null) => {
        setRegistrations(prevRegs => {
          const newRegs = prevRegs.some(x => x.id === r.id) ? prevRegs.map(x => x.id === r.id ? r : x) : [...prevRegs, r];
          return newRegs;
        });
        await storage.set('camp_registrations', r.id, r);
        if (action) addToHistory('Registration', action);
      };

      const saveRegistrations = async (regs, action = null) => {
        // Delete all existing registrations from Supabase (they're stored as individual records)
        const currentRegIds = registrations.map(r => r.id);
        for (const regId of currentRegIds) {
          await supabase.from('camp_registrations').delete().eq('id', regId);
        }
        // Save new registrations (if any)
        for (const reg of regs) {
          await storage.set('camp_registrations', reg.id, reg);
        }
        setRegistrations(regs);
        if (action) addToHistory('Registration', action);
      };

      const saveParents = async (p, action = null) => {
        setParents(p);
        await storage.set('camp_parents', 'main', p);
        if (action) addToHistory('Parent', action);
      };

      const saveCounselorUsers = async (cu, action = null) => {
        setCounselorUsers(cu);
        await storage.set('camp_counselor_users', 'main', cu);
        if (action) addToHistory('Counselor User', action);
      };

      // Backward compatibility: saveUsers intelligently routes to correct table
      const saveUsers = async (u, action = null) => {
        const newParents = u.filter(user => user.role === 'parent' || user.roles?.includes('parent'));
        const newCounselorUsers = u.filter(user => user.role === 'counselor' || user.roles?.includes('counselor'));

        if (newParents.length > 0) await saveParents(newParents, action);
        if (newCounselorUsers.length > 0) await saveCounselorUsers(newCounselorUsers, action);
      };

      const deleteParent = async (parentEmail, parentName) => {
        // Remove from parents state
        const updatedParents = parents.filter(p => p.email !== parentEmail);
        setParents(updatedParents);
        await storage.set('camp_parents', 'main', updatedParents);
        // Remove camper-parent links for this parent
        const updatedLinks = camperParentLinks.filter(l => l.parentEmail !== parentEmail);
        setCamperParentLinks(updatedLinks);
        await storage.set('camp_camper_parent_links', 'main', updatedLinks);
        // Note: We don't delete registrations - they're historical records
        addToHistory('Parent', `Deleted parent ${parentName}`);
        showToast('Parent deleted');
      };
      const saveAvail = async (a) => { setAvailability(a); await storage.set('camp_counselor_availability', 'main', a); };
      const saveAdmins = async (a, action = null) => {
        setAdmins(a);
        await storage.set('camp_admins', 'main', a);
        if (action) addToHistory('Admin', action);
      };
      const saveAssignments = async (a, action = null) => {
        setAssignments(a);
        await storage.set('camp_assignments', 'main', a);
        if (action) addToHistory('Assignment', action);
      };
      const saveCampers = async (c, action = null) => {
        setCampers(c);
        await storage.set('camp_campers', 'main', c);
        if (action) addToHistory('Camper', action);
      };
      const saveFoodPhotos = async (photos) => {
        setFoodPhotos(photos);
        await storage.set('camp_food_photos', 'main', photos);
        addToHistory('Content', 'Updated food photos');
        showToast('Photo updated!');
      };

      const saveSitePhotos = async (photos, photoName = null) => {
        setSitePhotos(photos);
        await storage.set('camp_site_photos', 'main', photos);
        if (photoName) addToHistory('Content', `Updated ${photoName} photo`);
        showToast('Photo updated!');
      };

      const deleteCamper = async (camperId, camperName) => {
        // Remove from campers state
        const updatedCampers = campers.filter(c => c.id !== camperId);
        setCampers(updatedCampers);
        await storage.set('camp_campers', 'main', updatedCampers);
        // Remove camper-parent links
        const updatedLinks = camperParentLinks.filter(l => l.camperId !== camperId);
        setCamperParentLinks(updatedLinks);
        await storage.set('camp_camper_parent_links', 'main', updatedLinks);
        // Clean up assignments that reference this camper
        const cleanedAssignments = { ...assignments };
        Object.keys(cleanedAssignments).forEach(key => {
          Object.keys(cleanedAssignments[key]).forEach(counselorId => {
            cleanedAssignments[key][counselorId] = cleanedAssignments[key][counselorId].filter(id => id !== camperId);
          });
        });
        setAssignments(cleanedAssignments);
        await storage.set('camp_assignments', 'main', cleanedAssignments);
        // Note: We don't delete registrations - they're historical records
        addToHistory('Camper', `Deleted camper ${camperName}`);
        showToast('Camper deleted');
      };

      const saveCamperParentLinks = async (links) => {
        setCamperParentLinks(links);
        await storage.set('camp_camper_parent_links', 'main', links);
      };

      const saveBlockedSessions = async (sessions, action = null) => {
        setBlockedSessions(sessions);
        await storage.set('camp_blocked_sessions', 'main', sessions);
        if (action) addToHistory('Sessions', action);
      };

      const saveGymRentals = async (rentals, action = null) => {
        setGymRentals(rentals);
        await storage.set('camp_gym_rentals', 'main', rentals);
        if (action) addToHistory('Gym Rentals', action);
      };

      const saveCounselorSchedule = async (schedule, action = null) => {
        setCounselorSchedule(schedule);
        await storage.set('camp_counselor_schedule', 'main', schedule);
        if (action) addToHistory('Counselor Schedule', action);
      };

      // Helper to check if a counselor is scheduled to work a session
      const isCounselorScheduled = (counselorId, date, session) => {
        return counselorSchedule[counselorId]?.[date]?.[session] === true;
      };

      // Helper to check if a session is blocked
      const isSessionBlocked = (date, session) => {
        return blockedSessions[date]?.[session] === true;
      };

      // Helper to check if a date is fully blocked (both sessions)
      const isDateFullyBlocked = (date) => {
        return isSessionBlocked(date, 'morning') && isSessionBlocked(date, 'afternoon');
      };

      // Compute available dates (dates where at least one session is available)
      const availableDates = CAMP_DATES.filter(d => !isDateFullyBlocked(d));

      // New save functions for onboarding system
      const saveEmergencyContacts = async (contacts, action = null) => {
        setEmergencyContacts(contacts);
        await storage.set('camp_emergency_contacts', 'main', contacts);
        if (action) addToHistory('Emergency Contacts', action);
      };

      const saveOnboardingProgress = async (progress) => {
        setOnboardingProgress(progress);
        await storage.set('camp_onboarding_progress', 'main', progress);
      };

      const saveAvailabilityChangeRequests = async (requests, action = null) => {
        setAvailabilityChangeRequests(requests);
        await storage.set('camp_availability_change_requests', 'main', requests);
        if (action) addToHistory('Availability', action);
      };

      const saveProfileChangeRequests = async (requests, action = null) => {
        setProfileChangeRequests(requests);
        await storage.set('camp_profile_change_requests', 'main', requests);
        if (action) addToHistory('Profile', action);
      };

      const countOrders = (regs) => new Set(regs.map(r => r.orderId || r.id)).size;
      const getPending = () => countOrders(registrations.filter(r => r.status === 'pending' && ['sent', 'submitted'].includes(r.paymentStatus)));
      const getApproved = () => countOrders(registrations.filter(r => r.status === 'approved'));
      const getCancelled = () => countOrders(registrations.filter(r => r.status === 'cancelled' || r.status === 'rejected'));
      const getUnpaid = () => countOrders(registrations.filter(r => r.status === 'pending' && r.paymentStatus === 'unpaid'));

      // ==================== ADMIN TAB CONFIGURATION ====================
      const ADMIN_TAB_CONFIG = {
        'dashboard': { label: 'üìä Dashboard', hasChildren: false },
        'family': {
          label: 'üë®‚Äçüë©‚Äçüëß Family Setup',
          hasChildren: true,
          children: {
            'parents': { label: 'Parents', badge: () => parents.length },
            'campers': { label: 'Campers', badge: () => campers.length }
          },
          defaultChild: 'parents'
        },
        'counselor': {
          label: 'üèÄ Counselor Setup',
          hasChildren: true,
          badge: () => counselors.length,
          children: {
            'counselors': { label: 'Counselors', badge: () => counselors.filter(c => c.visible !== false && c.approvedByAdmin !== false).length },
            'applications': { label: 'Applications', badge: () => counselors.filter(c => c.approvedByAdmin === false || c.visible === false).length },
            'availability': { label: 'Work Availability' },
            'workschedule': { label: 'Work Schedule' }
          },
          defaultChild: 'counselors'
        },
        'registrations': {
          label: '‚úÖ Registrations',
          hasChildren: true,
          badge: () => getPending(),
          children: {
            'new': { label: 'New', badge: () => getUnpaid() },
            'pending': { label: 'Pending Approval', badge: () => getPending() },
            'paid': { label: 'Paid', badge: () => getApproved() },
            'invoices': { label: 'Customer Invoices', badge: () => countOrders(registrations.filter(r => r.invoiceId)) }
          },
          defaultChild: 'new'
        },
        'pod': {
          label: 'üìã Pod Setup',
          hasChildren: true,
          children: {
            'assignments': { label: 'Counselor and Camper Assignments' }
          },
          defaultChild: 'assignments'
        },
        'camp': {
          label: '‚öôÔ∏è Camp Setup',
          hasChildren: true,
          children: {
            'gymrentals': { label: 'Gym Rental Days' },
            'content': { label: 'Public Website Content' },
            'history': { label: 'üìú History' },
            'dangerzone': { label: '‚ö†Ô∏è Danger Zone' }
          },
          defaultChild: 'gymrentals'
        }
      };

      // Navigation helper functions
      const getActiveChildTab = (parentKey) => {
        const config = ADMIN_TAB_CONFIG[parentKey];
        if (!config?.hasChildren) return null;
        return adminChildTab[parentKey] || config.defaultChild;
      };

      const navigateToTab = (parentKey, childKey = null) => {
        setAdminParentTab(parentKey);
        const config = ADMIN_TAB_CONFIG[parentKey];
        if (config?.hasChildren) {
          const targetChild = childKey || adminChildTab[parentKey] || config.defaultChild;
          setAdminChildTab(prev => ({ ...prev, [parentKey]: targetChild }));
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      // ==================== NAV ====================
      // ==================== NAV (ADMIN) ====================
      const Nav = () => {
        const handleLogout = () => {
          sessionStorage.removeItem('user');
          window.location.href = '/index.html';
        };

        return (
          <nav className="bg-green-900 text-white shadow-lg">
            <div className="max-w-6xl mx-auto px-3 sm:px-4 py-3 sm:py-3 flex flex-wrap items-center justify-between gap-2">
              <div className="font-display text-xl sm:text-2xl cursor-pointer" onClick={() => window.location.href = '/index.html'}>üèÄ ROOSEVELT CAMP</div>
              <div className="hidden md:flex gap-1 items-center">
                {['home', 'schedule', 'pricing', 'location', 'counselors'].map(p => (
                  <a key={p} href={'/index.html#' + p} className="px-3 py-1.5 rounded text-sm capitalize hover:bg-green-800 transition-colors">{p}</a>
                ))}
              </div>
              <div className="flex flex-wrap gap-1.5 sm:gap-2 items-center">
                <span className="text-green-300 text-xs sm:text-sm px-2 py-1">{user?.name || 'Admin'}</span>
                <button onClick={handleLogout} className="px-3 sm:px-4 py-2.5 sm:py-2 bg-red-600 hover:bg-red-700 rounded text-sm sm:text-base min-h-[44px]">Logout</button>
              </div>
            </div>
          </nav>
        );
      };

      const Counselors = () => (
        <div className="min-h-screen bg-amber-50 py-8 sm:py-12">
          <div className="max-w-6xl mx-auto px-4">
            <h1 className="font-display text-2xl sm:text-3xl md:text-4xl text-green-800 text-center mb-6 sm:mb-8">Our Counselors</h1>
            <div className="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4 md:gap-6">
              {counselors.filter(c => c.visible).map(c => (
                <div key={c.id} className="bg-white rounded-xl shadow-lg overflow-hidden">
                  <div className="pt-4 sm:pt-6 flex items-center justify-center">
                    {getDisplayPhoto(c.photo) ? <img src={getDisplayPhoto(c.photo)} className="w-28 h-28 sm:w-48 sm:h-48 rounded-full object-cover border-4 border-green-600 shadow-lg" /> : <div className="w-28 h-28 sm:w-48 sm:h-48 rounded-full bg-gray-200 flex flex-col items-center justify-center border-4 border-green-600 shadow-lg"><svg className="w-8 h-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg><span className="text-xs text-gray-500 font-medium">add photo</span></div>}
                  </div>
                  <div className="p-3 sm:p-4 text-center">
                    <h3 className="font-bold text-base sm:text-xl text-green-800">{c.name}</h3>
                    <p className="text-green-600 text-xs sm:text-base">{c.position} ‚Ä¢ {c.year}</p>
                    <p className="text-gray-600 text-xs sm:text-sm mt-1 sm:mt-2">{c.bio}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );

      // ==================== ROLE SELECTOR ====================
      const RoleSelector = ({ onSelect, onBack }) => (
        <div className="min-h-screen bg-gradient-to-br from-green-50 to-green-100 py-8 sm:py-12">
          <div className="max-w-lg mx-auto px-4">
            <div className="bg-white rounded-2xl shadow-xl p-4 sm:p-8">
              <h2 className="font-display text-2xl sm:text-3xl text-green-800 text-center mb-2">Join Roosevelt Camp</h2>
              <p className="text-gray-600 text-center mb-6 sm:mb-8 text-sm sm:text-base">How would you like to participate?</p>

              <div className="space-y-3 sm:space-y-4">
                <button
                  onClick={() => onSelect('parent')}
                  className="w-full p-4 sm:p-6 border-2 border-gray-200 rounded-xl hover:border-green-500 hover:bg-green-50 transition-all text-left group"
                >
                  <div className="flex items-start gap-3 sm:gap-4">
                    <div className="text-3xl sm:text-4xl">üë®‚Äçüë©‚Äçüëß</div>
                    <div>
                      <h3 className="font-bold text-lg sm:text-xl text-green-800 group-hover:text-green-600">I'm a Parent</h3>
                      <p className="text-gray-600 mt-1 text-sm sm:text-base">Register your children for basketball camp sessions</p>
                      <ul className="text-xs sm:text-sm text-gray-500 mt-2 space-y-1">
                        <li>‚Ä¢ Add your children's profiles</li>
                        <li>‚Ä¢ Set up emergency contacts</li>
                        <li>‚Ä¢ Register for camp sessions</li>
                      </ul>
                    </div>
                  </div>
                </button>

                <button
                  onClick={() => onSelect('counselor')}
                  className="w-full p-4 sm:p-6 border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all text-left group"
                >
                  <div className="flex items-start gap-3 sm:gap-4">
                    <div className="text-3xl sm:text-4xl">üèÄ</div>
                    <div>
                      <h3 className="font-bold text-lg sm:text-xl text-blue-800 group-hover:text-blue-600">I'm a Counselor</h3>
                      <p className="text-gray-600 mt-1 text-sm sm:text-base">Apply to be a camp counselor and work with campers</p>
                      <ul className="text-xs sm:text-sm text-gray-500 mt-2 space-y-1">
                        <li>‚Ä¢ Create your counselor profile</li>
                        <li>‚Ä¢ Set your availability</li>
                        <li>‚Ä¢ Pending admin approval</li>
                      </ul>
                    </div>
                  </div>
                </button>
              </div>

              <button
                onClick={onBack}
                className="w-full mt-6 text-gray-500 hover:text-gray-700 text-sm"
              >
                ‚Üê Back to login
              </button>
            </div>
          </div>
        </div>
      );
      const CounselorOnboarding = ({ onComplete, onBack, users, saveUsers, counselors, saveCounselors, availability, saveAvailability, counselorSchedule, saveCounselorSchedule }) => {
        const [step, setStep] = useState(1);
        const [userData, setUserData] = useState({ name: '', email: '', phone: '', password: '' });
        const [showPassword, setShowPassword] = useState(false);
        const [profileData, setProfileData] = useState({ position: 'Point Guard', year: 'Freshman', bio: '', photo: null });
        const [availData, setAvailData] = useState({});
        const [unavailData, setUnavailData] = useState({});
        const [selectedMonth, setSelectedMonth] = useState(6); // 6=July, 7=August
        const [responsibilitiesAcked, setResponsibilitiesAcked] = useState(false);
        const [payAcked, setPayAcked] = useState(false);
        const [error, setError] = useState('');
        const [showCropper, setShowCropper] = useState(false);
        const [tempImage, setTempImage] = useState(null);
        const [submitting, setSubmitting] = useState(false); // Prevents flash during submission
        const photoInputRef = useRef(null);

        const totalSteps = 5;

        const steps = [
          { num: 1, title: 'Account', icon: 'üë§' },
          { num: 2, title: 'Profile', icon: 'üèÄ' },
          { num: 3, title: 'Availability', icon: 'üìÖ' },
          { num: 4, title: 'Responsibilities', icon: 'üìã' },
          { num: 5, title: 'Submit', icon: '‚úÖ' }
        ];

        const handlePhotoUpload = (e) => {
          const file = e.target.files?.[0];
          if (file) {
            const reader = new FileReader();
            reader.onloadend = () => {
              setTempImage(reader.result);
              setShowCropper(true);
            };
            reader.readAsDataURL(file);
          }
          if (e.target) e.target.value = '';
        };

        // Availability helpers - cycle: grey (unset) ‚Üí green (available) ‚Üí red (unavailable) ‚Üí grey
        const getSessionState = (date, session) => {
          const avail = availData[date] || [];
          const unavail = unavailData[date] || [];
          if (avail.includes(session)) return 'available';
          if (unavail.includes(session)) return 'unavailable';
          return 'unset';
        };

        const toggleSession = (date, session) => {
          const state = getSessionState(date, session);
          if (state === 'unset') {
            // grey ‚Üí green (available)
            setAvailData({ ...availData, [date]: [...(availData[date] || []), session] });
            setUnavailData({ ...unavailData, [date]: (unavailData[date] || []).filter(s => s !== session) });
          } else if (state === 'available') {
            // green ‚Üí red (unavailable)
            setAvailData({ ...availData, [date]: (availData[date] || []).filter(s => s !== session) });
            setUnavailData({ ...unavailData, [date]: [...(unavailData[date] || []), session] });
          } else {
            // red ‚Üí grey (unset)
            setUnavailData({ ...unavailData, [date]: (unavailData[date] || []).filter(s => s !== session) });
          }
        };

        const selectAllSessions = () => {
          const newAvail = {};
          CAMP_DATES.forEach(date => {
            newAvail[date] = ['morning', 'afternoon'];
          });
          setAvailData(newAvail);
          setUnavailData({});
        };

        const clearAllSessions = () => {
          setAvailData({});
          setUnavailData({});
        };

        const getTotalSessions = () => {
          return Object.values(availData).flat().length;
        };

        const getUnavailableSessions = () => {
          return Object.values(unavailData).flat().length;
        };

        const validateStep = () => {
          setError('');
          if (step === 1) {
            if (!userData.name || !userData.email || !userData.phone || !userData.password) {
              setError('Please fill in all required fields');
              return false;
            }
            if (!isValidPhone(userData.phone)) {
              setError('Please enter a valid phone number');
              return false;
            }
            if (users.some(u => u.email === userData.email) || counselors.some(c => c.email === userData.email)) {
              setError('An account with this email already exists');
              return false;
            }
          }
          if (step === 2) {
            if (!profileData.bio || profileData.bio.length < 20) {
              setError('Please write a bio (at least 20 characters)');
              return false;
            }
          }
          if (step === 3) {
            if (Object.values(availData).flat().length === 0) {
              setError('Please select at least one available session');
              return false;
            }
          }
          if (step === 4) {
            if (!responsibilitiesAcked || !payAcked) {
              setError('Please acknowledge both the responsibilities and pay terms');
              return false;
            }
          }
          return true;
        };

        const handleNext = async () => {
          if (!validateStep()) return;

          if (step === totalSteps) {
            // Show submitting screen to prevent flash
            setSubmitting(true);

            // Create user account
            const newUser = {
              email: userData.email,
              name: userData.name,
              phone: userData.phone,
              role: 'counselor',
              roles: ['counselor'],
              onboardingComplete: true,
              onboardingCompletedAt: new Date().toISOString()
            };
            if (userData.password) {
              try {
                const hashRes = await fetch('/.netlify/functions/hash-password', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ password: userData.password })
                });
                const hashData = await hashRes.json();
                if (hashRes.ok) newUser.passwordHash = hashData.passwordHash;
              } catch (e) { /* Continue without hash */ }
            }
            await saveCounselorUsers([...counselorUsers, newUser]);

            // Create counselor profile (pending approval)
            const newCounselor = {
              id: 'counselor_' + Date.now(),
              name: userData.name,
              email: userData.email,
              phone: userData.phone,
              position: profileData.position,
              year: profileData.year,
              bio: profileData.bio,
              photo: profileData.photo,
              visible: false, // Hidden until approved
              approvedByAdmin: false,
              responsibilitiesAcknowledged: true,
              payDisclosureAcknowledged: true,
              createdAt: new Date().toISOString(),
              order: counselors.length
            };
            await saveCounselors([...counselors, newCounselor]);

            // Save availability in object format with both available and unavailable arrays
            // This format is required for counselor dashboard to show both green and red sessions
            const allDates = new Set([...Object.keys(availData), ...Object.keys(unavailData)]);
            const combinedAvail = {};
            allDates.forEach(date => {
              combinedAvail[date] = {
                available: availData[date] || [],
                unavailable: unavailData[date] || []
              };
            });
            const newAvail = { ...availability, [newCounselor.email]: combinedAvail };
            await saveAvail(newAvail);

            // Also save to counselorSchedule so admin dashboard shows availability immediately
            // Save both available (true) and unavailable (false) sessions
            const newSchedule = { ...counselorSchedule };
            newSchedule[newCounselor.id] = {};
            allDates.forEach(date => {
              const avail = availData[date] || [];
              const unavail = unavailData[date] || [];
              // Only add date entry if there's any data for it
              if (avail.length > 0 || unavail.length > 0) {
                newSchedule[newCounselor.id][date] = {};
                // Set true for available, false for unavailable
                if (avail.includes('morning')) newSchedule[newCounselor.id][date].morning = true;
                else if (unavail.includes('morning')) newSchedule[newCounselor.id][date].morning = false;
                if (avail.includes('afternoon')) newSchedule[newCounselor.id][date].afternoon = true;
                else if (unavail.includes('afternoon')) newSchedule[newCounselor.id][date].afternoon = false;
              }
            });
            await saveCounselorSchedule(newSchedule, `${newCounselor.name} registered with availability`);

            onComplete(newUser);
            return;
          }

          setStep(step + 1);
        };

        const handleBack = () => {
          if (step === 1) {
            onBack();
          } else {
            setStep(step - 1);
          }
        };

        // Submitting screen - prevents flash during async operations
        if (submitting) {
          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center">
              <div className="bg-white rounded-2xl shadow-xl p-8 text-center max-w-md">
                <div className="text-6xl mb-4">üèÄ</div>
                <h2 className="font-display text-2xl text-blue-800 mb-2">Submitting Application...</h2>
                <p className="text-gray-600">Please wait while we save your information.</p>
                <div className="mt-4 flex justify-center">
                  <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                </div>
              </div>
            </div>
          );
        }

        // Image cropper modal
        if (showCropper && tempImage) {
          return (
            <div className="min-h-screen bg-gray-900 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-lg w-full p-6">
                <h3 className="font-bold text-lg mb-4">Crop Your Photo</h3>
                <ImageCropper
                  image={tempImage}
                  shape="circle"
                  onSave={(img) => {
                    setProfileData({ ...profileData, photo: img });
                    setShowCropper(false);
                    setTempImage(null);
                  }}
                  onCancel={() => {
                    setShowCropper(false);
                    setTempImage(null);
                  }}
                />
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 py-8">
            <div className="max-w-lg mx-auto px-4">
              {/* Progress Bar */}
              <div className="mb-6">
                <div className="flex justify-between items-center mb-2">
                  {steps.map((s) => (
                    <div
                      key={s.num}
                      className={`flex flex-col items-center ${s.num <= step ? 'text-blue-600' : 'text-gray-400'}`}
                    >
                      <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg ${
                        s.num < step ? 'bg-blue-600 text-white' :
                        s.num === step ? 'bg-blue-100 border-2 border-blue-600' : 'bg-gray-200'
                      }`}>
                        {s.num < step ? '‚úì' : s.icon}
                      </div>
                      <span className="text-xs mt-1 hidden sm:block">{s.title}</span>
                    </div>
                  ))}
                </div>
                <div className="h-2 bg-gray-200 rounded-full">
                  <div
                    className="h-2 bg-blue-600 rounded-full transition-all"
                    style={{ width: `${((step - 1) / (totalSteps - 1)) * 100}%` }}
                  />
                </div>
              </div>

              {/* Content Card */}
              <div className="bg-white rounded-2xl shadow-xl p-8">
                <h2 className="font-display text-2xl text-blue-800 mb-6">
                  {steps[step - 1].title}
                </h2>

                {error && (
                  <div className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm">
                    {error}
                  </div>
                )}

                {/* Step 1: Account */}
                {step === 1 && (
                  <div className="space-y-4">
                    <p className="text-gray-600 mb-4">Create your counselor account to get started.</p>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                      <input value={userData.name} onChange={e => setUserData({ ...userData, name: e.target.value })} className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Your full name" autoComplete="off" data-1p-ignore="true" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                      <input type="email" value={userData.email} onChange={e => setUserData({ ...userData, email: e.target.value })} className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="your@email.com" autoComplete="off" data-1p-ignore="true" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                      <input value={userData.phone} onChange={e => setUserData({ ...userData, phone: formatPhone(e.target.value) })} className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="(555) 555-1234" autoComplete="off" data-1p-ignore="true" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                      <div className="relative">
                        <input type={showPassword ? 'text' : 'password'} value={userData.password} onChange={e => setUserData({ ...userData, password: e.target.value })} className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none pr-16" placeholder="Create a password" autoComplete="off" data-1p-ignore="true" />
                        <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 text-sm">{showPassword ? 'Hide' : 'Show'}</button>
                      </div>
                    </div>
                  </div>
                )}

                {/* Step 2: Profile */}
                {step === 2 && (
                  <div className="space-y-4">
                    <p className="text-gray-600 mb-4">Tell us about your basketball background. This will appear on the camp website once approved.</p>
                    <div className="flex justify-center mb-4">
                      {getDisplayPhoto(profileData.photo) ? (
                        <div className="relative">
                          <img src={getDisplayPhoto(profileData.photo)} className="w-32 h-32 rounded-full object-cover border-4 border-blue-600" />
                          <button onClick={() => photoInputRef.current?.click()} className="absolute -bottom-2 -right-2 w-10 h-10 bg-blue-600 rounded-full text-white flex items-center justify-center hover:bg-blue-700">‚úé</button>
                        </div>
                      ) : (
                        <div onClick={() => photoInputRef.current?.click()} className="w-32 h-32 rounded-full bg-gray-200 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300">
                          <svg className="w-8 h-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                          <span className="text-xs text-gray-500 font-medium">add photo</span>
                        </div>
                      )}
                      <input ref={photoInputRef} type="file" accept="image/*" onChange={handlePhotoUpload} className="hidden" />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Position *</label>
                        <select value={profileData.position} onChange={e => setProfileData({ ...profileData, position: e.target.value })} className="w-full px-3 py-2 border rounded-lg">
                          <option value="Point Guard">Point Guard</option>
                          <option value="Shooting Guard">Shooting Guard</option>
                          <option value="Small Forward">Small Forward</option>
                          <option value="Power Forward">Power Forward</option>
                          <option value="Center">Center</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Year *</label>
                        <select value={profileData.year} onChange={e => setProfileData({ ...profileData, year: e.target.value })} className="w-full px-3 py-2 border rounded-lg">
                          <option value="Freshman">Freshman</option>
                          <option value="Sophomore">Sophomore</option>
                          <option value="Junior">Junior</option>
                          <option value="Senior">Senior</option>
                          <option value="Alumni">Alumni</option>
                        </select>
                      </div>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Bio *</label>
                      <textarea value={profileData.bio} onChange={e => setProfileData({ ...profileData, bio: e.target.value })} className="w-full px-3 py-2 border rounded-lg h-24" placeholder="Tell us about your basketball experience and why you want to be a counselor..." />
                      <p className="text-xs text-gray-500 mt-1">{profileData.bio.length}/200 characters</p>
                    </div>
                  </div>
                )}

                {/* Step 3: Availability */}
                {step === 3 && (
                  <div className="space-y-4">
                    <p className="text-gray-600 mb-2">Camp runs weekdays only (Mon-Fri). Click each session to set your availability. Click cycles through: <span className="text-gray-400 font-medium">Not Set</span> ‚Üí <span className="text-green-600 font-medium">Available</span> ‚Üí <span className="text-red-600 font-medium">Unavailable</span></p>

                    {/* Month Tabs */}
                    <div className="flex flex-wrap gap-2 mb-4">
                      {[{ m: 6, n: 'July' }, { m: 7, n: 'August' }].map(({ m, n }) => (
                        <button key={m} onClick={() => setSelectedMonth(m)} className={'px-6 py-2 rounded-lg font-medium ' + (selectedMonth === m ? 'bg-green-600 text-white' : 'bg-white border border-green-600 text-green-700')}>{n}</button>
                      ))}
                      <div className="flex-1" />
                      <button onClick={selectAllSessions} className="px-3 py-1 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200">Mark All Available</button>
                      <button onClick={clearAllSessions} className="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Clear All</button>
                    </div>
                    <div className="text-sm text-gray-500 text-right mb-2">{getTotalSessions()} available ¬∑ {getUnavailableSessions()} unavailable</div>

                    {/* Weeks for selected month */}
                    {CAMP_WEEKS.filter(w => new Date(w.start + 'T12:00:00').getMonth() === selectedMonth).map((week, weekIdx) => (
                      <div key={weekIdx} className="border rounded-lg overflow-hidden">
                        <div className="bg-gray-100 px-3 py-2 text-sm font-medium">Week {weekIdx + 1}: {new Date(week.start + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                        <div className="grid grid-cols-5 gap-2 p-3">
                          {week.dates.map(date => {
                            const d = new Date(date + 'T12:00:00');
                            const amState = getSessionState(date, 'morning');
                            const pmState = getSessionState(date, 'afternoon');
                            const bothAvail = amState === 'available' && pmState === 'available';
                            const bothUnavail = amState === 'unavailable' && pmState === 'unavailable';
                            const cardBorder = bothAvail ? 'border-green-300 bg-green-50' : bothUnavail ? 'border-red-300 bg-red-50' : 'border-gray-200 bg-white';
                            const getButtonStyle = (state) => state === 'available' ? 'bg-green-500 text-white hover:bg-green-600' : state === 'unavailable' ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-gray-200 text-gray-600 hover:bg-gray-300';
                            return (
                              <div key={date} className={`rounded-lg border-2 overflow-hidden ${cardBorder}`}>
                                <div className={`text-center p-1 font-bold text-xs ${bothAvail ? 'bg-green-200' : bothUnavail ? 'bg-red-200' : 'bg-gray-100'}`}>
                                  <div className="text-gray-600">{['Mon', 'Tue', 'Wed', 'Thu', 'Fri'][d.getDay() - 1]}</div>
                                  <div>{d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                                </div>
                                <div className="p-1 space-y-1">
                                  <button onClick={() => toggleSession(date, 'morning')} className={`w-full p-1.5 rounded text-xs font-medium transition-colors ${getButtonStyle(amState)}`}>
                                    AM
                                  </button>
                                  <button onClick={() => toggleSession(date, 'afternoon')} className={`w-full p-1.5 rounded text-xs font-medium transition-colors ${getButtonStyle(pmState)}`}>
                                    PM
                                  </button>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    ))}
                    {/* Legend */}
                    <div className="flex gap-4 text-xs text-gray-600 justify-center">
                      <div className="flex items-center gap-1"><div className="w-4 h-4 bg-green-500 rounded"></div><span>Available</span></div>
                      <div className="flex items-center gap-1"><div className="w-4 h-4 bg-red-500 rounded"></div><span>Unavailable</span></div>
                      <div className="flex items-center gap-1"><div className="w-4 h-4 bg-gray-200 rounded"></div><span>Not Set</span></div>
                    </div>
                    <p className="text-xs text-gray-500 text-center">You can update your availability later from your dashboard.</p>
                  </div>
                )}

                {/* Step 4: Responsibilities */}
                {step === 4 && (
                  <div className="space-y-6">
                    <div className="bg-white border rounded-lg overflow-hidden">
                      <div className="bg-blue-100 px-4 py-2 font-medium text-blue-800">üìã Counselor Responsibilities</div>
                      <div className="p-4">
                        <ul className="space-y-2">
                          {COUNSELOR_RESPONSIBILITIES.map((resp, idx) => (
                            <li key={idx} className="flex items-start gap-2 text-sm text-gray-600"><span className="text-blue-500">‚Ä¢</span>{resp}</li>
                          ))}
                        </ul>
                        <label className="flex items-center gap-3 mt-4 cursor-pointer">
                          <input type="checkbox" checked={responsibilitiesAcked} onChange={e => setResponsibilitiesAcked(e.target.checked)} className="w-5 h-5 text-blue-600" />
                          <span className="text-sm">I understand and accept these responsibilities</span>
                        </label>
                      </div>
                    </div>
                    <div className="bg-white border rounded-lg overflow-hidden">
                      <div className="bg-green-100 px-4 py-2 font-medium text-green-800">üíµ Pay Information</div>
                      <div className="p-4">
                        <pre className="whitespace-pre-wrap text-sm text-gray-600 font-sans">{PAY_DISCLOSURE}</pre>
                        <label className="flex items-center gap-3 mt-4 cursor-pointer">
                          <input type="checkbox" checked={payAcked} onChange={e => setPayAcked(e.target.checked)} className="w-5 h-5 text-green-600" />
                          <span className="text-sm">I understand and accept the pay terms and 1099 status</span>
                        </label>
                      </div>
                    </div>
                  </div>
                )}

                {/* Step 5: Submit */}
                {step === 5 && (
                  <div className="text-center space-y-6">
                    <div className="text-6xl">üì®</div>
                    <h3 className="font-display text-2xl text-blue-800">Ready to Submit!</h3>
                    <p className="text-gray-600">Your application will be reviewed by a camp administrator. You'll be notified once approved.</p>
                    <div className="bg-gray-50 rounded-lg p-4 text-left">
                      <h4 className="font-medium mb-2">Application Summary:</h4>
                      <p className="text-sm text-gray-600">‚Ä¢ {userData.name}</p>
                      <p className="text-sm text-gray-600">‚Ä¢ {profileData.position} ‚Ä¢ {profileData.year}</p>
                      <p className="text-sm text-gray-600">‚Ä¢ {getTotalSessions()} sessions available</p>
                    </div>
                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                      <p className="text-yellow-800 font-medium">‚è≥ Pending Admin Approval</p>
                      <p className="text-sm text-yellow-700 mt-1">Your profile won't appear on the website until approved by an administrator.</p>
                    </div>
                  </div>
                )}

                {/* Navigation */}
                <div className="flex gap-4 mt-8">
                  <button
                    onClick={handleBack}
                    className="flex-1 py-3 border-2 border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
                  >
                    {step === 1 ? '‚Üê Back' : '‚Üê Previous'}
                  </button>
                  <button
                    onClick={handleNext}
                    className="flex-1 py-3 bg-blue-700 hover:bg-blue-800 text-white font-bold rounded-lg"
                  >
                    {step === totalSteps ? 'Submit Application' : 'Continue ‚Üí'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // ==================== LOGIN ====================
      // Helper to get food photo (must be in Admin scope where foodPhotos is available)
      const getFoodPhoto = (key) => {
        const data = foodPhotos?.[key];
        if (!data) return null;
        return typeof data === 'string' ? data : data.cropped;
      };

      const Admin = () => {
        const [editCounselor, setEditCounselor] = useState(null);
        const [showModal, setShowModal] = useState(false);
        const [confirmDeleteCounselor, setConfirmDeleteCounselor] = useState(null);
        const [deleteConfirmText, setDeleteConfirmText] = useState('');
        // Use lifted state for availability modal to prevent closing on state updates
        const managingSchedule = counselorScheduleModal;
        const setManagingSchedule = setCounselorScheduleModal;
        const scheduleMonths = counselorScheduleMonths;
        const setScheduleMonths = setCounselorScheduleMonths;
        const availDraft = counselorAvailDraft;
        const setAvailDraft = setCounselorAvailDraft;
        const [availCalMonths, setAvailCalMonths] = useState([]);
        const [availCalHidden, setAvailCalHidden] = useState({});
        const [availCalWeeks, setAvailCalWeeks] = useState(null);
        const [availCalDates, setAvailCalDates] = useState(null);
        const [availCalSession, setAvailCalSession] = useState('both');
        const [schedCalMonths, setSchedCalMonths] = useState([]);
        const [schedCalHidden, setSchedCalHidden] = useState({});
        const [schedCalWeeks, setSchedCalWeeks] = useState(null);
        const [schedCalDates, setSchedCalDates] = useState(null);
        const [schedCalSession, setSchedCalSession] = useState('both');

        // Helper: count sessions where counselor is marked eligible by admin
        const getCounselorEligibleCount = (counselorId) => {
          const schedule = counselorSchedule[counselorId] || {};
          let count = 0;
          Object.values(schedule).forEach(day => {
            if (day.morning) count++;
            if (day.afternoon) count++;
          });
          return count;
        };

        // Helper: count sessions where counselor has campers assigned
        const getCounselorScheduledCount = (counselorId) => {
          let count = 0;
          Object.entries(assignments).forEach(([key, counselorAssignments]) => {
            if (counselorAssignments[counselorId]?.length > 0) {
              count++;
            }
          });
          return count;
        };

        // Sync admin schedule changes to counselor availability table
        const syncScheduleToAvailability = (counselorId, dates, newSchedule) => {
          const counselor = counselors.find(c => c.id === counselorId);
          if (!counselor?.email) return;
          const newAvail = JSON.parse(JSON.stringify(availability));
          if (!newAvail[counselor.email]) newAvail[counselor.email] = {};
          (Array.isArray(dates) ? dates : [dates]).forEach(date => {
            const sched = newSchedule[counselorId]?.[date] || {};
            // Preserve existing counselor-set availability for sessions the admin didn't touch
            const existing = newAvail[counselor.email][date] || {};
            const existingAvail = Array.isArray(existing) ? existing : (existing.available || []);
            const existingUnavail = Array.isArray(existing) ? [] : (existing.unavailable || []);
            const available = [];
            const unavailable = [];
            ['morning', 'afternoon'].forEach(session => {
              if (sched[session] === true) available.push(session);
              else if (sched[session] === false) unavailable.push(session);
              else {
                // Admin didn't set this session ‚Äî preserve counselor's own setting
                if (existingAvail.includes(session)) available.push(session);
                else if (existingUnavail.includes(session)) unavailable.push(session);
              }
            });
            if (available.length === 0 && unavailable.length === 0) {
              delete newAvail[counselor.email][date];
            } else {
              newAvail[counselor.email][date] = { available, unavailable };
            }
          });
          saveAvail(newAvail);
        };

        // Toggle counselor eligibility for a specific session (cycles: not set ‚Üí available ‚Üí unavailable ‚Üí not set)
        const toggleCounselorEligibility = (counselorId, date, session) => {
          const currentVal = counselorSchedule[counselorId]?.[date]?.[session];
          // Cycle: undefined/null ‚Üí true (available) ‚Üí false (unavailable) ‚Üí delete (not set)
          let newVal;
          let label;
          if (currentVal === true) {
            newVal = false;
            label = 'Unavailable';
          } else if (currentVal === false) {
            newVal = undefined; // not set
            label = 'Not Set';
          } else {
            newVal = true;
            label = 'Available';
          }
          const newDateSched = { ...counselorSchedule[counselorId]?.[date] };
          if (newVal === undefined) {
            delete newDateSched[session];
          } else {
            newDateSched[session] = newVal;
          }
          // Clean up empty date entries
          const hasValues = Object.keys(newDateSched).length > 0;
          const newCounselorSched = { ...counselorSchedule[counselorId] };
          if (hasValues) {
            newCounselorSched[date] = newDateSched;
          } else {
            delete newCounselorSched[date];
          }
          const newSchedule = { ...counselorSchedule, [counselorId]: newCounselorSched };
          const counselor = counselors.find(c => c.id === counselorId);
          saveCounselorSchedule(newSchedule, `Set ${counselor?.name} ${date} ${session} to ${label}`);
          syncScheduleToAvailability(counselorId, date, newSchedule);
        };

        // Toggle entire day for counselor (cycles: not set ‚Üí available ‚Üí unavailable ‚Üí not set)
        const toggleCounselorDay = (counselorId, date) => {
          const currentMorning = counselorSchedule[counselorId]?.[date]?.morning;
          const currentAfternoon = counselorSchedule[counselorId]?.[date]?.afternoon;
          const allAvailable = currentMorning === true && currentAfternoon === true;
          const allUnavailable = currentMorning === false && currentAfternoon === false;
          let newDateSched;
          let label;
          if (allAvailable) {
            newDateSched = { morning: false, afternoon: false };
            label = 'Unavailable';
          } else if (allUnavailable) {
            newDateSched = undefined; // not set ‚Äî remove entry
            label = 'Not Set';
          } else {
            newDateSched = { morning: true, afternoon: true };
            label = 'Available';
          }
          const newCounselorSched = { ...counselorSchedule[counselorId] };
          if (newDateSched) {
            newCounselorSched[date] = newDateSched;
          } else {
            delete newCounselorSched[date];
          }
          const newSchedule = { ...counselorSchedule, [counselorId]: newCounselorSched };
          const counselor = counselors.find(c => c.id === counselorId);
          saveCounselorSchedule(newSchedule, `Set ${counselor?.name} ${date} (full day) to ${label}`);
          syncScheduleToAvailability(counselorId, date, newSchedule);
        };

        // Toggle entire week for counselor
        const toggleCounselorWeek = (counselorId, weekDates) => {
          let allSet = true;
          weekDates.forEach(date => {
            if (counselorSchedule[counselorId]?.[date]?.morning !== true) allSet = false;
            if (counselorSchedule[counselorId]?.[date]?.afternoon !== true) allSet = false;
          });
          const newSchedule = { ...counselorSchedule };
          if (!newSchedule[counselorId]) newSchedule[counselorId] = {};
          weekDates.forEach(date => {
            newSchedule[counselorId][date] = {
              morning: !allSet,
              afternoon: !allSet
            };
          });
          const counselor = counselors.find(c => c.id === counselorId);
          saveCounselorSchedule(newSchedule, `${!allSet ? 'Added' : 'Removed'} ${counselor?.name} ${!allSet ? 'to' : 'from'} week`);
          syncScheduleToAvailability(counselorId, weekDates, newSchedule);
        };

        const updateContent = (field, value) => {
          const newContent = { ...content, [field]: value };
          saveContent(newContent, field);
        };

        return (
          <div className="min-h-screen bg-gray-100">
            <div className="bg-green-800 text-white py-3 sm:py-4">
              <div className="max-w-6xl mx-auto px-4 text-center">
                <h1 className="font-display text-2xl sm:text-3xl">Admin Dashboard</h1>
                <p className="text-green-200 text-sm sm:text-base">Welcome, {user?.name}</p>
              </div>
            </div>

            {/* Parent Tabs Row */}
            <div className="bg-white shadow">
              <div className="max-w-6xl mx-auto px-2 sm:px-4">
                <ScrollableTabs persistKey="admin-parent-tabs">
                  {Object.entries(ADMIN_TAB_CONFIG).map(([key, config]) => {
                    const isActive = adminParentTab === key;
                    const badge = config.badge ? config.badge() : null;

                    return (
                      <button
                        key={key}
                        onClick={() => {
                          navigateToTab(key);
                        }}
                        className={`px-4 sm:px-6 py-3 sm:py-4 border-b-3 font-semibold whitespace-nowrap select-none text-sm sm:text-base transition-colors ${
                          isActive
                            ? 'border-green-600 text-green-800 bg-green-100'
                            : 'border-transparent text-gray-600 hover:bg-gray-50'
                        }`}
                      >
                        {config.label}
                        {badge > 0 && (
                          <span className="ml-2 bg-green-700 text-white text-xs px-2 rounded-full">{badge}</span>
                        )}
                      </button>
                    );
                  })}
                </ScrollableTabs>
              </div>
            </div>

            {/* Child Tabs Row */}
            {ADMIN_TAB_CONFIG[adminParentTab]?.hasChildren && (
              <div className="bg-gray-50 border-t border-gray-200">
                <div className="max-w-6xl mx-auto px-2 sm:px-4">
                  <ScrollableTabs persistKey="admin-child-tabs">
                    {Object.entries(ADMIN_TAB_CONFIG[adminParentTab].children).map(([childKey, childConfig]) => {
                      const isActive = getActiveChildTab(adminParentTab) === childKey;
                      const badge = childConfig.badge ? childConfig.badge() : null;

                      return (
                        <button
                          key={childKey}
                          onClick={() => {
                            setAdminChildTab(prev => ({ ...prev, [adminParentTab]: childKey }));
                          }}
                          className={`px-3 sm:px-4 py-2 sm:py-3 border-b-2 whitespace-nowrap select-none text-xs sm:text-sm transition-colors ${
                            isActive
                              ? 'border-green-500 text-green-700 bg-green-50'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                        >
                          {childConfig.label}
                          {badge > 0 && (
                            <span className="ml-2 bg-green-700 text-white text-xs px-2 rounded-full">{badge}</span>
                          )}
                        </button>
                      );
                    })}
                  </ScrollableTabs>
                </div>
              </div>
            )}

            <div className="max-w-6xl mx-auto px-4 py-6">
              {adminParentTab === 'dashboard' && (
                <div className="text-center py-16">
                  <div className="text-6xl mb-4">üèÄ</div>
                  <h2 className="text-2xl font-bold text-gray-700 mb-2">Dashboard</h2>
                  <p className="text-gray-500 max-w-md mx-auto">Dashboard content coming soon. Use the tabs above to manage camp operations.</p>
                </div>
              )}

              {adminParentTab === 'counselor' && getActiveChildTab('counselor') === 'counselors' && (
                <div>
                  <div className="flex justify-between items-center mb-4">
                    <div>
                      <h2 className="font-bold text-xl">Counselors</h2>
                      <p className="text-sm text-gray-500">Manage counselor profiles and work eligibility</p>
                    </div>
                    <button onClick={() => { setEditCounselor({ name: '', email: '', phone: '', position: '', year: '', bio: '', photo: null, visible: true }); setShowModal(true); }} className="bg-green-600 text-white px-4 py-2 rounded-lg">+ Add</button>
                  </div>
                  <div className="space-y-3">
                    {counselors.filter(c => c.visible !== false && c.approvedByAdmin !== false).map((c, idx) => {
                      const eligibleCount = getCounselorEligibleCount(c.id);
                      const scheduledCount = getCounselorScheduledCount(c.id);
                      return (
                      <div key={c.id} className="bg-white rounded-xl shadow p-4">
                        <div className="flex items-center gap-4">
                          {/* Reorder buttons */}
                          <div className="flex flex-col gap-1">
                            <button
                              onClick={() => {
                                if (idx === 0) return;
                                const newOrder = [...counselors];
                                [newOrder[idx - 1], newOrder[idx]] = [newOrder[idx], newOrder[idx - 1]];
                                const reordered = newOrder.map((co, i) => ({ ...co, order: i }));
                                saveCounselors(reordered, `Moved ${c.name} up`);
                              }}
                              disabled={idx === 0}
                              className={'w-7 h-7 rounded flex items-center justify-center text-sm ' + (idx === 0 ? 'bg-gray-100 text-gray-300 cursor-not-allowed' : 'bg-gray-200 hover:bg-gray-300 text-gray-600')}
                              title="Move up"
                            >‚ñ≤</button>
                            <button
                              onClick={() => {
                                if (idx === counselors.length - 1) return;
                                const newOrder = [...counselors];
                                [newOrder[idx], newOrder[idx + 1]] = [newOrder[idx + 1], newOrder[idx]];
                                const reordered = newOrder.map((co, i) => ({ ...co, order: i }));
                                saveCounselors(reordered, `Moved ${c.name} down`);
                              }}
                              disabled={idx === counselors.length - 1}
                              className={'w-7 h-7 rounded flex items-center justify-center text-sm ' + (idx === counselors.length - 1 ? 'bg-gray-100 text-gray-300 cursor-not-allowed' : 'bg-gray-200 hover:bg-gray-300 text-gray-600')}
                              title="Move down"
                            >‚ñº</button>
                          </div>

                          {/* Position number */}
                          <div className="w-8 h-8 rounded-full bg-green-100 text-green-700 flex items-center justify-center font-bold text-sm">
                            {idx + 1}
                          </div>

                          {/* Photo */}
                          {getDisplayPhoto(c.photo) ? <img src={getDisplayPhoto(c.photo)} className="w-14 h-14 rounded-full object-cover" /> : <div className="w-14 h-14 rounded-full bg-gray-200 flex flex-col items-center justify-center"><svg className="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg><span className="text-[8px] text-gray-500 font-medium">add photo</span></div>}

                          {/* Info */}
                          <div className="flex-1">
                            <div className="font-bold">{c.name}</div>
                            <div className="text-sm text-gray-600">{c.position} ‚Ä¢ {c.year}</div>
                            <div className="flex gap-2 mt-1 flex-wrap">
                              {eligibleCount > 0 && (
                                <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">
                                  üìÖ {eligibleCount} session{eligibleCount !== 1 ? 's' : ''} eligible
                                </span>
                              )}
                              {scheduledCount > 0 ? (
                                <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">
                                  ‚úì Working {scheduledCount} session{scheduledCount !== 1 ? 's' : ''}
                                </span>
                              ) : eligibleCount > 0 ? (
                                <span className="text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded">
                                  No campers assigned yet
                                </span>
                              ) : null}
                            </div>
                          </div>

                          {/* Toggle Switch for Visibility */}
                          <div className="flex flex-col items-center gap-1">
                            <button
                              onClick={async () => {
                                const isCurrentlyVisible = c.visible !== false && c.approvedByAdmin !== false;
                                const newVisible = !isCurrentlyVisible;
                                const updated = counselors.map(co =>
                                  co.id === c.id
                                    ? { ...co, visible: newVisible, approvedByAdmin: newVisible }
                                    : co
                                );
                                await saveCounselors(updated, newVisible ? `Made ${c.name} visible on website` : `Hid ${c.name} from website`);
                              }}
                              className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${(c.visible !== false && c.approvedByAdmin !== false) ? 'bg-green-500' : 'bg-gray-300'}`}
                            >
                              <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${(c.visible !== false && c.approvedByAdmin !== false) ? 'translate-x-6' : 'translate-x-1'}`} />
                            </button>
                            <span className={`text-xs font-medium ${(c.visible !== false && c.approvedByAdmin !== false) ? 'text-green-600' : 'text-gray-400'}`}>
                              {(c.visible !== false && c.approvedByAdmin !== false) ? 'Visible' : 'Hidden'}
                            </span>
                          </div>

                          {/* Actions */}
                          <div className="flex gap-2 flex-wrap justify-end">
                            <button onClick={() => { setManagingSchedule(c); setScheduleMonths([]); setAvailDraft(JSON.parse(JSON.stringify(availability[c.email] || {}))); }} className="px-3 py-1 bg-green-50 text-green-600 rounded hover:bg-green-100 text-sm">Edit Availability</button>
                            <button onClick={() => { setEditCounselor(c); setShowModal(true); }} className="px-3 py-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 text-sm">Edit Profile</button>
                          </div>
                        </div>
                      </div>
                    )})}
                  </div>
                  {counselors.filter(c => c.visible !== false && c.approvedByAdmin !== false).length === 0 && (
                    <div className="text-center py-12 text-gray-500">
                      <p>{counselors.length === 0 ? 'No counselors yet. Click "+ Add" to add a counselor.' : 'No approved counselors yet. Check the Applications tab to approve pending counselors.'}</p>
                    </div>
                  )}

                  {/* Edit Availability Modal */}
                  {managingSchedule && availDraft && (() => {
                    // Helper: get availability state from draft
                    const getDraftState = (date, session) => {
                      const dateAvail = availDraft[date] || {};
                      const availSessions = Array.isArray(dateAvail) ? dateAvail : (dateAvail.available || []);
                      const unavailSessions = Array.isArray(dateAvail) ? [] : (dateAvail.unavailable || []);
                      if (availSessions.includes(session)) return 'available';
                      if (unavailSessions.includes(session)) return 'unavailable';
                      return 'not-set';
                    };

                    // Toggle a single session in draft
                    const toggleDraftSession = (date, session) => {
                      const current = getDraftState(date, session);
                      const otherSession = session === 'morning' ? 'afternoon' : 'morning';
                      const otherState = getDraftState(date, otherSession);
                      const existing = availDraft[date] || {};
                      const existingAvail = Array.isArray(existing) ? existing : (existing.available || []);
                      const existingUnavail = Array.isArray(existing) ? [] : (existing.unavailable || []);

                      let newAvail, newUnavail;
                      if (current === 'not-set') {
                        newAvail = [...new Set([...existingAvail, session])];
                        newUnavail = existingUnavail.filter(s => s !== session);
                      } else if (current === 'available') {
                        newAvail = existingAvail.filter(s => s !== session);
                        newUnavail = [...new Set([...existingUnavail, session])];
                      } else {
                        newAvail = existingAvail.filter(s => s !== session);
                        newUnavail = existingUnavail.filter(s => s !== session);
                      }

                      const newDraft = { ...availDraft };
                      if (newAvail.length === 0 && newUnavail.length === 0) {
                        delete newDraft[date];
                      } else {
                        newDraft[date] = { available: newAvail, unavailable: newUnavail };
                      }
                      setAvailDraft(newDraft);
                    };

                    // Toggle whole day in draft
                    const toggleDraftDay = (date) => {
                      const amState = getDraftState(date, 'morning');
                      const pmState = getDraftState(date, 'afternoon');
                      const allAvailable = amState === 'available' && pmState === 'available';
                      const allUnavailable = amState === 'unavailable' && pmState === 'unavailable';

                      const newDraft = { ...availDraft };
                      if (allAvailable) {
                        newDraft[date] = { available: [], unavailable: ['morning', 'afternoon'] };
                      } else if (allUnavailable) {
                        delete newDraft[date];
                      } else {
                        newDraft[date] = { available: ['morning', 'afternoon'], unavailable: [] };
                      }
                      setAvailDraft(newDraft);
                    };

                    // Save handler
                    const handleSaveAvailability = async () => {
                      const newAvailability = { ...availability, [managingSchedule.email]: availDraft };
                      await saveAvail(newAvailability);
                      addToHistory('Counselor Availability', `Updated availability for ${managingSchedule.name}`);
                      // Sync to counselor schedule
                      const newSchedule = { ...counselorSchedule };
                      const cs = {};
                      Object.entries(availDraft).forEach(([date, dateData]) => {
                        const avail = Array.isArray(dateData) ? dateData : (dateData.available || []);
                        const unavail = Array.isArray(dateData) ? [] : (dateData.unavailable || []);
                        const morning = avail.includes('morning') ? true : unavail.includes('morning') ? false : undefined;
                        const afternoon = avail.includes('afternoon') ? true : unavail.includes('afternoon') ? false : undefined;
                        if (morning !== undefined || afternoon !== undefined) {
                          cs[date] = {};
                          if (morning !== undefined) cs[date].morning = morning;
                          if (afternoon !== undefined) cs[date].afternoon = afternoon;
                        }
                      });
                      newSchedule[managingSchedule.id] = cs;
                      await saveCounselorSchedule(newSchedule, `Synced schedule for ${managingSchedule.name}`);
                      setManagingSchedule(null);
                      setAvailDraft(null);
                      showToast(`Availability saved for ${managingSchedule.name}`);
                    };

                    // Build months and auto-select all by default
                    const months = [...new Set(CAMP_DATES.map(d => {
                      const date = new Date(d + 'T12:00:00');
                      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    }))];
                    if (scheduleMonths.length === 0 && months.length > 0) {
                      setTimeout(() => setScheduleMonths([...months]), 0);
                    }

                    // Get dates for selected months
                    const getModalDates = () => CAMP_DATES.filter(d => {
                      const date = new Date(d + 'T12:00:00');
                      const mk = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                      return scheduleMonths.includes(mk);
                    });

                    // Group dates into weeks (Mon-Fri rows)
                    const groupIntoWeeks = (dates) => {
                      const weeks = [];
                      let currentWeek = [];
                      dates.forEach(d => {
                        const dn = new Date(d + 'T12:00:00');
                        if (currentWeek.length > 0 && dn.getDay() === 1) {
                          weeks.push(currentWeek);
                          currentWeek = [];
                        }
                        currentWeek.push(d);
                      });
                      if (currentWeek.length > 0) weeks.push(currentWeek);
                      return weeks;
                    };

                    // Button styles matching Work Availability tab
                    const btnStyle = (state, blocked) => blocked ? 'bg-gray-100 text-gray-400 cursor-not-allowed' :
                      state === 'available' ? 'bg-green-500 text-white hover:bg-green-600' :
                      state === 'unavailable' ? 'bg-red-500 text-white hover:bg-red-600' :
                      'bg-white border text-gray-600 hover:bg-gray-50';
                    const btnIcon = (state, blocked) => blocked ? ' üö´' : state === 'available' ? ' ‚úì' : state === 'unavailable' ? ' ‚úó' : '';

                    return (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                      <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="bg-green-600 text-white px-6 py-4">
                          <h2 className="font-display text-xl">Edit Availability</h2>
                          <p className="text-green-200 text-sm">{managingSchedule.name}</p>
                        </div>
                        <div className="p-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                          {/* Month selector (multi-select, both default) */}
                          <div className="flex gap-2 mb-4">
                            {months.map(m => {
                              const [yr, mo] = m.split('-');
                              const label = new Date(yr, mo - 1).toLocaleDateString('en-US', { month: 'long' });
                              const isActive = scheduleMonths.includes(m);
                              return (
                                <button key={m} onClick={() => setScheduleMonths(prev => prev.includes(m) ? prev.filter(x => x !== m) : [...prev, m].sort())}
                                  className={'px-4 py-2 rounded-lg font-medium ' + (isActive ? 'bg-green-600 text-white' : 'bg-white border border-green-600 text-green-700 hover:bg-green-50')}>
                                  {label}
                                </button>
                              );
                            })}
                          </div>

                          {/* Card grid ‚Äî grouped by week, 5 columns (Mon-Fri) */}
                          {getModalDates().length === 0 ? (
                            <div className="text-center text-gray-500 py-6">Select a month above to view availability.</div>
                          ) : groupIntoWeeks(getModalDates()).map((week, wi) => {
                            const firstDate = new Date(week[0] + 'T12:00:00');
                            const weekLabel = `Week of ${firstDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                            return (
                              <div key={wi} className="mb-4">
                                <div className="text-xs font-medium text-gray-500 mb-1.5">{weekLabel}</div>
                                <div className="grid grid-cols-5 gap-2">
                                  {week.map(d => {
                                    const amBlocked = isSessionBlocked(d, 'morning');
                                    const pmBlocked = isSessionBlocked(d, 'afternoon');
                                    const fullyBlocked = amBlocked && pmBlocked;
                                    const amState = getDraftState(d, 'morning');
                                    const pmState = getDraftState(d, 'afternoon');
                                    const bothAvail = amState === 'available' && pmState === 'available';
                                    const bothUnavail = amState === 'unavailable' && pmState === 'unavailable';
                                    const anyAvail = amState === 'available' || pmState === 'available';
                                    const anyUnavail = amState === 'unavailable' || pmState === 'unavailable';

                                    const cardBorder = fullyBlocked ? 'border-gray-200 bg-gray-50' :
                                      bothAvail ? 'border-green-300 bg-green-50' :
                                      bothUnavail ? 'border-red-300 bg-red-50' :
                                      (anyAvail || anyUnavail) ? 'border-yellow-300 bg-yellow-50' :
                                      'border-gray-200 bg-white';

                                    const headerBg = fullyBlocked ? 'bg-gray-200 cursor-not-allowed' :
                                      bothAvail ? 'bg-green-200 hover:bg-green-300' :
                                      bothUnavail ? 'bg-red-200 hover:bg-red-300' :
                                      (anyAvail || anyUnavail) ? 'bg-yellow-200 hover:bg-yellow-300' :
                                      'bg-gray-100 hover:bg-gray-200';

                                    const dn = new Date(d + 'T12:00:00');

                                    return (
                                      <div key={d} className={'rounded-lg border-2 overflow-hidden transition-shadow hover:shadow-md ' + cardBorder}>
                                        <button onClick={() => !fullyBlocked && toggleDraftDay(d)} disabled={fullyBlocked}
                                          className={'w-full p-2 text-center font-bold transition-colors ' + headerBg}>
                                          <div className="text-xs text-gray-600">{['Mon','Tue','Wed','Thu','Fri'][dn.getDay() - 1]}</div>
                                          <div className="text-sm">{dn.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                                        </button>
                                        {fullyBlocked ? (
                                          <div className="p-2 text-center text-xs text-red-500">üö´ Blocked</div>
                                        ) : (
                                          <div className="p-2 space-y-1">
                                            <button onClick={() => !amBlocked && toggleDraftSession(d, 'morning')} disabled={amBlocked}
                                              className={'w-full p-1.5 rounded text-xs font-medium text-center transition-colors ' + btnStyle(amState, amBlocked)}>
                                              ‚òÄÔ∏è AM{btnIcon(amState, amBlocked)}
                                            </button>
                                            <button onClick={() => !pmBlocked && toggleDraftSession(d, 'afternoon')} disabled={pmBlocked}
                                              className={'w-full p-1.5 rounded text-xs font-medium text-center transition-colors ' + btnStyle(pmState, pmBlocked)}>
                                              üåô PM{btnIcon(pmState, pmBlocked)}
                                            </button>
                                          </div>
                                        )}
                                      </div>
                                    );
                                  })}
                                </div>
                              </div>
                            );
                          })}

                          <div className="mt-2 flex flex-wrap gap-4 justify-center text-sm text-gray-600">
                            <div className="flex items-center gap-1"><div className="w-3 h-3 bg-green-500 rounded-full" /><span>Available</span></div>
                            <div className="flex items-center gap-1"><div className="w-3 h-3 bg-red-500 rounded-full" /><span>Unavailable</span></div>
                            <div className="flex items-center gap-1"><div className="w-3 h-3 bg-gray-200 rounded-full border" /><span>Not Set</span></div>
                            <div className="flex items-center gap-1"><span>üö´</span><span>Blocked</span></div>
                          </div>
                        </div>
                        <div className="p-4 border-t flex gap-3">
                          <button onClick={() => { setManagingSchedule(null); setAvailDraft(null); }}
                            className="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium">
                            Cancel
                          </button>
                          <button onClick={handleSaveAvailability}
                            className="flex-1 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                            Save
                          </button>
                        </div>
                      </div>
                    </div>
                    );
                  })()}
                </div>
              )}

              {/* ===== COUNSELOR APPLICATIONS TAB ===== */}
              {adminParentTab === 'counselor' && getActiveChildTab('counselor') === 'applications' && (() => {
                const pending = counselors.filter(c => c.approvedByAdmin === false || c.visible === false);
                const approved = counselors.filter(c => c.visible !== false && c.approvedByAdmin !== false);
                return (
                <div>
                  <div className="mb-4">
                    <h2 className="font-bold text-xl">Counselor Applications</h2>
                    <p className="text-sm text-gray-500">Review and approve counselor registrations</p>
                  </div>

                  {pending.length === 0 ? (
                    <div className="text-center py-12 bg-white rounded-xl shadow">
                      <div className="text-4xl mb-3">‚úì</div>
                      <p className="text-gray-600 font-medium">No pending applications</p>
                      <p className="text-sm text-gray-400 mt-1">All counselor applications have been reviewed</p>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      <div className="bg-amber-50 border border-amber-200 rounded-lg px-4 py-2 text-sm text-amber-700 font-medium">
                        {pending.length} pending application{pending.length !== 1 ? 's' : ''} to review
                      </div>
                      {pending.map(c => (
                        <div key={c.id} className="bg-white rounded-xl shadow p-4 border-l-4 border-amber-400">
                          <div className="flex items-center gap-4">
                            {getDisplayPhoto(c.photo) ? (
                              <img src={getDisplayPhoto(c.photo)} className="w-14 h-14 rounded-full object-cover" />
                            ) : (
                              <div className="w-14 h-14 rounded-full bg-gray-200 flex items-center justify-center text-gray-400 text-xl font-bold">
                                {c.name?.charAt(0)}
                              </div>
                            )}
                            <div className="flex-1">
                              <div className="font-bold text-lg">{c.name}</div>
                              <div className="text-sm text-gray-600">{c.position} {c.year ? '‚Ä¢ ' + c.year : ''}</div>
                              <div className="text-sm text-gray-500">{c.email}</div>
                              {c.phone && <div className="text-sm text-gray-500">{c.phone}</div>}
                              {c.bio && <div className="text-sm text-gray-600 mt-1 italic">"{c.bio}"</div>}
                              {c.createdAt && <div className="text-xs text-gray-400 mt-1">Applied: {new Date(c.createdAt).toLocaleDateString()}</div>}
                            </div>
                            <div className="flex flex-col gap-2">
                              <button
                                onClick={async () => {
                                  const updated = counselors.map(co =>
                                    co.id === c.id ? { ...co, visible: true, approvedByAdmin: true } : co
                                  );
                                  await saveCounselors(updated, 'Approved ' + c.name + ' as counselor');
                                }}
                                className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-colors"
                              >
                                Approve
                              </button>
                              <button
                                onClick={async () => {
                                  if (!confirm('Reject and remove ' + c.name + '? This will delete their application.')) return;
                                  await deleteCounselor(c.id, c.name);
                                }}
                                className="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg font-medium text-sm transition-colors"
                              >
                                Reject
                              </button>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}

                  {approved.length > 0 && (
                    <div className="mt-6">
                      <h3 className="font-bold text-gray-600 mb-2">Previously Approved ({approved.length})</h3>
                      <div className="bg-white rounded-xl shadow divide-y">
                        {approved.map(c => (
                          <div key={c.id} className="flex items-center gap-3 px-4 py-3">
                            {getDisplayPhoto(c.photo) ? (
                              <img src={getDisplayPhoto(c.photo)} className="w-8 h-8 rounded-full object-cover" />
                            ) : (
                              <div className="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-700 text-sm font-bold">
                                {c.name?.charAt(0)}
                              </div>
                            )}
                            <div className="flex-1">
                              <span className="font-medium">{c.name}</span>
                              <span className="text-sm text-gray-500 ml-2">{c.position}</span>
                            </div>
                            <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-medium">Approved</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              );
              })()}

              {/* ===== WORK AVAILABILITY TAB ===== */}
              {adminParentTab === 'counselor' && getActiveChildTab('counselor') === 'availability' && (
                <div className="space-y-6">
                  {(() => {
                    // Build month list and auto-select all
                    const months = [...new Set(CAMP_DATES.map(d => {
                      const date = new Date(d + 'T12:00:00');
                      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    }))];
                    if (availCalMonths.length === 0 && months.length > 0) {
                      setTimeout(() => setAvailCalMonths([...months]), 0);
                    }
                    const visibleCounselors = counselors.filter(c => !availCalHidden[c.id]);
                    const allShown = counselors.length > 0 && visibleCounselors.length === counselors.length;
                    const noneShown = visibleCounselors.length === 0;

                    // Get availability state for a counselor on a date/session
                    const getAvailState = (c, date, session) => {
                      const counselorAvail = availability[c.email] || {};
                      const dateAvail = counselorAvail[date] || {};
                      const availSessions = Array.isArray(dateAvail) ? dateAvail : (dateAvail.available || []);
                      const unavailSessions = Array.isArray(dateAvail) ? [] : (dateAvail.unavailable || []);
                      if (availSessions.includes(session)) return 'available';
                      if (unavailSessions.includes(session)) return 'unavailable';
                      return 'not-set';
                    };

                    // All dates for selected months (unfiltered, for date pill display)
                    const allMonthDates = CAMP_DATES.filter(d => {
                      const date = new Date(d + 'T12:00:00');
                      const mk = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                      return availCalMonths.includes(mk);
                    });
                    // Weeks available for selected months
                    const availableWeeks = CAMP_WEEKS.filter(w => {
                      const d = new Date(w.start + 'T12:00:00');
                      const mk = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                      return availCalMonths.includes(mk);
                    });
                    const availableWeekStarts = availableWeeks.map(w => w.start);
                    // Auto-initialize weeks and dates on first load only (null = not yet initialized, [] = user cleared all)
                    if (availCalWeeks === null && availableWeekStarts.length > 0) {
                      setTimeout(() => setAvailCalWeeks([...availableWeekStarts]), 0);
                    }
                    const safeAvailWeeks = availCalWeeks || [];
                    // Dates filtered by week selection (for date pills)
                    const weekFilteredDates = allMonthDates.filter(d => {
                      const week = CAMP_WEEKS.find(w => w.dates.includes(d));
                      return !week || safeAvailWeeks.length === 0 || safeAvailWeeks.includes(week.start);
                    });
                    if (availCalDates === null && weekFilteredDates.length > 0) {
                      setTimeout(() => setAvailCalDates([...weekFilteredDates]), 0);
                    }
                    const safeAvailDates = availCalDates || [];

                    // Final filtered dates
                    const getSelectedDates = () => {
                      return weekFilteredDates.filter(d => safeAvailDates.includes(d));
                    };

                    // Counselor name helper
                    const getName = (c) => c.firstName || c.name?.split(' ')[0] || '?';

                    return (
                      <>
                        {/* Counselor filter chips */}
                        <div className="bg-white rounded-xl shadow p-4">
                          <div className="flex items-center gap-2 mb-3">
                            <span className="text-sm font-medium text-gray-700">Show counselors:</span>
                            <button onClick={() => setAvailCalHidden({})} className={'px-2 py-0.5 rounded text-xs font-medium ' + (allShown ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')}>All</button>
                            <button onClick={() => { const h = {}; counselors.forEach(c => h[c.id] = true); setAvailCalHidden(h); }} className={'px-2 py-0.5 rounded text-xs font-medium ' + (noneShown ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')}>None</button>
                          </div>
                          <div className="flex gap-2 flex-wrap">
                            {counselors.map(c => {
                              const isShown = !availCalHidden[c.id];
                              return (
                                <button key={c.id} onClick={() => setAvailCalHidden(prev => ({ ...prev, [c.id]: !prev[c.id] }))}
                                  className={`px-3 py-1.5 rounded-full text-sm font-medium transition border ${isShown ? 'bg-green-100 text-green-700 border-green-300' : 'bg-gray-100 text-gray-500 border-gray-300'}`}>
                                  {isShown ? '‚úì ' : ''}{getName(c)}
                                </button>
                              );
                            })}
                          </div>
                        </div>

                        {/* Month tabs (multi-select) */}
                        <div className="flex flex-wrap gap-2">
                          {months.map(m => {
                            const [yr, mo] = m.split('-');
                            const label = new Date(yr, mo - 1).toLocaleDateString('en-US', { month: 'long' });
                            const isActive = availCalMonths.includes(m);
                            return (
                              <button key={m} onClick={() => setAvailCalMonths(prev => prev.includes(m) ? prev.filter(x => x !== m) : [...prev, m].sort())}
                                className={'px-6 py-2 rounded-lg font-medium ' + (isActive ? 'bg-green-600 text-white' : 'bg-white border border-green-600 text-green-700')}>
                                {label}
                              </button>
                            );
                          })}
                        </div>

                        {/* Week / Date / Session filters */}
                        <div className="bg-white rounded-xl shadow p-4 space-y-3">
                          <div className="flex items-center gap-2 flex-wrap">
                            <span className="text-sm font-medium text-gray-700 w-14">Weeks:</span>
                            <button onClick={() => { setAvailCalWeeks([...availableWeekStarts]); setAvailCalDates([...allMonthDates]); }} className={'px-2 py-0.5 rounded text-xs font-medium ' + (safeAvailWeeks.length === availableWeekStarts.length ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')}>All</button>
                            <button onClick={() => { setAvailCalWeeks([]); setAvailCalDates([]); }} className={'px-2 py-0.5 rounded text-xs font-medium ' + (safeAvailWeeks.length === 0 ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')}>None</button>
                            {availableWeeks.map(w => {
                              const wd = new Date(w.start + 'T12:00:00');
                              const label = wd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                              const isActive = safeAvailWeeks.includes(w.start);
                              return (
                                <button key={w.start} onClick={() => {
                                  const newWeeks = isActive ? safeAvailWeeks.filter(x => x !== w.start) : [...safeAvailWeeks, w.start].sort();
                                  setAvailCalWeeks(newWeeks);
                                  if (isActive) {
                                    setAvailCalDates(prev => (prev || []).filter(d => !w.dates.includes(d)));
                                  } else {
                                    setAvailCalDates(prev => [...new Set([...(prev || []), ...w.dates])].sort());
                                  }
                                }}
                                  className={`px-3 py-1 rounded-lg text-xs font-medium transition border ${isActive ? 'bg-green-100 text-green-700 border-green-300' : 'bg-gray-100 text-gray-500 border-gray-200'}`}>
                                  {label}
                                </button>
                              );
                            })}
                          </div>
                          <div className="flex items-center gap-2 flex-wrap">
                            <span className="text-sm font-medium text-gray-700 w-14">Dates:</span>
                            <button onClick={() => setAvailCalDates([...weekFilteredDates])} className={'px-2 py-0.5 rounded text-xs font-medium ' + (safeAvailDates.length === weekFilteredDates.length ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')}>All</button>
                            <button onClick={() => setAvailCalDates([])} className={'px-2 py-0.5 rounded text-xs font-medium ' + (safeAvailDates.length === 0 ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')}>None</button>
                            {weekFilteredDates.map(d => {
                              const dt = new Date(d + 'T12:00:00');
                              const dayName = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()];
                              const label = `${dayName} ${dt.getMonth() + 1}/${dt.getDate()}`;
                              const isActive = safeAvailDates.includes(d);
                              return (
                                <button key={d} onClick={() => setAvailCalDates(prev => (prev || []).includes(d) ? (prev || []).filter(x => x !== d) : [...(prev || []), d].sort())}
                                  className={`px-2 py-1 rounded-lg text-xs font-medium transition border ${isActive ? 'bg-green-100 text-green-700 border-green-300' : 'bg-gray-100 text-gray-500 border-gray-200'}`}>
                                  {label}
                                </button>
                              );
                            })}
                          </div>
                          <div className="flex items-center gap-2 flex-wrap">
                            <span className="text-sm font-medium text-gray-700 w-14">Session:</span>
                            {[{key: 'both', label: 'Both'}, {key: 'morning', label: 'AM Only'}, {key: 'afternoon', label: 'PM Only'}].map(({key, label}) => (
                              <button key={key} onClick={() => setAvailCalSession(key)}
                                className={`px-3 py-1 rounded-lg text-xs font-medium transition border ${availCalSession === key ? 'bg-green-600 text-white border-green-600' : 'bg-gray-100 text-gray-500 border-gray-200'}`}>
                                {label}
                              </button>
                            ))}
                          </div>
                        </div>

                        {/* Responsive card grid */}
                        {getSelectedDates().length === 0 ? (
                          <div className="bg-white rounded-xl shadow p-6 text-center text-gray-500">Select a month above to view availability.</div>
                        ) : (
                          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                            {getSelectedDates().map(date => {
                              const d = new Date(date + 'T12:00:00');
                              const amBlocked = isSessionBlocked(date, 'morning');
                              const pmBlocked = isSessionBlocked(date, 'afternoon');
                              const fullyBlocked = amBlocked && pmBlocked;

                              // Compute states for all visible counselors
                              const amStates = visibleCounselors.map(c => ({ c, state: getAvailState(c, date, 'morning') }));
                              const pmStates = visibleCounselors.map(c => ({ c, state: getAvailState(c, date, 'afternoon') }));
                              const allAmAvail = amStates.length > 0 && amStates.every(s => s.state === 'available');
                              const allPmAvail = pmStates.length > 0 && pmStates.every(s => s.state === 'available');
                              const allAmUnavail = amStates.length > 0 && amStates.every(s => s.state === 'unavailable');
                              const allPmUnavail = pmStates.length > 0 && pmStates.every(s => s.state === 'unavailable');
                              const anyAvail = amStates.some(s => s.state === 'available') || pmStates.some(s => s.state === 'available');

                              const cardBorder = fullyBlocked ? 'border-gray-200 bg-gray-50' :
                                (allAmAvail && allPmAvail) ? 'border-green-300 bg-green-50' :
                                (allAmUnavail && allPmUnavail) ? 'border-red-300 bg-red-50' :
                                anyAvail ? 'border-yellow-300 bg-yellow-50' :
                                'border-gray-200 bg-white';

                              // Pill color for availability
                              const pillBg = (state) => state === 'available' ? 'bg-green-500 text-white' : state === 'unavailable' ? 'bg-red-400 text-white' : 'bg-gray-200 text-gray-500';

                              // Single counselor button style
                              const singleBtn = (state, blocked) => blocked ? 'bg-gray-100 text-gray-400' :
                                state === 'available' ? 'bg-green-500 text-white' :
                                state === 'unavailable' ? 'bg-red-500 text-white' :
                                'bg-white border text-gray-600';
                              const singleIcon = (state, blocked) => blocked ? ' üö´' : state === 'available' ? ' ‚úì' : state === 'unavailable' ? ' ‚úó' : '';

                              return (
                                <div key={date} className={'rounded-lg border-2 overflow-hidden transition-shadow hover:shadow-md ' + cardBorder}>
                                  <div className="p-2 text-center font-medium bg-gray-100">
                                    <div className="text-xs text-gray-500">{['Mon', 'Tue', 'Wed', 'Thu', 'Fri'][d.getDay() - 1]}</div>
                                    <div className="text-sm">{d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                                  </div>
                                  {fullyBlocked ? (
                                    <div className="p-2 text-center text-xs text-red-500">üö´ Blocked</div>
                                  ) : visibleCounselors.length === 0 ? (
                                    <div className="p-2 space-y-1">
                                      {(availCalSession === 'both' || availCalSession === 'morning') && <div className="w-full p-1.5 rounded text-xs bg-gray-100 text-gray-400 text-center">AM</div>}
                                      {(availCalSession === 'both' || availCalSession === 'afternoon') && <div className="w-full p-1.5 rounded text-xs bg-gray-100 text-gray-400 text-center">PM</div>}
                                    </div>
                                  ) : visibleCounselors.length === 1 ? (
                                    <div className="p-2 space-y-1">
                                      {(availCalSession === 'both' || availCalSession === 'morning') && <div className={'w-full p-1.5 rounded text-xs font-medium text-center ' + singleBtn(amStates[0]?.state, amBlocked)}>
                                        {getName(visibleCounselors[0])}{singleIcon(amStates[0]?.state, amBlocked)}
                                      </div>}
                                      {(availCalSession === 'both' || availCalSession === 'afternoon') && <div className={'w-full p-1.5 rounded text-xs font-medium text-center ' + singleBtn(pmStates[0]?.state, pmBlocked)}>
                                        {getName(visibleCounselors[0])}{singleIcon(pmStates[0]?.state, pmBlocked)}
                                      </div>}
                                    </div>
                                  ) : (() => {
                                    const cols = Math.min(visibleCounselors.length, 5);
                                    const showAm = availCalSession === 'both' || availCalSession === 'morning';
                                    const showPm = availCalSession === 'both' || availCalSession === 'afternoon';
                                    return (
                                    <div className="p-1.5 space-y-0">
                                      {showAm && (amBlocked ? (
                                        <div className="p-1 rounded text-xs bg-gray-100 text-gray-400 text-center">üö´</div>
                                      ) : (
                                        <div>
                                          <div className="text-center mb-0.5" style={{fontSize: '9px', fontWeight: 600, color: '#d97706', letterSpacing: '0.05em'}}>‚òÄÔ∏è AM</div>
                                          <div style={{display: 'grid', gridTemplateColumns: `repeat(${cols}, 1fr)`, gap: '2px'}}>
                                            {amStates.map(({ c, state }) => (
                                              <span key={c.id} className={'block py-0.5 rounded-full text-center font-medium truncate ' + pillBg(state)}
                                                style={{fontSize: '10px'}}
                                                title={`${getName(c)} ‚Äî ${state}`}>
                                                {getName(c)}
                                              </span>
                                            ))}
                                          </div>
                                        </div>
                                      ))}
                                      {showAm && showPm && <div style={{borderTop: '1px solid #e5e7eb', margin: '3px 0'}} />}
                                      {showPm && (pmBlocked ? (
                                        <div className="p-1 rounded text-xs bg-gray-100 text-gray-400 text-center">üö´</div>
                                      ) : (
                                        <div>
                                          <div className="text-center mb-0.5" style={{fontSize: '9px', fontWeight: 600, color: '#4f46e5', letterSpacing: '0.05em'}}>üåô PM</div>
                                          <div style={{display: 'grid', gridTemplateColumns: `repeat(${cols}, 1fr)`, gap: '2px'}}>
                                            {pmStates.map(({ c, state }) => (
                                              <span key={c.id} className={'block py-0.5 rounded-full text-center font-medium truncate ' + pillBg(state)}
                                                style={{fontSize: '10px'}}
                                                title={`${getName(c)} ‚Äî ${state}`}>
                                                {getName(c)}
                                              </span>
                                            ))}
                                          </div>
                                        </div>
                                      ))}
                                    </div>
                                    );
                                  })()}
                                </div>
                              );
                            })}
                          </div>
                        )}

                        {/* Legend */}
                        <div className="bg-white rounded-xl shadow p-4 flex flex-wrap gap-4 justify-center text-sm">
                          <div className="flex items-center gap-2"><div className="w-4 h-4 bg-green-500 rounded-full" /><span>Available</span></div>
                          <div className="flex items-center gap-2"><div className="w-4 h-4 bg-red-400 rounded-full" /><span>Unavailable</span></div>
                          <div className="flex items-center gap-2"><div className="w-4 h-4 bg-gray-200 rounded-full" /><span>Not Set</span></div>
                          <div className="flex items-center gap-2"><span>üö´</span><span>Session Blocked</span></div>
                        </div>
                      </>
                    );
                  })()}
                </div>
              )}

              {/* ===== WORK SCHEDULE TAB ===== */}
              {adminParentTab === 'counselor' && getActiveChildTab('counselor') === 'workschedule' && (
                <div className="space-y-6">
                  {(() => {
                    // Build month list and auto-select all
                    const months = [...new Set(CAMP_DATES.map(d => {
                      const date = new Date(d + 'T12:00:00');
                      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    }))];
                    if (schedCalMonths.length === 0 && months.length > 0) {
                      setTimeout(() => setSchedCalMonths([...months]), 0);
                    }
                    const visibleCounselors = counselors.filter(c => !schedCalHidden[c.id]);
                    const allShown = counselors.length > 0 && visibleCounselors.length === counselors.length;
                    const noneShown = visibleCounselors.length === 0;

                    // Get assigned camper count for a counselor on a date/session
                    const getAssignedCount = (c, date, session) => {
                      const key = `${date}_${session}`;
                      return ((assignments[key] || {})[c.id] || []).length;
                    };

                    // All dates for selected months (unfiltered)
                    const allMonthDates = CAMP_DATES.filter(d => {
                      const date = new Date(d + 'T12:00:00');
                      const mk = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                      return schedCalMonths.includes(mk);
                    });
                    // Weeks available for selected months
                    const availableWeeks = CAMP_WEEKS.filter(w => {
                      const d = new Date(w.start + 'T12:00:00');
                      const mk = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                      return schedCalMonths.includes(mk);
                    });
                    const availableWeekStarts = availableWeeks.map(w => w.start);
                    if (schedCalWeeks === null && availableWeekStarts.length > 0) {
                      setTimeout(() => setSchedCalWeeks([...availableWeekStarts]), 0);
                    }
                    const safeSchedWeeks = schedCalWeeks || [];
                    const weekFilteredDates = allMonthDates.filter(d => {
                      const week = CAMP_WEEKS.find(w => w.dates.includes(d));
                      return !week || safeSchedWeeks.length === 0 || safeSchedWeeks.includes(week.start);
                    });
                    if (schedCalDates === null && weekFilteredDates.length > 0) {
                      setTimeout(() => setSchedCalDates([...weekFilteredDates]), 0);
                    }
                    const safeSchedDates = schedCalDates || [];

                    // Final filtered dates
                    const getSelectedDates = () => {
                      return weekFilteredDates.filter(d => safeSchedDates.includes(d));
                    };

                    // Counselor name helper
                    const getName = (c) => c.firstName || c.name?.split(' ')[0] || '?';

                    return (
                      <>
                        {/* Counselor filter chips */}
                        <div className="bg-white rounded-xl shadow p-4">
                          <div className="flex items-center gap-2 mb-3">
                            <span className="text-sm font-medium text-gray-700">Show counselors:</span>
                            <button onClick={() => setSchedCalHidden({})} className={'px-2 py-0.5 rounded text-xs font-medium ' + (allShown ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')}>All</button>
                            <button onClick={() => { const h = {}; counselors.forEach(c => h[c.id] = true); setSchedCalHidden(h); }} className={'px-2 py-0.5 rounded text-xs font-medium ' + (noneShown ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')}>None</button>
                          </div>
                          <div className="flex gap-2 flex-wrap">
                            {counselors.map(c => {
                              const isShown = !schedCalHidden[c.id];
                              return (
                                <button key={c.id} onClick={() => setSchedCalHidden(prev => ({ ...prev, [c.id]: !prev[c.id] }))}
                                  className={`px-3 py-1.5 rounded-full text-sm font-medium transition border ${isShown ? 'bg-green-100 text-green-700 border-green-300' : 'bg-gray-100 text-gray-500 border-gray-300'}`}>
                                  {isShown ? '‚úì ' : ''}{getName(c)}
                                </button>
                              );
                            })}
                          </div>
                        </div>

                        {/* Month tabs (multi-select) */}
                        <div className="flex flex-wrap gap-2">
                          {months.map(m => {
                            const [yr, mo] = m.split('-');
                            const label = new Date(yr, mo - 1).toLocaleDateString('en-US', { month: 'long' });
                            const isActive = schedCalMonths.includes(m);
                            return (
                              <button key={m} onClick={() => setSchedCalMonths(prev => prev.includes(m) ? prev.filter(x => x !== m) : [...prev, m].sort())}
                                className={'px-6 py-2 rounded-lg font-medium ' + (isActive ? 'bg-green-600 text-white' : 'bg-white border border-green-600 text-green-700')}>
                                {label}
                              </button>
                            );
                          })}
                        </div>

                        {/* Week / Date / Session filters */}
                        <div className="bg-white rounded-xl shadow p-4 space-y-3">
                          <div className="flex items-center gap-2 flex-wrap">
                            <span className="text-sm font-medium text-gray-700 w-14">Weeks:</span>
                            <button onClick={() => { setSchedCalWeeks([...availableWeekStarts]); setSchedCalDates([...allMonthDates]); }} className={'px-2 py-0.5 rounded text-xs font-medium ' + (safeSchedWeeks.length === availableWeekStarts.length ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')}>All</button>
                            <button onClick={() => { setSchedCalWeeks([]); setSchedCalDates([]); }} className={'px-2 py-0.5 rounded text-xs font-medium ' + (safeSchedWeeks.length === 0 ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')}>None</button>
                            {availableWeeks.map(w => {
                              const wd = new Date(w.start + 'T12:00:00');
                              const label = wd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                              const isActive = safeSchedWeeks.includes(w.start);
                              return (
                                <button key={w.start} onClick={() => {
                                  const newWeeks = isActive ? safeSchedWeeks.filter(x => x !== w.start) : [...safeSchedWeeks, w.start].sort();
                                  setSchedCalWeeks(newWeeks);
                                  if (isActive) {
                                    setSchedCalDates(prev => (prev || []).filter(d => !w.dates.includes(d)));
                                  } else {
                                    setSchedCalDates(prev => [...new Set([...(prev || []), ...w.dates])].sort());
                                  }
                                }}
                                  className={`px-3 py-1 rounded-lg text-xs font-medium transition border ${isActive ? 'bg-green-100 text-green-700 border-green-300' : 'bg-gray-100 text-gray-500 border-gray-200'}`}>
                                  {label}
                                </button>
                              );
                            })}
                          </div>
                          <div className="flex items-center gap-2 flex-wrap">
                            <span className="text-sm font-medium text-gray-700 w-14">Dates:</span>
                            <button onClick={() => setSchedCalDates([...weekFilteredDates])} className={'px-2 py-0.5 rounded text-xs font-medium ' + (safeSchedDates.length === weekFilteredDates.length ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')}>All</button>
                            <button onClick={() => setSchedCalDates([])} className={'px-2 py-0.5 rounded text-xs font-medium ' + (safeSchedDates.length === 0 ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200')}>None</button>
                            {weekFilteredDates.map(d => {
                              const dt = new Date(d + 'T12:00:00');
                              const dayName = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()];
                              const label = `${dayName} ${dt.getMonth() + 1}/${dt.getDate()}`;
                              const isActive = safeSchedDates.includes(d);
                              return (
                                <button key={d} onClick={() => setSchedCalDates(prev => (prev || []).includes(d) ? (prev || []).filter(x => x !== d) : [...(prev || []), d].sort())}
                                  className={`px-2 py-1 rounded-lg text-xs font-medium transition border ${isActive ? 'bg-green-100 text-green-700 border-green-300' : 'bg-gray-100 text-gray-500 border-gray-200'}`}>
                                  {label}
                                </button>
                              );
                            })}
                          </div>
                          <div className="flex items-center gap-2 flex-wrap">
                            <span className="text-sm font-medium text-gray-700 w-14">Session:</span>
                            {[{key: 'both', label: 'Both'}, {key: 'morning', label: 'AM Only'}, {key: 'afternoon', label: 'PM Only'}].map(({key, label}) => (
                              <button key={key} onClick={() => setSchedCalSession(key)}
                                className={`px-3 py-1 rounded-lg text-xs font-medium transition border ${schedCalSession === key ? 'bg-green-600 text-white border-green-600' : 'bg-gray-100 text-gray-500 border-gray-200'}`}>
                                {label}
                              </button>
                            ))}
                          </div>
                        </div>

                        {/* Responsive card grid */}
                        {getSelectedDates().length === 0 ? (
                          <div className="bg-white rounded-xl shadow p-6 text-center text-gray-500">Select a month above to view schedule.</div>
                        ) : (
                          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                            {getSelectedDates().map(date => {
                              const d = new Date(date + 'T12:00:00');

                              // Compute counts for visible counselors
                              const amCounts = visibleCounselors.map(c => ({ c, count: getAssignedCount(c, date, 'morning') }));
                              const pmCounts = visibleCounselors.map(c => ({ c, count: getAssignedCount(c, date, 'afternoon') }));
                              const anyAmAssigned = amCounts.some(s => s.count > 0);
                              const anyPmAssigned = pmCounts.some(s => s.count > 0);
                              const anyAssigned = anyAmAssigned || anyPmAssigned;

                              const cardBorder = (anyAmAssigned && anyPmAssigned) ? 'border-green-300 bg-green-50' :
                                anyAssigned ? 'border-yellow-300 bg-yellow-50' :
                                'border-gray-200 bg-white';

                              return (
                                <div key={date} className={'rounded-lg border-2 overflow-hidden transition-shadow hover:shadow-md ' + cardBorder}>
                                  <div className="p-2 text-center font-medium bg-gray-100">
                                    <div className="text-xs text-gray-500">{['Mon', 'Tue', 'Wed', 'Thu', 'Fri'][d.getDay() - 1]}</div>
                                    <div className="text-sm">{d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                                  </div>
                                  {visibleCounselors.length === 0 ? (
                                    <div className="p-2 space-y-1">
                                      {(schedCalSession === 'both' || schedCalSession === 'morning') && <div className="w-full p-1.5 rounded text-xs bg-gray-100 text-gray-400 text-center">AM</div>}
                                      {(schedCalSession === 'both' || schedCalSession === 'afternoon') && <div className="w-full p-1.5 rounded text-xs bg-gray-100 text-gray-400 text-center">PM</div>}
                                    </div>
                                  ) : visibleCounselors.length === 1 ? (
                                    <div className="p-2 space-y-1">
                                      {(schedCalSession === 'both' || schedCalSession === 'morning') && (amCounts[0]?.count > 0 ? (
                                        <div className="w-full p-1.5 rounded text-xs font-medium text-center bg-green-500 text-white">
                                          {getName(visibleCounselors[0])} ¬∑ {amCounts[0].count}
                                        </div>
                                      ) : (
                                        <div className="w-full p-1.5 rounded text-xs bg-gray-100 text-gray-400 text-center">{getName(visibleCounselors[0])}</div>
                                      ))}
                                      {(schedCalSession === 'both' || schedCalSession === 'afternoon') && (pmCounts[0]?.count > 0 ? (
                                        <div className="w-full p-1.5 rounded text-xs font-medium text-center bg-green-500 text-white">
                                          {getName(visibleCounselors[0])} ¬∑ {pmCounts[0].count}
                                        </div>
                                      ) : (
                                        <div className="w-full p-1.5 rounded text-xs bg-gray-100 text-gray-400 text-center">{getName(visibleCounselors[0])}</div>
                                      ))}
                                    </div>
                                  ) : (() => {
                                    const cols = Math.min(visibleCounselors.length, 5);
                                    const showAm = schedCalSession === 'both' || schedCalSession === 'morning';
                                    const showPm = schedCalSession === 'both' || schedCalSession === 'afternoon';
                                    return (
                                    <div className="p-1.5 space-y-0">
                                      {showAm && <div>
                                        <div className="text-center mb-0.5" style={{fontSize: '9px', fontWeight: 600, color: '#d97706', letterSpacing: '0.05em'}}>‚òÄÔ∏è AM</div>
                                        <div style={{display: 'grid', gridTemplateColumns: `repeat(${cols}, 1fr)`, gap: '2px'}}>
                                          {amCounts.map(({ c, count }) => (
                                            <span key={c.id} className={'block py-0.5 rounded-full text-center font-medium truncate ' + (count > 0 ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-500')}
                                              style={{fontSize: '10px'}}
                                              title={`${getName(c)} ‚Äî ${count > 0 ? count + ' campers' : 'not assigned'}`}>
                                              {getName(c)}
                                            </span>
                                          ))}
                                        </div>
                                      </div>}
                                      {showAm && showPm && <div style={{borderTop: '1px solid #e5e7eb', margin: '3px 0'}} />}
                                      {showPm && <div>
                                        <div className="text-center mb-0.5" style={{fontSize: '9px', fontWeight: 600, color: '#4f46e5', letterSpacing: '0.05em'}}>üåô PM</div>
                                        <div style={{display: 'grid', gridTemplateColumns: `repeat(${cols}, 1fr)`, gap: '2px'}}>
                                          {pmCounts.map(({ c, count }) => (
                                            <span key={c.id} className={'block py-0.5 rounded-full text-center font-medium truncate ' + (count > 0 ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-500')}
                                              style={{fontSize: '10px'}}
                                              title={`${getName(c)} ‚Äî ${count > 0 ? count + ' campers' : 'not assigned'}`}>
                                              {getName(c)}
                                            </span>
                                          ))}
                                        </div>
                                      </div>}
                                    </div>
                                    );
                                  })()}
                                </div>
                              );
                            })}
                          </div>
                        )}

                        {/* Legend */}
                        <div className="bg-white rounded-xl shadow p-4 flex flex-wrap gap-4 justify-center text-sm">
                          <div className="flex items-center gap-2"><div className="w-4 h-4 bg-green-500 rounded-full" /><span>Assigned</span></div>
                          <div className="flex items-center gap-2"><div className="w-4 h-4 bg-gray-200 rounded-full" /><span>Not Assigned</span></div>
                        </div>
                      </>
                    );
                  })()}
                </div>
              )}

              {adminParentTab === 'registrations' && (() => {
                const formatDateRange2 = (dates) => {
                  const sorted = [...dates].sort();
                  const fmt = (d) => {
                    const dt = new Date(d + 'T12:00:00');
                    const month = dt.toLocaleDateString('en-US', { month: 'short' });
                    const day = dt.getDate();
                    const suffix = day === 1 || day === 21 || day === 31 ? 'st' : day === 2 || day === 22 ? 'nd' : day === 3 || day === 23 ? 'rd' : 'th';
                    return `${month} ${day}${suffix}`;
                  };
                  if (sorted.length === 1) return fmt(sorted[0]);
                  const ranges = [];
                  let rangeStart = sorted[0], prev = sorted[0];
                  for (let i = 1; i <= sorted.length; i++) {
                    const cur = sorted[i];
                    const prevDate = new Date(prev + 'T12:00:00');
                    const curDate = cur ? new Date(cur + 'T12:00:00') : null;
                    const isConsecutive = curDate && (curDate - prevDate) <= 86400000 * 3;
                    if (!isConsecutive) {
                      ranges.push(rangeStart === prev ? fmt(rangeStart) : `${fmt(rangeStart)} - ${fmt(prev)}`);
                      rangeStart = cur;
                    }
                    prev = cur;
                  }
                  return ranges.join(', ');
                };

                // Group registrations by orderId for the three sections
                const groupByOrder = (regs) => {
                  const byOrder = {};
                  regs.forEach(reg => {
                    const key = reg.orderId || reg.id;
                    if (!byOrder[key]) byOrder[key] = [];
                    byOrder[key].push(reg);
                  });
                  return Object.entries(byOrder);
                };

                const unpaidOrders = groupByOrder(registrations.filter(r => r.status === 'pending' && r.paymentStatus === 'unpaid'));
                const paidByParentOrders = groupByOrder(registrations.filter(r => r.status === 'pending' && ['sent', 'submitted'].includes(r.paymentStatus)));
                const paidOrders = groupByOrder(registrations.filter(r => r.status === 'approved' && ['paid', 'confirmed'].includes(r.paymentStatus)));

                const renderRegCard = (orderId, regs, options = {}) => {
                  const parent = users.find(u => u.email === regs[0].parentEmail);
                  const totalAmount = regs.reduce((sum, r) => sum + (parseFloat(r.totalAmount) || 0), 0);
                  const venmoCode = regs[0]?.venmoCode;
                  const sortedRegs = [...regs].sort((a, b) => new Date(a.date) - new Date(b.date));
                  const screenshot = regs[0]?.venmoScreenshot;
                  const screenshotUrl = screenshot ? (typeof screenshot === 'string' ? screenshot : screenshot?.cropped || screenshot) : null;
                  const paymentStatus = sortedRegs[0]?.paymentStatus || 'unpaid';
                  const isPaid = ['paid', 'confirmed'].includes(paymentStatus);
                  const isSent = paymentStatus === 'sent';

                  const byCamper = {};
                  sortedRegs.forEach(r => {
                    const name = r.camperName || r.childName || 'Unknown';
                    if (!byCamper[name]) byCamper[name] = [];
                    byCamper[name].push(r);
                  });

                  return (
                    <div key={orderId} className={`border-2 rounded-xl p-4 ${options.borderClass || 'border-gray-200'}`}>
                      <div className="flex justify-between items-start mb-3">
                        <div>
                          <h4 className="font-bold text-lg text-green-800">{Object.keys(byCamper).join(' & ')}</h4>
                          <p className="text-sm text-gray-500">Parent: {parent?.name || regs[0].parentName} ({regs[0].parentEmail})</p>
                        </div>
                        {options.actions}
                      </div>
                      <div className="space-y-2 mb-3">
                        {Object.entries(byCamper).map(([camperName, camperRegs]) => {
                          const sortedCamperRegs = camperRegs.sort((a, b) => new Date(a.date) - new Date(b.date));
                          const dates = sortedCamperRegs.map(r => r.date);
                          const camperTotal = sortedCamperRegs.reduce((sum, r) => sum + (parseFloat(r.totalAmount) || 0), 0);
                          const sessions = sortedCamperRegs.flatMap(r => r.sessions || []);
                          const hasAM = sessions.includes('morning');
                          const hasPM = sessions.includes('afternoon');
                          const sessionLabel = hasAM && hasPM ? 'AM + PM' : hasAM ? 'AM only' : 'PM only';
                          return (
                            <div key={camperName} className={`rounded-lg p-3 ${isPaid ? 'bg-green-100' : 'bg-blue-100'}`}>
                              <div className="flex justify-between items-center">
                                <div>
                                  <span className="font-medium">{camperName}</span>
                                  <span className="text-sm text-gray-500 ml-2">({sessionLabel})</span>
                                </div>
                                <span className="font-medium">${camperTotal.toFixed(2)}</span>
                              </div>
                              <div className="text-sm text-gray-600 mt-1">{dates.length} day{dates.length > 1 ? 's' : ''} {'\u2022'} {formatDateRange2(dates)}</div>
                            </div>
                          );
                        })}
                      </div>
                      {venmoCode && (
                        <div className={`text-xs mt-2 ${isPaid ? 'text-green-600' : 'text-blue-600'}`}>
                          Venmo Reference: <span className="font-mono font-bold">{venmoCode}</span>
                          {sortedRegs[0]?.paymentSentAt && (
                            <span className="ml-2 text-gray-500">
                              Sent {new Date(sortedRegs[0].paymentSentAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} at {new Date(sortedRegs[0].paymentSentAt).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                            </span>
                          )}
                        </div>
                      )}
                      {screenshotUrl && (
                        <div className="mt-2 mb-1">
                          <img src={screenshotUrl} alt="Venmo payment screenshot" className="max-h-32 object-contain rounded-lg border cursor-pointer" onClick={() => window.open(screenshotUrl, '_blank')} />
                        </div>
                      )}
                      {isPaid && sortedRegs[0]?.invoiceId && (
                        <div className="mt-2">
                          <span className="text-xs text-green-600">Invoice: <span className="font-mono font-bold">{sortedRegs[0].invoiceId}</span></span>
                        </div>
                      )}
                      <div className={`flex justify-between items-center pt-2 mt-2 ${isPaid ? 'border-t border-green-300' : 'border-t border-blue-200'}`}>
                        <span className="font-bold text-lg">${totalAmount.toFixed(2)}</span>
                        <span className="text-xs text-gray-400">Submitted: {regs[0].registeredAt ? new Date(regs[0].registeredAt).toLocaleString() : 'Unknown'}</span>
                      </div>
                    </div>
                  );
                };

                const activeRegTab = getActiveChildTab('registrations');

                return (
                <div className="space-y-6">
                  {/* New Registrations Sub-tab */}
                  {activeRegTab === 'new' && (
                    <div className="bg-white rounded-xl shadow p-6">
                      <h3 className="font-bold text-xl text-orange-700 mb-2">‚è≥ New Registrations awaiting payment ({unpaidOrders.length})</h3>
                      <p className="text-sm text-gray-500 mb-4">Registrations submitted by parents ‚Äî awaiting Venmo payment from parent.</p>

                      {unpaidOrders.length === 0 ? (
                        <div className="text-center py-6 text-gray-400">
                          <p className="text-3xl mb-2">üí≥</p>
                          <p>No unpaid registrations</p>
                        </div>
                      ) : (
                        <div className="space-y-4">
                          {unpaidOrders.map(([orderId, regs]) => renderRegCard(orderId, regs, {
                            borderClass: 'border-orange-300 bg-orange-50',
                            actions: (
                              <span className="px-3 py-1 rounded-full text-xs font-semibold bg-orange-100 text-orange-700">Awaiting Payment</span>
                            )
                          }))}
                        </div>
                      )}
                    </div>
                  )}

                  {/* Pending Approval Sub-tab */}
                  {activeRegTab === 'pending' && (
                    <div className="bg-white rounded-xl shadow p-6">
                      <h3 className="font-bold text-xl text-blue-700 mb-2">üí∞ Pending Approval ({paidByParentOrders.length})</h3>
                      <p className="text-sm text-gray-500 mb-4">Parent has submitted Venmo payment ‚Äî verify in Venmo and mark as paid.</p>

                      {paidByParentOrders.length === 0 ? (
                        <div className="text-center py-6 text-gray-400">
                          <p className="text-3xl mb-2">‚úì</p>
                          <p>No payments awaiting confirmation</p>
                        </div>
                      ) : (
                        <div className="space-y-4">
                          {paidByParentOrders.map(([orderId, regs]) => {
                            const camperNames = [...new Set(regs.map(r => r.camperName || r.childName))];
                            const totalAmount = regs.reduce((sum, r) => sum + (parseFloat(r.totalAmount) || 0), 0);
                            return renderRegCard(orderId, regs, {
                              borderClass: 'border-blue-300 bg-blue-50',
                              actions: (
                                <button
                                  onClick={async () => {
                                    if (!confirm(`This will mark $${totalAmount.toFixed(2)} as paid for ${camperNames.join(', ')} (${regs.length} session(s)).\n\nCamper(s) will become eligible for pod assignment. Confirm?`)) return;
                                    const now = new Date().toISOString();
                                    const invoiceId = `INV-${Date.now().toString(36).toUpperCase()}`;
                                    const updatedRegs = regs.map(reg => ({
                                      ...reg,
                                      status: 'approved',
                                      paymentStatus: 'confirmed',
                                      approvedAt: now,
                                      approvedBy: user?.name,
                                      paymentConfirmedAt: now,
                                      paymentConfirmedBy: user?.name,
                                      invoiceId
                                    }));
                                    setRegistrations(prev => prev.map(r => {
                                      const updated = updatedRegs.find(u => u.id === r.id);
                                      return updated || r;
                                    }));
                                    await Promise.all(updatedRegs.map(reg => storage.set('camp_registrations', reg.id, reg)));
                                    addToHistory('Payment Confirmed', `Confirmed payment of $${totalAmount.toFixed(2)} for ${camperNames.join(', ')} (${regs.length} sessions) ‚Äî Invoice ${invoiceId}`, [regs[0].parentEmail]);
                                    // Send payment confirmation email to parent
                                    try {
                                      const parent = users.find(u => u.email === regs[0].parentEmail);
                                      const sortedRegs = [...regs].sort((a, b) => new Date(a.date) - new Date(b.date));
                                      const sessionRows = sortedRegs.map(r => `<tr><td style="padding:4px 8px;border-bottom:1px solid #e5e7eb;">${r.camperName || r.childName}</td><td style="padding:4px 8px;border-bottom:1px solid #e5e7eb;">${new Date(r.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</td><td style="padding:4px 8px;border-bottom:1px solid #e5e7eb;">${(r.sessions || []).map(s => s === 'morning' ? 'AM' : 'PM').join(' + ')}</td><td style="padding:4px 8px;border-bottom:1px solid #e5e7eb;text-align:right;">$${(parseFloat(r.totalAmount) || 0).toFixed(2)}</td></tr>`).join('');
                                      fetch('/.netlify/functions/send-email', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                          to: regs[0].parentEmail,
                                          subject: `Payment Confirmed ‚Äî ${camperNames.join(', ')} (Invoice ${invoiceId})`,
                                          html: `<div style="font-family:Arial,sans-serif;max-width:600px;margin:0 auto;"><h2 style="color:#15803d;">Payment Confirmed!</h2><p>Hi ${parent?.name || regs[0].parentName},</p><p>Your payment has been confirmed. Your camper(s) are now registered!</p><div style="background:#f0fdf4;border:2px solid #86efac;border-radius:8px;padding:16px;margin:16px 0;"><p style="margin:0 0 4px;font-size:13px;color:#666;">Invoice: <strong>${invoiceId}</strong></p><p style="margin:0 0 12px;font-size:13px;color:#666;">Date: ${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p><table style="width:100%;border-collapse:collapse;font-size:14px;"><thead><tr style="background:#dcfce7;"><th style="padding:6px 8px;text-align:left;">Camper</th><th style="padding:6px 8px;text-align:left;">Date</th><th style="padding:6px 8px;text-align:left;">Session</th><th style="padding:6px 8px;text-align:right;">Amount</th></tr></thead><tbody>${sessionRows}</tbody><tfoot><tr><td colspan="3" style="padding:8px;font-weight:bold;border-top:2px solid #15803d;">Total Paid</td><td style="padding:8px;font-weight:bold;text-align:right;border-top:2px solid #15803d;color:#15803d;font-size:18px;">$${totalAmount.toFixed(2)}</td></tr></tfoot></table></div><h3 style="color:#15803d;">What Happens Next</h3><ul style="line-height:1.8;"><li>Your camper(s) will be assigned to their pod before camp starts</li><li>Check your dashboard for pod assignments and schedule updates</li><li>Make sure emergency contacts and camper photos are up to date</li></ul><p><a href="https://rhsbasketballdaycamp.com/#login" style="display:inline-block;background-color:#15803d;color:white;padding:12px 24px;text-decoration:none;border-radius:8px;font-weight:bold;">Go to Dashboard</a></p><p style="color:#666;font-size:12px;margin-top:20px;">Keep this email for your records. Invoice ${invoiceId}</p></div>`
                                        })
                                      });
                                    } catch (emailErr) { console.error('Payment email failed:', emailErr); }
                                    showToast(`Payment confirmed for ${camperNames.join(', ')}! Camper(s) now eligible for pod assignment.`);
                                  }}
                                  className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium whitespace-nowrap"
                                >
                                  ‚úì Mark as Paid
                                </button>
                              )
                            });
                          })}
                        </div>
                      )}
                    </div>
                  )}

                  {/* Paid Sub-tab */}
                  {activeRegTab === 'paid' && (
                    <div className="bg-white rounded-xl shadow p-6">
                      <h3 className="font-bold text-xl text-green-700 mb-2">‚úÖ Paid Registrations ({paidOrders.length})</h3>
                      <p className="text-sm text-gray-500 mb-4">Payment confirmed ‚Äî camper(s) eligible for pod assignment on the Pod Setup tab.</p>

                      {paidOrders.length === 0 ? (
                        <div className="text-center py-6 text-gray-400">
                          <p className="text-3xl mb-2">üìã</p>
                          <p>No paid registrations yet</p>
                        </div>
                      ) : (
                        <div className="space-y-4">
                          {paidOrders.map(([orderId, regs]) => {
                            const confirmedDate = regs[0]?.paymentConfirmedAt ? new Date(regs[0].paymentConfirmedAt).toLocaleDateString() : '';
                            const invId = regs[0]?.invoiceId;
                            return renderRegCard(orderId, regs, {
                              borderClass: 'border-green-500 bg-green-50',
                              actions: (
                                <div className="text-right">
                                  {invId && <span className="block text-xs font-mono text-purple-600">{invId}</span>}
                                  <span className="text-xs text-gray-500">{confirmedDate ? `Paid ${confirmedDate}` : 'Paid'}</span>
                                </div>
                              )
                            });
                          })}
                        </div>
                      )}
                    </div>
                  )}

                  {/* Customer Invoices Sub-tab */}
                  {activeRegTab === 'invoices' && (() => {
                    // Collect all invoiced registrations grouped by invoiceId
                    const invoicedRegs = registrations.filter(r => r.invoiceId);
                    const byInvoice = {};
                    invoicedRegs.forEach(r => {
                      if (!byInvoice[r.invoiceId]) byInvoice[r.invoiceId] = [];
                      byInvoice[r.invoiceId].push(r);
                    });

                    const invoices = Object.entries(byInvoice).map(([invoiceId, regs]) => {
                      const parent = users.find(u => u.email === regs[0].parentEmail);
                      const camperNames = [...new Set(regs.map(r => r.camperName || r.childName))].join(', ');
                      const totalAmount = regs.reduce((sum, r) => sum + (parseFloat(r.totalAmount) || 0), 0);
                      const paidDate = regs[0]?.paymentConfirmedAt ? new Date(regs[0].paymentConfirmedAt) : null;
                      return {
                        invoiceId,
                        regs,
                        parentName: parent?.name || regs[0].parentName || '',
                        parentEmail: regs[0].parentEmail || '',
                        parentPhone: parent?.phone || '',
                        camperNames,
                        totalAmount,
                        paidDate,
                        sessionCount: regs.length
                      };
                    });

                    // Executive summary totals
                    const newRegs = registrations.filter(r => r.status === 'pending' && r.paymentStatus === 'unpaid');
                    const pendingRegs = registrations.filter(r => r.status === 'pending' && ['sent', 'submitted'].includes(r.paymentStatus));
                    const paidRegs = registrations.filter(r => r.status === 'approved' && ['paid', 'confirmed'].includes(r.paymentStatus));
                    const newTotal = newRegs.reduce((s, r) => s + (parseFloat(r.totalAmount) || 0), 0);
                    const pendingTotal = pendingRegs.reduce((s, r) => s + (parseFloat(r.totalAmount) || 0), 0);
                    const paidTotal = paidRegs.reduce((s, r) => s + (parseFloat(r.totalAmount) || 0), 0);

                    // Search + Sort state
                    const [invoiceSearch, setInvoiceSearch] = React.useState('');
                    const [invoiceSort, setInvoiceSort] = React.useState('date-desc');
                    const [selectedInvoice, setSelectedInvoice] = React.useState(null);
                    const [emailForm, setEmailForm] = React.useState(null);
                    const [sendingEmail, setSendingEmail] = React.useState(false);

                    const filtered = invoices.filter(inv => {
                      if (!invoiceSearch) return true;
                      const q = invoiceSearch.toLowerCase();
                      return inv.invoiceId.toLowerCase().includes(q)
                        || inv.parentName.toLowerCase().includes(q)
                        || inv.parentEmail.toLowerCase().includes(q)
                        || inv.parentPhone.includes(q)
                        || inv.camperNames.toLowerCase().includes(q)
                        || inv.totalAmount.toFixed(2).includes(q);
                    });

                    const sorted = [...filtered].sort((a, b) => {
                      switch (invoiceSort) {
                        case 'date-desc': return (b.paidDate || 0) - (a.paidDate || 0);
                        case 'date-asc': return (a.paidDate || 0) - (b.paidDate || 0);
                        case 'amount-desc': return b.totalAmount - a.totalAmount;
                        case 'amount-asc': return a.totalAmount - b.totalAmount;
                        case 'parent-asc': return a.parentName.localeCompare(b.parentName);
                        case 'parent-desc': return b.parentName.localeCompare(a.parentName);
                        case 'invoice-asc': return a.invoiceId.localeCompare(b.invoiceId);
                        case 'invoice-desc': return b.invoiceId.localeCompare(a.invoiceId);
                        default: return 0;
                      }
                    });

                    const buildInvoiceHtml = (inv) => {
                      const sortedRegs = [...inv.regs].sort((a, b) => new Date(a.date) - new Date(b.date));
                      const sessionRows = sortedRegs.map(r => `<tr><td style="padding:6px 10px;border-bottom:1px solid #e5e7eb;">${r.camperName || r.childName}</td><td style="padding:6px 10px;border-bottom:1px solid #e5e7eb;">${new Date(r.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</td><td style="padding:6px 10px;border-bottom:1px solid #e5e7eb;">${(r.sessions || []).map(s => s === 'morning' ? 'AM' : 'PM').join(' + ')}</td><td style="padding:6px 10px;border-bottom:1px solid #e5e7eb;text-align:right;">$${(parseFloat(r.totalAmount) || 0).toFixed(2)}</td></tr>`).join('');
                      return `<div style="font-family:Arial,sans-serif;max-width:600px;margin:0 auto;"><h2 style="color:#15803d;">Roosevelt Basketball Day Camp</h2><div style="background:#f0fdf4;border:2px solid #86efac;border-radius:8px;padding:16px;margin:16px 0;"><p style="margin:0 0 4px;font-size:13px;color:#666;">Invoice: <strong>${inv.invoiceId}</strong></p><p style="margin:0 0 4px;font-size:13px;color:#666;">Parent: <strong>${inv.parentName}</strong></p><p style="margin:0 0 12px;font-size:13px;color:#666;">Date: ${inv.paidDate ? inv.paidDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : '‚Äî'}</p><table style="width:100%;border-collapse:collapse;font-size:14px;"><thead><tr style="background:#dcfce7;"><th style="padding:6px 10px;text-align:left;">Camper</th><th style="padding:6px 10px;text-align:left;">Date</th><th style="padding:6px 10px;text-align:left;">Session</th><th style="padding:6px 10px;text-align:right;">Amount</th></tr></thead><tbody>${sessionRows}</tbody><tfoot><tr><td colspan="3" style="padding:8px 10px;font-weight:bold;border-top:2px solid #15803d;">Total Paid</td><td style="padding:8px 10px;font-weight:bold;text-align:right;border-top:2px solid #15803d;color:#15803d;font-size:18px;">$${inv.totalAmount.toFixed(2)}</td></tr></tfoot></table></div><p style="color:#666;font-size:12px;">Roosevelt Basketball Day Camp ‚Äî rhsbasketballdaycamp.com</p></div>`;
                    };

                    return (
                    <div className="space-y-6">
                      {/* Executive Summary */}
                      <div className="bg-white rounded-xl shadow p-6">
                        <h3 className="font-bold text-xl text-gray-800 mb-4">üìä Revenue Summary</h3>
                        <div className="grid grid-cols-1 sm:grid-cols-4 gap-4">
                          <div className="bg-orange-50 border-2 border-orange-200 rounded-xl p-4 text-center">
                            <p className="text-sm text-orange-600 font-medium">New (Awaiting Payment)</p>
                            <p className="text-2xl font-bold text-orange-700">${newTotal.toFixed(2)}</p>
                            <p className="text-xs text-orange-500">{newRegs.length} session(s)</p>
                          </div>
                          <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 text-center">
                            <p className="text-sm text-blue-600 font-medium">Pending Approval</p>
                            <p className="text-2xl font-bold text-blue-700">${pendingTotal.toFixed(2)}</p>
                            <p className="text-xs text-blue-500">{pendingRegs.length} session(s)</p>
                          </div>
                          <div className="bg-green-50 border-2 border-green-200 rounded-xl p-4 text-center">
                            <p className="text-sm text-green-600 font-medium">Paid</p>
                            <p className="text-2xl font-bold text-green-700">${paidTotal.toFixed(2)}</p>
                            <p className="text-xs text-green-500">{paidRegs.length} session(s)</p>
                          </div>
                          <div className="bg-gray-50 border-2 border-gray-300 rounded-xl p-4 text-center">
                            <p className="text-sm text-gray-600 font-medium">Total Registered</p>
                            <p className="text-2xl font-bold text-gray-800">${(newTotal + pendingTotal + paidTotal).toFixed(2)}</p>
                            <p className="text-xs text-gray-500">{newRegs.length + pendingRegs.length + paidRegs.length} session(s)</p>
                          </div>
                        </div>
                      </div>

                      {/* Invoices Table */}
                      <div className="bg-white rounded-xl shadow p-6">
                        <h3 className="font-bold text-xl text-purple-700 mb-2">üßæ Customer Invoices ({invoices.length})</h3>
                        <p className="text-sm text-gray-500 mb-4">Click an invoice number to view details and email to parent.</p>

                        {/* Search and Sort Controls */}
                        <div className="flex flex-col sm:flex-row gap-3 mb-4">
                          <div className="flex-1 relative">
                            <input
                              type="text"
                              placeholder="Search by invoice #, parent, email, phone, camper, amount..."
                              value={invoiceSearch}
                              onChange={e => setInvoiceSearch(e.target.value)}
                              className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-300 focus:border-purple-400"
                            />
                            <span className="absolute left-3 top-2.5 text-gray-400">üîç</span>
                          </div>
                          <select
                            value={invoiceSort}
                            onChange={e => setInvoiceSort(e.target.value)}
                            className="px-3 py-2 border rounded-lg bg-white text-sm"
                          >
                            <option value="date-desc">Date (Newest First)</option>
                            <option value="date-asc">Date (Oldest First)</option>
                            <option value="amount-desc">Amount (High to Low)</option>
                            <option value="amount-asc">Amount (Low to High)</option>
                            <option value="parent-asc">Parent (A to Z)</option>
                            <option value="parent-desc">Parent (Z to A)</option>
                            <option value="invoice-asc">Invoice # (A to Z)</option>
                            <option value="invoice-desc">Invoice # (Z to A)</option>
                          </select>
                        </div>

                        {sorted.length === 0 ? (
                          <div className="text-center py-6 text-gray-400">
                            <p className="text-3xl mb-2">üßæ</p>
                            <p>{invoices.length === 0 ? 'No invoices yet' : 'No invoices match your search'}</p>
                          </div>
                        ) : (
                          <div className="overflow-x-auto -mx-4 sm:mx-0">
                            <table className="w-full min-w-[700px] text-sm">
                              <thead>
                                <tr className="text-left text-xs text-gray-500 border-b">
                                  <th className="p-2 font-medium">Invoice #</th>
                                  <th className="p-2 font-medium">Date</th>
                                  <th className="p-2 font-medium">Parent</th>
                                  <th className="p-2 font-medium">Email</th>
                                  <th className="p-2 font-medium">Phone</th>
                                  <th className="p-2 font-medium">Camper(s)</th>
                                  <th className="p-2 font-medium text-center">Sessions</th>
                                  <th className="p-2 font-medium text-right">Amount</th>
                                </tr>
                              </thead>
                              <tbody>
                                {sorted.map(inv => (
                                  <tr key={inv.invoiceId} className="border-b hover:bg-purple-50 transition-colors cursor-pointer" onClick={() => setSelectedInvoice(inv)}>
                                    <td className="p-2 font-mono font-bold text-purple-700 underline">{inv.invoiceId}</td>
                                    <td className="p-2 text-gray-600">{inv.paidDate ? inv.paidDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '‚Äî'}</td>
                                    <td className="p-2 font-medium">{inv.parentName}</td>
                                    <td className="p-2 text-gray-600">{inv.parentEmail}</td>
                                    <td className="p-2 text-gray-600">{inv.parentPhone || '‚Äî'}</td>
                                    <td className="p-2">{inv.camperNames}</td>
                                    <td className="p-2 text-center">{inv.sessionCount}</td>
                                    <td className="p-2 text-right font-bold text-green-700">${inv.totalAmount.toFixed(2)}</td>
                                  </tr>
                                ))}
                              </tbody>
                              <tfoot>
                                <tr className="border-t-2 border-gray-300">
                                  <td colSpan="6" className="p-2 font-bold text-right">Total ({sorted.length} invoices)</td>
                                  <td className="p-2 text-center font-bold">{sorted.reduce((sum, inv) => sum + inv.sessionCount, 0)}</td>
                                  <td className="p-2 text-right font-bold text-green-700 text-lg">${sorted.reduce((sum, inv) => sum + inv.totalAmount, 0).toFixed(2)}</td>
                                </tr>
                              </tfoot>
                            </table>
                          </div>
                        )}
                      </div>

                      {/* Invoice Detail Modal */}
                      {selectedInvoice && !emailForm && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={() => setSelectedInvoice(null)}>
                          <div className="bg-white rounded-xl max-w-lg w-full max-h-[90vh] overflow-y-auto p-6" onClick={e => e.stopPropagation()}>
                            <div className="flex justify-between items-start mb-4">
                              <h3 className="font-bold text-xl text-purple-700">Invoice {selectedInvoice.invoiceId}</h3>
                              <button onClick={() => setSelectedInvoice(null)} className="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                            </div>
                            <div className="space-y-3 mb-4">
                              <div className="flex justify-between text-sm"><span className="text-gray-500">Parent:</span><span className="font-medium">{selectedInvoice.parentName}</span></div>
                              <div className="flex justify-between text-sm"><span className="text-gray-500">Email:</span><span>{selectedInvoice.parentEmail}</span></div>
                              {selectedInvoice.parentPhone && <div className="flex justify-between text-sm"><span className="text-gray-500">Phone:</span><span>{selectedInvoice.parentPhone}</span></div>}
                              <div className="flex justify-between text-sm"><span className="text-gray-500">Date Paid:</span><span>{selectedInvoice.paidDate ? selectedInvoice.paidDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : '‚Äî'}</span></div>
                            </div>
                            <div className="border rounded-lg overflow-hidden mb-4">
                              <table className="w-full text-sm">
                                <thead><tr className="bg-green-50"><th className="p-2 text-left">Camper</th><th className="p-2 text-left">Date</th><th className="p-2 text-left">Session</th><th className="p-2 text-right">Amount</th></tr></thead>
                                <tbody>
                                  {[...selectedInvoice.regs].sort((a, b) => new Date(a.date) - new Date(b.date)).map(r => (
                                    <tr key={r.id} className="border-t">
                                      <td className="p-2">{r.camperName || r.childName}</td>
                                      <td className="p-2 text-gray-600">{new Date(r.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</td>
                                      <td className="p-2 text-gray-600">{(r.sessions || []).map(s => s === 'morning' ? 'AM' : 'PM').join(' + ')}</td>
                                      <td className="p-2 text-right font-medium">${(parseFloat(r.totalAmount) || 0).toFixed(2)}</td>
                                    </tr>
                                  ))}
                                </tbody>
                                <tfoot><tr className="border-t-2 border-green-600"><td colSpan="3" className="p-2 font-bold">Total</td><td className="p-2 text-right font-bold text-green-700 text-lg">${selectedInvoice.totalAmount.toFixed(2)}</td></tr></tfoot>
                              </table>
                            </div>
                            <div className="flex gap-3">
                              <button
                                onClick={() => {
                                  setEmailForm({
                                    to: selectedInvoice.parentEmail,
                                    cc: '',
                                    subject: `Invoice ${selectedInvoice.invoiceId} ‚Äî Roosevelt Basketball Day Camp`,
                                    body: `Hi ${selectedInvoice.parentName},\n\nPlease find your invoice details below for Roosevelt Basketball Day Camp.\n\nIf you have any questions, please don't hesitate to reach out.\n\nThank you,\nRoosevelt Basketball Day Camp`
                                  });
                                }}
                                className="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-700"
                              >
                                Email Invoice to Parent
                              </button>
                              <button onClick={() => setSelectedInvoice(null)} className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Close</button>
                            </div>
                          </div>
                        </div>
                      )}

                      {/* Email Invoice Modal */}
                      {selectedInvoice && emailForm && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={() => setEmailForm(null)}>
                          <div className="bg-white rounded-xl max-w-lg w-full max-h-[90vh] overflow-y-auto p-6" onClick={e => e.stopPropagation()}>
                            <div className="flex justify-between items-start mb-4">
                              <h3 className="font-bold text-lg text-green-700">Email Invoice {selectedInvoice.invoiceId}</h3>
                              <button onClick={() => setEmailForm(null)} className="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                            </div>
                            <div className="space-y-3">
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">To</label>
                                <input type="email" value={emailForm.to} readOnly className="w-full px-3 py-2 border rounded-lg bg-gray-50 text-gray-600" />
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">CC (comma-separated)</label>
                                <input type="text" value={emailForm.cc} onChange={e => setEmailForm(prev => ({ ...prev, cc: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" placeholder="email1@example.com, email2@example.com" />
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                                <input type="text" value={emailForm.subject} onChange={e => setEmailForm(prev => ({ ...prev, subject: e.target.value }))} className="w-full px-3 py-2 border rounded-lg" />
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Message (appears above invoice)</label>
                                <textarea value={emailForm.body} onChange={e => setEmailForm(prev => ({ ...prev, body: e.target.value }))} rows="5" className="w-full px-3 py-2 border rounded-lg resize-y" />
                              </div>
                              <div className="bg-gray-50 rounded-lg p-3 border">
                                <p className="text-xs text-gray-500 mb-2">Invoice preview (attached below your message):</p>
                                <p className="text-sm font-mono text-purple-700">{selectedInvoice.invoiceId} ‚Äî {selectedInvoice.camperNames} ‚Äî ${selectedInvoice.totalAmount.toFixed(2)}</p>
                              </div>
                            </div>
                            <div className="flex gap-3 mt-4">
                              <button
                                disabled={sendingEmail}
                                onClick={async () => {
                                  setSendingEmail(true);
                                  try {
                                    const recipients = [emailForm.to, ...emailForm.cc.split(',').map(e => e.trim()).filter(Boolean)];
                                    const bodyHtml = emailForm.body.split('\n').map(line => `<p style="margin:0 0 8px;">${line || '&nbsp;'}</p>`).join('');
                                    const invoiceHtml = buildInvoiceHtml(selectedInvoice);
                                    await fetch('/.netlify/functions/send-email', {
                                      method: 'POST',
                                      headers: { 'Content-Type': 'application/json' },
                                      body: JSON.stringify({
                                        to: recipients,
                                        subject: emailForm.subject,
                                        html: `<div style="font-family:Arial,sans-serif;max-width:600px;margin:0 auto;">${bodyHtml}<hr style="border:none;border-top:1px solid #e5e7eb;margin:24px 0;" />${invoiceHtml}</div>`
                                      })
                                    });
                                    addToHistory('Invoice Emailed', `Emailed invoice ${selectedInvoice.invoiceId} ($${selectedInvoice.totalAmount.toFixed(2)}) to ${recipients.join(', ')}`, [selectedInvoice.parentEmail]);
                                    showToast(`Invoice emailed to ${emailForm.to}`);
                                    setEmailForm(null);
                                    setSelectedInvoice(null);
                                  } catch (err) {
                                    console.error('Email invoice failed:', err);
                                    showToast('Failed to send email. Please try again.');
                                  }
                                  setSendingEmail(false);
                                }}
                                className="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-700 disabled:opacity-50"
                              >
                                {sendingEmail ? 'Sending...' : 'Send Email'}
                              </button>
                              <button onClick={() => setEmailForm(null)} className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Cancel</button>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                    );
                  })()}
                </div>
                );
              })()}

              {adminParentTab === 'camp' && getActiveChildTab('camp') === 'content' && (
                <div className="space-y-6">
                  <div className="bg-green-100 border-l-4 border-green-600 p-4 rounded-lg">
                    <p className="text-green-800"><strong>Auto-save enabled:</strong> Changes are saved automatically when you click outside the field</p>
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold mb-4">Hero Section</h3>
                    <div className="grid md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Title</label>
                        <StableInput value={content.heroTitle} onSave={(v) => updateContent('heroTitle', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Subtitle</label>
                        <StableInput value={content.heroSubtitle} onSave={(v) => updateContent('heroSubtitle', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div className="md:col-span-2">
                        <label className="block text-sm text-gray-600 mb-1">Tagline</label>
                        <StableInput value={content.heroTagline} onSave={(v) => updateContent('heroTagline', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold mb-4">Details</h3>
                    <div className="grid md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Session Cost</label>
                        <StableInput value={content.sessionCost} onSave={(v) => updateContent('sessionCost', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Venmo Username</label>
                        <StableInput value={content.venmoUsername} onSave={(v) => updateContent('venmoUsername', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Venmo QR Code</label>
                        {content.venmoImage && (
                          <div className="mb-2">
                            <img src={content.venmoImage} alt="Venmo QR Code" className="w-32 h-32 border rounded" />
                          </div>
                        )}
                        <div className="flex items-center gap-2">
                          <input
                            type="file"
                            accept="image/*"
                            onChange={(e) => {
                              const file = e.target.files?.[0];
                              if (file) {
                                const reader = new FileReader();
                                reader.onload = (ev) => updateContent('venmoImage', ev.target.result);
                                reader.readAsDataURL(file);
                              }
                            }}
                            className="text-sm"
                          />
                          {content.venmoImage && (
                            <button onClick={() => updateContent('venmoImage', null)} className="text-sm text-red-600 underline">Remove</button>
                          )}
                        </div>
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Morning Session</label>
                        <StableInput value={content.sessionMorning} onSave={(v) => updateContent('sessionMorning', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Afternoon Session</label>
                        <StableInput value={content.sessionAfternoon} onSave={(v) => updateContent('sessionAfternoon', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Camp Dates</label>
                        <StableInput value={content.campDates} onSave={(v) => updateContent('campDates', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Age Range</label>
                        <StableInput value={content.ageRange} onSave={(v) => updateContent('ageRange', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold mb-4">Contact & Location</h3>
                    <div className="grid md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Email</label>
                        <StableInput value={content.contactEmail} onSave={(v) => updateContent('contactEmail', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Phone</label>
                        <StableInput value={content.contactPhone} onSave={(v) => updateContent('contactPhone', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Location Name</label>
                        <StableInput value={content.locationName} onSave={(v) => updateContent('locationName', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Location Address</label>
                        <StableInput value={content.locationAddress} onSave={(v) => updateContent('locationAddress', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">City</label>
                        <StableInput value={content.locationCity} onSave={(v) => updateContent('locationCity', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">State</label>
                        <StableInput value={content.locationState} onSave={(v) => updateContent('locationState', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Zip Code</label>
                        <StableInput value={content.locationZip} onSave={(v) => updateContent('locationZip', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div className="md:col-span-2">
                        <label className="block text-sm text-gray-600 mb-1">Location Details</label>
                        <StableTextarea value={content.locationDetails} onSave={(v) => updateContent('locationDetails', v)} className="w-full px-3 py-2 border rounded-lg" rows={2} />
                      </div>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold mb-4">About</h3>
                    <label className="block text-sm text-gray-600 mb-1">About Text</label>
                    <StableTextarea value={content.aboutText} onSave={(v) => updateContent('aboutText', v)} className="w-full px-3 py-2 border rounded-lg" rows={4} />
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold mb-4">Pricing & Discounts</h3>
                    <div className="grid md:grid-cols-3 gap-4">
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Single Session Cost ($)</label>
                        <StableInput value={String(content.singleSessionCost || '')} onSave={(v) => updateContent('singleSessionCost', Number(v))} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Week Discount (%)</label>
                        <StableInput value={String(content.weekDiscount || '')} onSave={(v) => updateContent('weekDiscount', Number(v))} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Multi-Week Discount (%)</label>
                        <StableInput value={String(content.multiWeekDiscount || '')} onSave={(v) => updateContent('multiWeekDiscount', Number(v))} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                    </div>
                    <div className="mt-4">
                      <label className="block text-sm text-gray-600 mb-1">Scholarship Info</label>
                      <StableTextarea value={content.scholarshipInfo} onSave={(v) => updateContent('scholarshipInfo', v)} className="w-full px-3 py-2 border rounded-lg" rows={3} />
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold mb-4">Policies</h3>
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Cancellation Policy</label>
                        <StableTextarea value={content.cancellationPolicy} onSave={(v) => updateContent('cancellationPolicy', v)} className="w-full px-3 py-2 border rounded-lg" rows={3} />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Late Pickup Policy</label>
                        <StableTextarea value={content.latePickupPolicy} onSave={(v) => updateContent('latePickupPolicy', v)} className="w-full px-3 py-2 border rounded-lg" rows={3} />
                      </div>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold mb-2">Pickup Policy Images</h3>
                    <p className="text-sm text-gray-500 mb-4">These images appear during onboarding when parents review the pick-up policy. Upload a realistic example of a face photo and a photo ID card.</p>
                    <div className="grid md:grid-cols-2 gap-6">
                      <ImageUpload
                        currentImage={content.pickupPolicyFacePhoto}
                        onImageChange={(img) => updateContent('pickupPolicyFacePhoto', img)}
                        label="Face Photo Example"
                        circular={true}
                      />
                      <ImageUpload
                        currentImage={content.pickupPolicyIdPhoto}
                        onImageChange={(img) => updateContent('pickupPolicyIdPhoto', img)}
                        label="Photo ID Example"
                      />
                    </div>
                  </div>

                  <div className="bg-blue-50 border border-blue-200 rounded-xl p-6">
                    <h3 className="font-bold mb-2 text-blue-800">Data From Other Tables</h3>
                    <p className="text-sm text-blue-700 mb-3">The following content on the public website is pulled from database tables, not the content settings above. To update this data, edit the source records directly.</p>
                    <div className="space-y-2 text-sm">
                      <div className="flex items-start gap-2 p-2 bg-white rounded border border-blue-100">
                        <span className="font-bold text-blue-600 whitespace-nowrap">Counselor Profiles</span>
                        <span className="text-gray-600">Names, bios, and photos shown on the public site come from the <strong>Counselors</strong> tab. Edit counselor profiles there.</span>
                      </div>
                      <div className="flex items-start gap-2 p-2 bg-white rounded border border-blue-100">
                        <span className="font-bold text-blue-600 whitespace-nowrap">Camp Dates</span>
                        <span className="text-gray-600">The camp schedule calendar is generated from the <strong>camp_dates</strong> system table. These are configured in the codebase.</span>
                      </div>
                      <div className="flex items-start gap-2 p-2 bg-white rounded border border-blue-100">
                        <span className="font-bold text-blue-600 whitespace-nowrap">Gym Rental Days</span>
                        <span className="text-gray-600">Which days the gym is booked comes from <strong>Gym Rental Days</strong> tab under Camp Setup.</span>
                      </div>
                    </div>
                  </div>

                  {/* Site Photos Management (Hero, Drop-off, Layups, Lunch) */}
                  <SitePhotosManager
                    sitePhotos={sitePhotos}
                    onSave={saveSitePhotos}
                  />

                  {/* Food Photos Management */}
                  <FoodPhotosManager
                    foodPhotos={foodPhotos}
                    getFoodPhoto={getFoodPhoto}
                    onSave={saveFoodPhotos}
                  />
                </div>
              )}

              {adminParentTab === 'family' && getActiveChildTab('family') === 'parents' && (
                <ParentsTab
                  parents={parents}
                  registrations={registrations}
                  onUpdateParents={saveParents}
                  onDeleteParent={deleteParent}
                  onUpdateRegistrations={saveReg}
                  onDeleteRegistration={async (reg) => {
                    // Remove from registrations
                    setRegistrations(registrations.filter(r => r.id !== reg.id));
                    await supabase.from('camp_registrations').delete().eq('id', reg.id);

                    // Clean up assignments for this child on this date/sessions
                    if (reg.childId && reg.date && reg.sessions) {
                      const updatedAssignments = { ...assignments };
                      reg.sessions.forEach(session => {
                        const key = `${reg.date}_${session}`;
                        if (updatedAssignments[key]) {
                          Object.keys(updatedAssignments[key]).forEach(counselorId => {
                            updatedAssignments[key][counselorId] = updatedAssignments[key][counselorId].filter(id => id !== reg.childId);
                          });
                        }
                      });
                      setAssignments(updatedAssignments);
                      await storage.set('camp_assignments', 'main', updatedAssignments);
                    }
                  }}
                  showToast={showToast}
                  addToHistory={addToHistory}
                  campers={campers}
                  camperParentLinks={camperParentLinks}
                  onSaveLinks={saveCamperParentLinks}
                  onSaveCampers={saveCampers}
                  onSaveCamperParentLinks={saveCamperParentLinks}
                  emergencyContacts={emergencyContacts}
                  saveEmergencyContacts={saveEmergencyContacts}
                  saveOnboardingProgress={saveOnboardingProgress}
                />
              )}

              {adminParentTab === 'admins' && (
                <AdminsTab
                  admins={admins}
                  currentAdminId={user?.adminId}
                  onSave={saveAdmins}
                  showToast={showToast}
                />
              )}

              {adminParentTab === 'family' && getActiveChildTab('family') === 'campers' && (
                <CampersTab
                  parents={parents}
                  registrations={registrations}
                  campers={campers}
                  camperParentLinks={camperParentLinks}
                  emergencyContacts={emergencyContacts}
                  onSaveCampers={saveCampers}
                  onSaveLinks={saveCamperParentLinks}
                  onDeleteCamper={deleteCamper}
                  onSaveEmergencyContacts={saveEmergencyContacts}
                  showToast={showToast}
                  addToHistory={addToHistory}
                  assignments={assignments}
                />
              )}

              {adminParentTab === 'pod' && getActiveChildTab('pod') === 'assignments' && (
                <AssignmentsTab
                  registrations={registrations}
                  counselors={counselors}
                  users={users}
                  assignments={assignments}
                  availability={availability}
                  onSaveAssignments={saveAssignments}
                  showToast={showToast}
                  selectedMonth={assignmentsTabMonth}
                  setSelectedMonth={setAssignmentsTabMonth}
                  campers={campers}
                  selectedDate={podSelectedDate}
                  setSelectedDate={setPodSelectedDate}
                  selectedSession={podSelectedSession}
                  setSelectedSession={setPodSelectedSession}
                  sessionPods={podSessionPods}
                  setSessionPods={setPodSessionPods}
                  podCalWeeks={podCalWeeks}
                  setPodCalWeeks={setPodCalWeeks}
                  podCalDates={podCalDates}
                  setPodCalDates={setPodCalDates}
                  podCamperView={podCamperView}
                  setPodCamperView={setPodCamperView}
                  podSelectedCamper={podSelectedCamper}
                  setPodSelectedCamper={setPodSelectedCamper}
                  counselorSchedule={counselorSchedule}
                />
              )}

              {adminParentTab === 'family' && getActiveChildTab('family') === 'sessionregs' && false && (
                <SessionsTab
                  blockedSessions={blockedSessions}
                  allDates={CAMP_DATES}
                  onSaveBlockedSessions={saveBlockedSessions}
                  registrations={registrations}
                  counselors={counselors}
                  availability={availability}
                  assignments={assignments}
                  showToast={showToast}
                  selectedMonth={sessionsTabMonth}
                  setSelectedMonth={setSessionsTabMonth}
                />
              )}

              {adminParentTab === 'camp' && getActiveChildTab('camp') === 'gymrentals' && (
                <GymRentalDaysTab
                  gymRentals={gymRentals}
                  allDates={CAMP_DATES}
                  onSaveGymRentals={saveGymRentals}
                  showToast={showToast}
                  selectedMonth={gymRentalsTabMonth}
                  setSelectedMonth={setGymRentalsTabMonth}
                />
              )}

              {adminParentTab === 'camp' && getActiveChildTab('camp') === 'history' && (
                <div className="bg-white rounded-xl shadow p-6">
                  <h3 className="font-bold text-lg text-green-800 mb-4">üìú Change History</h3>
                  {changeHistory.length === 0 ? (
                    <p className="text-gray-500">No changes recorded yet</p>
                  ) : (
                    <div className="space-y-2 max-h-96 overflow-y-auto">
                      {changeHistory.map(entry => (
                        <div key={entry.id} className="flex items-start gap-3 p-3 border rounded-lg hover:bg-gray-50">
                          <div className="text-xs text-gray-400 whitespace-nowrap pt-0.5">
                            {formatTimestamp(entry.timestamp)}
                          </div>
                          <div>
                            <div className="font-medium text-gray-800">{entry.action}</div>
                            <div className="text-sm text-gray-600">{entry.details}</div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              {adminParentTab === 'camp' && getActiveChildTab('camp') === 'dangerzone' && (
                <div className="space-y-6">
                  {/* Warning Banner */}
                  <div className="bg-red-50 border-2 border-red-300 rounded-xl p-6">
                    <div className="flex items-start gap-4">
                      <span className="text-4xl">‚ö†Ô∏è</span>
                      <div>
                        <h3 className="font-bold text-xl text-red-700 mb-2">Danger Zone</h3>
                        <p className="text-red-600 mb-2">
                          Actions in this section are <strong>destructive and irreversible</strong>. Use extreme caution.
                        </p>
                        <p className="text-sm text-red-500">
                          Deletions will permanently remove data from Supabase and cannot be undone.
                        </p>
                      </div>
                    </div>
                  </div>

                  {/* Delete Actions */}
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold text-lg text-gray-800 mb-4">üóëÔ∏è Delete Records</h3>
                    <div className="grid md:grid-cols-1 gap-4">
                      {/* Delete ALL Data (except Counselors) */}
                      <div className="border-2 border-red-700 rounded-lg p-4 bg-red-100">
                        <h4 className="font-bold text-red-900 mb-2">‚ò¢Ô∏è Delete All Data (except Counselors)</h4>
                        <p className="text-sm text-red-800 mb-3">
                          Removes all parents, campers, registrations, assignments, emergency contacts, and all parent data. <strong>Preserves counselors, counselor availability, and admin.</strong> This resets all parent/camper data while keeping your counselor roster intact.
                        </p>
                        <button
                          onClick={async () => {
                            if (!confirm('‚ò¢Ô∏è DELETE ALL DATA: This will delete all parents, campers, registrations, assignments, and emergency contacts (but preserve counselors and admin). Are you ABSOLUTELY SURE?')) return;
                            const confirmText = prompt('Type DELETE ALL to confirm data wipe:');
                            if (confirmText !== 'DELETE ALL') {
                              showToast('Deletion cancelled', 'error');
                              return;
                            }
                            // Delete all parent/camper data (but preserve counselors and admins)
                            await saveParents([], 'Total Wipe: Deleted all parents');
                            // Note: counselorUsers and admins tables are NOT touched - they are preserved
                            await saveCampers([], 'Total Wipe: Deleted all campers');
                            await saveRegistrations([], 'Total Wipe: Deleted all registrations');
                            await saveAssignments({}, 'Total Wipe: Deleted all assignments');
                            await saveCamperParentLinks([], 'Total Wipe: Cleared all links');
                            await saveEmergencyContacts([], 'Total Wipe: Deleted all emergency contacts');
                            await saveOnboardingProgress({});
                            await saveAvailabilityChangeRequests([], 'Total Wipe: Cleared change requests');
                            await saveProfileChangeRequests([], 'Total Wipe: Cleared profile requests');
                            // Note: We preserve counselor data (counselors, availability, schedules)
                            showToast('‚ò¢Ô∏è All parent/camper data deleted (counselors & admin preserved)');
                          }}
                          className="px-4 py-2 bg-red-900 text-white rounded-lg hover:bg-black w-full font-bold"
                        >
                          ‚ò¢Ô∏è DELETE ALL DATA (EXCEPT COUNSELORS)
                        </button>
                      </div>

                      {/* Delete ALL Counselor Data */}
                      <div className="border-2 border-red-500 rounded-lg p-4 bg-red-50">
                        <h4 className="font-bold text-red-800 mb-2">üèÄ Delete All Counselor Data</h4>
                        <p className="text-sm text-red-700 mb-3">
                          Removes all counselor profiles, login accounts, availability, and schedules. <strong>Preserves parents, campers, registrations, and admin.</strong> Useful for resetting test counselor data.
                        </p>
                        <button
                          onClick={async () => {
                            if (!confirm('üèÄ DELETE ALL COUNSELORS: This will delete all counselor profiles, login accounts, availability, and schedules. Are you ABSOLUTELY SURE?')) return;
                            const confirmText = prompt('Type DELETE COUNSELORS to confirm:');
                            if (confirmText !== 'DELETE COUNSELORS') {
                              showToast('Deletion cancelled', 'error');
                              return;
                            }
                            // Delete all counselor rows (individual rows per counselor)
                            for (const c of counselors) {
                              try { await supabase.from('camp_counselors').delete().eq('id', c.id); } catch (e) { console.error(e); }
                            }
                            setCounselors([]);
                            // Clear counselor user accounts
                            await saveCounselorUsers([], 'Deleted all counselor users');
                            // Clear availability
                            await saveAvail({}, 'Deleted all counselor availability');
                            // Clear schedules
                            await saveCounselorSchedule({}, 'Deleted all counselor schedules');
                            // Clear assignments that reference counselors
                            await saveAssignments({}, 'Deleted all assignments (counselor wipe)');
                            showToast('üèÄ All counselor data deleted');
                          }}
                          className="px-4 py-2 bg-red-700 text-white rounded-lg hover:bg-red-900 w-full font-bold"
                        >
                          üèÄ DELETE ALL COUNSELOR DATA
                        </button>
                      </div>
                    </div>
                  </div>

                  {/* SECTION 1: Tables CLEARED by Delete All Button */}
                  <div className="bg-white rounded-xl shadow p-6 border-2 border-red-200">
                    <div className="flex items-center gap-2 mb-1">
                      <span className="text-lg">üî¥</span>
                      <h3 className="font-bold text-lg text-red-800">Tables CLEARED by "Delete All" Button (9 tables)</h3>
                    </div>
                    <p className="text-sm text-red-600 mb-4">All data in these tables will be permanently wiped when you press the button above.</p>
                    <div className="space-y-4">
                      {/* Parents */}
                      <details className="border border-red-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-red-50 font-medium flex items-center justify-between">
                          <span>üë®‚Äçüë©‚Äçüëß Parents ({parents.length} login accounts)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {parents.length === 0 ? (
                            <p className="text-gray-500 text-sm">No parent records</p>
                          ) : (
                            <div className="space-y-2">
                              {parents.map(parent => (
                                <div key={parent.email} className="flex items-center justify-between p-3 bg-white rounded border">
                                  <div>
                                    <div className="font-medium">{parent.name}</div>
                                    <div className="text-sm text-gray-500">{parent.email}</div>
                                  </div>
                                  <button
                                    onClick={async () => {
                                      if (!confirm(`Delete parent ${parent.name}? This will also remove their children and registrations.`)) return;
                                      const newParents = parents.filter(p => p.email !== parent.email);
                                      await saveParents(newParents, `Deleted parent ${parent.name}`);
                                      showToast(`Deleted ${parent.name}`);
                                    }}
                                    className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                  >
                                    Delete
                                  </button>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </details>

                      {/* Campers */}
                      <details className="border border-red-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-red-50 font-medium flex items-center justify-between">
                          <span>üèïÔ∏è Campers ({campers.length} records)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {campers.length === 0 ? (
                            <p className="text-gray-500 text-sm">No camper records</p>
                          ) : (
                            <div className="space-y-2">
                              {campers.map(camper => (
                                <div key={camper.id} className="flex items-center justify-between p-3 bg-white rounded border">
                                  <div>
                                    <div className="font-medium">{camper.name}</div>
                                    <div className="text-sm text-gray-500">Age: {camper.age}</div>
                                  </div>
                                  <button
                                    onClick={async () => {
                                      if (!confirm(`Delete camper ${camper.name}?`)) return;
                                      await deleteCamper(camper.id, camper.name);
                                      showToast(`Deleted ${camper.name}`);
                                    }}
                                    className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                  >
                                    Delete
                                  </button>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </details>

                      {/* Registrations */}
                      <details className="border border-red-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-red-50 font-medium flex items-center justify-between">
                          <span>üìù Registrations ({registrations.length} records)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {registrations.length === 0 ? (
                            <p className="text-gray-500 text-sm">No registration records</p>
                          ) : (
                            <div className="space-y-2">
                              {registrations.map(reg => (
                                <div key={reg.id} className="flex items-center justify-between p-3 bg-white rounded border">
                                  <div>
                                    <div className="font-medium">{reg.camperName || reg.childName}</div>
                                    <div className="text-sm text-gray-500">{reg.date} - {reg.sessions?.join(', ')}</div>
                                  </div>
                                  <button
                                    onClick={async () => {
                                      if (!confirm(`Delete registration for ${reg.camperName || reg.childName}?`)) return;
                                      const newRegs = registrations.filter(r => r.id !== reg.id);
                                      await saveRegistrations(newRegs, `Deleted registration ${reg.id}`);
                                      showToast('Registration deleted');
                                    }}
                                    className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                  >
                                    Delete
                                  </button>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </details>

                      {/* Assignments */}
                      <details className="border border-red-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-red-50 font-medium flex items-center justify-between">
                          <span>üìã Pod Assignments ({Object.keys(assignments).length} sessions)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {Object.keys(assignments).length === 0 ? (
                            <p className="text-gray-500 text-sm">No assignment records</p>
                          ) : (
                            <div className="space-y-2">
                              {Object.entries(assignments).map(([sessionKey, pods]) => (
                                <div key={sessionKey} className="flex items-center justify-between p-3 bg-white rounded border">
                                  <div>
                                    <div className="font-medium">{sessionKey.replace('_', ' - ')}</div>
                                    <div className="text-sm text-gray-500">{Object.keys(pods).length} pod(s)</div>
                                  </div>
                                  <button
                                    onClick={async () => {
                                      if (!confirm(`Delete all pod assignments for ${sessionKey}?`)) return;
                                      const newAssignments = { ...assignments };
                                      delete newAssignments[sessionKey];
                                      await saveAssignments(newAssignments, `Deleted assignments for ${sessionKey}`);
                                      showToast('Session assignments deleted');
                                    }}
                                    className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                  >
                                    Delete
                                  </button>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </details>

                      {/* Emergency Contacts */}
                      <details className="border border-red-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-red-50 font-medium flex items-center justify-between">
                          <span>üÜò Emergency Contacts ({emergencyContacts.length} contacts)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {emergencyContacts.length === 0 ? (
                            <p className="text-gray-500 text-sm">No emergency contact records</p>
                          ) : (
                            <div className="space-y-2">
                              {emergencyContacts.map(contact => (
                                <div key={contact.id} className="flex items-center justify-between p-3 bg-white rounded border">
                                  <div>
                                    <div className="font-medium">{contact.name}</div>
                                    <div className="text-sm text-gray-500">
                                      {contact.relationship} ‚Ä¢ {contact.phone}
                                      {contact.userEmail && <span className="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">Parent: {contact.userEmail}</span>}
                                    </div>
                                  </div>
                                  <button
                                    onClick={async () => {
                                      if (!confirm(`Delete emergency contact ${contact.name}?`)) return;
                                      const newContacts = emergencyContacts.filter(c => c.id !== contact.id);
                                      await saveEmergencyContacts(newContacts, `Deleted emergency contact ${contact.name}`);
                                      showToast('Emergency contact deleted');
                                    }}
                                    className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                  >
                                    Delete
                                  </button>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </details>

                      {/* Camper-Parent Links */}
                      <details className="border border-red-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-red-50 font-medium flex items-center justify-between">
                          <span>üîó Camper-Parent Links ({camperParentLinks.length} links)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {camperParentLinks.length === 0 ? (
                            <p className="text-gray-500 text-sm">No camper-parent links</p>
                          ) : (
                            <div className="space-y-2">
                              {camperParentLinks.map((link, idx) => {
                                const camper = campers.find(c => c.id === link.camperId);
                                const parent = parents.find(p => p.email === link.parentEmail);
                                return (
                                  <div key={`${link.camperId}-${link.parentEmail}-${idx}`} className="flex items-center justify-between p-3 bg-white rounded border">
                                    <div className="flex-1">
                                      <div className="font-medium">{camper?.name || 'Unknown Camper'} ‚Üî {parent?.name || link.parentEmail}</div>
                                      <div className="text-sm text-gray-500">Camper ID: {link.camperId}</div>
                                    </div>
                                    <button
                                      onClick={async () => {
                                        if (!confirm(`Delete link between ${camper?.name} and ${parent?.name}?`)) return;
                                        const newLinks = camperParentLinks.filter((l, i) => i !== idx);
                                        await saveCamperParentLinks(newLinks, `Deleted link for ${camper?.name}`);
                                        showToast('Link deleted');
                                      }}
                                      className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                    >
                                      Delete
                                    </button>
                                  </div>
                                );
                              })}
                            </div>
                          )}
                        </div>
                      </details>

                      {/* Onboarding Progress */}
                      <details className="border border-red-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-red-50 font-medium flex items-center justify-between">
                          <span>üéØ Onboarding Progress ({Object.keys(onboardingProgress || {}).length} users)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {Object.keys(onboardingProgress || {}).length === 0 ? (
                            <p className="text-gray-500 text-sm">No onboarding progress records</p>
                          ) : (
                            <div className="space-y-2">
                              {Object.entries(onboardingProgress).map(([userEmail, progressData]) => (
                                <div key={userEmail} className="flex items-center justify-between p-3 bg-white rounded border">
                                  <div className="flex-1">
                                    <div className="font-medium">{userEmail}</div>
                                    <div className="text-sm text-gray-500">Step: {progressData.step || 0} - {progressData.complete ? 'Complete' : 'In Progress'}</div>
                                  </div>
                                  <button
                                    onClick={async () => {
                                      if (!confirm(`Delete onboarding progress for ${userEmail}?`)) return;
                                      const newProgress = { ...onboardingProgress };
                                      delete newProgress[userEmail];
                                      setOnboardingProgress(newProgress);
                                      await storage.set('camp_onboarding_progress', 'main', newProgress);
                                      addToHistory('Onboarding Progress Deleted', `Deleted progress for ${userEmail}`);
                                      showToast('Progress deleted');
                                    }}
                                    className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                  >
                                    Delete
                                  </button>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </details>

                      {/* Availability Change Requests */}
                      <details className="border border-red-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-red-50 font-medium flex items-center justify-between">
                          <span>üìù Availability Change Requests ({availabilityChangeRequests.length} requests)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {availabilityChangeRequests.length === 0 ? (
                            <p className="text-gray-500 text-sm">No availability change requests</p>
                          ) : (
                            <div className="space-y-2">
                              {availabilityChangeRequests.map(request => (
                                <div key={request.id} className="flex items-center justify-between p-3 bg-white rounded border">
                                  <div className="flex-1">
                                    <div className="font-medium">{request.counselorEmail || 'Unknown'}</div>
                                    <div className="text-sm text-gray-500">Status: {request.status || 'Pending'}</div>
                                  </div>
                                  <button
                                    onClick={async () => {
                                      if (!confirm(`Delete availability change request?`)) return;
                                      const newRequests = availabilityChangeRequests.filter(r => r.id !== request.id);
                                      await saveAvailabilityChangeRequests(newRequests, `Deleted change request`);
                                      showToast('Request deleted');
                                    }}
                                    className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                  >
                                    Delete
                                  </button>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </details>

                      {/* Profile Change Requests */}
                      <details className="border border-red-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-red-50 font-medium flex items-center justify-between">
                          <span>üë§ Profile Change Requests ({profileChangeRequests.length} requests)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {profileChangeRequests.length === 0 ? (
                            <p className="text-gray-500 text-sm">No profile change requests</p>
                          ) : (
                            <div className="space-y-2">
                              {profileChangeRequests.map(request => (
                                <div key={request.id} className="flex items-center justify-between p-3 bg-white rounded border">
                                  <div className="flex-1">
                                    <div className="font-medium">{request.counselorEmail || 'Unknown'}</div>
                                    <div className="text-sm text-gray-500">Status: {request.status || 'Pending'}</div>
                                  </div>
                                  <button
                                    onClick={async () => {
                                      if (!confirm(`Delete profile change request?`)) return;
                                      const newRequests = profileChangeRequests.filter(r => r.id !== request.id);
                                      await saveProfileChangeRequests(newRequests, `Deleted change request`);
                                      showToast('Request deleted');
                                    }}
                                    className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                  >
                                    Delete
                                  </button>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </details>
                    </div>
                  </div>

                  {/* SECTION 2: Tables NOT CLEARED by Delete All Button */}
                  <div className="bg-white rounded-xl shadow p-6 border-2 border-green-200">
                    <div className="flex items-center gap-2 mb-1">
                      <span className="text-lg">üü¢</span>
                      <h3 className="font-bold text-lg text-green-800">Tables PRESERVED by "Delete All" Button (14 tables)</h3>
                    </div>
                    <p className="text-sm text-green-600 mb-4">These tables are NOT affected by the delete button. They can only be deleted individually.</p>
                    <div className="space-y-4">
                      {/* Admins */}
                      <details className="border border-green-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-green-50 font-medium flex items-center justify-between">
                          <span>üëë Admins ({admins.length} accounts)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {admins.length === 0 ? (
                            <p className="text-gray-500 text-sm">No admin accounts</p>
                          ) : (
                            <div className="space-y-2">
                              {admins.map(admin => (
                                <div key={admin.username} className="flex items-center justify-between p-3 bg-white rounded border">
                                  <div className="flex-1">
                                    <div className="font-medium">{admin.name || admin.username}</div>
                                    <div className="text-sm text-gray-500">Username: {admin.username}</div>
                                  </div>
                                  <button
                                    onClick={async () => {
                                      if (admins.length === 1) {
                                        alert('Cannot delete the last admin account!');
                                        return;
                                      }
                                      if (!confirm(`Delete admin ${admin.username}?`)) return;
                                      const newAdmins = admins.filter(a => a.username !== admin.username);
                                      await saveAdmins(newAdmins, `Deleted admin ${admin.username}`);
                                      showToast(`Deleted ${admin.username}`);
                                    }}
                                    className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                  >
                                    Delete
                                  </button>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </details>

                      {/* Counselor Users (Login Accounts) */}
                      <details className="border border-green-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-green-50 font-medium flex items-center justify-between">
                          <span>üîê Counselor Users ({counselorUsers.length} login accounts)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {counselorUsers.length === 0 ? (
                            <p className="text-gray-500 text-sm">No counselor user accounts</p>
                          ) : (
                            <div className="space-y-2">
                              {counselorUsers.map(user => (
                                <div key={user.email} className="flex items-center justify-between p-3 bg-white rounded border">
                                  <div className="flex-1">
                                    <div className="font-medium">{user.name}</div>
                                    <div className="text-sm text-gray-500">{user.email}</div>
                                  </div>
                                  <button
                                    onClick={async () => {
                                      if (!confirm(`Delete counselor user account for ${user.name}?`)) return;
                                      const newUsers = counselorUsers.filter(u => u.email !== user.email);
                                      await saveCounselorUsers(newUsers, `Deleted counselor user ${user.name}`);
                                      showToast(`Deleted ${user.name}`);
                                    }}
                                    className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                  >
                                    Delete
                                  </button>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </details>

                      {/* Counselors (Profiles) */}
                      <details className="border border-green-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-green-50 font-medium flex items-center justify-between">
                          <span>üèÄ Counselors ({counselors.length} profiles)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {counselors.length === 0 ? (
                            <p className="text-gray-500 text-sm">No counselor records</p>
                          ) : (
                            <div className="space-y-2">
                              {counselors.map(counselor => (
                                <div key={counselor.id} className="flex items-center justify-between p-3 bg-white rounded border">
                                  <div>
                                    <div className="font-medium">{counselor.name}</div>
                                    <div className="text-sm text-gray-500">{counselor.email}</div>
                                  </div>
                                  <button
                                    onClick={async () => {
                                      if (!confirm(`Delete counselor ${counselor.name}?`)) return;
                                      await deleteCounselor(counselor.id, counselor.name);
                                      showToast(`Deleted ${counselor.name}`);
                                    }}
                                    className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                  >
                                    Delete
                                  </button>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </details>

                      {/* Counselor Availability */}
                      <details className="border border-green-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-green-50 font-medium flex items-center justify-between">
                          <span>üìÖ Counselor Availability ({Object.keys(availability).length} counselors)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {Object.keys(availability).length === 0 ? (
                            <p className="text-gray-500 text-sm">No availability records</p>
                          ) : (
                            <div className="space-y-2">
                              {Object.entries(availability).map(([email, dates]) => {
                                const counselor = counselors.find(c => c.email === email);
                                const counselorName = counselor ? counselor.name : email;
                                const dateCount = Object.keys(dates).length;
                                return (
                                  <div key={email} className="flex items-center justify-between p-3 bg-white rounded border">
                                    <div>
                                      <div className="font-medium">{counselorName}</div>
                                      <div className="text-sm text-gray-500">{email} - {dateCount} date(s)</div>
                                    </div>
                                    <button
                                      onClick={async () => {
                                        if (!confirm(`Delete availability for ${counselorName}?`)) return;
                                        const newAvailability = { ...availability };
                                        delete newAvailability[email];
                                        await saveAvail(newAvailability, `Deleted availability for ${counselorName}`);
                                        const newSchedule = { ...counselorSchedule };
                                        if (counselor && counselor.id) {
                                          delete newSchedule[counselor.id];
                                        } else {
                                          const validCounselorIds = counselors.map(c => c.id);
                                          Object.keys(newSchedule).forEach(scheduleId => {
                                            if (!validCounselorIds.includes(scheduleId)) {
                                              delete newSchedule[scheduleId];
                                            }
                                          });
                                        }
                                        await saveCounselorSchedule(newSchedule, `Deleted schedule for ${counselorName}`);
                                        showToast('Availability deleted');
                                      }}
                                      className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                    >
                                      Delete
                                    </button>
                                  </div>
                                );
                              })}
                            </div>
                          )}
                        </div>
                      </details>

                      {/* Counselor Schedule */}
                      <details className="border border-green-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-green-50 font-medium flex items-center justify-between">
                          <span>üìÜ Counselor Schedule ({Object.keys(counselorSchedule).length} counselors)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {Object.keys(counselorSchedule).length === 0 ? (
                            <p className="text-gray-500 text-sm">No counselor schedules</p>
                          ) : (
                            <div className="space-y-2">
                              {Object.entries(counselorSchedule).map(([counselorId, schedule]) => {
                                const counselor = counselors.find(c => c.id === counselorId);
                                const dateCount = Object.keys(schedule).length;
                                return (
                                  <div key={counselorId} className="flex items-center justify-between p-3 bg-white rounded border">
                                    <div className="flex-1">
                                      <div className="font-medium">{counselor?.name || counselorId}</div>
                                      <div className="text-sm text-gray-500">{dateCount} scheduled date(s)</div>
                                    </div>
                                    <button
                                      onClick={async () => {
                                        if (!confirm(`Delete schedule for ${counselor?.name || counselorId}?`)) return;
                                        const newSchedule = { ...counselorSchedule };
                                        delete newSchedule[counselorId];
                                        await saveCounselorSchedule(newSchedule, `Deleted schedule for ${counselor?.name}`);
                                        showToast('Schedule deleted');
                                      }}
                                      className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                    >
                                      Delete
                                    </button>
                                  </div>
                                );
                              })}
                            </div>
                          )}
                        </div>
                      </details>

                      {/* Blocked Sessions */}
                      <details className="border border-green-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-green-50 font-medium flex items-center justify-between">
                          <span>üö´ Blocked Sessions ({Object.keys(blockedSessions).length} dates)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {Object.keys(blockedSessions).length === 0 ? (
                            <p className="text-gray-500 text-sm">No blocked sessions</p>
                          ) : (
                            <div className="space-y-2">
                              {Object.entries(blockedSessions).map(([date, data]) => (
                                <div key={date} className="flex items-center justify-between p-3 bg-white rounded border">
                                  <div className="flex-1">
                                    <div className="font-medium">{date}</div>
                                    <div className="text-sm text-gray-500">{data.reason || 'No reason provided'}</div>
                                  </div>
                                  <button
                                    onClick={async () => {
                                      if (!confirm(`Unblock session on ${date}?`)) return;
                                      const newBlocked = { ...blockedSessions };
                                      delete newBlocked[date];
                                      await saveBlockedSessions(newBlocked, `Unblocked session on ${date}`);
                                      showToast('Session unblocked');
                                    }}
                                    className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                  >
                                    Delete
                                  </button>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </details>

                      {/* Camp Dates */}
                      <details className="border border-green-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-green-50 font-medium flex items-center justify-between">
                          <span>üìÖ Camp Dates (system table)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          <p className="text-gray-500 text-sm italic">This table is managed automatically by the system and should not be manually edited.</p>
                        </div>
                      </details>

                      {/* Gym Rentals */}
                      <details className="border border-green-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-green-50 font-medium flex items-center justify-between">
                          <span>üèÄ Gym Rentals ({Object.keys(gymRentals || {}).length} dates)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {Object.keys(gymRentals || {}).length === 0 ? (
                            <p className="text-gray-500 text-sm">No gym rental records</p>
                          ) : (
                            <div className="space-y-2">
                              {Object.entries(gymRentals).map(([date, data]) => (
                                <div key={date} className="flex items-center justify-between p-3 bg-white rounded border">
                                  <div className="flex-1">
                                    <div className="font-medium">{date}</div>
                                    <div className="text-sm text-gray-500">
                                      {data.morning && 'Morning'}
                                      {data.morning && data.afternoon && ' & '}
                                      {data.afternoon && 'Afternoon'}
                                    </div>
                                  </div>
                                  <button
                                    onClick={async () => {
                                      if (!confirm(`Delete gym rental on ${date}?`)) return;
                                      const newRentals = { ...gymRentals };
                                      delete newRentals[date];
                                      setGymRentals(newRentals);
                                      await storage.set('camp_gym_rentals', 'main', newRentals);
                                      addToHistory('Gym Rental Deleted', `Deleted rental on ${date}`);
                                      showToast('Gym rental deleted');
                                    }}
                                    className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                  >
                                    Delete
                                  </button>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </details>

                      {/* Website Content */}
                      <details className="border border-green-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-green-50 font-medium flex items-center justify-between">
                          <span>‚úèÔ∏è Website Content ({Object.keys(content || {}).length} fields)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {!content || Object.keys(content).length === 0 ? (
                            <p className="text-gray-500 text-sm">No content data</p>
                          ) : (
                            <div className="space-y-2">
                              <div className="p-3 bg-white rounded border">
                                <div className="text-sm font-medium text-gray-700 mb-2">Website Content Record</div>
                                <div className="grid grid-cols-2 gap-2 text-sm">
                                  <div className="text-gray-500">Camp Name:</div>
                                  <div className="truncate">{content.campName || 'N/A'}</div>
                                  <div className="text-gray-500">Session Cost:</div>
                                  <div>{content.sessionCost || 'N/A'}</div>
                                  <div className="text-gray-500">Total Fields:</div>
                                  <div>{Object.keys(content).length}</div>
                                </div>
                                <button
                                  onClick={async () => {
                                    if (!confirm('Reset website content to defaults? This will erase all customizations.')) return;
                                    await saveContent(DEFAULT_CONTENT, 'Reset content to defaults');
                                    showToast('Content reset to defaults');
                                  }}
                                  className="mt-3 w-full px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                >
                                  Reset to Defaults
                                </button>
                              </div>
                            </div>
                          )}
                        </div>
                      </details>

                      {/* Food Photos */}
                      <details className="border border-green-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-green-50 font-medium flex items-center justify-between">
                          <span>üçΩÔ∏è Food Photos ({Object.keys(foodPhotos || {}).length} photos)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {Object.keys(foodPhotos || {}).length === 0 ? (
                            <p className="text-gray-500 text-sm">No food photos</p>
                          ) : (
                            <div className="space-y-2">
                              {Object.entries(foodPhotos).map(([photoKey, photoData]) => (
                                <div key={photoKey} className="flex items-center justify-between p-3 bg-white rounded border">
                                  <div className="flex-1">
                                    <div className="font-medium">{photoKey}</div>
                                    <div className="text-sm text-gray-500">{photoData ? 'Has image' : 'No image'}</div>
                                  </div>
                                  <button
                                    onClick={async () => {
                                      if (!confirm(`Delete food photo "${photoKey}"?`)) return;
                                      const newPhotos = { ...foodPhotos };
                                      delete newPhotos[photoKey];
                                      setFoodPhotos(newPhotos);
                                      await storage.set('camp_food_photos', 'main', newPhotos);
                                      addToHistory('Food Photo Deleted', `Deleted ${photoKey}`);
                                      showToast('Photo deleted');
                                    }}
                                    className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                  >
                                    Delete
                                  </button>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </details>

                      {/* Site Photos */}
                      <details className="border border-green-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-green-50 font-medium flex items-center justify-between">
                          <span>üì∏ Site Photos ({Object.keys(sitePhotos || {}).length} photos)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {Object.keys(sitePhotos || {}).length === 0 ? (
                            <p className="text-gray-500 text-sm">No site photos</p>
                          ) : (
                            <div className="space-y-2">
                              {Object.entries(sitePhotos).map(([photoKey, photoData]) => (
                                <div key={photoKey} className="flex items-center justify-between p-3 bg-white rounded border">
                                  <div className="flex-1">
                                    <div className="font-medium">{photoKey}</div>
                                    <div className="text-sm text-gray-500">{photoData ? 'Has image' : 'No image'}</div>
                                  </div>
                                  <button
                                    onClick={async () => {
                                      if (!confirm(`Delete site photo "${photoKey}"?`)) return;
                                      const newPhotos = { ...sitePhotos };
                                      delete newPhotos[photoKey];
                                      setSitePhotos(newPhotos);
                                      await storage.set('camp_site_photos', 'main', newPhotos);
                                      addToHistory('Site Photo Deleted', `Deleted ${photoKey}`);
                                      showToast('Photo deleted');
                                    }}
                                    className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                  >
                                    Delete
                                  </button>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </details>

                      {/* Change History */}
                      <details className="border border-green-200 rounded-lg">
                        <summary className="cursor-pointer p-4 hover:bg-green-50 font-medium flex items-center justify-between">
                          <span>üìú Change History ({(changeHistory || []).length} entries)</span>
                          <span className="text-gray-400">‚ñº</span>
                        </summary>
                        <div className="p-4 bg-gray-50 max-h-96 overflow-auto">
                          {(changeHistory || []).length === 0 ? (
                            <p className="text-gray-500 text-sm">No history entries</p>
                          ) : (
                            <>
                              <button
                                onClick={async () => {
                                  if (!confirm(`Delete ALL ${changeHistory.length} history entries? This cannot be undone.`)) return;
                                  setChangeHistory([]);
                                  await storage.set('camp_change_history', 'main', []);
                                  showToast('All history deleted');
                                }}
                                className="w-full mb-3 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-medium"
                              >
                                Delete All History ({changeHistory.length} entries)
                              </button>
                              <div className="space-y-2">
                                {(changeHistory || []).slice(-20).reverse().map(entry => (
                                <div key={entry.id} className="flex items-center justify-between p-3 bg-white rounded border">
                                  <div className="flex-1">
                                    <div className="font-medium">{entry.action}</div>
                                    <div className="text-sm text-gray-500">{entry.details} ‚Ä¢ {new Date(entry.timestamp).toLocaleString()}</div>
                                  </div>
                                  <button
                                    onClick={async () => {
                                      if (!confirm(`Delete history entry "${entry.action}"?`)) return;
                                      const newHistory = changeHistory.filter(h => h.id !== entry.id);
                                      setChangeHistory(newHistory);
                                      await storage.set('camp_change_history', 'main', newHistory);
                                      showToast('History entry deleted');
                                    }}
                                    className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                  >
                                    Delete
                                  </button>
                                </div>
                              ))}
                              </div>
                            </>
                          )}
                        </div>
                      </details>
                    </div>
                  </div>

                </div>
              )}
            </div>

            <Modal isOpen={showModal} onClose={() => setShowModal(false)} title={editCounselor?.id ? 'Edit Counselor Profile' : 'Add Counselor'}>
              {editCounselor && (
                <CounselorEditForm
                  counselor={editCounselor}
                  onSave={(form) => {
                    const isNew = !editCounselor.id;
                    const updated = isNew
                      ? [...counselors, { ...form, id: 'c_' + Date.now(), order: counselors.length }]
                      : counselors.map(c => c.id === editCounselor.id ? { ...form, id: editCounselor.id } : c);
                    const action = isNew ? `Added counselor ${form.name}` : `Updated ${form.name}`;
                    saveCounselors(updated, action);
                    setShowModal(false);
                  }}
                  onCancel={() => setShowModal(false)}
                  onDelete={(c) => { setShowModal(false); setConfirmDeleteCounselor(c); }}
                />
              )}
            </Modal>

            {/* Delete Counselor Confirmation Modal */}
            {confirmDeleteCounselor && (
              <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                <div className="bg-white rounded-xl max-w-md w-full p-6 text-center" onClick={e => e.stopPropagation()}>
                  <div className="text-5xl mb-4">‚ö†Ô∏è</div>
                  <h3 className="font-bold text-xl text-red-600 mb-2">Delete Counselor</h3>
                  <p className="text-gray-600 mb-4">
                    Are you sure you want to delete <strong>{confirmDeleteCounselor.name}</strong>?
                    <br />This will also remove them from all session assignments.
                  </p>
                  <p className="text-sm text-gray-500 mb-2">Type DELETE to confirm:</p>
                  <input
                    value={deleteConfirmText}
                    onChange={e => setDeleteConfirmText(e.target.value)}
                    className="w-full px-3 py-2 border rounded-lg text-center font-mono mb-4"
                    placeholder="DELETE"
                    autoComplete="off"
                    data-1p-ignore="true"
                  />
                  <div className="flex gap-3">
                    <button onClick={() => { setConfirmDeleteCounselor(null); setDeleteConfirmText(''); }} className="flex-1 px-4 py-2 border rounded-lg">Cancel</button>
                    <button
                      onClick={async () => {
                        if (deleteConfirmText !== 'DELETE') {
                          showToast('Please type DELETE to confirm', 'error');
                          return;
                        }
                        await deleteCounselor(confirmDeleteCounselor.id, confirmDeleteCounselor.name);
                        setConfirmDeleteCounselor(null);
                        setDeleteConfirmText('');
                      }}
                      disabled={deleteConfirmText !== 'DELETE'}
                      className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-300"
                    >
                      Delete Counselor
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      };

    // ==================== ADD CHILD FORM ====================
    const AddChildForm = ({ onAdd, onCancel }) => {
      const [name, setName] = useState('');
      const [birthdate, setBirthdate] = useState('');
      const [grade, setGrade] = useState('');
      const [phone, setPhone] = useState('');
      const [photo, setPhoto] = useState(null);
      const [showCrop, setShowCrop] = useState(false);
      const [tempImg, setTempImg] = useState(null);
      const inputRef = useRef(null);

      const age = calculateAge(birthdate);

      const handleFile = (e) => {
        const file = e.target.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setTempImg(reader.result);
            setShowCrop(true);
          };
          reader.readAsDataURL(file);
        }
        if (e.target) e.target.value = '';
      };

      const handleSubmit = () => {
        if (!name || !birthdate || !grade) return;
        onAdd({ name, birthdate, grade, phone, photo });
        setName(''); setBirthdate(''); setGrade(''); setPhone(''); setPhoto(null);
      };

      if (showCrop && tempImg) {
        return (
          <ImageCropper
            image={tempImg}
            onSave={(img) => { setPhoto(img); setShowCrop(false); }}
            onCancel={() => { setShowCrop(false); setTempImg(null); }}
          />
        );
      }

      return (
        <div className="border-t pt-4 space-y-4">
          <h4 className="font-medium text-lg">Add Child Profile</h4>
          <p className="text-sm text-gray-500 -mt-2">Create a profile for your child. You'll register them for camp sessions separately.</p>

          {/* Photo Upload with Face Silhouette Placeholder */}
          <div className="flex justify-center">
            {getDisplayPhoto(photo) ? (
              <div className="relative">
                <img src={getDisplayPhoto(photo)} className="w-24 h-24 rounded-full object-cover border-2 border-green-600" />
                <button onClick={() => inputRef.current?.click()}
                  className="absolute -bottom-1 -right-1 w-8 h-8 bg-green-600 rounded-full text-white flex items-center justify-center text-sm">‚úé</button>
                <button onClick={() => setPhoto(null)}
                  className="absolute -top-1 -right-1 w-6 h-6 bg-red-500 rounded-full text-white text-xs flex items-center justify-center">√ó</button>
              </div>
            ) : (
              <div
                onClick={() => inputRef.current?.click()}
                className="w-24 h-24 rounded-full bg-gray-200 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300"
              >
                <svg className="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                <span className="text-[8px] text-gray-500 font-medium">add photo</span>
              </div>
            )}
            <input ref={inputRef} type="file" accept="image/*" onChange={handleFile} className="hidden" />
          </div>
          <p className="text-xs text-gray-500 text-center">Photo helps us recognize your child at camp</p>

          {/* Name */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Child's Name *</label>
            <input value={name} onChange={e => setName(e.target.value)}
              className="w-full px-3 py-2 border rounded-lg" placeholder="Full name"
              autoComplete="off" data-1p-ignore="true" data-lpignore="true" data-form-type="other" />
          </div>

          {/* Birthdate & Calculated Age */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Birthdate *</label>
              <input type="date" value={birthdate} onChange={e => setBirthdate(e.target.value)}
                className="w-full px-3 py-2 border rounded-lg"
                min={new Date(new Date().getFullYear() - 25, 0, 1).toISOString().split('T')[0]}
                max={new Date(new Date().getFullYear() - 14, 11, 31).toISOString().split('T')[0]}
                data-1p-ignore="true" data-lpignore="true" data-form-type="other" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Age</label>
              <div className="w-full px-3 py-2 border rounded-lg bg-gray-50 text-gray-700">
                {age !== null ? `${age} years old` : 'Select birthdate'}
              </div>
            </div>
          </div>

          {/* Grade */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Grade (Fall 2026) *</label>
            <select value={grade} onChange={e => setGrade(e.target.value)}
              className="w-full px-3 py-2 border rounded-lg">
              <option value="">Select grade</option>
              <option value="3rd">3rd Grade</option>
              <option value="4th">4th Grade</option>
              <option value="5th">5th Grade</option>
              <option value="6th">6th Grade</option>
              <option value="7th">7th Grade</option>
              <option value="8th">8th Grade</option>
            </select>
          </div>

          {/* Phone (optional) */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Child's Phone <span className="text-gray-400">(optional)</span>
            </label>
            <input value={phone} onChange={e => setPhone(formatPhone(e.target.value))}
              className="w-full px-3 py-2 border rounded-lg" placeholder="(555) 555-1234"
              autoComplete="off" data-1p-ignore="true" data-lpignore="true" data-form-type="other" />
            <p className="text-xs text-gray-500 mt-1">If your child has a phone for emergencies</p>
          </div>

          {/* Buttons */}
          <div className="flex gap-4 pt-4">
            {onCancel && <button onClick={onCancel} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>}
            <button onClick={handleSubmit} disabled={!name || !birthdate || !grade}
              className="flex-1 py-2 bg-green-600 text-white rounded-lg disabled:bg-gray-300 hover:bg-green-700 disabled:hover:bg-gray-300">
              Add Child
            </button>
          </div>
        </div>
      );
    };

    // ==================== CHILD CARD ====================
    const ChildCard = ({ child, onUpdate, onDelete }) => {
      const inputRef = useRef(null);
      const [tempImg, setTempImg] = useState(null);
      const [showCrop, setShowCrop] = useState(false);
      const [isEditing, setIsEditing] = useState(false);
      const [editForm, setEditForm] = useState({ ...child });
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
      const age = calculateAge(child.birthdate);

      const handleFile = (e) => {
        const file = e.target.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => { setTempImg(reader.result); setShowCrop(true); };
          reader.readAsDataURL(file);
        }
        if (e.target) e.target.value = '';
      };

      const handleSaveEdit = () => {
        if (!editForm.name || !editForm.birthdate || !editForm.grade) return;
        onUpdate({ ...child, ...editForm });
        setIsEditing(false);
      };

      const handleCancelEdit = () => {
        setEditForm({ ...child });
        setIsEditing(false);
      };

      if (showCrop && tempImg) {
        return (
          <div className="border rounded-lg p-4">
            <ImageCropper
              image={tempImg}
              onSave={(img) => {
                if (isEditing) {
                  setEditForm({ ...editForm, photo: img });
                } else {
                  onUpdate({ ...child, photo: img });
                }
                setShowCrop(false);
              }}
              onCancel={() => { setShowCrop(false); setTempImg(null); }}
            />
          </div>
        );
      }

      // Delete confirmation dialog
      if (showDeleteConfirm) {
        return (
          <div className="border-2 border-red-300 bg-red-50 rounded-lg p-4">
            <div className="text-center">
              <div className="text-4xl mb-2">‚ö†Ô∏è</div>
              <h4 className="font-bold text-red-800 mb-2">Delete {child.name}?</h4>
              <p className="text-sm text-red-600 mb-4">
                This will permanently remove this child from your account.
                Any existing registrations will remain in the system.
              </p>
              <div className="flex gap-3 justify-center">
                <button
                  onClick={() => setShowDeleteConfirm(false)}
                  className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                >
                  Cancel
                </button>
                <button
                  onClick={() => { onDelete(child.id); setShowDeleteConfirm(false); }}
                  className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                >
                  Yes, Delete
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Edit mode
      if (isEditing) {
        return (
          <div className="border-2 border-blue-300 bg-blue-50 rounded-lg p-4">
            <h4 className="font-bold text-blue-800 mb-4">‚úèÔ∏è Edit Child Details</h4>

            {/* Photo */}
            <div className="flex justify-center mb-4">
              {getDisplayPhoto(editForm.photo) ? (
                <div className="relative">
                  <img src={getDisplayPhoto(editForm.photo)} className="w-20 h-20 rounded-full object-cover border-2 border-blue-400" />
                  <button onClick={() => inputRef.current?.click()}
                    className="absolute -bottom-1 -right-1 w-6 h-6 bg-blue-600 rounded-full text-white text-xs flex items-center justify-center">‚úé</button>
                  <button onClick={() => setEditForm({ ...editForm, photo: null })}
                    className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-white text-xs flex items-center justify-center">√ó</button>
                </div>
              ) : (
                <div onClick={() => inputRef.current?.click()}
                  className="w-20 h-20 rounded-full bg-gray-200 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300">
                  <svg className="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                  <span className="text-[8px] text-gray-500 font-medium">add photo</span>
                </div>
              )}
              <input ref={inputRef} type="file" accept="image/*" onChange={handleFile} className="hidden" />
            </div>

            <div className="space-y-3">
              {/* Name */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                <input
                  value={editForm.name || ''}
                  onChange={e => setEditForm({ ...editForm, name: e.target.value })}
                  className="w-full px-3 py-2 border rounded-lg"
                  placeholder="Child's name"
                  autoComplete="off"
                  data-1p-ignore="true"
                />
              </div>

              {/* Birthdate & Age */}
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Birthdate *</label>
                  <input
                    type="date"
                    value={editForm.birthdate || ''}
                    onChange={e => setEditForm({ ...editForm, birthdate: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                    min={new Date(new Date().getFullYear() - 25, 0, 1).toISOString().split('T')[0]}
                    max={new Date(new Date().getFullYear() - 14, 11, 31).toISOString().split('T')[0]}
                    data-1p-ignore="true"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Age</label>
                  <div className="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-700">
                    {calculateAge(editForm.birthdate) !== null ? `${calculateAge(editForm.birthdate)} years old` : 'Select birthdate'}
                  </div>
                </div>
              </div>

              {/* Grade */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Grade (Fall 2026) *</label>
                <select
                  value={editForm.grade || ''}
                  onChange={e => setEditForm({ ...editForm, grade: e.target.value })}
                  className="w-full px-3 py-2 border rounded-lg"
                >
                  <option value="">Select grade</option>
                  <option value="3rd">3rd Grade</option>
                  <option value="4th">4th Grade</option>
                  <option value="5th">5th Grade</option>
                  <option value="6th">6th Grade</option>
                  <option value="7th">7th Grade</option>
                  <option value="8th">8th Grade</option>
                </select>
              </div>

              {/* Phone */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Child's Phone (optional)</label>
                <input
                  value={editForm.phone || ''}
                  onChange={e => setEditForm({ ...editForm, phone: formatPhone(e.target.value) })}
                  className="w-full px-3 py-2 border rounded-lg"
                  placeholder="(555) 555-1234"
                  autoComplete="off"
                  data-1p-ignore="true"
                />
              </div>

              {/* Buttons */}
              <div className="flex gap-3 pt-2">
                <button onClick={handleCancelEdit} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                  Cancel
                </button>
                <button
                  onClick={handleSaveEdit}
                  disabled={!editForm.name || !editForm.birthdate || !editForm.grade}
                  className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300"
                >
                  Save Changes
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Normal display mode
      return (
        <div className="border rounded-lg p-4 flex items-start gap-4">
          {/* Photo with edit button or face placeholder */}
          <div className="flex-shrink-0">
            {getDisplayPhoto(child.photo) ? (
              <div className="relative">
                <img src={getDisplayPhoto(child.photo)} className="w-20 h-20 rounded-full object-cover border-2 border-green-600" />
                <button onClick={() => inputRef.current?.click()}
                  className="absolute -bottom-1 -right-1 w-6 h-6 bg-green-600 rounded-full text-white text-xs flex items-center justify-center">‚úé</button>
              </div>
            ) : (
              <div onClick={() => inputRef.current?.click()}
                className="w-20 h-20 rounded-full bg-gray-200 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300">
                <svg className="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                <span className="text-[8px] text-gray-500 font-medium">add photo</span>
              </div>
            )}
            <input ref={inputRef} type="file" accept="image/*" onChange={handleFile} className="hidden" />
          </div>

          {/* Info */}
          <div className="flex-1">
            <div className="font-bold text-lg">{child.name}</div>
            <div className="text-sm text-gray-600 space-y-1">
              {child.grade && <div>Grade: {child.grade}</div>}
              {child.birthdate && (
                <div>
                  Birthday: {formatBirthdate(child.birthdate)}
                  {age !== null && <span className="text-green-600 font-medium"> ({age} years old)</span>}
                </div>
              )}
              {child.phone && <div>Phone: {child.phone}</div>}
            </div>
          </div>

          {/* Action buttons */}
          <div className="flex flex-col gap-2">
            <button
              onClick={() => { setEditForm({ ...child }); setIsEditing(true); }}
              className="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 text-sm"
            >
              ‚úèÔ∏è Edit
            </button>
            <button
              onClick={() => setShowDeleteConfirm(true)}
              className="px-3 py-1.5 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 text-sm"
            >
              üóëÔ∏è Delete
            </button>
          </div>
        </div>
      );
    };

    // ==================== CHILDREN MANAGER (Parent Dashboard) ====================
    const ChildrenManager = ({ children, onUpdate, onDelete, onAdd, registrations }) => {
      const [showAddForm, setShowAddForm] = useState(false);

      // Check if child has any registrations (is a camper)
      const isCamper = (childId) => registrations?.some(r => r.childId === childId);

      return (
        <div className="space-y-4">
          {children.map(child => (
            <div key={child.id} className="relative">
              <ChildCard
                child={child}
                onUpdate={onUpdate}
                onDelete={onDelete}
              />
              {isCamper(child.id) && (
                <div className="absolute top-2 right-2">
                  <span className="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full font-medium">
                    üèïÔ∏è Registered Camper
                  </span>
                </div>
              )}
            </div>
          ))}

          {showAddForm ? (
            <div className="border-t pt-4 mt-4">
              <AddChildForm
                onAdd={(child) => {
                  onAdd(child);
                  setShowAddForm(false);
                }}
                onCancel={() => setShowAddForm(false)}
              />
            </div>
          ) : (
            <button
              onClick={() => setShowAddForm(true)}
              className="w-full py-4 border-2 border-dashed border-green-300 rounded-xl text-green-600 hover:bg-green-50 hover:border-green-400 transition-colors flex items-center justify-center gap-2 font-medium"
            >
              <span className="text-xl">+</span>
              <span>Add Another Child</span>
            </button>
          )}
        </div>
      );
    };

    // ==================== PARENT EMERGENCY CONTACTS MANAGER ====================
    const ParentEmergencyContactsManager = ({ parentEmail, emergencyContacts, onSave, showToast }) => {
      const [localContacts, setLocalContacts] = useState([]);
      const [editingId, setEditingId] = useState(null);
      const [showAddForm, setShowAddForm] = useState(false);
      const [editForm, setEditForm] = useState({ name: '', relationship: '', phone: '', email: '', priority: 'normal' });
      const [hasChanges, setHasChanges] = useState(false);

      // Initialize local contacts from props
      useEffect(() => {
        const myContacts = emergencyContacts.filter(c => c.userEmail === parentEmail);
        setLocalContacts(myContacts);
      }, [emergencyContacts, parentEmail]);

      // Check if requirements are met
      const meetsRequirements = () => {
        return localContacts.length >= 2;
      };

      const handleEdit = (contact) => {
        setEditingId(contact.id);
        setEditForm({
          name: contact.name,
          relationship: contact.relationship,
          phone: contact.phone,
          email: contact.email || '',
          priority: contact.priority || 'normal'
        });
      };

      const handleSaveEdit = () => {
        if (!editForm.name || !editForm.relationship || !editForm.phone) {
          showToast('Please fill in all required fields', 'error');
          return;
        }
        const updatedContacts = localContacts.map(c =>
          c.id === editingId ? { ...c, ...editForm } : c
        );
        setLocalContacts(updatedContacts);
        setEditingId(null);
        setEditForm({ name: '', relationship: '', phone: '', email: '', priority: 'normal' });
        setHasChanges(true);
      };

      const handleDelete = (id) => {
        if (!confirm('Delete this emergency contact?')) return;
        setLocalContacts(localContacts.filter(c => c.id !== id));
        setHasChanges(true);
      };

      const handleAdd = () => {
        if (!editForm.name || !editForm.relationship || !editForm.phone) {
          showToast('Please fill in all required fields', 'error');
          return;
        }
        const newContact = {
          id: `ec_${Date.now()}`,
          userEmail: parentEmail,
          ...editForm
        };
        setLocalContacts([...localContacts, newContact]);
        setShowAddForm(false);
        setEditForm({ name: '', relationship: '', phone: '', email: '', priority: 'normal' });
        setHasChanges(true);
      };

      const handleSaveChanges = () => {
        if (!meetsRequirements()) {
          showToast('You must have at least 2 emergency contacts', 'error');
          return;
        }
        // Merge local contacts with other users' contacts
        const otherContacts = emergencyContacts.filter(c => c.userEmail !== parentEmail);
        const allContacts = [...otherContacts, ...localContacts];
        onSave(allContacts);
        setHasChanges(false);
      };

      const handleCancel = () => {
        const myContacts = emergencyContacts.filter(c => c.userEmail === parentEmail);
        setLocalContacts(myContacts);
        setHasChanges(false);
        setEditingId(null);
        setShowAddForm(false);
      };

      const requirementsMet = meetsRequirements();

      return (
        <div className="space-y-4">
          {/* Contact List */}
          {localContacts.length === 0 ? (
            <p className="text-gray-500 text-center py-4">No emergency contacts yet. Add at least 2 contacts.</p>
          ) : (
            <div className="space-y-2">
              {localContacts.map(contact => (
                <div key={contact.id} className="border rounded-lg p-4">
                  {editingId === contact.id ? (
                    <div className="space-y-3">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                        <input
                          value={editForm.name}
                          onChange={e => setEditForm({ ...editForm, name: e.target.value })}
                          className="w-full px-3 py-2 border rounded-lg"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Relationship *</label>
                        <input
                          value={editForm.relationship}
                          onChange={e => setEditForm({ ...editForm, relationship: e.target.value })}
                          className="w-full px-3 py-2 border rounded-lg"
                          placeholder="e.g., Grandparent, Neighbor, Friend"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                        <input
                          value={editForm.phone}
                          onChange={e => setEditForm({ ...editForm, phone: formatPhone(e.target.value) })}
                          className="w-full px-3 py-2 border rounded-lg"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input
                          value={editForm.email}
                          onChange={e => setEditForm({ ...editForm, email: e.target.value })}
                          className="w-full px-3 py-2 border rounded-lg"
                        />
                      </div>
                      <div className="flex gap-2">
                        <button
                          onClick={handleSaveEdit}
                          className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                        >
                          Save
                        </button>
                        <button
                          onClick={() => {
                            setEditingId(null);
                            setEditForm({ name: '', relationship: '', phone: '', email: '', priority: 'normal' });
                          }}
                          className="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  ) : (
                    <div className="flex justify-between items-start">
                      <div>
                        <div className="font-medium">{contact.name}</div>
                        <div className="text-sm text-gray-600">{contact.relationship}</div>
                        <div className="text-sm text-gray-600">{contact.phone}</div>
                        {contact.email && <div className="text-sm text-gray-600">{contact.email}</div>}
                      </div>
                      <div className="flex gap-2">
                        <button
                          onClick={() => handleEdit(contact)}
                          className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"
                        >
                          Edit
                        </button>
                        <button
                          onClick={() => handleDelete(contact.id)}
                          className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}

          {/* Add New Contact Form */}
          {showAddForm ? (
            <div className="border-2 border-green-300 rounded-lg p-4 space-y-3 bg-green-50">
              <h4 className="font-medium">Add Emergency Contact</h4>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                <input
                  value={editForm.name}
                  onChange={e => setEditForm({ ...editForm, name: e.target.value })}
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Relationship *</label>
                <input
                  value={editForm.relationship}
                  onChange={e => setEditForm({ ...editForm, relationship: e.target.value })}
                  className="w-full px-3 py-2 border rounded-lg"
                  placeholder="e.g., Grandparent, Neighbor, Friend"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                <input
                  value={editForm.phone}
                  onChange={e => setEditForm({ ...editForm, phone: formatPhone(e.target.value) })}
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input
                  value={editForm.email}
                  onChange={e => setEditForm({ ...editForm, email: e.target.value })}
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>
              <div className="flex gap-2">
                <button
                  onClick={handleAdd}
                  className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                >
                  Add Contact
                </button>
                <button
                  onClick={() => {
                    setShowAddForm(false);
                    setEditForm({ name: '', relationship: '', phone: '', email: '', priority: 'normal' });
                  }}
                  className="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                >
                  Cancel
                </button>
              </div>
            </div>
          ) : (
            <button
              onClick={() => setShowAddForm(true)}
              className="w-full py-3 border-2 border-dashed border-green-300 rounded-lg text-green-600 hover:bg-green-50 hover:border-green-400"
            >
              + Add Emergency Contact
            </button>
          )}

          {/* Save/Cancel Changes */}
          {hasChanges && (
            <div className="flex gap-2 pt-4 border-t">
              <button
                onClick={handleSaveChanges}
                disabled={!requirementsMet}
                className="flex-1 px-4 py-3 bg-green-700 text-white rounded-lg hover:bg-green-800 disabled:bg-gray-300 disabled:cursor-not-allowed font-medium"
              >
                {requirementsMet ? 'Save Changes' : 'Cannot Save - Requirements Not Met'}
              </button>
              <button
                onClick={handleCancel}
                className="px-4 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
              >
                Cancel
              </button>
            </div>
          )}
        </div>
      );
    };

    // ==================== REGISTRATION CALENDAR VIEW ====================
    const RegistrationCalendarView = ({ myChildren, registrations }) => {
      const [selectedChild, setSelectedChild] = useState(myChildren[0]?.id || 'all');

      // Get all registration dates for selected child or all children
      const getRegistrationsForDisplay = () => {
        if (selectedChild === 'all') {
          return registrations;
        }
        return registrations.filter(r => r.childId === selectedChild);
      };

      const displayRegs = getRegistrationsForDisplay();

      // Generate calendar for July, August 2026
      const months = [
        { name: 'July', year: 2026, month: 6 },
        { name: 'August', year: 2026, month: 7 }
      ];

      const getDaysInMonth = (year, month) => {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDayOfWeek = firstDay.getDay(); // 0 = Sunday

        const days = [];
        // Add empty cells for days before month starts
        for (let i = 0; i < startDayOfWeek; i++) {
          days.push(null);
        }
        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
          days.push(day);
        }
        return days;
      };

      const getRegistrationForDate = (year, month, day) => {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        return displayRegs.filter(r => r.date === dateStr);
      };

      const getStatusColor = (status) => {
        if (status === 'approved') return 'bg-green-500';
        if (status === 'pending') return 'bg-yellow-500';
        if (status === 'rejected') return 'bg-red-500';
        return 'bg-gray-300';
      };

      const getStatusText = (status) => {
        if (status === 'approved') return 'Approved';
        if (status === 'pending') return 'Pending';
        if (status === 'rejected') return 'Rejected';
        return '';
      };

      if (myChildren.length === 0) {
        return (
          <div className="bg-white rounded-xl shadow p-8 text-center">
            <div className="text-6xl mb-4">üìÖ</div>
            <h3 className="font-bold text-lg text-gray-800 mb-2">No Campers Yet</h3>
            <p className="text-gray-500">Add campers to see their registration calendar</p>
          </div>
        );
      }

      return (
        <div className="bg-white rounded-xl shadow p-6">
          <div className="mb-6">
            <h3 className="font-bold text-xl mb-2">üìÖ Registration Calendar</h3>
            <p className="text-sm text-gray-500 mb-4">View registration status across July and August</p>

            {/* Child Selector */}
            <div className="flex gap-2 flex-wrap mb-4">
              <button
                onClick={() => setSelectedChild('all')}
                className={`px-4 py-2 rounded-lg font-medium ${
                  selectedChild === 'all'
                    ? 'bg-green-600 text-white'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                All Campers
              </button>
              {myChildren.map(child => (
                <button
                  key={child.id}
                  onClick={() => setSelectedChild(child.id)}
                  className={`px-4 py-2 rounded-lg font-medium ${
                    selectedChild === child.id
                      ? 'bg-green-600 text-white'
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  {child.name}
                </button>
              ))}
            </div>

            {/* Legend */}
            <div className="flex flex-wrap gap-4 text-sm mb-4 p-3 bg-gray-50 rounded-lg">
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-green-500 rounded"></div>
                <span>Approved</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-yellow-500 rounded"></div>
                <span>Pending</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-red-500 rounded"></div>
                <span>Rejected</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-gray-100 border border-gray-300 rounded"></div>
                <span>Not Registered</span>
              </div>
            </div>
          </div>

          {/* Calendar Grid */}
          <div className="grid md:grid-cols-3 gap-6">
            {months.map(({ name, year, month }) => {
              const days = getDaysInMonth(year, month);
              return (
                <div key={`${year}-${month}`} className="border rounded-lg overflow-hidden">
                  <div className="bg-green-700 text-white text-center py-2 font-bold">
                    {name} {year}
                  </div>
                  <div className="grid grid-cols-7 gap-1 p-2">
                    {/* Day headers */}
                    {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((d, i) => (
                      <div key={i} className="text-center text-xs font-medium text-gray-500 py-1">
                        {d}
                      </div>
                    ))}
                    {/* Days */}
                    {days.map((day, i) => {
                      if (day === null) {
                        return <div key={`empty-${i}`} className="aspect-square"></div>;
                      }
                      const regs = getRegistrationForDate(year, month, day);
                      const hasRegistrations = regs.length > 0;

                      return (
                        <div
                          key={day}
                          className={`aspect-square flex flex-col items-center justify-center text-xs rounded relative group cursor-pointer ${
                            hasRegistrations
                              ? regs.some(r => r.status === 'approved')
                                ? 'bg-green-100 border-2 border-green-500 font-bold'
                                : regs.some(r => r.status === 'pending')
                                ? 'bg-yellow-100 border-2 border-yellow-500 font-bold'
                                : 'bg-red-100 border-2 border-red-500 font-bold'
                              : 'bg-gray-50 border border-gray-200'
                          }`}
                        >
                          <span className={hasRegistrations ? 'text-gray-800' : 'text-gray-500'}>
                            {day}
                          </span>
                          {hasRegistrations && (
                            <>
                              <div className="text-[8px] leading-none mt-1">
                                {regs.flatMap(r => r.sessions || []).map(s => s === 'morning' ? 'AM' : 'PM').join(' ')}
                              </div>
                              {/* Tooltip on hover */}
                              <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 hidden group-hover:block z-10 w-48">
                                <div className="bg-gray-900 text-white text-xs rounded-lg p-2 shadow-lg">
                                  {regs.map((reg, idx) => (
                                    <div key={idx} className="mb-1 last:mb-0">
                                      <div className="font-bold">{reg.childName || myChildren.find(c => c.id === reg.childId)?.name}</div>
                                      <div>{reg.sessions?.map(s => s === 'morning' ? 'AM' : 'PM').join(' + ')}</div>
                                      <div className={`text-xs ${
                                        reg.status === 'approved' ? 'text-green-300' :
                                        reg.status === 'pending' ? 'text-yellow-300' :
                                        'text-red-300'
                                      }`}>
                                        {getStatusText(reg.status)}
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            </>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    };

    // ==================== CAMPER SCHEDULE TAB (Visual Schedule for Parents) ====================
    const CamperScheduleTab = ({ myChildren, registrations, allRegistrations, assignments, counselors, campers, users }) => {
      const [selectedChild, setSelectedChild] = useState(myChildren[0]?.id || null);

      // Get registrations for selected child
      const childRegs = registrations.filter(r => r.childId === selectedChild);

      // Group registrations by date
      const regsByDate = {};
      childRegs.forEach(reg => {
        if (!regsByDate[reg.date]) regsByDate[reg.date] = [];
        regsByDate[reg.date].push(reg);
      });

      // Sort dates
      const sortedDates = Object.keys(regsByDate).sort();

      // Get counselor for a specific session
      const getCounselorForSession = (childId, date, session) => {
        const sessionKey = `${date}_${session}`;
        const sessionPods = assignments[sessionKey];
        if (!sessionPods) return null;

        // Find the pod that contains this child
        for (const [podId, pod] of Object.entries(sessionPods)) {
          if (pod.camperIds?.includes(childId)) {
            return counselors.find(c => c.id === pod.counselorId);
          }
        }
        return null;
      };

      // Get pod mates (other campers with same counselor for a session)
      const getPodMates = (childId, date, session, counselorId) => {
        if (!counselorId) return [];
        const sessionKey = `${date}_${session}`;
        const sessionPods = assignments[sessionKey];
        if (!sessionPods) return [];

        // Find the pod with this counselor that contains this child
        for (const [podId, pod] of Object.entries(sessionPods)) {
          if (pod.counselorId === counselorId && pod.camperIds?.includes(childId)) {
            // Get all other campers in this pod
            const otherCamperIds = pod.camperIds.filter(id => id !== childId);
            return otherCamperIds.map(camperId => {
              // Try to find in campers first, then in users' children
              const camper = campers.find(c => c.id === camperId);
              if (camper) return camper;

              for (const user of users) {
                const child = user.children?.find(c => c.id === camperId);
                if (child) return child;
              }
              return null;
            }).filter(Boolean);
          }
        }
        return [];
      };

      // Get all campers at camp for a session (not just pod)
      const getAllCampersForSession = (date, session, excludeChildId) => {
        const sessionRegs = allRegistrations.filter(r =>
          r.date === date &&
          r.sessions?.includes(session) &&
          r.childId !== excludeChildId &&
          (r.status === 'approved' || r.status === 'pending')
        );
        return sessionRegs.map(r => {
          const camper = campers.find(c => c.id === r.childId);
          if (camper) return { ...camper, status: r.status };

          for (const user of users) {
            const child = user.children?.find(c => c.id === r.childId);
            if (child) return { ...child, status: r.status };
          }
          return { name: r.childName, status: r.status };
        }).filter(Boolean);
      };

      const selectedChildData = myChildren.find(c => c.id === selectedChild);

      if (myChildren.length === 0) {
        return (
          <div className="bg-white rounded-xl shadow p-8 text-center">
            <div className="text-6xl mb-4">üë∂</div>
            <h3 className="font-bold text-lg text-gray-800 mb-2">No Children Yet</h3>
            <p className="text-gray-500">Add campers in the "My Campers" tab, then register them for camp.</p>
          </div>
        );
      }

      if (childRegs.length === 0) {
        return (
          <div className="space-y-6">
            {myChildren.length > 1 && (
              <div className="bg-white rounded-xl shadow p-4">
                <div className="flex gap-2 flex-wrap">
                  {myChildren.map(child => (
                    <button
                      key={child.id}
                      onClick={() => setSelectedChild(child.id)}
                      className={`px-4 py-2 rounded-lg flex items-center gap-2 ${
                        selectedChild === child.id
                          ? 'bg-green-600 text-white'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      {getDisplayPhoto(child.photo) ? (
                        <img src={getDisplayPhoto(child.photo)} className="w-6 h-6 rounded-full object-cover" />
                      ) : (
                        <div className="w-6 h-6 rounded-full bg-gray-200 flex flex-col items-center justify-center">
                          <svg className="w-3 h-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                          <span className="text-[5px] text-gray-500 font-medium">add photo</span>
                        </div>
                      )}
                      {child.name}
                    </button>
                  ))}
                </div>
              </div>
            )}
            <div className="bg-white rounded-xl shadow p-8 text-center">
              <div className="text-6xl mb-4">üìÖ</div>
              <h3 className="font-bold text-lg text-gray-800 mb-2">No Sessions Registered</h3>
              <p className="text-gray-500">{selectedChildData?.name || 'Your child'} hasn't been registered for any camp sessions yet.</p>
              <p className="text-sm text-gray-400 mt-2">Go to the "Register" tab to sign up for sessions.</p>
            </div>
          </div>
        );
      }

      return (
        <div className="space-y-6">
          {/* Child Selector */}
          {myChildren.length > 1 && (
            <div className="bg-white rounded-xl shadow p-4">
              <div className="flex gap-2 flex-wrap">
                {myChildren.map(child => {
                  const hasRegs = registrations.some(r => r.childId === child.id);
                  return (
                    <button
                      key={child.id}
                      onClick={() => setSelectedChild(child.id)}
                      className={`px-4 py-2 rounded-lg flex items-center gap-2 ${
                        selectedChild === child.id
                          ? 'bg-green-600 text-white'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      {getDisplayPhoto(child.photo) ? (
                        <img src={getDisplayPhoto(child.photo)} className="w-6 h-6 rounded-full object-cover" />
                      ) : (
                        <div className="w-6 h-6 rounded-full bg-gray-200 flex flex-col items-center justify-center">
                          <svg className="w-3 h-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                          <span className="text-[5px] text-gray-500 font-medium">add photo</span>
                        </div>
                      )}
                      {child.name}
                      {hasRegs && <span className="text-xs opacity-75">üèïÔ∏è</span>}
                    </button>
                  );
                })}
              </div>
            </div>
          )}

          {/* Selected Child Header */}
          <div className="bg-gradient-to-r from-green-600 to-green-700 rounded-xl shadow p-6 text-white">
            <div className="flex items-center gap-4">
              {getDisplayPhoto(selectedChildData?.photo) ? (
                <img src={getDisplayPhoto(selectedChildData.photo)} className="w-20 h-20 rounded-full object-cover border-4 border-white/30" />
              ) : (
                <div className="w-20 h-20 rounded-full bg-gray-200 flex flex-col items-center justify-center">
                  <svg className="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                  <span className="text-[8px] text-gray-500 font-medium">add photo</span>
                </div>
              )}
              <div>
                <h2 className="font-display text-2xl">{selectedChildData?.name}'s Camp Schedule</h2>
                <p className="text-green-100">{childRegs.length} session{childRegs.length !== 1 ? 's' : ''} registered</p>
              </div>
            </div>
          </div>

          {/* Schedule by Date */}
          <div className="space-y-4">
            {sortedDates.map(date => {
              const dateRegs = regsByDate[date];
              const d = new Date(date + 'T12:00:00');
              const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][d.getDay()];
              const monthName = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][d.getMonth()];

              return (
                <div key={date} className="bg-white rounded-xl shadow overflow-hidden">
                  <div className="bg-gray-100 px-6 py-3 border-b">
                    <h3 className="font-bold text-gray-800">{dayName}, {monthName} {d.getDate()}</h3>
                  </div>

                  <div className="p-4 space-y-4">
                    {dateRegs.flatMap(reg => reg.sessions || []).sort().map(session => {
                      const reg = dateRegs.find(r => r.sessions?.includes(session));
                      const counselor = getCounselorForSession(selectedChild, date, session);
                      const podMates = counselor ? getPodMates(selectedChild, date, session, counselor.id) : [];
                      const otherCampers = getAllCampersForSession(date, session, selectedChild);
                      const isPending = reg?.status === 'pending';

                      return (
                        <div key={session} className={`border rounded-xl p-4 ${isPending ? 'border-yellow-300 bg-yellow-50' : 'border-green-200 bg-green-50'}`}>
                          <div className="flex justify-between items-start mb-4">
                            <div className="flex items-center gap-3">
                              <div className={`w-12 h-12 rounded-lg flex items-center justify-center text-2xl ${session === 'morning' ? 'bg-yellow-400' : 'bg-blue-400'}`}>
                                {session === 'morning' ? 'üåÖ' : 'üåÜ'}
                              </div>
                              <div>
                                <h4 className="font-bold text-gray-800">{session === 'morning' ? 'Morning Session' : 'Afternoon Session'}</h4>
                                <p className="text-sm text-gray-500">{session === 'morning' ? '9:00 AM - 12:00 PM' : '12:00 PM - 3:00 PM'}</p>
                              </div>
                            </div>
                            <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                              isPending
                                ? 'bg-yellow-200 text-yellow-800'
                                : 'bg-green-200 text-green-800'
                            }`}>
                              {isPending ? '‚è≥ Pending Approval' : '‚úì Approved'}
                            </span>
                          </div>

                          {/* Counselor/Pod Section */}
                          {counselor ? (
                            <div className="mb-4">
                              <h5 className="text-sm font-medium text-gray-600 mb-2">Your Pod</h5>
                              <div className="bg-white rounded-lg p-4 border">
                                <div className="flex items-center gap-4 mb-3">
                                  {getDisplayPhoto(counselor.photo) ? (
                                    <img src={getDisplayPhoto(counselor.photo)} className="w-16 h-16 rounded-full object-cover border-2 border-green-400" />
                                  ) : (
                                    <div className="w-16 h-16 rounded-full bg-gray-200 flex flex-col items-center justify-center">
                                      <svg className="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                                      <span className="text-[8px] text-gray-500 font-medium">add photo</span>
                                    </div>
                                  )}
                                  <div>
                                    <p className="font-bold text-gray-800">{counselor.name}</p>
                                    <p className="text-sm text-green-600">Your Counselor</p>
                                    {counselor.position && <p className="text-xs text-gray-500">{counselor.position}</p>}
                                  </div>
                                </div>

                                {podMates.length > 0 && (
                                  <div>
                                    <p className="text-xs text-gray-500 mb-2">Pod Mates ({podMates.length}):</p>
                                    <div className="flex flex-wrap gap-2">
                                      {podMates.map((mate, idx) => (
                                        <div key={idx} className="flex items-center gap-2 bg-gray-50 rounded-lg px-2 py-1">
                                          {getDisplayPhoto(mate.photo) ? (
                                            <img src={getDisplayPhoto(mate.photo)} className="w-8 h-8 rounded-full object-cover" />
                                          ) : (
                                            <div className="w-8 h-8 rounded-full bg-gray-200 flex flex-col items-center justify-center">
                                              <svg className="w-3 h-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                                              <span className="text-[5px] text-gray-500 font-medium">add photo</span>
                                            </div>
                                          )}
                                          <span className="text-sm">{mate.name}</span>
                                        </div>
                                      ))}
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>
                          ) : (
                            <div className="mb-4 p-4 bg-gray-100 rounded-lg text-center text-gray-500">
                              <p className="text-sm">Pod assignment pending</p>
                              <p className="text-xs">Counselor will be assigned soon!</p>
                            </div>
                          )}

                          {/* Other Campers at Camp */}
                          {otherCampers.length > 0 && (
                            <div>
                              <h5 className="text-sm font-medium text-gray-600 mb-2">Other Campers at Camp ({otherCampers.length})</h5>
                              <div className="flex flex-wrap gap-2">
                                {otherCampers.slice(0, 12).map((camper, idx) => (
                                  <div key={idx} className="flex items-center gap-1 bg-white rounded-full px-2 py-1 border">
                                    {getDisplayPhoto(camper.photo) ? (
                                      <img src={getDisplayPhoto(camper.photo)} className="w-6 h-6 rounded-full object-cover" />
                                    ) : (
                                      <div className="w-6 h-6 rounded-full bg-gray-200 flex flex-col items-center justify-center">
                                        <svg className="w-3 h-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>
                                        <span className="text-[5px] text-gray-500 font-medium">add photo</span>
                                      </div>
                                    )}
                                    <span className="text-xs">{camper.name?.split(' ')[0]}</span>
                                  </div>
                                ))}
                                {otherCampers.length > 12 && (
                                  <span className="text-xs text-gray-500 self-center">+{otherCampers.length - 12} more</span>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    };

    // ==================== CAMPER SCHEDULE TAB (Visual Schedule for Parents) ====================

      // ==================== AUTH CHECK & ROUTER (ADMIN) ====================
      // Check authentication on load
      useEffect(() => {
        const userJson = sessionStorage.getItem('user');
        if (!userJson) {
          window.location.href = '/index.html';
          return;
        }
        const sessionUser = JSON.parse(userJson);
        if (sessionUser.role !== 'admin') {
          window.location.href = '/index.html';
          return;
        }
        if (!user) setUser(sessionUser);
      }, []);

      if (loading) return <div className="min-h-screen bg-green-50 flex items-center justify-center"><div className="text-6xl">üèÄ</div></div>;

      if (!user) return <div className="min-h-screen bg-green-50 flex items-center justify-center"><div className="text-6xl">üèÄ</div></div>;

      return (
        <div className="min-h-screen bg-gray-50">
          <VersionBanner isVisible={isDevEnv || showBanner} isDev={isDevEnv} />
          <Nav />
          {toast && <Toast message={toast.msg} type={toast.type} onDone={() => setToast(null)} />}
          <Admin />
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<ErrorBoundary><RooseveltCamp /></ErrorBoundary>);
  </script>
</body>
</html>
