<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tests - Roosevelt Basketball Day Camp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .font-display { font-family: 'Bebas Neue', sans-serif; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ==================== CONFIGURATION ====================
    const SUPABASE_URL = 'https://rdrtsebhninqgfbrleft.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkcnRzZWJobmlucWdmYnJsZWZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2OTcyMTMsImV4cCI6MjA4NTI3MzIxM30.l6gt5vvG1bXemZt9_BKSRy4kzbSatE4UIrV0a872QYw';

    const getEnvironment = () => {
      const hostname = window.location.hostname;
      return (hostname.includes('dev') || hostname.includes('localhost') || hostname.includes('127.0.0.1') || hostname.includes('--dev') || hostname.includes('github.io')) ? 'development' : 'production';
    };

    const ENV = getEnvironment();
    const SCHEMA = ENV === 'development' ? 'dev' : 'public';

    // Save reference to library BEFORE creating clients — Babel transforms
    // "const supabase = ..." to "var supabase = ..." which overwrites window.supabase
    const _supabaseLib = window.supabase;

    const supabase = _supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      db: { schema: SCHEMA },
      global: { headers: { 'Accept-Profile': SCHEMA, 'Content-Profile': SCHEMA } }
    });

    // ==================== VERSION INFO ====================
    const VERSION = "13.138";
    const BUILD_DATE = new Date("2026-02-15T18:45:00");

    // Lazy-create public schema client (only when schema comparison tests need it)
    let _pubClient = null;
    const getSupabasePublic = () => {
      if (!_pubClient) {
        _pubClient = _supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          db: { schema: 'public' },
          global: { headers: { 'Accept-Profile': 'public', 'Content-Profile': 'public' } }
        });
      }
      return _pubClient;
    };

    // The tables our code expects to exist (from CLAUDE.md "ACTIVE TABLES" section)
    const EXPECTED_TABLES = [
      'camp_admins', 'camp_parents', 'camp_counselor_users',
      'camp_counselors', 'camp_campers', 'camp_camper_parent_links',
      'camp_camper_emergency_contact_links', 'camp_emergency_contacts',
      'camp_registrations', 'camp_assignments', 'camp_dates', 'camp_blocked_sessions',
      'camp_counselor_availability', 'camp_counselor_schedule',
      'camp_availability_change_requests', 'camp_profile_change_requests',
      'camp_content', 'camp_food_photos', 'camp_site_photos', 'camp_gym_rentals',
      'camp_messages', 'camp_onboarding_progress', 'camp_change_history',
      'camp_password_reset_tokens'
    ];

    // Helper: check if a table exists in a given schema client
    const tableExists = async (client, table) => {
      try {
        const { data, error } = await client.from(table).select('id').limit(1);
        return !error;
      } catch {
        return false;
      }
    };

    // ==================== STORAGE (same as other files) ====================
    const storage = {
      async get(table) {
        if (!supabase) return null;
        try {
          const { data, error } = await supabase.from(table).select('*');
          if (error) throw error;
          return data;
        } catch (e) {
          console.error('Error fetching ' + table + ':', e);
          return null;
        }
      },
      async set(table, id, data) {
        if (!supabase) return false;
        try {
          const { error } = await supabase.from(table).upsert({ id, data, updated_at: new Date().toISOString() });
          if (error) throw error;
          return true;
        } catch (e) {
          console.error('Error saving to ' + table + ':', e);
          return false;
        }
      },
      async deleteRow(table, id) {
        if (!supabase) return false;
        try {
          const { error } = await supabase.from(table).delete().eq('id', id);
          if (error) throw error;
          return true;
        } catch (e) {
          console.error('Error deleting from ' + table + ':', e);
          return false;
        }
      }
    };

    // Read JSONB data from a single-row table (id='main')
    const getMainData = async (table) => {
      const rows = await storage.get(table);
      if (!rows || rows.length === 0) return null;
      return rows[0]?.data || null;
    };

    // ==================== BUSINESS LOGIC FUNCTIONS (copied from parent.html for testing) ====================

    const formatPhone = (value) => {
      const digits = value.replace(/\D/g, '').slice(0, 10);
      if (digits.length === 0) return '';
      if (digits.length <= 3) return '(' + digits;
      if (digits.length <= 6) return '(' + digits.slice(0, 3) + ') ' + digits.slice(3);
      return '(' + digits.slice(0, 3) + ') ' + digits.slice(3, 6) + '-' + digits.slice(6);
    };

    const isValidPhone = (phone) => (phone || '').replace(/\D/g, '').length === 10;

    const calculateAge = (birthdate) => {
      if (!birthdate) return null;
      const today = new Date();
      const birth = new Date(birthdate);
      let age = today.getFullYear() - birth.getFullYear();
      if (today.getMonth() < birth.getMonth() || (today.getMonth() === birth.getMonth() && today.getDate() < birth.getDate())) age--;
      return age;
    };

    // Camp dates and weeks (needed by calculateDiscountedTotal)
    const generateCampDates = () => {
      const weeks = [
        ['2026-07-13', '2026-07-14', '2026-07-15', '2026-07-16', '2026-07-17'],
        ['2026-08-10', '2026-08-11', '2026-08-12', '2026-08-13', '2026-08-14'],
        ['2026-08-17', '2026-08-18', '2026-08-19', '2026-08-20', '2026-08-21'],
        ['2026-08-24', '2026-08-25', '2026-08-26', '2026-08-27', '2026-08-28']
      ];
      return weeks.flat();
    };
    const CAMP_DATES = generateCampDates();

    const getWeeks = () => {
      const weeks = [];
      let currentWeek = [];
      let weekStart = null;
      CAMP_DATES.forEach((date, idx) => {
        const d = new Date(date + 'T12:00:00');
        if (d.getDay() === 1 || idx === 0) {
          if (currentWeek.length > 0) weeks.push({ start: weekStart, dates: currentWeek });
          currentWeek = [date];
          weekStart = date;
        } else {
          currentWeek.push(date);
        }
      });
      if (currentWeek.length > 0) weeks.push({ start: weekStart, dates: currentWeek });
      return weeks;
    };
    const CAMP_WEEKS = getWeeks();

    const calculateDiscountedTotal = (selectedDates, numChildren, content) => {
      const basePrice = content.singleSessionCost || 60;
      const weekDiscount = (content.weekDiscount || 10) / 100;
      const multiWeekDiscount = (content.multiWeekDiscount || 15) / 100;

      const sessionsByWeek = {};
      Object.entries(selectedDates).forEach(([date, sessions]) => {
        if (!sessions?.length) return;
        const weekIdx = CAMP_WEEKS.findIndex(w => w.dates.includes(date));
        if (weekIdx >= 0) {
          if (!sessionsByWeek[weekIdx]) sessionsByWeek[weekIdx] = { dates: {}, totalSessions: 0 };
          sessionsByWeek[weekIdx].dates[date] = sessions;
          sessionsByWeek[weekIdx].totalSessions += sessions.length;
        }
      });

      let fullWeeks = 0;
      let fullWeekSessions = 0;
      let partialSessions = 0;

      Object.values(sessionsByWeek).forEach(week => {
        const daysCount = Object.keys(week.dates).length;
        const hasBothSessions = Object.values(week.dates).every(s => s.includes('morning') && s.includes('afternoon'));
        if (daysCount === 5 && hasBothSessions && week.totalSessions === 10) {
          fullWeeks++;
          fullWeekSessions += 10;
        } else {
          partialSessions += week.totalSessions;
        }
      });

      const children = Math.max(1, numChildren);
      let subtotal = 0;
      let discount = 0;

      if (fullWeeks >= 2) {
        const fullWeekCost = fullWeekSessions * basePrice * children;
        discount = fullWeekCost * multiWeekDiscount;
        subtotal = fullWeekCost - discount + (partialSessions * basePrice * children);
      } else if (fullWeeks === 1) {
        const fullWeekCost = fullWeekSessions * basePrice * children;
        discount = fullWeekCost * weekDiscount;
        subtotal = fullWeekCost - discount + (partialSessions * basePrice * children);
      } else {
        subtotal = (fullWeekSessions + partialSessions) * basePrice * children;
      }

      const totalSessions = fullWeekSessions + partialSessions;
      const originalTotal = totalSessions * basePrice * children;

      return {
        totalSessions,
        fullWeeks,
        partialSessions,
        originalTotal,
        discount,
        discountPercent: fullWeeks >= 2 ? multiWeekDiscount * 100 : fullWeeks === 1 ? weekDiscount * 100 : 0,
        finalTotal: Math.round(subtotal)
      };
    };

    // ==================== TEST FRAMEWORK ====================
    const assert = {
      ok(val, msg) { if (!val) throw new Error(msg || `Expected truthy, got ${JSON.stringify(val)}`); },
      equal(a, b, msg) { if (a !== b) throw new Error(msg || `Expected ${JSON.stringify(b)}, got ${JSON.stringify(a)}`); },
      isArray(val, msg) { if (!Array.isArray(val)) throw new Error(msg || `Expected array, got ${typeof val}`); },
      isObject(val, msg) { if (typeof val !== 'object' || val === null || Array.isArray(val)) throw new Error(msg || `Expected object, got ${typeof val}`); },
      hasProperty(obj, prop, msg) { if (!(prop in obj)) throw new Error(msg || `Missing property: ${prop}`); },
      greaterThan(a, b, msg) { if (!(a > b)) throw new Error(msg || `Expected ${a} > ${b}`); },
      includes(arr, predicate, msg) { if (!arr || !arr.some(predicate)) throw new Error(msg || 'Expected array to include matching item'); },
      notIncludes(arr, predicate, msg) { if (arr && arr.some(predicate)) throw new Error(msg || 'Expected array NOT to include matching item'); },
    };

    // ==================== FLOW TEST DATA ====================
    const TEST_PREFIX = '__test__';
    let TEST_RUN_ID = Date.now();

    const makeTestData = () => {
      const runId = TEST_RUN_ID;
      return {
        parentEmail: `${TEST_PREFIX}parent_${runId}@testflow.com`,
        parentName: `Test Parent ${runId}`,
        parentPhone: '(555) 000-0001',
        parentPassword: 'testpass123',
        counselorEmail: `${TEST_PREFIX}counselor_${runId}@testflow.com`,
        counselorName: `Test Counselor ${runId}`,
        counselorPhone: '(555) 000-0002',
        counselorPassword: 'testpass456',
        counselorId: `counselor_${TEST_PREFIX}${runId}`,
        camperId: `camper_${TEST_PREFIX}${runId}`,
        camperName: `Test Camper ${runId}`,
        ecId: `contact_${TEST_PREFIX}${runId}`,
        ecName: `Test Emergency ${runId}`,
        regId: `reg_${TEST_PREFIX}${runId}`,
        campDate: '2026-07-13',
      };
    };
    let TD = makeTestData();
    const isTestData = (str) => str && typeof str === 'string' && str.includes(TEST_PREFIX);

    // ==================== SEED USER DATA ====================
    const WEEK1 = CAMP_DATES.slice(0, 5);
    const WEEK2 = CAMP_DATES.slice(5, 10);
    const WEEK3 = CAMP_DATES.slice(10, 15);
    const WEEK4 = CAMP_DATES.slice(15, 20);

    let COUNSELOR_PHOTOS = {};

    const PARENT_PROFILES = [
      {
        email: 'sarah@msn.com', name: 'Sarah Johnson', phone: '(206) 555-1001', password: 'camp',
        campers: [
          { name: 'Tyler Johnson', birthdate: '2016-04-12', grade: '5', phone: '' },
          { name: 'Maya Johnson', birthdate: '2018-09-03', grade: '3', phone: '' },
        ],
        emergencyContacts: [{ name: 'Karen Johnson', phone: '(206) 555-1002', relationship: 'Grandparent' }],
        registration: { weeks: [WEEK1], sessions: ['morning', 'afternoon'] },
      },
      {
        email: 'mike@msn.com', name: 'Mike Chen', phone: '(206) 555-2001', password: 'camp',
        campers: [{ name: 'Ethan Chen', birthdate: '2015-01-22', grade: '6', phone: '(206) 555-2003' }],
        emergencyContacts: [{ name: 'David Chen', phone: '(206) 555-2002', relationship: 'Other', otherRelationship: 'Uncle' }],
        registration: { weeks: [WEEK2], sessions: ['morning'] },
      },
      {
        email: 'lisa@msn.com', name: 'Lisa Williams', phone: '(206) 555-3001', password: 'camp',
        campers: [
          { name: 'Noah Williams', birthdate: '2014-06-15', grade: '7', phone: '' },
          { name: 'Jordan Williams', birthdate: '2017-03-28', grade: '4', phone: '' },
          { name: 'Ava Williams', birthdate: '2019-11-10', grade: '2', phone: '' },
        ],
        emergencyContacts: [
          { name: 'Amy Martinez', phone: '(206) 555-3002', relationship: 'Other', otherRelationship: 'Neighbor' },
          { name: 'Robert Williams', phone: '(206) 555-3003', relationship: 'Grandparent' },
        ],
        registration: { weeks: [WEEK1, WEEK2, WEEK3, WEEK4], sessions: ['morning', 'afternoon'] },
      },
      {
        email: 'maria@msn.com', name: 'Maria Garcia', phone: '(206) 555-4001', password: 'camp',
        campers: [
          { name: 'Sofia Garcia', birthdate: '2016-08-05', grade: '5', phone: '' },
          { name: 'Lucas Garcia', birthdate: '2018-02-14', grade: '3', phone: '' },
        ],
        emergencyContacts: [{ name: 'Rosa Garcia', phone: '(206) 555-4002', relationship: 'Other', otherRelationship: 'Aunt' }],
        registration: { weeks: [WEEK3, WEEK4], sessions: ['morning', 'afternoon'] },
      },
      {
        email: 'jennifer@msn.com', name: 'Jennifer Park', phone: '(206) 555-5001', password: 'camp',
        campers: [{ name: 'Ryan Park', birthdate: '2015-12-01', grade: '6', phone: '(206) 555-5003' }],
        emergencyContacts: [{ name: 'James Park', phone: '(206) 555-5002', relationship: 'Parent' }],
        registration: { weeks: [WEEK1], sessions: ['afternoon'] },
      },
      {
        email: 'derek.richardson@gmail.com', name: 'Derek Richardson', phone: '(206) 555-6001', password: 'camp',
        campers: [
          { name: 'Dylan Richardson', birthdate: '2014-09-15', grade: '7', phone: '(206) 555-6002' },
        ],
        emergencyContacts: [{ name: 'Sarah Richardson', phone: '(206) 555-6003', relationship: 'Parent' }],
        registration: { weeks: [WEEK1, WEEK2, WEEK3, WEEK4], sessions: ['morning', 'afternoon'] },
      },
    ];

    const COUNSELOR_PROFILES = [
      {
        id: 'c1', email: 'audrey@msn.com', name: 'Audrey Richardson',
        phone: '(555) 555-2234', password: 'camp', position: 'Point Guard', year: 'Senior',
        bio: 'Team captain with 3 years varsity experience.', order: 0,
        availability: { '2026-07-13':[true,true],'2026-07-14':[true,true],'2026-07-15':[true,true],'2026-07-16':[false,false],'2026-07-17':[true,true],'2026-08-10':[true,true],'2026-08-11':[true,true],'2026-08-12':[true,true],'2026-08-13':[false,false],'2026-08-14':[true,true],'2026-08-17':[true,true],'2026-08-18':[true,true],'2026-08-19':[true,true],'2026-08-20':[true,true],'2026-08-21':[true,true],'2026-08-24':[true,true],'2026-08-25':[true,true],'2026-08-26':[true,true],'2026-08-27':[true,true],'2026-08-28':[true,true] },
      },
      {
        id: 'c4', email: 'emma@msn.com', name: 'Emma Curtis',
        phone: '(555) 555-5555', password: 'camp', position: 'Shooting Guard / Small Forward', year: 'Senior',
        bio: '3 year starter entering her senior year at Roosevelt.  ', order: 1,
        availability: { '2026-07-13':[true,true],'2026-07-14':[true,true],'2026-07-15':[true,true],'2026-07-16':[true,true],'2026-07-17':[true,true],'2026-08-10':[true,true],'2026-08-11':[true,true],'2026-08-12':[true,true],'2026-08-13':[true,true],'2026-08-14':[true,true],'2026-08-17':[true,true],'2026-08-18':[true,true],'2026-08-19':[true,false],'2026-08-20':[true,true],'2026-08-21':[true,true],'2026-08-24':[false,false],'2026-08-25':[false,false],'2026-08-26':[false,false],'2026-08-27':[false,false],'2026-08-28':[false,false] },
      },
      {
        id: 'c2', email: 'julia@msn.com', name: 'Julia Gilbertson',
        phone: '(555) 123-1232', password: 'camp', position: 'Shooting Guard', year: 'Junior',
        bio: 'Power forward with 2 years varsity experience.', order: 2,
        availability: { '2026-07-13':[true,false],'2026-07-14':[true,false],'2026-07-15':[true,false],'2026-07-16':[true,false],'2026-07-17':[true,false],'2026-08-10':[true,true],'2026-08-11':[true,true],'2026-08-12':[true,true],'2026-08-13':[true,true],'2026-08-14':[true,true],'2026-08-17':[true,true],'2026-08-18':[true,true],'2026-08-19':[true,true],'2026-08-20':[true,true],'2026-08-21':[true,true],'2026-08-24':[true,true],'2026-08-25':[true,true],'2026-08-26':[true,true],'2026-08-27':[true,true],'2026-08-28':[true,true] },
      },
      {
        id: 'c3', email: 'molly@msn.com', name: 'Molly Kirkland',
        phone: '(555) 123-4243', password: 'camp', position: 'Center', year: 'Sophomore',
        bio: 'Versatile player known for rebounding and blocking opponents shots.  ', order: 3,
        availability: { '2026-07-13':[false,true],'2026-07-14':[false,true],'2026-07-15':[true,true],'2026-07-16':[true,true],'2026-07-17':[true,true],'2026-08-10':[true,true],'2026-08-11':[true,true],'2026-08-12':[true,true],'2026-08-13':[true,true],'2026-08-14':[true,true],'2026-08-17':[true,true],'2026-08-18':[false,false],'2026-08-19':[false,false],'2026-08-20':[true,true],'2026-08-21':[true,true],'2026-08-24':[true,true],'2026-08-25':[true,true],'2026-08-26':[true,true],'2026-08-27':[true,true],'2026-08-28':[true,true] },
      },
    ];

    // ==================== SEED ADD/REMOVE FUNCTIONS ====================
    // These replicate the EXACT signup flow from index.html (ParentOnboarding / CounselorOnboarding)
    // including welcome emails, change history, and the same data shapes.
    const SEND_EMAIL_URL = 'https://rhsbasketballdaycamp.com/.netlify/functions/send-email';

    const seedSendParentWelcome = async (profile) => {
      try {
        const tips = [
          '<li><strong>Upload photos</strong> — Add a photo for yourself and each camper (required before camp starts)</li>',
          '<li><strong>Register for sessions</strong> — Check the schedule and register your campers for their sessions</li>',
        ];
        const tipsHtml = `<h3 style="color: #15803d;">Next Steps</h3><ul style="line-height: 1.8;">${tips.join('')}</ul>`;
        await fetch(SEND_EMAIL_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            to: profile.email,
            subject: 'Welcome to Roosevelt Basketball Day Camp!',
            html: `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;"><h2 style="color: #15803d;">Welcome to Roosevelt Basketball Day Camp, ${profile.name}!</h2><p>Thank you for creating your account. We're excited to have your family join us this summer!</p>${tipsHtml}<p><a href="https://rhsbasketballdaycamp.com/#login" style="display: inline-block; background-color: #15803d; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; font-weight: bold;">Log In to Your Dashboard</a></p><p style="color: #666; font-size: 14px; margin-top: 20px;">If you have any questions, just reply to this email and we'll get back to you!</p></div>`
          })
        });
      } catch (e) { console.warn('Welcome email failed (non-critical):', e.message); }
    };

    const seedSendCounselorWelcome = async (profile) => {
      try {
        await fetch(SEND_EMAIL_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            to: profile.email,
            subject: 'Welcome to the Roosevelt Basketball Day Camp Team!',
            html: `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;"><h2 style="color: #15803d;">Welcome to the Team, ${profile.name}!</h2><p>Thank you for signing up as a counselor at Roosevelt Basketball Day Camp. We're glad to have you on board!</p><h3 style="color: #15803d;">What Happens Next</h3><ul style="line-height: 1.8;"><li><strong>Your profile is pending approval</strong> — The camp director will review and approve your profile</li><li><strong>Check your availability</strong> — Make sure your available dates are up to date in your dashboard</li><li><strong>Upload a photo</strong> — Add a profile photo so campers and parents can recognize you</li><li><strong>Review your schedule</strong> — Once approved, you'll be assigned to camp sessions</li></ul><p><a href="https://rhsbasketballdaycamp.com/#login" style="display: inline-block; background-color: #15803d; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; font-weight: bold;">Log In to Your Dashboard</a></p><p style="color: #666; font-size: 14px; margin-top: 20px;">If you have any questions, just reply to this email and we'll get back to you!</p></div>`
          })
        });
      } catch (e) { console.warn('Welcome email failed (non-critical):', e.message); }
    };

    const seedLogHistory = async (action, details, emails) => {
      try {
        const history = await getMainData('camp_change_history') || [];
        history.push({ action, details, relatedEmails: emails, timestamp: new Date().toISOString(), source: 'seed-users' });
        await storage.set('camp_change_history', 'main', history);
      } catch (e) { console.warn('History log failed:', e.message); }
    };

    const seedAddParent = async (profile) => {
      const now = new Date().toISOString();
      const ts = Date.now();

      // 1. Create parent account (matches index.html ParentOnboarding handleComplete)
      const parents = await getMainData('camp_parents') || [];
      if (parents.some(p => p.email === profile.email)) throw new Error('Already exists');
      const newUser = {
        email: profile.email, name: profile.name, phone: profile.phone, password: profile.password,
        photo: null, role: 'parent', roles: ['parent'], loginType: 'Email/Password',
        onboardingComplete: true, onboardingCompletedAt: now,
        policiesAccepted: { pickup: true, dropoff: true, acceptedAt: now },
      };
      await storage.set('camp_parents', 'main', [...parents, newUser]);

      // 2. Add campers + parent links
      const campers = await getMainData('camp_campers') || [];
      const links = await getMainData('camp_camper_parent_links') || [];
      const newCampers = []; const newLinks = [];
      profile.campers.forEach((c, i) => {
        const cid = `camper_seed_${ts}_${i}`;
        newCampers.push({ id: cid, name: c.name, birthdate: c.birthdate, grade: c.grade, phone: c.phone || '', photo: null, createdAt: now });
        newLinks.push({ camperId: cid, parentEmail: profile.email });
      });
      await storage.set('camp_campers', 'main', [...campers, ...newCampers]);
      await storage.set('camp_camper_parent_links', 'main', [...links, ...newLinks]);

      // 3. Emergency contacts — parent as EC #1 (reference-only) + additional contacts
      const contacts = await getMainData('camp_emergency_contacts') || [];
      const newContacts = [{ id: `ec_seed_${ts}_parent`, parentEmail: profile.email, isParent: true, relationship: 'Parent', priority: 1, userEmail: profile.email }];
      profile.emergencyContacts.forEach((ec, i) => {
        newContacts.push({ id: `ec_seed_${ts}_${i}`, name: ec.name, phone: ec.phone, relationship: ec.relationship, otherRelationship: ec.otherRelationship || '', photo: null, userEmail: profile.email, isParent: false, priority: i + 2 });
      });
      await storage.set('camp_emergency_contacts', 'main', [...contacts, ...newContacts]);

      // 4. Register campers for sessions (if specified)
      if (profile.registration) {
        let rc = 0; const oid = `order_seed_${ts}`;
        for (const camper of newCampers) for (const date of profile.registration.weeks.flat()) {
          const rid = `reg_seed_${ts}_${rc++}`;
          await storage.set('camp_registrations', rid, { id: rid, orderId: oid, childId: camper.id, childName: camper.name, parentEmail: profile.email, parentName: profile.name, date, sessions: profile.registration.sessions, status: 'pending', paymentStatus: 'unpaid', venmoCode: 'SEED000', baseAmount: profile.registration.sessions.length * 60, discountAmount: 0, discountPercent: 0, totalAmount: profile.registration.sessions.length * 60, registeredAt: now });
        }
      }

      // 5. Log to change history (matches onboarding flow)
      const camperNames = profile.campers.map(c => c.name).join(', ');
      const ecNames = profile.emergencyContacts.map(c => c.name).join(', ');
      await seedLogHistory('Parent Onboarding Complete',
        `Parent account created: ${profile.name} (${profile.email}) | Campers added: ${camperNames} | Emergency contacts added: ${ecNames} | Pickup & dropoff policies accepted`,
        [profile.email]);

      // 6. Send welcome email (same as index.html — fire and forget)
      await seedSendParentWelcome(profile);
    };

    const seedRemoveParent = async (profile) => {
      const parents = await getMainData('camp_parents') || [];
      await storage.set('camp_parents', 'main', parents.filter(p => p.email !== profile.email));
      const links = await getMainData('camp_camper_parent_links') || [];
      const camperIds = links.filter(l => l.parentEmail === profile.email).map(l => l.camperId);
      await storage.set('camp_camper_parent_links', 'main', links.filter(l => l.parentEmail !== profile.email));
      const campers = await getMainData('camp_campers') || [];
      await storage.set('camp_campers', 'main', campers.filter(c => !camperIds.includes(c.id)));
      const contacts = await getMainData('camp_emergency_contacts') || [];
      await storage.set('camp_emergency_contacts', 'main', contacts.filter(c => c.userEmail !== profile.email));
      const regs = await storage.get('camp_registrations');
      for (const row of (regs || []).filter(r => r.data?.parentEmail === profile.email)) await storage.deleteRow('camp_registrations', row.id);
    };

    const seedAddCounselor = async (profile) => {
      const now = new Date().toISOString();
      const photo = COUNSELOR_PHOTOS[profile.id] || null;

      // 1. Create counselor user account (matches index.html CounselorOnboarding handleNext)
      const users = await getMainData('camp_counselor_users') || [];
      if (users.some(u => u.email === profile.email)) throw new Error('Already exists');
      const newUser = {
        email: profile.email, name: profile.name, phone: profile.phone, password: profile.password,
        role: 'counselor', roles: ['counselor'], loginType: 'Email/Password',
        onboardingComplete: true, onboardingCompletedAt: now,
      };
      await storage.set('camp_counselor_users', 'main', [...users, newUser]);

      // 2. Create counselor profile (visible:false, approvedByAdmin:false — pending admin approval, same as real flow)
      const newCounselor = {
        id: profile.id, name: profile.name, email: profile.email, phone: profile.phone,
        position: profile.position, year: profile.year, bio: profile.bio, photo,
        visible: false, approvedByAdmin: false,
        responsibilitiesAcknowledged: true, payDisclosureAcknowledged: true,
        createdAt: now, order: profile.order || 0,
      };
      await storage.set('camp_counselors', profile.id, newCounselor);

      // 3. Save availability (matches combined format: { email: { date: { available: [], unavailable: [] } } })
      const avail = await getMainData('camp_counselor_availability') || {};
      const ca = {};
      for (const [date, [am, pm]] of Object.entries(profile.availability)) {
        ca[date] = { available: [...(am ? ['morning'] : []), ...(pm ? ['afternoon'] : [])], unavailable: [...(!am ? ['morning'] : []), ...(!pm ? ['afternoon'] : [])] };
      }
      avail[profile.email] = ca;
      await storage.set('camp_counselor_availability', 'main', avail);

      // 4. Save schedule (matches format: { counselorId: { date: { morning: bool, afternoon: bool } } })
      const schedule = await getMainData('camp_counselor_schedule') || {};
      const cs = {};
      for (const [date, [am, pm]] of Object.entries(profile.availability)) {
        cs[date] = { morning: am, afternoon: pm };
      }
      schedule[profile.id] = cs;
      await storage.set('camp_counselor_schedule', 'main', schedule);

      // 5. Log to change history (matches onboarding flow)
      const availDates = Object.keys(profile.availability).length;
      await seedLogHistory('Counselor Onboarding Complete',
        `Counselor account created: ${profile.name} (${profile.email}) | Position: ${profile.position} | Year: ${profile.year} | Availability set for ${availDates} dates | Profile pending admin approval`,
        [profile.email]);

      // 6. Send welcome email (same as index.html — fire and forget)
      await seedSendCounselorWelcome(profile);
    };

    const seedRemoveCounselor = async (profile) => {
      const users = await getMainData('camp_counselor_users') || [];
      await storage.set('camp_counselor_users', 'main', users.filter(u => u.email !== profile.email));
      const avail = await getMainData('camp_counselor_availability') || {}; delete avail[profile.email]; await storage.set('camp_counselor_availability', 'main', avail);
      const schedule = await getMainData('camp_counselor_schedule') || {}; delete schedule[profile.id]; await storage.set('camp_counselor_schedule', 'main', schedule);
      await storage.deleteRow('camp_counselors', profile.id);
    };

    // ==================== TEST SUITES ====================
    // Section labels for visual grouping in the UI
    const SECTIONS = {
      readonly: { title: "Database & Logic Tests", subtitle: "Read-only — safe to run anytime, no data is modified" },
      flows: { title: "Flow Tests", subtitle: "Creates test accounts, walks through setup flows, then cleans up" },
    };

    const ALL_SUITES = [
      // ===== DATABASE CONNECTIVITY =====
      {
        name: "Database Connectivity",
        section: "readonly",
        category: "connectivity",
        icon: "\ud83d\udd0c",
        tests: [
          {
            name: "Supabase client initializes",
            fn: async () => { assert.ok(supabase, 'Supabase client should exist'); }
          },
          {
            name: "Schema is dev (safety check)",
            fn: async () => { assert.equal(SCHEMA, 'dev', 'Tests must run against dev schema, not production'); }
          },
          {
            name: "Can connect to Supabase and query",
            fn: async () => {
              const { data, error } = await supabase.from('camp_admins').select('id').limit(1);
              assert.ok(!error, `Connection failed: ${error?.message}`);
            }
          },
          {
            name: "storage.get returns data array",
            fn: async () => {
              const result = await storage.get('camp_admins');
              assert.ok(result !== null, 'storage.get should return non-null');
              assert.isArray(result, 'Result should be an array of rows');
            }
          }
        ]
      },

      // ===== DATA INTEGRITY =====
      {
        name: "Data Integrity \u2014 Tables Exist",
        section: "readonly",
        category: "integrity",
        icon: "\ud83d\uddc4\ufe0f",
        tests: [
          ...['camp_admins', 'camp_parents', 'camp_counselor_users', 'camp_counselors',
            'camp_campers', 'camp_camper_parent_links', 'camp_emergency_contacts',
            'camp_registrations', 'camp_assignments', 'camp_dates', 'camp_blocked_sessions',
            'camp_counselor_availability', 'camp_counselor_schedule',
            'camp_availability_change_requests', 'camp_profile_change_requests',
            'camp_content', 'camp_food_photos', 'camp_site_photos', 'camp_gym_rentals',
            'camp_messages', 'camp_onboarding_progress', 'camp_change_history',
            'camp_password_reset_tokens'].map(table => ({
            name: `Table "${table}" exists`,
            fn: async () => {
              const { data, error } = await supabase.from(table).select('id').limit(1);
              assert.ok(!error, `Table ${table} query failed: ${error?.message}`);
            }
          })),
          {
            name: "camp_admins table is queryable (admin login is hardcoded as fallback)",
            fn: async () => {
              const result = await storage.get('camp_admins');
              // Admin credentials are hardcoded in admin.html as DEFAULT_ADMINS,
              // so the table may be empty in dev — that's OK
              assert.ok(result !== null, 'Table should be queryable');
            }
          },
          {
            name: "Admin records have required fields if data exists",
            fn: async () => {
              const result = await storage.get('camp_admins');
              const admins = result?.[0]?.data || [];
              if (admins.length > 0) {
                assert.hasProperty(admins[0], 'username', 'Admin should have username');
                assert.hasProperty(admins[0], 'name', 'Admin should have name');
              }
            }
          }
        ]
      },

      // ===== SCHEMA COMPARISON =====
      {
        name: "Schema Comparison \u2014 Dev vs Public vs Code",
        section: "readonly",
        category: "schema",
        icon: "\ud83d\udd0d",
        tests: [
          {
            name: "Can connect to PUBLIC schema",
            fn: async () => {
              const { data, error } = await getSupabasePublic().from('camp_admins').select('id').limit(1);
              assert.ok(!error, `Public schema connection failed: ${error?.message}`);
            }
          },
          // Check every expected table exists in DEV
          ...EXPECTED_TABLES.map(table => ({
            name: `DEV has "${table}"`,
            fn: async () => {
              const exists = await tableExists(supabase, table);
              assert.ok(exists, `Table "${table}" missing from DEV schema`);
            }
          })),
          // Check every expected table exists in PUBLIC
          ...EXPECTED_TABLES.map(table => ({
            name: `PUBLIC has "${table}"`,
            fn: async () => {
              const exists = await tableExists(getSupabasePublic(), table);
              assert.ok(exists, `Table "${table}" missing from PUBLIC schema`);
            }
          })),
          // Cross-check: make sure both schemas have the same tables
          {
            name: "DEV and PUBLIC have the same camp tables",
            fn: async () => {
              const devOnly = [];
              const publicOnly = [];

              for (const table of EXPECTED_TABLES) {
                const inDev = await tableExists(supabase, table);
                const inPub = await tableExists(getSupabasePublic(), table);
                if (inDev && !inPub) devOnly.push(table);
                if (!inDev && inPub) publicOnly.push(table);
              }

              const mismatches = [];
              if (devOnly.length > 0) mismatches.push(`In DEV only: ${devOnly.join(', ')}`);
              if (publicOnly.length > 0) mismatches.push(`In PUBLIC only: ${publicOnly.join(', ')}`);
              assert.ok(mismatches.length === 0, mismatches.join(' | '));
            }
          },
          // Verify the expected table list matches what the HTML files reference
          {
            name: "Expected table list matches CLAUDE.md (24 tables)",
            fn: () => {
              assert.equal(EXPECTED_TABLES.length, 24, `Expected 24 tables, got ${EXPECTED_TABLES.length}`);
            }
          }
        ]
      },

      // ===== BUSINESS LOGIC =====
      {
        name: "Business Logic \u2014 Phone",
        section: "readonly",
        category: "logic",
        icon: "\ud83d\udcde",
        tests: [
          {
            name: "formatPhone: formats 10 digits correctly",
            fn: () => { assert.equal(formatPhone('2065551234'), '(206) 555-1234'); }
          },
          {
            name: "formatPhone: handles partial (3 digits)",
            fn: () => { assert.equal(formatPhone('206'), '(206'); }
          },
          {
            name: "formatPhone: handles partial (6 digits)",
            fn: () => { assert.equal(formatPhone('206555'), '(206) 555'); }
          },
          {
            name: "formatPhone: strips non-digits",
            fn: () => { assert.equal(formatPhone('(206) 555-1234'), '(206) 555-1234'); }
          },
          {
            name: "formatPhone: returns empty for empty input",
            fn: () => { assert.equal(formatPhone(''), ''); }
          },
          {
            name: "isValidPhone: accepts 10-digit formatted phone",
            fn: () => { assert.ok(isValidPhone('(206) 555-1234')); }
          },
          {
            name: "isValidPhone: accepts raw 10 digits",
            fn: () => { assert.ok(isValidPhone('2065551234')); }
          },
          {
            name: "isValidPhone: rejects 7-digit phone",
            fn: () => { assert.ok(!isValidPhone('555-1234')); }
          },
          {
            name: "isValidPhone: rejects empty string",
            fn: () => { assert.ok(!isValidPhone('')); }
          },
          {
            name: "isValidPhone: handles null gracefully",
            fn: () => { assert.ok(!isValidPhone(null)); }
          }
        ]
      },
      {
        name: "Business Logic \u2014 Age",
        section: "readonly",
        category: "logic",
        icon: "\ud83c\udf82",
        tests: [
          {
            name: "calculateAge: returns correct age for known date",
            fn: () => {
              // Someone born Jan 1 2016 should be ~10 in Feb 2026
              const age = calculateAge('2016-01-01');
              assert.equal(age, 10, `Age should be 10, got ${age}`);
            }
          },
          {
            name: "calculateAge: returns null for null input",
            fn: () => { assert.equal(calculateAge(null), null); }
          },
          {
            name: "calculateAge: returns null for empty string",
            fn: () => { assert.equal(calculateAge(''), null); }
          }
        ]
      },
      {
        name: "Business Logic \u2014 Discounts",
        section: "readonly",
        category: "logic",
        icon: "\ud83d\udcb0",
        tests: [
          {
            name: "No discount for partial week (3 sessions)",
            fn: () => {
              const dates = { '2026-07-13': ['morning'], '2026-07-14': ['morning'], '2026-07-15': ['morning'] };
              const result = calculateDiscountedTotal(dates, 1, { singleSessionCost: 60 });
              assert.equal(result.discount, 0, 'No discount for partial week');
              assert.equal(result.finalTotal, 180, '3 sessions x $60 = $180');
              assert.equal(result.totalSessions, 3);
            }
          },
          {
            name: "10% discount for full week (5 days x 2 sessions = 10)",
            fn: () => {
              const dates = {};
              ['2026-07-13', '2026-07-14', '2026-07-15', '2026-07-16', '2026-07-17'].forEach(d => {
                dates[d] = ['morning', 'afternoon'];
              });
              const result = calculateDiscountedTotal(dates, 1, { singleSessionCost: 60, weekDiscount: 10 });
              assert.equal(result.fullWeeks, 1, 'Should detect 1 full week');
              assert.equal(result.discountPercent, 10);
              assert.equal(result.originalTotal, 600, '10 sessions x $60');
              assert.equal(result.finalTotal, 540, '$600 - 10% = $540');
            }
          },
          {
            name: "15% discount for 2+ full weeks",
            fn: () => {
              const dates = {};
              ['2026-07-13', '2026-07-14', '2026-07-15', '2026-07-16', '2026-07-17'].forEach(d => {
                dates[d] = ['morning', 'afternoon'];
              });
              ['2026-08-10', '2026-08-11', '2026-08-12', '2026-08-13', '2026-08-14'].forEach(d => {
                dates[d] = ['morning', 'afternoon'];
              });
              const result = calculateDiscountedTotal(dates, 1, { singleSessionCost: 60, weekDiscount: 10, multiWeekDiscount: 15 });
              assert.equal(result.fullWeeks, 2);
              assert.equal(result.discountPercent, 15);
              assert.equal(result.originalTotal, 1200, '20 sessions x $60');
              assert.equal(result.finalTotal, 1020, '$1200 - 15% = $1020');
            }
          },
          {
            name: "Discount scales with number of children",
            fn: () => {
              const dates = {};
              ['2026-07-13', '2026-07-14', '2026-07-15', '2026-07-16', '2026-07-17'].forEach(d => {
                dates[d] = ['morning', 'afternoon'];
              });
              const result = calculateDiscountedTotal(dates, 2, { singleSessionCost: 60, weekDiscount: 10 });
              assert.equal(result.originalTotal, 1200, '10 sessions x $60 x 2 children');
              assert.equal(result.finalTotal, 1080, '$1200 - 10% = $1080');
            }
          },
          {
            name: "Mixed: full week + partial sessions",
            fn: () => {
              const dates = {};
              // Full week 1
              ['2026-07-13', '2026-07-14', '2026-07-15', '2026-07-16', '2026-07-17'].forEach(d => {
                dates[d] = ['morning', 'afternoon'];
              });
              // Partial: 2 extra sessions
              dates['2026-08-10'] = ['morning'];
              dates['2026-08-11'] = ['morning'];
              const result = calculateDiscountedTotal(dates, 1, { singleSessionCost: 60, weekDiscount: 10 });
              assert.equal(result.fullWeeks, 1);
              assert.equal(result.partialSessions, 2);
              assert.equal(result.totalSessions, 12);
              // Full week: 10 * 60 = 600 - 10% = 540, partial: 2 * 60 = 120, total = 660
              assert.equal(result.finalTotal, 660);
            }
          },
          {
            name: "Zero sessions returns zero total",
            fn: () => {
              const result = calculateDiscountedTotal({}, 1, { singleSessionCost: 60 });
              assert.equal(result.totalSessions, 0);
              assert.equal(result.finalTotal, 0);
            }
          }
        ]
      },
      {
        name: "Business Logic \u2014 Environment",
        section: "readonly",
        category: "logic",
        icon: "\ud83c\udf0d",
        tests: [
          {
            name: "getEnvironment returns development on localhost",
            fn: () => { assert.equal(ENV, 'development'); }
          },
          {
            name: "SCHEMA is dev on localhost",
            fn: () => { assert.equal(SCHEMA, 'dev'); }
          },
          {
            name: "CAMP_DATES has 20 dates (4 weeks x 5 days)",
            fn: () => { assert.equal(CAMP_DATES.length, 20); }
          },
          {
            name: "CAMP_WEEKS has 4 weeks",
            fn: () => { assert.equal(CAMP_WEEKS.length, 4); }
          },
          {
            name: "Each camp week has 5 days",
            fn: () => {
              CAMP_WEEKS.forEach((week, i) => {
                assert.equal(week.dates.length, 5, `Week ${i + 1} should have 5 days, has ${week.dates.length}`);
              });
            }
          }
        ]
      },

      // ===== API ENDPOINTS =====
      {
        name: "API Endpoints (Netlify Functions)",
        section: "readonly",
        category: "api",
        icon: "\u26a1",
        tests: [
          ...['send-email', 'request-password-reset', 'reset-password', 'send-sms', 'send-verification-code', 'verify-code'].map(fn => ({
            name: `Function "${fn}" endpoint responds`,
            fn: async () => {
              try {
                const res = await fetch(`https://rhsbasketballdaycamp.com/.netlify/functions/${fn}`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({})
                });
                // Any response (even 400/500) means the endpoint exists
                assert.ok(res.status > 0, `Endpoint responded with status ${res.status}`);
              } catch (e) {
                // CORS error means the endpoint exists but blocks cross-origin
                if (e.message.includes('Failed to fetch') || e.message.includes('CORS') || e.message.includes('NetworkError')) {
                  assert.ok(true, 'Endpoint exists (CORS blocked from localhost)');
                } else {
                  throw e;
                }
              }
            }
          }))
        ]
      },

      // ═══════════════════════════════════════════════════════════════
      // FLOW TESTS — Parent Setup
      // ═══════════════════════════════════════════════════════════════
      {
        name: "Parent Flow \u2014 Account & Login",
        section: "flows",
        category: "flow-parent",
        icon: "\ud83d\udc68\u200d\ud83d\udc69\u200d\ud83d\udc67",
        tests: [
          {
            name: "Create parent account",
            fn: async () => {
              const current = await getMainData('camp_parents') || [];
              const cleaned = current.filter(p => !isTestData(p.email));
              const newParent = {
                email: TD.parentEmail, name: TD.parentName, phone: TD.parentPhone,
                password: TD.parentPassword, photo: null, role: 'parent', roles: ['parent'],
                loginType: 'Email/Password', onboardingComplete: true,
                onboardingCompletedAt: new Date().toISOString(),
                policiesAccepted: { pickup: true, dropoff: true, acceptedAt: new Date().toISOString() }
              };
              const saved = await storage.set('camp_parents', 'main', [...cleaned, newParent]);
              assert.ok(saved, 'Failed to save parent to Supabase');
            }
          },
          {
            name: "Verify parent exists in database",
            fn: async () => {
              const parents = await getMainData('camp_parents') || [];
              assert.isArray(parents);
              const found = parents.find(p => p.email === TD.parentEmail);
              assert.ok(found, `Parent ${TD.parentEmail} not found in camp_parents`);
              assert.equal(found.name, TD.parentName);
              assert.equal(found.role, 'parent');
            }
          },
          {
            name: "Verify parent login credentials match",
            fn: async () => {
              const parents = await getMainData('camp_parents') || [];
              const match = parents.find(p => p.email === TD.parentEmail && p.password === TD.parentPassword);
              assert.ok(match, 'Login credentials do not match \u2014 email+password lookup failed');
              assert.equal(match.loginType, 'Email/Password');
            }
          },
        ]
      },
      {
        name: "Parent Flow \u2014 Camper & Emergency Contact",
        section: "flows",
        category: "flow-parent",
        icon: "\ud83e\uddd2",
        tests: [
          {
            name: "Add camper linked to parent",
            fn: async () => {
              const campers = await getMainData('camp_campers') || [];
              const cleaned = campers.filter(c => !isTestData(c.id));
              const newCamper = {
                id: TD.camperId, name: TD.camperName, birthdate: '2015-03-20',
                grade: '5', phone: '', photo: null, createdAt: new Date().toISOString()
              };
              assert.ok(await storage.set('camp_campers', 'main', [...cleaned, newCamper]), 'Failed to save camper');
              const links = await getMainData('camp_camper_parent_links') || [];
              const cleanedLinks = links.filter(l => !isTestData(l.camperId));
              assert.ok(await storage.set('camp_camper_parent_links', 'main', [...cleanedLinks, { camperId: TD.camperId, parentEmail: TD.parentEmail }]), 'Failed to save link');
            }
          },
          {
            name: "Verify camper and parent link in database",
            fn: async () => {
              const campers = await getMainData('camp_campers') || [];
              assert.ok(campers.find(c => c.id === TD.camperId), `Camper ${TD.camperId} not found`);
              const links = await getMainData('camp_camper_parent_links') || [];
              assert.ok(links.find(l => l.camperId === TD.camperId && l.parentEmail === TD.parentEmail), 'Camper-parent link not found');
            }
          },
          {
            name: "Add emergency contact for parent",
            fn: async () => {
              const contacts = await getMainData('camp_emergency_contacts') || [];
              const cleaned = contacts.filter(c => !isTestData(c.id));
              const newEC = {
                id: TD.ecId, name: TD.ecName, phone: '(555) 000-0099',
                relationship: 'Grandparent', otherRelationship: '', photo: null,
                userEmail: TD.parentEmail, isParent: false, priority: 2
              };
              assert.ok(await storage.set('camp_emergency_contacts', 'main', [...cleaned, newEC]), 'Failed to save EC');
            }
          },
          {
            name: "Verify emergency contact in database",
            fn: async () => {
              const contacts = await getMainData('camp_emergency_contacts') || [];
              const found = contacts.find(c => c.id === TD.ecId);
              assert.ok(found, `Emergency contact ${TD.ecId} not found`);
              assert.equal(found.userEmail, TD.parentEmail);
            }
          },
        ]
      },
      {
        name: "Parent Flow \u2014 Session Registration",
        section: "flows",
        category: "flow-parent",
        icon: "\ud83d\udcc5",
        tests: [
          {
            name: "Register camper for camp session",
            fn: async () => {
              const reg = {
                id: TD.regId, orderId: `order_${TEST_PREFIX}${TEST_RUN_ID}`,
                childId: TD.camperId, childName: TD.camperName,
                parentEmail: TD.parentEmail, parentName: TD.parentName,
                date: TD.campDate, sessions: ['morning', 'afternoon'],
                status: 'pending', paymentStatus: 'unpaid', venmoCode: 'TESTES000',
                baseAmount: 120, discountAmount: 0, discountPercent: 0,
                totalAmount: 120, registeredAt: new Date().toISOString()
              };
              assert.ok(await storage.set('camp_registrations', reg.id, reg), 'Failed to save registration');
            }
          },
          {
            name: "Verify registration in database",
            fn: async () => {
              const rows = await storage.get('camp_registrations');
              const found = (rows || []).find(r => r.id === TD.regId);
              assert.ok(found, `Registration ${TD.regId} not found`);
              assert.equal(found.data.childId, TD.camperId);
              assert.equal(found.data.parentEmail, TD.parentEmail);
              assert.equal(found.data.date, TD.campDate);
            }
          },
        ]
      },

      // ═══════════════════════════════════════════════════════════════
      // FLOW TESTS — Counselor Setup
      // ═══════════════════════════════════════════════════════════════
      {
        name: "Counselor Flow \u2014 Account & Profile",
        section: "flows",
        category: "flow-counselor",
        icon: "\ud83c\udfc0",
        tests: [
          {
            name: "Create counselor user account",
            fn: async () => {
              const current = await getMainData('camp_counselor_users') || [];
              const cleaned = current.filter(u => !isTestData(u.email));
              const newUser = {
                email: TD.counselorEmail, name: TD.counselorName, phone: TD.counselorPhone,
                password: TD.counselorPassword, role: 'counselor', roles: ['counselor'],
                loginType: 'Email/Password', onboardingComplete: true,
                onboardingCompletedAt: new Date().toISOString()
              };
              assert.ok(await storage.set('camp_counselor_users', 'main', [...cleaned, newUser]), 'Failed to save counselor user');
            }
          },
          {
            name: "Create counselor profile (pending approval)",
            fn: async () => {
              const newCounselor = {
                id: TD.counselorId, name: TD.counselorName, email: TD.counselorEmail,
                phone: TD.counselorPhone, position: 'Point Guard', year: 'Junior',
                bio: 'This is a test counselor bio that is at least twenty characters long for validation.',
                photo: null, visible: false, approvedByAdmin: false,
                responsibilitiesAcknowledged: true, payDisclosureAcknowledged: true,
                createdAt: new Date().toISOString(), order: 999
              };
              assert.ok(await storage.set('camp_counselors', newCounselor.id, newCounselor), 'Failed to save counselor profile');
            }
          },
          {
            name: "Verify counselor user in database",
            fn: async () => {
              const users = await getMainData('camp_counselor_users') || [];
              const found = users.find(u => u.email === TD.counselorEmail);
              assert.ok(found, `Counselor user ${TD.counselorEmail} not found`);
              assert.equal(found.role, 'counselor');
            }
          },
          {
            name: "Verify counselor profile is pending approval",
            fn: async () => {
              const rows = await storage.get('camp_counselors');
              const found = (rows || []).find(r => r.id === TD.counselorId);
              assert.ok(found, `Counselor profile ${TD.counselorId} not found`);
              assert.equal(found.data.approvedByAdmin, false, 'New counselor should not be approved yet');
              assert.equal(found.data.visible, false, 'New counselor should not be visible yet');
            }
          },
          {
            name: "Verify counselor login credentials match",
            fn: async () => {
              const users = await getMainData('camp_counselor_users') || [];
              const match = users.find(u => u.email === TD.counselorEmail && u.password === TD.counselorPassword);
              assert.ok(match, 'Counselor login credentials do not match');
            }
          },
        ]
      },
      {
        name: "Counselor Flow \u2014 Availability & Schedule",
        section: "flows",
        category: "flow-counselor",
        icon: "\ud83d\uddd3\ufe0f",
        tests: [
          {
            name: "Set counselor availability",
            fn: async () => {
              const avail = await getMainData('camp_counselor_availability') || {};
              avail[TD.counselorEmail] = {
                '2026-07-13': { available: ['morning', 'afternoon'], unavailable: [] },
                '2026-07-14': { available: ['morning'], unavailable: ['afternoon'] },
                '2026-07-15': { available: [], unavailable: ['morning', 'afternoon'] },
              };
              assert.ok(await storage.set('camp_counselor_availability', 'main', avail), 'Failed to save availability');
            }
          },
          {
            name: "Set counselor schedule",
            fn: async () => {
              const schedule = await getMainData('camp_counselor_schedule') || {};
              schedule[TD.counselorId] = {
                '2026-07-13': { morning: true, afternoon: true },
                '2026-07-14': { morning: true, afternoon: false },
                '2026-07-15': { morning: false, afternoon: false },
              };
              assert.ok(await storage.set('camp_counselor_schedule', 'main', schedule), 'Failed to save schedule');
            }
          },
          {
            name: "Verify availability in database",
            fn: async () => {
              const avail = await getMainData('camp_counselor_availability') || {};
              const ca = avail[TD.counselorEmail];
              assert.ok(ca, 'Counselor availability not found');
              assert.ok(ca['2026-07-13'].available.includes('morning'), 'Expected morning available on 7/13');
              assert.ok(ca['2026-07-14'].unavailable.includes('afternoon'), 'Expected afternoon unavailable on 7/14');
            }
          },
          {
            name: "Verify schedule in database",
            fn: async () => {
              const schedule = await getMainData('camp_counselor_schedule') || {};
              const cs = schedule[TD.counselorId];
              assert.ok(cs, 'Counselor schedule not found');
              assert.equal(cs['2026-07-13'].morning, true);
              assert.equal(cs['2026-07-14'].afternoon, false);
            }
          },
        ]
      },

      // ═══════════════════════════════════════════════════════════════
      // CLEANUP — Removes all test data
      // ═══════════════════════════════════════════════════════════════
      {
        name: "Cleanup \u2014 Remove All Test Data",
        section: "flows",
        category: "cleanup",
        icon: "\ud83e\uddf9",
        tests: [
          {
            name: "Remove test parent",
            fn: async () => {
              const parents = await getMainData('camp_parents') || [];
              await storage.set('camp_parents', 'main', parents.filter(p => !isTestData(p.email)));
              const after = await getMainData('camp_parents') || [];
              assert.notIncludes(after, p => isTestData(p.email), 'Test parent still exists');
            }
          },
          {
            name: "Remove test camper",
            fn: async () => {
              const campers = await getMainData('camp_campers') || [];
              await storage.set('camp_campers', 'main', campers.filter(c => !isTestData(c.id)));
              const after = await getMainData('camp_campers') || [];
              assert.notIncludes(after, c => isTestData(c.id), 'Test camper still exists');
            }
          },
          {
            name: "Remove test camper-parent links",
            fn: async () => {
              const links = await getMainData('camp_camper_parent_links') || [];
              await storage.set('camp_camper_parent_links', 'main', links.filter(l => !isTestData(l.camperId) && !isTestData(l.parentEmail)));
              const after = await getMainData('camp_camper_parent_links') || [];
              assert.notIncludes(after, l => isTestData(l.camperId), 'Test link still exists');
            }
          },
          {
            name: "Remove test emergency contacts",
            fn: async () => {
              const contacts = await getMainData('camp_emergency_contacts') || [];
              await storage.set('camp_emergency_contacts', 'main', contacts.filter(c => !isTestData(c.id) && !isTestData(c.userEmail)));
              const after = await getMainData('camp_emergency_contacts') || [];
              assert.notIncludes(after, c => isTestData(c.id), 'Test EC still exists');
            }
          },
          {
            name: "Remove test registration",
            fn: async () => {
              const rows = await storage.get('camp_registrations');
              for (const row of (rows || []).filter(r => isTestData(r.id))) {
                await storage.deleteRow('camp_registrations', row.id);
              }
              const after = await storage.get('camp_registrations');
              assert.equal((after || []).filter(r => isTestData(r.id)).length, 0, 'Test registration still exists');
            }
          },
          {
            name: "Remove test counselor user",
            fn: async () => {
              const users = await getMainData('camp_counselor_users') || [];
              await storage.set('camp_counselor_users', 'main', users.filter(u => !isTestData(u.email)));
              const after = await getMainData('camp_counselor_users') || [];
              assert.notIncludes(after, u => isTestData(u.email), 'Test counselor user still exists');
            }
          },
          {
            name: "Remove test counselor profile",
            fn: async () => {
              const rows = await storage.get('camp_counselors');
              for (const row of (rows || []).filter(r => isTestData(r.id))) {
                await storage.deleteRow('camp_counselors', row.id);
              }
              const after = await storage.get('camp_counselors');
              assert.equal((after || []).filter(r => isTestData(r.id)).length, 0, 'Test counselor profile still exists');
            }
          },
          {
            name: "Remove test availability & schedule",
            fn: async () => {
              const avail = await getMainData('camp_counselor_availability') || {};
              const cleanAvail = {};
              for (const [k, v] of Object.entries(avail)) { if (!isTestData(k)) cleanAvail[k] = v; }
              await storage.set('camp_counselor_availability', 'main', cleanAvail);

              const sched = await getMainData('camp_counselor_schedule') || {};
              const cleanSched = {};
              for (const [k, v] of Object.entries(sched)) { if (!isTestData(k)) cleanSched[k] = v; }
              await storage.set('camp_counselor_schedule', 'main', cleanSched);

              const afterAvail = await getMainData('camp_counselor_availability') || {};
              const afterSched = await getMainData('camp_counselor_schedule') || {};
              assert.equal(Object.keys(afterAvail).filter(k => isTestData(k)).length, 0, 'Test availability still exists');
              assert.equal(Object.keys(afterSched).filter(k => isTestData(k)).length, 0, 'Test schedule still exists');
            }
          },
        ]
      },
    ];

    // ==================== TEST RUNNER ====================
    const runTest = async (test) => {
      const start = performance.now();
      try {
        await test.fn();
        return { name: test.name, status: 'pass', duration: Math.round(performance.now() - start), error: null };
      } catch (e) {
        return { name: test.name, status: 'fail', duration: Math.round(performance.now() - start), error: e.message };
      }
    };

    // ==================== COPY RESULTS ====================
    const generateResultsText = (suiteResults) => {
      const allResults = suiteResults.flat();
      if (allResults.length === 0) return 'No tests have been run yet.';

      const totalPassed = allResults.filter(r => r.status === 'pass').length;
      const totalFailed = allResults.filter(r => r.status === 'fail').length;
      const total = allResults.length;

      let text = `Roosevelt Camp Test Results - v${VERSION}\n`;
      text += `Date: ${new Date().toLocaleString()}\n`;
      text += `Schema: ${SCHEMA} | Environment: ${ENV}\n`;
      text += `Results: ${totalPassed} passed, ${totalFailed} failed, ${total} total\n`;
      text += '─'.repeat(50) + '\n\n';

      ALL_SUITES.forEach((suite, i) => {
        const results = suiteResults[i];
        if (!results || results.length === 0) return;

        const passed = results.filter(r => r.status === 'pass').length;
        const failed = results.filter(r => r.status === 'fail').length;

        text += `${suite.name} (${passed}/${results.length} passed)\n`;

        results.forEach(r => {
          const icon = r.status === 'pass' ? 'PASS' : 'FAIL';
          text += `  [${icon}] ${r.name}`;
          if (r.duration) text += ` (${r.duration}ms)`;
          text += '\n';
          if (r.error) text += `         Error: ${r.error}\n`;
        });

        text += '\n';
      });

      return text;
    };

    // ==================== VERSION RIBBON ====================
    const VersionRibbon = () => {
      const [elapsed, setElapsed] = useState('');
      useEffect(() => {
        const update = () => {
          const secs = Math.floor((new Date() - BUILD_DATE) / 1000);
          if (secs < 60) setElapsed(`${secs}s ago`);
          else if (secs < 3600) setElapsed(`${Math.floor(secs / 60)}m ${secs % 60}s ago`);
          else setElapsed(`${Math.floor(secs / 3600)}h ${Math.floor((secs % 3600) / 60)}m ago`);
        };
        update();
        const id = setInterval(update, 1000);
        return () => clearInterval(id);
      }, []);
      const bgColor = ENV === 'development' ? 'bg-red-600' : 'bg-green-600';
      return (
        <div className={`${bgColor} text-white text-sm font-mono py-1 px-4 flex items-center justify-center gap-2`}>
          <span className="font-bold">{ENV === 'development' ? 'DEVELOPMENT' : 'PRODUCTION'}</span>
          <span>{'\u2022'}</span>
          <span>v{VERSION}</span>
          <span>{'\u2022'}</span>
          <span>TEST SUITE</span>
          <span>{'\u2022'}</span>
          <span>Schema: {SCHEMA}</span>
          <span>({elapsed})</span>
        </div>
      );
    };

    // ==================== UI COMPONENTS ====================
    const TestResultRow = ({ result }) => {
      const [showError, setShowError] = useState(false);
      const icon = result.status === 'pass' ? '\u2705' : result.status === 'fail' ? '\u274c' : '\u23f3';
      return (
        <div className="border-b border-gray-100 last:border-0">
          <div className="flex items-center justify-between py-2 px-3">
            <div className="flex items-center gap-2">
              <span className="text-sm">{icon}</span>
              <span className={`text-sm ${result.status === 'fail' ? 'text-red-600 font-medium' : 'text-gray-600'}`}>
                {result.name}
              </span>
            </div>
            <div className="flex items-center gap-3">
              <span className="text-gray-300 text-xs">{result.duration}ms</span>
              {result.error && (
                <button onClick={() => setShowError(!showError)} className="text-red-500 text-xs underline hover:text-red-700">
                  {showError ? 'hide' : 'details'}
                </button>
              )}
            </div>
          </div>
          {showError && result.error && (
            <pre className="mx-3 mb-2 p-2 bg-red-50 text-red-700 text-xs rounded font-mono border border-red-200 whitespace-pre-wrap">
              {result.error}
            </pre>
          )}
        </div>
      );
    };

    const StatusBadge = ({ exists }) => (
      <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium ${exists ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}>
        <span className={`w-2 h-2 rounded-full ${exists ? 'bg-green-500' : 'bg-gray-300'}`}></span>
        {exists ? 'In DB' : 'Not Added'}
      </span>
    );

    const TestSuiteCard = ({ suite, results, running, onRun }) => {
      const passed = results.filter(r => r.status === 'pass').length;
      const failed = results.filter(r => r.status === 'fail').length;
      const total = suite.tests.length;
      const hasRun = results.length > 0;
      const allPassed = hasRun && failed === 0 && passed === total;

      return (
        <div className={`border rounded-xl overflow-hidden bg-white ${hasRun ? (allPassed ? 'border-green-300' : 'border-red-300') : 'border-gray-200'}`}>
          <div className="px-5 py-4 flex items-center justify-between bg-white">
            <div className="flex items-center gap-3">
              <span className="text-xl">{suite.icon}</span>
              <div>
                <h3 className="font-bold text-gray-800">{suite.name}</h3>
                <span className="text-xs text-gray-400">{total} tests</span>
              </div>
            </div>
            <div className="flex items-center gap-3">
              {hasRun && (
                <div className="flex items-center gap-2 text-sm">
                  <span className="text-green-600 font-medium">{passed} passed</span>
                  {failed > 0 && <span className="text-red-600 font-medium">{failed} failed</span>}
                </div>
              )}
              <button
                onClick={onRun}
                disabled={running}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                  running
                    ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                    : 'bg-green-600 text-white hover:bg-green-700'
                }`}
              >
                {running ? 'Running...' : 'Run'}
              </button>
            </div>
          </div>
          {results.length > 0 && (
            <div className="border-t border-gray-100">
              {results.map((r, i) => <TestResultRow key={i} result={r} />)}
            </div>
          )}
        </div>
      );
    };

    // ==================== MAIN APP ====================
    const TestsApp = () => {
      const [suiteResults, setSuiteResults] = useState(ALL_SUITES.map(() => []));
      const [runningIdx, setRunningIdx] = useState(null); // which suite is running (-1 = run all)
      const [isBlocked, setIsBlocked] = useState(false);
      const [copied, setCopied] = useState(false);
      const [showResultsText, setShowResultsText] = useState(false);
      const [parentStatus, setParentStatus] = useState({});
      const [counselorStatus, setCounselorStatus] = useState({});
      const [seedLoading, setSeedLoading] = useState({});
      const [seedMessage, setSeedMessage] = useState(null);
      const [seedChecking, setSeedChecking] = useState(true);
      const [expandedSeed, setExpandedSeed] = useState({});

      // Safety: block on production
      useEffect(() => {
        if (SCHEMA !== 'dev') setIsBlocked(true);
      }, []);

      // Load seed user status + photos on mount
      const checkSeedStatus = useCallback(async () => {
        setSeedChecking(true);
        try {
          if (Object.keys(COUNSELOR_PHOTOS).length === 0) {
            try {
              const resp = await fetch('/seed-photos.json');
              if (resp.ok) COUNSELOR_PHOTOS = await resp.json();
            } catch (e) { console.warn('Could not load seed-photos.json:', e.message); }
          }
          const parents = await getMainData('camp_parents') || [];
          const pStatus = {};
          PARENT_PROFILES.forEach(p => { pStatus[p.email] = parents.some(x => x.email === p.email); });
          setParentStatus(pStatus);
          const users = await getMainData('camp_counselor_users') || [];
          const cStatus = {};
          COUNSELOR_PROFILES.forEach(c => { cStatus[c.email] = users.some(u => u.email === c.email); });
          setCounselorStatus(cStatus);
        } catch (e) { console.error('Seed status check failed:', e); }
        setSeedChecking(false);
      }, []);
      useEffect(() => { checkSeedStatus(); }, [checkSeedStatus]);

      const showSeedMsg = (text, type = 'success') => {
        setSeedMessage({ text, type });
        setTimeout(() => setSeedMessage(null), 3000);
      };
      const handleSeedAdd = async (type, profile) => {
        setSeedLoading(prev => ({ ...prev, [profile.email]: true }));
        try {
          if (type === 'parent') await seedAddParent(profile);
          else await seedAddCounselor(profile);
          showSeedMsg(`${profile.name} added`);
          await checkSeedStatus();
        } catch (e) { showSeedMsg(`Error: ${e.message}`, 'error'); }
        setSeedLoading(prev => ({ ...prev, [profile.email]: false }));
      };
      const handleSeedRemove = async (type, profile) => {
        setSeedLoading(prev => ({ ...prev, [profile.email]: true }));
        try {
          if (type === 'parent') await seedRemoveParent(profile);
          else await seedRemoveCounselor(profile);
          showSeedMsg(`${profile.name} removed`);
          await checkSeedStatus();
        } catch (e) { showSeedMsg(`Error: ${e.message}`, 'error'); }
        setSeedLoading(prev => ({ ...prev, [profile.email]: false }));
      };
      const addAllSeeds = async () => {
        setSeedLoading({ __all: true });
        let added = 0;
        for (const p of PARENT_PROFILES) {
          if (!parentStatus[p.email]) { try { await seedAddParent(p); added++; } catch (e) { console.error(e); } }
        }
        for (const c of COUNSELOR_PROFILES) {
          if (!counselorStatus[c.email]) { try { await seedAddCounselor(c); added++; } catch (e) { console.error(e); } }
        }
        showSeedMsg(`Added ${added} user(s)`);
        await checkSeedStatus();
        setSeedLoading({});
      };
      const removeAllSeeds = async () => {
        setSeedLoading({ __all: true });
        let removed = 0;
        for (const p of PARENT_PROFILES) {
          if (parentStatus[p.email]) { try { await seedRemoveParent(p); removed++; } catch (e) { console.error(e); } }
        }
        for (const c of COUNSELOR_PROFILES) {
          if (counselorStatus[c.email]) { try { await seedRemoveCounselor(c); removed++; } catch (e) { console.error(e); } }
        }
        showSeedMsg(`Removed ${removed} user(s)`);
        await checkSeedStatus();
        setSeedLoading({});
      };

      const runSuite = async (idx) => {
        setRunningIdx(idx);
        const newResults = [...suiteResults];
        newResults[idx] = [];
        setSuiteResults([...newResults]);

        for (const test of ALL_SUITES[idx].tests) {
          const result = await runTest(test);
          newResults[idx] = [...newResults[idx], result];
          setSuiteResults([...newResults]);
        }
        setRunningIdx(null);
      };

      const runAll = async () => {
        // Fresh test data for each full run
        TEST_RUN_ID = Date.now();
        TD = makeTestData();

        setRunningIdx(-1);
        const newResults = ALL_SUITES.map(() => []);
        setSuiteResults(newResults);

        for (let i = 0; i < ALL_SUITES.length; i++) {
          for (const test of ALL_SUITES[i].tests) {
            const result = await runTest(test);
            newResults[i] = [...newResults[i], result];
            setSuiteResults([...newResults.map(r => [...r])]);
          }
        }
        setRunningIdx(null);
      };

      const runCleanupOnly = async () => {
        const idx = ALL_SUITES.findIndex(s => s.category === 'cleanup');
        if (idx >= 0) await runSuite(idx);
      };

      // Summary stats
      const totalTests = ALL_SUITES.reduce((a, s) => a + s.tests.length, 0);
      const totalPassed = suiteResults.flat().filter(r => r.status === 'pass').length;
      const totalFailed = suiteResults.flat().filter(r => r.status === 'fail').length;
      const totalRun = suiteResults.flat().length;
      const allDone = totalRun === totalTests && totalRun > 0;
      const allPassed = allDone && totalFailed === 0;

      // Seed stats
      const totalParentsIn = Object.values(parentStatus).filter(Boolean).length;
      const totalCounselorsIn = Object.values(counselorStatus).filter(Boolean).length;
      const totalSeedIn = totalParentsIn + totalCounselorsIn;
      const totalSeedUsers = PARENT_PROFILES.length + COUNSELOR_PROFILES.length;
      const isSeedAllLoading = seedLoading.__all;

      if (isBlocked) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-red-50">
            <div className="text-center p-10">
              <div className="text-6xl mb-4">{'\ud83d\uded1'}</div>
              <h1 className="text-2xl font-bold text-red-700 mb-2">Tests Blocked</h1>
              <p className="text-red-600">Cannot run tests against production schema.</p>
              <p className="text-red-500 mt-2">Open this page on <code className="bg-red-100 px-2 py-1 rounded">localhost</code> to use the dev schema.</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50">
          <VersionRibbon />

          {/* Seed toast */}
          {seedMessage && (
            <div className={`fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-white text-sm font-medium ${seedMessage.type === 'error' ? 'bg-red-600' : 'bg-green-600'}`}>
              {seedMessage.text}
            </div>
          )}

          {/* Header */}
          <div className="bg-green-900 text-white py-6 px-6">
            <div className="max-w-4xl mx-auto flex items-center justify-between">
              <div>
                <h1 className="font-display text-4xl tracking-wide">Roosevelt Camp Test Suite</h1>
                <p className="text-green-300 text-sm mt-1">Tests, flow validation, and seed user management</p>
              </div>
              <a href="/prd.html" className="px-4 py-2 bg-green-700 hover:bg-green-600 rounded-lg text-sm transition-colors">
                {'\u2190'} Back to PRD
              </a>
            </div>
          </div>

          {/* Summary bar */}
          <div className={`py-3 px-6 border-b ${allDone ? (allPassed ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200') : 'bg-white border-gray-200'}`}>
            <div className="max-w-4xl mx-auto flex items-center justify-between">
              <div className="flex items-center gap-6">
                <div className="text-sm">
                  <span className="font-bold text-gray-800">{totalTests}</span> <span className="text-gray-500">total tests</span>
                </div>
                {totalRun > 0 && (
                  <>
                    <div className="text-sm">
                      <span className="font-bold text-green-600">{totalPassed}</span> <span className="text-gray-500">passed</span>
                    </div>
                    {totalFailed > 0 && (
                      <div className="text-sm">
                        <span className="font-bold text-red-600">{totalFailed}</span> <span className="text-gray-500">failed</span>
                      </div>
                    )}
                    <div className="w-48 h-2 bg-gray-200 rounded-full overflow-hidden">
                      <div className="h-full bg-green-500 rounded-full transition-all" style={{ width: `${(totalPassed / totalTests) * 100}%` }}></div>
                    </div>
                  </>
                )}
              </div>
              <div className="flex items-center gap-2">
                {totalRun > 0 && (
                  <button
                    onClick={() => {
                      const text = generateResultsText(suiteResults);
                      navigator.clipboard.writeText(text).then(() => {
                        setCopied(true);
                        setTimeout(() => setCopied(false), 2000);
                      });
                    }}
                    className="px-4 py-2 rounded-lg font-medium transition-colors bg-gray-700 text-white hover:bg-gray-800 shadow-sm text-sm"
                  >
                    {copied ? 'Copied!' : 'Copy Results'}
                  </button>
                )}
                <button
                  onClick={runCleanupOnly}
                  disabled={runningIdx !== null}
                  className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                    runningIdx !== null
                      ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                      : 'bg-orange-500 text-white hover:bg-orange-600 shadow-sm'
                  }`}
                >
                  Cleanup Only
                </button>
                <button
                  onClick={runAll}
                  disabled={runningIdx !== null}
                  className={`px-5 py-2 rounded-lg font-medium transition-colors ${
                    runningIdx !== null
                      ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                      : 'bg-green-600 text-white hover:bg-green-700 shadow-sm'
                  }`}
                >
                  {runningIdx === -1 ? 'Running All...' : 'Run All Tests'}
                </button>
              </div>
            </div>
          </div>

          {/* ==================== SEED USERS ==================== */}
          <div className="max-w-4xl mx-auto px-6 pt-6">
            <div>
              <h2 className="text-lg font-bold text-gray-800">Seed Users</h2>
              <p className="text-sm text-gray-500 mb-3">Pre-built parent and counselor profiles. Click Add to populate the dev database.</p>
            </div>

            <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
              <div className="flex flex-wrap items-center justify-between px-5 py-3 bg-gray-50 border-b">
                <div className="text-sm text-gray-600">
                  <span className="font-bold text-gray-800">{totalSeedIn}/{totalSeedUsers}</span> users in database
                  {seedChecking && <span className="text-gray-400 ml-2">(checking...)</span>}
                </div>
                <div className="flex gap-2">
                  <button onClick={checkSeedStatus} disabled={isSeedAllLoading}
                    className="px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">Refresh</button>
                  <button onClick={addAllSeeds} disabled={isSeedAllLoading || totalSeedIn === totalSeedUsers}
                    className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ${totalSeedIn === totalSeedUsers || isSeedAllLoading ? 'bg-gray-200 text-gray-400' : 'bg-green-600 text-white hover:bg-green-700'}`}>
                    {isSeedAllLoading ? 'Working...' : 'Add All'}</button>
                  <button onClick={removeAllSeeds} disabled={isSeedAllLoading || totalSeedIn === 0}
                    className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ${totalSeedIn === 0 || isSeedAllLoading ? 'bg-gray-200 text-gray-400' : 'bg-red-500 text-white hover:bg-red-600'}`}>
                    Remove All</button>
                </div>
              </div>
              <table className="w-full text-sm">
                <thead><tr className="border-b bg-gray-50 text-left">
                  <th className="px-5 py-2 text-gray-500 font-medium w-10"></th>
                  <th className="px-5 py-2 text-gray-500 font-medium">Name</th>
                  <th className="px-5 py-2 text-gray-500 font-medium hidden sm:table-cell">Email / Password</th>
                  <th className="px-5 py-2 text-gray-500 font-medium hidden md:table-cell">Details</th>
                  <th className="px-5 py-2 text-gray-500 font-medium text-center">Status</th>
                  <th className="px-5 py-2 text-gray-500 font-medium text-right">Action</th>
                </tr></thead>
                <tbody>
                  {PARENT_PROFILES.map(p => {
                    const exists = parentStatus[p.email];
                    const busy = !!seedLoading[p.email] || isSeedAllLoading;
                    const isExpanded = expandedSeed[p.email];
                    return (
                      <React.Fragment key={p.email}>
                      <tr className={`border-b hover:bg-gray-50 cursor-pointer ${exists ? 'bg-green-50/40' : ''}`}
                        onClick={() => setExpandedSeed(prev => ({...prev, [p.email]: !prev[p.email]}))}>
                        <td className="px-5 py-2.5 text-lg">{'\ud83d\udc6a'}</td>
                        <td className="px-5 py-2.5">
                          <div className="font-medium text-gray-800">
                            <span className={`inline-block mr-1 text-xs transition-transform ${isExpanded ? 'transform rotate-90' : ''}`}>▶</span>
                            {p.name}
                          </div>
                        </td>
                        <td className="px-5 py-2.5 hidden sm:table-cell">
                          <div className="text-gray-600 font-mono text-xs">{p.email}</div>
                          <div className="text-gray-400 font-mono text-xs">{p.password}</div>
                        </td>
                        <td className="px-5 py-2.5 text-gray-500 text-xs hidden md:table-cell">
                          {p.campers.length} camper{p.campers.length > 1 ? 's' : ''}, {p.registration?.weeks?.length || 0} wk
                        </td>
                        <td className="px-5 py-2.5 text-center"><StatusBadge exists={exists} /></td>
                        <td className="px-5 py-2.5 text-right" onClick={e => e.stopPropagation()}>
                          {!exists ? (
                            <button onClick={() => handleSeedAdd('parent', p)} disabled={busy}
                              className={`px-3 py-1 rounded-lg text-xs font-medium transition-colors ${busy ? 'bg-gray-200 text-gray-400' : 'bg-green-600 text-white hover:bg-green-700'}`}>
                              {busy ? '...' : 'Add'}</button>
                          ) : (
                            <button onClick={() => handleSeedRemove('parent', p)} disabled={busy}
                              className={`px-3 py-1 rounded-lg text-xs font-medium transition-colors ${busy ? 'bg-gray-200 text-gray-400' : 'bg-red-500 text-white hover:bg-red-600'}`}>
                              {busy ? '...' : 'Remove'}</button>
                          )}
                        </td>
                      </tr>
                      {isExpanded && (
                        <tr className={`border-b ${exists ? 'bg-green-50/20' : 'bg-gray-50/50'}`}>
                          <td colSpan="6" className="px-5 py-3">
                            <div className="ml-6 space-y-2 text-xs">
                              <div>
                                <span className="font-semibold text-gray-700">Phone:</span>
                                <span className="ml-2 text-gray-600">{p.phone}</span>
                              </div>
                              <div>
                                <span className="font-semibold text-gray-700">Campers:</span>
                                <div className="ml-4 mt-1 space-y-1">
                                  {p.campers.map((c, i) => (
                                    <div key={i} className="flex gap-4 text-gray-600">
                                      <span className="font-medium">{c.name}</span>
                                      <span>Grade {c.grade}</span>
                                      <span>DOB: {c.birthdate}</span>
                                      <span>{c.phone}</span>
                                    </div>
                                  ))}
                                </div>
                              </div>
                              <div>
                                <span className="font-semibold text-gray-700">Emergency Contacts:</span>
                                <div className="ml-4 mt-1 space-y-1">
                                  {p.emergencyContacts.map((ec, i) => (
                                    <div key={i} className="text-gray-600">
                                      {ec.name} — {ec.phone} ({ec.relationship})
                                    </div>
                                  ))}
                                </div>
                              </div>
                              {p.registration && (
                                <div>
                                  <span className="font-semibold text-gray-700">Registration:</span>
                                  <span className="ml-2 text-gray-600">
                                    {p.registration.weeks.length} week{p.registration.weeks.length > 1 ? 's' : ''} • {p.registration.sessions.join(' + ')}
                                  </span>
                                </div>
                              )}
                            </div>
                          </td>
                        </tr>
                      )}
                      </React.Fragment>
                    );
                  })}
                  <tr className="border-b bg-gray-50"><td colSpan="6" className="px-5 py-1"></td></tr>
                  {COUNSELOR_PROFILES.map(c => {
                    const exists = counselorStatus[c.email];
                    const busy = !!seedLoading[c.email] || isSeedAllLoading;
                    const photoSrc = COUNSELOR_PHOTOS[c.id] || null;
                    const isExpanded = expandedSeed[c.email];
                    const availDays = c.availability ? Object.keys(c.availability).length : 0;
                    return (
                      <React.Fragment key={c.email}>
                      <tr className={`border-b hover:bg-gray-50 cursor-pointer ${exists ? 'bg-green-50/40' : ''}`}
                        onClick={() => setExpandedSeed(prev => ({...prev, [c.email]: !prev[c.email]}))}>
                        <td className="px-5 py-2.5">{photoSrc ? <img src={photoSrc} className="w-7 h-7 rounded-full object-cover" /> : <span className="text-lg">{'\ud83c\udfc0'}</span>}</td>
                        <td className="px-5 py-2.5">
                          <div className="font-medium text-gray-800">
                            <span className={`inline-block mr-1 text-xs transition-transform ${isExpanded ? 'transform rotate-90' : ''}`}>▶</span>
                            {c.name}
                          </div>
                        </td>
                        <td className="px-5 py-2.5 hidden sm:table-cell">
                          <div className="text-gray-600 font-mono text-xs">{c.email}</div>
                          <div className="text-gray-400 font-mono text-xs">{c.password}</div>
                        </td>
                        <td className="px-5 py-2.5 text-gray-500 text-xs hidden md:table-cell">
                          {c.position}, {c.year}
                        </td>
                        <td className="px-5 py-2.5 text-center"><StatusBadge exists={exists} /></td>
                        <td className="px-5 py-2.5 text-right" onClick={e => e.stopPropagation()}>
                          {!exists ? (
                            <button onClick={() => handleSeedAdd('counselor', c)} disabled={busy}
                              className={`px-3 py-1 rounded-lg text-xs font-medium transition-colors ${busy ? 'bg-gray-200 text-gray-400' : 'bg-green-600 text-white hover:bg-green-700'}`}>
                              {busy ? '...' : 'Add'}</button>
                          ) : (
                            <button onClick={() => handleSeedRemove('counselor', c)} disabled={busy}
                              className={`px-3 py-1 rounded-lg text-xs font-medium transition-colors ${busy ? 'bg-gray-200 text-gray-400' : 'bg-red-500 text-white hover:bg-red-600'}`}>
                              {busy ? '...' : 'Remove'}</button>
                          )}
                        </td>
                      </tr>
                      {isExpanded && (
                        <tr className={`border-b ${exists ? 'bg-green-50/20' : 'bg-gray-50/50'}`}>
                          <td colSpan="6" className="px-5 py-3">
                            <div className="ml-6 space-y-2 text-xs">
                              <div>
                                <span className="font-semibold text-gray-700">Phone:</span>
                                <span className="ml-2 text-gray-600">{c.phone}</span>
                              </div>
                              <div>
                                <span className="font-semibold text-gray-700">Position:</span>
                                <span className="ml-2 text-gray-600">{c.position}</span>
                              </div>
                              <div>
                                <span className="font-semibold text-gray-700">Year:</span>
                                <span className="ml-2 text-gray-600">{c.year}</span>
                              </div>
                              {c.bio && (
                                <div>
                                  <span className="font-semibold text-gray-700">Bio:</span>
                                  <span className="ml-2 text-gray-600">{c.bio}</span>
                                </div>
                              )}
                              <div>
                                <span className="font-semibold text-gray-700">Availability:</span>
                                <span className="ml-2 text-gray-600">{availDays} days set</span>
                                <div className="ml-4 mt-1 flex flex-wrap gap-1">
                                  {Object.entries(c.availability || {}).map(([date, slots]) => (
                                    <span key={date} className={`px-1.5 py-0.5 rounded text-[10px] font-mono ${
                                      slots[0] && slots[1] ? 'bg-green-100 text-green-700' :
                                      slots[0] || slots[1] ? 'bg-yellow-100 text-yellow-700' :
                                      'bg-red-100 text-red-700'
                                    }`}>
                                      {new Date(date + 'T12:00:00').toLocaleDateString('en-US', {month:'short', day:'numeric'})}
                                      {slots[0] && slots[1] ? ' ✓' : slots[0] ? ' AM' : slots[1] ? ' PM' : ' ✗'}
                                    </span>
                                  ))}
                                </div>
                              </div>
                            </div>
                          </td>
                        </tr>
                      )}
                      </React.Fragment>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>

          {/* Test suites grouped by section */}
          <div className="max-w-4xl mx-auto px-6 py-6 space-y-4">
            {ALL_SUITES.map((suite, i) => {
              const prevSection = i > 0 ? ALL_SUITES[i - 1].section : null;
              const showHeader = suite.section !== prevSection && SECTIONS[suite.section];
              const sec = SECTIONS[suite.section];
              return (
                <React.Fragment key={i}>
                  {showHeader && (
                    <div className={`${i > 0 ? 'mt-8 pt-6 border-t-2 border-gray-300' : ''}`}>
                      <h2 className="text-lg font-bold text-gray-800">{sec.title}</h2>
                      <p className="text-sm text-gray-500 mb-3">{sec.subtitle}</p>
                    </div>
                  )}
                  <TestSuiteCard
                    suite={suite}
                    results={suiteResults[i]}
                    running={runningIdx === i || runningIdx === -1}
                    onRun={() => runSuite(i)}
                  />
                </React.Fragment>
              );
            })}
          </div>

          {/* Copy Results Section */}
          {totalRun > 0 && (
            <div className="max-w-4xl mx-auto px-6 pb-6">
              <button
                onClick={() => setShowResultsText(!showResultsText)}
                className="text-sm text-gray-500 hover:text-gray-700 underline"
              >
                {showResultsText ? 'Hide' : 'Show'} plain text results (for sharing with Claude)
              </button>
              {showResultsText && (
                <div className="mt-3 relative">
                  <button
                    onClick={() => {
                      const text = generateResultsText(suiteResults);
                      navigator.clipboard.writeText(text).then(() => {
                        setCopied(true);
                        setTimeout(() => setCopied(false), 2000);
                      });
                    }}
                    className="absolute top-2 right-2 px-3 py-1 bg-gray-700 text-white text-xs rounded hover:bg-gray-800 transition-colors"
                  >
                    {copied ? 'Copied!' : 'Copy'}
                  </button>
                  <pre className="bg-gray-900 text-green-400 p-4 rounded-xl text-xs font-mono overflow-x-auto whitespace-pre-wrap border border-gray-700">
                    {generateResultsText(suiteResults)}
                  </pre>
                </div>
              )}
            </div>
          )}

          {/* Footer */}
          <div className="text-center text-gray-400 text-sm py-6 border-t border-gray-200 mt-4">
            {"Database & Logic tests are read-only. Flow tests create __test__ data then clean up. Seed users are persistent \u2014 use Add/Remove to manage them."}
          </div>
        </div>
      );
    };

    // ==================== INIT ====================
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<TestsApp />);
  </script>
</body>
</html>
