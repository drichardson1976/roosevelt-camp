<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Roosevelt Girls Basketball Day Camp 2026</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .font-display { font-family: 'Bebas Neue', sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ==================== CONFIGURATION ====================
    const SUPABASE_URL = 'https://rdrtsebhninqgfbrleft.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkcnRzZWJobmlucWdmYnJsZWZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2OTcyMTMsImV4cCI6MjA4NTI3MzIxM30.l6gt5vvG1bXemZt9_BKSRy4kzbSatE4UIrV0a872QYw';

    const getEnvironment = () => {
      const hostname = window.location.hostname;
      // GitHub Pages and localhost = development (uses dev schema)
      // Netlify production = production (uses public schema)
      return (hostname.includes('dev') || hostname.includes('localhost') || hostname.includes('127.0.0.1') || hostname.includes('--dev') || hostname.includes('github.io')) ? 'development' : 'production';
    };
    
    const ENV = getEnvironment();
    const SCHEMA = ENV === 'development' ? 'dev' : 'public';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      db: { schema: SCHEMA },
      global: { headers: { 'Accept-Profile': SCHEMA, 'Content-Profile': SCHEMA } }
    });
    
    console.log('Roosevelt Camp - Environment:', ENV, '- Schema:', SCHEMA);

    // ==================== VERSION INFO ====================
    const VERSION = "12.110";
    // BUILD_DATE - update this timestamp when committing changes
    const BUILD_DATE = new Date("2026-02-02T10:15:00");

    const RELEASE_NOTES = [
      { version: "12.110", date: "2026-02-02", author: "Derek Richardson", changes: [
        "Added author tracking to release notes",
        "Release notes now display who made each change"
      ]},
      { version: "12.109", date: "2026-02-02", author: "Derek Richardson", changes: [
        "Fixed afternoon session drop-off time (11:45 AM - 12:00 PM)",
        "Added basketball training focus section to schedule with drill descriptions",
        "Removed lunch restaurant options from public page",
        "Removed payment section from pricing page"
      ]},
      { version: "12.107", date: "2026-02-01", author: "Derek Richardson", changes: [
        "Registrations tab: Added ability to permanently delete registrations",
        "Delete confirmation modal prevents accidental deletions"
      ]},
      { version: "12.106", date: "2026-02-01", changes: [
        "Assignments tab: Counselors split into Eligible and Not Eligible groups",
        "Assignments tab: Registered campers shown as draggable list for pod assignment"
      ]},
      { version: "12.105", date: "2026-02-01", changes: [
        "Removed Children tab from admin dashboard",
        "Simplified Parents tab header to just 'Parents'",
        "Reordered admin tabs: Campers now follows Parents",
        "Redesigned Assignments tab with pod-based layout",
        "Pods can be added/removed, with counselor slot at top and 5 camper slots below",
        "Drag and drop support for both counselors and campers in pods"
      ]},
      { version: "12.104", date: "2026-02-01", changes: [
        "Simplified data model - removed children/campers distinction",
        "Parents now register campers directly during onboarding",
        "Updated parent onboarding to 'Add Campers' step",
        "Campers tab now shows all campers (not just those with approved registrations)",
        "All terminology updated from 'children' to 'campers' throughout",
        "Registrations now use camperId/camperName (backward compatible with childId/childName)"
      ]},
      { version: "12.103", date: "2026-02-01", changes: [
        "Updated counselor photos on public site - removed green background, 50% larger",
        "Made registration detail fields read-only (camper name, parent info, session date)",
        "Added rejected/cancelled registrations section to admin dashboard",
        "Updated campers tab to show approved and pending registration counts",
        "Removed manage parents option from camper summary"
      ]},
      { version: "12.102", date: "2026-02-01", changes: [
        "Fixed bulk registration creating only one registration",
        "Added registration details view with edit capability",
        "Added payment status visibility and mark-as-paid in pending registrations",
        "Made registration rows clickable to view/edit details"
      ]},
      { version: "12.101", date: "2026-01-31", changes: [
        "Moved policy info from Schedule to Pricing page",
        "Added bulk registration creation in Registrations tab",
        "Admin can create registrations for multiple children across multiple days/sessions/weeks",
        "Unified session selection UI with week headers and ‚òÄÔ∏è AM / üåô PM buttons",
      ]},
      { version: "12.100", date: "2026-01-31", changes: [
        "Phone validation now requires exactly 10 digits",
        "Parent onboarding steps 2-6 are now skippable (only account info required)",
        "Parent tab summary shows: Children, Campers, Approved/Pending Registrations, Unread Messages",
        "Admin can create registrations for parent's children",
        "Registration approval with payment verification in Approvals tab",
        "Renamed profile changes section to 'Counselor Profile Change Requests'",
        "Campers tab only shows children with approved registrations",
      ]},
      { version: "12.099", date: "2026-01-31", changes: [
        "Fixed Add Parent button showing blank screen (moved ParentOnboarding to correct scope)",
      ]},
      { version: "12.098", date: "2026-01-31", changes: [
        "Fixed counselor schedule modal staying open when toggling sessions",
        "Unified day/session UI: ‚òÄÔ∏è AM and üåô PM icons across all screens",
        "Counselor schedule modal now matches Sessions tab layout",
        "Parent registration date selector uses consistent styling",
        "Counselor availability calendar uses same icons"
      ]},
      { version: "12.097", date: "2026-01-31", changes: [
        "Counselors: renamed to Edit Profile/Edit Schedule, Delete moved inside profile",
        "Admin Add Parent now uses full parent onboarding wizard"
      ]},
      { version: "12.096", date: "2026-01-31", changes: [
        "Login page auto-focuses email input for faster typing",
        "Schedule eligibility modal now requires Done button to close",
        "All schedule changes logged to history"
      ]},
      { version: "12.095", date: "2026-01-31", changes: [
        "Dashboard stats now labeled as 'Registration Requests'",
        "Counselors tab: Schedule button to set work eligibility by week/day/session",
        "Counselors show eligible sessions count and scheduled (working) status",
        "Sessions marked with camper icon when counselor has assignments"
      ]},
      { version: "12.094", date: "2026-01-31", changes: [
        "Fixed popup/modal windows closing unexpectedly when clicking",
        "Added large navigation buttons to admin dashboard for quick access"
      ]},
      { version: "12.092", date: "2026-01-31", changes: [
        "Build timestamp now uses actual current time",
        "Sessions tab: toggle individual AM/PM sessions or whole day",
        "Sessions tab: stays in current month after changes",
        "Sessions tab: shows counselor availability and camper counts per session",
        "Parent registration: shows blocked AM/PM sessions individually"
      ]},
      { version: "12.091", date: "2026-01-31", changes: [
        "Larger navigation buttons for easier mobile use",
        "Registration deletion now cascades to remove camper from assignments",
        "New Sessions admin tab to block/unblock camp dates",
        "Blocked dates shown as unavailable in parent registration",
        "Reordered admin tabs: Counselors, Parents, Children, Registrations, Campers, Assignments, Sessions, Approval, Content, History"
      ]},
      { version: "12.090", date: "2026-01-31", changes: [
        "Moved counselors section up on homepage with larger circular headshots",
        "Removed green rectangle frames from counselor photos",
        "Changed to 'Easy Pick-up & Drop-off' text"
      ]},
      { version: "12.089", date: "2026-01-31", changes: [
        "Hero image now edge-to-edge",
        "New Pricing tab with pricing, discounts, and scholarship info",
        "Removed pre-order lunch options - campers bring their own lunch",
        "Updated snacks section with clearer messaging",
        "Simplified cancellation and late pickup policies"
      ]},
      { version: "12.088", date: "2026-01-31", changes: [
        "Mobile responsive improvements across entire site",
        "Navigation wraps and scales properly on small screens",
        "Hero section text sizes adjust for mobile devices",
        "Info cards and counselor grids use responsive breakpoints",
        "Admin/Parent dashboard tabs and headers scale for mobile",
        "Tables have horizontal scroll on small screens",
        "Footer contact info breaks properly on mobile",
        "Role selector and forms use appropriate mobile sizing"
      ]},
      { version: "12.087", date: "2026-01-31", changes: [
        "Version banner time now uses 12-hour format with AM/PM",
        "Photo re-editing preserves previous zoom, position, and rotation settings",
        "Original images stored for lossless re-editing",
        "Public site photos now use consistent 4:3 aspect ratios matching cropper"
      ]},
      { version: "12.086", date: "2026-01-31", changes: [
        "Version banner now shows build time in MM-DD-YYYY HH:MM format",
        "Version banner shows both build time and time since upload",
        "Release notes modal is now scrollable for long release histories"
      ]},
      { version: "12.085", date: "2026-01-31", changes: [
        "Scrollable tabs with drag-to-scroll in Admin and Parent dashboards",
        "Visual indicators (fade + arrows) when more tabs are available to scroll",
        "Admin content photos now display at correct aspect ratios matching website",
        "Increased image export resolution from 300px to 1200px for sharper photos",
        "Improved JPEG quality from 90% to 95% for uploaded images"
      ]},
      { version: "12.084", date: "2026-01-30", changes: ["Version bump for dev build"] },
      { version: "12.081", date: "2026-01-30", changes: [
        "Fixed input focus issue in onboarding flows - text fields now maintain focus",
        "Refactored ParentOnboarding to use inline JSX instead of inner components",
        "Refactored CounselorOnboarding to use inline JSX instead of inner components",
        "All form inputs throughout the site now work correctly without losing focus"
      ]},
      { version: "12.080", date: "2026-01-30", changes: [
        "Parent dashboard: 'Add Another Child' button replaces always-visible form",
        "New 'Camp Schedule' tab shows visual schedule with counselor & pod info",
        "Schedule tab displays pod mates and other campers at each session",
        "Counselor headshots shown in pod assignments",
        "Children remain as children even when registered as campers",
        "Admin Children tab now shows ALL children from both data sources",
        "Clear distinction: children are profiles, campers are registered children"
      ]},
      { version: "12.079", date: "2026-01-30", changes: [
        "Added Children tab in admin dashboard to view all child profiles",
        "Children tab separates registered (campers) from unregistered children",
        "Hidden 'Coming Soon' badges on Google/Apple login buttons",
        "Content tab has text editing and photo management (scroll down)",
        "Site Photos section in Content tab for hero image and activity photos"
      ]},
      { version: "12.078", date: "2026-01-30", changes: [
        "Removed admin credentials display from login page",
        "Added Google and Apple login buttons (Coming Soon)",
        "Login page visually shows social login options will be available",
        "Updated 'Create account' button text for clarity"
      ]},
      { version: "12.077", date: "2026-01-30", changes: [
        "Hero image: Admin can upload a large background photo for the hero section",
        "Activity photos: Drop-off, layups practice, and lunch photos throughout site",
        "Photo editor with zoom/crop shows exact preview of final result",
        "All site photos manageable from Admin Content tab",
        "Photos stored in database and persist across builds"
      ]},
      { version: "12.076", date: "2026-01-30", changes: [
        "Terminology update: Parents have 'children', registered children become 'campers'",
        "Parent dashboard: 'My Children' tab with clear profile management",
        "Registration confirmation now says 'Your children are now campers!'",
        "Clear messaging throughout: profiles vs registrations",
        "Admin tabs updated with clearer camper/children terminology"
      ]},
      { version: "12.075", date: "2026-01-29", changes: [
        "Food/snack/drink images are now perfectly square (aspect-square)",
        "Image cropper preview exactly matches how photos appear on website",
        "Square photos have rounded corners (rounded-xl) in both editor and site",
        "Admin thumbnails now square to match public display",
        "Edit modal preview labeled 'Preview (exactly as shown on website)'"
      ]},
      { version: "12.074", date: "2026-01-29", changes: [
        "Image cropper now supports shapes: circle (counselors), square (food photos)",
        "Added rotation slider and 90¬∞ rotate button to image editor",
        "Click any food photo to see 'Edit' overlay - opens edit modal",
        "Edit modal has: Upload New Photo, Adjust Position/Zoom/Rotate, Reset to Default",
        "Food/snack photos on Schedule page are now 2x larger",
        "Green dot indicator shows which photos have custom uploads"
      ]},
      { version: "12.073", date: "2026-01-29", changes: [
        "Food photo uploads now include zoom, crop, and pan controls",
        "Hover over any food photo to see upload and adjust buttons",
        "Adjust button opens the image cropper for existing photos",
        "Same image editor used for counselor photos"
      ]},
      { version: "12.072", date: "2026-01-29", changes: [
        "Fixed parent editing bug - changes now save properly",
        "Fixed child editing bug - changes now save properly",
        "Fixed registration editing bug - changes now save properly",
        "Admin can upload custom photos for snacks and drinks (Content tab)",
        "Food photos persist to database",
        "Reset button to restore default photos"
      ]},
      { version: "12.071", date: "2026-01-29", changes: [
        "All changes persist to database immediately",
        "Proper delete functions remove records from database",
        "Delete counselor: Removes from DB, cleans up assignments and availability",
        "Delete camper: Removes from DB, cleans up parent links and assignments",
        "Delete parent: Removes from DB, cleans up camper links",
        "DELETE confirmation modal for counselors (replaces browser confirm)",
        "UI updates instantly on all add/edit/delete operations",
        "All dynamic data stored in Supabase for persistence across builds"
      ]},
      { version: "12.070", date: "2026-01-29", changes: [
        "Standalone campers: Campers are now separate entities from parents",
        "Many-to-many relationships: A camper can have multiple parents, and a parent can have multiple campers",
        "Admin can add/edit/delete campers from Campers tab",
        "Admin can add/edit/delete parents from Parents tab",
        "Manage camper-parent associations from either tab",
        "Backward compatible with legacy children data",
        "Counselors tab has full CRUD (add/edit/delete/reorder)",
        "Camper can only be assigned to ONE counselor per session (enforced)"
      ]},
      { version: "12.069", date: "2026-01-29", changes: [
        "Admin management: Create, edit, delete admin accounts",
        "At least one admin always required",
        "Campers tab: View all registered campers with details",
        "Camper search, sort by name/age/grade/registrations",
        "Assignments tab: Drag-and-drop camper-counselor assignments",
        "View assignments by date and session (AM/PM)",
        "Capacity tracking: 5 campers max per counselor",
        "Auto-assign feature distributes campers evenly",
        "Empty spots summary to see available capacity"
      ]},
      { version: "12.068", date: "2026-01-29", changes: [
        "Enhanced counselor availability signup with bulk actions",
        "Camp dates auto-generated: Monday after school ends ‚Üí Friday before school starts",
        "Flexible registration with bulk discounts:",
        "  - 10% off for booking full week (all 5 days, AM & PM)",
        "  - 15% off for booking 2+ full weeks",
        "Quick 'Full Week' selection buttons for easy booking",
        "Order summary shows discount breakdown and savings",
        "Registrations store discount info for accounting"
      ]},
      { version: "12.067", date: "2026-01-29", changes: [
        "Admin can edit/delete parents, children, and registrations",
        "Type 'DELETE' confirmation for all deletions",
        "Location page with Roosevelt HS map, address, GPS links",
        "Schedule page shows pricing tiers and bulk discounts",
        "Cancellation policy (2 weeks advance notice)",
        "Late pickup policy (Starbucks gift card suggestion)",
        "Added Apple Maps and Google Maps direct links"
      ]},
      { version: "12.066", date: "2026-01-29", changes: [
        "Parents can now edit child details (name, birthdate, grade, phone, photo)",
        "Parents can delete children from their account (e.g., duplicates)",
        "Edit mode with inline form for child details",
        "Delete confirmation dialog to prevent accidents"
      ]},
      { version: "12.065", date: "2026-01-29", changes: [
        "Added Parents tab in admin to view all registered parents and campers",
        "Two-way in-app messaging system between admin and parents",
        "Message individual, multiple, or all parents",
        "Parents see messages in dashboard with unread indicators",
        "Conversation threads with reply functionality"
      ]},
      { version: "12.064", date: "2026-01-29", changes: [
        "Fixed modal closing when selecting text in edit forms",
        "Enhanced photo editing: adjust zoom/position, delete, or upload new",
        "Added counselor reordering with up/down arrows",
        "Counselor order persists and displays on public website"
      ]},
      { version: "12.063", date: "2026-01-29", changes: [
        "Fixed 1Password popup with data-1p-ignore attributes",
        "Admin shows as 'Admin' - click to go to admin portal",
        "Fixed input fields losing focus when typing",
        "Enhanced child form: photo upload, birthdate, calculated age, optional phone",
        "Auto-save for all content changes",
        "Added change history with timestamps"
      ]},
      { version: "12.061", date: "2026-01-29", changes: ["Fresh rebuild with all features", "Merged v12.042 features with Supabase schema separation", "Payment tracking, cancellation/refund system", "Collapsible calendar, scholarship requests"] },
      { version: "12.056", date: "2026-01-29", changes: ["Fixed counselor editing, photo cropper, phone formatting"] },
      { version: "12.054", date: "2026-01-29", changes: ["Fixed Supabase schema connection"] }
    ];

    const isDev = () => ENV === 'development';

    // ==================== CONSTANTS ====================
    const KIDS_PER_COUNSELOR = 5;

    // Seattle Public Schools 2025-2026: Last day of school is June 19, 2026 (Friday)
    // First day of school 2026-2027: September 2, 2026 (Wednesday)
    // Camp runs: Monday June 22, 2026 through Friday August 28, 2026
    const SCHOOL_YEAR_END = new Date(2026, 5, 19); // June 19, 2026 (Friday)
    const SCHOOL_YEAR_START = new Date(2026, 8, 2); // September 2, 2026 (Wednesday)

    const generateCampDates = () => {
      const dates = [];
      // Start on Monday after school ends
      const start = new Date(SCHOOL_YEAR_END);
      // Find next Monday after school ends
      while (start.getDay() !== 1) {
        start.setDate(start.getDate() + 1);
      }
      // End on Friday before school starts
      const end = new Date(SCHOOL_YEAR_START);
      // Find previous Friday before school starts
      while (end.getDay() !== 5) {
        end.setDate(end.getDate() - 1);
      }
      // Generate all weekdays (Mon-Fri) between start and end
      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        if (d.getDay() >= 1 && d.getDay() <= 5) {
          dates.push(new Date(d).toISOString().split('T')[0]);
        }
      }
      return dates;
    };
    const CAMP_DATES = generateCampDates();

    // Format camp date range for display
    const getCampDateRange = () => {
      if (CAMP_DATES.length === 0) return '';
      const start = new Date(CAMP_DATES[0] + 'T12:00:00');
      const end = new Date(CAMP_DATES[CAMP_DATES.length - 1] + 'T12:00:00');
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      return `${months[start.getMonth()]} ${start.getDate()} - ${months[end.getMonth()]} ${end.getDate()}, ${end.getFullYear()}`;
    };
    const CAMP_DATE_RANGE = getCampDateRange();
    
    const getWeeks = () => {
      const weeks = [];
      let currentWeek = [];
      let weekStart = null;
      CAMP_DATES.forEach((date, idx) => {
        const d = new Date(date + 'T12:00:00');
        if (d.getDay() === 1 || idx === 0) {
          if (currentWeek.length > 0) weeks.push({ start: weekStart, dates: currentWeek });
          currentWeek = [date];
          weekStart = date;
        } else {
          currentWeek.push(date);
        }
      });
      if (currentWeek.length > 0) weeks.push({ start: weekStart, dates: currentWeek });
      return weeks;
    };
    const CAMP_WEEKS = getWeeks();

    // ==================== DEFAULT DATA ====================
    const DEFAULT_CONTENT = {
      heroTitle: "Roosevelt Girls Basketball",
      heroSubtitle: "Summer Daycamp 2026",
      heroTagline: "Build Skills. Build Friendships. Build Your Future.",
      heroImage: null,
      venmoImage: null,
      venmoUsername: "@RHSDayCamp",
      aboutText: "Join us for an incredible summer of basketball at Roosevelt High School! Our camp is designed for young athletes who want to develop their basketball skills while having fun and making lasting friendships.",
      contactEmail: "rhsdaycamp@gmail.com",
      contactPhone: "(206) 384-1872",
      sessionMorning: "9:00 AM - 12:00 PM",
      sessionAfternoon: "12:00 PM - 3:00 PM",
      sessionCost: "$60",
      campDates: "June 22 - August 28, 2026",
      ageRange: "Completed 3rd - 8th Grade",
      // Location details
      locationName: "Roosevelt High School",
      locationAddress: "1410 NE 66th St",
      locationCity: "Seattle",
      locationState: "WA",
      locationZip: "98115",
      locationDetails: "Roosevelt High School Gymnasium - Enter through the main gym entrance on the east side of the building.",
      // Pricing tiers
      singleSessionCost: 60,
      weekDiscount: 10, // percent off for booking full week (10 sessions)
      multiWeekDiscount: 15, // percent off for 2+ weeks
      // Policies
      cancellationPolicy: "All cancellation requests must be submitted at least 14 days (2 weeks) before the scheduled session to receive a full refund. Cancellations made less than 14 days in advance are non-refundable but may be credited toward a future session at the camp director's discretion. No-shows are non-refundable.",
      latePickupPolicy: "Camp sessions end promptly at the scheduled time. Our counselors volunteer their time and have other commitments after camp. If you anticipate being late, please call us immediately. As a gesture of appreciation for counselors who stay late due to delayed pickups, we kindly suggest purchasing a small Starbucks gift card ($5-10) for the counselor who waited with your child. Repeated late pickups may result in dismissal from the camp.",
      scholarshipInfo: "We believe every child deserves the chance to experience our camp. Apply for scholarship assistance through your Parent Dashboard."
    };

    const DEFAULT_COUNSELORS = [
      { id: 'c1', name: 'Sarah Mitchell', email: 'sarah.mitchell@roosevelt.edu', phone: '(206) 555-0101', position: 'Point Guard', year: 'Senior', bio: 'Team captain with 3 years varsity experience.', photo: null, visible: true, order: 0 },
      { id: 'c2', name: 'Maya Johnson', email: 'maya.johnson@roosevelt.edu', phone: '(206) 555-0102', position: 'Shooting Guard', year: 'Senior', bio: 'Sharpshooter with excellent 3-point range.', photo: null, visible: true, order: 1 },
      { id: 'c3', name: 'Emma Chen', email: 'emma.chen@roosevelt.edu', phone: '(206) 555-0103', position: 'Small Forward', year: 'Junior', bio: 'Versatile player known for lockdown defense.', photo: null, visible: true, order: 2 },
      { id: 'c4', name: 'Jasmine Williams', email: 'jasmine.williams@roosevelt.edu', phone: '(206) 555-0104', position: 'Center', year: 'Junior', bio: 'Starting center with strong post moves.', photo: null, visible: true, order: 3 },
    ];

    const DEFAULT_ADMINS = [
      { id: 'admin_1', username: 'admin', password: 'admin', name: 'Camp Director', email: 'director@rooseveltcamp.com', createdAt: new Date().toISOString() }
    ];

    // ==================== STORAGE ====================
    const storage = {
      async get(table) {
        if (!supabase) return null;
        try {
          const { data, error } = await supabase.from(table).select('*');
          if (error) throw error;
          return data;
        } catch (e) {
          console.error('Error fetching ' + table + ':', e);
          return null;
        }
      },
      async set(table, id, data) {
        if (!supabase) return false;
        try {
          const { error } = await supabase.from(table).upsert({ id, data, updated_at: new Date().toISOString() });
          if (error) throw error;
          return true;
        } catch (e) {
          console.error('Error saving to ' + table + ':', e);
          return false;
        }
      }
    };

    // ==================== UTILITIES ====================
    const formatPhone = (value) => {
      const digits = value.replace(/\D/g, '').slice(0, 10);
      if (digits.length === 0) return '';
      if (digits.length <= 3) return '(' + digits;
      if (digits.length <= 6) return '(' + digits.slice(0, 3) + ') ' + digits.slice(3);
      return '(' + digits.slice(0, 3) + ') ' + digits.slice(3, 6) + '-' + digits.slice(6);
    };

    const isValidPhone = (phone) => (phone || '').replace(/\D/g, '').length === 10;

    const generateVenmoCode = (name) => {
      if (!name) return 'CAMP000';
      const parts = name.trim().split(' ');
      const first = (parts[0] || 'XXX').substring(0, 3).toUpperCase();
      const last = (parts[parts.length - 1] || 'XXX').substring(0, 3).toUpperCase();
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = ((hash << 5) - hash) + name.charCodeAt(i);
        hash = hash & hash;
      }
      return first + last + Math.abs(hash % 1000).toString().padStart(3, '0');
    };

    const getSessionCost = (content) => parseInt((content.sessionCost || '$60').replace(/[^0-9]/g, '')) || 60;

    // Calculate discounted total based on sessions selected
    // - 10% discount for booking a full week (both AM and PM for all 5 days = 10 sessions)
    // - 15% discount for booking 2+ full weeks
    const calculateDiscountedTotal = (selectedDates, numChildren, content) => {
      const basePrice = content.singleSessionCost || 60;
      const weekDiscount = (content.weekDiscount || 10) / 100;
      const multiWeekDiscount = (content.multiWeekDiscount || 15) / 100;

      // Group sessions by week
      const sessionsByWeek = {};
      Object.entries(selectedDates).forEach(([date, sessions]) => {
        if (!sessions?.length) return;
        // Find which week this date belongs to
        const weekIdx = CAMP_WEEKS.findIndex(w => w.dates.includes(date));
        if (weekIdx >= 0) {
          if (!sessionsByWeek[weekIdx]) sessionsByWeek[weekIdx] = { dates: {}, totalSessions: 0 };
          sessionsByWeek[weekIdx].dates[date] = sessions;
          sessionsByWeek[weekIdx].totalSessions += sessions.length;
        }
      });

      // Count full weeks (5 days with both AM and PM = 10 sessions)
      let fullWeeks = 0;
      let fullWeekSessions = 0;
      let partialSessions = 0;

      Object.values(sessionsByWeek).forEach(week => {
        const daysCount = Object.keys(week.dates).length;
        const hasBothSessions = Object.values(week.dates).every(s => s.includes('morning') && s.includes('afternoon'));

        if (daysCount === 5 && hasBothSessions && week.totalSessions === 10) {
          fullWeeks++;
          fullWeekSessions += 10;
        } else {
          partialSessions += week.totalSessions;
        }
      });

      // Calculate pricing
      const children = Math.max(1, numChildren);
      let subtotal = 0;
      let discount = 0;

      if (fullWeeks >= 2) {
        // Multi-week discount applies to all full weeks
        const fullWeekCost = fullWeekSessions * basePrice * children;
        discount = fullWeekCost * multiWeekDiscount;
        subtotal = fullWeekCost - discount + (partialSessions * basePrice * children);
      } else if (fullWeeks === 1) {
        // Single week discount
        const fullWeekCost = fullWeekSessions * basePrice * children;
        discount = fullWeekCost * weekDiscount;
        subtotal = fullWeekCost - discount + (partialSessions * basePrice * children);
      } else {
        // No discount - partial weeks only
        subtotal = (fullWeekSessions + partialSessions) * basePrice * children;
      }

      const totalSessions = fullWeekSessions + partialSessions;
      const originalTotal = totalSessions * basePrice * children;

      return {
        totalSessions,
        fullWeeks,
        partialSessions,
        originalTotal,
        discount,
        discountPercent: fullWeeks >= 2 ? multiWeekDiscount * 100 : fullWeeks === 1 ? weekDiscount * 100 : 0,
        finalTotal: Math.round(subtotal)
      };
    };

    const calculateAge = (birthdate) => {
      if (!birthdate) return null;
      const today = new Date();
      const birth = new Date(birthdate);
      let age = today.getFullYear() - birth.getFullYear();
      if (today.getMonth() < birth.getMonth() || (today.getMonth() === birth.getMonth() && today.getDate() < birth.getDate())) age--;
      return age;
    };

    const formatTimestamp = (date) => {
      const d = new Date(date);
      return d.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
      });
    };

    // ==================== STABLE INPUT COMPONENTS ====================
    const StableInput = React.memo(({ value, onSave, type = 'text', className = '', placeholder = '' }) => {
      const [local, setLocal] = useState(value || '');
      const inputRef = useRef(null);
      const initialValue = useRef(value);

      useEffect(() => {
        if (value !== initialValue.current && document.activeElement !== inputRef.current) {
          setLocal(value || '');
          initialValue.current = value;
        }
      }, [value]);

      const handleBlur = () => {
        if (local !== value) {
          onSave(local);
          initialValue.current = local;
        }
      };

      return (
        <input
          ref={inputRef}
          type={type}
          value={local}
          onChange={(e) => setLocal(e.target.value)}
          onBlur={handleBlur}
          className={className}
          placeholder={placeholder}
          autoComplete="off"
          data-1p-ignore="true"
          data-lpignore="true"
          data-form-type="other"
        />
      );
    });

    const StableTextarea = React.memo(({ value, onSave, className = '', placeholder = '', rows = 3 }) => {
      const [local, setLocal] = useState(value || '');
      const ref = useRef(null);
      const initialValue = useRef(value);

      useEffect(() => {
        if (value !== initialValue.current && document.activeElement !== ref.current) {
          setLocal(value || '');
          initialValue.current = value;
        }
      }, [value]);

      const handleBlur = () => {
        if (local !== value) {
          onSave(local);
          initialValue.current = local;
        }
      };

      return (
        <textarea
          ref={ref}
          value={local}
          onChange={(e) => setLocal(e.target.value)}
          onBlur={handleBlur}
          className={className}
          placeholder={placeholder}
          rows={rows}
          autoComplete="off"
          data-1p-ignore="true"
          data-lpignore="true"
          data-form-type="other"
        />
      );
    });

    // ==================== COUNSELOR EDIT FORM ====================
    const CounselorEditForm = ({ counselor, onSave, onCancel, onDelete }) => {
      const [form, setForm] = useState({ ...counselor });
      const inputRef = useRef(null);
      const [tempImg, setTempImg] = useState(null);
      const [showCrop, setShowCrop] = useState(false);
      const [showPhotoOptions, setShowPhotoOptions] = useState(false);

      const update = (field, value) => {
        setForm(prev => ({ ...prev, [field]: value }));
      };

      const handleFile = (e) => {
        const file = e.target.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => { setTempImg(reader.result); setShowCrop(true); setShowPhotoOptions(false); };
          reader.readAsDataURL(file);
        }
        if (e.target) e.target.value = '';
      };

      const handleAdjustPhoto = () => {
        setTempImg(form.photo);
        setShowCrop(true);
        setShowPhotoOptions(false);
      };

      if (showCrop && tempImg) {
        return <ImageCropper image={tempImg} onSave={(img) => { update('photo', img); setShowCrop(false); setTempImg(null); }} onCancel={() => { setShowCrop(false); setTempImg(null); }} />;
      }

      return (
        <div className="space-y-4">
          <div className="flex items-center gap-4">
            {form.photo ? (
              <div className="relative">
                <img
                  src={form.photo}
                  className="w-20 h-20 rounded-full object-cover border-2 border-green-600 cursor-pointer hover:opacity-80"
                  onClick={() => setShowPhotoOptions(true)}
                />
                {showPhotoOptions && (
                  <div className="absolute top-0 left-24 bg-white rounded-lg shadow-lg border p-2 z-10 min-w-[140px]">
                    <button onClick={handleAdjustPhoto} className="w-full text-left px-3 py-2 hover:bg-gray-100 rounded text-sm flex items-center gap-2">
                      <span>üîç</span> Adjust Photo
                    </button>
                    <button onClick={() => { inputRef.current?.click(); }} className="w-full text-left px-3 py-2 hover:bg-gray-100 rounded text-sm flex items-center gap-2">
                      <span>üì∑</span> Upload New
                    </button>
                    <button onClick={() => { update('photo', null); setShowPhotoOptions(false); }} className="w-full text-left px-3 py-2 hover:bg-red-50 text-red-600 rounded text-sm flex items-center gap-2">
                      <span>üóëÔ∏è</span> Delete Photo
                    </button>
                    <hr className="my-1" />
                    <button onClick={() => setShowPhotoOptions(false)} className="w-full text-left px-3 py-2 hover:bg-gray-100 rounded text-sm text-gray-500">
                      Cancel
                    </button>
                  </div>
                )}
              </div>
            ) : (
              <div onClick={() => inputRef.current?.click()} className="w-20 h-20 rounded-full bg-gray-200 border-2 border-dashed border-gray-400 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300">
                <svg className="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
                <span className="text-xs text-gray-500">Add</span>
              </div>
            )}
            <input ref={inputRef} type="file" accept="image/*" onChange={handleFile} className="hidden" />
            <div className="flex-1 text-sm text-gray-500">{form.photo ? 'Click photo for options' : 'Click to add photo'}</div>
          </div>

          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
              <input
                value={form.name || ''}
                onChange={e => update('name', e.target.value)}
                className="w-full px-3 py-2 border rounded-lg"
                placeholder="Full name"
                autoComplete="off"
                data-1p-ignore="true"
                data-lpignore="true"
                data-form-type="other"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input
                value={form.email || ''}
                onChange={e => update('email', e.target.value)}
                className="w-full px-3 py-2 border rounded-lg"
                placeholder="email@example.com"
                autoComplete="off"
                data-1p-ignore="true"
                data-lpignore="true"
                data-form-type="other"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
              <input
                value={form.phone || ''}
                onChange={e => update('phone', formatPhone(e.target.value))}
                className="w-full px-3 py-2 border rounded-lg"
                placeholder="(555) 555-1234"
                autoComplete="off"
                data-1p-ignore="true"
                data-lpignore="true"
                data-form-type="other"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Position</label>
              <input
                value={form.position || ''}
                onChange={e => update('position', e.target.value)}
                className="w-full px-3 py-2 border rounded-lg"
                placeholder="Point Guard"
                autoComplete="off"
                data-1p-ignore="true"
                data-lpignore="true"
                data-form-type="other"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Year</label>
              <select value={form.year || ''} onChange={e => update('year', e.target.value)} className="w-full px-3 py-2 border rounded-lg">
                <option value="">Select year</option>
                <option value="Freshman">Freshman</option>
                <option value="Sophomore">Sophomore</option>
                <option value="Junior">Junior</option>
                <option value="Senior">Senior</option>
              </select>
            </div>
            <div className="flex items-center gap-2">
              <input type="checkbox" checked={form.visible !== false} onChange={e => update('visible', e.target.checked)} className="w-5 h-5" />
              <label className="text-sm font-medium text-gray-700">Visible on website</label>
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Bio</label>
            <textarea
              value={form.bio || ''}
              onChange={e => update('bio', e.target.value)}
              className="w-full px-3 py-2 border rounded-lg"
              rows={3}
              placeholder="Short bio..."
              autoComplete="off"
              data-1p-ignore="true"
              data-lpignore="true"
              data-form-type="other"
            />
          </div>

          <div className="flex gap-4 pt-4">
            <button onClick={onCancel} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
            <button onClick={() => onSave(form)} className="flex-1 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Save</button>
          </div>

          {onDelete && counselor?.id && (
            <div className="pt-4 mt-4 border-t">
              <button onClick={() => onDelete(counselor)} className="w-full py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 border border-red-200">
                Delete Counselor
              </button>
            </div>
          )}
        </div>
      );
    };

    // ==================== POLICY CONSTANTS ====================
    const PICKUP_POLICY = `
Only authorized emergency contacts may pick up your child.
Photo ID is required for all pickups.
If someone not on the authorized list needs to pick up,
parents must notify camp staff in advance by phone or email.
    `.trim();

    const DROPOFF_POLICY = `
Morning sessions: Drop-off is between 8:45 AM - 9:00 AM
Afternoon sessions: Drop-off is between 11:45 AM - 12:00 PM
Please sign in your child with the counselor on duty at the main gym entrance.
    `.trim();

    // ==================== PARENT ONBOARDING WIZARD ====================
    const ParentOnboarding = ({ onComplete, onBack, users, saveUsers, saveEmergencyContacts, emergencyContacts, saveOnboardingProgress, campers, saveCampers, saveCamperParentLinks, camperParentLinks }) => {
      const [step, setStep] = useState(1);
      const [userData, setUserData] = useState({ name: '', email: '', phone: '', password: '', photo: null });
      const [campersData, setCampersData] = useState([]);
      const [emergencyData, setEmergencyData] = useState([]);
      const [policiesAccepted, setPoliciesAccepted] = useState({ pickup: false, dropoff: false });
      const [cardData, setCardData] = useState({ number: '', expiry: '', cvc: '', name: '' });
      const [error, setError] = useState('');
      // State for adding campers/contacts (moved to parent level to avoid re-renders)
      const [showAddCamper, setShowAddCamper] = useState(false);
      const [newCamper, setNewCamper] = useState({ name: '', birthdate: '', grade: '', phone: '' });
      const [showAddContact, setShowAddContact] = useState(false);
      const [newContact, setNewContact] = useState({ name: '', phone: '', relationship: '', photo: null });
      // Photo cropping state
      const [showCropper, setShowCropper] = useState(false);
      const [tempImage, setTempImage] = useState(null);
      const [cropTarget, setCropTarget] = useState(null); // 'parent', 'contact', or contact id
      const parentPhotoRef = useRef(null);
      const contactPhotoRef = useRef(null);

      const totalSteps = 6;

      const steps = [
        { num: 1, title: 'Your Account', icon: 'üë§' },
        { num: 2, title: 'Add Campers', icon: 'üèÄ' },
        { num: 3, title: 'Emergency Contacts', icon: 'üìû' },
        { num: 4, title: 'Payment', icon: 'üí≥' },
        { num: 5, title: 'Policies', icon: 'üìã' },
        { num: 6, title: 'Complete', icon: '‚úÖ' }
      ];

      // Photo upload handler
      const handlePhotoUpload = (e, target) => {
        const file = e.target.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setTempImage(reader.result);
            setCropTarget(target);
            setShowCropper(true);
          };
          reader.readAsDataURL(file);
        }
        if (e.target) e.target.value = '';
      };

      const handleCropSave = (croppedImage) => {
        if (cropTarget === 'parent') {
          setUserData({ ...userData, photo: croppedImage });
        } else if (cropTarget === 'newContact') {
          setNewContact({ ...newContact, photo: croppedImage });
        }
        setShowCropper(false);
        setTempImage(null);
        setCropTarget(null);
      };

      // Credit card number formatting
      const formatCardNumber = (value) => {
        const v = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        const matches = v.match(/\d{4,16}/g);
        const match = matches && matches[0] || '';
        const parts = [];
        for (let i = 0, len = match.length; i < len; i += 4) {
          parts.push(match.substring(i, i + 4));
        }
        return parts.length ? parts.join(' ') : value;
      };

      // Expiry formatting
      const formatExpiry = (value) => {
        const v = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        if (v.length >= 2) {
          return v.substring(0, 2) + '/' + v.substring(2, 4);
        }
        return v;
      };

      // Helper functions for campers
      const addCamper = () => {
        if (!newCamper.name || !newCamper.birthdate || !newCamper.grade) return;
        setCampersData([...campersData, { ...newCamper, id: 'camper_' + Date.now() }]);
        setNewCamper({ name: '', birthdate: '', grade: '', phone: '' });
        setShowAddCamper(false);
      };

      const removeCamper = (id) => {
        setCampersData(campersData.filter(c => c.id !== id));
      };

      const getEligibility = (grade, birthdate) => {
        const gradeNum = parseInt(grade);
        if (gradeNum >= 3 && gradeNum <= 8) return { eligible: true, status: 'Eligible', color: 'green' };
        if (gradeNum < 3) return { eligible: false, status: 'Too young - must be in 3rd grade or higher', color: 'yellow' };
        return { eligible: false, status: 'Too old - camp is for grades 3-8', color: 'orange' };
      };

      // Helper functions for emergency contacts
      const [contactError, setContactError] = useState('');
      const addContact = () => {
        setContactError('');
        if (!newContact.name || !newContact.phone || !newContact.relationship) return;
        if (!isValidPhone(newContact.phone)) {
          setContactError('Please enter a valid 10-digit phone number');
          return;
        }
        setEmergencyData([...emergencyData, {
          ...newContact,
          id: 'contact_' + Date.now(),
          isParent: false,
          priority: emergencyData.length + 2
        }]);
        setNewContact({ name: '', phone: '', relationship: '', photo: null });
        setShowAddContact(false);
      };

      const removeContact = (id) => {
        setEmergencyData(emergencyData.filter(c => c.id !== id));
      };

      const hasNonParentContact = emergencyData.some(c => !c.isParent);

      const validateStep = () => {
        setError('');
        if (step === 1) {
          if (!userData.name || !userData.email || !userData.phone || !userData.password) {
            setError('Please fill in all required fields');
            return false;
          }
          if (!isValidPhone(userData.phone)) {
            setError('Please enter a valid 10-digit phone number: (555) 555-1234');
            return false;
          }
          if (users.some(u => u.email === userData.email)) {
            setError('An account with this email already exists');
            return false;
          }
        }
        // Steps 2-6 are all skippable - validation is advisory only
        // Emergency contact phone validation (if adding contacts)
        if (step === 3 && emergencyData.length > 0) {
          const invalidContact = emergencyData.find(c => !isValidPhone(c.phone));
          if (invalidContact) {
            setError(`Please enter a valid 10-digit phone for ${invalidContact.name}`);
            return false;
          }
        }
        return true;
      };

      // Allow completing registration early (skip remaining steps)
      const handleComplete = async () => {
        // Create user account with whatever data we have
        const newUser = {
          email: userData.email,
          name: userData.name,
          password: userData.password,
          phone: userData.phone,
          photo: userData.photo,
          role: 'parent',
          roles: ['parent'],
          onboardingComplete: true,
          onboardingCompletedAt: new Date().toISOString(),
          policiesAccepted: policiesAccepted.pickup && policiesAccepted.dropoff ? {
            pickup: true,
            dropoff: true,
            acceptedAt: new Date().toISOString()
          } : null
        };
        await saveUsers([...users, newUser]);

        // Save campers and create parent links
        if (campersData.length > 0 && saveCampers && saveCamperParentLinks) {
          const newCampers = campersData.map(c => ({
            ...c,
            createdAt: new Date().toISOString()
          }));
          await saveCampers([...(campers || []), ...newCampers]);

          // Create links between campers and this parent
          const newLinks = campersData.map(c => ({
            camperId: c.id,
            parentEmail: userData.email
          }));
          await saveCamperParentLinks([...(camperParentLinks || []), ...newLinks]);
        }

        // Save emergency contacts if any were added
        if (emergencyData.length > 0) {
          const allContacts = [
            { id: 'ec_' + Date.now(), name: userData.name, phone: userData.phone, relationship: 'Parent', isParent: true, priority: 1, userEmail: userData.email },
            ...emergencyData.map((c, i) => ({ ...c, userEmail: userData.email, priority: i + 2 }))
          ];
          await saveEmergencyContacts([...emergencyContacts, ...allContacts]);
        }

        onComplete(newUser);
      };

      const handleNext = async () => {
        if (!validateStep()) return;

        if (step === totalSteps) {
          await handleComplete();
          return;
        }

        setStep(step + 1);
      };

      const handleBack = () => {
        if (step === 1) {
          onBack();
        } else {
          setStep(step - 1);
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-green-50 to-green-100 py-8">
          {/* Image Cropper Modal */}
          {showCropper && tempImage && (
            <ImageCropper
              image={tempImage}
              onSave={handleCropSave}
              onCancel={() => { setShowCropper(false); setTempImage(null); setCropTarget(null); }}
              shape="circle"
            />
          )}
          <div className="max-w-lg mx-auto px-4">
            {/* Progress Bar */}
            <div className="mb-6">
              <div className="flex justify-between items-center mb-2">
                {steps.map((s) => (
                  <div
                    key={s.num}
                    className={`flex flex-col items-center ${s.num <= step ? 'text-green-600' : 'text-gray-400'}`}
                  >
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg ${
                      s.num < step ? 'bg-green-600 text-white' :
                      s.num === step ? 'bg-green-100 border-2 border-green-600' : 'bg-gray-200'
                    }`}>
                      {s.num < step ? '‚úì' : s.icon}
                    </div>
                    <span className="text-xs mt-1 hidden sm:block">{s.title}</span>
                  </div>
                ))}
              </div>
              <div className="h-2 bg-gray-200 rounded-full">
                <div
                  className="h-2 bg-green-600 rounded-full transition-all"
                  style={{ width: `${((step - 1) / (totalSteps - 1)) * 100}%` }}
                />
              </div>
            </div>

            {/* Content Card */}
            <div className="bg-white rounded-2xl shadow-xl p-8">
              <h2 className="font-display text-2xl text-green-800 mb-6">
                {steps[step - 1].title}
              </h2>

              {error && (
                <div className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm">
                  {error}
                </div>
              )}

              {/* Step 1: Account Setup */}
              {step === 1 && (
                <div className="space-y-4">
                  <p className="text-gray-600 mb-4">Let's start by creating your account.</p>

                  {/* Photo Upload */}
                  <div className="flex justify-center mb-4">
                    {userData.photo ? (
                      <div className="relative">
                        <img src={userData.photo} className="w-24 h-24 rounded-full object-cover border-4 border-green-500" />
                        <button onClick={() => parentPhotoRef.current?.click()} className="absolute -bottom-1 -right-1 w-8 h-8 bg-green-600 rounded-full text-white flex items-center justify-center text-sm hover:bg-green-700">‚úé</button>
                        <button onClick={() => setUserData({ ...userData, photo: null })} className="absolute -top-1 -right-1 w-6 h-6 bg-red-500 rounded-full text-white text-xs flex items-center justify-center">√ó</button>
                      </div>
                    ) : (
                      <div onClick={() => parentPhotoRef.current?.click()} className="w-24 h-24 rounded-full bg-gray-200 border-2 border-dashed border-gray-400 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300">
                        <svg className="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        <span className="text-xs text-gray-500">Add Photo</span>
                      </div>
                    )}
                    <input ref={parentPhotoRef} type="file" accept="image/*" onChange={(e) => handlePhotoUpload(e, 'parent')} className="hidden" />
                  </div>
                  <p className="text-xs text-gray-500 text-center -mt-2 mb-4">Photo is optional but helps counselors recognize you at drop-off</p>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                    <input
                      value={userData.name}
                      onChange={e => setUserData({ ...userData, name: e.target.value })}
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-green-500 focus:outline-none"
                      placeholder="Your full name"
                      autoComplete="off" data-1p-ignore="true"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                    <input
                      type="email"
                      value={userData.email}
                      onChange={e => setUserData({ ...userData, email: e.target.value })}
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-green-500 focus:outline-none"
                      placeholder="your@email.com"
                      autoComplete="off" data-1p-ignore="true"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                    <input
                      value={userData.phone}
                      onChange={e => setUserData({ ...userData, phone: formatPhone(e.target.value) })}
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-green-500 focus:outline-none"
                      placeholder="(555) 555-1234"
                      autoComplete="off" data-1p-ignore="true"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                    <input
                      type="password"
                      value={userData.password}
                      onChange={e => setUserData({ ...userData, password: e.target.value })}
                      className="w-full px-4 py-3 border-2 rounded-lg focus:border-green-500 focus:outline-none"
                      placeholder="Create a password"
                      autoComplete="off" data-1p-ignore="true"
                    />
                  </div>
                </div>
              )}

              {/* Step 2: Add Campers */}
              {step === 2 && (
                <div className="space-y-4">
                  <p className="text-gray-600 mb-4">Add the campers you want to register. You'll select their camp sessions after setup.</p>

                  {campersData.length > 0 && (
                    <div className="space-y-3 mb-4">
                      {campersData.map(camper => {
                        const elig = getEligibility(camper.grade, camper.birthdate);
                        return (
                          <div key={camper.id} className="flex items-center justify-between p-4 bg-gray-50 rounded-lg border">
                            <div>
                              <div className="font-medium">{camper.name}</div>
                              <div className="text-sm text-gray-500">
                                {camper.grade} Grade ‚Ä¢ Age {calculateAge(camper.birthdate)}
                              </div>
                              <span className={`text-xs px-2 py-0.5 rounded ${elig.eligible ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                                {elig.status}
                              </span>
                            </div>
                            <button onClick={() => removeCamper(camper.id)} className="text-red-500 hover:text-red-700 p-2">‚úï</button>
                          </div>
                        );
                      })}
                    </div>
                  )}

                  {showAddCamper ? (
                    <div className="border-2 border-dashed border-green-300 rounded-lg p-4 bg-green-50">
                      <h4 className="font-medium mb-3">Add Camper</h4>
                      <div className="space-y-3">
                        <input
                          value={newCamper.name}
                          onChange={e => setNewCamper({ ...newCamper, name: e.target.value })}
                          placeholder="Camper's full name"
                          className="w-full px-3 py-2 border rounded-lg"
                          autoComplete="off" data-1p-ignore="true"
                        />
                        <div className="grid grid-cols-2 gap-3">
                          <input
                            type="date"
                            value={newCamper.birthdate}
                            onChange={e => setNewCamper({ ...newCamper, birthdate: e.target.value })}
                            className="w-full px-3 py-2 border rounded-lg"
                            max={new Date().toISOString().split('T')[0]}
                          />
                          <select
                            value={newCamper.grade}
                            onChange={e => setNewCamper({ ...newCamper, grade: e.target.value })}
                            className="w-full px-3 py-2 border rounded-lg"
                          >
                            <option value="">Grade (Fall 2026)</option>
                            <option value="K">Kindergarten</option>
                            <option value="1st">1st Grade</option>
                            <option value="2nd">2nd Grade</option>
                            <option value="3rd">3rd Grade</option>
                            <option value="4th">4th Grade</option>
                            <option value="5th">5th Grade</option>
                            <option value="6th">6th Grade</option>
                            <option value="7th">7th Grade</option>
                            <option value="8th">8th Grade</option>
                            <option value="9th">9th Grade</option>
                          </select>
                        </div>
                        <input
                          value={newCamper.phone}
                          onChange={e => setNewCamper({ ...newCamper, phone: formatPhone(e.target.value) })}
                          placeholder="Camper's phone (optional)"
                          className="w-full px-3 py-2 border rounded-lg"
                          autoComplete="off" data-1p-ignore="true"
                        />
                        <div className="flex gap-2">
                          <button onClick={addCamper} disabled={!newCamper.name || !newCamper.birthdate || !newCamper.grade} className="flex-1 py-2 bg-green-600 text-white rounded-lg disabled:bg-gray-300">Add Camper</button>
                          <button onClick={() => setShowAddCamper(false)} className="px-4 py-2 border rounded-lg">Cancel</button>
                        </div>
                      </div>
                    </div>
                  ) : (
                    <button onClick={() => setShowAddCamper(true)} className="w-full py-4 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-green-500 hover:text-green-600">+ Add a Camper</button>
                  )}

                  {campersData.length === 0 && (
                    <p className="text-sm text-gray-500 text-center mt-4">Add at least one camper to continue. You can add more campers later.</p>
                  )}
                </div>
              )}

              {/* Step 3: Emergency Contacts */}
              {step === 3 && (
                <div className="space-y-4">
                  <p className="text-gray-600 mb-2">Emergency contacts are people we can call if we can't reach you.</p>
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm text-yellow-800">
                    <strong>Required:</strong> At least 3 emergency contacts, including at least 1 who is not a parent (grandparent, neighbor, etc.)
                  </div>

                  {/* Parent auto-contact */}
                  <div className="p-4 bg-green-50 rounded-lg border border-green-200">
                    <div className="flex items-center gap-3">
                      {userData.photo ? (
                        <img src={userData.photo} className="w-10 h-10 rounded-full object-cover border-2 border-green-500" />
                      ) : (
                        <div className="w-10 h-10 bg-green-600 text-white rounded-full flex items-center justify-center font-bold">1</div>
                      )}
                      <div>
                        <div className="font-medium">{userData.name}</div>
                        <div className="text-sm text-gray-500">{userData.phone} ‚Ä¢ Parent (you)</div>
                      </div>
                      <span className="ml-auto text-green-600 text-sm">‚úì Auto-added</span>
                    </div>
                  </div>

                  {/* Additional contacts */}
                  {emergencyData.map((contact, idx) => (
                    <div key={contact.id} className="p-4 bg-gray-50 rounded-lg border flex items-center gap-3">
                      {contact.photo ? (
                        <img src={contact.photo} className="w-10 h-10 rounded-full object-cover border-2 border-gray-400" />
                      ) : (
                        <div className="w-10 h-10 bg-gray-600 text-white rounded-full flex items-center justify-center font-bold">{idx + 2}</div>
                      )}
                      <div>
                        <div className="font-medium">{contact.name}</div>
                        <div className="text-sm text-gray-500">{contact.phone} ‚Ä¢ {contact.relationship}</div>
                      </div>
                      <button onClick={() => removeContact(contact.id)} className="ml-auto text-red-500 hover:text-red-700 p-2">‚úï</button>
                    </div>
                  ))}

                  {showAddContact ? (
                    <div className="border-2 border-dashed border-blue-300 rounded-lg p-4 bg-blue-50">
                      <h4 className="font-medium mb-3">Add Emergency Contact</h4>
                      <div className="space-y-3">
                        {/* Photo Upload */}
                        <div className="flex justify-center mb-2">
                          {newContact.photo ? (
                            <div className="relative">
                              <img src={newContact.photo} className="w-16 h-16 rounded-full object-cover border-2 border-blue-500" />
                              <button onClick={() => contactPhotoRef.current?.click()} className="absolute -bottom-1 -right-1 w-6 h-6 bg-blue-600 rounded-full text-white flex items-center justify-center text-xs hover:bg-blue-700">‚úé</button>
                              <button onClick={() => setNewContact({ ...newContact, photo: null })} className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-white text-xs flex items-center justify-center">√ó</button>
                            </div>
                          ) : (
                            <div onClick={() => contactPhotoRef.current?.click()} className="w-16 h-16 rounded-full bg-gray-200 border-2 border-dashed border-gray-400 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300">
                              <svg className="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                              <span className="text-xs text-gray-500">Photo</span>
                            </div>
                          )}
                          <input ref={contactPhotoRef} type="file" accept="image/*" onChange={(e) => handlePhotoUpload(e, 'newContact')} className="hidden" />
                        </div>
                        <p className="text-xs text-gray-500 text-center -mt-1 mb-2">Photo helps identify authorized pickup (optional)</p>
                        <input
                          value={newContact.name}
                          onChange={e => setNewContact({ ...newContact, name: e.target.value })}
                          placeholder="Contact's full name"
                          className="w-full px-3 py-2 border rounded-lg"
                          autoComplete="off" data-1p-ignore="true"
                        />
                        <input
                          value={newContact.phone}
                          onChange={e => setNewContact({ ...newContact, phone: formatPhone(e.target.value) })}
                          placeholder="Phone number"
                          className="w-full px-3 py-2 border rounded-lg"
                          autoComplete="off" data-1p-ignore="true"
                        />
                        <select
                          value={newContact.relationship}
                          onChange={e => setNewContact({ ...newContact, relationship: e.target.value })}
                          className="w-full px-3 py-2 border rounded-lg"
                        >
                          <option value="">Relationship to child</option>
                          <option value="Grandparent">Grandparent</option>
                          <option value="Aunt/Uncle">Aunt/Uncle</option>
                          <option value="Family Friend">Family Friend</option>
                          <option value="Neighbor">Neighbor</option>
                          <option value="Other Parent">Other Parent/Guardian</option>
                          <option value="Other">Other</option>
                        </select>
                        {contactError && (
                          <p className="text-sm text-red-600">{contactError}</p>
                        )}
                        <div className="flex gap-2">
                          <button onClick={addContact} disabled={!newContact.name || !newContact.phone || !newContact.relationship} className="flex-1 py-2 bg-blue-600 text-white rounded-lg disabled:bg-gray-300">Add Contact</button>
                          <button onClick={() => { setShowAddContact(false); setNewContact({ name: '', phone: '', relationship: '', photo: null }); setContactError(''); }} className="px-4 py-2 border rounded-lg">Cancel</button>
                        </div>
                      </div>
                    </div>
                  ) : (
                    <button onClick={() => { setShowAddContact(true); setContactError(''); }} className="w-full py-4 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-500 hover:text-blue-600">+ Add Emergency Contact</button>
                  )}

                  {!hasNonParentContact && (
                    <p className="text-sm text-orange-600 text-center">Please add at least one non-parent contact (grandparent, neighbor, etc.)</p>
                  )}
                </div>
              )}

              {/* Step 4: Payment (Optional) */}
              {step === 4 && (
                <div className="space-y-6">
                  <p className="text-gray-600">Add a payment method for faster checkout. You can skip this for now.</p>

                  <div className="bg-gradient-to-r from-slate-800 to-slate-900 rounded-xl p-6 text-white">
                    <div className="flex justify-between items-start mb-8">
                      <div className="text-xs uppercase tracking-wider opacity-60">Credit Card</div>
                      <div className="flex gap-2">
                        <div className="w-10 h-6 bg-gradient-to-r from-blue-500 to-blue-700 rounded flex items-center justify-center text-xs font-bold">VISA</div>
                        <div className="w-10 h-6 bg-gradient-to-r from-red-500 to-yellow-500 rounded flex items-center justify-center text-xs font-bold">MC</div>
                      </div>
                    </div>
                    <div className="font-mono text-xl tracking-wider mb-6">
                      {cardData.number || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}
                    </div>
                    <div className="flex justify-between text-sm">
                      <div>
                        <div className="text-xs opacity-60 uppercase">Card Holder</div>
                        <div>{cardData.name || 'YOUR NAME'}</div>
                      </div>
                      <div>
                        <div className="text-xs opacity-60 uppercase">Expires</div>
                        <div>{cardData.expiry || 'MM/YY'}</div>
                      </div>
                    </div>
                  </div>

                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Card Number</label>
                      <input
                        value={cardData.number}
                        onChange={e => setCardData({ ...cardData, number: formatCardNumber(e.target.value) })}
                        className="w-full px-4 py-3 border-2 rounded-lg focus:border-green-500 focus:outline-none font-mono"
                        placeholder="1234 5678 9012 3456"
                        maxLength={19}
                        autoComplete="off" data-1p-ignore="true"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Cardholder Name</label>
                      <input
                        value={cardData.name}
                        onChange={e => setCardData({ ...cardData, name: e.target.value.toUpperCase() })}
                        className="w-full px-4 py-3 border-2 rounded-lg focus:border-green-500 focus:outline-none"
                        placeholder="JOHN DOE"
                        autoComplete="off" data-1p-ignore="true"
                      />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
                        <input
                          value={cardData.expiry}
                          onChange={e => setCardData({ ...cardData, expiry: formatExpiry(e.target.value) })}
                          className="w-full px-4 py-3 border-2 rounded-lg focus:border-green-500 focus:outline-none"
                          placeholder="MM/YY"
                          maxLength={5}
                          autoComplete="off" data-1p-ignore="true"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">CVC</label>
                        <input
                          value={cardData.cvc}
                          onChange={e => setCardData({ ...cardData, cvc: e.target.value.replace(/\D/g, '').slice(0, 4) })}
                          className="w-full px-4 py-3 border-2 rounded-lg focus:border-green-500 focus:outline-none"
                          placeholder="123"
                          maxLength={4}
                          type="password"
                          autoComplete="off" data-1p-ignore="true"
                        />
                      </div>
                    </div>
                  </div>

                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <p className="text-yellow-800 text-sm">
                      <strong>üîê Secure Payment:</strong> Card payments will be processed through Stripe (coming soon). For now, you can skip this step and pay via Venmo.
                    </p>
                  </div>

                  <button
                    onClick={() => setStep(5)}
                    className="w-full py-3 text-gray-500 hover:text-gray-700 text-sm"
                  >
                    Skip for now ‚Üí
                  </button>
                </div>
              )}

              {/* Step 5: Policies */}
              {step === 5 && (
                <div className="space-y-6">
                  <p className="text-gray-600">Please review and acknowledge our camp policies.</p>

                  <div className="bg-white border rounded-lg overflow-hidden">
                    <div className="bg-green-100 px-4 py-2 font-medium text-green-800">üì• Drop-off Policy</div>
                    <div className="p-4">
                      <pre className="whitespace-pre-wrap text-sm text-gray-600 font-sans">{DROPOFF_POLICY}</pre>
                      <label className="flex items-center gap-3 mt-4 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={policiesAccepted.dropoff}
                          onChange={e => setPoliciesAccepted({ ...policiesAccepted, dropoff: e.target.checked })}
                          className="w-5 h-5 text-green-600"
                        />
                        <span className="text-sm">I have read and agree to the drop-off policy</span>
                      </label>
                    </div>
                  </div>

                  <div className="bg-white border rounded-lg overflow-hidden">
                    <div className="bg-blue-100 px-4 py-2 font-medium text-blue-800">üì§ Pick-up Policy</div>
                    <div className="p-4">
                      <pre className="whitespace-pre-wrap text-sm text-gray-600 font-sans">{PICKUP_POLICY}</pre>
                      <label className="flex items-center gap-3 mt-4 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={policiesAccepted.pickup}
                          onChange={e => setPoliciesAccepted({ ...policiesAccepted, pickup: e.target.checked })}
                          className="w-5 h-5 text-blue-600"
                        />
                        <span className="text-sm">I have read and agree to the pick-up policy</span>
                      </label>
                    </div>
                  </div>
                </div>
              )}

              {/* Step 6: Complete */}
              {step === 6 && (
                <div className="text-center space-y-6">
                  <div className="text-6xl">üéâ</div>
                  <h3 className="font-display text-2xl text-green-800">You're All Set!</h3>
                  <p className="text-gray-600">Your account is ready. You can now register your campers for sessions!</p>

                  <div className="bg-gray-50 rounded-lg p-4 text-left">
                    <h4 className="font-medium mb-2">Account Summary:</h4>
                    <p className="text-sm text-gray-600">‚Ä¢ {userData.name} ({userData.email})</p>
                    <p className="text-sm text-gray-600">‚Ä¢ {campersData.length} camper{campersData.length !== 1 ? 's' : ''} added</p>
                    <p className="text-sm text-gray-600">‚Ä¢ {emergencyData.length + 1} emergency contact{emergencyData.length !== 0 ? 's' : ''}</p>
                    {cardData.number && <p className="text-sm text-gray-600">‚Ä¢ Payment method saved</p>}
                  </div>

                  <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                    <p className="text-green-800 font-medium">Next Step: Register for Sessions</p>
                    <p className="text-sm text-green-700 mt-1">Go to the Register tab to sign up your campers for camp dates!</p>
                  </div>
                </div>
              )}

              {/* Navigation */}
              <div className="flex flex-col gap-3 mt-8">
                <div className="flex gap-4">
                  <button
                    onClick={handleBack}
                    className="flex-1 py-3 border-2 border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
                  >
                    {step === 1 ? '‚Üê Back' : '‚Üê Previous'}
                  </button>
                  <button
                    onClick={handleNext}
                    className="flex-1 py-3 bg-green-700 hover:bg-green-800 text-white font-bold rounded-lg"
                  >
                    {step === totalSteps ? 'Complete Setup' : 'Continue ‚Üí'}
                  </button>
                </div>
                {/* Skip & Finish option for steps 2-5 */}
                {step > 1 && step < totalSteps && (
                  <button
                    onClick={handleComplete}
                    className="w-full py-2 text-gray-500 hover:text-green-700 text-sm border border-gray-200 rounded-lg hover:border-green-300"
                  >
                    Skip remaining steps & finish setup ‚Üí
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ==================== PARENTS TAB ====================
    const ParentsTab = ({ users, registrations, messages, onSendMessage, onUpdateUsers, onDeleteParent, onUpdateRegistrations, onDeleteRegistration, showToast, addToHistory, campers, camperParentLinks, onSaveLinks, onSaveCampers, onSaveCamperParentLinks, emergencyContacts, saveEmergencyContacts, saveOnboardingProgress }) => {
      const [searchTerm, setSearchTerm] = useState('');
      const [selectedParents, setSelectedParents] = useState([]);
      const [expandedParent, setExpandedParent] = useState(null);
      const [showComposer, setShowComposer] = useState(false);
      const [composerMode, setComposerMode] = useState('single'); // 'single', 'selected', 'all'
      const [composerRecipient, setComposerRecipient] = useState(null);
      const [viewingThread, setViewingThread] = useState(null);
      // Admin edit/delete state
      const [editingParent, setEditingParent] = useState(null);
      const [editingChild, setEditingChild] = useState(null);
      const [editingReg, setEditingReg] = useState(null);
      const [confirmDelete, setConfirmDelete] = useState(null); // { type: 'parent'|'child'|'registration', data: ... }
      // Add parent state - use full onboarding flow
      const [showAddParent, setShowAddParent] = useState(false);
      // Manage campers for parent
      const [managingCampers, setManagingCampers] = useState(null);
      // Create registration for parent
      const [creatingRegFor, setCreatingRegFor] = useState(null); // parent object
      const [newReg, setNewReg] = useState({ camperId: '', date: '', sessions: [] });

      // Get all campers
      const getAllCampers = () => campers || [];

      // Get campers linked to a parent
      const getParentCampers = (parentEmail) => {
        const linkedCamperIds = (camperParentLinks || [])
          .filter(l => l.parentEmail === parentEmail)
          .map(l => l.camperId);
        return (campers || []).filter(c => linkedCamperIds.includes(c.id));
      };

      
      const toggleCamperLink = (parentEmail, camperId) => {
        const exists = (camperParentLinks || []).some(l => l.camperId === camperId && l.parentEmail === parentEmail);
        if (exists) {
          onSaveLinks(camperParentLinks.filter(l => !(l.camperId === camperId && l.parentEmail === parentEmail)));
        } else {
          onSaveLinks([...(camperParentLinks || []), { camperId, parentEmail }]);
        }
      };

      const filteredUsers = users.filter(u =>
        u.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        u.email?.toLowerCase().includes(searchTerm.toLowerCase())
      );

      const getParentRegs = (email) => registrations.filter(r => r.parentEmail === email);
      const getParentMessages = (email) => messages.filter(m =>
        m.to === 'all' || m.to?.includes(email) || m.from === email
      );

      const toggleSelectParent = (email) => {
        setSelectedParents(prev =>
          prev.includes(email) ? prev.filter(e => e !== email) : [...prev, email]
        );
      };

      const selectAll = () => {
        if (selectedParents.length === filteredUsers.length) {
          setSelectedParents([]);
        } else {
          setSelectedParents(filteredUsers.map(u => u.email));
        }
      };

      const openComposer = (mode, recipient = null) => {
        setComposerMode(mode);
        setComposerRecipient(recipient);
        setShowComposer(true);
      };

      return (
        <div className="space-y-6">
          {/* Header with search and actions */}
          <div className="bg-white rounded-xl shadow p-6">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
              <div>
                <h3 className="font-bold text-xl text-green-800">üë®‚Äçüë©‚Äçüëß Parents</h3>
                <p className="text-sm text-gray-500">{users.length} registered parents</p>
              </div>
              <div className="flex gap-2">
                {selectedParents.length > 0 && (
                  <button
                    onClick={() => openComposer('selected')}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                  >
                    ‚úâÔ∏è Message Selected ({selectedParents.length})
                  </button>
                )}
                <button
                  onClick={() => openComposer('all')}
                  className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                >
                  üì¢ Message All Parents
                </button>
                <button
                  onClick={() => setShowAddParent(true)}
                  className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                >
                  + Add Parent
                </button>
              </div>
            </div>

            {/* Search */}
            <div className="flex gap-4 items-center">
              <input
                value={searchTerm}
                onChange={e => setSearchTerm(e.target.value)}
                placeholder="Search parents by name or email..."
                className="flex-1 px-4 py-2 border rounded-lg"
                autoComplete="off"
                data-1p-ignore="true"
              />
              <label className="flex items-center gap-2 text-sm text-gray-600">
                <input
                  type="checkbox"
                  checked={selectedParents.length === filteredUsers.length && filteredUsers.length > 0}
                  onChange={selectAll}
                  className="w-4 h-4"
                />
                Select All
              </label>
            </div>
          </div>

          {/* Parents List */}
          {filteredUsers.length === 0 ? (
            <div className="bg-white rounded-xl shadow p-12 text-center text-gray-500">
              <p className="text-4xl mb-4">üë®‚Äçüë©‚Äçüëß</p>
              <p>{users.length === 0 ? 'No parents have registered yet' : 'No parents match your search'}</p>
            </div>
          ) : (
            <div className="space-y-4">
              {filteredUsers.map(parent => {
                const regs = getParentRegs(parent.email);
                const parentMsgs = getParentMessages(parent.email);
                const isExpanded = expandedParent === parent.email;
                const approvedRegs = regs.filter(r => r.status === 'approved').length;
                const pendingRegs = regs.filter(r => r.status === 'pending').length;
                const campersList = getParentCampers(parent.email);
                // Unread messages from admin to this parent
                const unreadMsgs = parentMsgs.filter(m => m.from !== parent.email && !m.readBy?.includes(parent.email)).length;

                return (
                  <div key={parent.email} className="bg-white rounded-xl shadow overflow-hidden">
                    {/* Parent Header */}
                    <div className="p-4 flex items-center gap-4">
                      <input
                        type="checkbox"
                        checked={selectedParents.includes(parent.email)}
                        onChange={() => toggleSelectParent(parent.email)}
                        className="w-5 h-5"
                      />

                      <div
                        className="flex-1 cursor-pointer"
                        onClick={() => setExpandedParent(isExpanded ? null : parent.email)}
                      >
                        <div className="flex items-center gap-3">
                          <div className="w-12 h-12 rounded-full bg-green-200 flex items-center justify-center text-xl font-bold text-green-700">
                            {parent.name?.[0]?.toUpperCase() || '?'}
                          </div>
                          <div>
                            <div className="font-bold text-gray-800">{parent.name}</div>
                            <div className="text-sm text-gray-500">{parent.email}</div>
                            {parent.phone && <div className="text-sm text-gray-500">{parent.phone}</div>}
                          </div>
                        </div>
                      </div>

                      {/* Stats */}
                      <div className="flex gap-3 text-center flex-wrap">
                        <div title="Campers linked to this parent">
                          <div className="text-lg font-bold text-teal-600">{campersList.length}</div>
                          <div className="text-xs text-gray-500">Campers</div>
                        </div>
                        <div title="Approved registration requests">
                          <div className="text-lg font-bold text-green-600">{approvedRegs}</div>
                          <div className="text-xs text-gray-500">Approved</div>
                        </div>
                        <div title="Pending registration requests">
                          <div className={`text-lg font-bold ${pendingRegs > 0 ? 'text-yellow-600' : 'text-gray-400'}`}>{pendingRegs}</div>
                          <div className="text-xs text-gray-500">Pending</div>
                        </div>
                        <div title="Unread messages from admin">
                          <div className={`text-lg font-bold ${unreadMsgs > 0 ? 'text-red-600' : 'text-gray-400'}`}>{unreadMsgs}</div>
                          <div className="text-xs text-gray-500">Unread</div>
                        </div>
                      </div>

                      {/* Actions */}
                      <div className="flex gap-2">
                        <button
                          onClick={(e) => { e.stopPropagation(); openComposer('single', parent); }}
                          className="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 text-sm"
                        >
                          ‚úâÔ∏è Message
                        </button>
                        <button
                          onClick={() => setExpandedParent(isExpanded ? null : parent.email)}
                          className="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-sm"
                        >
                          {isExpanded ? '‚ñ≤ Less' : '‚ñº More'}
                        </button>
                      </div>
                    </div>

                    {/* Expanded Details */}
                    {isExpanded && (
                      <div className="border-t bg-gray-50 p-4">
                        {/* Admin Actions Bar */}
                        <div className="flex gap-2 mb-4 pb-4 border-b">
                          <button
                            onClick={() => setEditingParent({ ...parent, originalEmail: parent.email })}
                            className="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm"
                          >
                            ‚úèÔ∏è Edit Parent
                          </button>
                          <button
                            onClick={() => setConfirmDelete({ type: 'parent', data: parent })}
                            className="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 text-sm"
                          >
                            üóëÔ∏è Delete Parent
                          </button>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6">
                          {/* Children */}
                          <div>
                            <div className="flex justify-between items-center mb-3">
                              <h4 className="font-bold text-gray-700">üèÄ Campers ({getParentCampers(parent.email).length})</h4>
                              <button
                                onClick={() => setManagingCampers(parent)}
                                className="text-xs text-blue-600 hover:underline"
                              >
                                Manage Campers
                              </button>
                            </div>
                            {getParentCampers(parent.email).length === 0 ? (
                              <p className="text-gray-500 text-sm">No campers linked yet. Click "Manage Campers" to add.</p>
                            ) : (
                              <div className="space-y-2">
                                {getParentCampers(parent.email).map(camper => (
                                  <div key={camper.id} className="flex items-center gap-3 p-2 bg-white rounded-lg">
                                    {camper.photo ? (
                                      <img src={camper.photo} className="w-10 h-10 rounded-full object-cover" />
                                    ) : (
                                      <div className="w-10 h-10 rounded-full bg-green-200 flex items-center justify-center text-sm">
                                        {camper.name?.[0]}
                                      </div>
                                    )}
                                    <div className="flex-1">
                                      <div className="font-medium">{camper.name}</div>
                                      <div className="text-xs text-gray-500">
                                        {camper.grade && `Grade ${camper.grade}`}
                                        {camper.birthdate && ` ‚Ä¢ ${calculateAge(camper.birthdate)} years old`}
                                      </div>
                                    </div>
                                    <div className="flex gap-1">
                                      <button
                                        onClick={() => setEditingChild({ child: { ...camper }, parentEmail: parent.email, originalChildId: camper.id })}
                                        className="p-1 text-blue-600 hover:bg-blue-50 rounded"
                                        title="Edit camper"
                                      >‚úèÔ∏è</button>
                                      <button
                                        onClick={() => setConfirmDelete({ type: 'camper', data: { camper, parentEmail: parent.email } })}
                                        className="p-1 text-red-600 hover:bg-red-50 rounded"
                                        title="Delete camper"
                                      >üóëÔ∏è</button>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>

                          {/* Registrations */}
                          <div>
                            <div className="flex justify-between items-center mb-3">
                              <h4 className="font-bold text-gray-700">üìã Registrations ({regs.length})</h4>
                              {campersList.length > 0 && (
                                <button
                                  onClick={() => { setCreatingRegFor(parent); setNewReg({ camperId: '', date: '', sessions: [] }); }}
                                  className="text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200"
                                >
                                  + Create Registration
                                </button>
                              )}
                            </div>
                            {regs.length === 0 ? (
                              <p className="text-gray-500 text-sm">{campersList.length === 0 ? 'Add campers first to create registrations' : 'No registrations yet'}</p>
                            ) : (
                              <div className="space-y-2 max-h-48 overflow-y-auto">
                                {regs.map(reg => (
                                  <div key={reg.id} className="flex items-center gap-2 p-2 bg-white rounded-lg text-sm">
                                    <div className="flex-1">
                                      <div className="font-medium">{reg.childName}</div>
                                      <div className="text-xs text-gray-500">{reg.date} ‚Ä¢ {reg.sessions?.join(', ')}</div>
                                    </div>
                                    <span className={`px-2 py-0.5 rounded text-xs ${
                                      reg.status === 'approved' ? 'bg-green-100 text-green-700' :
                                      reg.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                                      'bg-gray-100 text-gray-600'
                                    }`}>{reg.status}</span>
                                    <button
                                      onClick={() => setEditingReg(reg)}
                                      className="p-1 text-blue-600 hover:bg-blue-50 rounded"
                                      title="Edit registration"
                                    >‚úèÔ∏è</button>
                                    <button
                                      onClick={() => setConfirmDelete({ type: 'registration', data: reg })}
                                      className="p-1 text-red-600 hover:bg-red-50 rounded"
                                      title="Delete registration"
                                    >üóëÔ∏è</button>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>

                        {/* Message History */}
                        <div className="mt-4 pt-4 border-t">
                          <h4 className="font-bold text-gray-700 mb-3">üí¨ Messages ({parentMsgs.length})</h4>
                          {parentMsgs.length === 0 ? (
                            <p className="text-gray-500 text-sm">No messages yet</p>
                          ) : (
                            <div className="flex gap-2 flex-wrap">
                              <button
                                onClick={() => setViewingThread({ parentEmail: parent.email, parent })}
                                className="text-sm text-blue-600 hover:underline"
                              >
                                View conversation ({parentMsgs.length} messages) ‚Üí
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )}

          {/* Message Composer Modal */}
          {showComposer && (
            <MessageComposer
              mode={composerMode}
              recipient={composerRecipient}
              selectedParents={composerMode === 'selected' ? users.filter(u => selectedParents.includes(u.email)) : []}
              allParents={users}
              onSend={(msg) => {
                onSendMessage(msg);
                const recipientDesc = composerMode === 'all' ? 'all parents' :
                  composerMode === 'selected' ? `${selectedParents.length} parents` :
                  composerRecipient?.name;
                addToHistory('Message Sent', `Sent message to ${recipientDesc}: "${msg.subject}"`);
                showToast('Message sent!');
                setShowComposer(false);
                setSelectedParents([]);
              }}
              onCancel={() => setShowComposer(false)}
            />
          )}

          {/* Thread Viewer Modal */}
          {viewingThread && (
            <ThreadViewer
              parent={viewingThread.parent}
              messages={messages}
              onSendReply={(msg) => {
                onSendMessage(msg);
                addToHistory('Message Sent', `Replied to ${viewingThread.parent.name}`);
                showToast('Reply sent!');
              }}
              onClose={() => setViewingThread(null)}
            />
          )}

          {/* Edit Parent Modal */}
          {editingParent && (
            <AdminEditModal
              title="Edit Parent"
              onClose={() => setEditingParent(null)}
              onSave={() => {
                onUpdateUsers(users.map(u => u.email === editingParent.originalEmail ? { ...u, name: editingParent.name, email: editingParent.email, phone: editingParent.phone } : u));
                addToHistory('Admin Edit', `Updated parent: ${editingParent.name}`);
                showToast('Parent updated!');
                setEditingParent(null);
              }}
            >
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
                  <input
                    value={editingParent.name || ''}
                    onChange={e => setEditingParent({ ...editingParent, name: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                    autoComplete="off" data-1p-ignore="true"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                  <input
                    value={editingParent.email || ''}
                    onChange={e => setEditingParent({ ...editingParent, email: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                    autoComplete="off" data-1p-ignore="true"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                  <input
                    value={editingParent.phone || ''}
                    onChange={e => setEditingParent({ ...editingParent, phone: formatPhone(e.target.value) })}
                    className="w-full px-3 py-2 border rounded-lg"
                    autoComplete="off" data-1p-ignore="true"
                  />
                </div>
              </div>
            </AdminEditModal>
          )}

          {/* Edit Child Modal */}
          {editingChild && (
            <AdminEditModal
              title="Edit Child"
              onClose={() => setEditingChild(null)}
              onSave={() => {
                const parent = users.find(u => u.email === editingChild.parentEmail);
                if (parent) {
                  const updatedChildren = parent.children.map(c => c.id === editingChild.originalChildId ? { ...editingChild.child } : c);
                  onUpdateUsers(users.map(u => u.email === editingChild.parentEmail ? { ...u, children: updatedChildren } : u));
                  addToHistory('Admin Edit', `Updated child: ${editingChild.child.name}`);
                  showToast('Child updated!');
                }
                setEditingChild(null);
              }}
            >
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
                  <input
                    value={editingChild.child.name || ''}
                    onChange={e => setEditingChild({ ...editingChild, child: { ...editingChild.child, name: e.target.value } })}
                    className="w-full px-3 py-2 border rounded-lg"
                    autoComplete="off" data-1p-ignore="true"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Birthdate</label>
                  <input
                    type="date"
                    value={editingChild.child.birthdate || ''}
                    onChange={e => setEditingChild({ ...editingChild, child: { ...editingChild.child, birthdate: e.target.value } })}
                    className="w-full px-3 py-2 border rounded-lg"
                    data-1p-ignore="true"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Grade</label>
                  <select
                    value={editingChild.child.grade || ''}
                    onChange={e => setEditingChild({ ...editingChild, child: { ...editingChild.child, grade: e.target.value } })}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="">Select grade</option>
                    {['3rd', '4th', '5th', '6th', '7th', '8th'].map(g => <option key={g} value={g}>{g} Grade</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Phone (optional)</label>
                  <input
                    value={editingChild.child.phone || ''}
                    onChange={e => setEditingChild({ ...editingChild, child: { ...editingChild.child, phone: formatPhone(e.target.value) } })}
                    className="w-full px-3 py-2 border rounded-lg"
                    autoComplete="off" data-1p-ignore="true"
                  />
                </div>
              </div>
            </AdminEditModal>
          )}

          {/* Create Registration Modal */}
          {creatingRegFor && (
            <AdminEditModal
              title={`Create Registration for ${creatingRegFor.name}`}
              onClose={() => setCreatingRegFor(null)}
              onSave={async () => {
                if (!newReg.camperId || !newReg.date || newReg.sessions.length === 0) return;
                const camper = getParentCampers(creatingRegFor.email).find(c => c.id === newReg.camperId);
                const registration = {
                  id: 'reg_' + Date.now(),
                  camperId: newReg.camperId,
                  camperName: camper?.name || 'Unknown',
                  parentEmail: creatingRegFor.email,
                  parentName: creatingRegFor.name,
                  date: newReg.date,
                  sessions: newReg.sessions,
                  status: 'pending',
                  paymentStatus: 'unpaid',
                  createdAt: new Date().toISOString(),
                  createdBy: 'admin'
                };
                onUpdateRegistrations(registration);
                addToHistory('Admin', `Created registration for ${camper?.name} on ${newReg.date}`);
                showToast('Registration created!');
                setCreatingRegFor(null);
              }}
            >
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Select Camper *</label>
                  <select
                    value={newReg.camperId}
                    onChange={e => setNewReg({ ...newReg, camperId: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="">-- Select a camper --</option>
                    {getParentCampers(creatingRegFor.email).map(camper => (
                      <option key={camper.id} value={camper.id}>{camper.name}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Select Date *</label>
                  <select
                    value={newReg.date}
                    onChange={e => setNewReg({ ...newReg, date: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="">-- Select a date --</option>
                    {CAMP_DATES.map(date => (
                      <option key={date} value={date}>{new Date(date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Sessions *</label>
                  <div className="flex gap-4">
                    <button
                      type="button"
                      onClick={() => {
                        const sessions = newReg.sessions.includes('morning')
                          ? newReg.sessions.filter(s => s !== 'morning')
                          : [...newReg.sessions, 'morning'];
                        setNewReg({ ...newReg, sessions });
                      }}
                      className={`flex-1 py-3 rounded-lg border-2 font-medium ${
                        newReg.sessions.includes('morning')
                          ? 'bg-amber-100 border-amber-400 text-amber-800'
                          : 'bg-white border-gray-200 text-gray-600 hover:border-amber-300'
                      }`}
                    >
                      ‚òÄÔ∏è AM {newReg.sessions.includes('morning') && '‚úì'}
                    </button>
                    <button
                      type="button"
                      onClick={() => {
                        const sessions = newReg.sessions.includes('afternoon')
                          ? newReg.sessions.filter(s => s !== 'afternoon')
                          : [...newReg.sessions, 'afternoon'];
                        setNewReg({ ...newReg, sessions });
                      }}
                      className={`flex-1 py-3 rounded-lg border-2 font-medium ${
                        newReg.sessions.includes('afternoon')
                          ? 'bg-indigo-100 border-indigo-400 text-indigo-800'
                          : 'bg-white border-gray-200 text-gray-600 hover:border-indigo-300'
                      }`}
                    >
                      üåô PM {newReg.sessions.includes('afternoon') && '‚úì'}
                    </button>
                  </div>
                </div>
                {(!newReg.camperId || !newReg.date || newReg.sessions.length === 0) && (
                  <p className="text-sm text-gray-500 text-center">Please select a camper, date, and at least one session</p>
                )}
              </div>
            </AdminEditModal>
          )}

          {/* Edit Registration Modal */}
          {editingReg && (
            <AdminEditModal
              title="Edit Registration"
              onClose={() => setEditingReg(null)}
              onSave={() => {
                onUpdateRegistrations(editingReg);
                addToHistory('Admin Edit', `Updated registration for ${editingReg.camperName || editingReg.childName} on ${editingReg.date}`);
                showToast('Registration updated!');
                setEditingReg(null);
              }}
            >
              <div className="space-y-4">
                <div className="p-3 bg-gray-50 rounded-lg">
                  <p className="font-medium">{editingReg.camperName || editingReg.childName}</p>
                  <p className="text-sm text-gray-500">{editingReg.date}</p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Status</label>
                  <select
                    value={editingReg.status || ''}
                    onChange={e => setEditingReg({ ...editingReg, status: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                    <option value="cancelled">Cancelled</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                  <select
                    value={editingReg.paymentStatus || 'unpaid'}
                    onChange={e => setEditingReg({ ...editingReg, paymentStatus: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="unpaid">Unpaid</option>
                    <option value="paid">Paid</option>
                    <option value="refunded">Refunded</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Sessions</label>
                  <div className="flex gap-4">
                    <label className="flex items-center gap-2">
                      <input
                        type="checkbox"
                        checked={editingReg.sessions?.includes('morning')}
                        onChange={e => {
                          const sessions = e.target.checked
                            ? [...(editingReg.sessions || []), 'morning']
                            : (editingReg.sessions || []).filter(s => s !== 'morning');
                          setEditingReg({ ...editingReg, sessions });
                        }}
                        className="w-4 h-4"
                      />
                      Morning
                    </label>
                    <label className="flex items-center gap-2">
                      <input
                        type="checkbox"
                        checked={editingReg.sessions?.includes('afternoon')}
                        onChange={e => {
                          const sessions = e.target.checked
                            ? [...(editingReg.sessions || []), 'afternoon']
                            : (editingReg.sessions || []).filter(s => s !== 'afternoon');
                          setEditingReg({ ...editingReg, sessions });
                        }}
                        className="w-4 h-4"
                      />
                      Afternoon
                    </label>
                  </div>
                </div>
              </div>
            </AdminEditModal>
          )}

          {/* Confirm Delete Modal */}
          {confirmDelete && (
            <AdminConfirmDelete
              type={confirmDelete.type}
              data={confirmDelete.data}
              onCancel={() => setConfirmDelete(null)}
              onConfirm={async () => {
                if (confirmDelete.type === 'parent') {
                  if (onDeleteParent) {
                    await onDeleteParent(confirmDelete.data.email, confirmDelete.data.name);
                  } else {
                    onUpdateUsers(users.filter(u => u.email !== confirmDelete.data.email));
                    addToHistory('Admin Delete', `Deleted parent: ${confirmDelete.data.name}`);
                    showToast('Parent deleted');
                  }
                  setExpandedParent(null);
                } else if (confirmDelete.type === 'child') {
                  const { child, parentEmail } = confirmDelete.data;
                  const parent = users.find(u => u.email === parentEmail);
                  if (parent) {
                    const updatedChildren = parent.children.filter(c => c.id !== child.id);
                    onUpdateUsers(users.map(u => u.email === parentEmail ? { ...u, children: updatedChildren } : u));
                    addToHistory('Admin Delete', `Deleted child: ${child.name}`);
                    showToast('Child deleted');
                  }
                } else if (confirmDelete.type === 'registration') {
                  onDeleteRegistration(confirmDelete.data);
                  addToHistory('Admin Delete', `Deleted registration: ${confirmDelete.data.childName} on ${confirmDelete.data.date}`);
                  showToast('Registration deleted');
                }
                setConfirmDelete(null);
              }}
            />
          )}

          {/* Add Parent - Full Onboarding Flow */}
          {showAddParent && (
            <div className="fixed inset-0 z-50 bg-white overflow-auto">
              <div className="sticky top-0 bg-purple-600 text-white px-4 py-3 flex items-center justify-between z-10">
                <h2 className="font-display text-xl">Add New Parent (Admin)</h2>
                <button onClick={() => setShowAddParent(false)} className="px-4 py-1 bg-purple-500 hover:bg-purple-400 rounded">Cancel</button>
              </div>
              <ParentOnboarding
                onComplete={(newUser) => {
                  addToHistory('Parent', `Added parent ${newUser.name} via onboarding`);
                  setShowAddParent(false);
                  showToast(`Parent ${newUser.name} added successfully!`);
                }}
                onBack={() => setShowAddParent(false)}
                users={users}
                saveUsers={onUpdateUsers}
                saveEmergencyContacts={saveEmergencyContacts}
                emergencyContacts={emergencyContacts}
                saveOnboardingProgress={saveOnboardingProgress}
                campers={campers}
                saveCampers={onSaveCampers}
                saveCamperParentLinks={onSaveCamperParentLinks}
                camperParentLinks={camperParentLinks}
              />
            </div>
          )}

          {/* Manage Campers for Parent Modal */}
          {managingCampers && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                <h3 className="font-bold text-xl mb-2">Manage Campers for {managingCampers.name}</h3>
                <p className="text-sm text-gray-500 mb-4">Select which campers belong to this parent. A camper can have multiple parents.</p>

                {getAllCampers().length === 0 ? (
                  <p className="text-gray-500 text-center py-8">No campers exist yet. Add campers during parent onboarding or in the Campers tab.</p>
                ) : (
                  <div className="space-y-2 mb-4">
                    {getAllCampers().map(camper => {
                      const isLinked = (camperParentLinks || []).some(l => l.camperId === camper.id && l.parentEmail === managingCampers.email);
                      return (
                        <label key={camper.id} className={`flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 ${isLinked ? 'border-green-500 bg-green-50' : ''}`}>
                          <input
                            type="checkbox"
                            checked={isLinked}
                            onChange={() => toggleCamperLink(managingCampers.email, camper.id)}
                            className="w-5 h-5"
                          />
                          <div className="flex items-center gap-3">
                            {camper.photo ? (
                              <img src={camper.photo} alt={camper.name} className="w-8 h-8 rounded-full object-cover" />
                            ) : (
                              <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-400 text-sm">
                                {camper.name?.charAt(0)}
                              </div>
                            )}
                            <div>
                              <div className="font-medium">{camper.name}</div>
                              <div className="text-xs text-gray-500">{camper.grade || 'No grade'} {camper.birthdate ? `‚Ä¢ Age ${calculateAge(camper.birthdate)}` : ''}</div>
                            </div>
                          </div>
                        </label>
                      );
                    })}
                  </div>
                )}

                <button onClick={() => setManagingCampers(null)} className="w-full px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">
                  Done
                </button>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ==================== ADMIN EDIT MODAL ====================
    const AdminEditModal = ({ title, children, onClose, onSave }) => {
      const mouseDownTarget = useRef(null);

      return (
        <div
          className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
          onMouseDown={e => mouseDownTarget.current = e.target}
          onClick={e => e.target === e.currentTarget && mouseDownTarget.current === e.currentTarget && onClose()}
        >
          <div className="bg-white rounded-xl max-w-md w-full overflow-hidden">
            <div className="bg-blue-600 text-white px-6 py-4 flex justify-between items-center">
              <h2 className="font-display text-xl">‚úèÔ∏è {title}</h2>
              <button onClick={onClose} className="text-2xl hover:bg-blue-500 rounded px-2">√ó</button>
            </div>
            <div className="p-6">
              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                <p className="text-sm text-yellow-800">‚ö†Ô∏è <strong>Warning:</strong> Changes made here cannot be automatically undone. Please verify all information before saving.</p>
              </div>
              {children}
              <div className="flex gap-4 mt-6">
                <button onClick={onClose} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                <button onClick={onSave} className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ==================== ADMIN CONFIRM DELETE ====================
    const AdminConfirmDelete = ({ type, data, onCancel, onConfirm }) => {
      const [confirmText, setConfirmText] = useState('');
      const requiredText = 'DELETE';

      const getDescription = () => {
        if (type === 'parent') return `parent account "${data.name}" and all their data`;
        if (type === 'child') return `child "${data.child.name}" from ${data.parentEmail}`;
        if (type === 'registration') return `registration for ${data.childName} on ${data.date}`;
        return 'this item';
      };

      return (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-xl max-w-md w-full overflow-hidden" onClick={e => e.stopPropagation()}>
            <div className="bg-red-600 text-white px-6 py-4">
              <h2 className="font-display text-xl">‚ö†Ô∏è Confirm Deletion</h2>
            </div>
            <div className="p-6">
              <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                <p className="text-red-800 font-medium mb-2">You are about to permanently delete:</p>
                <p className="text-red-700">{getDescription()}</p>
              </div>

              <p className="text-gray-700 mb-4">This action <strong>cannot be undone</strong>. All associated data will be permanently removed.</p>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Type <span className="font-mono bg-gray-100 px-1">DELETE</span> to confirm:
                </label>
                <input
                  value={confirmText}
                  onChange={e => setConfirmText(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg"
                  placeholder="DELETE"
                  autoComplete="off"
                  data-1p-ignore="true"
                />
              </div>

              <div className="flex gap-4">
                <button onClick={onCancel} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                <button
                  onClick={onConfirm}
                  disabled={confirmText !== requiredText}
                  className="flex-1 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                >
                  Delete Permanently
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ==================== MESSAGE COMPOSER ====================
    const MessageComposer = ({ mode, recipient, selectedParents, allParents, onSend, onCancel }) => {
      const [subject, setSubject] = useState('');
      const [body, setBody] = useState('');
      const mouseDownTarget = useRef(null);

      const getRecipientText = () => {
        if (mode === 'all') return `All Parents (${allParents.length})`;
        if (mode === 'selected') return selectedParents.map(p => p.name).join(', ');
        return recipient?.name || '';
      };

      const getRecipientEmails = () => {
        if (mode === 'all') return 'all';
        if (mode === 'selected') return selectedParents.map(p => p.email);
        return [recipient?.email];
      };

      const handleSend = () => {
        if (!subject.trim() || !body.trim()) return;
        const msg = {
          id: 'msg_' + Date.now(),
          threadId: mode === 'single' ? recipient?.email : 'broadcast_' + Date.now(),
          from: 'admin',
          to: getRecipientEmails(),
          subject: subject.trim(),
          body: body.trim(),
          sentAt: new Date().toISOString(),
          readBy: ['admin']
        };
        onSend(msg);
      };

      const handleBackdropMouseDown = (e) => { mouseDownTarget.current = e.target; };
      const handleBackdropClick = (e) => {
        if (e.target === e.currentTarget && mouseDownTarget.current === e.currentTarget) {
          onCancel();
        }
      };

      return (
        <div
          className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
          onMouseDown={handleBackdropMouseDown}
          onClick={handleBackdropClick}
        >
          <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div className="bg-blue-600 text-white px-6 py-4 flex justify-between items-center">
              <h2 className="font-display text-2xl">‚úâÔ∏è New Message</h2>
              <button onClick={onCancel} className="text-2xl hover:bg-blue-500 rounded px-2">√ó</button>
            </div>
            <div className="p-6 space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">To:</label>
                <div className="px-4 py-2 bg-gray-100 rounded-lg text-gray-700">
                  {mode === 'all' && <span className="text-blue-600 font-medium">üì¢ </span>}
                  {getRecipientText()}
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Subject:</label>
                <input
                  value={subject}
                  onChange={e => setSubject(e.target.value)}
                  className="w-full px-4 py-2 border rounded-lg"
                  placeholder="Message subject..."
                  autoComplete="off"
                  data-1p-ignore="true"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Message:</label>
                <textarea
                  value={body}
                  onChange={e => setBody(e.target.value)}
                  className="w-full px-4 py-2 border rounded-lg"
                  rows={6}
                  placeholder="Type your message here..."
                  autoComplete="off"
                  data-1p-ignore="true"
                />
              </div>

              <div className="flex gap-4 pt-4">
                <button onClick={onCancel} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                  Cancel
                </button>
                <button
                  onClick={handleSend}
                  disabled={!subject.trim() || !body.trim()}
                  className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300"
                >
                  Send Message
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ==================== THREAD VIEWER ====================
    const ThreadViewer = ({ parent, messages, onSendReply, onClose }) => {
      const [replyText, setReplyText] = useState('');
      const messagesEndRef = useRef(null);
      const mouseDownTarget = useRef(null);

      const threadMessages = messages
        .filter(m => m.to === 'all' || m.to?.includes(parent.email) || m.from === parent.email)
        .sort((a, b) => new Date(a.sentAt) - new Date(b.sentAt));

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [threadMessages.length]);

      const handleSendReply = () => {
        if (!replyText.trim()) return;
        const msg = {
          id: 'msg_' + Date.now(),
          threadId: parent.email,
          from: 'admin',
          to: [parent.email],
          subject: '',
          body: replyText.trim(),
          sentAt: new Date().toISOString(),
          readBy: ['admin']
        };
        onSendReply(msg);
        setReplyText('');
      };

      const handleBackdropMouseDown = (e) => { mouseDownTarget.current = e.target; };
      const handleBackdropClick = (e) => {
        if (e.target === e.currentTarget && mouseDownTarget.current === e.currentTarget) {
          onClose();
        }
      };

      return (
        <div
          className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
          onMouseDown={handleBackdropMouseDown}
          onClick={handleBackdropClick}
        >
          <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div className="bg-green-700 text-white px-6 py-4 flex justify-between items-center">
              <div>
                <h2 className="font-display text-2xl">üí¨ Conversation</h2>
                <p className="text-green-200 text-sm">with {parent.name}</p>
              </div>
              <button onClick={onClose} className="text-2xl hover:bg-green-600 rounded px-2">√ó</button>
            </div>

            {/* Messages */}
            <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50" style={{ maxHeight: '50vh' }}>
              {threadMessages.length === 0 ? (
                <p className="text-center text-gray-500 py-8">No messages yet. Start the conversation!</p>
              ) : (
                threadMessages.map(msg => (
                  <div
                    key={msg.id}
                    className={`flex ${msg.from === 'admin' ? 'justify-end' : 'justify-start'}`}
                  >
                    <div
                      className={`max-w-[80%] rounded-lg p-3 ${
                        msg.from === 'admin'
                          ? 'bg-blue-600 text-white'
                          : 'bg-white border'
                      }`}
                    >
                      {msg.subject && <div className="font-bold text-sm mb-1">{msg.subject}</div>}
                      <div className="whitespace-pre-wrap">{msg.body}</div>
                      <div className={`text-xs mt-1 ${msg.from === 'admin' ? 'text-blue-200' : 'text-gray-400'}`}>
                        {formatTimestamp(msg.sentAt)}
                        {msg.to === 'all' && <span className="ml-2">üì¢ Broadcast</span>}
                      </div>
                    </div>
                  </div>
                ))
              )}
              <div ref={messagesEndRef} />
            </div>

            {/* Reply Input */}
            <div className="border-t p-4 bg-white">
              <div className="flex gap-2">
                <textarea
                  value={replyText}
                  onChange={e => setReplyText(e.target.value)}
                  className="flex-1 px-4 py-2 border rounded-lg resize-none"
                  rows={2}
                  placeholder="Type your reply..."
                  autoComplete="off"
                  data-1p-ignore="true"
                  onKeyDown={e => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                      e.preventDefault();
                      handleSendReply();
                    }
                  }}
                />
                <button
                  onClick={handleSendReply}
                  disabled={!replyText.trim()}
                  className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300"
                >
                  Send
                </button>
              </div>
              <p className="text-xs text-gray-500 mt-1">Press Enter to send, Shift+Enter for new line</p>
            </div>
          </div>
        </div>
      );
    };

    // ==================== ADMINS TAB ====================
    const AdminsTab = ({ admins, currentAdminId, onSave, showToast }) => {
      const [editingAdmin, setEditingAdmin] = useState(null);
      const [showAddForm, setShowAddForm] = useState(false);
      const [confirmDelete, setConfirmDelete] = useState(null);
      const [deleteConfirmText, setDeleteConfirmText] = useState('');

      const [formData, setFormData] = useState({
        username: '', password: '', name: '', email: ''
      });

      const resetForm = () => {
        setFormData({ username: '', password: '', name: '', email: '' });
        setShowAddForm(false);
        setEditingAdmin(null);
      };

      const handleSave = () => {
        if (!formData.username || !formData.password || !formData.name) {
          showToast('Username, password, and name are required', 'error');
          return;
        }
        // Check for duplicate username
        if (admins.some(a => a.username === formData.username && a.id !== editingAdmin?.id)) {
          showToast('Username already exists', 'error');
          return;
        }

        if (editingAdmin) {
          const updated = admins.map(a => a.id === editingAdmin.id ? { ...a, ...formData } : a);
          onSave(updated, `Updated admin ${formData.name}`);
        } else {
          const newAdmin = {
            id: 'admin_' + Date.now(),
            ...formData,
            createdAt: new Date().toISOString()
          };
          onSave([...admins, newAdmin], `Added admin ${formData.name}`);
        }
        resetForm();
        showToast(editingAdmin ? 'Admin updated!' : 'Admin added!');
      };

      const handleDelete = (admin) => {
        if (admins.length <= 1) {
          showToast('Cannot delete the last admin!', 'error');
          return;
        }
        if (admin.id === currentAdminId) {
          showToast('Cannot delete yourself!', 'error');
          return;
        }
        setConfirmDelete(admin);
      };

      const confirmDeleteAdmin = () => {
        if (deleteConfirmText !== 'DELETE') {
          showToast('Please type DELETE to confirm', 'error');
          return;
        }
        const updated = admins.filter(a => a.id !== confirmDelete.id);
        onSave(updated, `Deleted admin ${confirmDelete.name}`);
        setConfirmDelete(null);
        setDeleteConfirmText('');
        showToast('Admin deleted');
      };

      const startEdit = (admin) => {
        setFormData({
          username: admin.username,
          password: admin.password,
          name: admin.name,
          email: admin.email || ''
        });
        setEditingAdmin(admin);
        setShowAddForm(true);
      };

      return (
        <div className="space-y-6">
          <div className="bg-white rounded-xl shadow p-6">
            <div className="flex justify-between items-center mb-4">
              <div>
                <h3 className="font-bold text-xl text-purple-800">üëë Admin Accounts</h3>
                <p className="text-sm text-gray-500">{admins.length} admin{admins.length !== 1 ? 's' : ''} ‚Ä¢ At least 1 admin required</p>
              </div>
              <button
                onClick={() => setShowAddForm(true)}
                className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
              >
                + Add Admin
              </button>
            </div>

            {/* Admin List */}
            <div className="space-y-3">
              {admins.map(admin => (
                <div key={admin.id} className="border rounded-lg p-4 flex justify-between items-center hover:bg-gray-50">
                  <div>
                    <div className="font-bold text-lg">{admin.name}</div>
                    <div className="text-sm text-gray-600">
                      Username: <span className="font-mono bg-gray-100 px-2 rounded">{admin.username}</span>
                      {admin.email && <span className="ml-3">‚Ä¢ {admin.email}</span>}
                    </div>
                    <div className="text-xs text-gray-400">
                      Created: {new Date(admin.createdAt).toLocaleDateString()}
                      {admin.id === currentAdminId && <span className="ml-2 px-2 py-0.5 bg-green-100 text-green-700 rounded">You</span>}
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={() => startEdit(admin)}
                      className="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
                    >
                      Edit
                    </button>
                    <button
                      onClick={() => handleDelete(admin)}
                      disabled={admins.length <= 1 || admin.id === currentAdminId}
                      className="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      Delete
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Add/Edit Form Modal */}
          {showAddForm && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-md w-full p-6" onClick={e => e.stopPropagation()}>
                <h3 className="font-bold text-xl mb-4">{editingAdmin ? 'Edit Admin' : 'Add New Admin'}</h3>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Name *</label>
                    <input
                      value={formData.name}
                      onChange={e => setFormData({ ...formData, name: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg"
                      placeholder="Full Name"
                      autoComplete="off"
                      data-1p-ignore="true"
                    />
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Username *</label>
                    <input
                      value={formData.username}
                      onChange={e => setFormData({ ...formData, username: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg font-mono"
                      placeholder="login_username"
                      autoComplete="off"
                      data-1p-ignore="true"
                    />
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Password *</label>
                    <input
                      type="text"
                      value={formData.password}
                      onChange={e => setFormData({ ...formData, password: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg font-mono"
                      placeholder="password"
                      autoComplete="off"
                      data-1p-ignore="true"
                    />
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Email (optional)</label>
                    <input
                      type="email"
                      value={formData.email}
                      onChange={e => setFormData({ ...formData, email: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg"
                      placeholder="admin@example.com"
                      autoComplete="off"
                      data-1p-ignore="true"
                    />
                  </div>
                </div>
                <div className="flex gap-3 mt-6">
                  <button onClick={resetForm} className="flex-1 px-4 py-2 border rounded-lg">Cancel</button>
                  <button onClick={handleSave} className="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                    {editingAdmin ? 'Save Changes' : 'Add Admin'}
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Delete Confirmation Modal */}
          {confirmDelete && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-md w-full p-6 text-center" onClick={e => e.stopPropagation()}>
                <div className="text-5xl mb-4">‚ö†Ô∏è</div>
                <h3 className="font-bold text-xl text-red-600 mb-2">Delete Admin Account</h3>
                <p className="text-gray-600 mb-4">
                  Are you sure you want to delete <strong>{confirmDelete.name}</strong>?
                  <br />This cannot be undone.
                </p>
                <p className="text-sm text-gray-500 mb-2">Type DELETE to confirm:</p>
                <input
                  value={deleteConfirmText}
                  onChange={e => setDeleteConfirmText(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg text-center font-mono mb-4"
                  placeholder="DELETE"
                  autoComplete="off"
                  data-1p-ignore="true"
                />
                <div className="flex gap-3">
                  <button onClick={() => { setConfirmDelete(null); setDeleteConfirmText(''); }} className="flex-1 px-4 py-2 border rounded-lg">Cancel</button>
                  <button onClick={confirmDeleteAdmin} disabled={deleteConfirmText !== 'DELETE'} className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-300">
                    Delete Admin
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ==================== SESSIONS TAB ====================
    const SessionsTab = ({ blockedSessions, allDates, onSaveBlockedSessions, registrations, counselors, availability, assignments, showToast, selectedMonth, setSelectedMonth }) => {
      const [confirmBlock, setConfirmBlock] = useState(null);

      // Initialize selected month if not set
      React.useEffect(() => {
        if (!selectedMonth && allDates.length > 0) {
          const d = new Date(allDates[0] + 'T12:00:00');
          setSelectedMonth(`${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`);
        }
      }, [selectedMonth, allDates, setSelectedMonth]);

      // Get months that have camp dates
      const getMonths = () => {
        const months = [];
        allDates.forEach(date => {
          const d = new Date(date + 'T12:00:00');
          const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
          if (!months.some(m => m.key === monthKey)) {
            months.push({
              key: monthKey,
              name: d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
              year: d.getFullYear(),
              month: d.getMonth()
            });
          }
        });
        return months;
      };

      const months = getMonths();

      // Get dates for selected month
      const getMonthDates = () => {
        if (!selectedMonth) return [];
        const [year, month] = selectedMonth.split('-').map(Number);
        return allDates.filter(date => {
          const d = new Date(date + 'T12:00:00');
          return d.getFullYear() === year && d.getMonth() === month - 1;
        });
      };

      const monthDates = getMonthDates();

      // Check if a session is blocked
      const isSessionBlocked = (date, session) => {
        return blockedSessions[date]?.[session] === true;
      };

      // Check if whole day is blocked
      const isDayFullyBlocked = (date) => {
        return isSessionBlocked(date, 'morning') && isSessionBlocked(date, 'afternoon');
      };

      // Check if day is partially blocked
      const isDayPartiallyBlocked = (date) => {
        const am = isSessionBlocked(date, 'morning');
        const pm = isSessionBlocked(date, 'afternoon');
        return (am || pm) && !(am && pm);
      };

      // Get registration stats for a date/session
      const getSessionStats = (date, session) => {
        const regs = registrations.filter(r =>
          r.date === date &&
          r.sessions?.includes(session) &&
          r.status !== 'cancelled'
        );
        return { count: regs.length };
      };

      // Get counselor availability for a date/session
      const getCounselorStats = (date, session) => {
        let available = 0;
        let total = counselors.filter(c => c.visible).length;

        Object.entries(availability).forEach(([email, avail]) => {
          const counselor = counselors.find(c => c.email === email && c.visible);
          if (!counselor) return;

          const dateAvail = avail[date];
          if (dateAvail?.available?.includes(session) ||
              (Array.isArray(dateAvail) && dateAvail.includes(session))) {
            available++;
          }
        });

        return { available, total };
      };

      // Get assigned campers for a date/session
      const getAssignedStats = (date, session) => {
        const key = `${date}_${session}`;
        const sessionAssignments = assignments[key] || {};
        const assigned = Object.values(sessionAssignments).flat().length;
        return { assigned };
      };

      // Toggle a single session
      const toggleSession = (date, session) => {
        const isBlocked = isSessionBlocked(date, session);
        const stats = getSessionStats(date, session);

        if (!isBlocked && stats.count > 0) {
          // Blocking with registrations - confirm first
          setConfirmBlock({ date, session, count: stats.count });
          return;
        }

        const newBlocked = { ...blockedSessions };
        if (!newBlocked[date]) newBlocked[date] = {};

        if (isBlocked) {
          delete newBlocked[date][session];
          if (Object.keys(newBlocked[date]).length === 0) {
            delete newBlocked[date];
          }
          onSaveBlockedSessions(newBlocked, `Unblocked ${session} on ${date}`);
          showToast(`${session} on ${date} is now available`);
        } else {
          newBlocked[date][session] = true;
          onSaveBlockedSessions(newBlocked, `Blocked ${session} on ${date}`);
          showToast(`${session} on ${date} is now blocked`);
        }
      };

      // Toggle whole day (both sessions)
      const toggleDay = (date) => {
        const fullyBlocked = isDayFullyBlocked(date);
        const morningStats = getSessionStats(date, 'morning');
        const afternoonStats = getSessionStats(date, 'afternoon');
        const totalRegs = morningStats.count + afternoonStats.count;

        if (!fullyBlocked && totalRegs > 0) {
          // Blocking with registrations - confirm first
          setConfirmBlock({ date, session: 'both', count: totalRegs });
          return;
        }

        const newBlocked = { ...blockedSessions };

        if (fullyBlocked) {
          // Unblock whole day
          delete newBlocked[date];
          onSaveBlockedSessions(newBlocked, `Unblocked whole day ${date}`);
          showToast(`${date} is now fully available`);
        } else {
          // Block whole day
          newBlocked[date] = { morning: true, afternoon: true };
          onSaveBlockedSessions(newBlocked, `Blocked whole day ${date}`);
          showToast(`${date} is now fully blocked`);
        }
      };

      // Handle confirm block
      const handleConfirmBlock = () => {
        const { date, session } = confirmBlock;
        const newBlocked = { ...blockedSessions };
        if (!newBlocked[date]) newBlocked[date] = {};

        if (session === 'both') {
          newBlocked[date] = { morning: true, afternoon: true };
          onSaveBlockedSessions(newBlocked, `Blocked whole day ${date} (had registrations)`);
          showToast(`${date} is now fully blocked`);
        } else {
          newBlocked[date][session] = true;
          onSaveBlockedSessions(newBlocked, `Blocked ${session} on ${date} (had registrations)`);
          showToast(`${session} on ${date} is now blocked`);
        }
        setConfirmBlock(null);
      };

      // Get week days for a date
      const getDayName = (date) => {
        const d = new Date(date + 'T12:00:00');
        return d.toLocaleDateString('en-US', { weekday: 'short' });
      };

      const formatDateShort = (date) => {
        const d = new Date(date + 'T12:00:00');
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      };

      // Stats
      const totalSessions = allDates.length * 2;
      const blockedCount = Object.values(blockedSessions).reduce((sum, day) =>
        sum + (day.morning ? 1 : 0) + (day.afternoon ? 1 : 0), 0);
      const availableCount = totalSessions - blockedCount;

      return (
        <div className="space-y-6">
          {/* Summary Stats */}
          <div className="grid grid-cols-3 gap-4">
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-3xl font-bold text-blue-600">{totalSessions}</div>
              <div className="text-gray-600 text-sm">Total Sessions</div>
            </div>
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-3xl font-bold text-green-600">{availableCount}</div>
              <div className="text-gray-600 text-sm">Available</div>
            </div>
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-3xl font-bold text-red-600">{blockedCount}</div>
              <div className="text-gray-600 text-sm">Blocked</div>
            </div>
          </div>

          {/* Month Selector */}
          <div className="bg-white rounded-xl shadow p-4">
            <div className="flex flex-wrap gap-2 mb-4">
              {months.map(m => (
                <button
                  key={m.key}
                  onClick={() => setSelectedMonth(m.key)}
                  className={`px-4 py-2 rounded-lg text-sm ${
                    selectedMonth === m.key
                      ? 'bg-green-600 text-white'
                      : 'bg-gray-100 hover:bg-gray-200'
                  }`}
                >
                  {m.name}
                </button>
              ))}
            </div>

            {/* Instructions */}
            <p className="text-sm text-gray-500 mb-4">
              Click AM/PM to toggle individual sessions, or the date header to toggle the whole day. Blocked sessions will not appear as options for registration.
            </p>

            {/* Date Grid */}
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
              {monthDates.map(date => {
                const fullyBlocked = isDayFullyBlocked(date);
                const partiallyBlocked = isDayPartiallyBlocked(date);
                const amBlocked = isSessionBlocked(date, 'morning');
                const pmBlocked = isSessionBlocked(date, 'afternoon');
                const amStats = getSessionStats(date, 'morning');
                const pmStats = getSessionStats(date, 'afternoon');
                const amCounselors = getCounselorStats(date, 'morning');
                const pmCounselors = getCounselorStats(date, 'afternoon');
                const amAssigned = getAssignedStats(date, 'morning');
                const pmAssigned = getAssignedStats(date, 'afternoon');

                return (
                  <div
                    key={date}
                    className={`rounded-lg border-2 overflow-hidden ${
                      fullyBlocked ? 'border-red-300 bg-red-50' :
                      partiallyBlocked ? 'border-yellow-300 bg-yellow-50' :
                      'border-green-300 bg-green-50'
                    }`}
                  >
                    {/* Date Header - Click to toggle whole day */}
                    <button
                      onClick={() => toggleDay(date)}
                      className={`w-full p-2 text-center font-bold transition-colors ${
                        fullyBlocked ? 'bg-red-200 hover:bg-red-300' :
                        partiallyBlocked ? 'bg-yellow-200 hover:bg-yellow-300' :
                        'bg-green-200 hover:bg-green-300'
                      }`}
                    >
                      <div className="text-xs text-gray-600">{getDayName(date)}</div>
                      <div>{formatDateShort(date)}</div>
                    </button>

                    {/* Session Buttons */}
                    <div className="p-2 space-y-2">
                      {/* Morning Session */}
                      <button
                        onClick={() => toggleSession(date, 'morning')}
                        className={`w-full p-2 rounded text-left text-sm transition-colors ${
                          amBlocked ? 'bg-red-100 hover:bg-red-200' : 'bg-white hover:bg-gray-50'
                        }`}
                      >
                        <div className="flex justify-between items-center">
                          <span className="font-medium">‚òÄÔ∏è AM</span>
                          <span className={amBlocked ? 'text-red-600' : 'text-green-600'}>
                            {amBlocked ? 'üö´' : '‚úì'}
                          </span>
                        </div>
                        <div className="text-xs text-gray-500 mt-1">
                          <span title="Counselors available">üë§ {amCounselors.available}/{amCounselors.total}</span>
                          <span className="mx-1">‚Ä¢</span>
                          <span title="Campers registered">üèïÔ∏è {amStats.count}</span>
                          {amAssigned.assigned > 0 && (
                            <>
                              <span className="mx-1">‚Ä¢</span>
                              <span title="Assigned">üìã {amAssigned.assigned}</span>
                            </>
                          )}
                        </div>
                      </button>

                      {/* Afternoon Session */}
                      <button
                        onClick={() => toggleSession(date, 'afternoon')}
                        className={`w-full p-2 rounded text-left text-sm transition-colors ${
                          pmBlocked ? 'bg-red-100 hover:bg-red-200' : 'bg-white hover:bg-gray-50'
                        }`}
                      >
                        <div className="flex justify-between items-center">
                          <span className="font-medium">üåô PM</span>
                          <span className={pmBlocked ? 'text-red-600' : 'text-green-600'}>
                            {pmBlocked ? 'üö´' : '‚úì'}
                          </span>
                        </div>
                        <div className="text-xs text-gray-500 mt-1">
                          <span title="Counselors available">üë§ {pmCounselors.available}/{pmCounselors.total}</span>
                          <span className="mx-1">‚Ä¢</span>
                          <span title="Campers registered">üèïÔ∏è {pmStats.count}</span>
                          {pmAssigned.assigned > 0 && (
                            <>
                              <span className="mx-1">‚Ä¢</span>
                              <span title="Assigned">üìã {pmAssigned.assigned}</span>
                            </>
                          )}
                        </div>
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Legend */}
          <div className="bg-white rounded-xl shadow p-4">
            <h4 className="font-bold text-gray-700 mb-2">Legend</h4>
            <div className="flex flex-wrap gap-4 text-sm">
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-green-50 border-2 border-green-300 rounded"></div>
                <span>Fully available</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-yellow-50 border-2 border-yellow-300 rounded"></div>
                <span>Partially blocked</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-red-50 border-2 border-red-300 rounded"></div>
                <span>Fully blocked</span>
              </div>
            </div>
            <div className="mt-3 text-xs text-gray-500">
              <strong>Stats:</strong> üë§ = Counselors available/total ‚Ä¢ üèïÔ∏è = Campers registered ‚Ä¢ üìã = Assigned to pods
            </div>
          </div>

          {/* Confirm Block Modal */}
          {confirmBlock && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-md w-full p-6 text-center" onClick={e => e.stopPropagation()}>
                <div className="text-5xl mb-4">‚ö†Ô∏è</div>
                <h3 className="font-bold text-xl text-orange-600 mb-2">Block Session with Registrations?</h3>
                <p className="text-gray-600 mb-4">
                  <strong>{confirmBlock.date}</strong> {confirmBlock.session === 'both' ? '(both sessions)' : `(${confirmBlock.session})`} has <strong>{confirmBlock.count}</strong> existing registration{confirmBlock.count !== 1 ? 's' : ''}.
                  <br /><br />
                  Blocking will prevent new registrations but won't affect existing ones.
                </p>
                <div className="flex gap-3">
                  <button onClick={() => setConfirmBlock(null)} className="flex-1 px-4 py-2 border rounded-lg">Cancel</button>
                  <button onClick={handleConfirmBlock} className="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                    Block Anyway
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ==================== CHILDREN TAB (All Child Profiles) ====================
    const ChildrenTab = ({ children, childParentLinks, users, registrations, onSaveChildren, onSaveLinks, showToast }) => {
      const [searchTerm, setSearchTerm] = useState('');

      // Get all children profiles from BOTH sources:
      // 1. Standalone children from camp_children table
      // 2. Legacy children embedded in user accounts
      const getAllChildren = () => {
        // Start with standalone children
        const standaloneChildren = children.map(child => ({
          ...child,
          source: 'standalone',
          parents: childParentLinks
            .filter(link => link.childId === child.id)
            .map(link => users.find(u => u.email === link.parentEmail))
            .filter(Boolean),
          hasRegistrations: registrations.some(r => r.childId === child.id)
        }));

        // Add legacy children from users (avoid duplicates)
        const legacyChildren = users.flatMap(user =>
          (user.children || [])
            .filter(child => !children.some(c => c.id === child.id)) // Don't duplicate
            .map(child => ({
              ...child,
              source: 'legacy',
              parents: [user],
              parentEmail: user.email,
              parentName: user.name,
              hasRegistrations: registrations.some(r => r.childId === child.id)
            }))
        );

        return [...standaloneChildren, ...legacyChildren];
      };

      const allChildren = getAllChildren();
      const filteredChildren = allChildren.filter(c =>
        c.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        c.parents?.some(p => p?.name?.toLowerCase().includes(searchTerm.toLowerCase()))
      );

      // Separate into registered (campers) and not registered (children)
      const unregisteredChildren = filteredChildren.filter(c => !c.hasRegistrations);
      const registeredChildren = filteredChildren.filter(c => c.hasRegistrations);

      const getAge = (birthdate) => {
        if (!birthdate) return null;
        const today = new Date();
        const birth = new Date(birthdate);
        let age = today.getFullYear() - birth.getFullYear();
        const m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
        return age;
      };

      const ChildCard = ({ child }) => {
        const age = getAge(child.birthdate);
        return (
          <div className="border rounded-xl p-4 hover:shadow-md transition-shadow">
            <div className="flex items-start gap-4">
              <div className="w-16 h-16 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-xl font-bold overflow-hidden flex-shrink-0">
                {child.photo ? (
                  <img src={child.photo} alt={child.name} className="w-full h-full object-cover" />
                ) : (
                  child.name?.charAt(0)?.toUpperCase() || '?'
                )}
              </div>
              <div className="flex-1 min-w-0">
                <h4 className="font-bold text-gray-800 truncate">{child.name}</h4>
                <div className="text-sm text-gray-600">
                  {age && <span>Age {age}</span>}
                  {child.grade && <span className="ml-2">‚Ä¢ Grade {child.grade}</span>}
                </div>
                {child.parents?.length > 0 && (
                  <div className="text-xs text-gray-500 mt-1">
                    Parents: {child.parents.map(p => p.name).join(', ')}
                  </div>
                )}
              </div>
              <div className="flex-shrink-0">
                {child.hasRegistrations ? (
                  <span className="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full font-medium">
                    ‚úì Registered
                  </span>
                ) : (
                  <span className="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full font-medium">
                    Not Registered
                  </span>
                )}
              </div>
            </div>
          </div>
        );
      };

      return (
        <div className="space-y-6">
          <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg">
            <p className="text-blue-800">
              <strong>Children &amp; Campers:</strong> All child profiles are shown here. When children register for camp sessions, they become "campers" but remain in this list. Children are never deleted when they become campers - they simply gain registered status.
            </p>
          </div>

          <div className="bg-white rounded-xl shadow p-6">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-bold text-lg text-green-800">üë∂ All Children Profiles ({allChildren.length})</h3>
              <input
                type="text"
                placeholder="Search children or parents..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="px-4 py-2 border rounded-lg w-64"
              />
            </div>

            {unregisteredChildren.length > 0 && (
              <div className="mb-6">
                <h4 className="font-medium text-yellow-700 mb-3 flex items-center gap-2">
                  <span className="w-3 h-3 bg-yellow-400 rounded-full"></span>
                  Not Yet Registered ({unregisteredChildren.length})
                </h4>
                <div className="grid md:grid-cols-2 gap-4">
                  {unregisteredChildren.map(child => (
                    <ChildCard key={child.id} child={child} />
                  ))}
                </div>
              </div>
            )}

            {registeredChildren.length > 0 && (
              <div>
                <h4 className="font-medium text-green-700 mb-3 flex items-center gap-2">
                  <span className="w-3 h-3 bg-green-500 rounded-full"></span>
                  üèïÔ∏è Registered as Campers ({registeredChildren.length})
                </h4>
                <div className="grid md:grid-cols-2 gap-4">
                  {registeredChildren.map(child => (
                    <ChildCard key={child.id} child={child} />
                  ))}
                </div>
              </div>
            )}

            {allChildren.length === 0 && (
              <p className="text-gray-500 text-center py-8">No children profiles found. Children are created when parents complete onboarding.</p>
            )}
          </div>
        </div>
      );
    };

    // ==================== CAMPERS TAB ====================
    const CampersTab = ({ users, registrations, campers, camperParentLinks, onSaveCampers, onSaveLinks, onDeleteCamper, showToast, addToHistory }) => {
      const [searchTerm, setSearchTerm] = useState('');
      const [sortBy, setSortBy] = useState('name');
      const [editingCamper, setEditingCamper] = useState(null);
      const [showAddForm, setShowAddForm] = useState(false);
      const [confirmDelete, setConfirmDelete] = useState(null);
      const [deleteConfirmText, setDeleteConfirmText] = useState('');
      const [managingParents, setManagingParents] = useState(null);

      const [formData, setFormData] = useState({
        name: '', birthdate: '', grade: '', phone: '', photo: null
      });

      // Get all campers
      const getAllCampers = () => {
        // All campers from the campers collection with their linked parents and registrations
        return campers.map(c => ({
          ...c,
          parents: camperParentLinks
            .filter(link => link.camperId === c.id)
            .map(link => users.find(u => u.email === link.parentEmail))
            .filter(Boolean),
          registrations: registrations.filter(r => r.camperId === c.id || r.childId === c.id)
        }));
      };

      const allCampers = getAllCampers();

      const filteredCampers = allCampers.filter(c =>
        c.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        c.parents?.some(p => p?.name?.toLowerCase().includes(searchTerm.toLowerCase()))
      );

      const sortedCampers = [...filteredCampers].sort((a, b) => {
        switch (sortBy) {
          case 'name': return (a.name || '').localeCompare(b.name || '');
          case 'age': return (a.birthdate || '').localeCompare(b.birthdate || '');
          case 'grade': return (a.grade || '').localeCompare(b.grade || '');
          case 'registrations': return b.registrations.length - a.registrations.length;
          default: return 0;
        }
      });

      const getAge = (birthdate) => {
        if (!birthdate) return null;
        const today = new Date();
        const birth = new Date(birthdate);
        let age = today.getFullYear() - birth.getFullYear();
        const m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
        return age;
      };

      const resetForm = () => {
        setFormData({ name: '', birthdate: '', grade: '', phone: '', photo: null });
        setShowAddForm(false);
        setEditingCamper(null);
      };

      const handleSave = () => {
        if (!formData.name) {
          showToast('Name is required', 'error');
          return;
        }

        if (editingCamper) {
          // Update existing camper
          if (editingCamper.isStandalone) {
            const updated = campers.map(c => c.id === editingCamper.id ? { ...c, ...formData } : c);
            onSaveCampers(updated, `Updated camper ${formData.name}`);
          } else {
            // Legacy camper - migrate to standalone
            const newCamper = { id: editingCamper.id, ...formData, createdAt: new Date().toISOString() };
            onSaveCampers([...campers, newCamper], `Migrated and updated camper ${formData.name}`);
            // Add link to original parent
            if (editingCamper.parentEmail) {
              onSaveLinks([...camperParentLinks, { camperId: editingCamper.id, parentEmail: editingCamper.parentEmail }]);
            }
          }
        } else {
          // Add new camper
          const newCamper = {
            id: 'camper_' + Date.now(),
            ...formData,
            createdAt: new Date().toISOString()
          };
          onSaveCampers([...campers, newCamper], `Added camper ${formData.name}`);
        }
        resetForm();
        showToast(editingCamper ? 'Camper updated!' : 'Camper added!');
      };

      const handleDelete = async () => {
        if (deleteConfirmText !== 'DELETE') {
          showToast('Please type DELETE to confirm', 'error');
          return;
        }
        const camper = confirmDelete;
        if (onDeleteCamper) {
          await onDeleteCamper(camper.id, camper.name);
        } else if (camper.isStandalone) {
          onSaveCampers(campers.filter(c => c.id !== camper.id), `Deleted camper ${camper.name}`);
          onSaveLinks(camperParentLinks.filter(l => l.camperId !== camper.id));
          showToast('Camper deleted');
        }
        setConfirmDelete(null);
        setDeleteConfirmText('');
      };

      const startEdit = (camper) => {
        setFormData({
          name: camper.name || '',
          birthdate: camper.birthdate || '',
          grade: camper.grade || '',
          phone: camper.phone || '',
          photo: camper.photo || null
        });
        setEditingCamper(camper);
        setShowAddForm(true);
      };

      const toggleParentLink = (camperId, parentEmail) => {
        const exists = camperParentLinks.some(l => l.camperId === camperId && l.parentEmail === parentEmail);
        if (exists) {
          onSaveLinks(camperParentLinks.filter(l => !(l.camperId === camperId && l.parentEmail === parentEmail)));
        } else {
          onSaveLinks([...camperParentLinks, { camperId, parentEmail }]);
        }
      };

      const getCamperParents = (camperId) => {
        return camperParentLinks
          .filter(l => l.camperId === camperId)
          .map(l => users.find(u => u.email === l.parentEmail))
          .filter(Boolean);
      };

      return (
        <div className="space-y-6">
          <div className="bg-white rounded-xl shadow p-6">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
              <div>
                <h3 className="font-bold text-xl text-green-800">üèÄ Campers</h3>
                <p className="text-sm text-gray-500">{allCampers.length} campers registered</p>
              </div>
              <div className="flex gap-2 items-center">
                <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="px-3 py-2 border rounded-lg">
                  <option value="name">Sort by Name</option>
                  <option value="age">Sort by Age</option>
                  <option value="grade">Sort by Grade</option>
                  <option value="registrations">Sort by Registrations</option>
                </select>
                <button onClick={() => setShowAddForm(true)} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                  + Add Camper
                </button>
              </div>
            </div>

            <div className="mb-4">
              <input
                value={searchTerm}
                onChange={e => setSearchTerm(e.target.value)}
                placeholder="Search campers or parents..."
                className="w-full px-4 py-2 border rounded-lg"
                autoComplete="off"
                data-1p-ignore="true"
              />
            </div>

            {sortedCampers.length === 0 ? (
              <div className="text-center py-12 text-gray-500">
                <p className="text-4xl mb-4">üèÄ</p>
                <p>{allCampers.length === 0 ? 'No campers yet. Campers are added when parents complete onboarding.' : 'No campers match your search'}</p>
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="text-left text-sm text-gray-600 border-b">
                      <th className="p-3">Photo</th>
                      <th className="p-3">Name</th>
                      <th className="p-3">Age</th>
                      <th className="p-3">Grade</th>
                      <th className="p-3">Parents</th>
                      <th className="p-3">Registrations</th>
                      <th className="p-3">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {sortedCampers.map(camper => (
                      <tr key={camper.id} className="border-b hover:bg-gray-50">
                        <td className="p-3">
                          {camper.photo ? (
                            <img src={camper.photo} alt={camper.name} className="w-10 h-10 rounded-full object-cover" />
                          ) : (
                            <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-400">
                              <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                              </svg>
                            </div>
                          )}
                        </td>
                        <td className="p-3 font-medium">{camper.name}</td>
                        <td className="p-3">{getAge(camper.birthdate) ? `${getAge(camper.birthdate)} yrs` : '-'}</td>
                        <td className="p-3">{camper.grade || '-'}</td>
                        <td className="p-3">
                          {camper.parents?.length > 0 ? (
                            <div className="space-y-1">
                              {camper.parents.map(p => (
                                <div key={p?.email} className="text-sm">
                                  <span className="font-medium">{p?.name}</span>
                                  <span className="text-gray-400 ml-1 text-xs">{p?.email}</span>
                                </div>
                              ))}
                            </div>
                          ) : (
                            <span className="text-gray-400 text-sm">No parents linked</span>
                          )}
                        </td>
                        <td className="p-3">
                          <div className="space-y-1">
                            {(() => {
                              const approved = camper.registrations.filter(r => r.status === 'approved').length;
                              const pending = camper.registrations.filter(r => r.status === 'pending').length;
                              return (
                                <>
                                  {approved > 0 && (
                                    <span className="px-2 py-1 rounded text-sm bg-green-100 text-green-700 inline-block">
                                      {approved} approved
                                    </span>
                                  )}
                                  {pending > 0 && (
                                    <span className="px-2 py-1 rounded text-sm bg-yellow-100 text-yellow-700 inline-block ml-1">
                                      {pending} pending
                                    </span>
                                  )}
                                  {approved === 0 && pending === 0 && (
                                    <span className="px-2 py-1 rounded text-sm bg-gray-100 text-gray-500 inline-block">
                                      No registrations
                                    </span>
                                  )}
                                </>
                              );
                            })()}
                          </div>
                        </td>
                        <td className="p-3">
                          <div className="flex gap-2">
                            <button onClick={() => startEdit(camper)} className="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-sm">
                              Edit
                            </button>
                            <button onClick={() => setConfirmDelete(camper)} className="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm">
                              Delete
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          {/* Summary Stats */}
          <div className="grid md:grid-cols-4 gap-4">
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-3xl font-bold text-green-600">{allCampers.length}</div>
              <div className="text-gray-600">Total Campers</div>
            </div>
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-3xl font-bold text-green-600">
                {allCampers.reduce((sum, c) => sum + c.registrations.filter(r => r.status === 'approved').length, 0)}
              </div>
              <div className="text-gray-600">Approved Registrations</div>
            </div>
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-3xl font-bold text-yellow-600">
                {allCampers.reduce((sum, c) => sum + c.registrations.filter(r => r.status === 'pending').length, 0)}
              </div>
              <div className="text-gray-600">Pending Registrations</div>
            </div>
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-3xl font-bold text-purple-600">{users.length}</div>
              <div className="text-gray-600">Parent Accounts</div>
            </div>
          </div>

          {/* Add/Edit Camper Modal */}
          {showAddForm && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                <h3 className="font-bold text-xl mb-4">{editingCamper ? 'Edit Camper' : 'Add New Camper'}</h3>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Name *</label>
                    <input
                      value={formData.name}
                      onChange={e => setFormData({ ...formData, name: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg"
                      placeholder="Camper's full name"
                      autoComplete="off"
                      data-1p-ignore="true"
                    />
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Birthdate</label>
                    <input
                      type="date"
                      value={formData.birthdate}
                      onChange={e => setFormData({ ...formData, birthdate: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg"
                    />
                    {formData.birthdate && (
                      <p className="text-sm text-gray-500 mt-1">Age: {getAge(formData.birthdate)} years old</p>
                    )}
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Grade (Fall 2026)</label>
                    <select
                      value={formData.grade}
                      onChange={e => setFormData({ ...formData, grade: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg"
                    >
                      <option value="">Select grade...</option>
                      <option value="3rd">3rd Grade</option>
                      <option value="4th">4th Grade</option>
                      <option value="5th">5th Grade</option>
                      <option value="6th">6th Grade</option>
                      <option value="7th">7th Grade</option>
                      <option value="8th">8th Grade</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Phone (optional)</label>
                    <input
                      value={formData.phone}
                      onChange={e => setFormData({ ...formData, phone: formatPhone(e.target.value) })}
                      className="w-full px-3 py-2 border rounded-lg"
                      placeholder="(555) 555-5555"
                      autoComplete="off"
                      data-1p-ignore="true"
                    />
                  </div>
                </div>
                <div className="flex gap-3 mt-6">
                  <button onClick={resetForm} className="flex-1 px-4 py-2 border rounded-lg">Cancel</button>
                  <button onClick={handleSave} className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    {editingCamper ? 'Save Changes' : 'Add Camper'}
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Delete Confirmation Modal */}
          {confirmDelete && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-md w-full p-6 text-center" onClick={e => e.stopPropagation()}>
                <div className="text-5xl mb-4">‚ö†Ô∏è</div>
                <h3 className="font-bold text-xl text-red-600 mb-2">Delete Camper</h3>
                <p className="text-gray-600 mb-4">
                  Are you sure you want to delete <strong>{confirmDelete.name}</strong>?
                  <br />This will also remove all their registrations.
                </p>
                <p className="text-sm text-gray-500 mb-2">Type DELETE to confirm:</p>
                <input
                  value={deleteConfirmText}
                  onChange={e => setDeleteConfirmText(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg text-center font-mono mb-4"
                  placeholder="DELETE"
                  autoComplete="off"
                  data-1p-ignore="true"
                />
                <div className="flex gap-3">
                  <button onClick={() => { setConfirmDelete(null); setDeleteConfirmText(''); }} className="flex-1 px-4 py-2 border rounded-lg">Cancel</button>
                  <button onClick={handleDelete} disabled={deleteConfirmText !== 'DELETE'} className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-300">
                    Delete Camper
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Manage Parents Modal */}
          {managingParents && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                <h3 className="font-bold text-xl mb-2">Manage Parents for {managingParents.name}</h3>
                <p className="text-sm text-gray-500 mb-4">Select which parents are associated with this camper. A camper can have multiple parents.</p>

                {users.length === 0 ? (
                  <p className="text-gray-500 text-center py-8">No parent accounts exist yet.</p>
                ) : (
                  <div className="space-y-2 mb-4">
                    {users.map(parent => {
                      const isLinked = managingParents.isStandalone
                        ? camperParentLinks.some(l => l.camperId === managingParents.id && l.parentEmail === parent.email)
                        : managingParents.parentEmail === parent.email;
                      return (
                        <label key={parent.email} className={`flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 ${isLinked ? 'border-green-500 bg-green-50' : ''}`}>
                          <input
                            type="checkbox"
                            checked={isLinked}
                            onChange={() => {
                              if (managingParents.isStandalone) {
                                toggleParentLink(managingParents.id, parent.email);
                              } else {
                                showToast('Migrate camper to standalone first by editing', 'error');
                              }
                            }}
                            className="w-5 h-5"
                            disabled={!managingParents.isStandalone}
                          />
                          <div>
                            <div className="font-medium">{parent.name}</div>
                            <div className="text-sm text-gray-500">{parent.email}</div>
                          </div>
                        </label>
                      );
                    })}
                  </div>
                )}

                {!managingParents.isStandalone && (
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4 text-sm text-yellow-800">
                    ‚ö†Ô∏è This is a legacy camper. Edit and save to enable multi-parent support.
                  </div>
                )}

                <button onClick={() => setManagingParents(null)} className="w-full px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">
                  Done
                </button>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ==================== ASSIGNMENTS TAB ====================
    const AssignmentsTab = ({ registrations, counselors, users, assignments, availability, onSaveAssignments, showToast, selectedMonth, setSelectedMonth }) => {
      const [selectedDate, setSelectedDate] = useState(null);
      const [selectedSession, setSelectedSession] = useState('morning');
      const [draggedItem, setDraggedItem] = useState(null); // { type: 'camper' | 'counselor', data: ... }
      const [sessionPods, setSessionPods] = useState({}); // { 'date_session': [{ id, counselorId, camperIds }] }

      // Get months that have camp dates
      const getMonths = () => {
        const months = [];
        CAMP_DATES.forEach(date => {
          const d = new Date(date + 'T12:00:00');
          const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
          if (!months.some(m => m.key === monthKey)) {
            months.push({
              key: monthKey,
              name: d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
              year: d.getFullYear(),
              month: d.getMonth()
            });
          }
        });
        return months;
      };

      const months = getMonths();

      // Initialize selected month if not set
      React.useEffect(() => {
        if (!selectedMonth && months.length > 0) {
          setSelectedMonth(months[0].key);
        }
      }, [selectedMonth, months, setSelectedMonth]);

      // Get dates for selected month
      const getMonthDates = () => {
        if (!selectedMonth) return [];
        const [year, month] = selectedMonth.split('-').map(Number);
        return CAMP_DATES.filter(date => {
          const d = new Date(date + 'T12:00:00');
          return d.getFullYear() === year && d.getMonth() === month - 1;
        });
      };

      const monthDates = getMonthDates();

      // Get session key
      const getSessionKey = () => selectedDate ? `${selectedDate}_${selectedSession}` : '';

      // Get or initialize pods for current session
      const getCurrentPods = () => {
        const key = getSessionKey();
        if (!key) return [];

        // If we have pods stored, use them
        if (sessionPods[key]) return sessionPods[key];

        // Otherwise, initialize from existing assignments
        const existingAssignments = assignments[key] || {};
        const pods = Object.entries(existingAssignments).map(([counselorId, camperIds]) => ({
          id: 'pod_' + counselorId,
          counselorId,
          camperIds: camperIds || []
        }));

        // If no existing assignments, start with one empty pod
        if (pods.length === 0) {
          pods.push({ id: 'pod_' + Date.now(), counselorId: null, camperIds: [] });
        }

        return pods;
      };

      // Save pods and sync to assignments
      const savePods = (newPods) => {
        const key = getSessionKey();
        if (!key) return;

        setSessionPods(prev => ({ ...prev, [key]: newPods }));

        // Sync to assignments format
        const newAssignments = { ...assignments };
        newAssignments[key] = {};
        newPods.forEach(pod => {
          if (pod.counselorId && pod.camperIds.length > 0) {
            newAssignments[key][pod.counselorId] = pod.camperIds;
          }
        });
        onSaveAssignments(newAssignments, 'Updated pod assignments');
      };

      // Add new empty pod
      const addPod = () => {
        const pods = getCurrentPods();
        const newPod = { id: 'pod_' + Date.now(), counselorId: null, camperIds: [] };
        savePods([...pods, newPod]);
        showToast('New pod added');
      };

      // Remove empty pod
      const removePod = (podId) => {
        const pods = getCurrentPods();
        const pod = pods.find(p => p.id === podId);
        if (pod?.counselorId || pod?.camperIds?.length > 0) {
          showToast('Cannot remove pod with assigned counselor or campers', 'error');
          return;
        }
        savePods(pods.filter(p => p.id !== podId));
        showToast('Pod removed');
      };

      // Get approved registrations for the selected date/session
      const getSessionRegs = () => {
        if (!selectedDate) return [];
        return registrations.filter(r =>
          r.date === selectedDate &&
          r.sessions?.includes(selectedSession) &&
          r.status === 'approved'
        );
      };

      // Get all assigned camper IDs across all pods
      const getAssignedCamperIds = () => {
        const pods = getCurrentPods();
        return pods.flatMap(p => p.camperIds);
      };

      // Get all assigned counselor IDs across all pods
      const getAssignedCounselorIds = () => {
        const pods = getCurrentPods();
        return pods.map(p => p.counselorId).filter(Boolean);
      };

      // Get unassigned campers
      const getUnassignedCampers = () => {
        const assigned = getAssignedCamperIds();
        return getSessionRegs().filter(r => !assigned.includes(r.childId) && !assigned.includes(r.camperId));
      };

      // Check if counselor is eligible (marked available for this date/session)
      const isCounselorEligible = (counselor) => {
        if (!selectedDate) return false;
        const counselorAvail = availability[counselor.email];
        if (!counselorAvail) return false;
        const dateAvail = counselorAvail[selectedDate];
        if (!dateAvail) return false;
        // Check both new format and legacy format
        return dateAvail.available?.includes(selectedSession) ||
               (Array.isArray(dateAvail) && dateAvail.includes(selectedSession));
      };

      // Get eligible counselors (marked available for this session, not yet assigned to a pod)
      const getEligibleCounselors = () => {
        const assigned = getAssignedCounselorIds();
        return counselors.filter(c => c.visible && !assigned.includes(c.id) && isCounselorEligible(c));
      };

      // Get not-eligible counselors (NOT marked available for this session, not yet assigned to a pod)
      const getNotEligibleCounselors = () => {
        const assigned = getAssignedCounselorIds();
        return counselors.filter(c => c.visible && !assigned.includes(c.id) && !isCounselorEligible(c));
      };

      // Get all unassigned counselors (for backward compatibility)
      const getUnassignedCounselors = () => {
        const assigned = getAssignedCounselorIds();
        return counselors.filter(c => c.visible && !assigned.includes(c.id));
      };

      // Calculate summary stats
      const getSummary = () => {
        const regs = getSessionRegs();
        const pods = getCurrentPods();
        const assignedCampers = getAssignedCamperIds().length;
        const podsWithCounselors = pods.filter(p => p.counselorId).length;
        const totalCapacity = podsWithCounselors * KIDS_PER_COUNSELOR;

        return {
          totalCampers: regs.length,
          assignedCount: assignedCampers,
          unassignedCount: regs.length - assignedCampers,
          podCount: pods.length,
          podsWithCounselors,
          totalCapacity,
          overCapacity: regs.length > totalCapacity && totalCapacity > 0
        };
      };

      // Handle drag start for campers
      const handleCamperDragStart = (e, camper) => {
        setDraggedItem({ type: 'camper', data: camper });
        e.dataTransfer.effectAllowed = 'move';
      };

      // Handle drag start for counselors
      const handleCounselorDragStart = (e, counselor) => {
        setDraggedItem({ type: 'counselor', data: counselor });
        e.dataTransfer.effectAllowed = 'move';
      };

      // Handle drop on pod's counselor slot
      const handleDropCounselor = (e, podId) => {
        e.preventDefault();
        if (!draggedItem || draggedItem.type !== 'counselor') return;

        const pods = getCurrentPods();
        const counselor = draggedItem.data;

        // Check if counselor is already assigned to another pod
        const existingPod = pods.find(p => p.counselorId === counselor.id);
        if (existingPod && existingPod.id !== podId) {
          // Remove from existing pod
          existingPod.counselorId = null;
        }

        // Assign to new pod
        const targetPod = pods.find(p => p.id === podId);
        if (targetPod) {
          targetPod.counselorId = counselor.id;
        }

        savePods([...pods]);
        setDraggedItem(null);
        showToast(`${counselor.name} assigned to pod`);
      };

      // Handle drop on pod's camper area
      const handleDropCamper = (e, podId, slotIndex) => {
        e.preventDefault();
        if (!draggedItem || draggedItem.type !== 'camper') return;

        const pods = getCurrentPods();
        const camper = draggedItem.data;
        const camperId = camper.childId || camper.camperId;

        const targetPod = pods.find(p => p.id === podId);
        if (!targetPod) return;

        // Check capacity
        if (targetPod.camperIds.length >= KIDS_PER_COUNSELOR && !targetPod.camperIds.includes(camperId)) {
          showToast(`Pod is at capacity (${KIDS_PER_COUNSELOR} campers max)`, 'error');
          setDraggedItem(null);
          return;
        }

        // Remove camper from any existing pod
        pods.forEach(p => {
          p.camperIds = p.camperIds.filter(id => id !== camperId);
        });

        // Add to target pod
        if (!targetPod.camperIds.includes(camperId)) {
          targetPod.camperIds.push(camperId);
        }

        savePods([...pods]);
        setDraggedItem(null);
        showToast('Camper assigned to pod');
      };

      // Handle drop on unassigned area (remove from pod)
      const handleDropUnassigned = (e) => {
        e.preventDefault();
        if (!draggedItem) return;

        const pods = getCurrentPods();

        if (draggedItem.type === 'camper') {
          const camperId = draggedItem.data.childId || draggedItem.data.camperId;
          pods.forEach(p => {
            p.camperIds = p.camperIds.filter(id => id !== camperId);
          });
          savePods([...pods]);
          showToast('Camper removed from pod');
        } else if (draggedItem.type === 'counselor') {
          const counselorId = draggedItem.data.id;
          pods.forEach(p => {
            if (p.counselorId === counselorId) {
              p.counselorId = null;
            }
          });
          savePods([...pods]);
          showToast('Counselor removed from pod');
        }

        setDraggedItem(null);
      };

      // Get camper name from ID
      const getCamperName = (camperId) => {
        const reg = registrations.find(r => r.childId === camperId || r.camperId === camperId);
        return reg?.camperName || reg?.childName || 'Unknown';
      };

      // Get camper info for display
      const getCamperInfo = (camperId) => {
        const reg = registrations.find(r => r.childId === camperId || r.camperId === camperId);
        return reg;
      };

      // Get counselor by ID
      const getCounselor = (counselorId) => counselors.find(c => c.id === counselorId);

      const summary = getSummary();
      const formatDate = (dateStr) => {
        const d = new Date(dateStr + 'T12:00:00');
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return `${days[d.getDay()]}, ${months[d.getMonth()]} ${d.getDate()}`;
      };

      // Helper to get registration count for a date/session
      const getDateSessionStats = (date, session) => {
        const regs = registrations.filter(r =>
          r.date === date &&
          r.sessions?.includes(session) &&
          r.status === 'approved'
        );
        const key = `${date}_${session}`;
        const assigned = Object.values(assignments[key] || {}).flat().length;
        return { registered: regs.length, assigned };
      };

      const getDayName = (date) => {
        const d = new Date(date + 'T12:00:00');
        return d.toLocaleDateString('en-US', { weekday: 'short' });
      };

      const formatDateShort = (date) => {
        const d = new Date(date + 'T12:00:00');
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      };

      const pods = getCurrentPods();

      return (
        <div className="space-y-6">
          {/* Month Selector */}
          <div className="bg-white rounded-xl shadow p-4">
            <div className="flex flex-wrap gap-2 mb-4">
              {months.map(m => (
                <button
                  key={m.key}
                  onClick={() => { setSelectedMonth(m.key); setSelectedDate(null); }}
                  className={`px-4 py-2 rounded-lg text-sm ${
                    selectedMonth === m.key
                      ? 'bg-green-600 text-white'
                      : 'bg-gray-100 hover:bg-gray-200'
                  }`}
                >
                  {m.name}
                </button>
              ))}
            </div>

            <p className="text-sm text-gray-500 mb-4">
              Select a date and session below to manage pod assignments. Drag counselors and campers to build your pods.
            </p>

            {/* Date Grid */}
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
              {monthDates.map(date => {
                const amStats = getDateSessionStats(date, 'morning');
                const pmStats = getDateSessionStats(date, 'afternoon');
                const isAmSelected = selectedDate === date && selectedSession === 'morning';
                const isPmSelected = selectedDate === date && selectedSession === 'afternoon';

                return (
                  <div key={date} className="rounded-lg border-2 border-gray-200 overflow-hidden">
                    {/* Date Header */}
                    <div className="p-2 text-center font-bold bg-gray-100">
                      <div className="text-xs text-gray-600">{getDayName(date)}</div>
                      <div>{formatDateShort(date)}</div>
                    </div>

                    {/* Session Buttons */}
                    <div className="p-2 space-y-2">
                      {/* Morning Session */}
                      <button
                        onClick={() => { setSelectedDate(date); setSelectedSession('morning'); }}
                        className={`w-full p-2 rounded text-left text-sm transition-colors border-2 ${
                          isAmSelected ? 'bg-yellow-100 border-yellow-500' : 'bg-white border-transparent hover:bg-gray-50'
                        }`}
                      >
                        <div className="flex justify-between items-center">
                          <span className="font-medium">‚òÄÔ∏è AM</span>
                          {isAmSelected && <span className="text-yellow-600">‚úì</span>}
                        </div>
                        <div className="text-xs text-gray-500 mt-1">
                          <span title="Registered">üèïÔ∏è {amStats.registered}</span>
                          <span className="mx-1">‚Ä¢</span>
                          <span title="Assigned">üìã {amStats.assigned}</span>
                        </div>
                      </button>

                      {/* Afternoon Session */}
                      <button
                        onClick={() => { setSelectedDate(date); setSelectedSession('afternoon'); }}
                        className={`w-full p-2 rounded text-left text-sm transition-colors border-2 ${
                          isPmSelected ? 'bg-blue-100 border-blue-500' : 'bg-white border-transparent hover:bg-gray-50'
                        }`}
                      >
                        <div className="flex justify-between items-center">
                          <span className="font-medium">üåô PM</span>
                          {isPmSelected && <span className="text-blue-600">‚úì</span>}
                        </div>
                        <div className="text-xs text-gray-500 mt-1">
                          <span title="Registered">üèïÔ∏è {pmStats.registered}</span>
                          <span className="mx-1">‚Ä¢</span>
                          <span title="Assigned">üìã {pmStats.assigned}</span>
                        </div>
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* No date selected message */}
          {!selectedDate && (
            <div className="bg-white rounded-xl shadow p-8 text-center">
              <div className="text-5xl mb-4">üìÖ</div>
              <h3 className="font-bold text-lg text-gray-700 mb-2">Select a Session</h3>
              <p className="text-gray-500">Click on a date and session above to start building pods.</p>
            </div>
          )}

          {/* Selected Session Header */}
          {selectedDate && (
            <div className={`rounded-xl shadow p-4 ${selectedSession === 'morning' ? 'bg-yellow-50 border-2 border-yellow-400' : 'bg-blue-50 border-2 border-blue-400'}`}>
              <h3 className="font-bold text-xl text-center">
                {selectedSession === 'morning' ? '‚òÄÔ∏è' : 'üåô'} {formatDate(selectedDate)} - {selectedSession === 'morning' ? 'Morning' : 'Afternoon'} Session
              </h3>
              <p className="text-center text-sm text-gray-600 mt-1">
                Drag counselors and campers to build pods. Each pod has 1 counselor and up to {KIDS_PER_COUNSELOR} campers.
              </p>
            </div>
          )}

          {/* Summary Stats */}
          {selectedDate && (
          <div className="grid md:grid-cols-4 gap-4">
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-2xl font-bold text-green-600">{summary.totalCampers}</div>
              <div className="text-sm text-gray-600">Registered Campers</div>
            </div>
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-2xl font-bold text-blue-600">{summary.assignedCount}</div>
              <div className="text-sm text-gray-600">Assigned to Pods</div>
            </div>
            <div className={`rounded-xl shadow p-4 text-center ${summary.unassignedCount > 0 ? 'bg-yellow-50' : 'bg-white'}`}>
              <div className={`text-2xl font-bold ${summary.unassignedCount > 0 ? 'text-yellow-600' : 'text-gray-400'}`}>{summary.unassignedCount}</div>
              <div className="text-sm text-gray-600">Unassigned</div>
            </div>
            <div className="bg-white rounded-xl shadow p-4 text-center">
              <div className="text-2xl font-bold text-purple-600">{summary.podCount}</div>
              <div className="text-sm text-gray-600">Pods</div>
            </div>
          </div>
          )}

          {/* Main Assignment Area */}
          {selectedDate && (
          <div className="grid lg:grid-cols-4 gap-6">
            {/* Unassigned Sidebar */}
            <div className="space-y-4">
              {/* Eligible Counselors */}
              <div
                className="bg-white rounded-xl shadow p-4"
                onDragOver={e => e.preventDefault()}
                onDrop={handleDropUnassigned}
              >
                <h4 className="font-bold text-green-700 mb-3 flex items-center gap-2">
                  <span className="w-3 h-3 bg-green-500 rounded-full"></span>
                  Eligible Counselors ({getEligibleCounselors().length})
                </h4>
                <p className="text-xs text-gray-500 mb-2">Available for this session</p>
                <div className="space-y-2 min-h-16">
                  {getEligibleCounselors().length === 0 ? (
                    <div className="text-gray-400 text-sm text-center py-2">
                      {getAssignedCounselorIds().length > 0 ? 'All eligible counselors assigned' : 'No eligible counselors'}
                    </div>
                  ) : (
                    getEligibleCounselors().map(counselor => (
                      <div
                        key={counselor.id}
                        draggable
                        onDragStart={e => handleCounselorDragStart(e, counselor)}
                        className="p-2 bg-green-50 border border-green-200 rounded-lg cursor-move hover:bg-green-100 transition-colors flex items-center gap-2"
                      >
                        {counselor.photo ? (
                          <img src={counselor.photo} alt={counselor.name} className="w-8 h-8 rounded-full object-cover" />
                        ) : (
                          <div className="w-8 h-8 rounded-full bg-green-200 flex items-center justify-center text-green-700 font-bold text-sm">
                            {counselor.name?.charAt(0)}
                          </div>
                        )}
                        <div className="font-medium text-sm">{counselor.name}</div>
                      </div>
                    ))
                  )}
                </div>
              </div>

              {/* Not Eligible Counselors */}
              {getNotEligibleCounselors().length > 0 && (
                <div
                  className="bg-white rounded-xl shadow p-4"
                  onDragOver={e => e.preventDefault()}
                  onDrop={handleDropUnassigned}
                >
                  <h4 className="font-bold text-gray-500 mb-3 flex items-center gap-2">
                    <span className="w-3 h-3 bg-gray-400 rounded-full"></span>
                    Not Eligible ({getNotEligibleCounselors().length})
                  </h4>
                  <p className="text-xs text-gray-500 mb-2">Not available for this session</p>
                  <div className="space-y-2">
                    {getNotEligibleCounselors().map(counselor => (
                      <div
                        key={counselor.id}
                        draggable
                        onDragStart={e => handleCounselorDragStart(e, counselor)}
                        className="p-2 bg-gray-50 border border-gray-200 rounded-lg cursor-move hover:bg-gray-100 transition-colors flex items-center gap-2 opacity-60"
                      >
                        {counselor.photo ? (
                          <img src={counselor.photo} alt={counselor.name} className="w-8 h-8 rounded-full object-cover grayscale" />
                        ) : (
                          <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-bold text-sm">
                            {counselor.name?.charAt(0)}
                          </div>
                        )}
                        <div className="font-medium text-sm text-gray-500">{counselor.name}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Registered Campers to Assign */}
              <div
                className="bg-white rounded-xl shadow p-4"
                onDragOver={e => e.preventDefault()}
                onDrop={handleDropUnassigned}
              >
                <h4 className="font-bold text-yellow-700 mb-3 flex items-center gap-2">
                  <span className="w-3 h-3 bg-yellow-500 rounded-full"></span>
                  Campers to Assign ({getUnassignedCampers().length})
                </h4>
                <p className="text-xs text-gray-500 mb-2">Registered for this session</p>
                <div className="space-y-2 min-h-32 max-h-96 overflow-y-auto">
                  {getUnassignedCampers().length === 0 ? (
                    <div className="text-gray-400 text-sm text-center py-4">
                      {getSessionRegs().length === 0 ? 'No registrations for this session' : 'All campers assigned! üéâ'}
                    </div>
                  ) : (
                    getUnassignedCampers().map(reg => (
                      <div
                        key={reg.id}
                        draggable
                        onDragStart={e => handleCamperDragStart(e, reg)}
                        className="p-2 bg-yellow-50 border border-yellow-200 rounded-lg cursor-move hover:bg-yellow-100 transition-colors"
                      >
                        <div className="font-medium text-sm">{reg.camperName || reg.childName}</div>
                        <div className="text-xs text-gray-500">{reg.parentName}</div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>

            {/* Pods Grid */}
            <div className="lg:col-span-3">
              <div className="flex items-center justify-between mb-4">
                <h4 className="font-bold text-lg text-green-800">üë• Pods</h4>
                <div className="flex gap-2">
                  <button
                    onClick={addPod}
                    className="px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm flex items-center gap-1"
                  >
                    <span>+</span> Add Pod
                  </button>
                </div>
              </div>

              <div className="grid md:grid-cols-2 xl:grid-cols-3 gap-4">
                {pods.map((pod, podIndex) => {
                  const counselor = pod.counselorId ? getCounselor(pod.counselorId) : null;
                  const camperCount = pod.camperIds.length;
                  const isEmpty = !pod.counselorId && camperCount === 0;

                  return (
                    <div key={pod.id} className="bg-white rounded-xl shadow border-2 border-gray-200 overflow-hidden">
                      {/* Pod Header with Remove Button */}
                      <div className="bg-gray-50 px-3 py-2 flex items-center justify-between border-b">
                        <span className="font-bold text-sm text-gray-600">Pod {podIndex + 1}</span>
                        {isEmpty && pods.length > 1 && (
                          <button
                            onClick={() => removePod(pod.id)}
                            className="text-red-500 hover:text-red-700 text-sm"
                            title="Remove empty pod"
                          >
                            ‚úï
                          </button>
                        )}
                      </div>

                      {/* Counselor Slot (Top) */}
                      <div
                        className={`p-3 border-b-2 border-dashed ${counselor ? 'bg-purple-50 border-purple-200' : 'bg-gray-50 border-gray-300'}`}
                        onDragOver={e => e.preventDefault()}
                        onDrop={e => handleDropCounselor(e, pod.id)}
                      >
                        <div className="text-xs text-gray-500 mb-2 font-medium">COUNSELOR</div>
                        {counselor ? (
                          <div
                            draggable
                            onDragStart={e => handleCounselorDragStart(e, counselor)}
                            className="flex items-center gap-3 p-2 bg-white rounded-lg border border-purple-200 cursor-move hover:bg-purple-50 transition-colors"
                          >
                            {counselor.photo ? (
                              <img src={counselor.photo} alt={counselor.name} className="w-12 h-12 rounded-full object-cover border-2 border-purple-300" />
                            ) : (
                              <div className="w-12 h-12 rounded-full bg-purple-200 flex items-center justify-center text-purple-700 font-bold text-lg border-2 border-purple-300">
                                {counselor.name?.charAt(0)}
                              </div>
                            )}
                            <div>
                              <div className="font-bold">{counselor.name}</div>
                              <div className="text-xs text-gray-500">{counselor.position}</div>
                            </div>
                          </div>
                        ) : (
                          <div className="h-16 flex items-center justify-center text-gray-400 border-2 border-dashed border-gray-300 rounded-lg bg-white">
                            <span className="text-sm">Drop counselor here</span>
                          </div>
                        )}
                      </div>

                      {/* Camper Slots (5 slots below) */}
                      <div
                        className="p-3"
                        onDragOver={e => e.preventDefault()}
                        onDrop={e => handleDropCamper(e, pod.id)}
                      >
                        <div className="text-xs text-gray-500 mb-2 font-medium">CAMPERS ({camperCount}/{KIDS_PER_COUNSELOR})</div>
                        <div className="space-y-2">
                          {[...Array(KIDS_PER_COUNSELOR)].map((_, slotIndex) => {
                            const camperId = pod.camperIds[slotIndex];
                            const camperInfo = camperId ? getCamperInfo(camperId) : null;

                            return (
                              <div
                                key={slotIndex}
                                className={`h-10 rounded-lg border-2 ${
                                  camperId
                                    ? 'bg-green-50 border-green-200'
                                    : 'bg-gray-50 border-dashed border-gray-300'
                                }`}
                                onDragOver={e => e.preventDefault()}
                                onDrop={e => handleDropCamper(e, pod.id, slotIndex)}
                              >
                                {camperId ? (
                                  <div
                                    draggable
                                    onDragStart={e => handleCamperDragStart(e, camperInfo || { childId: camperId, camperId })}
                                    className="h-full flex items-center gap-2 px-2 cursor-move hover:bg-green-100 transition-colors rounded-lg"
                                  >
                                    <div className="w-6 h-6 rounded-full bg-green-200 flex items-center justify-center text-xs text-green-700 font-medium">
                                      {getCamperName(camperId)?.charAt(0)}
                                    </div>
                                    <span className="text-sm font-medium truncate">{getCamperName(camperId)}</span>
                                  </div>
                                ) : (
                                  <div className="h-full flex items-center justify-center text-gray-400 text-xs">
                                    Empty slot
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                      </div>

                      {/* Pod Status Footer */}
                      <div className={`px-3 py-2 text-center text-xs font-medium ${
                        !counselor ? 'bg-gray-100 text-gray-500' :
                        camperCount === 0 ? 'bg-yellow-50 text-yellow-600' :
                        camperCount <= 3 ? 'bg-green-50 text-green-600' :
                        camperCount <= 5 ? 'bg-blue-50 text-blue-600' :
                        'bg-red-50 text-red-600'
                      }`}>
                        {!counselor ? 'Needs counselor' :
                         camperCount === 0 ? 'Ready for campers' :
                         `${camperCount} camper${camperCount !== 1 ? 's' : ''} assigned`}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
          )}

          {/* Quick Actions */}
          {selectedDate && (
          <div className="bg-white rounded-xl shadow p-4">
            <h4 className="font-bold text-gray-700 mb-3">Quick Actions</h4>
            <div className="flex flex-wrap gap-2">
              <button
                onClick={() => {
                  const unassignedCampers = getUnassignedCampers();
                  const unassignedCounselors = getUnassignedCounselors();

                  if (unassignedCampers.length === 0) {
                    showToast('No unassigned campers');
                    return;
                  }

                  let pods = getCurrentPods();
                  let camperIdx = 0;

                  // First, assign unassigned counselors to empty pods
                  for (const counselor of unassignedCounselors) {
                    const emptyPod = pods.find(p => !p.counselorId);
                    if (emptyPod) {
                      emptyPod.counselorId = counselor.id;
                    } else {
                      // Create new pod with this counselor
                      pods.push({ id: 'pod_' + Date.now() + '_' + counselor.id, counselorId: counselor.id, camperIds: [] });
                    }
                  }

                  // Then assign campers to pods with counselors
                  for (const camper of unassignedCampers) {
                    const camperId = camper.childId || camper.camperId;

                    // Find pod with counselor and space
                    const availablePod = pods.find(p => p.counselorId && p.camperIds.length < KIDS_PER_COUNSELOR);
                    if (!availablePod) break;

                    availablePod.camperIds.push(camperId);
                    camperIdx++;
                  }

                  savePods([...pods]);
                  showToast(`Auto-assigned ${camperIdx} campers!`);
                }}
                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
              >
                ‚ú® Auto-Assign All
              </button>
              <button
                onClick={() => {
                  const pods = getCurrentPods().map(p => ({ ...p, camperIds: [], counselorId: null }));
                  // Keep at least one empty pod
                  if (pods.length === 0) {
                    pods.push({ id: 'pod_' + Date.now(), counselorId: null, camperIds: [] });
                  }
                  savePods(pods);
                  showToast('All assignments cleared');
                }}
                className="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200"
              >
                üóëÔ∏è Clear All
              </button>
            </div>
          </div>
          )}
        </div>
      );
    };

    // ==================== PARENT MESSAGES TAB ====================
    const ParentMessagesTab = ({ userEmail, userName, messages, onSendReply, markAsRead, showToast }) => {
      const [replyText, setReplyText] = useState('');
      const [selectedMsg, setSelectedMsg] = useState(null);
      const messagesEndRef = useRef(null);

      // Get messages for this parent (sent to them or to all, or from them)
      const myMessages = messages
        .filter(m => m.to === 'all' || m.to?.includes(userEmail) || m.from === userEmail)
        .sort((a, b) => new Date(b.sentAt) - new Date(a.sentAt));

      const unreadMessages = myMessages.filter(m => m.from !== userEmail && !m.readBy?.includes(userEmail));

      useEffect(() => {
        // Mark messages as read when viewing
        if (selectedMsg && !selectedMsg.readBy?.includes(userEmail)) {
          markAsRead(selectedMsg.id, userEmail);
        }
      }, [selectedMsg]);

      const handleSendReply = () => {
        if (!replyText.trim() || !selectedMsg) return;
        const msg = {
          id: 'msg_' + Date.now(),
          threadId: selectedMsg.threadId || selectedMsg.from === 'admin' ? userEmail : selectedMsg.threadId,
          from: userEmail,
          to: ['admin'],
          subject: selectedMsg.subject ? `Re: ${selectedMsg.subject}` : '',
          body: replyText.trim(),
          sentAt: new Date().toISOString(),
          readBy: [userEmail]
        };
        onSendReply(msg);
        setReplyText('');
        showToast('Reply sent!');
      };

      return (
        <div className="space-y-6">
          {/* Unread Alert */}
          {unreadMessages.length > 0 && (
            <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 flex items-center gap-4">
              <div className="text-3xl">üì¨</div>
              <div>
                <div className="font-bold text-blue-800">You have {unreadMessages.length} unread message{unreadMessages.length > 1 ? 's' : ''}</div>
                <div className="text-sm text-blue-600">Click on a message to read and reply</div>
              </div>
            </div>
          )}

          <div className="grid md:grid-cols-2 gap-6">
            {/* Message List */}
            <div className="bg-white rounded-xl shadow p-6">
              <h3 className="font-bold text-lg text-green-800 mb-4">üí¨ Messages from Camp</h3>
              {myMessages.length === 0 ? (
                <div className="text-center py-8 text-gray-500">
                  <p className="text-4xl mb-2">üì≠</p>
                  <p>No messages yet</p>
                </div>
              ) : (
                <div className="space-y-2 max-h-96 overflow-y-auto">
                  {myMessages.map(msg => {
                    const isUnread = msg.from !== userEmail && !msg.readBy?.includes(userEmail);
                    const isSelected = selectedMsg?.id === msg.id;
                    const isFromMe = msg.from === userEmail;

                    return (
                      <div
                        key={msg.id}
                        onClick={() => setSelectedMsg(msg)}
                        className={`p-3 rounded-lg cursor-pointer transition-colors ${
                          isSelected ? 'bg-green-100 border-2 border-green-500' :
                          isUnread ? 'bg-blue-50 border-2 border-blue-300' :
                          'bg-gray-50 hover:bg-gray-100'
                        }`}
                      >
                        <div className="flex justify-between items-start mb-1">
                          <span className={`text-sm ${isUnread ? 'font-bold text-blue-800' : 'text-gray-600'}`}>
                            {isFromMe ? 'üì§ You' : 'üì• Camp Admin'}
                            {msg.to === 'all' && !isFromMe && <span className="ml-1 text-xs text-purple-600">(Broadcast)</span>}
                          </span>
                          <span className="text-xs text-gray-400">{formatTimestamp(msg.sentAt)}</span>
                        </div>
                        {msg.subject && <div className={`text-sm ${isUnread ? 'font-bold' : 'font-medium'}`}>{msg.subject}</div>}
                        <div className="text-sm text-gray-600 truncate">{msg.body}</div>
                        {isUnread && <span className="inline-block mt-1 px-2 py-0.5 bg-blue-500 text-white text-xs rounded">New</span>}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {/* Message Detail / Reply */}
            <div className="bg-white rounded-xl shadow p-6">
              {!selectedMsg ? (
                <div className="text-center py-12 text-gray-500">
                  <p className="text-4xl mb-2">üëà</p>
                  <p>Select a message to read</p>
                </div>
              ) : (
                <div className="flex flex-col h-full">
                  <div className="mb-4">
                    <div className="flex justify-between items-start mb-2">
                      <span className="font-bold text-lg">
                        {selectedMsg.from === userEmail ? 'üì§ You sent' : 'üì• From Camp Admin'}
                      </span>
                      <span className="text-sm text-gray-500">{formatTimestamp(selectedMsg.sentAt)}</span>
                    </div>
                    {selectedMsg.subject && (
                      <div className="font-medium text-gray-800 mb-2">{selectedMsg.subject}</div>
                    )}
                    {selectedMsg.to === 'all' && selectedMsg.from !== userEmail && (
                      <span className="inline-block px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded mb-2">
                        üì¢ Sent to all parents
                      </span>
                    )}
                  </div>

                  <div className="flex-1 bg-gray-50 rounded-lg p-4 mb-4 whitespace-pre-wrap overflow-y-auto max-h-48">
                    {selectedMsg.body}
                  </div>

                  {/* Reply section - only show for messages from admin */}
                  {selectedMsg.from !== userEmail && (
                    <div className="border-t pt-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Reply:</label>
                      <textarea
                        value={replyText}
                        onChange={e => setReplyText(e.target.value)}
                        className="w-full px-4 py-2 border rounded-lg resize-none"
                        rows={3}
                        placeholder="Type your reply..."
                        autoComplete="off"
                        data-1p-ignore="true"
                      />
                      <button
                        onClick={handleSendReply}
                        disabled={!replyText.trim()}
                        className="mt-2 w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300"
                      >
                        Send Reply
                      </button>
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ==================== VERSION BANNER ====================
    const VersionBanner = ({ isVisible, isDev }) => {
      const [elapsed, setElapsed] = useState('0s');
      const [dbStatus, setDbStatus] = useState('checking');
      const [showNotes, setShowNotes] = useState(false);

      // Format BUILD_DATE as MM-DD-YYYY HH:MM AM/PM
      const formatBuildDate = () => {
        const d = BUILD_DATE;
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const yyyy = d.getFullYear();
        let hours = d.getHours();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12 || 12;
        const min = String(d.getMinutes()).padStart(2, '0');
        return `${mm}-${dd}-${yyyy} ${hours}:${min} ${ampm}`;
      };

      useEffect(() => {
        const update = () => {
          const diff = Math.floor((new Date() - BUILD_DATE) / 1000);
          const h = Math.floor(diff / 3600), m = Math.floor((diff % 3600) / 60), s = diff % 60;
          setElapsed((h > 0 ? h + 'h ' : '') + (m > 0 ? m + 'm ' : '') + s + 's');
        };
        update();
        const i = setInterval(update, 1000);
        supabase.from('camp_content').select('id').limit(1).then(({ error }) => setDbStatus(error ? 'error' : 'connected')).catch(() => setDbStatus('error'));
        return () => clearInterval(i);
      }, []);

      if (!isVisible) return null;

      return (
        <React.Fragment>
          <div className={(isDev ? 'bg-red-600' : 'bg-green-600') + ' text-white text-center py-2 text-sm font-mono'}>
            <span className="font-bold">{isDev ? 'DEVELOPMENT' : 'PRODUCTION'}</span>
            <span className="mx-2">‚Ä¢</span>
            <span>v{VERSION}</span>
            <span className="mx-2">‚Ä¢</span>
            <span>{dbStatus === 'connected' ? '‚úì DB (' + SCHEMA + ')' : dbStatus === 'checking' ? '‚è≥...' : '‚úó DB Error'}</span>
            <span className="mx-2">‚Ä¢</span>
            <span>Built: {formatBuildDate()} ({elapsed} ago)</span>
            <span className="mx-2">‚Ä¢</span>
            <button onClick={() => setShowNotes(true)} className="underline">Notes</button>
          </div>
          {showNotes && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={() => setShowNotes(false)}>
              <div className="bg-white rounded-xl max-w-lg w-full max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                <div className="p-6 pb-2">
                  <h2 className="font-bold text-xl">Release Notes</h2>
                </div>
                <div className="flex-1 overflow-y-auto px-6 pb-2">
                  {RELEASE_NOTES.map((r, i) => (
                    <div key={r.version} className={i > 0 ? 'mt-3 pt-3 border-t' : ''}>
                      <div className="font-mono text-green-700">v{r.version} <span className="text-gray-400 text-sm">{r.date}</span>{r.author && <span className="text-blue-600 text-sm ml-2">by {r.author}</span>}</div>
                      <ul className="text-sm text-gray-600 mt-1">{r.changes.map((c, j) => <li key={j}>‚Ä¢ {c}</li>)}</ul>
                    </div>
                  ))}
                </div>
                <div className="p-6 pt-2">
                  <button onClick={() => setShowNotes(false)} className="w-full py-2 bg-green-600 text-white rounded-lg">Close</button>
                </div>
              </div>
            </div>
          )}
        </React.Fragment>
      );
    };

    // ==================== UI COMPONENTS ====================
    const Toast = ({ message, type, onDone }) => {
      useEffect(() => {
        const t = setTimeout(onDone, 3000);
        return () => clearTimeout(t);
      }, []);
      return <div className={'fixed top-16 left-1/2 -translate-x-1/2 z-50 px-6 py-3 rounded-lg shadow-lg text-white ' + (type === 'error' ? 'bg-red-500' : 'bg-green-600')}>{message}</div>;
    };

    const Modal = ({ isOpen, onClose, title, children }) => {
      const mouseDownTarget = useRef(null);

      if (!isOpen) return null;

      const handleMouseDown = (e) => {
        mouseDownTarget.current = e.target;
      };

      const handleClick = (e) => {
        // Only close if both mousedown and click happened on the backdrop itself
        if (e.target === e.currentTarget && mouseDownTarget.current === e.currentTarget) {
          onClose();
        }
        mouseDownTarget.current = null;
      };

      return (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onMouseDown={handleMouseDown} onClick={handleClick}>
          <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div className="bg-green-800 text-white px-6 py-4 flex justify-between items-center">
              <h2 className="font-display text-2xl">{title}</h2>
              <button onClick={onClose} className="text-2xl hover:bg-green-700 rounded px-2">√ó</button>
            </div>
            <div className="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">{children}</div>
          </div>
        </div>
      );
    };

    // ==================== SCROLLABLE TABS ====================
    const ScrollableTabs = ({ children, className = '' }) => {
      const containerRef = useRef(null);
      const [canScrollLeft, setCanScrollLeft] = useState(false);
      const [canScrollRight, setCanScrollRight] = useState(false);
      const [isDragging, setIsDragging] = useState(false);
      const [startX, setStartX] = useState(0);
      const [scrollLeft, setScrollLeft] = useState(0);

      const checkScroll = () => {
        const el = containerRef.current;
        if (!el) return;
        setCanScrollLeft(el.scrollLeft > 0);
        setCanScrollRight(el.scrollLeft < el.scrollWidth - el.clientWidth - 1);
      };

      useEffect(() => {
        checkScroll();
        window.addEventListener('resize', checkScroll);
        return () => window.removeEventListener('resize', checkScroll);
      }, [children]);

      const onMouseDown = (e) => {
        setIsDragging(true);
        setStartX(e.pageX - containerRef.current.offsetLeft);
        setScrollLeft(containerRef.current.scrollLeft);
      };

      const onMouseMove = (e) => {
        if (!isDragging) return;
        e.preventDefault();
        const x = e.pageX - containerRef.current.offsetLeft;
        const walk = (x - startX) * 1.5;
        containerRef.current.scrollLeft = scrollLeft - walk;
      };

      const onMouseUp = () => setIsDragging(false);
      const onMouseLeave = () => setIsDragging(false);

      // Touch support
      const onTouchStart = (e) => {
        setIsDragging(true);
        setStartX(e.touches[0].pageX - containerRef.current.offsetLeft);
        setScrollLeft(containerRef.current.scrollLeft);
      };

      const onTouchMove = (e) => {
        if (!isDragging) return;
        const x = e.touches[0].pageX - containerRef.current.offsetLeft;
        const walk = (x - startX) * 1.5;
        containerRef.current.scrollLeft = scrollLeft - walk;
      };

      const onTouchEnd = () => setIsDragging(false);

      return (
        <div className="relative">
          {/* Left fade indicator */}
          {canScrollLeft && (
            <div className="absolute left-0 top-0 bottom-0 w-8 bg-gradient-to-r from-white to-transparent z-10 pointer-events-none flex items-center">
              <span className="text-gray-400 text-lg ml-1">‚Äπ</span>
            </div>
          )}

          {/* Scrollable container */}
          <div
            ref={containerRef}
            className={`flex gap-1 overflow-x-auto scrollbar-hide ${isDragging ? 'cursor-grabbing' : 'cursor-grab'} ${className}`}
            style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}
            onScroll={checkScroll}
            onMouseDown={onMouseDown}
            onMouseMove={onMouseMove}
            onMouseUp={onMouseUp}
            onMouseLeave={onMouseLeave}
            onTouchStart={onTouchStart}
            onTouchMove={onTouchMove}
            onTouchEnd={onTouchEnd}
          >
            {children}
          </div>

          {/* Right fade indicator */}
          {canScrollRight && (
            <div className="absolute right-0 top-0 bottom-0 w-8 bg-gradient-to-l from-white to-transparent z-10 pointer-events-none flex items-center justify-end">
              <span className="text-gray-400 text-lg mr-1">‚Ä∫</span>
            </div>
          )}
        </div>
      );
    };

    // shape: 'circle' | 'square' | 'rectangle'
    // aspectRatio: only used for rectangle (width/height ratio, e.g. 16/9)
    // initialTransform: optional { zoom, posX, posY, rotation } to restore previous editing state
    const ImageCropper = ({ image, onSave, onCancel, shape = 'circle', aspectRatio = 1, initialTransform = null }) => {
      const canvasRef = useRef(null);
      const [zoom, setZoom] = useState(initialTransform?.zoom ?? 1);
      const [pos, setPos] = useState({ x: initialTransform?.posX ?? 0, y: initialTransform?.posY ?? 0 });
      const [rotation, setRotation] = useState(initialTransform?.rotation ?? 0);
      const [dragging, setDragging] = useState(false);
      const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
      const [img, setImg] = useState(null);

      // Canvas dimensions - high resolution for export, displayed smaller via CSS
      const exportW = shape === 'rectangle' ? 1200 : 400;
      const exportH = shape === 'rectangle' ? Math.round(1200 / aspectRatio) : 400;
      const displayW = shape === 'rectangle' ? 300 : 250;
      const displayH = shape === 'rectangle' ? Math.round(300 / aspectRatio) : 250;
      const canvasW = exportW;
      const canvasH = exportH;

      useEffect(() => {
        const i = new Image();
        i.onload = () => setImg(i);
        i.src = image;
      }, [image]);

      useEffect(() => {
        if (!img || !canvasRef.current) return;
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        canvas.width = canvasW;
        canvas.height = canvasH;
        ctx.clearRect(0, 0, canvasW, canvasH);
        ctx.save();

        // Clip based on shape (with rounded corners for square to match website)
        ctx.beginPath();
        if (shape === 'circle') {
          ctx.arc(canvasW / 2, canvasH / 2, Math.min(canvasW, canvasH) / 2, 0, Math.PI * 2);
        } else {
          // Rounded rectangle (12px radius to match rounded-xl)
          const radius = 12;
          ctx.moveTo(radius, 0);
          ctx.lineTo(canvasW - radius, 0);
          ctx.quadraticCurveTo(canvasW, 0, canvasW, radius);
          ctx.lineTo(canvasW, canvasH - radius);
          ctx.quadraticCurveTo(canvasW, canvasH, canvasW - radius, canvasH);
          ctx.lineTo(radius, canvasH);
          ctx.quadraticCurveTo(0, canvasH, 0, canvasH - radius);
          ctx.lineTo(0, radius);
          ctx.quadraticCurveTo(0, 0, radius, 0);
        }
        ctx.clip();

        // Draw image with rotation
        ctx.translate(canvasW / 2, canvasH / 2);
        ctx.rotate((rotation * Math.PI) / 180);
        const scale = zoom * Math.min(canvasW, canvasH) / Math.max(img.width, img.height);
        const w = img.width * scale, h = img.height * scale;
        ctx.drawImage(img, -w / 2 + pos.x, -h / 2 + pos.y, w, h);
        ctx.restore();

        // Draw border
        ctx.beginPath();
        if (shape === 'circle') {
          ctx.arc(canvasW / 2, canvasH / 2, Math.min(canvasW, canvasH) / 2 - 2, 0, Math.PI * 2);
        } else {
          // Rounded rectangle border (matching the clip)
          const radius = 10;
          const offset = 2;
          ctx.moveTo(radius + offset, offset);
          ctx.lineTo(canvasW - radius - offset, offset);
          ctx.quadraticCurveTo(canvasW - offset, offset, canvasW - offset, radius + offset);
          ctx.lineTo(canvasW - offset, canvasH - radius - offset);
          ctx.quadraticCurveTo(canvasW - offset, canvasH - offset, canvasW - radius - offset, canvasH - offset);
          ctx.lineTo(radius + offset, canvasH - offset);
          ctx.quadraticCurveTo(offset, canvasH - offset, offset, canvasH - radius - offset);
          ctx.lineTo(offset, radius + offset);
          ctx.quadraticCurveTo(offset, offset, radius + offset, offset);
        }
        ctx.strokeStyle = '#16a34a';
        ctx.lineWidth = 4;
        ctx.stroke();
      }, [img, zoom, pos, rotation, shape, canvasW, canvasH]);

      // Scale factor for mouse movements (display is smaller than export)
      const scaleFactor = exportW / displayW;
      const onMouseDown = (e) => { setDragging(true); setDragStart({ x: e.clientX - pos.x / scaleFactor, y: e.clientY - pos.y / scaleFactor }); };
      const onMouseMove = (e) => { if (dragging) setPos({ x: (e.clientX - dragStart.x) * scaleFactor, y: (e.clientY - dragStart.y) * scaleFactor }); };
      const onMouseUp = () => setDragging(false);
      const rotate90 = () => setRotation((r) => (r + 90) % 360);

      const containerClass = shape === 'circle' ? 'rounded-full' : 'rounded-xl';

      return (
        <div className="flex flex-col items-center gap-4">
          <p className="text-xs text-gray-500 text-center">Preview exactly as it will appear on the website.<br/>Drag to position, use sliders to zoom & rotate.</p>
          <div
            className={`overflow-hidden cursor-move bg-gray-100 shadow-md ${containerClass}`}
            style={{ width: displayW, height: displayH }}
            onMouseDown={onMouseDown}
            onMouseMove={onMouseMove}
            onMouseUp={onMouseUp}
            onMouseLeave={onMouseUp}
          >
            <canvas ref={canvasRef} style={{ width: displayW, height: displayH }} />
          </div>
          <div className="flex flex-col gap-2 w-64">
            <div className="flex items-center gap-2">
              <span className="text-xs text-gray-500 w-12">Zoom</span>
              <input type="range" min="0.5" max="3" step="0.1" value={zoom} onChange={e => setZoom(parseFloat(e.target.value))} className="flex-1" />
            </div>
            <div className="flex items-center gap-2">
              <span className="text-xs text-gray-500 w-12">Rotate</span>
              <input type="range" min="0" max="360" step="1" value={rotation} onChange={e => setRotation(parseInt(e.target.value))} className="flex-1" />
              <button onClick={rotate90} className="px-2 py-1 bg-gray-200 rounded text-xs" title="Rotate 90¬∞">‚Üª</button>
            </div>
          </div>
          <div className="flex gap-3">
            <button onClick={onCancel} className="px-4 py-2 bg-gray-200 rounded-lg">Cancel</button>
            <button onClick={() => onSave(canvasRef.current.toDataURL('image/jpeg', 0.95), { zoom, posX: pos.x, posY: pos.y, rotation })} className="px-4 py-2 bg-green-600 text-white rounded-lg">Save</button>
          </div>
        </div>
      );
    };

    const ImageUpload = ({ currentImage, onImageChange, label, circular = false }) => {
      const inputRef = useRef(null);
      const [temp, setTemp] = useState(null);
      const [showCrop, setShowCrop] = useState(false);

      const onFile = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => { setTemp(reader.result); setShowCrop(true); };
          reader.readAsDataURL(file);
        }
        e.target.value = '';
      };

      if (showCrop && temp) {
        return <ImageCropper image={temp} onSave={(img) => { onImageChange(img); setShowCrop(false); }} onCancel={() => setShowCrop(false)} />;
      }

      return (
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">{label}</label>
          <div className="flex items-center gap-4">
            {currentImage ? <img src={currentImage} className={'w-20 h-20 object-cover border ' + (circular ? 'rounded-full' : 'rounded-lg')} /> : <div className={'w-20 h-20 bg-gray-100 border-2 border-dashed flex items-center justify-center text-gray-400 text-xs ' + (circular ? 'rounded-full' : 'rounded-lg')}>No image</div>}
            <div className="flex flex-col gap-2">
              <button onClick={() => inputRef.current?.click()} className="px-3 py-1 bg-green-600 text-white rounded text-sm">{currentImage ? 'Change' : 'Upload'}</button>
              {currentImage && <button onClick={() => onImageChange(null)} className="px-3 py-1 bg-red-100 text-red-600 rounded text-sm">Remove</button>}
            </div>
          </div>
          <input ref={inputRef} type="file" accept="image/*" onChange={onFile} className="hidden" />
        </div>
      );
    };

    // ==================== FOOD PHOTOS MANAGER ====================
    const FoodPhotosManager = ({ foodPhotos, getFoodPhoto, onSave }) => {
      const [editingPhoto, setEditingPhoto] = useState(null); // { key, label }
      const [showCropper, setShowCropper] = useState(false);
      const [cropImage, setCropImage] = useState(null);
      const inputRef = useRef(null);

      const FOOD_ITEMS = {
        snacks: [
          { key: 'snack_fruit', label: 'Fresh Fruit' },
          { key: 'snack_granola', label: 'Granola Bars' },
          { key: 'snack_cheese', label: 'Cheese & Crackers' },
          { key: 'snack_veggie', label: 'Veggie Sticks' }
        ],
        drinks: [
          { key: 'drink_water', label: 'Water' },
          { key: 'drink_gatorade', label: 'Gatorade' },
          { key: 'drink_orange', label: 'Orange Juice' },
          { key: 'drink_apple', label: 'Apple Juice' }
        ]
      };

      const handleUploadClick = () => {
        inputRef.current?.click();
      };

      const handleFileSelect = (e) => {
        const file = e.target.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setCropImage(reader.result);
            setShowCropper(true);
          };
          reader.readAsDataURL(file);
        }
        e.target.value = '';
      };

      const handleEditClick = () => {
        setCropImage(getFoodPhoto(editingPhoto.key));
        setShowCropper(true);
      };

      const handleCropSave = (croppedImage) => {
        onSave({ ...foodPhotos, [editingPhoto.key]: croppedImage });
        setShowCropper(false);
        setCropImage(null);
        setEditingPhoto(null);
      };

      const handleDelete = () => {
        const updated = { ...foodPhotos };
        delete updated[editingPhoto.key];
        onSave(updated);
        setEditingPhoto(null);
      };

      const renderPhotoGrid = (items, title, colorClass) => (
        <div className={title === 'Snacks' ? 'mb-6' : ''}>
          <h4 className={`font-medium ${colorClass} mb-3`}>{title}</h4>
          <div className="grid grid-cols-4 gap-4">
            {items.map(item => (
              <div key={item.key} className="text-center">
                <div
                  className="relative group cursor-pointer"
                  onClick={() => setEditingPhoto(item)}
                >
                  <img
                    src={getFoodPhoto(item.key)}
                    alt={item.label}
                    className="w-full aspect-square object-cover rounded-xl mb-1 shadow-sm"
                    onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/150x150/gray/white?text=No+Image'; }}
                  />
                  <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity rounded-xl flex items-center justify-center">
                    <span className="text-white font-medium text-sm">Edit</span>
                  </div>
                  {foodPhotos[item.key] && (
                    <div className="absolute top-1 right-1 w-2 h-2 bg-green-500 rounded-full" title="Custom photo" />
                  )}
                </div>
                <span className="text-xs text-gray-600 block">{item.label}</span>
              </div>
            ))}
          </div>
        </div>
      );

      return (
        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="font-bold mb-4">üçé Snacks & Drinks Photos</h3>
          <p className="text-sm text-gray-600 mb-4">
            Click any photo to edit. Green dot indicates a custom uploaded photo.
          </p>
          {renderPhotoGrid(FOOD_ITEMS.snacks, 'Snacks', 'text-green-700')}
          {renderPhotoGrid(FOOD_ITEMS.drinks, 'Beverages', 'text-blue-700')}

          {/* Photo Edit Modal */}
          {editingPhoto && !showCropper && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-sm w-full overflow-hidden" onClick={e => e.stopPropagation()}>
                <div className="bg-green-600 text-white px-6 py-4 flex justify-between items-center">
                  <h2 className="font-display text-lg">Edit: {editingPhoto.label}</h2>
                  <button onClick={() => setEditingPhoto(null)} className="text-2xl hover:bg-green-500 rounded px-2">√ó</button>
                </div>
                <div className="p-6">
                  <div className="mb-4">
                    <p className="text-xs text-gray-500 mb-2 text-center">Preview (exactly as shown on website)</p>
                    <img
                      src={getFoodPhoto(editingPhoto.key)}
                      alt={editingPhoto.label}
                      className="w-full aspect-square object-cover rounded-xl shadow-md"
                      onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/300x300/gray/white?text=No+Image'; }}
                    />
                  </div>
                  <div className="space-y-2">
                    <button
                      onClick={handleUploadClick}
                      className="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"
                    >
                      üì∑ Upload New Photo
                    </button>
                    <button
                      onClick={handleEditClick}
                      className="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center gap-2"
                    >
                      ‚úÇÔ∏è Adjust Position, Zoom & Rotate
                    </button>
                    {foodPhotos[editingPhoto.key] && (
                      <button
                        onClick={handleDelete}
                        className="w-full py-3 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 flex items-center justify-center gap-2"
                      >
                        üóëÔ∏è Reset to Default
                      </button>
                    )}
                    <button
                      onClick={() => setEditingPhoto(null)}
                      className="w-full py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
              <input
                ref={inputRef}
                type="file"
                accept="image/*"
                className="hidden"
                onChange={handleFileSelect}
              />
            </div>
          )}

          {/* Image Cropper Modal */}
          {showCropper && cropImage && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-md w-full overflow-hidden" onClick={e => e.stopPropagation()}>
                <div className="bg-green-600 text-white px-6 py-4 flex justify-between items-center">
                  <h2 className="font-display text-lg">Adjust: {editingPhoto.label}</h2>
                  <button onClick={() => { setShowCropper(false); setCropImage(null); }} className="text-2xl hover:bg-green-500 rounded px-2">√ó</button>
                </div>
                <div className="p-6">
                  <ImageCropper
                    image={cropImage}
                    shape="square"
                    onSave={handleCropSave}
                    onCancel={() => { setShowCropper(false); setCropImage(null); }}
                  />
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ==================== SITE PHOTOS MANAGER ====================
    const SitePhotosManager = ({ sitePhotos, onSave }) => {
      const [editingPhoto, setEditingPhoto] = useState(null);
      const [showCropper, setShowCropper] = useState(false);
      const [cropImage, setCropImage] = useState(null);
      const [cropTransform, setCropTransform] = useState(null);
      const [isNewUpload, setIsNewUpload] = useState(false);
      const inputRef = useRef(null);

      const SITE_PHOTO_CONFIG = [
        { key: 'hero', label: 'Hero Background', description: 'Large banner image behind the camp title', aspectRatio: 16/9 },
        { key: 'dropoff', label: 'Drop-off Photo', description: 'Camper being dropped off at gym entrance', aspectRatio: 4/3 },
        { key: 'layups', label: 'Skills Training Photo', description: 'Counselor working with kids on layups/drills', aspectRatio: 4/3 },
        { key: 'lunch', label: 'Lunch Photo', description: 'Kids sitting together eating lunch', aspectRatio: 4/3 }
      ];

      // Helper to get cropped image (handles both old string format and new object format)
      const getCroppedImage = (key) => {
        const data = sitePhotos?.[key];
        if (!data) return null;
        return typeof data === 'string' ? data : data.cropped;
      };

      // Helper to get photo data for re-editing
      const getPhotoData = (key) => {
        const data = sitePhotos?.[key];
        if (!data) return null;
        if (typeof data === 'string') return { cropped: data, original: null, transform: null };
        return data;
      };

      const handleFileSelect = (e) => {
        const file = e.target.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setCropImage(reader.result);
            setCropTransform(null);
            setIsNewUpload(true);
            setShowCropper(true);
          };
          reader.readAsDataURL(file);
        }
        if (e.target) e.target.value = '';
      };

      const handleReEdit = () => {
        const photoData = getPhotoData(editingPhoto.key);
        if (photoData?.original) {
          setCropImage(photoData.original);
          setCropTransform(photoData.transform);
        } else {
          setCropImage(photoData?.cropped || getCroppedImage(editingPhoto.key));
          setCropTransform(null);
        }
        setIsNewUpload(false);
        setShowCropper(true);
      };

      const handleCropSave = (croppedImage, transform) => {
        const photoData = {
          cropped: croppedImage,
          original: isNewUpload ? cropImage : (getPhotoData(editingPhoto.key)?.original || cropImage),
          transform: transform
        };
        onSave({ ...sitePhotos, [editingPhoto.key]: photoData }, editingPhoto.label);
        setShowCropper(false);
        setCropImage(null);
        setCropTransform(null);
        setIsNewUpload(false);
        setEditingPhoto(null);
      };

      const handleDelete = () => {
        const updated = { ...sitePhotos };
        delete updated[editingPhoto.key];
        onSave(updated, editingPhoto.label);
        setEditingPhoto(null);
      };

      return (
        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="font-bold text-lg text-green-800 mb-2">üì∏ Site Photos</h3>
          <p className="text-sm text-gray-500 mb-4">Upload photos that appear throughout the website. Photos will be displayed exactly as cropped.</p>

          <div className="grid md:grid-cols-2 gap-6">
            {SITE_PHOTO_CONFIG.map(photo => (
              <div key={photo.key} className="border rounded-xl p-4 hover:border-green-400 transition-colors">
                <div className="flex justify-between items-start mb-2">
                  <div>
                    <h4 className="font-medium text-gray-800">{photo.label}</h4>
                    <p className="text-xs text-gray-500">{photo.description}</p>
                  </div>
                  {getCroppedImage(photo.key) && (
                    <span className="w-3 h-3 bg-green-500 rounded-full" title="Custom photo uploaded" />
                  )}
                </div>

                {getCroppedImage(photo.key) ? (
                  <div
                    className="relative group cursor-pointer rounded-xl overflow-hidden"
                    style={{ aspectRatio: photo.aspectRatio }}
                    onClick={() => setEditingPhoto(photo)}
                  >
                    <img
                      src={getCroppedImage(photo.key)}
                      alt={photo.label}
                      className="w-full h-full object-cover"
                    />
                    <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                      <span className="text-white font-bold text-lg">Edit</span>
                    </div>
                  </div>
                ) : (
                  <div
                    className="bg-gray-100 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-gray-200 transition-colors"
                    style={{ aspectRatio: photo.aspectRatio }}
                    onClick={() => {
                      setEditingPhoto(photo);
                      setTimeout(() => inputRef.current?.click(), 100);
                    }}
                  >
                    <span className="text-4xl mb-2">üì∑</span>
                    <span className="text-sm text-gray-500">Click to upload</span>
                  </div>
                )}
              </div>
            ))}
          </div>

          {/* Edit Modal */}
          {editingPhoto && !showCropper && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-lg w-full overflow-hidden" onClick={e => e.stopPropagation()}>
                <div className="bg-green-600 text-white px-6 py-4 flex justify-between items-center">
                  <h2 className="font-display text-lg">{editingPhoto.label}</h2>
                  <button onClick={() => setEditingPhoto(null)} className="text-2xl hover:bg-green-500 rounded px-2">√ó</button>
                </div>
                <div className="p-6">
                  {getCroppedImage(editingPhoto.key) && (
                    <div className="mb-4">
                      <p className="text-sm text-gray-500 mb-2 font-medium">Preview (exactly as shown on website)</p>
                      <img
                        src={getCroppedImage(editingPhoto.key)}
                        alt={editingPhoto.label}
                        className="w-full object-cover rounded-xl shadow"
                        style={{ aspectRatio: editingPhoto.aspectRatio }}
                      />
                    </div>
                  )}

                  <div className="space-y-3">
                    <button
                      onClick={() => inputRef.current?.click()}
                      className="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium flex items-center justify-center gap-2"
                    >
                      <span>üì§</span> {getCroppedImage(editingPhoto.key) ? 'Upload New Photo' : 'Upload Photo'}
                    </button>

                    {getCroppedImage(editingPhoto.key) && (
                      <>
                        <button
                          onClick={handleReEdit}
                          className="w-full py-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 font-medium flex items-center justify-center gap-2"
                        >
                          <span>‚úÇÔ∏è</span> Adjust Position / Zoom
                        </button>
                        <button
                          onClick={handleDelete}
                          className="w-full py-3 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 font-medium flex items-center justify-center gap-2"
                        >
                          <span>üóëÔ∏è</span> Remove Photo
                        </button>
                      </>
                    )}

                    <button
                      onClick={() => setEditingPhoto(null)}
                      className="w-full py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
              <input
                ref={inputRef}
                type="file"
                accept="image/*"
                className="hidden"
                onChange={handleFileSelect}
              />
            </div>
          )}

          {/* Image Cropper Modal */}
          {showCropper && cropImage && editingPhoto && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-lg w-full overflow-hidden" onClick={e => e.stopPropagation()}>
                <div className="bg-green-600 text-white px-6 py-4 flex justify-between items-center">
                  <h2 className="font-display text-lg">Adjust: {editingPhoto.label}</h2>
                  <button onClick={() => { setShowCropper(false); setCropImage(null); setCropTransform(null); }} className="text-2xl hover:bg-green-500 rounded px-2">√ó</button>
                </div>
                <div className="p-6">
                  <p className="text-sm text-gray-500 mb-4 text-center">The preview below shows exactly how the photo will appear on the website.</p>
                  <ImageCropper
                    image={cropImage}
                    shape="rectangle"
                    aspectRatio={editingPhoto.aspectRatio}
                    initialTransform={cropTransform}
                    onSave={handleCropSave}
                    onCancel={() => { setShowCropper(false); setCropImage(null); setCropTransform(null); }}
                  />
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ==================== MAIN APP ====================
    function RooseveltCamp() {
      const [page, setPage] = useState('home');
      const [user, setUser] = useState(null);
      const [toast, setToast] = useState(null);
      const [loading, setLoading] = useState(true);
      const [showBanner, setShowBanner] = useState(false);
      
      const [content, setContent] = useState(DEFAULT_CONTENT);
      const [counselors, setCounselors] = useState(DEFAULT_COUNSELORS);
      const [registrations, setRegistrations] = useState([]);
      const [users, setUsers] = useState([]);
      const [availability, setAvailability] = useState({});
      const [changeHistory, setChangeHistory] = useState([]);
      const [messages, setMessages] = useState([]);
      const [admins, setAdmins] = useState(DEFAULT_ADMINS);
      const [assignments, setAssignments] = useState({}); // { "date_session": { counselorId: [childId, ...] } }
      const [campers, setCampers] = useState([]); // Standalone campers collection
      const [camperParentLinks, setCamperParentLinks] = useState([]); // { camperId, parentEmail } associations
      const [foodPhotos, setFoodPhotos] = useState({}); // Admin-uploadable food photos { snack_fruit: base64, ... }
      const [sitePhotos, setSitePhotos] = useState({}); // Site-wide photos { hero, dropoff, layups, lunch }

      // New state for onboarding system
      const [emergencyContacts, setEmergencyContacts] = useState([]); // Emergency contact records
      const [onboardingProgress, setOnboardingProgress] = useState({}); // { email: { step, complete, ... } }
      const [pendingCounselors, setPendingCounselors] = useState([]); // Counselors awaiting admin approval
      const [availabilityChangeRequests, setAvailabilityChangeRequests] = useState([]); // Counselor availability change requests
      const [profileChangeRequests, setProfileChangeRequests] = useState([]); // Counselor profile change requests
      const [blockedSessions, setBlockedSessions] = useState({}); // { date: { morning: bool, afternoon: bool } }
      const [counselorSchedule, setCounselorSchedule] = useState({}); // { counselorId: { date: { morning: bool, afternoon: bool } } }

      const [adminTab, setAdminTab] = useState('dashboard');
      const [parentTab, setParentTab] = useState('dashboard');
      const [sessionsTabMonth, setSessionsTabMonth] = useState(null); // Persist selected month in Sessions tab
      const [assignmentsTabMonth, setAssignmentsTabMonth] = useState(null); // Persist selected month in Assignments tab
      const [counselorScheduleModal, setCounselorScheduleModal] = useState(null); // Counselor being scheduled
      const [counselorScheduleMonth, setCounselorScheduleMonth] = useState(null); // Month selected in schedule modal
      const [bulkRegModal, setBulkRegModal] = useState(null); // Bulk registration creation: { parentEmail, camperIds, selectedDates: { date: ['morning','afternoon'] } }
      const [bulkRegMonth, setBulkRegMonth] = useState(null); // Selected month for bulk registration
      const [viewRegModal, setViewRegModal] = useState(null); // Registration details view/edit modal
      const [deleteRegConfirm, setDeleteRegConfirm] = useState(null); // Registration to delete confirmation

      const isDevEnv = isDev();
      const showToast = useCallback((msg, type = 'success') => setToast({ msg, type }), []);
      const sessionCost = getSessionCost(content);

      useEffect(() => {
        const load = async () => {
          setLoading(true);
          try {
            const cd = await storage.get('camp_content');
            if (cd?.[0]?.data) setContent({ ...DEFAULT_CONTENT, ...cd[0].data });
            const cs = await storage.get('camp_counselors');
            if (cs?.length) setCounselors(cs.map(c => c.data).filter(Boolean).sort((a, b) => (a.order || 0) - (b.order || 0)));
            const rg = await storage.get('camp_registrations');
            if (rg?.length) setRegistrations(rg.map(r => r.data).filter(Boolean));
            const us = await storage.get('camp_registered_users');
            if (us?.[0]?.data) setUsers(Array.isArray(us[0].data) ? us[0].data : []);
            const av = await storage.get('camp_counselor_availability');
            if (av?.[0]?.data) setAvailability(av[0].data);
            const ch = await storage.get('camp_change_history');
            if (ch?.[0]?.data) setChangeHistory(Array.isArray(ch[0].data) ? ch[0].data : []);
            const ms = await storage.get('camp_messages');
            if (ms?.length) setMessages(ms.map(m => m.data).filter(Boolean));
            const ad = await storage.get('camp_admins');
            if (ad?.[0]?.data) setAdmins(Array.isArray(ad[0].data) ? ad[0].data : DEFAULT_ADMINS);
            const as = await storage.get('camp_assignments');
            if (as?.[0]?.data) setAssignments(as[0].data);
            const cp = await storage.get('camp_campers');
            if (cp?.[0]?.data) setCampers(Array.isArray(cp[0].data) ? cp[0].data : []);
            const cpl = await storage.get('camp_camper_parent_links');
            if (cpl?.[0]?.data) setCamperParentLinks(Array.isArray(cpl[0].data) ? cpl[0].data : []);
            const fp = await storage.get('camp_food_photos');
            if (fp?.[0]?.data) setFoodPhotos(fp[0].data);
            const sp = await storage.get('camp_site_photos');
            if (sp?.[0]?.data) setSitePhotos(sp[0].data);

            // Load new onboarding system data
            const ec = await storage.get('camp_emergency_contacts');
            if (ec?.[0]?.data) setEmergencyContacts(Array.isArray(ec[0].data) ? ec[0].data : []);
            const op = await storage.get('camp_onboarding_progress');
            if (op?.[0]?.data) setOnboardingProgress(op[0].data || {});
            const acr = await storage.get('camp_availability_change_requests');
            if (acr?.[0]?.data) setAvailabilityChangeRequests(Array.isArray(acr[0].data) ? acr[0].data : []);
            const pcr = await storage.get('camp_profile_change_requests');
            if (pcr?.[0]?.data) setProfileChangeRequests(Array.isArray(pcr[0].data) ? pcr[0].data : []);
            const bs = await storage.get('camp_blocked_sessions');
            if (bs?.[0]?.data) setBlockedSessions(typeof bs[0].data === 'object' && !Array.isArray(bs[0].data) ? bs[0].data : {});
            const csch = await storage.get('camp_counselor_schedule');
            if (csch?.[0]?.data) setCounselorSchedule(typeof csch[0].data === 'object' && !Array.isArray(csch[0].data) ? csch[0].data : {});
          } catch (e) { console.error('Load error:', e); }
          setLoading(false);
        };
        load();
      }, []);

      const addToHistory = useCallback(async (action, details) => {
        const entry = {
          id: Date.now(),
          timestamp: new Date().toISOString(),
          action,
          details
        };
        const newHistory = [entry, ...changeHistory].slice(0, 100);
        setChangeHistory(newHistory);
        await storage.set('camp_change_history', 'main', newHistory);
      }, [changeHistory]);

      const saveContent = async (c, field = null) => {
        setContent(c);
        await storage.set('camp_content', 'main', c);
        if (field) {
          addToHistory('Content Updated', `Changed "${field}"`);
        }
        showToast('Saved!');
      };

      const saveCounselors = async (cs, action = null) => {
        setCounselors(cs);
        for (const c of cs) await storage.set('camp_counselors', c.id, c);
        if (action) addToHistory('Counselor', action);
        showToast('Saved!');
      };

      const deleteCounselor = async (counselorId, counselorName) => {
        // Remove from state
        const updated = counselors.filter(c => c.id !== counselorId).map((c, i) => ({ ...c, order: i }));
        setCounselors(updated);
        // Remove from database
        try {
          await supabase.from('camp_counselors').delete().eq('id', counselorId);
        } catch (e) { console.error('Error deleting counselor:', e); }
        // Clean up assignments that reference this counselor
        const cleanedAssignments = { ...assignments };
        Object.keys(cleanedAssignments).forEach(key => {
          if (cleanedAssignments[key][counselorId]) {
            delete cleanedAssignments[key][counselorId];
          }
        });
        await saveAssignments(cleanedAssignments);
        // Clean up availability
        const cleanedAvail = { ...availability };
        if (cleanedAvail[counselorId]) {
          delete cleanedAvail[counselorId];
          await saveAvail(cleanedAvail);
        }
        addToHistory('Counselor', `Deleted counselor ${counselorName}`);
        showToast('Counselor deleted');
      };

      const saveReg = async (r, action = null) => {
        const newRegs = registrations.some(x => x.id === r.id) ? registrations.map(x => x.id === r.id ? r : x) : [...registrations, r];
        setRegistrations(newRegs);
        await storage.set('camp_registrations', r.id, r);
        if (action) addToHistory('Registration', action);
      };

      const saveUsers = async (u, action = null) => {
        setUsers(u);
        await storage.set('camp_registered_users', 'main', u);
        if (action) addToHistory('Parent', action);
      };

      const deleteParent = async (parentEmail, parentName) => {
        // Remove from users state
        const updatedUsers = users.filter(u => u.email !== parentEmail);
        setUsers(updatedUsers);
        await storage.set('camp_registered_users', 'main', updatedUsers);
        // Remove camper-parent links for this parent
        const updatedLinks = camperParentLinks.filter(l => l.parentEmail !== parentEmail);
        setCamperParentLinks(updatedLinks);
        await storage.set('camp_camper_parent_links', 'main', updatedLinks);
        // Note: We don't delete registrations - they're historical records
        addToHistory('Parent', `Deleted parent ${parentName}`);
        showToast('Parent deleted');
      };
      const saveAvail = async (a) => { setAvailability(a); await storage.set('camp_counselor_availability', 'main', a); };
      const saveAdmins = async (a, action = null) => {
        setAdmins(a);
        await storage.set('camp_admins', 'main', a);
        if (action) addToHistory('Admin', action);
      };
      const saveAssignments = async (a, action = null) => {
        setAssignments(a);
        await storage.set('camp_assignments', 'main', a);
        if (action) addToHistory('Assignment', action);
      };
      const saveCampers = async (c, action = null) => {
        setCampers(c);
        await storage.set('camp_campers', 'main', c);
        if (action) addToHistory('Camper', action);
      };
      const saveFoodPhotos = async (photos) => {
        setFoodPhotos(photos);
        await storage.set('camp_food_photos', 'main', photos);
        addToHistory('Content', 'Updated food photos');
        showToast('Photo updated!');
      };

      const saveSitePhotos = async (photos, photoName = null) => {
        setSitePhotos(photos);
        await storage.set('camp_site_photos', 'main', photos);
        if (photoName) addToHistory('Content', `Updated ${photoName} photo`);
        showToast('Photo updated!');
      };

      const deleteCamper = async (camperId, camperName) => {
        // Remove from campers state
        const updatedCampers = campers.filter(c => c.id !== camperId);
        setCampers(updatedCampers);
        await storage.set('camp_campers', 'main', updatedCampers);
        // Remove camper-parent links
        const updatedLinks = camperParentLinks.filter(l => l.camperId !== camperId);
        setCamperParentLinks(updatedLinks);
        await storage.set('camp_camper_parent_links', 'main', updatedLinks);
        // Clean up assignments that reference this camper
        const cleanedAssignments = { ...assignments };
        Object.keys(cleanedAssignments).forEach(key => {
          Object.keys(cleanedAssignments[key]).forEach(counselorId => {
            cleanedAssignments[key][counselorId] = cleanedAssignments[key][counselorId].filter(id => id !== camperId);
          });
        });
        setAssignments(cleanedAssignments);
        await storage.set('camp_assignments', 'main', cleanedAssignments);
        // Note: We don't delete registrations - they're historical records
        addToHistory('Camper', `Deleted camper ${camperName}`);
        showToast('Camper deleted');
      };

      const saveCamperParentLinks = async (links) => {
        setCamperParentLinks(links);
        await storage.set('camp_camper_parent_links', 'main', links);
      };

      const saveBlockedSessions = async (sessions, action = null) => {
        setBlockedSessions(sessions);
        await storage.set('camp_blocked_sessions', 'main', sessions);
        if (action) addToHistory('Sessions', action);
      };

      const saveCounselorSchedule = async (schedule, action = null) => {
        setCounselorSchedule(schedule);
        await storage.set('camp_counselor_schedule', 'main', schedule);
        if (action) addToHistory('Counselor Schedule', action);
      };

      // Helper to check if a counselor is scheduled to work a session
      const isCounselorScheduled = (counselorId, date, session) => {
        return counselorSchedule[counselorId]?.[date]?.[session] === true;
      };

      // Helper to check if a session is blocked
      const isSessionBlocked = (date, session) => {
        return blockedSessions[date]?.[session] === true;
      };

      // Helper to check if a date is fully blocked (both sessions)
      const isDateFullyBlocked = (date) => {
        return isSessionBlocked(date, 'morning') && isSessionBlocked(date, 'afternoon');
      };

      // Compute available dates (dates where at least one session is available)
      const availableDates = CAMP_DATES.filter(d => !isDateFullyBlocked(d));

      // New save functions for onboarding system
      const saveEmergencyContacts = async (contacts) => {
        setEmergencyContacts(contacts);
        await storage.set('camp_emergency_contacts', 'main', contacts);
      };

      const saveOnboardingProgress = async (progress) => {
        setOnboardingProgress(progress);
        await storage.set('camp_onboarding_progress', 'main', progress);
      };

      const saveAvailabilityChangeRequests = async (requests, action = null) => {
        setAvailabilityChangeRequests(requests);
        await storage.set('camp_availability_change_requests', 'main', requests);
        if (action) addToHistory('Availability', action);
      };

      const saveProfileChangeRequests = async (requests, action = null) => {
        setProfileChangeRequests(requests);
        await storage.set('camp_profile_change_requests', 'main', requests);
        if (action) addToHistory('Profile', action);
      };

      const saveMessage = async (msg) => {
        const newMsgs = [...messages, msg];
        setMessages(newMsgs);
        await storage.set('camp_messages', msg.id, msg);
      };

      const markMessageRead = async (msgId, readerEmail) => {
        const updated = messages.map(m => {
          if (m.id === msgId && !m.readBy?.includes(readerEmail)) {
            return { ...m, readBy: [...(m.readBy || []), readerEmail] };
          }
          return m;
        });
        setMessages(updated);
        const msg = updated.find(m => m.id === msgId);
        if (msg) await storage.set('camp_messages', msg.id, msg);
      };

      const getUnreadCount = (email) => {
        return messages.filter(m =>
          (m.to === 'all' || m.to?.includes(email)) &&
          m.from !== email &&
          !m.readBy?.includes(email)
        ).length;
      };

      const getPending = () => registrations.filter(r => r.status === 'pending').length;
      const getApproved = () => registrations.filter(r => r.status === 'approved').length;
      const getCancelled = () => registrations.filter(r => r.status === 'cancelled' || r.status === 'rejected').length;
      const getUnpaid = () => registrations.filter(r => r.status === 'approved' && r.paymentStatus !== 'paid').length;

      // ==================== NAV ====================
      const Nav = () => (
        <nav className="bg-green-900 text-white shadow-lg">
          <div className="max-w-6xl mx-auto px-3 sm:px-4 py-3 sm:py-3 flex flex-wrap items-center justify-between gap-2">
            <div className="font-display text-xl sm:text-2xl cursor-pointer" onClick={() => { setPage('home'); setUser(null); }} onDoubleClick={() => !isDevEnv && setShowBanner(p => !p)}>üèÄ ROOSEVELT CAMP</div>
            <div className="flex flex-wrap gap-1.5 sm:gap-2 items-center">
              {['home', 'schedule', 'pricing', 'location', 'counselors'].map(p => (
                <button key={p} onClick={() => setPage(p)} className={'px-3 sm:px-4 py-2.5 sm:py-2 rounded text-sm sm:text-base capitalize min-h-[44px] ' + (page === p ? 'bg-green-700' : 'hover:bg-green-800')}>{p}</button>
              ))}
              {user ? (
                <React.Fragment>
                  {user.role === 'admin' ? (
                    <button onClick={() => setPage('admin')} className="text-green-300 text-sm sm:text-base ml-1 sm:ml-2 hover:text-white hover:underline px-3 py-2.5 min-h-[44px]">
                      Admin
                    </button>
                  ) : (
                    <span className="text-green-300 text-sm sm:text-base ml-1 sm:ml-2 hidden sm:inline">{user.name}</span>
                  )}
                  <button onClick={() => { setUser(null); setPage('home'); }} className="px-3 sm:px-4 py-2.5 sm:py-2 bg-red-600 rounded text-sm sm:text-base min-h-[44px]">Logout</button>
                </React.Fragment>
              ) : (
                <button onClick={() => setPage('login')} className={'px-3 sm:px-4 py-2.5 sm:py-2 rounded text-sm sm:text-base min-h-[44px] ' + (page === 'login' ? 'bg-green-700' : 'hover:bg-green-800')}>Login</button>
              )}
            </div>
          </div>
        </nav>
      );

      // ==================== HOME ====================
      // Helper to get cropped image (handles both old string format and new object format)
      const getSitePhoto = (key) => {
        const data = sitePhotos?.[key];
        if (!data) return null;
        return typeof data === 'string' ? data : data.cropped;
      };

      const Home = () => (
        <div className="w-full">
          {/* Hero Section with Large Background Image - Edge to Edge */}
          <div className="relative w-full min-h-[400px] sm:min-h-[500px] md:min-h-[600px] flex items-center justify-center overflow-hidden">
            {/* Background Image or Gradient Fallback */}
            {getSitePhoto('hero') ? (
              <div
                className="absolute inset-0 bg-cover bg-center"
                style={{ backgroundImage: `url(${getSitePhoto('hero')})` }}
              />
            ) : (
              <div className="absolute inset-0 bg-gradient-to-br from-green-800 to-green-900" />
            )}
            {/* Dark Overlay for Text Readability */}
            <div className="absolute inset-0 bg-black/40" />
            {/* Hero Content */}
            <div className="relative z-10 max-w-4xl mx-auto px-4 text-center text-white">
              <h1 className="font-display text-3xl sm:text-5xl md:text-7xl mb-3 sm:mb-4 drop-shadow-lg">{content.heroTitle}</h1>
              <h2 className="font-display text-xl sm:text-3xl md:text-5xl text-green-200 mb-3 sm:mb-4 drop-shadow-md">{content.heroSubtitle}</h2>
              <p className="text-base sm:text-xl md:text-2xl text-green-100 mb-6 sm:mb-8 drop-shadow">{content.heroTagline}</p>
              <button onClick={() => setPage('login')} className="bg-yellow-500 hover:bg-yellow-400 text-green-900 font-bold text-base sm:text-xl px-6 sm:px-8 py-3 sm:py-4 rounded-lg shadow-lg transform hover:scale-105 transition-transform">Register Now ‚Üí</button>
            </div>
          </div>

          {/* Info Cards */}
          <div className="max-w-6xl mx-auto px-4 py-8 sm:py-12 grid sm:grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6">
            <div className="bg-white rounded-xl shadow-lg p-4 sm:p-6 border-t-4 border-green-600">
              <div className="text-3xl sm:text-4xl mb-2">üìÖ</div>
              <h3 className="font-bold text-lg sm:text-xl text-green-800">Camp Dates</h3>
              <p className="text-sm sm:text-base text-gray-700">{content.campDates}</p>
            </div>
            <div className="bg-white rounded-xl shadow-lg p-4 sm:p-6 border-t-4 border-yellow-500">
              <div className="text-3xl sm:text-4xl mb-2">‚è∞</div>
              <h3 className="font-bold text-lg sm:text-xl text-green-800">Sessions</h3>
              <p className="text-sm sm:text-base text-gray-700">AM: {content.sessionMorning}</p>
              <p className="text-sm sm:text-base text-gray-700">PM: {content.sessionAfternoon}</p>
              <p className="text-green-600 font-bold mt-2 text-sm sm:text-base">{content.sessionCost}/session</p>
            </div>
            <div className="bg-white rounded-xl shadow-lg p-4 sm:p-6 border-t-4 border-orange-500">
              <div className="text-3xl sm:text-4xl mb-2">üëß</div>
              <h3 className="font-bold text-lg sm:text-xl text-green-800">Ages</h3>
              <p className="text-sm sm:text-base text-gray-700">{content.ageRange}</p>
            </div>
          </div>

          {/* Counselors Section - Large circular headshots */}
          <div className="bg-green-50 py-8 sm:py-12">
            <div className="max-w-6xl mx-auto px-4">
              <h2 className="font-display text-2xl sm:text-3xl md:text-4xl text-green-800 text-center mb-6 sm:mb-8">Our Counselors</h2>
              <div className="flex flex-wrap justify-center gap-6 sm:gap-8 md:gap-10">
                {counselors.filter(c => c.visible).map(c => (
                  <div key={c.id} className="text-center">
                    {c.photo ? (
                      <img src={c.photo} className="w-24 h-24 sm:w-32 sm:h-32 md:w-40 md:h-40 rounded-full object-cover shadow-lg border-4 border-white mx-auto" alt={c.name} />
                    ) : (
                      <div className="w-24 h-24 sm:w-32 sm:h-32 md:w-40 md:h-40 rounded-full bg-green-200 flex items-center justify-center text-3xl sm:text-4xl md:text-5xl shadow-lg border-4 border-white mx-auto">{c.name[0]}</div>
                    )}
                    <h3 className="font-bold text-sm sm:text-base md:text-lg text-green-800 mt-3">{c.name}</h3>
                    <p className="text-green-600 text-xs sm:text-sm">{c.position}</p>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Drop-off Photo Section */}
          {getSitePhoto('dropoff') && (
            <div className="bg-green-50 py-12">
              <div className="max-w-6xl mx-auto px-4">
                <div className="grid md:grid-cols-2 gap-8 items-center">
                  <div>
                    <img
                      src={getSitePhoto('dropoff')}
                      alt="Camp drop-off"
                      className="w-full object-cover rounded-2xl shadow-xl"
                      style={{ aspectRatio: '4/3' }}
                    />
                  </div>
                  <div>
                    <h2 className="font-display text-3xl text-green-800 mb-4">Easy Pick-up & Drop-off</h2>
                    <p className="text-gray-700 text-lg mb-4">Our convenient location at Roosevelt High School makes drop-off and pick-up a breeze. Counselors greet every camper at the gym entrance.</p>
                    <ul className="space-y-2 text-gray-600">
                      <li className="flex items-center gap-2"><span className="text-green-600">‚úì</span> Morning drop-off: 8:45 - 9:00 AM</li>
                      <li className="flex items-center gap-2"><span className="text-green-600">‚úì</span> Afternoon drop-off: 11:45 AM - 12:00 PM</li>
                      <li className="flex items-center gap-2"><span className="text-green-600">‚úì</span> Safe, supervised transitions</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* About Section */}
          <div className="bg-gray-50 py-12">
            <div className="max-w-4xl mx-auto px-4 text-center">
              <h2 className="font-display text-4xl text-green-800 mb-6">About Our Camp</h2>
              <p className="text-gray-700 text-lg">{content.aboutText}</p>
            </div>
          </div>

          {/* Skills Training Photo Section */}
          {getSitePhoto('layups') && (
            <div className="py-12">
              <div className="max-w-6xl mx-auto px-4">
                <div className="grid md:grid-cols-2 gap-8 items-center">
                  <div className="order-2 md:order-1">
                    <h2 className="font-display text-3xl text-green-800 mb-4">Skills Training with Expert Coaches</h2>
                    <p className="text-gray-700 text-lg mb-4">Our counselors work one-on-one and in small groups to develop fundamental basketball skills. Every camper gets personalized attention.</p>
                    <ul className="space-y-2 text-gray-600">
                      <li className="flex items-center gap-2"><span className="text-green-600">‚úì</span> Layups, shooting, and ball handling</li>
                      <li className="flex items-center gap-2"><span className="text-green-600">‚úì</span> Age-appropriate drills</li>
                      <li className="flex items-center gap-2"><span className="text-green-600">‚úì</span> 5:1 camper-to-counselor ratio</li>
                    </ul>
                  </div>
                  <div className="order-1 md:order-2">
                    <img
                      src={getSitePhoto('layups')}
                      alt="Layups practice"
                      className="w-full object-cover rounded-2xl shadow-xl"
                      style={{ aspectRatio: '4/3' }}
                    />
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Lunch Photo Section */}
          {getSitePhoto('lunch') && (
            <div className="bg-amber-50 py-12">
              <div className="max-w-6xl mx-auto px-4">
                <div className="grid md:grid-cols-2 gap-8 items-center">
                  <div>
                    <img
                      src={getSitePhoto('lunch')}
                      alt="Campers eating lunch"
                      className="w-full object-cover rounded-2xl shadow-xl"
                      style={{ aspectRatio: '4/3' }}
                    />
                  </div>
                  <div>
                    <h2 className="font-display text-3xl text-green-800 mb-4">Lunch & Snack Time</h2>
                    <p className="text-gray-700 text-lg mb-4">Campers enjoy healthy snacks and lunch breaks together, building friendships on and off the court.</p>
                    <ul className="space-y-2 text-gray-600">
                      <li className="flex items-center gap-2"><span className="text-green-600">‚úì</span> Healthy snacks provided</li>
                      <li className="flex items-center gap-2"><span className="text-green-600">‚úì</span> Water and sports drinks available</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Contact Footer */}
          <div className="bg-green-900 text-white py-8 sm:py-12 text-center px-4">
            <h2 className="font-display text-2xl sm:text-3xl md:text-4xl mb-4 sm:mb-6">Contact Us</h2>
            <p className="text-base sm:text-lg md:text-xl break-words">{content.contactEmail}</p>
            <p className="text-base sm:text-lg md:text-xl">{content.contactPhone}</p>
            <p className="mt-3 sm:mt-4 text-green-200 whitespace-pre-line text-sm sm:text-base">{content.locationAddress}</p>
          </div>
        </div>
      );

      // ==================== SCHEDULE ====================
      const DEFAULT_FOOD_PHOTOS = {
        snack_fruit: 'https://images.unsplash.com/photo-1619566636858-adf3ef46400b?w=150&h=150&fit=crop',
        snack_granola: 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=150&h=150&fit=crop',
        snack_cheese: 'https://images.unsplash.com/photo-1486297678162-eb2a19b0a32d?w=150&h=150&fit=crop',
        snack_veggie: 'https://images.unsplash.com/photo-1640719028782-8230f1bdc5d1?w=150&h=150&fit=crop',
        drink_water: 'https://images.unsplash.com/photo-1548839140-29a749e1cf4d?w=150&h=150&fit=crop',
        drink_gatorade: 'https://images.unsplash.com/photo-1622543925917-763c34d1a86e?w=150&h=150&fit=crop',
        drink_orange: 'https://images.unsplash.com/photo-1600271886742-f049cd451bba?w=150&h=150&fit=crop',
        drink_apple: 'https://images.unsplash.com/photo-1576673442511-7e39b6545c87?w=150&h=150&fit=crop'
      };
      const getFoodPhoto = (key) => foodPhotos[key] || DEFAULT_FOOD_PHOTOS[key] || '';
      const Schedule = () => (
        <div className="min-h-screen bg-amber-50 py-8 sm:py-12">
          <div className="max-w-4xl mx-auto px-4">
            <h1 className="font-display text-2xl sm:text-3xl md:text-4xl text-green-800 text-center mb-6 sm:mb-8">Camp Schedule</h1>

            {/* Sessions */}
            <div className="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-6">
              <h2 className="font-bold text-lg sm:text-xl text-green-800 mb-4">Daily Sessions</h2>
              <div className="grid sm:grid-cols-2 gap-4 mb-6">
                <div className="p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
                  <h3 className="font-bold text-yellow-700">üåÖ Morning Session</h3>
                  <p className="text-base sm:text-lg">{content.sessionMorning}</p>
                </div>
                <div className="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                  <h3 className="font-bold text-blue-700">‚òÄÔ∏è Afternoon Session</h3>
                  <p className="text-base sm:text-lg">{content.sessionAfternoon}</p>
                </div>
              </div>
              <p className="text-gray-700 font-medium">{content.campDates}</p>
              <p className="text-sm text-gray-500 mt-2">Camp runs Monday through Friday.</p>
              <button onClick={() => setPage('pricing')} className="mt-4 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">View Pricing ‚Üí</button>
            </div>

            {/* Basketball Training Focus */}
            <div className="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-6">
              <h2 className="font-bold text-lg sm:text-xl text-green-800 mb-4">üèÄ Basketball Training Focus</h2>
              <p className="text-gray-700 mb-4">Each session includes a variety of basketball drills and activities designed to build fundamental skills and game experience:</p>
              <div className="grid sm:grid-cols-2 gap-3">
                <div className="p-3 bg-orange-50 rounded-lg border-l-4 border-orange-400">
                  <h3 className="font-bold text-orange-800 text-sm mb-1">üéØ Shooting Form</h3>
                  <p className="text-gray-600 text-sm">Proper technique, follow-through, and free throws</p>
                </div>
                <div className="p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                  <h3 className="font-bold text-blue-800 text-sm mb-1">üèÉ Layups</h3>
                  <p className="text-gray-600 text-sm">Footwork, finishing with both hands, and coordination</p>
                </div>
                <div className="p-3 bg-purple-50 rounded-lg border-l-4 border-purple-400">
                  <h3 className="font-bold text-purple-800 text-sm mb-1">‚ö° Dribbling</h3>
                  <p className="text-gray-600 text-sm">Ball control, speed dribbles, and ball handling drills</p>
                </div>
                <div className="p-3 bg-green-50 rounded-lg border-l-4 border-green-400">
                  <h3 className="font-bold text-green-800 text-sm mb-1">ü§ù Passing</h3>
                  <p className="text-gray-600 text-sm">Chest passes, bounce passes, and court awareness</p>
                </div>
                <div className="p-3 bg-red-50 rounded-lg border-l-4 border-red-400">
                  <h3 className="font-bold text-red-800 text-sm mb-1">üõ°Ô∏è Defense</h3>
                  <p className="text-gray-600 text-sm">Stance, positioning, and defensive fundamentals</p>
                </div>
                <div className="p-3 bg-yellow-50 rounded-lg border-l-4 border-yellow-400">
                  <h3 className="font-bold text-yellow-800 text-sm mb-1">üèÜ Scrimmages</h3>
                  <p className="text-gray-600 text-sm">Apply skills in game situations and team play</p>
                </div>
              </div>
            </div>

            {/* Lunch & Snacks */}
            <div className="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-6">
              <h2 className="font-bold text-lg sm:text-xl text-green-800 mb-4">üçé Lunch & Snacks</h2>

              {/* Lunch Info */}
              <div className="p-4 bg-orange-50 rounded-lg border border-orange-200 mb-6">
                <h3 className="font-bold text-orange-800 mb-2">üçΩÔ∏è Bring Your Own Lunch</h3>
                <p className="text-gray-700">
                  Campers attending both morning and afternoon sessions should bring their own lunch. We have a supervised lunch break between sessions where kids can eat together.
                </p>
              </div>

              {/* Snacks Provided */}
              <div className="mb-6">
                <h3 className="font-bold text-lg text-green-700 mb-3">‚ú® Snacks Provided</h3>
                <p className="text-gray-700 mb-4">
                  We provide healthy snacks to keep campers energized! If your child needs extra snacks, we're happy to help.
                </p>
                <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
                  <div className="text-center">
                    <img src={getFoodPhoto('snack_fruit')} alt="Fresh fruits" className="w-full aspect-square object-cover rounded-xl mb-2 shadow-md"
                      onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/300x300/22c55e/white?text=üçé'; }} />
                    <span className="text-xs sm:text-sm font-medium text-gray-700">Fresh Fruit</span>
                  </div>
                  <div className="text-center">
                    <img src={getFoodPhoto('snack_granola')} alt="Granola bars" className="w-full aspect-square object-cover rounded-xl mb-2 shadow-md"
                      onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/300x300/f59e0b/white?text=ü•ú'; }} />
                    <span className="text-xs sm:text-sm font-medium text-gray-700">Granola Bars</span>
                  </div>
                  <div className="text-center">
                    <img src={getFoodPhoto('snack_cheese')} alt="Cheese and crackers" className="w-full aspect-square object-cover rounded-xl mb-2 shadow-md"
                      onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/300x300/fbbf24/white?text=üßÄ'; }} />
                    <span className="text-xs sm:text-sm font-medium text-gray-700">Cheese & Crackers</span>
                  </div>
                  <div className="text-center">
                    <img src={getFoodPhoto('snack_veggie')} alt="Veggie sticks" className="w-full aspect-square object-cover rounded-xl mb-2 shadow-md"
                      onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/300x300/84cc16/white?text=ü•ï'; }} />
                    <span className="text-xs sm:text-sm font-medium text-gray-700">Veggie Sticks</span>
                  </div>
                </div>
              </div>

              {/* Drinks */}
              <div>
                <h3 className="font-bold text-lg text-blue-700 mb-3">ü•§ Beverages</h3>
                <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
                  <div className="text-center p-3 sm:p-4 bg-blue-50 rounded-xl">
                    <img src={getFoodPhoto('drink_water')} alt="Water bottles" className="w-full aspect-square object-cover rounded-xl mb-2 shadow-md"
                      onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/300x300/3b82f6/white?text=üíß'; }} />
                    <span className="text-xs sm:text-sm font-medium text-gray-700">Water</span>
                  </div>
                  <div className="text-center p-3 sm:p-4 bg-green-50 rounded-xl">
                    <img src={getFoodPhoto('drink_gatorade')} alt="Gatorade" className="w-full aspect-square object-cover rounded-xl mb-2 shadow-md"
                      onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/300x300/22c55e/white?text=‚ö°'; }} />
                    <span className="text-xs sm:text-sm font-medium text-gray-700">Gatorade</span>
                  </div>
                  <div className="text-center p-3 sm:p-4 bg-orange-50 rounded-xl">
                    <img src={getFoodPhoto('drink_orange')} alt="Orange juice" className="w-full aspect-square object-cover rounded-xl mb-2 shadow-md"
                      onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/300x300/f97316/white?text=üçä'; }} />
                    <span className="text-xs sm:text-sm font-medium text-gray-700">Orange Juice</span>
                  </div>
                  <div className="text-center p-3 sm:p-4 bg-red-50 rounded-xl">
                    <img src={getFoodPhoto('drink_apple')} alt="Apple juice" className="w-full aspect-square object-cover rounded-xl mb-2 shadow-md"
                      onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/300x300/ef4444/white?text=üçé'; }} />
                    <span className="text-xs sm:text-sm font-medium text-gray-700">Apple Juice</span>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      );

      // ==================== PRICING PAGE ====================
      const Pricing = () => (
        <div className="min-h-screen bg-amber-50 py-8 sm:py-12">
          <div className="max-w-4xl mx-auto px-4">
            <h1 className="font-display text-2xl sm:text-3xl md:text-4xl text-green-800 text-center mb-6 sm:mb-8">üí∞ Pricing & Registration</h1>

            {/* Session Pricing */}
            <div className="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-6">
              <h2 className="font-bold text-lg sm:text-xl text-green-800 mb-4">Session Pricing</h2>
              <div className="grid sm:grid-cols-2 gap-4 mb-6">
                <div className="p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
                  <h3 className="font-bold text-yellow-700">üåÖ Morning Session</h3>
                  <p className="text-base sm:text-lg">{content.sessionMorning}</p>
                  <p className="text-green-600 font-bold text-lg">${content.singleSessionCost || 60}/session</p>
                </div>
                <div className="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                  <h3 className="font-bold text-blue-700">‚òÄÔ∏è Afternoon Session</h3>
                  <p className="text-base sm:text-lg">{content.sessionAfternoon}</p>
                  <p className="text-green-600 font-bold text-lg">${content.singleSessionCost || 60}/session</p>
                </div>
              </div>
            </div>

            {/* Discounts */}
            <div className="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-6">
              <h2 className="font-bold text-lg sm:text-xl text-green-800 mb-4">üéâ Discounts</h2>
              <div className="space-y-3">
                <div className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                  <span>Single Session</span>
                  <span className="font-bold">${content.singleSessionCost || 60}</span>
                </div>
                <div className="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-200">
                  <div>
                    <span className="font-medium">Full Week (10 sessions)</span>
                    <span className="ml-2 text-green-600 text-sm">Save {content.weekDiscount || 10}%!</span>
                  </div>
                  <span className="font-bold text-green-700">${Math.round((content.singleSessionCost || 60) * 10 * (1 - (content.weekDiscount || 10) / 100))}</span>
                </div>
                <div className="flex justify-between items-center p-3 bg-green-100 rounded-lg border border-green-300">
                  <div>
                    <span className="font-medium">2+ Weeks</span>
                    <span className="ml-2 text-green-700 text-sm">Save {content.multiWeekDiscount || 15}%!</span>
                  </div>
                  <span className="font-bold text-green-800">{content.multiWeekDiscount || 15}% off total</span>
                </div>
              </div>
              <p className="text-sm text-gray-500 mt-4">Discounts applied automatically at checkout.</p>
            </div>

            {/* Scholarship */}
            <div className="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-6">
              <h2 className="font-bold text-lg sm:text-xl text-purple-800 mb-4">üíú Scholarship Assistance</h2>
              <p className="text-gray-700">{content.scholarshipInfo}</p>
              <button onClick={() => setPage('login')} className="mt-4 px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Apply for Scholarship</button>
            </div>

            {/* Policies */}
            <div className="bg-white rounded-xl shadow-lg p-4 sm:p-6">
              <h2 className="font-bold text-lg sm:text-xl text-green-800 mb-4">üìã Policies</h2>
              <div className="space-y-3">
                <div className="p-3 bg-red-50 rounded-lg border-l-4 border-red-400">
                  <h3 className="font-bold text-red-800 text-sm">üö´ Cancellations</h3>
                  <p className="text-gray-700 text-sm">Cancel 14+ days ahead for full refund. Later cancellations may receive credit for future sessions.</p>
                </div>
                <div className="p-3 bg-orange-50 rounded-lg border-l-4 border-orange-400">
                  <h3 className="font-bold text-orange-800 text-sm">‚è∞ Late Pickup</h3>
                  <p className="text-gray-700 text-sm">Please pick up on time - our volunteer counselors have commitments after camp. Call if you'll be late.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      );

      // ==================== LOCATION PAGE ====================
      const Location = () => {
        const fullAddress = `${content.locationAddress}, ${content.locationCity}, ${content.locationState} ${content.locationZip}`;
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(content.locationName + ' ' + fullAddress)}`;
        const mapsEmbedUrl = `https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${encodeURIComponent(content.locationName + ' ' + fullAddress)}`;

        return (
          <div className="min-h-screen bg-amber-50 py-12">
            <div className="max-w-4xl mx-auto px-4">
              <h1 className="font-display text-4xl text-green-800 text-center mb-8">üìç Camp Location</h1>

              {/* Location Card */}
              <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
                {/* Map */}
                <div className="h-64 bg-gray-200 relative">
                  <iframe
                    width="100%"
                    height="100%"
                    frameBorder="0"
                    style={{ border: 0 }}
                    src={`https://www.google.com/maps?q=${encodeURIComponent(content.locationName + ' ' + fullAddress)}&output=embed`}
                    allowFullScreen
                  />
                </div>

                {/* Details */}
                <div className="p-6">
                  <h2 className="font-display text-3xl text-green-800 mb-2">{content.locationName || 'Roosevelt High School'}</h2>

                  <div className="space-y-3 mb-6">
                    <div className="flex items-start gap-3">
                      <span className="text-2xl">üè´</span>
                      <div>
                        <p className="font-medium">{content.locationAddress || '1410 NE 66th St'}</p>
                        <p className="text-gray-600">{content.locationCity || 'Seattle'}, {content.locationState || 'WA'} {content.locationZip || '98115'}</p>
                      </div>
                    </div>

                    {content.locationDetails && (
                      <div className="flex items-start gap-3">
                        <span className="text-2xl">‚ÑπÔ∏è</span>
                        <p className="text-gray-700">{content.locationDetails}</p>
                      </div>
                    )}
                  </div>

                  {/* Copy-friendly address box */}
                  <div className="bg-gray-50 rounded-lg p-4 mb-4">
                    <p className="text-sm text-gray-500 mb-2">üìã Copy this address for GPS/Maps:</p>
                    <p className="font-mono text-gray-800 select-all">{fullAddress}</p>
                  </div>

                  {/* Action buttons */}
                  <div className="flex flex-wrap gap-3">
                    <a
                      href={mapsUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex-1 min-w-[200px] py-3 bg-blue-600 text-white rounded-lg text-center font-medium hover:bg-blue-700"
                    >
                      üó∫Ô∏è Open in Google Maps
                    </a>
                    <a
                      href={`https://maps.apple.com/?q=${encodeURIComponent(fullAddress)}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex-1 min-w-[200px] py-3 bg-gray-800 text-white rounded-lg text-center font-medium hover:bg-gray-900"
                    >
                      üçé Open in Apple Maps
                    </a>
                  </div>
                </div>
              </div>

              {/* Parking & Directions */}
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h2 className="font-bold text-xl text-green-800 mb-4">üöó Parking & Drop-off</h2>
                <div className="space-y-3 text-gray-700">
                  <p>‚Ä¢ <strong>Parking:</strong> Free parking is available in the school parking lot off NE 66th St.</p>
                  <p>‚Ä¢ <strong>Drop-off:</strong> Please drop off campers at the main gymnasium entrance on the east side of the building.</p>
                  <p>‚Ä¢ <strong>Pick-up:</strong> Campers should be picked up at the same location promptly at the end of their session.</p>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // ==================== COUNSELORS PAGE ====================
      const Counselors = () => (
        <div className="min-h-screen bg-amber-50 py-8 sm:py-12">
          <div className="max-w-6xl mx-auto px-4">
            <h1 className="font-display text-2xl sm:text-3xl md:text-4xl text-green-800 text-center mb-6 sm:mb-8">Our Counselors</h1>
            <div className="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4 md:gap-6">
              {counselors.filter(c => c.visible).map(c => (
                <div key={c.id} className="bg-white rounded-xl shadow-lg overflow-hidden">
                  <div className="pt-4 sm:pt-6 flex items-center justify-center">
                    {c.photo ? <img src={c.photo} className="w-28 h-28 sm:w-48 sm:h-48 rounded-full object-cover border-4 border-green-600 shadow-lg" /> : <div className="w-28 h-28 sm:w-48 sm:h-48 rounded-full bg-green-200 flex items-center justify-center text-4xl sm:text-6xl border-4 border-green-600 shadow-lg">{c.name[0]}</div>}
                  </div>
                  <div className="p-3 sm:p-4 text-center">
                    <h3 className="font-bold text-base sm:text-xl text-green-800">{c.name}</h3>
                    <p className="text-green-600 text-xs sm:text-base">{c.position} ‚Ä¢ {c.year}</p>
                    <p className="text-gray-600 text-xs sm:text-sm mt-1 sm:mt-2">{c.bio}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );

      // ==================== ROLE SELECTOR ====================
      const RoleSelector = ({ onSelect, onBack }) => (
        <div className="min-h-screen bg-gradient-to-br from-green-50 to-green-100 py-8 sm:py-12">
          <div className="max-w-lg mx-auto px-4">
            <div className="bg-white rounded-2xl shadow-xl p-4 sm:p-8">
              <h2 className="font-display text-2xl sm:text-3xl text-green-800 text-center mb-2">Join Roosevelt Camp</h2>
              <p className="text-gray-600 text-center mb-6 sm:mb-8 text-sm sm:text-base">How would you like to participate?</p>

              <div className="space-y-3 sm:space-y-4">
                <button
                  onClick={() => onSelect('parent')}
                  className="w-full p-4 sm:p-6 border-2 border-gray-200 rounded-xl hover:border-green-500 hover:bg-green-50 transition-all text-left group"
                >
                  <div className="flex items-start gap-3 sm:gap-4">
                    <div className="text-3xl sm:text-4xl">üë®‚Äçüë©‚Äçüëß</div>
                    <div>
                      <h3 className="font-bold text-lg sm:text-xl text-green-800 group-hover:text-green-600">I'm a Parent</h3>
                      <p className="text-gray-600 mt-1 text-sm sm:text-base">Register your children for basketball camp sessions</p>
                      <ul className="text-xs sm:text-sm text-gray-500 mt-2 space-y-1">
                        <li>‚Ä¢ Add your children's profiles</li>
                        <li>‚Ä¢ Set up emergency contacts</li>
                        <li>‚Ä¢ Register for camp sessions</li>
                      </ul>
                    </div>
                  </div>
                </button>

                <button
                  onClick={() => onSelect('counselor')}
                  className="w-full p-4 sm:p-6 border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all text-left group"
                >
                  <div className="flex items-start gap-3 sm:gap-4">
                    <div className="text-3xl sm:text-4xl">üèÄ</div>
                    <div>
                      <h3 className="font-bold text-lg sm:text-xl text-blue-800 group-hover:text-blue-600">I'm a Counselor</h3>
                      <p className="text-gray-600 mt-1 text-sm sm:text-base">Apply to be a camp counselor and work with campers</p>
                      <ul className="text-xs sm:text-sm text-gray-500 mt-2 space-y-1">
                        <li>‚Ä¢ Create your counselor profile</li>
                        <li>‚Ä¢ Set your availability</li>
                        <li>‚Ä¢ Pending admin approval</li>
                      </ul>
                    </div>
                  </div>
                </button>
              </div>

              <button
                onClick={onBack}
                className="w-full mt-6 text-gray-500 hover:text-gray-700 text-sm"
              >
                ‚Üê Back to login
              </button>
            </div>
          </div>
        </div>
      );

      // ==================== ONBOARDING CONSTANTS ====================
      const COUNSELOR_RESPONSIBILITIES = [
        "Supervise campers during all activities",
        "Lead basketball drills and games appropriate for age group",
        "Ensure camper safety at all times",
        "Report any incidents or concerns to camp director",
        "Arrive 15 minutes before session start",
        "Maintain positive and encouraging attitude",
        "Be a role model for campers on and off the court"
      ];

      const PAY_DISCLOSURE = `
Pay Rate: $25 per session (morning or afternoon)
Payment Schedule: Twice monthly (1st and 15th)
Employment Status: 1099 Independent Contractor

As a 1099 contractor, you are responsible for:
‚Ä¢ Reporting this income on your tax return
‚Ä¢ Paying self-employment taxes
‚Ä¢ We will provide a 1099 form at year end for income over $600
      `.trim();

      // NOTE: ParentOnboarding is defined at top-level scope (before ParentsTab) to be accessible by both Admin and parent signup

      // ==================== COUNSELOR ONBOARDING WIZARD ====================
      const CounselorOnboarding = ({ onComplete, onBack, users, saveUsers, counselors, saveCounselors, availability, saveAvailability }) => {
        const [step, setStep] = useState(1);
        const [userData, setUserData] = useState({ name: '', email: '', phone: '', password: '' });
        const [profileData, setProfileData] = useState({ position: 'Point Guard', year: 'Freshman', bio: '', photo: null });
        const [availData, setAvailData] = useState(() => {
          // Default: available for all sessions
          const defaultAvail = {};
          CAMP_DATES.forEach(date => {
            defaultAvail[date] = ['morning', 'afternoon'];
          });
          return defaultAvail;
        });
        const [responsibilitiesAcked, setResponsibilitiesAcked] = useState(false);
        const [payAcked, setPayAcked] = useState(false);
        const [error, setError] = useState('');
        const [showCropper, setShowCropper] = useState(false);
        const [tempImage, setTempImage] = useState(null);
        const photoInputRef = useRef(null);

        const totalSteps = 5;

        const steps = [
          { num: 1, title: 'Account', icon: 'üë§' },
          { num: 2, title: 'Profile', icon: 'üèÄ' },
          { num: 3, title: 'Availability', icon: 'üìÖ' },
          { num: 4, title: 'Responsibilities', icon: 'üìã' },
          { num: 5, title: 'Submit', icon: '‚úÖ' }
        ];

        const handlePhotoUpload = (e) => {
          const file = e.target.files?.[0];
          if (file) {
            const reader = new FileReader();
            reader.onloadend = () => {
              setTempImage(reader.result);
              setShowCropper(true);
            };
            reader.readAsDataURL(file);
          }
          if (e.target) e.target.value = '';
        };

        // Availability helpers (moved to parent level)
        const toggleSession = (date, session) => {
          const current = availData[date] || [];
          if (current.includes(session)) {
            setAvailData({ ...availData, [date]: current.filter(s => s !== session) });
          } else {
            setAvailData({ ...availData, [date]: [...current, session] });
          }
        };

        const selectAllSessions = () => {
          const newAvail = {};
          CAMP_DATES.forEach(date => {
            newAvail[date] = ['morning', 'afternoon'];
          });
          setAvailData(newAvail);
        };

        const clearAllSessions = () => {
          setAvailData({});
        };

        const getTotalSessions = () => {
          return Object.values(availData).flat().length;
        };

        const validateStep = () => {
          setError('');
          if (step === 1) {
            if (!userData.name || !userData.email || !userData.phone || !userData.password) {
              setError('Please fill in all required fields');
              return false;
            }
            if (!isValidPhone(userData.phone)) {
              setError('Please enter a valid phone number');
              return false;
            }
            if (users.some(u => u.email === userData.email) || counselors.some(c => c.email === userData.email)) {
              setError('An account with this email already exists');
              return false;
            }
          }
          if (step === 2) {
            if (!profileData.bio || profileData.bio.length < 20) {
              setError('Please write a bio (at least 20 characters)');
              return false;
            }
          }
          if (step === 3) {
            if (Object.values(availData).flat().length === 0) {
              setError('Please select at least one available session');
              return false;
            }
          }
          if (step === 4) {
            if (!responsibilitiesAcked || !payAcked) {
              setError('Please acknowledge both the responsibilities and pay terms');
              return false;
            }
          }
          return true;
        };

        const handleNext = async () => {
          if (!validateStep()) return;

          if (step === totalSteps) {
            // Create user account
            const newUser = {
              email: userData.email,
              name: userData.name,
              password: userData.password,
              phone: userData.phone,
              role: 'counselor',
              roles: ['counselor'],
              onboardingComplete: true,
              onboardingCompletedAt: new Date().toISOString()
            };
            await saveUsers([...users, newUser]);

            // Create counselor profile (pending approval)
            const newCounselor = {
              id: 'counselor_' + Date.now(),
              name: userData.name,
              email: userData.email,
              phone: userData.phone,
              position: profileData.position,
              year: profileData.year,
              bio: profileData.bio,
              photo: profileData.photo,
              visible: false, // Hidden until approved
              approvedByAdmin: false,
              responsibilitiesAcknowledged: true,
              payDisclosureAcknowledged: true,
              createdAt: new Date().toISOString(),
              order: counselors.length
            };
            await saveCounselors([...counselors, newCounselor]);

            // Save availability
            const newAvail = { ...availability, [newCounselor.id]: availData };
            await saveAvailability(newAvail);

            onComplete(newUser);
            return;
          }

          setStep(step + 1);
        };

        const handleBack = () => {
          if (step === 1) {
            onBack();
          } else {
            setStep(step - 1);
          }
        };

        // Image cropper modal
        if (showCropper && tempImage) {
          return (
            <div className="min-h-screen bg-gray-900 flex items-center justify-center p-4">
              <div className="bg-white rounded-xl max-w-lg w-full p-6">
                <h3 className="font-bold text-lg mb-4">Crop Your Photo</h3>
                <ImageCropper
                  image={tempImage}
                  shape="circle"
                  onSave={(img) => {
                    setProfileData({ ...profileData, photo: img });
                    setShowCropper(false);
                    setTempImage(null);
                  }}
                  onCancel={() => {
                    setShowCropper(false);
                    setTempImage(null);
                  }}
                />
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 py-8">
            <div className="max-w-lg mx-auto px-4">
              {/* Progress Bar */}
              <div className="mb-6">
                <div className="flex justify-between items-center mb-2">
                  {steps.map((s) => (
                    <div
                      key={s.num}
                      className={`flex flex-col items-center ${s.num <= step ? 'text-blue-600' : 'text-gray-400'}`}
                    >
                      <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg ${
                        s.num < step ? 'bg-blue-600 text-white' :
                        s.num === step ? 'bg-blue-100 border-2 border-blue-600' : 'bg-gray-200'
                      }`}>
                        {s.num < step ? '‚úì' : s.icon}
                      </div>
                      <span className="text-xs mt-1 hidden sm:block">{s.title}</span>
                    </div>
                  ))}
                </div>
                <div className="h-2 bg-gray-200 rounded-full">
                  <div
                    className="h-2 bg-blue-600 rounded-full transition-all"
                    style={{ width: `${((step - 1) / (totalSteps - 1)) * 100}%` }}
                  />
                </div>
              </div>

              {/* Content Card */}
              <div className="bg-white rounded-2xl shadow-xl p-8">
                <h2 className="font-display text-2xl text-blue-800 mb-6">
                  {steps[step - 1].title}
                </h2>

                {error && (
                  <div className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm">
                    {error}
                  </div>
                )}

                {/* Step 1: Account */}
                {step === 1 && (
                  <div className="space-y-4">
                    <p className="text-gray-600 mb-4">Create your counselor account to get started.</p>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                      <input value={userData.name} onChange={e => setUserData({ ...userData, name: e.target.value })} className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Your full name" autoComplete="off" data-1p-ignore="true" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                      <input type="email" value={userData.email} onChange={e => setUserData({ ...userData, email: e.target.value })} className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="your@email.com" autoComplete="off" data-1p-ignore="true" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                      <input value={userData.phone} onChange={e => setUserData({ ...userData, phone: formatPhone(e.target.value) })} className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="(555) 555-1234" autoComplete="off" data-1p-ignore="true" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                      <input type="password" value={userData.password} onChange={e => setUserData({ ...userData, password: e.target.value })} className="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Create a password" autoComplete="off" data-1p-ignore="true" />
                    </div>
                  </div>
                )}

                {/* Step 2: Profile */}
                {step === 2 && (
                  <div className="space-y-4">
                    <p className="text-gray-600 mb-4">Tell us about your basketball background. This will appear on the camp website once approved.</p>
                    <div className="flex justify-center mb-4">
                      {profileData.photo ? (
                        <div className="relative">
                          <img src={profileData.photo} className="w-32 h-32 rounded-full object-cover border-4 border-blue-600" />
                          <button onClick={() => photoInputRef.current?.click()} className="absolute -bottom-2 -right-2 w-10 h-10 bg-blue-600 rounded-full text-white flex items-center justify-center hover:bg-blue-700">‚úé</button>
                        </div>
                      ) : (
                        <div onClick={() => photoInputRef.current?.click()} className="w-32 h-32 rounded-full bg-gray-200 border-4 border-dashed border-gray-400 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300">
                          <span className="text-4xl mb-1">üì∑</span>
                          <span className="text-xs text-gray-500">Add Photo</span>
                        </div>
                      )}
                      <input ref={photoInputRef} type="file" accept="image/*" onChange={handlePhotoUpload} className="hidden" />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Position *</label>
                        <select value={profileData.position} onChange={e => setProfileData({ ...profileData, position: e.target.value })} className="w-full px-3 py-2 border rounded-lg">
                          <option value="Point Guard">Point Guard</option>
                          <option value="Shooting Guard">Shooting Guard</option>
                          <option value="Small Forward">Small Forward</option>
                          <option value="Power Forward">Power Forward</option>
                          <option value="Center">Center</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Year *</label>
                        <select value={profileData.year} onChange={e => setProfileData({ ...profileData, year: e.target.value })} className="w-full px-3 py-2 border rounded-lg">
                          <option value="Freshman">Freshman</option>
                          <option value="Sophomore">Sophomore</option>
                          <option value="Junior">Junior</option>
                          <option value="Senior">Senior</option>
                          <option value="Alumni">Alumni</option>
                        </select>
                      </div>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Bio *</label>
                      <textarea value={profileData.bio} onChange={e => setProfileData({ ...profileData, bio: e.target.value })} className="w-full px-3 py-2 border rounded-lg h-24" placeholder="Tell us about your basketball experience and why you want to be a counselor..." />
                      <p className="text-xs text-gray-500 mt-1">{profileData.bio.length}/200 characters</p>
                    </div>
                  </div>
                )}

                {/* Step 3: Availability */}
                {step === 3 && (
                  <div className="space-y-4">
                    <p className="text-gray-600 mb-2">Select the sessions you're available to work. All sessions are selected by default.</p>
                    <div className="flex gap-2 mb-4">
                      <button onClick={selectAllSessions} className="px-3 py-1 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200">Select All</button>
                      <button onClick={clearAllSessions} className="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Clear All</button>
                      <span className="ml-auto text-sm text-gray-500">{getTotalSessions()} sessions selected</span>
                    </div>
                    <div className="max-h-64 overflow-y-auto border rounded-lg">
                      {CAMP_WEEKS.slice(0, 4).map((week, weekIdx) => (
                        <div key={weekIdx} className="border-b last:border-b-0">
                          <div className="bg-gray-100 px-3 py-2 text-sm font-medium">Week {weekIdx + 1}</div>
                          <div className="grid grid-cols-5 gap-1 p-2">
                            {week.dates.map(date => {
                              const d = new Date(date + 'T12:00:00');
                              const sessions = availData[date] || [];
                              return (
                                <div key={date} className="text-center p-1">
                                  <div className="text-xs text-gray-500">{['Mon', 'Tue', 'Wed', 'Thu', 'Fri'][d.getDay() - 1]}</div>
                                  <div className="text-xs">{d.getDate()}</div>
                                  <div className="flex flex-col gap-1 mt-1">
                                    <button onClick={() => toggleSession(date, 'morning')} className={`text-xs px-1 py-0.5 rounded ${sessions.includes('morning') ? 'bg-yellow-500 text-white' : 'bg-gray-200'}`}>AM</button>
                                    <button onClick={() => toggleSession(date, 'afternoon')} className={`text-xs px-1 py-0.5 rounded ${sessions.includes('afternoon') ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}>PM</button>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      ))}
                    </div>
                    <p className="text-xs text-gray-500">Scroll to see more weeks. You can update your availability later.</p>
                  </div>
                )}

                {/* Step 4: Responsibilities */}
                {step === 4 && (
                  <div className="space-y-6">
                    <div className="bg-white border rounded-lg overflow-hidden">
                      <div className="bg-blue-100 px-4 py-2 font-medium text-blue-800">üìã Counselor Responsibilities</div>
                      <div className="p-4">
                        <ul className="space-y-2">
                          {COUNSELOR_RESPONSIBILITIES.map((resp, idx) => (
                            <li key={idx} className="flex items-start gap-2 text-sm text-gray-600"><span className="text-blue-500">‚Ä¢</span>{resp}</li>
                          ))}
                        </ul>
                        <label className="flex items-center gap-3 mt-4 cursor-pointer">
                          <input type="checkbox" checked={responsibilitiesAcked} onChange={e => setResponsibilitiesAcked(e.target.checked)} className="w-5 h-5 text-blue-600" />
                          <span className="text-sm">I understand and accept these responsibilities</span>
                        </label>
                      </div>
                    </div>
                    <div className="bg-white border rounded-lg overflow-hidden">
                      <div className="bg-green-100 px-4 py-2 font-medium text-green-800">üíµ Pay Information</div>
                      <div className="p-4">
                        <pre className="whitespace-pre-wrap text-sm text-gray-600 font-sans">{PAY_DISCLOSURE}</pre>
                        <label className="flex items-center gap-3 mt-4 cursor-pointer">
                          <input type="checkbox" checked={payAcked} onChange={e => setPayAcked(e.target.checked)} className="w-5 h-5 text-green-600" />
                          <span className="text-sm">I understand and accept the pay terms and 1099 status</span>
                        </label>
                      </div>
                    </div>
                  </div>
                )}

                {/* Step 5: Submit */}
                {step === 5 && (
                  <div className="text-center space-y-6">
                    <div className="text-6xl">üì®</div>
                    <h3 className="font-display text-2xl text-blue-800">Ready to Submit!</h3>
                    <p className="text-gray-600">Your application will be reviewed by a camp administrator. You'll be notified once approved.</p>
                    <div className="bg-gray-50 rounded-lg p-4 text-left">
                      <h4 className="font-medium mb-2">Application Summary:</h4>
                      <p className="text-sm text-gray-600">‚Ä¢ {userData.name}</p>
                      <p className="text-sm text-gray-600">‚Ä¢ {profileData.position} ‚Ä¢ {profileData.year}</p>
                      <p className="text-sm text-gray-600">‚Ä¢ {getTotalSessions()} sessions available</p>
                    </div>
                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                      <p className="text-yellow-800 font-medium">‚è≥ Pending Admin Approval</p>
                      <p className="text-sm text-yellow-700 mt-1">Your profile won't appear on the website until approved by an administrator.</p>
                    </div>
                  </div>
                )}

                {/* Navigation */}
                <div className="flex gap-4 mt-8">
                  <button
                    onClick={handleBack}
                    className="flex-1 py-3 border-2 border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
                  >
                    {step === 1 ? '‚Üê Back' : '‚Üê Previous'}
                  </button>
                  <button
                    onClick={handleNext}
                    className="flex-1 py-3 bg-blue-700 hover:bg-blue-800 text-white font-bold rounded-lg"
                  >
                    {step === totalSteps ? 'Submit Application' : 'Continue ‚Üí'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // ==================== LOGIN ====================
      const Login = () => {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const [mode, setMode] = useState('login'); // 'login' | 'selectRole' | 'onboardParent' | 'onboardCounselor'
        const [name, setName] = useState('');
        const [phone, setPhone] = useState('');

        const handleLogin = () => {
          // Check if logging in as admin
          const admin = admins.find(a => a.username === email && a.password === password);
          if (admin) { setUser({ name: admin.name, role: 'admin', adminId: admin.id }); setPage('admin'); showToast(`Welcome, ${admin.name}!`); return; }
          const u = users.find(x => x.email === email && x.password === password);
          if (u) { setUser(u); setPage(u.role === 'counselor' ? 'counselor' : 'parent'); showToast('Welcome!'); return; }
          const c = counselors.find(x => x.email === email);
          if (c) { setUser({ ...c, role: 'counselor' }); setPage('counselor'); showToast('Welcome!'); return; }
          setError('Invalid credentials');
        };

        // Show role selector
        if (mode === 'selectRole') {
          return (
            <RoleSelector
              onSelect={(role) => setMode(role === 'parent' ? 'onboardParent' : 'onboardCounselor')}
              onBack={() => setMode('login')}
            />
          );
        }

        // Show parent onboarding wizard
        if (mode === 'onboardParent') {
          return (
            <ParentOnboarding
              onComplete={(newUser) => {
                setUser(newUser);
                setPage('parent');
                showToast('Welcome to Roosevelt Camp!');
              }}
              onBack={() => setMode('selectRole')}
              users={users}
              saveUsers={saveUsers}
              saveEmergencyContacts={saveEmergencyContacts}
              emergencyContacts={emergencyContacts}
              saveOnboardingProgress={saveOnboardingProgress}
              campers={campers}
              saveCampers={saveCampers}
              saveCamperParentLinks={saveCamperParentLinks}
              camperParentLinks={camperParentLinks}
            />
          );
        }

        // Show counselor onboarding wizard
        if (mode === 'onboardCounselor') {
          return (
            <CounselorOnboarding
              onComplete={(newUser) => {
                setUser(newUser);
                setPage('counselor');
                showToast('Application submitted! Awaiting admin approval.');
              }}
              onBack={() => setMode('selectRole')}
              users={users}
              saveUsers={saveUsers}
              counselors={counselors}
              saveCounselors={saveCounselors}
              availability={availability}
              saveAvailability={saveAvail}
            />
          );
        }

        return (
          <div className="min-h-screen bg-gradient-to-br from-green-50 to-green-100 py-12">
            <div className="max-w-md mx-auto px-4">
              <div className="bg-white rounded-2xl shadow-xl p-8">
                <h2 className="font-display text-3xl text-green-800 text-center mb-6">Welcome Back</h2>
                {error && <div className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-center">{error}</div>}

                <form autoComplete="off" data-1p-ignore="true" onSubmit={e => e.preventDefault()} className="space-y-4">
                  <input value={email} onChange={e => setEmail(e.target.value)} className="w-full px-4 py-3 border-2 rounded-lg" placeholder="Email" autoComplete="off" data-1p-ignore="true" data-lpignore="true" data-form-type="other" autoFocus />
                  <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full px-4 py-3 border-2 rounded-lg" placeholder="Password" onKeyDown={e => e.key === 'Enter' && handleLogin()} autoComplete="off" data-1p-ignore="true" data-lpignore="true" data-form-type="other" />
                  <button type="button" onClick={handleLogin} className="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 rounded-lg">Login</button>
                </form>

                <div className="relative my-6">
                  <div className="absolute inset-0 flex items-center">
                    <div className="w-full border-t border-gray-200"></div>
                  </div>
                  <div className="relative flex justify-center text-sm">
                    <span className="bg-white px-4 text-gray-500">or continue with</span>
                  </div>
                </div>

                <div className="space-y-3">
                  <button
                    onClick={() => showToast('Google login coming soon!')}
                    className="w-full flex items-center justify-center gap-3 px-4 py-3 border-2 border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
                  >
                    <svg className="w-5 h-5" viewBox="0 0 24 24">
                      <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                      <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                      <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                      <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span className="font-medium text-gray-700">Continue with Google</span>
                  </button>

                  <button
                    onClick={() => showToast('Apple login coming soon!')}
                    className="w-full flex items-center justify-center gap-3 px-4 py-3 border-2 border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
                  >
                    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
                    </svg>
                    <span className="font-medium text-gray-700">Continue with Apple</span>
                  </button>
                </div>

                <button onClick={() => { setMode('selectRole'); setError(''); }} className="w-full mt-6 text-green-600 hover:underline font-medium">
                  New? Create account with email ‚Üí
                </button>
              </div>
            </div>
          </div>
        );
      };

      // ==================== ADMIN ====================
      const Admin = () => {
        const [editCounselor, setEditCounselor] = useState(null);
        const [showModal, setShowModal] = useState(false);
        const [confirmDeleteCounselor, setConfirmDeleteCounselor] = useState(null);
        const [deleteConfirmText, setDeleteConfirmText] = useState('');
        // Use lifted state for schedule modal to prevent closing on state updates
        const managingSchedule = counselorScheduleModal;
        const setManagingSchedule = setCounselorScheduleModal;
        const scheduleMonth = counselorScheduleMonth;
        const setScheduleMonth = setCounselorScheduleMonth;

        // Helper: count sessions where counselor is marked eligible by admin
        const getCounselorEligibleCount = (counselorId) => {
          const schedule = counselorSchedule[counselorId] || {};
          let count = 0;
          Object.values(schedule).forEach(day => {
            if (day.morning) count++;
            if (day.afternoon) count++;
          });
          return count;
        };

        // Helper: count sessions where counselor has campers assigned
        const getCounselorScheduledCount = (counselorId) => {
          let count = 0;
          Object.entries(assignments).forEach(([key, counselorAssignments]) => {
            if (counselorAssignments[counselorId]?.length > 0) {
              count++;
            }
          });
          return count;
        };

        // Toggle counselor eligibility for a specific session
        const toggleCounselorEligibility = (counselorId, date, session) => {
          const current = counselorSchedule[counselorId]?.[date]?.[session] === true;
          const newSchedule = {
            ...counselorSchedule,
            [counselorId]: {
              ...counselorSchedule[counselorId],
              [date]: {
                ...counselorSchedule[counselorId]?.[date],
                [session]: !current
              }
            }
          };
          const counselor = counselors.find(c => c.id === counselorId);
          saveCounselorSchedule(newSchedule, `${!current ? 'Added' : 'Removed'} ${counselor?.name} ${!current ? 'to' : 'from'} ${date} ${session}`);
        };

        // Toggle entire day for counselor
        const toggleCounselorDay = (counselorId, date) => {
          const currentMorning = counselorSchedule[counselorId]?.[date]?.morning === true;
          const currentAfternoon = counselorSchedule[counselorId]?.[date]?.afternoon === true;
          const allSet = currentMorning && currentAfternoon;
          const newSchedule = {
            ...counselorSchedule,
            [counselorId]: {
              ...counselorSchedule[counselorId],
              [date]: {
                morning: !allSet,
                afternoon: !allSet
              }
            }
          };
          const counselor = counselors.find(c => c.id === counselorId);
          saveCounselorSchedule(newSchedule, `${!allSet ? 'Added' : 'Removed'} ${counselor?.name} ${!allSet ? 'to' : 'from'} ${date} (full day)`);
        };

        // Toggle entire week for counselor
        const toggleCounselorWeek = (counselorId, weekDates) => {
          let allSet = true;
          weekDates.forEach(date => {
            if (counselorSchedule[counselorId]?.[date]?.morning !== true) allSet = false;
            if (counselorSchedule[counselorId]?.[date]?.afternoon !== true) allSet = false;
          });
          const newSchedule = { ...counselorSchedule };
          if (!newSchedule[counselorId]) newSchedule[counselorId] = {};
          weekDates.forEach(date => {
            newSchedule[counselorId][date] = {
              morning: !allSet,
              afternoon: !allSet
            };
          });
          const counselor = counselors.find(c => c.id === counselorId);
          saveCounselorSchedule(newSchedule, `${!allSet ? 'Added' : 'Removed'} ${counselor?.name} ${!allSet ? 'to' : 'from'} week`);
        };

        const updateContent = (field, value) => {
          const newContent = { ...content, [field]: value };
          saveContent(newContent, field);
        };

        return (
          <div className="min-h-screen bg-gray-100">
            <div className="bg-green-800 text-white py-3 sm:py-4">
              <div className="max-w-6xl mx-auto px-4">
                <h1 className="font-display text-2xl sm:text-3xl">Admin Dashboard</h1>
                <p className="text-green-200 text-sm sm:text-base">Welcome, {user?.name}</p>
              </div>
            </div>

            <div className="bg-white shadow">
              <div className="max-w-6xl mx-auto px-2 sm:px-4">
                <ScrollableTabs>
                  {['dashboard', 'counselors', 'parents', 'campers', 'registrations', 'assignments', 'sessions', 'approval', 'content', 'history'].map(t => (
                    <button key={t} onClick={() => setAdminTab(t)} className={'px-2 sm:px-4 py-2 sm:py-3 border-b-2 whitespace-nowrap select-none text-xs sm:text-sm ' + (adminTab === t ? 'border-green-600 text-green-700 bg-green-50' : 'border-transparent text-gray-500')}>
                      {t === 'history' ? 'üìú History' : t === 'parents' ? 'üë®‚Äçüë©‚Äçüëß Parents' : t === 'campers' ? 'üèïÔ∏è Campers' : t === 'assignments' ? 'üìã Assignments' : t === 'sessions' ? 'üìÖ Sessions' : t === 'registrations' ? 'üìù Registrations' : t === 'counselors' ? 'üèÄ Counselors' : t === 'content' ? '‚úèÔ∏è Content' : t === 'dashboard' ? 'üìä Dashboard' : t === 'approval' ? '‚úÖ Approval' : t}
                      {t === 'registrations' && getPending() > 0 && <span className="ml-2 bg-red-500 text-white text-xs px-2 rounded-full">{getPending()}</span>}
                      {t === 'parents' && users.length > 0 && <span className="ml-2 bg-blue-500 text-white text-xs px-2 rounded-full">{users.length}</span>}
                      {t === 'sessions' && Object.keys(blockedSessions).length > 0 && <span className="ml-2 bg-red-500 text-white text-xs px-2 rounded-full">{Object.values(blockedSessions).reduce((sum, day) => sum + (day.morning ? 1 : 0) + (day.afternoon ? 1 : 0), 0)}</span>}
                      {t === 'approval' && counselors.filter(c => !c.approvedByAdmin && c.approvedByAdmin !== undefined).length > 0 && (
                        <span className="ml-2 bg-orange-500 text-white text-xs px-2 rounded-full">{counselors.filter(c => !c.approvedByAdmin && c.approvedByAdmin !== undefined).length}</span>
                      )}
                    </button>
                  ))}
                </ScrollableTabs>
              </div>
            </div>

            <div className="max-w-6xl mx-auto px-4 py-6">
              {adminTab === 'dashboard' && (
                <div className="space-y-6">
                  {/* Stats Cards */}
                  <div className="bg-white rounded-xl shadow p-4">
                    <h3 className="font-bold text-lg text-gray-700 mb-3">Registration Requests</h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div className="bg-yellow-50 rounded-lg p-4 text-center border border-yellow-200"><div className="text-3xl font-bold text-yellow-600">{getPending()}</div><div className="text-gray-600 text-sm">Pending</div></div>
                      <div className="bg-green-50 rounded-lg p-4 text-center border border-green-200"><div className="text-3xl font-bold text-green-600">{getApproved()}</div><div className="text-gray-600 text-sm">Approved</div></div>
                      <div className="bg-red-50 rounded-lg p-4 text-center border border-red-200"><div className="text-3xl font-bold text-red-600">{getUnpaid()}</div><div className="text-gray-600 text-sm">Unpaid</div></div>
                      <div className="bg-gray-50 rounded-lg p-4 text-center border border-gray-200"><div className="text-3xl font-bold text-gray-600">{getCancelled()}</div><div className="text-gray-600 text-sm">Cancelled</div></div>
                    </div>
                  </div>

                  {/* Quick Navigation Buttons */}
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold text-lg mb-4 text-gray-700">Quick Navigation</h3>
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
                      <button onClick={() => setAdminTab('counselors')} className="flex flex-col items-center justify-center p-4 bg-purple-50 hover:bg-purple-100 rounded-xl border-2 border-purple-200 min-h-[80px] transition-colors">
                        <span className="text-2xl mb-1">üë•</span>
                        <span className="font-medium text-purple-700">Counselors</span>
                      </button>
                      <button onClick={() => setAdminTab('parents')} className="flex flex-col items-center justify-center p-4 bg-blue-50 hover:bg-blue-100 rounded-xl border-2 border-blue-200 min-h-[80px] transition-colors">
                        <span className="text-2xl mb-1">üë®‚Äçüë©‚Äçüëß</span>
                        <span className="font-medium text-blue-700">Parents</span>
                      </button>
                      <button onClick={() => setAdminTab('registrations')} className="flex flex-col items-center justify-center p-4 bg-yellow-50 hover:bg-yellow-100 rounded-xl border-2 border-yellow-200 min-h-[80px] transition-colors">
                        <span className="text-2xl mb-1">üìù</span>
                        <span className="font-medium text-yellow-700">Registrations</span>
                      </button>
                      <button onClick={() => setAdminTab('campers')} className="flex flex-col items-center justify-center p-4 bg-green-50 hover:bg-green-100 rounded-xl border-2 border-green-200 min-h-[80px] transition-colors">
                        <span className="text-2xl mb-1">üèïÔ∏è</span>
                        <span className="font-medium text-green-700">Campers</span>
                      </button>
                      <button onClick={() => setAdminTab('assignments')} className="flex flex-col items-center justify-center p-4 bg-orange-50 hover:bg-orange-100 rounded-xl border-2 border-orange-200 min-h-[80px] transition-colors">
                        <span className="text-2xl mb-1">üìã</span>
                        <span className="font-medium text-orange-700">Assignments</span>
                      </button>
                      <button onClick={() => setAdminTab('sessions')} className="flex flex-col items-center justify-center p-4 bg-teal-50 hover:bg-teal-100 rounded-xl border-2 border-teal-200 min-h-[80px] transition-colors">
                        <span className="text-2xl mb-1">üìÖ</span>
                        <span className="font-medium text-teal-700">Sessions</span>
                      </button>
                      <button onClick={() => setAdminTab('approval')} className="flex flex-col items-center justify-center p-4 bg-indigo-50 hover:bg-indigo-100 rounded-xl border-2 border-indigo-200 min-h-[80px] transition-colors">
                        <span className="text-2xl mb-1">‚úÖ</span>
                        <span className="font-medium text-indigo-700">Approval</span>
                      </button>
                      <button onClick={() => setAdminTab('content')} className="flex flex-col items-center justify-center p-4 bg-cyan-50 hover:bg-cyan-100 rounded-xl border-2 border-cyan-200 min-h-[80px] transition-colors">
                        <span className="text-2xl mb-1">‚úèÔ∏è</span>
                        <span className="font-medium text-cyan-700">Content</span>
                      </button>
                      <button onClick={() => setAdminTab('history')} className="flex flex-col items-center justify-center p-4 bg-gray-50 hover:bg-gray-100 rounded-xl border-2 border-gray-200 min-h-[80px] transition-colors">
                        <span className="text-2xl mb-1">üìú</span>
                        <span className="font-medium text-gray-700">History</span>
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {adminTab === 'registrations' && (
                <div className="space-y-6">
                  {/* Header with Create button */}
                  <div className="bg-white rounded-xl shadow p-6">
                    <div className="flex justify-between items-center mb-4">
                      <div>
                        <h3 className="font-bold text-xl text-green-800">üìã Registration Management</h3>
                        <p className="text-sm text-gray-500">Create and manage camper registrations</p>
                      </div>
                      <button
                        onClick={() => {
                          // Initialize bulk reg modal with first month selected
                          const firstMonth = CAMP_DATES.length > 0 ? (() => {
                            const d = new Date(CAMP_DATES[0] + 'T12:00:00');
                            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                          })() : null;
                          setBulkRegMonth(firstMonth);
                          setBulkRegModal({ parentEmail: '', camperIds: [], selectedDates: {} });
                        }}
                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                      >
                        + Create Registration
                      </button>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold text-lg text-yellow-700 mb-4">Pending ({getPending()})</h3>
                    {registrations.filter(r => r.status === 'pending').length === 0 ? <p className="text-gray-500">None</p> : (
                      <div className="space-y-3">{registrations.filter(r => r.status === 'pending').map(r => (
                        <div key={r.id} className="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition" onClick={() => setViewRegModal({ ...r })}>
                          <div className="flex justify-between items-start">
                            <div className="flex-1">
                              <div className="font-bold">{r.camperName || r.childName}</div>
                              <div className="text-sm text-gray-600">{r.parentName} ‚Ä¢ {r.date}</div>
                              <div className="text-xs text-gray-500 mt-1">
                                Sessions: {r.sessions?.join(', ') || 'N/A'} ‚Ä¢
                                <span className={r.paymentStatus === 'paid' ? 'text-green-600' : 'text-red-600'}>
                                  {' '}{r.paymentStatus === 'paid' ? 'üíµ Paid' : '‚ö†Ô∏è Unpaid'}
                                </span>
                              </div>
                            </div>
                            <div className="flex gap-2" onClick={e => e.stopPropagation()}>
                              <button onClick={() => {
                                const newStatus = r.paymentStatus === 'paid' ? 'unpaid' : 'paid';
                                saveReg({ ...r, paymentStatus: newStatus }, `Marked ${r.camperName || r.childName} as ${newStatus}`);
                              }} className={'px-2 py-1 rounded text-xs ' + (r.paymentStatus === 'paid' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700')}>
                                {r.paymentStatus === 'paid' ? 'Mark Unpaid' : 'Mark Paid'}
                              </button>
                              <button onClick={() => { saveReg({ ...r, status: 'approved' }, `Approved ${r.camperName || r.childName} for ${r.date}`); showToast('Approved!'); }} className="px-3 py-1 bg-green-600 text-white rounded text-sm">Approve</button>
                              <button onClick={() => { saveReg({ ...r, status: 'rejected' }, `Rejected ${r.camperName || r.childName} for ${r.date}`); showToast('Rejected'); }} className="px-3 py-1 bg-red-100 text-red-600 rounded text-sm">Reject</button>
                              <button onClick={() => setDeleteRegConfirm(r)} className="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs hover:bg-red-100 hover:text-red-600" title="Delete permanently">üóëÔ∏è</button>
                            </div>
                          </div>
                        </div>
                      ))}</div>
                    )}
                  </div>

                  <div className="bg-white rounded-xl shadow p-4 sm:p-6">
                    <h3 className="font-bold text-base sm:text-lg text-green-700 mb-4">Approved ({getApproved()})</h3>
                    {registrations.filter(r => r.status === 'approved').length === 0 ? <p className="text-gray-500">None</p> : (
                      <div className="overflow-x-auto -mx-4 sm:mx-0">
                        <table className="w-full min-w-[500px]">
                          <thead><tr className="text-left text-xs sm:text-sm text-gray-600"><th className="p-2">Camper</th><th className="p-2">Parent</th><th className="p-2">Date</th><th className="p-2">Payment</th><th className="p-2">Actions</th></tr></thead>
                          <tbody>{registrations.filter(r => r.status === 'approved').map(r => (
                            <tr key={r.id} className={'hover:bg-gray-50 cursor-pointer ' + (r.paymentStatus !== 'paid' ? 'bg-red-50' : '')} onClick={() => setViewRegModal({ ...r })}>
                              <td className="p-2 font-medium text-sm">{r.camperName || r.childName}</td>
                              <td className="p-2 text-gray-600 text-sm">{r.parentName}</td>
                              <td className="p-2 text-gray-600 text-sm">{r.date}</td>
                              <td className="p-2" onClick={e => e.stopPropagation()}>
                                <button onClick={() => {
                                  const newStatus = r.paymentStatus === 'paid' ? 'unpaid' : 'paid';
                                  saveReg({ ...r, paymentStatus: newStatus }, `Marked ${r.camperName || r.childName} as ${newStatus} for ${r.date}`);
                                }} className={'px-2 py-1 rounded text-xs ' + (r.paymentStatus === 'paid' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700')}>
                                  {r.paymentStatus || 'unpaid'}
                                </button>
                              </td>
                              <td className="p-2" onClick={e => e.stopPropagation()}>
                                <button onClick={() => { saveReg({ ...r, status: 'cancelled', cancelledAt: new Date().toISOString() }, `Cancelled ${r.camperName || r.childName} for ${r.date}`); showToast('Cancelled'); }} className="text-red-600 text-sm mr-2">Cancel</button>
                                <button onClick={() => setDeleteRegConfirm(r)} className="text-gray-400 hover:text-red-600 text-sm" title="Delete permanently">üóëÔ∏è</button>
                              </td>
                            </tr>
                          ))}</tbody>
                        </table>
                      </div>
                    )}
                  </div>

                  {/* Rejected/Cancelled Section */}
                  <div className="bg-white rounded-xl shadow p-4 sm:p-6">
                    <h3 className="font-bold text-base sm:text-lg text-red-700 mb-4">Rejected/Cancelled ({getCancelled()})</h3>
                    {registrations.filter(r => r.status === 'rejected' || r.status === 'cancelled').length === 0 ? <p className="text-gray-500">None</p> : (
                      <div className="overflow-x-auto -mx-4 sm:mx-0">
                        <table className="w-full min-w-[500px]">
                          <thead><tr className="text-left text-xs sm:text-sm text-gray-600"><th className="p-2">Camper</th><th className="p-2">Parent</th><th className="p-2">Date</th><th className="p-2">Status</th><th className="p-2">Actions</th></tr></thead>
                          <tbody>{registrations.filter(r => r.status === 'rejected' || r.status === 'cancelled').map(r => (
                            <tr key={r.id} className="hover:bg-gray-50 cursor-pointer bg-red-50" onClick={() => setViewRegModal({ ...r })}>
                              <td className="p-2 font-medium text-sm">{r.camperName || r.childName}</td>
                              <td className="p-2 text-gray-600 text-sm">{r.parentName}</td>
                              <td className="p-2 text-gray-600 text-sm">{r.date}</td>
                              <td className="p-2">
                                <span className={`px-2 py-1 rounded text-xs ${r.status === 'rejected' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'}`}>
                                  {r.status}
                                </span>
                              </td>
                              <td className="p-2" onClick={e => e.stopPropagation()}>
                                <button onClick={() => { saveReg({ ...r, status: 'pending', cancelledAt: null }, `Restored ${r.camperName || r.childName} to pending`); showToast('Restored to pending'); }} className="text-blue-600 text-sm mr-2">Restore</button>
                                <button onClick={() => setDeleteRegConfirm(r)} className="text-gray-400 hover:text-red-600 text-sm" title="Delete permanently">üóëÔ∏è</button>
                              </td>
                            </tr>
                          ))}</tbody>
                        </table>
                      </div>
                    )}
                  </div>

                  {/* Delete Registration Confirmation Modal */}
                  {deleteRegConfirm && (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={() => setDeleteRegConfirm(null)}>
                      <div className="bg-white rounded-xl max-w-md w-full p-6" onClick={e => e.stopPropagation()}>
                        <h3 className="font-bold text-lg text-red-700 mb-4">Delete Registration Permanently?</h3>
                        <p className="text-gray-600 mb-2">
                          This will permanently delete the registration for:
                        </p>
                        <div className="bg-gray-50 rounded-lg p-3 mb-4">
                          <div className="font-bold">{deleteRegConfirm.camperName || deleteRegConfirm.childName}</div>
                          <div className="text-sm text-gray-600">{deleteRegConfirm.date} ‚Ä¢ {deleteRegConfirm.sessions?.join(', ')}</div>
                          <div className="text-sm text-gray-500">Parent: {deleteRegConfirm.parentName}</div>
                        </div>
                        <p className="text-red-600 text-sm mb-4">
                          This action cannot be undone. The registration will be removed as if it never existed.
                        </p>
                        <div className="flex gap-3 justify-end">
                          <button
                            onClick={() => setDeleteRegConfirm(null)}
                            className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
                          >
                            Cancel
                          </button>
                          <button
                            onClick={async () => {
                              const reg = deleteRegConfirm;
                              // Remove from state
                              setRegistrations(prev => prev.filter(r => r.id !== reg.id));
                              // Remove from database
                              await supabase.from('camp_registrations').delete().eq('id', reg.id);
                              // Clean up assignments
                              const camperId = reg.childId || reg.camperId;
                              if (camperId && reg.date && reg.sessions) {
                                const updatedAssignments = { ...assignments };
                                reg.sessions.forEach(session => {
                                  const key = `${reg.date}_${session}`;
                                  if (updatedAssignments[key]) {
                                    Object.keys(updatedAssignments[key]).forEach(counselorId => {
                                      updatedAssignments[key][counselorId] = updatedAssignments[key][counselorId].filter(id => id !== camperId);
                                    });
                                  }
                                });
                                setAssignments(updatedAssignments);
                                await storage.set('camp_assignments', 'main', updatedAssignments);
                              }
                              addToHistory('Delete', `Permanently deleted registration: ${reg.camperName || reg.childName} for ${reg.date}`);
                              showToast('Registration deleted permanently');
                              setDeleteRegConfirm(null);
                            }}
                            className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                          >
                            Delete Permanently
                          </button>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Bulk Registration Modal */}
                  {bulkRegModal && (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={() => setBulkRegModal(null)}>
                      <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="sticky top-0 bg-green-600 text-white px-6 py-4 flex justify-between items-center z-10">
                          <h2 className="font-display text-xl">Create Registration</h2>
                          <button onClick={() => setBulkRegModal(null)} className="text-2xl hover:bg-green-500 rounded px-2">√ó</button>
                        </div>
                        <div className="p-6 space-y-6">
                          {/* Step 1: Select Parent */}
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">1. Select Parent</label>
                            <select
                              value={bulkRegModal.parentEmail}
                              onChange={e => setBulkRegModal({ ...bulkRegModal, parentEmail: e.target.value, camperIds: [] })}
                              className="w-full px-4 py-2 border rounded-lg"
                            >
                              <option value="">-- Select a parent --</option>
                              {users.filter(u => u.role === 'parent' || u.roles?.includes('parent')).map(p => {
                                const camperCount = (camperParentLinks || []).filter(l => l.parentEmail === p.email).length;
                                return (
                                  <option key={p.email} value={p.email}>{p.name} ({p.email}) - {camperCount} campers</option>
                                );
                              })}
                            </select>
                          </div>

                          {/* Step 2: Select Campers */}
                          {bulkRegModal.parentEmail && (() => {
                            const linkedCamperIds = (camperParentLinks || []).filter(l => l.parentEmail === bulkRegModal.parentEmail).map(l => l.camperId);
                            const linkedCampers = (campers || []).filter(c => linkedCamperIds.includes(c.id));

                            return linkedCampers.length === 0 ? (
                              <div className="p-4 bg-yellow-50 rounded-lg text-yellow-800">
                                This parent has no campers. Add campers in the Parents tab first.
                              </div>
                            ) : (
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">2. Select Campers</label>
                                <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                  {linkedCampers.map(camper => (
                                    <label key={camper.id} className={`flex items-center gap-2 p-3 border rounded-lg cursor-pointer transition ${bulkRegModal.camperIds.includes(camper.id) ? 'bg-green-50 border-green-500' : 'hover:bg-gray-50'}`}>
                                      <input
                                        type="checkbox"
                                        checked={bulkRegModal.camperIds.includes(camper.id)}
                                        onChange={e => {
                                          const checked = e.target.checked;
                                          const camperId = camper.id;
                                          setBulkRegModal(prev => ({
                                            ...prev,
                                            camperIds: checked
                                              ? [...prev.camperIds, camperId]
                                              : prev.camperIds.filter(id => id !== camperId)
                                          }));
                                        }}
                                        className="w-4 h-4"
                                      />
                                      <span className="font-medium">{camper.name}</span>
                                    </label>
                                  ))}
                                </div>
                              </div>
                            );
                          })()}

                          {/* Step 3: Select Dates/Sessions */}
                          {bulkRegModal.camperIds.length > 0 && (() => {
                            // Get months from CAMP_DATES
                            const getMonths = () => {
                              const months = [];
                              CAMP_DATES.forEach(date => {
                                const d = new Date(date + 'T12:00:00');
                                const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                                if (!months.some(m => m.key === monthKey)) {
                                  months.push({ key: monthKey, name: d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) });
                                }
                              });
                              return months;
                            };
                            const months = getMonths();

                            // Use first month as fallback if bulkRegMonth not set (shouldn't happen since we set it on open)
                            const currentMonth = bulkRegMonth || (months.length > 0 ? months[0].key : null);

                            // Get dates for selected month
                            const monthDates = currentMonth ? CAMP_DATES.filter(date => {
                              const d = new Date(date + 'T12:00:00');
                              const [year, month] = currentMonth.split('-').map(Number);
                              return d.getFullYear() === year && d.getMonth() === month - 1;
                            }) : [];

                            // Group dates by week
                            const getWeekKey = (date) => {
                              const d = new Date(date + 'T12:00:00');
                              const startOfWeek = new Date(d);
                              startOfWeek.setDate(d.getDate() - d.getDay() + 1); // Monday
                              return startOfWeek.toISOString().split('T')[0];
                            };

                            const weekGroups = {};
                            monthDates.forEach(date => {
                              const weekKey = getWeekKey(date);
                              if (!weekGroups[weekKey]) weekGroups[weekKey] = [];
                              weekGroups[weekKey].push(date);
                            });

                            // Toggle functions - use functional updates to avoid stale state
                            const isSelected = (date, session) => bulkRegModal.selectedDates[date]?.includes(session);

                            const toggleSession = (date, session) => {
                              setBulkRegModal(prev => {
                                const current = prev.selectedDates[date] || [];
                                const newSessions = current.includes(session)
                                  ? current.filter(s => s !== session)
                                  : [...current, session];
                                const newSelectedDates = { ...prev.selectedDates };
                                if (newSessions.length > 0) {
                                  newSelectedDates[date] = newSessions;
                                } else {
                                  delete newSelectedDates[date];
                                }
                                return { ...prev, selectedDates: newSelectedDates };
                              });
                            };

                            const toggleDay = (date) => {
                              setBulkRegModal(prev => {
                                const current = prev.selectedDates[date] || [];
                                const allSelected = current.includes('morning') && current.includes('afternoon');
                                const newSelectedDates = { ...prev.selectedDates };
                                if (allSelected) {
                                  delete newSelectedDates[date];
                                } else {
                                  newSelectedDates[date] = ['morning', 'afternoon'];
                                }
                                return { ...prev, selectedDates: newSelectedDates };
                              });
                            };

                            const toggleWeek = (dates) => {
                              setBulkRegModal(prev => {
                                const allSelected = dates.every(d => {
                                  const current = prev.selectedDates[d] || [];
                                  return current.includes('morning') && current.includes('afternoon');
                                });
                                const newSelectedDates = { ...prev.selectedDates };
                                dates.forEach(d => {
                                  if (allSelected) {
                                    delete newSelectedDates[d];
                                  } else {
                                    newSelectedDates[d] = ['morning', 'afternoon'];
                                  }
                                });
                                return { ...prev, selectedDates: newSelectedDates };
                              });
                            };

                            // Count selections
                            const totalSessions = Object.values(bulkRegModal.selectedDates).reduce((sum, sessions) => sum + (sessions?.length || 0), 0);

                            return (
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">3. Select Sessions</label>

                                {/* Month tabs */}
                                <div className="flex flex-wrap gap-2 mb-4">
                                  {months.map(m => (
                                    <button
                                      key={m.key}
                                      onClick={() => setBulkRegMonth(m.key)}
                                      className={`px-4 py-2 rounded-lg text-sm ${currentMonth === m.key ? 'bg-green-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
                                    >
                                      {m.name}
                                    </button>
                                  ))}
                                </div>

                                {/* Week/Day/Session Grid */}
                                <div className="space-y-4">
                                  {Object.entries(weekGroups).map(([weekKey, dates]) => {
                                    const weekStart = new Date(weekKey + 'T12:00:00');
                                    const weekLabel = `Week of ${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                                    const allWeekSelected = dates.every(d => {
                                      const current = bulkRegModal.selectedDates[d] || [];
                                      return current.includes('morning') && current.includes('afternoon');
                                    });

                                    return (
                                      <div key={weekKey} className="border rounded-lg overflow-hidden">
                                        {/* Week Header */}
                                        <button
                                          onClick={() => toggleWeek(dates)}
                                          className={`w-full p-3 text-left font-bold flex justify-between items-center ${allWeekSelected ? 'bg-green-200 hover:bg-green-300' : 'bg-gray-100 hover:bg-gray-200'}`}
                                        >
                                          <span>{weekLabel}</span>
                                          <span className={`px-2 py-1 rounded text-sm ${allWeekSelected ? 'bg-green-600 text-white' : 'bg-gray-300'}`}>
                                            {allWeekSelected ? '‚úì Full Week' : 'Select Full Week'}
                                          </span>
                                        </button>

                                        {/* Days Grid */}
                                        <div className="grid grid-cols-5 gap-2 p-3">
                                          {dates.map(date => {
                                            const d = new Date(date + 'T12:00:00');
                                            const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                                            const dayNum = d.getDate();
                                            const amSelected = isSelected(date, 'morning');
                                            const pmSelected = isSelected(date, 'afternoon');
                                            const fullySelected = amSelected && pmSelected;
                                            const isBlocked = blockedSessions[date];

                                            return (
                                              <div key={date} className={`rounded-lg border-2 overflow-hidden ${fullySelected ? 'border-green-400 bg-green-50' : 'border-gray-200'}`}>
                                                {/* Day Header */}
                                                <button
                                                  onClick={() => toggleDay(date)}
                                                  className={`w-full p-2 text-center text-sm font-medium ${fullySelected ? 'bg-green-200 hover:bg-green-300' : 'bg-gray-50 hover:bg-gray-100'}`}
                                                >
                                                  <div className="text-xs text-gray-600">{dayName}</div>
                                                  <div>{dayNum}</div>
                                                </button>

                                                {/* Session Buttons */}
                                                <div className="p-1 space-y-1">
                                                  <button
                                                    onClick={() => toggleSession(date, 'morning')}
                                                    disabled={isBlocked?.morning}
                                                    className={`w-full py-2 rounded text-xs font-medium transition ${
                                                      isBlocked?.morning ? 'bg-gray-100 text-gray-400 cursor-not-allowed' :
                                                      amSelected ? 'bg-amber-100 border-2 border-amber-400 text-amber-800' : 'bg-white border border-gray-200 hover:border-amber-300'
                                                    }`}
                                                  >
                                                    ‚òÄÔ∏è AM {amSelected && '‚úì'}
                                                  </button>
                                                  <button
                                                    onClick={() => toggleSession(date, 'afternoon')}
                                                    disabled={isBlocked?.afternoon}
                                                    className={`w-full py-2 rounded text-xs font-medium transition ${
                                                      isBlocked?.afternoon ? 'bg-gray-100 text-gray-400 cursor-not-allowed' :
                                                      pmSelected ? 'bg-indigo-100 border-2 border-indigo-400 text-indigo-800' : 'bg-white border border-gray-200 hover:border-indigo-300'
                                                    }`}
                                                  >
                                                    üåô PM {pmSelected && '‚úì'}
                                                  </button>
                                                </div>
                                              </div>
                                            );
                                          })}
                                        </div>
                                      </div>
                                    );
                                  })}
                                </div>

                                {totalSessions > 0 && (
                                  <div className="mt-4 p-3 bg-green-50 rounded-lg text-green-800 text-sm">
                                    Selected: {totalSessions} session{totalSessions !== 1 ? 's' : ''} √ó {bulkRegModal.camperIds.length} camper{bulkRegModal.camperIds.length !== 1 ? 's' : ''} = {totalSessions * bulkRegModal.camperIds.length} registration{totalSessions * bulkRegModal.camperIds.length !== 1 ? 's' : ''}
                                  </div>
                                )}
                              </div>
                            );
                          })()}

                          {/* Actions */}
                          <div className="flex gap-4 pt-4 border-t">
                            <button
                              onClick={() => setBulkRegModal(null)}
                              className="flex-1 py-3 border-2 border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
                            >
                              Cancel
                            </button>
                            <button
                              onClick={async () => {
                                if (!bulkRegModal.parentEmail || bulkRegModal.camperIds.length === 0) return;
                                const parent = users.find(u => u.email === bulkRegModal.parentEmail);
                                const linkedCamperIds = (camperParentLinks || []).filter(l => l.parentEmail === bulkRegModal.parentEmail).map(l => l.camperId);
                                const allCampers = (campers || []).filter(c => linkedCamperIds.includes(c.id));

                                const newRegs = [];
                                let regIndex = 0;
                                bulkRegModal.camperIds.forEach(camperId => {
                                  const camper = allCampers.find(c => c.id === camperId);
                                  Object.entries(bulkRegModal.selectedDates).forEach(([date, sessions]) => {
                                    if (sessions && sessions.length > 0) {
                                      newRegs.push({
                                        id: 'reg_' + Date.now() + '_' + (regIndex++) + '_' + Math.random().toString(36).substr(2, 9),
                                        camperId,
                                        camperName: camper?.name || 'Unknown',
                                        parentEmail: bulkRegModal.parentEmail,
                                        parentName: parent?.name,
                                        date,
                                        sessions,
                                        status: 'pending',
                                        paymentStatus: 'unpaid',
                                        createdAt: new Date().toISOString(),
                                        createdBy: 'admin'
                                      });
                                    }
                                  });
                                });

                                // Save all registrations at once to avoid stale closure issue
                                const allRegs = [...registrations, ...newRegs];
                                setRegistrations(allRegs);
                                for (const reg of newRegs) {
                                  await storage.set('camp_registrations', reg.id, reg);
                                }

                                addToHistory('Admin', `Created ${newRegs.length} registration(s) for ${parent?.name}`);
                                showToast(`Created ${newRegs.length} registration(s)!`);
                                setBulkRegModal(null);
                                setBulkRegMonth(null);
                              }}
                              disabled={!bulkRegModal.parentEmail || bulkRegModal.camperIds.length === 0 || Object.values(bulkRegModal.selectedDates).filter(s => s?.length > 0).length === 0}
                              className="flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed font-medium"
                            >
                              Create Registrations
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Registration Details Modal */}
                  {viewRegModal && (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={() => setViewRegModal(null)}>
                      <div className="bg-white rounded-xl max-w-lg w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="sticky top-0 bg-green-600 text-white px-6 py-4 flex justify-between items-center z-10">
                          <h2 className="font-display text-xl">Registration Details</h2>
                          <button onClick={() => setViewRegModal(null)} className="text-2xl hover:bg-green-500 rounded px-2">√ó</button>
                        </div>
                        <div className="p-6 space-y-4">
                          {/* Status Badge */}
                          <div className="flex items-center justify-between">
                            <span className={'px-3 py-1 rounded-full text-sm font-medium ' + (
                              viewRegModal.status === 'approved' ? 'bg-green-100 text-green-800' :
                              viewRegModal.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                              viewRegModal.status === 'rejected' ? 'bg-red-100 text-red-800' :
                              'bg-gray-100 text-gray-800'
                            )}>
                              {viewRegModal.status?.toUpperCase()}
                            </span>
                            <span className={'px-3 py-1 rounded-full text-sm font-medium ' + (
                              viewRegModal.paymentStatus === 'paid' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                            )}>
                              {viewRegModal.paymentStatus === 'paid' ? 'üíµ PAID' : '‚ö†Ô∏è UNPAID'}
                            </span>
                          </div>

                          {/* Camper Name */}
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Camper Name</label>
                            <div className="w-full px-4 py-2 bg-gray-50 border rounded-lg text-gray-800">{viewRegModal.camperName || viewRegModal.childName || 'N/A'}</div>
                          </div>

                          {/* Parent Info */}
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">Parent Name</label>
                              <div className="w-full px-4 py-2 bg-gray-50 border rounded-lg text-gray-800">{viewRegModal.parentName || 'N/A'}</div>
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">Parent Email</label>
                              <div className="w-full px-4 py-2 bg-gray-50 border rounded-lg text-gray-800">{viewRegModal.parentEmail || 'N/A'}</div>
                            </div>
                          </div>

                          {/* Session Date */}
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Session Date</label>
                            <div className="w-full px-4 py-2 bg-gray-50 border rounded-lg text-gray-800">
                              {viewRegModal.date ? new Date(viewRegModal.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) : 'N/A'}
                            </div>
                          </div>

                          {/* Sessions */}
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Sessions</label>
                            <div className="flex gap-4">
                              <label className={`flex-1 flex items-center justify-center gap-2 p-3 border-2 rounded-lg cursor-pointer transition ${
                                viewRegModal.sessions?.includes('morning') ? 'bg-amber-50 border-amber-400' : 'hover:bg-gray-50'
                              }`}>
                                <input
                                  type="checkbox"
                                  checked={viewRegModal.sessions?.includes('morning')}
                                  onChange={e => {
                                    const sessions = viewRegModal.sessions || [];
                                    setViewRegModal({
                                      ...viewRegModal,
                                      sessions: e.target.checked
                                        ? [...sessions.filter(s => s !== 'morning'), 'morning']
                                        : sessions.filter(s => s !== 'morning')
                                    });
                                  }}
                                  className="sr-only"
                                />
                                <span className="text-lg">‚òÄÔ∏è</span>
                                <span className="font-medium">Morning (AM)</span>
                              </label>
                              <label className={`flex-1 flex items-center justify-center gap-2 p-3 border-2 rounded-lg cursor-pointer transition ${
                                viewRegModal.sessions?.includes('afternoon') ? 'bg-indigo-50 border-indigo-400' : 'hover:bg-gray-50'
                              }`}>
                                <input
                                  type="checkbox"
                                  checked={viewRegModal.sessions?.includes('afternoon')}
                                  onChange={e => {
                                    const sessions = viewRegModal.sessions || [];
                                    setViewRegModal({
                                      ...viewRegModal,
                                      sessions: e.target.checked
                                        ? [...sessions.filter(s => s !== 'afternoon'), 'afternoon']
                                        : sessions.filter(s => s !== 'afternoon')
                                    });
                                  }}
                                  className="sr-only"
                                />
                                <span className="text-lg">üåô</span>
                                <span className="font-medium">Afternoon (PM)</span>
                              </label>
                            </div>
                          </div>

                          {/* Payment Status Toggle */}
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Payment Status</label>
                            <button
                              onClick={() => setViewRegModal({
                                ...viewRegModal,
                                paymentStatus: viewRegModal.paymentStatus === 'paid' ? 'unpaid' : 'paid'
                              })}
                              className={`w-full py-3 rounded-lg font-medium transition ${
                                viewRegModal.paymentStatus === 'paid'
                                  ? 'bg-green-100 text-green-800 hover:bg-green-200'
                                  : 'bg-red-100 text-red-800 hover:bg-red-200'
                              }`}
                            >
                              {viewRegModal.paymentStatus === 'paid' ? '‚úì Payment Received - Click to Mark Unpaid' : '‚ö†Ô∏è Payment Pending - Click to Mark Paid'}
                            </button>
                          </div>

                          {/* Metadata */}
                          <div className="text-xs text-gray-500 border-t pt-4 space-y-1">
                            <div>Registration ID: {viewRegModal.id}</div>
                            <div>Created: {viewRegModal.createdAt ? new Date(viewRegModal.createdAt).toLocaleString() : 'N/A'}</div>
                            {viewRegModal.createdBy && <div>Created by: {viewRegModal.createdBy}</div>}
                            {viewRegModal.cancelledAt && <div>Cancelled: {new Date(viewRegModal.cancelledAt).toLocaleString()}</div>}
                          </div>

                          {/* Actions */}
                          <div className="flex flex-wrap gap-2 pt-4 border-t">
                            {/* Save Changes */}
                            <button
                              onClick={async () => {
                                await saveReg(viewRegModal, `Updated registration for ${viewRegModal.camperName || viewRegModal.childName}`);
                                showToast('Registration updated!');
                                setViewRegModal(null);
                              }}
                              className="flex-1 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium"
                            >
                              Save Changes
                            </button>

                            {/* Status Actions */}
                            {viewRegModal.status === 'pending' && (
                              <>
                                <button
                                  onClick={async () => {
                                    await saveReg({ ...viewRegModal, status: 'approved' }, `Approved ${viewRegModal.camperName || viewRegModal.childName} for ${viewRegModal.date}`);
                                    showToast('Approved!');
                                    setViewRegModal(null);
                                  }}
                                  className="py-3 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium"
                                >
                                  Approve
                                </button>
                                <button
                                  onClick={async () => {
                                    await saveReg({ ...viewRegModal, status: 'rejected' }, `Rejected ${viewRegModal.camperName || viewRegModal.childName} for ${viewRegModal.date}`);
                                    showToast('Rejected');
                                    setViewRegModal(null);
                                  }}
                                  className="py-3 px-4 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 font-medium"
                                >
                                  Reject
                                </button>
                              </>
                            )}

                            {viewRegModal.status === 'approved' && (
                              <button
                                onClick={async () => {
                                  await saveReg({ ...viewRegModal, status: 'cancelled', cancelledAt: new Date().toISOString() }, `Cancelled ${viewRegModal.camperName || viewRegModal.childName} for ${viewRegModal.date}`);
                                  showToast('Cancelled');
                                  setViewRegModal(null);
                                }}
                                className="py-3 px-4 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 font-medium"
                              >
                                Cancel Registration
                              </button>
                            )}

                            {(viewRegModal.status === 'rejected' || viewRegModal.status === 'cancelled') && (
                              <button
                                onClick={async () => {
                                  await saveReg({ ...viewRegModal, status: 'pending', cancelledAt: null }, `Restored ${viewRegModal.camperName || viewRegModal.childName} to pending`);
                                  showToast('Restored to pending');
                                  setViewRegModal(null);
                                }}
                                className="py-3 px-4 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 font-medium"
                              >
                                Restore to Pending
                              </button>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {adminTab === 'counselors' && (
                <div>
                  <div className="flex justify-between items-center mb-4">
                    <div>
                      <h2 className="font-bold text-xl">Counselors</h2>
                      <p className="text-sm text-gray-500">Manage counselor profiles and work eligibility</p>
                    </div>
                    <button onClick={() => { setEditCounselor({ name: '', email: '', phone: '', position: '', year: '', bio: '', photo: null, visible: true }); setShowModal(true); }} className="bg-green-600 text-white px-4 py-2 rounded-lg">+ Add</button>
                  </div>
                  <div className="space-y-3">
                    {counselors.map((c, idx) => {
                      const eligibleCount = getCounselorEligibleCount(c.id);
                      const scheduledCount = getCounselorScheduledCount(c.id);
                      return (
                      <div key={c.id} className="bg-white rounded-xl shadow p-4">
                        <div className="flex items-center gap-4">
                          {/* Reorder buttons */}
                          <div className="flex flex-col gap-1">
                            <button
                              onClick={() => {
                                if (idx === 0) return;
                                const newOrder = [...counselors];
                                [newOrder[idx - 1], newOrder[idx]] = [newOrder[idx], newOrder[idx - 1]];
                                const reordered = newOrder.map((co, i) => ({ ...co, order: i }));
                                saveCounselors(reordered, `Moved ${c.name} up`);
                              }}
                              disabled={idx === 0}
                              className={'w-7 h-7 rounded flex items-center justify-center text-sm ' + (idx === 0 ? 'bg-gray-100 text-gray-300 cursor-not-allowed' : 'bg-gray-200 hover:bg-gray-300 text-gray-600')}
                              title="Move up"
                            >‚ñ≤</button>
                            <button
                              onClick={() => {
                                if (idx === counselors.length - 1) return;
                                const newOrder = [...counselors];
                                [newOrder[idx], newOrder[idx + 1]] = [newOrder[idx + 1], newOrder[idx]];
                                const reordered = newOrder.map((co, i) => ({ ...co, order: i }));
                                saveCounselors(reordered, `Moved ${c.name} down`);
                              }}
                              disabled={idx === counselors.length - 1}
                              className={'w-7 h-7 rounded flex items-center justify-center text-sm ' + (idx === counselors.length - 1 ? 'bg-gray-100 text-gray-300 cursor-not-allowed' : 'bg-gray-200 hover:bg-gray-300 text-gray-600')}
                              title="Move down"
                            >‚ñº</button>
                          </div>

                          {/* Position number */}
                          <div className="w-8 h-8 rounded-full bg-green-100 text-green-700 flex items-center justify-center font-bold text-sm">
                            {idx + 1}
                          </div>

                          {/* Photo */}
                          {c.photo ? <img src={c.photo} className="w-14 h-14 rounded-full object-cover" /> : <div className="w-14 h-14 rounded-full bg-green-200 flex items-center justify-center text-xl">{c.name[0]}</div>}

                          {/* Info */}
                          <div className="flex-1">
                            <div className="font-bold">{c.name}</div>
                            <div className="text-sm text-gray-600">{c.position} ‚Ä¢ {c.year}</div>
                            <div className="flex gap-2 mt-1 flex-wrap">
                              {!c.visible && <span className="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded">Hidden</span>}
                              {eligibleCount > 0 && (
                                <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">
                                  üìÖ {eligibleCount} session{eligibleCount !== 1 ? 's' : ''} eligible
                                </span>
                              )}
                              {scheduledCount > 0 ? (
                                <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">
                                  ‚úì Working {scheduledCount} session{scheduledCount !== 1 ? 's' : ''}
                                </span>
                              ) : eligibleCount > 0 ? (
                                <span className="text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded">
                                  No campers assigned yet
                                </span>
                              ) : null}
                            </div>
                          </div>

                          {/* Actions */}
                          <div className="flex gap-2 flex-wrap justify-end">
                            <button onClick={() => { setManagingSchedule(c); setScheduleMonth(null); }} className="px-3 py-1 bg-purple-50 text-purple-600 rounded hover:bg-purple-100 text-sm">Edit Schedule</button>
                            <button onClick={() => { setEditCounselor(c); setShowModal(true); }} className="px-3 py-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 text-sm">Edit Profile</button>
                          </div>
                        </div>
                      </div>
                    )})}
                  </div>
                  {counselors.length === 0 && (
                    <div className="text-center py-12 text-gray-500">
                      <p>No counselors yet. Click "+ Add" to add your first counselor.</p>
                    </div>
                  )}

                  {/* Schedule Modal */}
                  {managingSchedule && (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                      <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="bg-purple-600 text-white px-6 py-4">
                          <h2 className="font-display text-xl">Set Work Eligibility</h2>
                          <p className="text-purple-200 text-sm">{managingSchedule.name}</p>
                        </div>
                        <div className="p-4 overflow-y-auto max-h-[calc(90vh-120px)]">
                          <p className="text-sm text-gray-600 mb-4">
                            Mark which sessions this counselor is eligible to work. They will only be scheduled if a camper is assigned to them.
                          </p>

                          {/* Month selector */}
                          <div className="flex gap-2 mb-4">
                            {(() => {
                              const months = [...new Set(CAMP_DATES.map(d => {
                                const date = new Date(d + 'T12:00:00');
                                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                              }))];
                              if (!scheduleMonth && months.length > 0) {
                                setTimeout(() => setScheduleMonth(months[0]), 0);
                              }
                              return months.map(m => {
                                const [year, month] = m.split('-');
                                const label = new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short' });
                                return (
                                  <button
                                    key={m}
                                    onClick={() => setScheduleMonth(m)}
                                    className={`px-4 py-2 rounded-lg font-medium ${scheduleMonth === m ? 'bg-purple-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
                                  >
                                    {label}
                                  </button>
                                );
                              });
                            })()}
                          </div>

                          {/* Date Grid - matches Sessions tab style */}
                          {scheduleMonth && (() => {
                            const [year, month] = scheduleMonth.split('-').map(Number);
                            const monthDates = CAMP_DATES.filter(d => {
                              const date = new Date(d + 'T12:00:00');
                              return date.getFullYear() === year && date.getMonth() + 1 === month;
                            });

                            const getDayName = (d) => new Date(d + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short' });
                            const formatDateShort = (d) => new Date(d + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                            return (
                              <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                                {monthDates.map(d => {
                                  const morningBlocked = isSessionBlocked(d, 'morning');
                                  const afternoonBlocked = isSessionBlocked(d, 'afternoon');
                                  const fullyBlocked = morningBlocked && afternoonBlocked;
                                  const morningEligible = counselorSchedule[managingSchedule.id]?.[d]?.morning === true;
                                  const afternoonEligible = counselorSchedule[managingSchedule.id]?.[d]?.afternoon === true;
                                  const bothEligible = morningEligible && afternoonEligible;
                                  const partialEligible = (morningEligible || afternoonEligible) && !bothEligible;

                                  // Check if counselor has campers assigned
                                  const morningAssigned = (assignments[`${d}_morning`]?.[managingSchedule.id]?.length || 0) > 0;
                                  const afternoonAssigned = (assignments[`${d}_afternoon`]?.[managingSchedule.id]?.length || 0) > 0;

                                  return (
                                    <div
                                      key={d}
                                      className={`rounded-lg border-2 overflow-hidden ${
                                        fullyBlocked ? 'border-gray-300 bg-gray-50' :
                                        bothEligible ? 'border-green-300 bg-green-50' :
                                        partialEligible ? 'border-yellow-300 bg-yellow-50' :
                                        'border-gray-200 bg-white'
                                      }`}
                                    >
                                      {/* Date Header - Click to toggle whole day */}
                                      <button
                                        onClick={() => !fullyBlocked && toggleCounselorDay(managingSchedule.id, d)}
                                        disabled={fullyBlocked}
                                        className={`w-full p-2 text-center font-bold transition-colors ${
                                          fullyBlocked ? 'bg-gray-200 cursor-not-allowed' :
                                          bothEligible ? 'bg-green-200 hover:bg-green-300' :
                                          partialEligible ? 'bg-yellow-200 hover:bg-yellow-300' :
                                          'bg-gray-100 hover:bg-gray-200'
                                        }`}
                                      >
                                        <div className="text-xs text-gray-600">{getDayName(d)}</div>
                                        <div>{formatDateShort(d)}</div>
                                      </button>

                                      {/* Session Buttons */}
                                      <div className="p-2 space-y-2">
                                        {/* Morning Session */}
                                        <button
                                          onClick={() => !morningBlocked && toggleCounselorEligibility(managingSchedule.id, d, 'morning')}
                                          disabled={morningBlocked}
                                          className={`w-full p-2 rounded text-left text-sm transition-colors ${
                                            morningBlocked ? 'bg-gray-100 cursor-not-allowed' :
                                            morningEligible ? 'bg-green-100 hover:bg-green-200' : 'bg-white hover:bg-gray-50'
                                          }`}
                                        >
                                          <div className="flex justify-between items-center">
                                            <span className="font-medium">‚òÄÔ∏è AM</span>
                                            <span className={morningBlocked ? 'text-gray-400' : morningEligible ? 'text-green-600' : 'text-gray-400'}>
                                              {morningBlocked ? 'üö´' : morningEligible ? '‚úì' : '‚óã'}
                                            </span>
                                          </div>
                                          {morningAssigned && (
                                            <div className="text-xs text-green-600 mt-1">üèïÔ∏è Has campers</div>
                                          )}
                                        </button>

                                        {/* Afternoon Session */}
                                        <button
                                          onClick={() => !afternoonBlocked && toggleCounselorEligibility(managingSchedule.id, d, 'afternoon')}
                                          disabled={afternoonBlocked}
                                          className={`w-full p-2 rounded text-left text-sm transition-colors ${
                                            afternoonBlocked ? 'bg-gray-100 cursor-not-allowed' :
                                            afternoonEligible ? 'bg-green-100 hover:bg-green-200' : 'bg-white hover:bg-gray-50'
                                          }`}
                                        >
                                          <div className="flex justify-between items-center">
                                            <span className="font-medium">üåô PM</span>
                                            <span className={afternoonBlocked ? 'text-gray-400' : afternoonEligible ? 'text-green-600' : 'text-gray-400'}>
                                              {afternoonBlocked ? 'üö´' : afternoonEligible ? '‚úì' : '‚óã'}
                                            </span>
                                          </div>
                                          {afternoonAssigned && (
                                            <div className="text-xs text-green-600 mt-1">üèïÔ∏è Has campers</div>
                                          )}
                                        </button>
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                            );
                          })()}

                          <div className="mt-4 p-3 bg-gray-50 rounded-lg text-sm text-gray-600">
                            <strong>Legend:</strong> ‚úì = Eligible to work ‚Ä¢ üö´ = Session blocked ‚Ä¢ üèïÔ∏è = Has campers assigned
                          </div>
                        </div>
                        <div className="p-4 border-t">
                          <button onClick={() => setManagingSchedule(null)} className="w-full py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Done</button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {adminTab === 'approval' && (
                <div className="space-y-6">
                  {/* Pending Registration Approvals */}
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold text-xl text-green-800 mb-4">üìã Pending Registration Approvals</h3>
                    <p className="text-sm text-gray-500 mb-4">Review and approve camper registrations. Verify payment has been received before approving.</p>

                    {registrations.filter(r => r.status === 'pending').length === 0 ? (
                      <div className="text-center py-8 text-gray-500">
                        <p className="text-4xl mb-2">‚úì</p>
                        <p>No pending registration approvals</p>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        {registrations.filter(r => r.status === 'pending').map(reg => {
                          const parent = users.find(u => u.email === reg.parentEmail);
                          return (
                            <div key={reg.id} className="border-2 border-green-200 rounded-xl p-4 bg-green-50">
                              <div className="flex items-start gap-4">
                                <div className="flex-1">
                                  <h4 className="font-bold text-lg">{reg.childName}</h4>
                                  <p className="text-gray-600">
                                    {new Date(reg.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                                    {' ‚Ä¢ '}
                                    {reg.sessions?.map(s => s === 'morning' ? '‚òÄÔ∏è AM' : 'üåô PM').join(' + ')}
                                  </p>
                                  <p className="text-sm text-gray-500 mt-1">Parent: {parent?.name || reg.parentName} ({reg.parentEmail})</p>
                                  <p className="text-xs text-gray-400 mt-1">Requested: {reg.createdAt ? new Date(reg.createdAt).toLocaleDateString() : 'Unknown'}</p>
                                </div>
                                <div className="flex flex-col gap-2">
                                  <button
                                    onClick={async () => {
                                      if (!confirm(`Approve registration for ${reg.childName}?\n\nPlease verify that payment has been received before approving.`)) return;
                                      const updated = { ...reg, status: 'approved', approvedAt: new Date().toISOString(), approvedBy: user?.name };
                                      await saveReg(updated);
                                      addToHistory('Approval', `Approved registration for ${reg.childName} on ${reg.date}`);
                                      showToast(`Registration approved for ${reg.childName}!`);
                                    }}
                                    className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium"
                                  >
                                    ‚úì Approve
                                  </button>
                                  <button
                                    onClick={async () => {
                                      if (!confirm(`Reject registration for ${reg.childName}?`)) return;
                                      const updated = { ...reg, status: 'rejected', rejectedAt: new Date().toISOString(), rejectedBy: user?.name };
                                      await saveReg(updated);
                                      addToHistory('Approval', `Rejected registration for ${reg.childName} on ${reg.date}`);
                                      showToast(`Registration rejected.`);
                                    }}
                                    className="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 font-medium"
                                  >
                                    ‚úó Reject
                                  </button>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>

                  {/* Pending Counselor Approvals */}
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold text-xl text-orange-800 mb-4">üèÄ Pending Counselor Approvals</h3>
                    <p className="text-sm text-gray-500 mb-4">New counselor applications awaiting your approval. Approved counselors will appear on the public website.</p>

                    {counselors.filter(c => c.approvedByAdmin === false).length === 0 ? (
                      <div className="text-center py-8 text-gray-500">
                        <p className="text-4xl mb-2">‚úì</p>
                        <p>No pending counselor approvals</p>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        {counselors.filter(c => c.approvedByAdmin === false).map(counselor => (
                          <div key={counselor.id} className="border-2 border-orange-200 rounded-xl p-4 bg-orange-50">
                            <div className="flex items-start gap-4">
                              {counselor.photo ? (
                                <img src={counselor.photo} className="w-20 h-20 rounded-full object-cover border-2 border-white shadow" />
                              ) : (
                                <div className="w-20 h-20 rounded-full bg-orange-200 flex items-center justify-center text-2xl">
                                  {counselor.name?.[0]}
                                </div>
                              )}
                              <div className="flex-1">
                                <h4 className="font-bold text-lg">{counselor.name}</h4>
                                <p className="text-gray-600">{counselor.position} ‚Ä¢ {counselor.year}</p>
                                <p className="text-sm text-gray-500 mt-1">{counselor.email} ‚Ä¢ {counselor.phone}</p>
                                <p className="text-sm text-gray-700 mt-2 bg-white rounded p-2">"{counselor.bio}"</p>
                                <p className="text-xs text-gray-400 mt-2">Applied: {counselor.createdAt ? new Date(counselor.createdAt).toLocaleDateString() : 'Unknown'}</p>
                              </div>
                              <div className="flex flex-col gap-2">
                                <button
                                  onClick={async () => {
                                    const updated = counselors.map(c =>
                                      c.id === counselor.id
                                        ? { ...c, approvedByAdmin: true, visible: true, approvedAt: new Date().toISOString(), approvedBy: user?.name }
                                        : c
                                    );
                                    await saveCounselors(updated, `Approved counselor ${counselor.name}`);
                                    showToast(`${counselor.name} approved! Now visible on website.`);
                                  }}
                                  className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium"
                                >
                                  ‚úì Approve
                                </button>
                                <button
                                  onClick={async () => {
                                    if (!confirm(`Reject ${counselor.name}'s application? This will delete their profile.`)) return;
                                    const updated = counselors.filter(c => c.id !== counselor.id);
                                    await saveCounselors(updated, `Rejected counselor ${counselor.name}`);
                                    // Also remove their user account
                                    const updatedUsers = users.filter(u => u.email !== counselor.email);
                                    await saveUsers(updatedUsers);
                                    showToast(`${counselor.name}'s application rejected.`);
                                  }}
                                  className="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 font-medium"
                                >
                                  ‚úó Reject
                                </button>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>

                  {/* Counselor Profile Change Requests */}
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold text-xl text-blue-800 mb-4">üìù Counselor Profile Change Requests</h3>
                    <p className="text-sm text-gray-500 mb-4">Counselors who want to update their public profile information.</p>

                    {profileChangeRequests.filter(r => r.status === 'pending').length === 0 ? (
                      <div className="text-center py-8 text-gray-500">
                        <p className="text-4xl mb-2">‚úì</p>
                        <p>No pending profile change requests</p>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        {profileChangeRequests.filter(r => r.status === 'pending').map(request => {
                          const counselor = counselors.find(c => c.id === request.counselorId);
                          return (
                            <div key={request.id} className="border-2 border-blue-200 rounded-xl p-4 bg-blue-50">
                              <div className="flex justify-between items-start mb-3">
                                <div>
                                  <h4 className="font-bold">{counselor?.name || 'Unknown'}</h4>
                                  <p className="text-sm text-gray-500">Requested: {new Date(request.requestedAt).toLocaleDateString()}</p>
                                </div>
                                <div className="flex gap-2">
                                  <button
                                    onClick={async () => {
                                      // Apply changes to counselor
                                      const updated = counselors.map(c =>
                                        c.id === request.counselorId
                                          ? { ...c, ...request.pendingChanges }
                                          : c
                                      );
                                      await saveCounselors(updated, `Approved profile changes for ${counselor?.name}`);
                                      // Update request status
                                      const updatedReqs = profileChangeRequests.map(r =>
                                        r.id === request.id
                                          ? { ...r, status: 'approved', reviewedAt: new Date().toISOString(), reviewedBy: user?.name }
                                          : r
                                      );
                                      await saveProfileChangeRequests(updatedReqs);
                                      showToast('Profile changes approved!');
                                    }}
                                    className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm"
                                  >
                                    Approve
                                  </button>
                                  <button
                                    onClick={async () => {
                                      const updatedReqs = profileChangeRequests.map(r =>
                                        r.id === request.id
                                          ? { ...r, status: 'rejected', reviewedAt: new Date().toISOString(), reviewedBy: user?.name }
                                          : r
                                      );
                                      await saveProfileChangeRequests(updatedReqs);
                                      showToast('Profile changes rejected.');
                                    }}
                                    className="px-3 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200 text-sm"
                                  >
                                    Reject
                                  </button>
                                </div>
                              </div>
                              <div className="grid grid-cols-2 gap-2 text-sm">
                                {Object.entries(request.pendingChanges || {}).map(([field, value]) => (
                                  <div key={field} className="bg-white p-2 rounded">
                                    <span className="text-gray-500">{field}:</span>
                                    <div className="font-medium">{typeof value === 'string' && value.startsWith('data:') ? '[Photo]' : value}</div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>

                  {/* Availability Change Requests */}
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold text-xl text-purple-800 mb-4">üìÖ Availability Change Requests</h3>
                    <p className="text-sm text-gray-500 mb-4">Counselors who want to change which sessions they can work.</p>

                    {availabilityChangeRequests.filter(r => r.status === 'pending').length === 0 ? (
                      <div className="text-center py-8 text-gray-500">
                        <p className="text-4xl mb-2">‚úì</p>
                        <p>No pending availability change requests</p>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        {availabilityChangeRequests.filter(r => r.status === 'pending').map(request => (
                          <div key={request.id} className="border-2 border-purple-200 rounded-xl p-4 bg-purple-50">
                            <div className="flex justify-between items-start mb-3">
                              <div>
                                <h4 className="font-bold">{request.counselorName}</h4>
                                <p className="text-sm text-gray-500">Requested: {new Date(request.requestedAt).toLocaleDateString()}</p>
                              </div>
                              <div className="flex gap-2">
                                <button
                                  onClick={async () => {
                                    // Apply new availability
                                    const newAvail = { ...availability, [request.counselorId]: request.requestedAvailability };
                                    await saveAvail(newAvail);
                                    // Update request status
                                    const updatedReqs = availabilityChangeRequests.map(r =>
                                      r.id === request.id
                                        ? { ...r, status: 'approved', reviewedAt: new Date().toISOString(), reviewedBy: user?.name }
                                        : r
                                    );
                                    await saveAvailabilityChangeRequests(updatedReqs);
                                    showToast('Availability changes approved!');
                                  }}
                                  className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm"
                                >
                                  Approve
                                </button>
                                <button
                                  onClick={async () => {
                                    const updatedReqs = availabilityChangeRequests.map(r =>
                                      r.id === request.id
                                        ? { ...r, status: 'rejected', reviewedAt: new Date().toISOString(), reviewedBy: user?.name }
                                        : r
                                    );
                                    await saveAvailabilityChangeRequests(updatedReqs);
                                    showToast('Availability changes rejected.');
                                  }}
                                  className="px-3 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200 text-sm"
                                >
                                  Reject
                                </button>
                              </div>
                            </div>
                            {request.changes && (
                              <div className="text-sm">
                                <p className="font-medium mb-1">Changes:</p>
                                <ul className="list-disc list-inside text-gray-600">
                                  {request.changes.slice(0, 5).map((change, idx) => (
                                    <li key={idx}>
                                      {change.action === 'add' ? '+ Adding' : '- Removing'} {change.session} on {change.date}
                                    </li>
                                  ))}
                                  {request.changes.length > 5 && (
                                    <li className="text-gray-400">...and {request.changes.length - 5} more changes</li>
                                  )}
                                </ul>
                              </div>
                            )}
                            {request.impactAnalysis?.affectedCampers?.length > 0 && (
                              <div className="mt-3 p-2 bg-yellow-100 rounded text-sm text-yellow-800">
                                ‚ö†Ô∏è {request.impactAnalysis.affectedCampers.length} camper(s) would need reassignment
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {adminTab === 'content' && (
                <div className="space-y-6">
                  <div className="bg-green-100 border-l-4 border-green-600 p-4 rounded-lg">
                    <p className="text-green-800"><strong>Auto-save enabled:</strong> Changes are saved automatically when you click outside the field</p>
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold mb-4">Hero Section</h3>
                    <div className="grid md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Title</label>
                        <StableInput value={content.heroTitle} onSave={(v) => updateContent('heroTitle', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Subtitle</label>
                        <StableInput value={content.heroSubtitle} onSave={(v) => updateContent('heroSubtitle', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div className="md:col-span-2">
                        <label className="block text-sm text-gray-600 mb-1">Tagline</label>
                        <StableInput value={content.heroTagline} onSave={(v) => updateContent('heroTagline', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold mb-4">Details</h3>
                    <div className="grid md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Session Cost</label>
                        <StableInput value={content.sessionCost} onSave={(v) => updateContent('sessionCost', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Venmo Username</label>
                        <StableInput value={content.venmoUsername} onSave={(v) => updateContent('venmoUsername', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Morning Session</label>
                        <StableInput value={content.sessionMorning} onSave={(v) => updateContent('sessionMorning', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Afternoon Session</label>
                        <StableInput value={content.sessionAfternoon} onSave={(v) => updateContent('sessionAfternoon', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Camp Dates</label>
                        <StableInput value={content.campDates} onSave={(v) => updateContent('campDates', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Age Range</label>
                        <StableInput value={content.ageRange} onSave={(v) => updateContent('ageRange', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold mb-4">Contact</h3>
                    <div className="grid md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Email</label>
                        <StableInput value={content.contactEmail} onSave={(v) => updateContent('contactEmail', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Phone</label>
                        <StableInput value={content.contactPhone} onSave={(v) => updateContent('contactPhone', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div className="md:col-span-2">
                        <label className="block text-sm text-gray-600 mb-1">Location Address</label>
                        <StableTextarea value={content.locationAddress} onSave={(v) => updateContent('locationAddress', v)} className="w-full px-3 py-2 border rounded-lg" rows={3} />
                      </div>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold mb-4">About</h3>
                    <label className="block text-sm text-gray-600 mb-1">About Text</label>
                    <StableTextarea value={content.aboutText} onSave={(v) => updateContent('aboutText', v)} className="w-full px-3 py-2 border rounded-lg" rows={4} />
                  </div>

                  {/* Site Photos Management (Hero, Drop-off, Layups, Lunch) */}
                  <SitePhotosManager
                    sitePhotos={sitePhotos}
                    onSave={saveSitePhotos}
                  />

                  {/* Food Photos Management */}
                  <FoodPhotosManager
                    foodPhotos={foodPhotos}
                    getFoodPhoto={getFoodPhoto}
                    onSave={saveFoodPhotos}
                  />
                </div>
              )}

              {adminTab === 'parents' && (
                <ParentsTab
                  users={users}
                  registrations={registrations}
                  messages={messages}
                  onSendMessage={saveMessage}
                  onUpdateUsers={saveUsers}
                  onDeleteParent={deleteParent}
                  onUpdateRegistrations={saveReg}
                  onDeleteRegistration={async (reg) => {
                    // Remove from registrations
                    setRegistrations(registrations.filter(r => r.id !== reg.id));
                    await supabase.from('camp_registrations').delete().eq('id', reg.id);

                    // Clean up assignments for this child on this date/sessions
                    if (reg.childId && reg.date && reg.sessions) {
                      const updatedAssignments = { ...assignments };
                      reg.sessions.forEach(session => {
                        const key = `${reg.date}_${session}`;
                        if (updatedAssignments[key]) {
                          Object.keys(updatedAssignments[key]).forEach(counselorId => {
                            updatedAssignments[key][counselorId] = updatedAssignments[key][counselorId].filter(id => id !== reg.childId);
                          });
                        }
                      });
                      setAssignments(updatedAssignments);
                      await storage.set('camp_assignments', 'main', updatedAssignments);
                    }
                  }}
                  showToast={showToast}
                  addToHistory={addToHistory}
                  campers={campers}
                  camperParentLinks={camperParentLinks}
                  onSaveLinks={saveCamperParentLinks}
                  onSaveCampers={saveCampers}
                  onSaveCamperParentLinks={saveCamperParentLinks}
                  emergencyContacts={emergencyContacts}
                  saveEmergencyContacts={saveEmergencyContacts}
                  saveOnboardingProgress={saveOnboardingProgress}
                />
              )}

              {adminTab === 'admins' && (
                <AdminsTab
                  admins={admins}
                  currentAdminId={user?.adminId}
                  onSave={saveAdmins}
                  showToast={showToast}
                />
              )}

              {adminTab === 'campers' && (
                <CampersTab
                  users={users}
                  registrations={registrations}
                  campers={campers}
                  camperParentLinks={camperParentLinks}
                  onSaveCampers={saveCampers}
                  onSaveLinks={saveCamperParentLinks}
                  onDeleteCamper={deleteCamper}
                  showToast={showToast}
                  addToHistory={addToHistory}
                />
              )}

              {adminTab === 'assignments' && (
                <AssignmentsTab
                  registrations={registrations}
                  counselors={counselors}
                  users={users}
                  assignments={assignments}
                  availability={availability}
                  onSaveAssignments={saveAssignments}
                  showToast={showToast}
                  selectedMonth={assignmentsTabMonth}
                  setSelectedMonth={setAssignmentsTabMonth}
                />
              )}

              {adminTab === 'sessions' && (
                <SessionsTab
                  blockedSessions={blockedSessions}
                  allDates={CAMP_DATES}
                  onSaveBlockedSessions={saveBlockedSessions}
                  registrations={registrations}
                  counselors={counselors}
                  availability={availability}
                  assignments={assignments}
                  showToast={showToast}
                  selectedMonth={sessionsTabMonth}
                  setSelectedMonth={setSessionsTabMonth}
                />
              )}

              {adminTab === 'history' && (
                <div className="bg-white rounded-xl shadow p-6">
                  <h3 className="font-bold text-lg text-green-800 mb-4">üìú Change History</h3>
                  {changeHistory.length === 0 ? (
                    <p className="text-gray-500">No changes recorded yet</p>
                  ) : (
                    <div className="space-y-2 max-h-96 overflow-y-auto">
                      {changeHistory.map(entry => (
                        <div key={entry.id} className="flex items-start gap-3 p-3 border rounded-lg hover:bg-gray-50">
                          <div className="text-xs text-gray-400 whitespace-nowrap pt-0.5">
                            {formatTimestamp(entry.timestamp)}
                          </div>
                          <div>
                            <div className="font-medium text-gray-800">{entry.action}</div>
                            <div className="text-sm text-gray-600">{entry.details}</div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </div>

            <Modal isOpen={showModal} onClose={() => setShowModal(false)} title={editCounselor?.id ? 'Edit Counselor Profile' : 'Add Counselor'}>
              {editCounselor && (
                <CounselorEditForm
                  counselor={editCounselor}
                  onSave={(form) => {
                    const isNew = !editCounselor.id;
                    const updated = isNew
                      ? [...counselors, { ...form, id: 'c_' + Date.now(), order: counselors.length }]
                      : counselors.map(c => c.id === editCounselor.id ? { ...form, id: editCounselor.id } : c);
                    const action = isNew ? `Added counselor ${form.name}` : `Updated ${form.name}`;
                    saveCounselors(updated, action);
                    setShowModal(false);
                  }}
                  onCancel={() => setShowModal(false)}
                  onDelete={(c) => { setShowModal(false); setConfirmDeleteCounselor(c); }}
                />
              )}
            </Modal>

            {/* Delete Counselor Confirmation Modal */}
            {confirmDeleteCounselor && (
              <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                <div className="bg-white rounded-xl max-w-md w-full p-6 text-center" onClick={e => e.stopPropagation()}>
                  <div className="text-5xl mb-4">‚ö†Ô∏è</div>
                  <h3 className="font-bold text-xl text-red-600 mb-2">Delete Counselor</h3>
                  <p className="text-gray-600 mb-4">
                    Are you sure you want to delete <strong>{confirmDeleteCounselor.name}</strong>?
                    <br />This will also remove them from all session assignments.
                  </p>
                  <p className="text-sm text-gray-500 mb-2">Type DELETE to confirm:</p>
                  <input
                    value={deleteConfirmText}
                    onChange={e => setDeleteConfirmText(e.target.value)}
                    className="w-full px-3 py-2 border rounded-lg text-center font-mono mb-4"
                    placeholder="DELETE"
                    autoComplete="off"
                    data-1p-ignore="true"
                  />
                  <div className="flex gap-3">
                    <button onClick={() => { setConfirmDeleteCounselor(null); setDeleteConfirmText(''); }} className="flex-1 px-4 py-2 border rounded-lg">Cancel</button>
                    <button
                      onClick={async () => {
                        if (deleteConfirmText !== 'DELETE') {
                          showToast('Please type DELETE to confirm', 'error');
                          return;
                        }
                        await deleteCounselor(confirmDeleteCounselor.id, confirmDeleteCounselor.name);
                        setConfirmDeleteCounselor(null);
                        setDeleteConfirmText('');
                      }}
                      disabled={deleteConfirmText !== 'DELETE'}
                      className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-300"
                    >
                      Delete Counselor
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      };

    // ==================== CHILDREN MANAGER (Parent Dashboard) ====================
    const ChildrenManager = ({ children, onUpdate, onDelete, onAdd, registrations }) => {
      const [showAddForm, setShowAddForm] = useState(false);

      // Check if child has any registrations (is a camper)
      const isCamper = (childId) => registrations?.some(r => r.childId === childId);

      return (
        <div className="space-y-4">
          {children.map(child => (
            <div key={child.id} className="relative">
              <ChildCard
                child={child}
                onUpdate={onUpdate}
                onDelete={onDelete}
              />
              {isCamper(child.id) && (
                <div className="absolute top-2 right-2">
                  <span className="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full font-medium">
                    üèïÔ∏è Registered Camper
                  </span>
                </div>
              )}
            </div>
          ))}

          {showAddForm ? (
            <div className="border-t pt-4 mt-4">
              <AddChildForm
                onAdd={(child) => {
                  onAdd(child);
                  setShowAddForm(false);
                }}
                onCancel={() => setShowAddForm(false)}
              />
            </div>
          ) : (
            <button
              onClick={() => setShowAddForm(true)}
              className="w-full py-4 border-2 border-dashed border-green-300 rounded-xl text-green-600 hover:bg-green-50 hover:border-green-400 transition-colors flex items-center justify-center gap-2 font-medium"
            >
              <span className="text-xl">+</span>
              <span>Add Another Child</span>
            </button>
          )}
        </div>
      );
    };

    // ==================== CAMPER SCHEDULE TAB (Visual Schedule for Parents) ====================
    const CamperScheduleTab = ({ myChildren, registrations, allRegistrations, assignments, counselors, campers, users }) => {
      const [selectedChild, setSelectedChild] = useState(myChildren[0]?.id || null);

      // Get registrations for selected child
      const childRegs = registrations.filter(r => r.childId === selectedChild);

      // Group registrations by date
      const regsByDate = {};
      childRegs.forEach(reg => {
        if (!regsByDate[reg.date]) regsByDate[reg.date] = [];
        regsByDate[reg.date].push(reg);
      });

      // Sort dates
      const sortedDates = Object.keys(regsByDate).sort();

      // Get counselor for a specific session
      const getCounselorForSession = (childId, date, session) => {
        const assignment = assignments.find(a =>
          a.camperId === childId && a.date === date && a.session === session
        );
        if (assignment) {
          return counselors.find(c => c.id === assignment.counselorId);
        }
        return null;
      };

      // Get pod mates (other campers with same counselor for a session)
      const getPodMates = (childId, date, session, counselorId) => {
        if (!counselorId) return [];
        const podAssignments = assignments.filter(a =>
          a.counselorId === counselorId && a.date === date && a.session === session && a.camperId !== childId
        );
        return podAssignments.map(a => {
          // Try to find in campers first, then in users' children
          const camper = campers.find(c => c.id === a.camperId);
          if (camper) return camper;

          for (const user of users) {
            const child = user.children?.find(c => c.id === a.camperId);
            if (child) return child;
          }
          return null;
        }).filter(Boolean);
      };

      // Get all campers at camp for a session (not just pod)
      const getAllCampersForSession = (date, session, excludeChildId) => {
        const sessionRegs = allRegistrations.filter(r =>
          r.date === date &&
          r.sessions?.includes(session) &&
          r.childId !== excludeChildId &&
          (r.status === 'approved' || r.status === 'pending')
        );
        return sessionRegs.map(r => {
          const camper = campers.find(c => c.id === r.childId);
          if (camper) return { ...camper, status: r.status };

          for (const user of users) {
            const child = user.children?.find(c => c.id === r.childId);
            if (child) return { ...child, status: r.status };
          }
          return { name: r.childName, status: r.status };
        }).filter(Boolean);
      };

      const selectedChildData = myChildren.find(c => c.id === selectedChild);

      if (myChildren.length === 0) {
        return (
          <div className="bg-white rounded-xl shadow p-8 text-center">
            <div className="text-6xl mb-4">üë∂</div>
            <h3 className="font-bold text-lg text-gray-800 mb-2">No Children Yet</h3>
            <p className="text-gray-500">Add campers in the "My Campers" tab, then register them for camp.</p>
          </div>
        );
      }

      if (childRegs.length === 0) {
        return (
          <div className="space-y-6">
            {myChildren.length > 1 && (
              <div className="bg-white rounded-xl shadow p-4">
                <div className="flex gap-2 flex-wrap">
                  {myChildren.map(child => (
                    <button
                      key={child.id}
                      onClick={() => setSelectedChild(child.id)}
                      className={`px-4 py-2 rounded-lg flex items-center gap-2 ${
                        selectedChild === child.id
                          ? 'bg-green-600 text-white'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      {child.photo ? (
                        <img src={child.photo} className="w-6 h-6 rounded-full object-cover" />
                      ) : (
                        <div className="w-6 h-6 rounded-full bg-green-200 flex items-center justify-center text-xs font-bold text-green-700">
                          {child.name?.charAt(0)}
                        </div>
                      )}
                      {child.name}
                    </button>
                  ))}
                </div>
              </div>
            )}
            <div className="bg-white rounded-xl shadow p-8 text-center">
              <div className="text-6xl mb-4">üìÖ</div>
              <h3 className="font-bold text-lg text-gray-800 mb-2">No Sessions Registered</h3>
              <p className="text-gray-500">{selectedChildData?.name || 'Your child'} hasn't been registered for any camp sessions yet.</p>
              <p className="text-sm text-gray-400 mt-2">Go to the "Register" tab to sign up for sessions.</p>
            </div>
          </div>
        );
      }

      return (
        <div className="space-y-6">
          {/* Child Selector */}
          {myChildren.length > 1 && (
            <div className="bg-white rounded-xl shadow p-4">
              <div className="flex gap-2 flex-wrap">
                {myChildren.map(child => {
                  const hasRegs = registrations.some(r => r.childId === child.id);
                  return (
                    <button
                      key={child.id}
                      onClick={() => setSelectedChild(child.id)}
                      className={`px-4 py-2 rounded-lg flex items-center gap-2 ${
                        selectedChild === child.id
                          ? 'bg-green-600 text-white'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      {child.photo ? (
                        <img src={child.photo} className="w-6 h-6 rounded-full object-cover" />
                      ) : (
                        <div className="w-6 h-6 rounded-full bg-green-200 flex items-center justify-center text-xs font-bold text-green-700">
                          {child.name?.charAt(0)}
                        </div>
                      )}
                      {child.name}
                      {hasRegs && <span className="text-xs opacity-75">üèïÔ∏è</span>}
                    </button>
                  );
                })}
              </div>
            </div>
          )}

          {/* Selected Child Header */}
          <div className="bg-gradient-to-r from-green-600 to-green-700 rounded-xl shadow p-6 text-white">
            <div className="flex items-center gap-4">
              {selectedChildData?.photo ? (
                <img src={selectedChildData.photo} className="w-20 h-20 rounded-full object-cover border-4 border-white/30" />
              ) : (
                <div className="w-20 h-20 rounded-full bg-white/20 flex items-center justify-center text-3xl font-bold">
                  {selectedChildData?.name?.charAt(0)}
                </div>
              )}
              <div>
                <h2 className="font-display text-2xl">{selectedChildData?.name}'s Camp Schedule</h2>
                <p className="text-green-100">{childRegs.length} session{childRegs.length !== 1 ? 's' : ''} registered</p>
              </div>
            </div>
          </div>

          {/* Schedule by Date */}
          <div className="space-y-4">
            {sortedDates.map(date => {
              const dateRegs = regsByDate[date];
              const d = new Date(date + 'T12:00:00');
              const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][d.getDay()];
              const monthName = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][d.getMonth()];

              return (
                <div key={date} className="bg-white rounded-xl shadow overflow-hidden">
                  <div className="bg-gray-100 px-6 py-3 border-b">
                    <h3 className="font-bold text-gray-800">{dayName}, {monthName} {d.getDate()}</h3>
                  </div>

                  <div className="p-4 space-y-4">
                    {dateRegs.flatMap(reg => reg.sessions || []).sort().map(session => {
                      const reg = dateRegs.find(r => r.sessions?.includes(session));
                      const counselor = getCounselorForSession(selectedChild, date, session);
                      const podMates = counselor ? getPodMates(selectedChild, date, session, counselor.id) : [];
                      const otherCampers = getAllCampersForSession(date, session, selectedChild);
                      const isPending = reg?.status === 'pending';

                      return (
                        <div key={session} className={`border rounded-xl p-4 ${isPending ? 'border-yellow-300 bg-yellow-50' : 'border-green-200 bg-green-50'}`}>
                          <div className="flex justify-between items-start mb-4">
                            <div className="flex items-center gap-3">
                              <div className={`w-12 h-12 rounded-lg flex items-center justify-center text-2xl ${session === 'morning' ? 'bg-yellow-400' : 'bg-blue-400'}`}>
                                {session === 'morning' ? 'üåÖ' : 'üåÜ'}
                              </div>
                              <div>
                                <h4 className="font-bold text-gray-800">{session === 'morning' ? 'Morning Session' : 'Afternoon Session'}</h4>
                                <p className="text-sm text-gray-500">{session === 'morning' ? '9:00 AM - 12:00 PM' : '1:00 PM - 4:00 PM'}</p>
                              </div>
                            </div>
                            <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                              isPending
                                ? 'bg-yellow-200 text-yellow-800'
                                : 'bg-green-200 text-green-800'
                            }`}>
                              {isPending ? '‚è≥ Pending Approval' : '‚úì Approved'}
                            </span>
                          </div>

                          {/* Counselor/Pod Section */}
                          {counselor ? (
                            <div className="mb-4">
                              <h5 className="text-sm font-medium text-gray-600 mb-2">Your Pod</h5>
                              <div className="bg-white rounded-lg p-4 border">
                                <div className="flex items-center gap-4 mb-3">
                                  {counselor.photo ? (
                                    <img src={counselor.photo} className="w-16 h-16 rounded-full object-cover border-2 border-green-400" />
                                  ) : (
                                    <div className="w-16 h-16 rounded-full bg-green-600 flex items-center justify-center text-white text-xl font-bold">
                                      {counselor.name?.charAt(0)}
                                    </div>
                                  )}
                                  <div>
                                    <p className="font-bold text-gray-800">{counselor.name}</p>
                                    <p className="text-sm text-green-600">Your Counselor</p>
                                    {counselor.position && <p className="text-xs text-gray-500">{counselor.position}</p>}
                                  </div>
                                </div>

                                {podMates.length > 0 && (
                                  <div>
                                    <p className="text-xs text-gray-500 mb-2">Pod Mates ({podMates.length}):</p>
                                    <div className="flex flex-wrap gap-2">
                                      {podMates.map((mate, idx) => (
                                        <div key={idx} className="flex items-center gap-2 bg-gray-50 rounded-lg px-2 py-1">
                                          {mate.photo ? (
                                            <img src={mate.photo} className="w-8 h-8 rounded-full object-cover" />
                                          ) : (
                                            <div className="w-8 h-8 rounded-full bg-green-200 flex items-center justify-center text-xs font-bold text-green-700">
                                              {mate.name?.charAt(0)}
                                            </div>
                                          )}
                                          <span className="text-sm">{mate.name}</span>
                                        </div>
                                      ))}
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>
                          ) : (
                            <div className="mb-4 p-4 bg-gray-100 rounded-lg text-center text-gray-500">
                              <p className="text-sm">Pod assignment pending</p>
                              <p className="text-xs">Counselor will be assigned soon!</p>
                            </div>
                          )}

                          {/* Other Campers at Camp */}
                          {otherCampers.length > 0 && (
                            <div>
                              <h5 className="text-sm font-medium text-gray-600 mb-2">Other Campers at Camp ({otherCampers.length})</h5>
                              <div className="flex flex-wrap gap-2">
                                {otherCampers.slice(0, 12).map((camper, idx) => (
                                  <div key={idx} className="flex items-center gap-1 bg-white rounded-full px-2 py-1 border">
                                    {camper.photo ? (
                                      <img src={camper.photo} className="w-6 h-6 rounded-full object-cover" />
                                    ) : (
                                      <div className="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-600">
                                        {camper.name?.charAt(0)}
                                      </div>
                                    )}
                                    <span className="text-xs">{camper.name?.split(' ')[0]}</span>
                                  </div>
                                ))}
                                {otherCampers.length > 12 && (
                                  <span className="text-xs text-gray-500 self-center">+{otherCampers.length - 12} more</span>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    };

      // ==================== PARENT ====================
      const Parent = () => {
        const [selectedDates, setSelectedDates] = useState({});
        const [expandedMonths, setExpandedMonths] = useState({});
        const [expandedWeeks, setExpandedWeeks] = useState({ 0: true });
        const [selectedChildren, setSelectedChildren] = useState([]);
        const [showConfirm, setShowConfirm] = useState(null);
        
        const myUser = users.find(u => u.email === user?.email) || user;
        const myChildren = myUser?.children || [];
        const myRegs = registrations.filter(r => r.parentEmail === user?.email && r.status !== 'cancelled');
        const venmoCode = generateVenmoCode(user?.name);
        
        const getAmountDue = () => myRegs.filter(r => r.status === 'approved' && r.paymentStatus !== 'paid').reduce((s, r) => s + (r.totalAmount || sessionCost), 0);
        
        const getMonthWeeks = () => {
          const months = {};
          CAMP_WEEKS.forEach((week, idx) => {
            const m = new Date(week.start + 'T12:00:00').getMonth();
            if (!months[m]) months[m] = { name: ['June', 'July', 'August'][m - 5], weeks: [] };
            months[m].weeks.push({ ...week, idx });
          });
          return months;
        };

        const toggleDate = (date, session) => {
          setSelectedDates(p => {
            const cur = p[date] || [];
            return { ...p, [date]: cur.includes(session) ? cur.filter(s => s !== session) : [...cur, session] };
          });
        };

        // Use discount calculation
        const getPricingBreakdown = () => calculateDiscountedTotal(selectedDates, selectedChildren.length, content);
        const calcTotal = () => getPricingBreakdown().finalTotal;

        // Quick action to select entire week (both AM and PM for all available days)
        const selectFullWeek = (weekDates) => {
          setSelectedDates(p => {
            const newDates = { ...p };
            weekDates.forEach(date => {
              const sessions = [];
              if (!isSessionBlocked(date, 'morning')) sessions.push('morning');
              if (!isSessionBlocked(date, 'afternoon')) sessions.push('afternoon');
              if (sessions.length > 0) newDates[date] = sessions;
            });
            return newDates;
          });
        };

        // Check if a week is fully selected (only counting available sessions)
        const isWeekFullySelected = (weekDates) => {
          const hasAvailable = weekDates.some(date =>
            !isSessionBlocked(date, 'morning') || !isSessionBlocked(date, 'afternoon')
          );
          if (!hasAvailable) return false;
          return weekDates.every(date => {
            const sel = selectedDates[date] || [];
            const amBlocked = isSessionBlocked(date, 'morning');
            const pmBlocked = isSessionBlocked(date, 'afternoon');
            const amOk = amBlocked || sel.includes('morning');
            const pmOk = pmBlocked || sel.includes('afternoon');
            return amOk && pmOk;
          });
        };

        // Get count of available days in a week (days with at least one available session)
        const getAvailableDaysInWeek = (weekDates) => weekDates.filter(date =>
          !isSessionBlocked(date, 'morning') || !isSessionBlocked(date, 'afternoon')
        ).length;

        // Clear a week's selection
        const clearWeek = (weekDates) => {
          setSelectedDates(p => {
            const newDates = { ...p };
            weekDates.forEach(date => {
              delete newDates[date];
            });
            return newDates;
          });
        };

        const handleRegister = async () => {
          if (!selectedChildren.length) { showToast('Select children', 'error'); return; }
          const dates = Object.entries(selectedDates).filter(([, s]) => s.length);
          if (!dates.length) { showToast('Select sessions', 'error'); return; }

          // Calculate discount info for the entire order
          const pricing = getPricingBreakdown();
          const orderId = `order_${Date.now()}`;

          // Calculate proportional discount per session
          const discountRatio = pricing.originalTotal > 0 ? pricing.discount / pricing.originalTotal : 0;

          for (const childId of selectedChildren) {
            const child = myChildren.find(c => c.id === childId);
            for (const [date, sessions] of dates) {
              const baseAmount = sessions.length * sessionCost;
              const discountAmount = Math.round(baseAmount * discountRatio * 100) / 100;
              const finalAmount = Math.round((baseAmount - discountAmount) * 100) / 100;

              await saveReg({
                id: `reg_${Date.now()}_${childId}_${date}`,
                orderId, // Group registrations from same order
                childId, childName: child?.name,
                parentEmail: user?.email, parentName: user?.name,
                date, sessions,
                status: 'pending', paymentStatus: 'unpaid',
                baseAmount, // Original price before discount
                discountAmount, // How much was discounted
                discountPercent: pricing.discountPercent,
                totalAmount: finalAmount, // Final price to pay
                registeredAt: new Date().toISOString()
              });
            }
          }

          setShowConfirm({
            children: selectedChildren.map(id => myChildren.find(c => c.id === id)?.name),
            total: pricing.finalTotal,
            savings: pricing.discount > 0 ? Math.round(pricing.discount) : null,
            venmoCode
          });
          setSelectedDates({});
          setSelectedChildren([]);
        };

        const addChild = async (child) => {
          const updated = { ...myUser, children: [...(myUser.children || []), { ...child, id: 'child_' + Date.now() }] };
          await saveUsers(users.map(u => u.email === myUser.email ? updated : u));
          showToast('Child profile added! Go to Register tab to sign them up for camp.');
        };

        return (
          <div className="min-h-screen bg-amber-50">
            <div className="bg-green-800 text-white py-3 sm:py-4">
              <div className="max-w-6xl mx-auto px-4">
                <h1 className="font-display text-2xl sm:text-3xl">Parent Dashboard</h1>
                <p className="text-green-200 text-sm sm:text-base">Welcome, {user?.name}</p>
              </div>
            </div>

            <div className="bg-white shadow">
              <div className="max-w-6xl mx-auto px-2 sm:px-4">
                <ScrollableTabs>
                  {['dashboard', 'schedule', 'register', 'campers', 'messages'].map(t => (
                    <button key={t} onClick={() => setParentTab(t)} className={'px-2 sm:px-4 py-2 sm:py-3 border-b-2 whitespace-nowrap select-none text-xs sm:text-sm ' + (parentTab === t ? 'border-green-600 text-green-700 bg-green-50' : 'border-transparent text-gray-500')}>
                      {t === 'messages' ? 'üí¨ Messages' : t === 'campers' ? 'üèÄ My Campers' : t === 'register' ? 'üìù Register' : t === 'dashboard' ? 'üìä Dashboard' : t === 'schedule' ? 'üìÖ Camp Schedule' : t}
                      {t === 'messages' && getUnreadCount(user?.email) > 0 && (
                        <span className="ml-2 bg-red-500 text-white text-xs px-2 rounded-full">{getUnreadCount(user?.email)}</span>
                      )}
                    </button>
                  ))}
                </ScrollableTabs>
              </div>
            </div>

            <div className="max-w-6xl mx-auto px-4 py-4 sm:py-6">
              {parentTab === 'dashboard' && (
                <div className="space-y-6">
                  <div className={'rounded-xl shadow p-6 ' + (getAmountDue() > 0 ? 'bg-blue-50 border-2 border-blue-200' : 'bg-gray-50')}>
                    <h3 className="font-bold text-lg mb-4">Payment</h3>
                    <div className="grid md:grid-cols-2 gap-4 mb-4">
                      <div className="text-center"><p className="text-sm text-gray-600">Due</p><p className="text-2xl font-bold text-red-600">${getAmountDue()}</p></div>
                      <div className="text-center"><p className="text-sm text-gray-600">Your Code</p><p className="text-2xl font-bold text-blue-600">{venmoCode}</p></div>
                    </div>
                    <div className="bg-white rounded-lg p-4">
                      <p><strong>Venmo:</strong> {content.venmoUsername}</p>
                      <p className="text-sm text-gray-600">Include code: <span className="font-mono bg-gray-100 px-2 rounded">{venmoCode}</span></p>
                    </div>
                  </div>
                  
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold text-lg mb-4">My Registrations</h3>
                    {myRegs.length === 0 ? <p className="text-gray-500">None yet</p> : (
                      <div className="space-y-2">{myRegs.map(r => (
                        <div key={r.id} className="flex justify-between p-3 border rounded-lg">
                          <div>
                            <span className="font-medium">{r.childName}</span>
                            <span className="text-gray-500 ml-2">{r.date} ‚Ä¢ {r.sessions?.join(', ')}</span>
                          </div>
                          <div className="flex gap-2">
                            <span className={'px-2 py-0.5 rounded text-xs ' + (r.status === 'approved' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700')}>{r.status}</span>
                            <span className={'px-2 py-0.5 rounded text-xs ' + (r.paymentStatus === 'paid' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700')}>{r.paymentStatus || 'unpaid'}</span>
                          </div>
                        </div>
                      ))}</div>
                    )}
                  </div>

                  {/* Share with Friends */}
                  <div className="bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl shadow p-6 border border-purple-200">
                    <div className="flex items-center gap-4">
                      <div className="text-4xl">üì¢</div>
                      <div className="flex-1">
                        <h3 className="font-bold text-lg text-purple-800">Invite Friends to Camp!</h3>
                        <p className="text-sm text-purple-600">Know other families who might be interested? Share Roosevelt Camp with them!</p>
                      </div>
                      <button
                        onClick={() => {
                          const shareText = `Join us at Roosevelt Girls Basketball Day Camp this summer! Great coaching, fun activities, and skill development for grades 3-8. ${window.location.origin}`;
                          if (navigator.share) {
                            navigator.share({
                              title: 'Roosevelt Girls Basketball Day Camp',
                              text: shareText,
                              url: window.location.origin
                            }).catch(() => {});
                          } else {
                            navigator.clipboard.writeText(shareText).then(() => {
                              showToast('Link copied to clipboard!');
                            });
                          }
                        }}
                        className="px-6 py-3 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 flex items-center gap-2"
                      >
                        <span>Share</span>
                        <span>üì§</span>
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {parentTab === 'register' && (
                <div className="space-y-6">
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold text-lg mb-2">Select Children to Register</h3>
                    <p className="text-sm text-gray-500 mb-4">Choose which of your children to register for camp sessions. Once registered, they become campers!</p>
                    {myChildren.length === 0 ? <p className="text-gray-500">Add campers in the "My Campers" tab first</p> : (
                      <div className="flex flex-wrap gap-2">{myChildren.map(c => (
                        <button key={c.id} onClick={() => setSelectedChildren(p => p.includes(c.id) ? p.filter(x => x !== c.id) : [...p, c.id])} className={'px-4 py-2 rounded-lg border-2 ' + (selectedChildren.includes(c.id) ? 'border-green-600 bg-green-50' : 'border-gray-200')}>{c.name}</button>
                      ))}</div>
                    )}
                  </div>
                  
                  <div className="bg-white rounded-xl shadow p-6">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-bold text-lg">Select Dates</h3>
                      <div className="flex gap-2">
                        <button onClick={() => setExpandedMonths({ 5: true, 6: true, 7: true })} className="text-sm text-green-600">Expand All</button>
                        <button onClick={() => { setExpandedMonths({}); setExpandedWeeks({}); }} className="text-sm text-gray-500">Collapse All</button>
                      </div>
                    </div>
                    
                    {Object.entries(getMonthWeeks()).map(([mKey, { name, weeks }]) => (
                      <div key={mKey} className="mb-4">
                        <button onClick={() => setExpandedMonths(p => ({ ...p, [mKey]: !p[mKey] }))} className="w-full flex justify-between p-3 bg-green-100 rounded-lg font-bold text-green-800">
                          <span>{name}</span><span>{expandedMonths[mKey] ? '‚ñº' : '‚ñ∂'}</span>
                        </button>
                        {expandedMonths[mKey] && (
                          <div className="mt-2 pl-4 space-y-2">{weeks.map(({ idx, start, dates }) => {
                            const isFullWeek = dates.length === 5 && isWeekFullySelected(dates);
                            return (
                            <div key={idx}>
                              <div className="flex gap-2 items-center">
                                <button onClick={() => setExpandedWeeks(p => ({ ...p, [idx]: !p[idx] }))} className="flex-1 flex justify-between p-2 bg-gray-100 rounded-lg text-gray-700">
                                  <span>Week {idx + 1} {isFullWeek && <span className="text-green-600 text-sm ml-2">‚úì Full week</span>}</span>
                                  <span>{expandedWeeks[idx] ? '‚ñº' : '‚ñ∂'}</span>
                                </button>
                                {getAvailableDaysInWeek(dates) > 0 && (
                                  isFullWeek ? (
                                    <button onClick={() => clearWeek(dates)} className="px-3 py-2 text-xs bg-red-100 text-red-600 rounded-lg hover:bg-red-200">
                                      Clear
                                    </button>
                                  ) : (
                                    <button onClick={() => selectFullWeek(dates)} className="px-3 py-2 text-xs bg-green-600 text-white rounded-lg hover:bg-green-700">
                                      {getAvailableDaysInWeek(dates) === 5 ? 'Full Week' : `Select ${getAvailableDaysInWeek(dates)} Days`}
                                    </button>
                                  )
                                )}
                              </div>
                              {expandedWeeks[idx] && (
                                <div className="grid grid-cols-5 gap-2 mt-2 pl-4">{dates.map(date => {
                                  const d = new Date(date + 'T12:00:00');
                                  const sel = selectedDates[date] || [];
                                  const amBlocked = isSessionBlocked(date, 'morning');
                                  const pmBlocked = isSessionBlocked(date, 'afternoon');
                                  const fullyBlocked = amBlocked && pmBlocked;
                                  const amSelected = sel.includes('morning');
                                  const pmSelected = sel.includes('afternoon');
                                  const bothSelected = amSelected && pmSelected;
                                  return (
                                    <div key={date} className={`rounded-lg border-2 overflow-hidden ${
                                      fullyBlocked ? 'border-gray-200 bg-gray-50' :
                                      bothSelected ? 'border-green-300 bg-green-50' :
                                      (amSelected || pmSelected) ? 'border-yellow-300 bg-yellow-50' :
                                      'border-gray-200 bg-white'
                                    }`}>
                                      <div className="p-2 text-center bg-gray-100 font-medium">
                                        <div className="text-xs text-gray-500">{['Mon', 'Tue', 'Wed', 'Thu', 'Fri'][d.getDay() - 1]}</div>
                                        <div className="text-sm">{d.getDate()}</div>
                                      </div>
                                      {fullyBlocked ? (
                                        <div className="p-2 text-center text-xs text-red-500">üö´ Not Available</div>
                                      ) : (
                                        <div className="p-2 space-y-1">
                                          {amBlocked ? (
                                            <div className="p-1.5 rounded text-xs bg-gray-100 text-gray-400 text-center">‚òÄÔ∏è AM üö´</div>
                                          ) : (
                                            <button onClick={() => toggleDate(date, 'morning')} className={`w-full p-1.5 rounded text-xs transition-colors ${amSelected ? 'bg-green-500 text-white' : 'bg-white hover:bg-gray-50 border'}`}>
                                              ‚òÄÔ∏è AM {amSelected ? '‚úì' : ''}
                                            </button>
                                          )}
                                          {pmBlocked ? (
                                            <div className="p-1.5 rounded text-xs bg-gray-100 text-gray-400 text-center">üåô PM üö´</div>
                                          ) : (
                                            <button onClick={() => toggleDate(date, 'afternoon')} className={`w-full p-1.5 rounded text-xs transition-colors ${pmSelected ? 'bg-green-500 text-white' : 'bg-white hover:bg-gray-50 border'}`}>
                                              üåô PM {pmSelected ? '‚úì' : ''}
                                            </button>
                                          )}
                                        </div>
                                      )}
                                    </div>
                                  );
                                })}</div>
                              )}
                            </div>
                          );})}</div>
                        )}
                      </div>
                    ))}
                  </div>
                  
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold text-lg mb-4">Order Summary</h3>
                    {(() => {
                      const pricing = getPricingBreakdown();
                      const hasSelections = pricing.totalSessions > 0;
                      return hasSelections ? (
                        <div className="space-y-3">
                          <div className="flex justify-between text-gray-600">
                            <span>{pricing.totalSessions} session{pricing.totalSessions !== 1 ? 's' : ''} √ó ${content.singleSessionCost || 60}</span>
                            <span>${pricing.originalTotal}</span>
                          </div>
                          {selectedChildren.length > 1 && (
                            <div className="text-sm text-gray-500">
                              ({selectedChildren.length} children)
                            </div>
                          )}
                          {pricing.fullWeeks > 0 && (
                            <div className="flex justify-between text-green-600">
                              <span>
                                {pricing.fullWeeks >= 2
                                  ? `üéâ Multi-week discount (${pricing.discountPercent}% off ${pricing.fullWeeks} full weeks)`
                                  : `‚úì Full week discount (${pricing.discountPercent}% off)`}
                              </span>
                              <span>-${Math.round(pricing.discount)}</span>
                            </div>
                          )}
                          {pricing.partialSessions > 0 && pricing.fullWeeks > 0 && (
                            <div className="text-sm text-gray-500">
                              + {pricing.partialSessions} additional session{pricing.partialSessions !== 1 ? 's' : ''} at full price
                            </div>
                          )}
                          <div className="border-t pt-3 flex justify-between items-center">
                            <span className="font-bold text-lg">Total</span>
                            <div className="text-right">
                              {pricing.discount > 0 && (
                                <span className="text-gray-400 line-through text-sm mr-2">${pricing.originalTotal}</span>
                              )}
                              <span className="text-2xl font-bold text-green-700">${pricing.finalTotal}</span>
                            </div>
                          </div>
                          {pricing.discount > 0 && (
                            <div className="bg-green-50 text-green-700 text-sm p-2 rounded-lg text-center">
                              You save ${Math.round(pricing.discount)}!
                            </div>
                          )}
                          {pricing.fullWeeks === 0 && pricing.totalSessions >= 5 && (
                            <div className="bg-yellow-50 text-yellow-700 text-sm p-2 rounded-lg">
                              üí° Tip: Book both AM & PM for all 5 days of a week to get {content.weekDiscount || 10}% off!
                            </div>
                          )}
                        </div>
                      ) : (
                        <div className="text-gray-400 text-center py-4">
                          Select sessions above to see pricing
                        </div>
                      );
                    })()}
                    <button onClick={handleRegister} disabled={!selectedChildren.length || !Object.values(selectedDates).flat().length} className="w-full mt-4 bg-green-700 hover:bg-green-800 disabled:bg-gray-300 text-white font-bold py-3 rounded-lg">Submit Registration</button>
                  </div>
                </div>
              )}

              {parentTab === 'schedule' && (
                <CamperScheduleTab
                  myChildren={myChildren}
                  registrations={myRegs}
                  allRegistrations={registrations}
                  assignments={assignments}
                  counselors={counselors}
                  campers={campers}
                  users={users}
                />
              )}

              {parentTab === 'campers' && (
                <div className="bg-white rounded-xl shadow p-6">
                  <h3 className="font-bold text-lg mb-2">My Campers</h3>
                  <p className="text-sm text-gray-500 mb-4">Manage your children's profiles here. Register them for camp sessions in the Register tab to make them campers!</p>
                  {myChildren.length > 0 ? (
                    <ChildrenManager
                      children={myChildren}
                      onUpdate={(updatedChild) => {
                        const updated = { ...myUser, children: myUser.children.map(ch => ch.id === updatedChild.id ? updatedChild : ch) };
                        saveUsers(users.map(u => u.email === myUser.email ? updated : u));
                        showToast('Child updated!');
                      }}
                      onDelete={(childId) => {
                        const updated = { ...myUser, children: myUser.children.filter(ch => ch.id !== childId) };
                        saveUsers(users.map(u => u.email === myUser.email ? updated : u));
                        showToast('Child removed');
                      }}
                      onAdd={addChild}
                      registrations={myRegs}
                    />
                  ) : (
                    <AddChildForm onAdd={addChild} />
                  )}
                </div>
              )}

              {parentTab === 'messages' && (
                <ParentMessagesTab
                  userEmail={user?.email}
                  userName={user?.name}
                  messages={messages}
                  onSendReply={saveMessage}
                  markAsRead={markMessageRead}
                  showToast={showToast}
                />
              )}
            </div>

            {showConfirm && (
              <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                <div className="bg-white rounded-xl max-w-md w-full p-6 text-center" onClick={e => e.stopPropagation()}>
                  <div className="text-6xl mb-4">üéâ</div>
                  <h2 className="font-display text-2xl text-green-800 mb-2">Registration Submitted!</h2>
                  <p className="text-green-600 font-medium mb-4">Your children are now campers!</p>
                  <p className="mb-2">Registered: {showConfirm.children?.join(', ')}</p>
                  <p className="text-2xl font-bold text-green-700 mb-2">Amount Due: ${showConfirm.total}</p>
                  {showConfirm.savings > 0 && (
                    <p className="text-green-600 text-sm mb-4">üéâ You saved ${showConfirm.savings} with your bulk discount!</p>
                  )}
                  <div className="bg-blue-50 rounded-lg p-4 mb-4">
                    <p className="font-medium">Venmo: {content.venmoUsername}</p>
                    <p className="text-sm">Code: <span className="font-mono bg-white px-2 rounded">{showConfirm.venmoCode}</span></p>
                  </div>
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                    <p className="text-sm text-yellow-800"><strong>‚ö†Ô∏è Spot not confirmed until:</strong></p>
                    <p className="text-sm text-yellow-700">‚úì Payment received AND ‚úì Admin approves</p>
                  </div>
                  <button onClick={() => { setShowConfirm(null); setParentTab('dashboard'); }} className="w-full bg-green-700 text-white font-bold py-3 rounded-lg">View Payment Info</button>
                </div>
              </div>
            )}
          </div>
        );
      };

      const AddChildForm = ({ onAdd, onCancel }) => {
        const [name, setName] = useState('');
        const [birthdate, setBirthdate] = useState('');
        const [grade, setGrade] = useState('');
        const [phone, setPhone] = useState('');
        const [photo, setPhoto] = useState(null);
        const [showCrop, setShowCrop] = useState(false);
        const [tempImg, setTempImg] = useState(null);
        const inputRef = useRef(null);

        const age = calculateAge(birthdate);

        const handleFile = (e) => {
          const file = e.target.files?.[0];
          if (file) {
            const reader = new FileReader();
            reader.onloadend = () => {
              setTempImg(reader.result);
              setShowCrop(true);
            };
            reader.readAsDataURL(file);
          }
          if (e.target) e.target.value = '';
        };

        const handleSubmit = () => {
          if (!name || !birthdate || !grade) return;
          onAdd({ name, birthdate, grade, phone, photo });
          setName(''); setBirthdate(''); setGrade(''); setPhone(''); setPhoto(null);
        };

        if (showCrop && tempImg) {
          return (
            <ImageCropper
              image={tempImg}
              onSave={(img) => { setPhoto(img); setShowCrop(false); }}
              onCancel={() => { setShowCrop(false); setTempImg(null); }}
            />
          );
        }

        return (
          <div className="border-t pt-4 space-y-4">
            <h4 className="font-medium text-lg">Add Child Profile</h4>
            <p className="text-sm text-gray-500 -mt-2">Create a profile for your child. You'll register them for camp sessions separately.</p>

            {/* Photo Upload with Face Silhouette Placeholder */}
            <div className="flex justify-center">
              {photo ? (
                <div className="relative">
                  <img src={photo} className="w-24 h-24 rounded-full object-cover border-2 border-green-600" />
                  <button onClick={() => inputRef.current?.click()}
                    className="absolute -bottom-1 -right-1 w-8 h-8 bg-green-600 rounded-full text-white flex items-center justify-center text-sm">‚úé</button>
                  <button onClick={() => setPhoto(null)}
                    className="absolute -top-1 -right-1 w-6 h-6 bg-red-500 rounded-full text-white text-xs flex items-center justify-center">√ó</button>
                </div>
              ) : (
                <div
                  onClick={() => inputRef.current?.click()}
                  className="w-24 h-24 rounded-full bg-gray-200 border-2 border-dashed border-gray-400 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300"
                >
                  <svg className="w-10 h-10 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                  </svg>
                  <span className="text-xs text-gray-500 mt-1">Add Photo</span>
                </div>
              )}
              <input ref={inputRef} type="file" accept="image/*" onChange={handleFile} className="hidden" />
            </div>
            <p className="text-xs text-gray-500 text-center">Photo helps us recognize your child at camp</p>

            {/* Name */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Child's Name *</label>
              <input value={name} onChange={e => setName(e.target.value)}
                className="w-full px-3 py-2 border rounded-lg" placeholder="Full name"
                autoComplete="off" data-1p-ignore="true" data-lpignore="true" data-form-type="other" />
            </div>

            {/* Birthdate & Calculated Age */}
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Birthdate *</label>
                <input type="date" value={birthdate} onChange={e => setBirthdate(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg"
                  max={new Date().toISOString().split('T')[0]} data-1p-ignore="true" data-lpignore="true" data-form-type="other" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Age</label>
                <div className="w-full px-3 py-2 border rounded-lg bg-gray-50 text-gray-700">
                  {age !== null ? `${age} years old` : 'Select birthdate'}
                </div>
              </div>
            </div>

            {/* Grade */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Grade (Fall 2026) *</label>
              <select value={grade} onChange={e => setGrade(e.target.value)}
                className="w-full px-3 py-2 border rounded-lg">
                <option value="">Select grade</option>
                <option value="3rd">3rd Grade</option>
                <option value="4th">4th Grade</option>
                <option value="5th">5th Grade</option>
                <option value="6th">6th Grade</option>
                <option value="7th">7th Grade</option>
                <option value="8th">8th Grade</option>
              </select>
            </div>

            {/* Phone (optional) */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Child's Phone <span className="text-gray-400">(optional)</span>
              </label>
              <input value={phone} onChange={e => setPhone(formatPhone(e.target.value))}
                className="w-full px-3 py-2 border rounded-lg" placeholder="(555) 555-1234"
                autoComplete="off" data-1p-ignore="true" data-lpignore="true" data-form-type="other" />
              <p className="text-xs text-gray-500 mt-1">If your child has a phone for emergencies</p>
            </div>

            {/* Buttons */}
            <div className="flex gap-4 pt-4">
              {onCancel && <button onClick={onCancel} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>}
              <button onClick={handleSubmit} disabled={!name || !birthdate || !grade}
                className="flex-1 py-2 bg-green-600 text-white rounded-lg disabled:bg-gray-300 hover:bg-green-700 disabled:hover:bg-gray-300">
                Add Child
              </button>
            </div>
          </div>
        );
      };

      // ==================== CHILD CARD ====================
      const ChildCard = ({ child, onUpdate, onDelete }) => {
        const inputRef = useRef(null);
        const [tempImg, setTempImg] = useState(null);
        const [showCrop, setShowCrop] = useState(false);
        const [isEditing, setIsEditing] = useState(false);
        const [editForm, setEditForm] = useState({ ...child });
        const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
        const age = calculateAge(child.birthdate);

        const handleFile = (e) => {
          const file = e.target.files?.[0];
          if (file) {
            const reader = new FileReader();
            reader.onloadend = () => { setTempImg(reader.result); setShowCrop(true); };
            reader.readAsDataURL(file);
          }
          if (e.target) e.target.value = '';
        };

        const handleSaveEdit = () => {
          if (!editForm.name || !editForm.birthdate || !editForm.grade) return;
          onUpdate({ ...child, ...editForm });
          setIsEditing(false);
        };

        const handleCancelEdit = () => {
          setEditForm({ ...child });
          setIsEditing(false);
        };

        if (showCrop && tempImg) {
          return (
            <div className="border rounded-lg p-4">
              <ImageCropper
                image={tempImg}
                onSave={(img) => {
                  if (isEditing) {
                    setEditForm({ ...editForm, photo: img });
                  } else {
                    onUpdate({ ...child, photo: img });
                  }
                  setShowCrop(false);
                }}
                onCancel={() => { setShowCrop(false); setTempImg(null); }}
              />
            </div>
          );
        }

        // Delete confirmation dialog
        if (showDeleteConfirm) {
          return (
            <div className="border-2 border-red-300 bg-red-50 rounded-lg p-4">
              <div className="text-center">
                <div className="text-4xl mb-2">‚ö†Ô∏è</div>
                <h4 className="font-bold text-red-800 mb-2">Delete {child.name}?</h4>
                <p className="text-sm text-red-600 mb-4">
                  This will permanently remove this child from your account.
                  Any existing registrations will remain in the system.
                </p>
                <div className="flex gap-3 justify-center">
                  <button
                    onClick={() => setShowDeleteConfirm(false)}
                    className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={() => { onDelete(child.id); setShowDeleteConfirm(false); }}
                    className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                  >
                    Yes, Delete
                  </button>
                </div>
              </div>
            </div>
          );
        }

        // Edit mode
        if (isEditing) {
          return (
            <div className="border-2 border-blue-300 bg-blue-50 rounded-lg p-4">
              <h4 className="font-bold text-blue-800 mb-4">‚úèÔ∏è Edit Child Details</h4>

              {/* Photo */}
              <div className="flex justify-center mb-4">
                {editForm.photo ? (
                  <div className="relative">
                    <img src={editForm.photo} className="w-20 h-20 rounded-full object-cover border-2 border-blue-400" />
                    <button onClick={() => inputRef.current?.click()}
                      className="absolute -bottom-1 -right-1 w-6 h-6 bg-blue-600 rounded-full text-white text-xs flex items-center justify-center">‚úé</button>
                    <button onClick={() => setEditForm({ ...editForm, photo: null })}
                      className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-white text-xs flex items-center justify-center">√ó</button>
                  </div>
                ) : (
                  <div onClick={() => inputRef.current?.click()}
                    className="w-20 h-20 rounded-full bg-gray-200 border-2 border-dashed border-gray-400 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300">
                    <svg className="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    <span className="text-xs text-gray-500">Add</span>
                  </div>
                )}
                <input ref={inputRef} type="file" accept="image/*" onChange={handleFile} className="hidden" />
              </div>

              <div className="space-y-3">
                {/* Name */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                  <input
                    value={editForm.name || ''}
                    onChange={e => setEditForm({ ...editForm, name: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                    placeholder="Child's name"
                    autoComplete="off"
                    data-1p-ignore="true"
                  />
                </div>

                {/* Birthdate & Age */}
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Birthdate *</label>
                    <input
                      type="date"
                      value={editForm.birthdate || ''}
                      onChange={e => setEditForm({ ...editForm, birthdate: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg"
                      max={new Date().toISOString().split('T')[0]}
                      data-1p-ignore="true"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Age</label>
                    <div className="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-700">
                      {calculateAge(editForm.birthdate) !== null ? `${calculateAge(editForm.birthdate)} years old` : 'Select birthdate'}
                    </div>
                  </div>
                </div>

                {/* Grade */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Grade (Fall 2026) *</label>
                  <select
                    value={editForm.grade || ''}
                    onChange={e => setEditForm({ ...editForm, grade: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="">Select grade</option>
                    <option value="3rd">3rd Grade</option>
                    <option value="4th">4th Grade</option>
                    <option value="5th">5th Grade</option>
                    <option value="6th">6th Grade</option>
                    <option value="7th">7th Grade</option>
                    <option value="8th">8th Grade</option>
                  </select>
                </div>

                {/* Phone */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Child's Phone (optional)</label>
                  <input
                    value={editForm.phone || ''}
                    onChange={e => setEditForm({ ...editForm, phone: formatPhone(e.target.value) })}
                    className="w-full px-3 py-2 border rounded-lg"
                    placeholder="(555) 555-1234"
                    autoComplete="off"
                    data-1p-ignore="true"
                  />
                </div>

                {/* Buttons */}
                <div className="flex gap-3 pt-2">
                  <button onClick={handleCancelEdit} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                    Cancel
                  </button>
                  <button
                    onClick={handleSaveEdit}
                    disabled={!editForm.name || !editForm.birthdate || !editForm.grade}
                    className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300"
                  >
                    Save Changes
                  </button>
                </div>
              </div>
            </div>
          );
        }

        // Normal display mode
        return (
          <div className="border rounded-lg p-4 flex items-start gap-4">
            {/* Photo with edit button or face placeholder */}
            <div className="flex-shrink-0">
              {child.photo ? (
                <div className="relative">
                  <img src={child.photo} className="w-20 h-20 rounded-full object-cover border-2 border-green-600" />
                  <button onClick={() => inputRef.current?.click()}
                    className="absolute -bottom-1 -right-1 w-6 h-6 bg-green-600 rounded-full text-white text-xs flex items-center justify-center">‚úé</button>
                </div>
              ) : (
                <div onClick={() => inputRef.current?.click()}
                  className="w-20 h-20 rounded-full bg-gray-200 border-2 border-dashed border-gray-400 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300">
                  <svg className="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                  </svg>
                  <span className="text-xs text-gray-500">Add</span>
                </div>
              )}
              <input ref={inputRef} type="file" accept="image/*" onChange={handleFile} className="hidden" />
            </div>

            {/* Info */}
            <div className="flex-1">
              <div className="font-bold text-lg">{child.name}</div>
              <div className="text-sm text-gray-600 space-y-1">
                {child.grade && <div>Grade: {child.grade}</div>}
                {child.birthdate && (
                  <div>
                    Birthday: {new Date(child.birthdate + 'T12:00:00').toLocaleDateString()}
                    {age !== null && <span className="text-green-600 font-medium"> ({age} years old)</span>}
                  </div>
                )}
                {child.phone && <div>Phone: {child.phone}</div>}
              </div>
            </div>

            {/* Action buttons */}
            <div className="flex flex-col gap-2">
              <button
                onClick={() => { setEditForm({ ...child }); setIsEditing(true); }}
                className="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 text-sm"
              >
                ‚úèÔ∏è Edit
              </button>
              <button
                onClick={() => setShowDeleteConfirm(true)}
                className="px-3 py-1.5 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 text-sm"
              >
                üóëÔ∏è Delete
              </button>
            </div>
          </div>
        );
      };

      // ==================== COUNSELOR ====================
      const CounselorDash = () => {
        const [month, setMonth] = useState(5);
        const [viewMode, setViewMode] = useState('calendar'); // 'calendar' or 'summary'
        const myAvail = availability[user?.email] || {};

        const getMonthDates = (m) => CAMP_DATES.filter(d => new Date(d + 'T12:00:00').getMonth() === m);

        const getState = (date, session) => {
          const data = myAvail[date];
          if (!data) return null;
          if (data.available?.includes(session)) return 'available';
          if (data.unavailable?.includes(session)) return 'unavailable';
          if (Array.isArray(data) && data.includes(session)) return 'available';
          return null;
        };

        const cycle = async (date, session) => {
          const newAvail = JSON.parse(JSON.stringify(myAvail));
          const state = getState(date, session);

          if (!newAvail[date] || Array.isArray(newAvail[date])) {
            newAvail[date] = { available: Array.isArray(newAvail[date]) ? [...newAvail[date]] : [], unavailable: [] };
          }

          if (state === null) {
            newAvail[date].available.push(session);
          } else if (state === 'available') {
            newAvail[date].available = newAvail[date].available.filter(s => s !== session);
            newAvail[date].unavailable.push(session);
          } else {
            newAvail[date].unavailable = newAvail[date].unavailable.filter(s => s !== session);
          }

          if (!newAvail[date].available?.length && !newAvail[date].unavailable?.length) delete newAvail[date];

          await saveAvail({ ...availability, [user?.email]: newAvail });
          showToast('Availability updated!');
        };

        // Bulk actions
        const markWeekAvailable = async (weekDates) => {
          const newAvail = JSON.parse(JSON.stringify(myAvail));
          weekDates.forEach(date => {
            newAvail[date] = { available: ['morning', 'afternoon'], unavailable: [] };
          });
          await saveAvail({ ...availability, [user?.email]: newAvail });
          showToast('Week marked as available!');
        };

        const markMonthAvailable = async (monthNum) => {
          const monthDates = getMonthDates(monthNum);
          const newAvail = JSON.parse(JSON.stringify(myAvail));
          monthDates.forEach(date => {
            newAvail[date] = { available: ['morning', 'afternoon'], unavailable: [] };
          });
          await saveAvail({ ...availability, [user?.email]: newAvail });
          showToast('Month marked as available!');
        };

        const clearMonth = async (monthNum) => {
          const monthDates = getMonthDates(monthNum);
          const newAvail = JSON.parse(JSON.stringify(myAvail));
          monthDates.forEach(date => {
            delete newAvail[date];
          });
          await saveAvail({ ...availability, [user?.email]: newAvail });
          showToast('Month cleared!');
        };

        // Calculate stats
        const getStats = () => {
          let available = 0, unavailable = 0, notSet = 0;
          CAMP_DATES.forEach(date => {
            ['morning', 'afternoon'].forEach(session => {
              const state = getState(date, session);
              if (state === 'available') available++;
              else if (state === 'unavailable') unavailable++;
              else notSet++;
            });
          });
          return { available, unavailable, notSet, total: CAMP_DATES.length * 2 };
        };
        const stats = getStats();

        return (
          <div className="min-h-screen bg-amber-50">
            <div className="bg-green-800 text-white py-4">
              <div className="max-w-6xl mx-auto px-4">
                <h1 className="font-display text-3xl">Counselor Dashboard</h1>
                <p className="text-green-200">Welcome, {user?.name}</p>
              </div>
            </div>

            <div className="max-w-6xl mx-auto px-4 py-6">
              {/* Stats Overview */}
              <div className="grid grid-cols-4 gap-4 mb-6">
                <div className="bg-white rounded-xl shadow p-4 text-center">
                  <div className="text-2xl font-bold text-green-600">{stats.available}</div>
                  <div className="text-sm text-gray-600">Sessions Available</div>
                </div>
                <div className="bg-white rounded-xl shadow p-4 text-center">
                  <div className="text-2xl font-bold text-red-600">{stats.unavailable}</div>
                  <div className="text-sm text-gray-600">Unavailable</div>
                </div>
                <div className="bg-white rounded-xl shadow p-4 text-center">
                  <div className="text-2xl font-bold text-gray-600">{stats.notSet}</div>
                  <div className="text-sm text-gray-600">Not Set</div>
                </div>
                <div className="bg-white rounded-xl shadow p-4 text-center">
                  <div className="text-2xl font-bold text-blue-600">{stats.total}</div>
                  <div className="text-sm text-gray-600">Total Sessions</div>
                </div>
              </div>

              {/* Instructions */}
              <div className="bg-green-100 border-l-4 border-green-600 p-4 rounded-lg mb-6">
                <h3 className="font-bold text-green-800 mb-2">üìÖ Sign Up for Sessions</h3>
                <p className="text-green-800 text-sm mb-2">Click on AM or PM to cycle through: <span className="font-medium">Available</span> ‚Üí <span className="font-medium">Unavailable</span> ‚Üí <span className="font-medium">Not Set</span></p>
                <p className="text-green-700 text-sm">Camp runs {CAMP_DATE_RANGE} (Monday after school ends through Friday before school starts)</p>
              </div>

              {/* Month Tabs */}
              <div className="flex flex-wrap gap-2 mb-4">
                {[{ m: 5, n: 'June' }, { m: 6, n: 'July' }, { m: 7, n: 'August' }].map(({ m, n }) => (
                  <button key={m} onClick={() => setMonth(m)} className={'px-6 py-2 rounded-lg font-medium ' + (month === m ? 'bg-green-600 text-white' : 'bg-white border border-green-600 text-green-700')}>{n}</button>
                ))}
                <div className="flex-1" />
                {/* Bulk Actions */}
                <button onClick={() => markMonthAvailable(month)} className="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 text-sm">
                  ‚úì Mark All Available
                </button>
                <button onClick={() => clearMonth(month)} className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm">
                  Clear Month
                </button>
              </div>

              {/* Calendar Grid */}
              <div className="bg-white rounded-xl shadow p-6">
                <div className="grid grid-cols-5 gap-3">
                  {['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].map(d => <div key={d} className="text-center font-bold text-green-800">{d}</div>)}
                  {getMonthDates(month).map(date => {
                    const d = new Date(date + 'T12:00:00');
                    const mState = getState(date, 'morning');
                    const aState = getState(date, 'afternoon');
                    const style = (s) => s === 'available' ? 'bg-green-500 text-white hover:bg-green-600' : s === 'unavailable' ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-gray-200 text-gray-600 hover:bg-gray-300';
                    return (
                      <div key={date} className="border rounded-lg p-2 hover:shadow-md transition-shadow">
                        <div className="text-center font-bold text-green-800 mb-2">{d.getDate()}</div>
                        <button onClick={() => cycle(date, 'morning')} className={'w-full py-1.5 rounded text-xs mb-1 font-medium transition-colors ' + style(mState)}>
                          {mState === 'available' ? '‚òÄÔ∏è AM ‚úì' : mState === 'unavailable' ? '‚òÄÔ∏è AM üö´' : '‚òÄÔ∏è AM'}
                        </button>
                        <button onClick={() => cycle(date, 'afternoon')} className={'w-full py-1.5 rounded text-xs font-medium transition-colors ' + style(aState)}>
                          {aState === 'available' ? 'üåô PM ‚úì' : aState === 'unavailable' ? 'üåô PM üö´' : 'üåô PM'}
                        </button>
                      </div>
                    );
                  })}
                </div>

                {/* Legend */}
                <div className="mt-6 pt-4 border-t flex flex-wrap gap-4 justify-center text-sm">
                  <div className="flex items-center gap-2"><div className="w-4 h-4 bg-green-500 rounded" /><span>Available - I can work</span></div>
                  <div className="flex items-center gap-2"><div className="w-4 h-4 bg-red-500 rounded" /><span>Unavailable - Can't work</span></div>
                  <div className="flex items-center gap-2"><div className="w-4 h-4 bg-gray-200 rounded" /><span>Not Set - Haven't decided</span></div>
                </div>
              </div>

              {/* Quick Actions by Week */}
              <div className="bg-white rounded-xl shadow p-6 mt-6">
                <h3 className="font-bold text-green-800 mb-4">‚ö° Quick Actions by Week</h3>
                <div className="space-y-2">
                  {CAMP_WEEKS.filter(w => new Date(w.start + 'T12:00:00').getMonth() === month).map((week, idx) => {
                    const weekStart = new Date(week.start + 'T12:00:00');
                    const weekEnd = new Date(week.dates[week.dates.length - 1] + 'T12:00:00');
                    const availableCount = week.dates.reduce((sum, date) => {
                      return sum + (getState(date, 'morning') === 'available' ? 1 : 0) + (getState(date, 'afternoon') === 'available' ? 1 : 0);
                    }, 0);

                    return (
                      <div key={week.start} className="flex items-center gap-4 p-3 bg-gray-50 rounded-lg">
                        <div className="flex-1">
                          <span className="font-medium">Week {idx + 1}: </span>
                          <span className="text-gray-600">
                            {weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - {weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                          </span>
                          <span className="ml-2 text-sm text-green-600">({availableCount}/{week.dates.length * 2} sessions)</span>
                        </div>
                        <button
                          onClick={() => markWeekAvailable(week.dates)}
                          className="px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm"
                        >
                          Mark Week Available
                        </button>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>
        );
      };

      // ==================== ROUTER ====================
      if (loading) return <div className="min-h-screen bg-green-50 flex items-center justify-center"><div className="text-6xl">üèÄ</div></div>;

      return (
        <div className="min-h-screen bg-gray-50">
          <VersionBanner isVisible={isDevEnv || showBanner} isDev={isDevEnv} />
          <Nav />
          {toast && <Toast message={toast.msg} type={toast.type} onDone={() => setToast(null)} />}
          {page === 'home' && <Home />}
          {page === 'schedule' && <Schedule />}
          {page === 'pricing' && <Pricing />}
          {page === 'location' && <Location />}
          {page === 'counselors' && <Counselors />}
          {page === 'login' && <Login />}
          {page === 'admin' && user?.role === 'admin' && <Admin />}
          {page === 'parent' && user?.role === 'parent' && <Parent />}
          {page === 'counselor' && user?.role === 'counselor' && <CounselorDash />}
          <footer className="bg-gray-800 text-white py-6 text-center">¬© 2026 Roosevelt High School Girls Basketball</footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<RooseveltCamp />);
  </script>
</body>
</html>
