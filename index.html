<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Roosevelt Girls Basketball Day Camp 2026</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .font-display { font-family: 'Bebas Neue', sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ==================== CONFIGURATION ====================
    const SUPABASE_URL = 'https://rdrtsebhninqgfbrleft.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkcnRzZWJobmlucWdmYnJsZWZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2OTcyMTMsImV4cCI6MjA4NTI3MzIxM30.l6gt5vvG1bXemZt9_BKSRy4kzbSatE4UIrV0a872QYw';

    const getEnvironment = () => {
      const hostname = window.location.hostname;
      return (hostname.includes('dev') || hostname.includes('localhost') || hostname.includes('127.0.0.1') || hostname.includes('--dev')) ? 'development' : 'production';
    };
    
    const ENV = getEnvironment();
    const SCHEMA = ENV === 'development' ? 'dev' : 'public';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      db: { schema: SCHEMA },
      global: { headers: { 'Accept-Profile': SCHEMA, 'Content-Profile': SCHEMA } }
    });
    
    console.log('Roosevelt Camp - Environment:', ENV, '- Schema:', SCHEMA);

    // ==================== VERSION INFO ====================
    const VERSION = "12.067";
    const BUILD_DATE = new Date();

    const RELEASE_NOTES = [
      { version: "12.067", date: "2026-01-29", changes: [
        "Admin can edit/delete parents, children, and registrations",
        "Type 'DELETE' confirmation for all deletions",
        "Location page with Roosevelt HS map, address, GPS links",
        "Schedule page shows pricing tiers and bulk discounts",
        "Cancellation policy (2 weeks advance notice)",
        "Late pickup policy (Starbucks gift card suggestion)",
        "Added Apple Maps and Google Maps direct links"
      ]},
      { version: "12.066", date: "2026-01-29", changes: [
        "Parents can now edit child details (name, birthdate, grade, phone, photo)",
        "Parents can delete children from their account (e.g., duplicates)",
        "Edit mode with inline form for child details",
        "Delete confirmation dialog to prevent accidents"
      ]},
      { version: "12.065", date: "2026-01-29", changes: [
        "Added Parents tab in admin to view all registered parents and campers",
        "Two-way in-app messaging system between admin and parents",
        "Message individual, multiple, or all parents",
        "Parents see messages in dashboard with unread indicators",
        "Conversation threads with reply functionality"
      ]},
      { version: "12.064", date: "2026-01-29", changes: [
        "Fixed modal closing when selecting text in edit forms",
        "Enhanced photo editing: adjust zoom/position, delete, or upload new",
        "Added counselor reordering with up/down arrows",
        "Counselor order persists and displays on public website"
      ]},
      { version: "12.063", date: "2026-01-29", changes: [
        "Fixed 1Password popup with data-1p-ignore attributes",
        "Admin shows as 'Admin' - click to go to admin portal",
        "Fixed input fields losing focus when typing",
        "Enhanced child form: photo upload, birthdate, calculated age, optional phone",
        "Auto-save for all content changes",
        "Added change history with timestamps"
      ]},
      { version: "12.061", date: "2026-01-29", changes: ["Fresh rebuild with all features", "Merged v12.042 features with Supabase schema separation", "Payment tracking, cancellation/refund system", "Collapsible calendar, scholarship requests"] },
      { version: "12.056", date: "2026-01-29", changes: ["Fixed counselor editing, photo cropper, phone formatting"] },
      { version: "12.054", date: "2026-01-29", changes: ["Fixed Supabase schema connection"] }
    ];

    const isDev = () => ENV === 'development';

    // ==================== CONSTANTS ====================
    const KIDS_PER_COUNSELOR = 5;
    
    const generateCampDates = () => {
      const dates = [];
      const start = new Date(2026, 5, 22);
      const end = new Date(2026, 7, 28);
      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        if (d.getDay() >= 1 && d.getDay() <= 5) dates.push(new Date(d).toISOString().split('T')[0]);
      }
      return dates;
    };
    const CAMP_DATES = generateCampDates();
    
    const getWeeks = () => {
      const weeks = [];
      let currentWeek = [];
      let weekStart = null;
      CAMP_DATES.forEach((date, idx) => {
        const d = new Date(date + 'T12:00:00');
        if (d.getDay() === 1 || idx === 0) {
          if (currentWeek.length > 0) weeks.push({ start: weekStart, dates: currentWeek });
          currentWeek = [date];
          weekStart = date;
        } else {
          currentWeek.push(date);
        }
      });
      if (currentWeek.length > 0) weeks.push({ start: weekStart, dates: currentWeek });
      return weeks;
    };
    const CAMP_WEEKS = getWeeks();

    // ==================== DEFAULT DATA ====================
    const DEFAULT_CONTENT = {
      heroTitle: "Roosevelt Girls Basketball",
      heroSubtitle: "Summer Daycamp 2026",
      heroTagline: "Build Skills. Build Friendships. Build Your Future.",
      heroImage: null,
      venmoImage: null,
      venmoUsername: "@RHSDayCamp",
      aboutText: "Join us for an incredible summer of basketball at Roosevelt High School! Our camp is designed for young athletes who want to develop their basketball skills while having fun and making lasting friendships.",
      contactEmail: "rhsdaycamp@gmail.com",
      contactPhone: "(206) 384-1872",
      sessionMorning: "9:00 AM - 12:00 PM",
      sessionAfternoon: "12:00 PM - 3:00 PM",
      sessionCost: "$60",
      campDates: "June 22 - August 28, 2026",
      ageRange: "Completed 3rd - 8th Grade",
      // Location details
      locationName: "Roosevelt High School",
      locationAddress: "1410 NE 66th St",
      locationCity: "Seattle",
      locationState: "WA",
      locationZip: "98115",
      locationDetails: "Roosevelt High School Gymnasium - Enter through the main gym entrance on the east side of the building.",
      // Pricing tiers
      singleSessionCost: 60,
      weekDiscount: 10, // percent off for booking full week (10 sessions)
      multiWeekDiscount: 15, // percent off for 2+ weeks
      // Policies
      cancellationPolicy: "All cancellation requests must be submitted at least 14 days (2 weeks) before the scheduled session to receive a full refund. Cancellations made less than 14 days in advance are non-refundable but may be credited toward a future session at the camp director's discretion. No-shows are non-refundable.",
      latePickupPolicy: "Camp sessions end promptly at the scheduled time. Our counselors volunteer their time and have other commitments after camp. If you anticipate being late, please call us immediately. As a gesture of appreciation for counselors who stay late due to delayed pickups, we kindly suggest purchasing a small Starbucks gift card ($5-10) for the counselor who waited with your child. Repeated late pickups may result in dismissal from the camp.",
      scholarshipInfo: "We believe every child deserves the chance to experience our camp. Apply for scholarship assistance through your Parent Dashboard."
    };

    const DEFAULT_COUNSELORS = [
      { id: 'c1', name: 'Sarah Mitchell', email: 'sarah.mitchell@roosevelt.edu', phone: '(206) 555-0101', position: 'Point Guard', year: 'Senior', bio: 'Team captain with 3 years varsity experience.', photo: null, visible: true, order: 0 },
      { id: 'c2', name: 'Maya Johnson', email: 'maya.johnson@roosevelt.edu', phone: '(206) 555-0102', position: 'Shooting Guard', year: 'Senior', bio: 'Sharpshooter with excellent 3-point range.', photo: null, visible: true, order: 1 },
      { id: 'c3', name: 'Emma Chen', email: 'emma.chen@roosevelt.edu', phone: '(206) 555-0103', position: 'Small Forward', year: 'Junior', bio: 'Versatile player known for lockdown defense.', photo: null, visible: true, order: 2 },
      { id: 'c4', name: 'Jasmine Williams', email: 'jasmine.williams@roosevelt.edu', phone: '(206) 555-0104', position: 'Center', year: 'Junior', bio: 'Starting center with strong post moves.', photo: null, visible: true, order: 3 },
    ];

    // ==================== STORAGE ====================
    const storage = {
      async get(table) {
        if (!supabase) return null;
        try {
          const { data, error } = await supabase.from(table).select('*');
          if (error) throw error;
          return data;
        } catch (e) {
          console.error('Error fetching ' + table + ':', e);
          return null;
        }
      },
      async set(table, id, data) {
        if (!supabase) return false;
        try {
          const { error } = await supabase.from(table).upsert({ id, data, updated_at: new Date().toISOString() });
          if (error) throw error;
          return true;
        } catch (e) {
          console.error('Error saving to ' + table + ':', e);
          return false;
        }
      }
    };

    // ==================== UTILITIES ====================
    const formatPhone = (value) => {
      const digits = value.replace(/\D/g, '').slice(0, 10);
      if (digits.length === 0) return '';
      if (digits.length <= 3) return '(' + digits;
      if (digits.length <= 6) return '(' + digits.slice(0, 3) + ') ' + digits.slice(3);
      return '(' + digits.slice(0, 3) + ') ' + digits.slice(3, 6) + '-' + digits.slice(6);
    };

    const isValidPhone = (phone) => (phone || '').replace(/\D/g, '').length === 10;

    const generateVenmoCode = (name) => {
      if (!name) return 'CAMP000';
      const parts = name.trim().split(' ');
      const first = (parts[0] || 'XXX').substring(0, 3).toUpperCase();
      const last = (parts[parts.length - 1] || 'XXX').substring(0, 3).toUpperCase();
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = ((hash << 5) - hash) + name.charCodeAt(i);
        hash = hash & hash;
      }
      return first + last + Math.abs(hash % 1000).toString().padStart(3, '0');
    };

    const getSessionCost = (content) => parseInt((content.sessionCost || '$60').replace(/[^0-9]/g, '')) || 60;

    const calculateAge = (birthdate) => {
      if (!birthdate) return null;
      const today = new Date();
      const birth = new Date(birthdate);
      let age = today.getFullYear() - birth.getFullYear();
      if (today.getMonth() < birth.getMonth() || (today.getMonth() === birth.getMonth() && today.getDate() < birth.getDate())) age--;
      return age;
    };

    const formatTimestamp = (date) => {
      const d = new Date(date);
      return d.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
      });
    };

    // ==================== STABLE INPUT COMPONENTS ====================
    const StableInput = React.memo(({ value, onSave, type = 'text', className = '', placeholder = '' }) => {
      const [local, setLocal] = useState(value || '');
      const inputRef = useRef(null);
      const initialValue = useRef(value);

      useEffect(() => {
        if (value !== initialValue.current && document.activeElement !== inputRef.current) {
          setLocal(value || '');
          initialValue.current = value;
        }
      }, [value]);

      const handleBlur = () => {
        if (local !== value) {
          onSave(local);
          initialValue.current = local;
        }
      };

      return (
        <input
          ref={inputRef}
          type={type}
          value={local}
          onChange={(e) => setLocal(e.target.value)}
          onBlur={handleBlur}
          className={className}
          placeholder={placeholder}
          autoComplete="off"
          data-1p-ignore="true"
          data-lpignore="true"
          data-form-type="other"
        />
      );
    });

    const StableTextarea = React.memo(({ value, onSave, className = '', placeholder = '', rows = 3 }) => {
      const [local, setLocal] = useState(value || '');
      const ref = useRef(null);
      const initialValue = useRef(value);

      useEffect(() => {
        if (value !== initialValue.current && document.activeElement !== ref.current) {
          setLocal(value || '');
          initialValue.current = value;
        }
      }, [value]);

      const handleBlur = () => {
        if (local !== value) {
          onSave(local);
          initialValue.current = local;
        }
      };

      return (
        <textarea
          ref={ref}
          value={local}
          onChange={(e) => setLocal(e.target.value)}
          onBlur={handleBlur}
          className={className}
          placeholder={placeholder}
          rows={rows}
          autoComplete="off"
          data-1p-ignore="true"
          data-lpignore="true"
          data-form-type="other"
        />
      );
    });

    // ==================== COUNSELOR EDIT FORM ====================
    const CounselorEditForm = ({ counselor, onSave, onCancel }) => {
      const [form, setForm] = useState({ ...counselor });
      const inputRef = useRef(null);
      const [tempImg, setTempImg] = useState(null);
      const [showCrop, setShowCrop] = useState(false);
      const [showPhotoOptions, setShowPhotoOptions] = useState(false);

      const update = (field, value) => {
        setForm(prev => ({ ...prev, [field]: value }));
      };

      const handleFile = (e) => {
        const file = e.target.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => { setTempImg(reader.result); setShowCrop(true); setShowPhotoOptions(false); };
          reader.readAsDataURL(file);
        }
        if (e.target) e.target.value = '';
      };

      const handleAdjustPhoto = () => {
        setTempImg(form.photo);
        setShowCrop(true);
        setShowPhotoOptions(false);
      };

      if (showCrop && tempImg) {
        return <ImageCropper image={tempImg} onSave={(img) => { update('photo', img); setShowCrop(false); setTempImg(null); }} onCancel={() => { setShowCrop(false); setTempImg(null); }} />;
      }

      return (
        <div className="space-y-4">
          <div className="flex items-center gap-4">
            {form.photo ? (
              <div className="relative">
                <img
                  src={form.photo}
                  className="w-20 h-20 rounded-full object-cover border-2 border-green-600 cursor-pointer hover:opacity-80"
                  onClick={() => setShowPhotoOptions(true)}
                />
                {showPhotoOptions && (
                  <div className="absolute top-0 left-24 bg-white rounded-lg shadow-lg border p-2 z-10 min-w-[140px]">
                    <button onClick={handleAdjustPhoto} className="w-full text-left px-3 py-2 hover:bg-gray-100 rounded text-sm flex items-center gap-2">
                      <span>üîç</span> Adjust Photo
                    </button>
                    <button onClick={() => { inputRef.current?.click(); }} className="w-full text-left px-3 py-2 hover:bg-gray-100 rounded text-sm flex items-center gap-2">
                      <span>üì∑</span> Upload New
                    </button>
                    <button onClick={() => { update('photo', null); setShowPhotoOptions(false); }} className="w-full text-left px-3 py-2 hover:bg-red-50 text-red-600 rounded text-sm flex items-center gap-2">
                      <span>üóëÔ∏è</span> Delete Photo
                    </button>
                    <hr className="my-1" />
                    <button onClick={() => setShowPhotoOptions(false)} className="w-full text-left px-3 py-2 hover:bg-gray-100 rounded text-sm text-gray-500">
                      Cancel
                    </button>
                  </div>
                )}
              </div>
            ) : (
              <div onClick={() => inputRef.current?.click()} className="w-20 h-20 rounded-full bg-gray-200 border-2 border-dashed border-gray-400 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300">
                <svg className="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
                <span className="text-xs text-gray-500">Add</span>
              </div>
            )}
            <input ref={inputRef} type="file" accept="image/*" onChange={handleFile} className="hidden" />
            <div className="flex-1 text-sm text-gray-500">{form.photo ? 'Click photo for options' : 'Click to add photo'}</div>
          </div>

          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
              <input
                value={form.name || ''}
                onChange={e => update('name', e.target.value)}
                className="w-full px-3 py-2 border rounded-lg"
                placeholder="Full name"
                autoComplete="off"
                data-1p-ignore="true"
                data-lpignore="true"
                data-form-type="other"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input
                value={form.email || ''}
                onChange={e => update('email', e.target.value)}
                className="w-full px-3 py-2 border rounded-lg"
                placeholder="email@example.com"
                autoComplete="off"
                data-1p-ignore="true"
                data-lpignore="true"
                data-form-type="other"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
              <input
                value={form.phone || ''}
                onChange={e => update('phone', formatPhone(e.target.value))}
                className="w-full px-3 py-2 border rounded-lg"
                placeholder="(555) 555-1234"
                autoComplete="off"
                data-1p-ignore="true"
                data-lpignore="true"
                data-form-type="other"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Position</label>
              <input
                value={form.position || ''}
                onChange={e => update('position', e.target.value)}
                className="w-full px-3 py-2 border rounded-lg"
                placeholder="Point Guard"
                autoComplete="off"
                data-1p-ignore="true"
                data-lpignore="true"
                data-form-type="other"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Year</label>
              <select value={form.year || ''} onChange={e => update('year', e.target.value)} className="w-full px-3 py-2 border rounded-lg">
                <option value="">Select year</option>
                <option value="Freshman">Freshman</option>
                <option value="Sophomore">Sophomore</option>
                <option value="Junior">Junior</option>
                <option value="Senior">Senior</option>
              </select>
            </div>
            <div className="flex items-center gap-2">
              <input type="checkbox" checked={form.visible !== false} onChange={e => update('visible', e.target.checked)} className="w-5 h-5" />
              <label className="text-sm font-medium text-gray-700">Visible on website</label>
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Bio</label>
            <textarea
              value={form.bio || ''}
              onChange={e => update('bio', e.target.value)}
              className="w-full px-3 py-2 border rounded-lg"
              rows={3}
              placeholder="Short bio..."
              autoComplete="off"
              data-1p-ignore="true"
              data-lpignore="true"
              data-form-type="other"
            />
          </div>

          <div className="flex gap-4 pt-4">
            <button onClick={onCancel} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
            <button onClick={() => onSave(form)} className="flex-1 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Save</button>
          </div>
        </div>
      );
    };

    // ==================== PARENTS TAB ====================
    const ParentsTab = ({ users, registrations, messages, onSendMessage, onUpdateUsers, onUpdateRegistrations, onDeleteRegistration, showToast, addToHistory }) => {
      const [searchTerm, setSearchTerm] = useState('');
      const [selectedParents, setSelectedParents] = useState([]);
      const [expandedParent, setExpandedParent] = useState(null);
      const [showComposer, setShowComposer] = useState(false);
      const [composerMode, setComposerMode] = useState('single'); // 'single', 'selected', 'all'
      const [composerRecipient, setComposerRecipient] = useState(null);
      const [viewingThread, setViewingThread] = useState(null);
      // Admin edit/delete state
      const [editingParent, setEditingParent] = useState(null);
      const [editingChild, setEditingChild] = useState(null);
      const [editingReg, setEditingReg] = useState(null);
      const [confirmDelete, setConfirmDelete] = useState(null); // { type: 'parent'|'child'|'registration', data: ... }

      const filteredUsers = users.filter(u =>
        u.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        u.email?.toLowerCase().includes(searchTerm.toLowerCase())
      );

      const getParentRegs = (email) => registrations.filter(r => r.parentEmail === email);
      const getParentMessages = (email) => messages.filter(m =>
        m.to === 'all' || m.to?.includes(email) || m.from === email
      );

      const toggleSelectParent = (email) => {
        setSelectedParents(prev =>
          prev.includes(email) ? prev.filter(e => e !== email) : [...prev, email]
        );
      };

      const selectAll = () => {
        if (selectedParents.length === filteredUsers.length) {
          setSelectedParents([]);
        } else {
          setSelectedParents(filteredUsers.map(u => u.email));
        }
      };

      const openComposer = (mode, recipient = null) => {
        setComposerMode(mode);
        setComposerRecipient(recipient);
        setShowComposer(true);
      };

      return (
        <div className="space-y-6">
          {/* Header with search and actions */}
          <div className="bg-white rounded-xl shadow p-6">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
              <div>
                <h3 className="font-bold text-xl text-green-800">üë®‚Äçüë©‚Äçüëß Parents & Campers</h3>
                <p className="text-sm text-gray-500">{users.length} registered parents</p>
              </div>
              <div className="flex gap-2">
                {selectedParents.length > 0 && (
                  <button
                    onClick={() => openComposer('selected')}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                  >
                    ‚úâÔ∏è Message Selected ({selectedParents.length})
                  </button>
                )}
                <button
                  onClick={() => openComposer('all')}
                  className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                >
                  üì¢ Message All Parents
                </button>
              </div>
            </div>

            {/* Search */}
            <div className="flex gap-4 items-center">
              <input
                value={searchTerm}
                onChange={e => setSearchTerm(e.target.value)}
                placeholder="Search parents by name or email..."
                className="flex-1 px-4 py-2 border rounded-lg"
                autoComplete="off"
                data-1p-ignore="true"
              />
              <label className="flex items-center gap-2 text-sm text-gray-600">
                <input
                  type="checkbox"
                  checked={selectedParents.length === filteredUsers.length && filteredUsers.length > 0}
                  onChange={selectAll}
                  className="w-4 h-4"
                />
                Select All
              </label>
            </div>
          </div>

          {/* Parents List */}
          {filteredUsers.length === 0 ? (
            <div className="bg-white rounded-xl shadow p-12 text-center text-gray-500">
              <p className="text-4xl mb-4">üë®‚Äçüë©‚Äçüëß</p>
              <p>{users.length === 0 ? 'No parents have registered yet' : 'No parents match your search'}</p>
            </div>
          ) : (
            <div className="space-y-4">
              {filteredUsers.map(parent => {
                const regs = getParentRegs(parent.email);
                const parentMsgs = getParentMessages(parent.email);
                const isExpanded = expandedParent === parent.email;
                const approvedRegs = regs.filter(r => r.status === 'approved').length;
                const pendingRegs = regs.filter(r => r.status === 'pending').length;

                return (
                  <div key={parent.email} className="bg-white rounded-xl shadow overflow-hidden">
                    {/* Parent Header */}
                    <div className="p-4 flex items-center gap-4">
                      <input
                        type="checkbox"
                        checked={selectedParents.includes(parent.email)}
                        onChange={() => toggleSelectParent(parent.email)}
                        className="w-5 h-5"
                      />

                      <div
                        className="flex-1 cursor-pointer"
                        onClick={() => setExpandedParent(isExpanded ? null : parent.email)}
                      >
                        <div className="flex items-center gap-3">
                          <div className="w-12 h-12 rounded-full bg-green-200 flex items-center justify-center text-xl font-bold text-green-700">
                            {parent.name?.[0]?.toUpperCase() || '?'}
                          </div>
                          <div>
                            <div className="font-bold text-gray-800">{parent.name}</div>
                            <div className="text-sm text-gray-500">{parent.email}</div>
                            {parent.phone && <div className="text-sm text-gray-500">{parent.phone}</div>}
                          </div>
                        </div>
                      </div>

                      {/* Stats */}
                      <div className="flex gap-4 text-center">
                        <div>
                          <div className="text-lg font-bold text-blue-600">{parent.children?.length || 0}</div>
                          <div className="text-xs text-gray-500">Campers</div>
                        </div>
                        <div>
                          <div className="text-lg font-bold text-green-600">{approvedRegs}</div>
                          <div className="text-xs text-gray-500">Approved</div>
                        </div>
                        {pendingRegs > 0 && (
                          <div>
                            <div className="text-lg font-bold text-yellow-600">{pendingRegs}</div>
                            <div className="text-xs text-gray-500">Pending</div>
                          </div>
                        )}
                        <div>
                          <div className="text-lg font-bold text-purple-600">{parentMsgs.length}</div>
                          <div className="text-xs text-gray-500">Messages</div>
                        </div>
                      </div>

                      {/* Actions */}
                      <div className="flex gap-2">
                        <button
                          onClick={(e) => { e.stopPropagation(); openComposer('single', parent); }}
                          className="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 text-sm"
                        >
                          ‚úâÔ∏è Message
                        </button>
                        <button
                          onClick={() => setExpandedParent(isExpanded ? null : parent.email)}
                          className="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-sm"
                        >
                          {isExpanded ? '‚ñ≤ Less' : '‚ñº More'}
                        </button>
                      </div>
                    </div>

                    {/* Expanded Details */}
                    {isExpanded && (
                      <div className="border-t bg-gray-50 p-4">
                        {/* Admin Actions Bar */}
                        <div className="flex gap-2 mb-4 pb-4 border-b">
                          <button
                            onClick={() => setEditingParent({ ...parent })}
                            className="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm"
                          >
                            ‚úèÔ∏è Edit Parent
                          </button>
                          <button
                            onClick={() => setConfirmDelete({ type: 'parent', data: parent })}
                            className="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 text-sm"
                          >
                            üóëÔ∏è Delete Parent
                          </button>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6">
                          {/* Children */}
                          <div>
                            <h4 className="font-bold text-gray-700 mb-3">üëß Campers ({parent.children?.length || 0})</h4>
                            {!parent.children?.length ? (
                              <p className="text-gray-500 text-sm">No campers added yet</p>
                            ) : (
                              <div className="space-y-2">
                                {parent.children.map(child => (
                                  <div key={child.id} className="flex items-center gap-3 p-2 bg-white rounded-lg">
                                    {child.photo ? (
                                      <img src={child.photo} className="w-10 h-10 rounded-full object-cover" />
                                    ) : (
                                      <div className="w-10 h-10 rounded-full bg-green-200 flex items-center justify-center text-sm">
                                        {child.name?.[0]}
                                      </div>
                                    )}
                                    <div className="flex-1">
                                      <div className="font-medium">{child.name}</div>
                                      <div className="text-xs text-gray-500">
                                        {child.grade && `Grade ${child.grade}`}
                                        {child.birthdate && ` ‚Ä¢ ${calculateAge(child.birthdate)} years old`}
                                      </div>
                                    </div>
                                    <div className="flex gap-1">
                                      <button
                                        onClick={() => setEditingChild({ child, parentEmail: parent.email })}
                                        className="p-1 text-blue-600 hover:bg-blue-50 rounded"
                                        title="Edit child"
                                      >‚úèÔ∏è</button>
                                      <button
                                        onClick={() => setConfirmDelete({ type: 'child', data: { child, parentEmail: parent.email } })}
                                        className="p-1 text-red-600 hover:bg-red-50 rounded"
                                        title="Delete child"
                                      >üóëÔ∏è</button>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>

                          {/* Registrations */}
                          <div>
                            <h4 className="font-bold text-gray-700 mb-3">üìã Registrations ({regs.length})</h4>
                            {regs.length === 0 ? (
                              <p className="text-gray-500 text-sm">No registrations yet</p>
                            ) : (
                              <div className="space-y-2 max-h-48 overflow-y-auto">
                                {regs.map(reg => (
                                  <div key={reg.id} className="flex items-center gap-2 p-2 bg-white rounded-lg text-sm">
                                    <div className="flex-1">
                                      <div className="font-medium">{reg.childName}</div>
                                      <div className="text-xs text-gray-500">{reg.date} ‚Ä¢ {reg.sessions?.join(', ')}</div>
                                    </div>
                                    <span className={`px-2 py-0.5 rounded text-xs ${
                                      reg.status === 'approved' ? 'bg-green-100 text-green-700' :
                                      reg.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                                      'bg-gray-100 text-gray-600'
                                    }`}>{reg.status}</span>
                                    <button
                                      onClick={() => setEditingReg(reg)}
                                      className="p-1 text-blue-600 hover:bg-blue-50 rounded"
                                      title="Edit registration"
                                    >‚úèÔ∏è</button>
                                    <button
                                      onClick={() => setConfirmDelete({ type: 'registration', data: reg })}
                                      className="p-1 text-red-600 hover:bg-red-50 rounded"
                                      title="Delete registration"
                                    >üóëÔ∏è</button>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>

                        {/* Message History */}
                        <div className="mt-4 pt-4 border-t">
                          <h4 className="font-bold text-gray-700 mb-3">üí¨ Messages ({parentMsgs.length})</h4>
                          {parentMsgs.length === 0 ? (
                            <p className="text-gray-500 text-sm">No messages yet</p>
                          ) : (
                            <div className="flex gap-2 flex-wrap">
                              <button
                                onClick={() => setViewingThread({ parentEmail: parent.email, parent })}
                                className="text-sm text-blue-600 hover:underline"
                              >
                                View conversation ({parentMsgs.length} messages) ‚Üí
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )}

          {/* Message Composer Modal */}
          {showComposer && (
            <MessageComposer
              mode={composerMode}
              recipient={composerRecipient}
              selectedParents={composerMode === 'selected' ? users.filter(u => selectedParents.includes(u.email)) : []}
              allParents={users}
              onSend={(msg) => {
                onSendMessage(msg);
                const recipientDesc = composerMode === 'all' ? 'all parents' :
                  composerMode === 'selected' ? `${selectedParents.length} parents` :
                  composerRecipient?.name;
                addToHistory('Message Sent', `Sent message to ${recipientDesc}: "${msg.subject}"`);
                showToast('Message sent!');
                setShowComposer(false);
                setSelectedParents([]);
              }}
              onCancel={() => setShowComposer(false)}
            />
          )}

          {/* Thread Viewer Modal */}
          {viewingThread && (
            <ThreadViewer
              parent={viewingThread.parent}
              messages={messages}
              onSendReply={(msg) => {
                onSendMessage(msg);
                addToHistory('Message Sent', `Replied to ${viewingThread.parent.name}`);
                showToast('Reply sent!');
              }}
              onClose={() => setViewingThread(null)}
            />
          )}

          {/* Edit Parent Modal */}
          {editingParent && (
            <AdminEditModal
              title="Edit Parent"
              onClose={() => setEditingParent(null)}
              onSave={(updated) => {
                onUpdateUsers(users.map(u => u.email === editingParent.email ? { ...u, ...updated } : u));
                addToHistory('Admin Edit', `Updated parent: ${updated.name}`);
                showToast('Parent updated!');
                setEditingParent(null);
              }}
            >
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
                  <input
                    value={editingParent.name || ''}
                    onChange={e => setEditingParent({ ...editingParent, name: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                    autoComplete="off" data-1p-ignore="true"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                  <input
                    value={editingParent.email || ''}
                    onChange={e => setEditingParent({ ...editingParent, email: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                    autoComplete="off" data-1p-ignore="true"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                  <input
                    value={editingParent.phone || ''}
                    onChange={e => setEditingParent({ ...editingParent, phone: formatPhone(e.target.value) })}
                    className="w-full px-3 py-2 border rounded-lg"
                    autoComplete="off" data-1p-ignore="true"
                  />
                </div>
              </div>
            </AdminEditModal>
          )}

          {/* Edit Child Modal */}
          {editingChild && (
            <AdminEditModal
              title="Edit Child"
              onClose={() => setEditingChild(null)}
              onSave={(updated) => {
                const parent = users.find(u => u.email === editingChild.parentEmail);
                if (parent) {
                  const updatedChildren = parent.children.map(c => c.id === editingChild.child.id ? { ...c, ...updated } : c);
                  onUpdateUsers(users.map(u => u.email === editingChild.parentEmail ? { ...u, children: updatedChildren } : u));
                  addToHistory('Admin Edit', `Updated child: ${updated.name}`);
                  showToast('Child updated!');
                }
                setEditingChild(null);
              }}
            >
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
                  <input
                    value={editingChild.child.name || ''}
                    onChange={e => setEditingChild({ ...editingChild, child: { ...editingChild.child, name: e.target.value } })}
                    className="w-full px-3 py-2 border rounded-lg"
                    autoComplete="off" data-1p-ignore="true"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Birthdate</label>
                  <input
                    type="date"
                    value={editingChild.child.birthdate || ''}
                    onChange={e => setEditingChild({ ...editingChild, child: { ...editingChild.child, birthdate: e.target.value } })}
                    className="w-full px-3 py-2 border rounded-lg"
                    data-1p-ignore="true"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Grade</label>
                  <select
                    value={editingChild.child.grade || ''}
                    onChange={e => setEditingChild({ ...editingChild, child: { ...editingChild.child, grade: e.target.value } })}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="">Select grade</option>
                    {['3rd', '4th', '5th', '6th', '7th', '8th'].map(g => <option key={g} value={g}>{g} Grade</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Phone (optional)</label>
                  <input
                    value={editingChild.child.phone || ''}
                    onChange={e => setEditingChild({ ...editingChild, child: { ...editingChild.child, phone: formatPhone(e.target.value) } })}
                    className="w-full px-3 py-2 border rounded-lg"
                    autoComplete="off" data-1p-ignore="true"
                  />
                </div>
              </div>
            </AdminEditModal>
          )}

          {/* Edit Registration Modal */}
          {editingReg && (
            <AdminEditModal
              title="Edit Registration"
              onClose={() => setEditingReg(null)}
              onSave={(updated) => {
                onUpdateRegistrations({ ...editingReg, ...updated });
                addToHistory('Admin Edit', `Updated registration for ${editingReg.childName} on ${editingReg.date}`);
                showToast('Registration updated!');
                setEditingReg(null);
              }}
            >
              <div className="space-y-4">
                <div className="p-3 bg-gray-50 rounded-lg">
                  <p className="font-medium">{editingReg.childName}</p>
                  <p className="text-sm text-gray-500">{editingReg.date}</p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Status</label>
                  <select
                    value={editingReg.status || ''}
                    onChange={e => setEditingReg({ ...editingReg, status: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                    <option value="cancelled">Cancelled</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                  <select
                    value={editingReg.paymentStatus || 'unpaid'}
                    onChange={e => setEditingReg({ ...editingReg, paymentStatus: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="unpaid">Unpaid</option>
                    <option value="paid">Paid</option>
                    <option value="refunded">Refunded</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Sessions</label>
                  <div className="flex gap-4">
                    <label className="flex items-center gap-2">
                      <input
                        type="checkbox"
                        checked={editingReg.sessions?.includes('morning')}
                        onChange={e => {
                          const sessions = e.target.checked
                            ? [...(editingReg.sessions || []), 'morning']
                            : (editingReg.sessions || []).filter(s => s !== 'morning');
                          setEditingReg({ ...editingReg, sessions });
                        }}
                        className="w-4 h-4"
                      />
                      Morning
                    </label>
                    <label className="flex items-center gap-2">
                      <input
                        type="checkbox"
                        checked={editingReg.sessions?.includes('afternoon')}
                        onChange={e => {
                          const sessions = e.target.checked
                            ? [...(editingReg.sessions || []), 'afternoon']
                            : (editingReg.sessions || []).filter(s => s !== 'afternoon');
                          setEditingReg({ ...editingReg, sessions });
                        }}
                        className="w-4 h-4"
                      />
                      Afternoon
                    </label>
                  </div>
                </div>
              </div>
            </AdminEditModal>
          )}

          {/* Confirm Delete Modal */}
          {confirmDelete && (
            <AdminConfirmDelete
              type={confirmDelete.type}
              data={confirmDelete.data}
              onCancel={() => setConfirmDelete(null)}
              onConfirm={() => {
                if (confirmDelete.type === 'parent') {
                  onUpdateUsers(users.filter(u => u.email !== confirmDelete.data.email));
                  addToHistory('Admin Delete', `Deleted parent: ${confirmDelete.data.name}`);
                  showToast('Parent deleted');
                  setExpandedParent(null);
                } else if (confirmDelete.type === 'child') {
                  const { child, parentEmail } = confirmDelete.data;
                  const parent = users.find(u => u.email === parentEmail);
                  if (parent) {
                    const updatedChildren = parent.children.filter(c => c.id !== child.id);
                    onUpdateUsers(users.map(u => u.email === parentEmail ? { ...u, children: updatedChildren } : u));
                    addToHistory('Admin Delete', `Deleted child: ${child.name}`);
                    showToast('Child deleted');
                  }
                } else if (confirmDelete.type === 'registration') {
                  onDeleteRegistration(confirmDelete.data.id);
                  addToHistory('Admin Delete', `Deleted registration: ${confirmDelete.data.childName} on ${confirmDelete.data.date}`);
                  showToast('Registration deleted');
                }
                setConfirmDelete(null);
              }}
            />
          )}
        </div>
      );
    };

    // ==================== ADMIN EDIT MODAL ====================
    const AdminEditModal = ({ title, children, onClose, onSave }) => {
      const mouseDownTarget = useRef(null);
      const [formData, setFormData] = useState({});

      return (
        <div
          className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
          onMouseDown={e => mouseDownTarget.current = e.target}
          onClick={e => e.target === e.currentTarget && mouseDownTarget.current === e.currentTarget && onClose()}
        >
          <div className="bg-white rounded-xl max-w-md w-full overflow-hidden">
            <div className="bg-blue-600 text-white px-6 py-4 flex justify-between items-center">
              <h2 className="font-display text-xl">‚úèÔ∏è {title}</h2>
              <button onClick={onClose} className="text-2xl hover:bg-blue-500 rounded px-2">√ó</button>
            </div>
            <div className="p-6">
              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                <p className="text-sm text-yellow-800">‚ö†Ô∏è <strong>Warning:</strong> Changes made here cannot be automatically undone. Please verify all information before saving.</p>
              </div>
              {children}
              <div className="flex gap-4 mt-6">
                <button onClick={onClose} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                <button onClick={() => onSave(formData)} className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ==================== ADMIN CONFIRM DELETE ====================
    const AdminConfirmDelete = ({ type, data, onCancel, onConfirm }) => {
      const [confirmText, setConfirmText] = useState('');
      const requiredText = 'DELETE';

      const getDescription = () => {
        if (type === 'parent') return `parent account "${data.name}" and all their data`;
        if (type === 'child') return `child "${data.child.name}" from ${data.parentEmail}`;
        if (type === 'registration') return `registration for ${data.childName} on ${data.date}`;
        return 'this item';
      };

      return (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-xl max-w-md w-full overflow-hidden">
            <div className="bg-red-600 text-white px-6 py-4">
              <h2 className="font-display text-xl">‚ö†Ô∏è Confirm Deletion</h2>
            </div>
            <div className="p-6">
              <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                <p className="text-red-800 font-medium mb-2">You are about to permanently delete:</p>
                <p className="text-red-700">{getDescription()}</p>
              </div>

              <p className="text-gray-700 mb-4">This action <strong>cannot be undone</strong>. All associated data will be permanently removed.</p>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Type <span className="font-mono bg-gray-100 px-1">DELETE</span> to confirm:
                </label>
                <input
                  value={confirmText}
                  onChange={e => setConfirmText(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg"
                  placeholder="DELETE"
                  autoComplete="off"
                  data-1p-ignore="true"
                />
              </div>

              <div className="flex gap-4">
                <button onClick={onCancel} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                <button
                  onClick={onConfirm}
                  disabled={confirmText !== requiredText}
                  className="flex-1 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                >
                  Delete Permanently
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ==================== MESSAGE COMPOSER ====================
    const MessageComposer = ({ mode, recipient, selectedParents, allParents, onSend, onCancel }) => {
      const [subject, setSubject] = useState('');
      const [body, setBody] = useState('');
      const mouseDownTarget = useRef(null);

      const getRecipientText = () => {
        if (mode === 'all') return `All Parents (${allParents.length})`;
        if (mode === 'selected') return selectedParents.map(p => p.name).join(', ');
        return recipient?.name || '';
      };

      const getRecipientEmails = () => {
        if (mode === 'all') return 'all';
        if (mode === 'selected') return selectedParents.map(p => p.email);
        return [recipient?.email];
      };

      const handleSend = () => {
        if (!subject.trim() || !body.trim()) return;
        const msg = {
          id: 'msg_' + Date.now(),
          threadId: mode === 'single' ? recipient?.email : 'broadcast_' + Date.now(),
          from: 'admin',
          to: getRecipientEmails(),
          subject: subject.trim(),
          body: body.trim(),
          sentAt: new Date().toISOString(),
          readBy: ['admin']
        };
        onSend(msg);
      };

      const handleBackdropMouseDown = (e) => { mouseDownTarget.current = e.target; };
      const handleBackdropClick = (e) => {
        if (e.target === e.currentTarget && mouseDownTarget.current === e.currentTarget) {
          onCancel();
        }
      };

      return (
        <div
          className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
          onMouseDown={handleBackdropMouseDown}
          onClick={handleBackdropClick}
        >
          <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div className="bg-blue-600 text-white px-6 py-4 flex justify-between items-center">
              <h2 className="font-display text-2xl">‚úâÔ∏è New Message</h2>
              <button onClick={onCancel} className="text-2xl hover:bg-blue-500 rounded px-2">√ó</button>
            </div>
            <div className="p-6 space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">To:</label>
                <div className="px-4 py-2 bg-gray-100 rounded-lg text-gray-700">
                  {mode === 'all' && <span className="text-blue-600 font-medium">üì¢ </span>}
                  {getRecipientText()}
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Subject:</label>
                <input
                  value={subject}
                  onChange={e => setSubject(e.target.value)}
                  className="w-full px-4 py-2 border rounded-lg"
                  placeholder="Message subject..."
                  autoComplete="off"
                  data-1p-ignore="true"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Message:</label>
                <textarea
                  value={body}
                  onChange={e => setBody(e.target.value)}
                  className="w-full px-4 py-2 border rounded-lg"
                  rows={6}
                  placeholder="Type your message here..."
                  autoComplete="off"
                  data-1p-ignore="true"
                />
              </div>

              <div className="flex gap-4 pt-4">
                <button onClick={onCancel} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                  Cancel
                </button>
                <button
                  onClick={handleSend}
                  disabled={!subject.trim() || !body.trim()}
                  className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300"
                >
                  Send Message
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ==================== THREAD VIEWER ====================
    const ThreadViewer = ({ parent, messages, onSendReply, onClose }) => {
      const [replyText, setReplyText] = useState('');
      const messagesEndRef = useRef(null);
      const mouseDownTarget = useRef(null);

      const threadMessages = messages
        .filter(m => m.to === 'all' || m.to?.includes(parent.email) || m.from === parent.email)
        .sort((a, b) => new Date(a.sentAt) - new Date(b.sentAt));

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [threadMessages.length]);

      const handleSendReply = () => {
        if (!replyText.trim()) return;
        const msg = {
          id: 'msg_' + Date.now(),
          threadId: parent.email,
          from: 'admin',
          to: [parent.email],
          subject: '',
          body: replyText.trim(),
          sentAt: new Date().toISOString(),
          readBy: ['admin']
        };
        onSendReply(msg);
        setReplyText('');
      };

      const handleBackdropMouseDown = (e) => { mouseDownTarget.current = e.target; };
      const handleBackdropClick = (e) => {
        if (e.target === e.currentTarget && mouseDownTarget.current === e.currentTarget) {
          onClose();
        }
      };

      return (
        <div
          className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
          onMouseDown={handleBackdropMouseDown}
          onClick={handleBackdropClick}
        >
          <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div className="bg-green-700 text-white px-6 py-4 flex justify-between items-center">
              <div>
                <h2 className="font-display text-2xl">üí¨ Conversation</h2>
                <p className="text-green-200 text-sm">with {parent.name}</p>
              </div>
              <button onClick={onClose} className="text-2xl hover:bg-green-600 rounded px-2">√ó</button>
            </div>

            {/* Messages */}
            <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50" style={{ maxHeight: '50vh' }}>
              {threadMessages.length === 0 ? (
                <p className="text-center text-gray-500 py-8">No messages yet. Start the conversation!</p>
              ) : (
                threadMessages.map(msg => (
                  <div
                    key={msg.id}
                    className={`flex ${msg.from === 'admin' ? 'justify-end' : 'justify-start'}`}
                  >
                    <div
                      className={`max-w-[80%] rounded-lg p-3 ${
                        msg.from === 'admin'
                          ? 'bg-blue-600 text-white'
                          : 'bg-white border'
                      }`}
                    >
                      {msg.subject && <div className="font-bold text-sm mb-1">{msg.subject}</div>}
                      <div className="whitespace-pre-wrap">{msg.body}</div>
                      <div className={`text-xs mt-1 ${msg.from === 'admin' ? 'text-blue-200' : 'text-gray-400'}`}>
                        {formatTimestamp(msg.sentAt)}
                        {msg.to === 'all' && <span className="ml-2">üì¢ Broadcast</span>}
                      </div>
                    </div>
                  </div>
                ))
              )}
              <div ref={messagesEndRef} />
            </div>

            {/* Reply Input */}
            <div className="border-t p-4 bg-white">
              <div className="flex gap-2">
                <textarea
                  value={replyText}
                  onChange={e => setReplyText(e.target.value)}
                  className="flex-1 px-4 py-2 border rounded-lg resize-none"
                  rows={2}
                  placeholder="Type your reply..."
                  autoComplete="off"
                  data-1p-ignore="true"
                  onKeyDown={e => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                      e.preventDefault();
                      handleSendReply();
                    }
                  }}
                />
                <button
                  onClick={handleSendReply}
                  disabled={!replyText.trim()}
                  className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300"
                >
                  Send
                </button>
              </div>
              <p className="text-xs text-gray-500 mt-1">Press Enter to send, Shift+Enter for new line</p>
            </div>
          </div>
        </div>
      );
    };

    // ==================== PARENT MESSAGES TAB ====================
    const ParentMessagesTab = ({ userEmail, userName, messages, onSendReply, markAsRead, showToast }) => {
      const [replyText, setReplyText] = useState('');
      const [selectedMsg, setSelectedMsg] = useState(null);
      const messagesEndRef = useRef(null);

      // Get messages for this parent (sent to them or to all, or from them)
      const myMessages = messages
        .filter(m => m.to === 'all' || m.to?.includes(userEmail) || m.from === userEmail)
        .sort((a, b) => new Date(b.sentAt) - new Date(a.sentAt));

      const unreadMessages = myMessages.filter(m => m.from !== userEmail && !m.readBy?.includes(userEmail));

      useEffect(() => {
        // Mark messages as read when viewing
        if (selectedMsg && !selectedMsg.readBy?.includes(userEmail)) {
          markAsRead(selectedMsg.id, userEmail);
        }
      }, [selectedMsg]);

      const handleSendReply = () => {
        if (!replyText.trim() || !selectedMsg) return;
        const msg = {
          id: 'msg_' + Date.now(),
          threadId: selectedMsg.threadId || selectedMsg.from === 'admin' ? userEmail : selectedMsg.threadId,
          from: userEmail,
          to: ['admin'],
          subject: selectedMsg.subject ? `Re: ${selectedMsg.subject}` : '',
          body: replyText.trim(),
          sentAt: new Date().toISOString(),
          readBy: [userEmail]
        };
        onSendReply(msg);
        setReplyText('');
        showToast('Reply sent!');
      };

      return (
        <div className="space-y-6">
          {/* Unread Alert */}
          {unreadMessages.length > 0 && (
            <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 flex items-center gap-4">
              <div className="text-3xl">üì¨</div>
              <div>
                <div className="font-bold text-blue-800">You have {unreadMessages.length} unread message{unreadMessages.length > 1 ? 's' : ''}</div>
                <div className="text-sm text-blue-600">Click on a message to read and reply</div>
              </div>
            </div>
          )}

          <div className="grid md:grid-cols-2 gap-6">
            {/* Message List */}
            <div className="bg-white rounded-xl shadow p-6">
              <h3 className="font-bold text-lg text-green-800 mb-4">üí¨ Messages from Camp</h3>
              {myMessages.length === 0 ? (
                <div className="text-center py-8 text-gray-500">
                  <p className="text-4xl mb-2">üì≠</p>
                  <p>No messages yet</p>
                </div>
              ) : (
                <div className="space-y-2 max-h-96 overflow-y-auto">
                  {myMessages.map(msg => {
                    const isUnread = msg.from !== userEmail && !msg.readBy?.includes(userEmail);
                    const isSelected = selectedMsg?.id === msg.id;
                    const isFromMe = msg.from === userEmail;

                    return (
                      <div
                        key={msg.id}
                        onClick={() => setSelectedMsg(msg)}
                        className={`p-3 rounded-lg cursor-pointer transition-colors ${
                          isSelected ? 'bg-green-100 border-2 border-green-500' :
                          isUnread ? 'bg-blue-50 border-2 border-blue-300' :
                          'bg-gray-50 hover:bg-gray-100'
                        }`}
                      >
                        <div className="flex justify-between items-start mb-1">
                          <span className={`text-sm ${isUnread ? 'font-bold text-blue-800' : 'text-gray-600'}`}>
                            {isFromMe ? 'üì§ You' : 'üì• Camp Admin'}
                            {msg.to === 'all' && !isFromMe && <span className="ml-1 text-xs text-purple-600">(Broadcast)</span>}
                          </span>
                          <span className="text-xs text-gray-400">{formatTimestamp(msg.sentAt)}</span>
                        </div>
                        {msg.subject && <div className={`text-sm ${isUnread ? 'font-bold' : 'font-medium'}`}>{msg.subject}</div>}
                        <div className="text-sm text-gray-600 truncate">{msg.body}</div>
                        {isUnread && <span className="inline-block mt-1 px-2 py-0.5 bg-blue-500 text-white text-xs rounded">New</span>}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {/* Message Detail / Reply */}
            <div className="bg-white rounded-xl shadow p-6">
              {!selectedMsg ? (
                <div className="text-center py-12 text-gray-500">
                  <p className="text-4xl mb-2">üëà</p>
                  <p>Select a message to read</p>
                </div>
              ) : (
                <div className="flex flex-col h-full">
                  <div className="mb-4">
                    <div className="flex justify-between items-start mb-2">
                      <span className="font-bold text-lg">
                        {selectedMsg.from === userEmail ? 'üì§ You sent' : 'üì• From Camp Admin'}
                      </span>
                      <span className="text-sm text-gray-500">{formatTimestamp(selectedMsg.sentAt)}</span>
                    </div>
                    {selectedMsg.subject && (
                      <div className="font-medium text-gray-800 mb-2">{selectedMsg.subject}</div>
                    )}
                    {selectedMsg.to === 'all' && selectedMsg.from !== userEmail && (
                      <span className="inline-block px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded mb-2">
                        üì¢ Sent to all parents
                      </span>
                    )}
                  </div>

                  <div className="flex-1 bg-gray-50 rounded-lg p-4 mb-4 whitespace-pre-wrap overflow-y-auto max-h-48">
                    {selectedMsg.body}
                  </div>

                  {/* Reply section - only show for messages from admin */}
                  {selectedMsg.from !== userEmail && (
                    <div className="border-t pt-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Reply:</label>
                      <textarea
                        value={replyText}
                        onChange={e => setReplyText(e.target.value)}
                        className="w-full px-4 py-2 border rounded-lg resize-none"
                        rows={3}
                        placeholder="Type your reply..."
                        autoComplete="off"
                        data-1p-ignore="true"
                      />
                      <button
                        onClick={handleSendReply}
                        disabled={!replyText.trim()}
                        className="mt-2 w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300"
                      >
                        Send Reply
                      </button>
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ==================== VERSION BANNER ====================
    const VersionBanner = ({ isVisible, isDev }) => {
      const [elapsed, setElapsed] = useState('0s');
      const [dbStatus, setDbStatus] = useState('checking');
      const [showNotes, setShowNotes] = useState(false);
      
      useEffect(() => {
        const update = () => {
          const diff = Math.floor((new Date() - BUILD_DATE) / 1000);
          const h = Math.floor(diff / 3600), m = Math.floor((diff % 3600) / 60), s = diff % 60;
          setElapsed((h > 0 ? h + 'h ' : '') + (m > 0 ? m + 'm ' : '') + s + 's');
        };
        update();
        const i = setInterval(update, 1000);
        supabase.from('camp_content').select('id').limit(1).then(({ error }) => setDbStatus(error ? 'error' : 'connected')).catch(() => setDbStatus('error'));
        return () => clearInterval(i);
      }, []);
      
      if (!isVisible) return null;
      
      return (
        <React.Fragment>
          <div className={(isDev ? 'bg-red-600' : 'bg-green-600') + ' text-white text-center py-2 text-sm font-mono'}>
            <span className="font-bold">{isDev ? 'DEVELOPMENT' : 'PRODUCTION'}</span>
            <span className="mx-2">‚Ä¢</span>
            <span>v{VERSION}</span>
            <span className="mx-2">‚Ä¢</span>
            <span>{dbStatus === 'connected' ? '‚úì DB (' + SCHEMA + ')' : dbStatus === 'checking' ? '‚è≥...' : '‚úó DB Error'}</span>
            <span className="mx-2">‚Ä¢</span>
            <span>Running: {elapsed}</span>
            <span className="mx-2">‚Ä¢</span>
            <button onClick={() => setShowNotes(true)} className="underline">Notes</button>
          </div>
          {showNotes && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={() => setShowNotes(false)}>
              <div className="bg-white rounded-xl max-w-lg w-full p-6" onClick={e => e.stopPropagation()}>
                <h2 className="font-bold text-xl mb-4">Release Notes</h2>
                {RELEASE_NOTES.map((r, i) => (
                  <div key={r.version} className={i > 0 ? 'mt-3 pt-3 border-t' : ''}>
                    <div className="font-mono text-green-700">v{r.version} <span className="text-gray-400 text-sm">{r.date}</span></div>
                    <ul className="text-sm text-gray-600 mt-1">{r.changes.map((c, j) => <li key={j}>‚Ä¢ {c}</li>)}</ul>
                  </div>
                ))}
                <button onClick={() => setShowNotes(false)} className="mt-4 w-full py-2 bg-green-600 text-white rounded-lg">Close</button>
              </div>
            </div>
          )}
        </React.Fragment>
      );
    };

    // ==================== UI COMPONENTS ====================
    const Toast = ({ message, type, onDone }) => {
      useEffect(() => {
        const t = setTimeout(onDone, 3000);
        return () => clearTimeout(t);
      }, []);
      return <div className={'fixed top-16 left-1/2 -translate-x-1/2 z-50 px-6 py-3 rounded-lg shadow-lg text-white ' + (type === 'error' ? 'bg-red-500' : 'bg-green-600')}>{message}</div>;
    };

    const Modal = ({ isOpen, onClose, title, children }) => {
      const mouseDownTarget = useRef(null);

      if (!isOpen) return null;

      const handleMouseDown = (e) => {
        mouseDownTarget.current = e.target;
      };

      const handleClick = (e) => {
        // Only close if both mousedown and click happened on the backdrop itself
        if (e.target === e.currentTarget && mouseDownTarget.current === e.currentTarget) {
          onClose();
        }
        mouseDownTarget.current = null;
      };

      return (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onMouseDown={handleMouseDown} onClick={handleClick}>
          <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div className="bg-green-800 text-white px-6 py-4 flex justify-between items-center">
              <h2 className="font-display text-2xl">{title}</h2>
              <button onClick={onClose} className="text-2xl hover:bg-green-700 rounded px-2">√ó</button>
            </div>
            <div className="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">{children}</div>
          </div>
        </div>
      );
    };

    const ImageCropper = ({ image, onSave, onCancel }) => {
      const canvasRef = useRef(null);
      const [zoom, setZoom] = useState(1);
      const [pos, setPos] = useState({ x: 0, y: 0 });
      const [dragging, setDragging] = useState(false);
      const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
      const [img, setImg] = useState(null);

      useEffect(() => {
        const i = new Image();
        i.onload = () => setImg(i);
        i.src = image;
      }, [image]);

      useEffect(() => {
        if (!img || !canvasRef.current) return;
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        canvas.width = 250;
        canvas.height = 250;
        ctx.clearRect(0, 0, 250, 250);
        ctx.save();
        ctx.beginPath();
        ctx.arc(125, 125, 125, 0, Math.PI * 2);
        ctx.clip();
        const scale = zoom * 250 / Math.max(img.width, img.height);
        const w = img.width * scale, h = img.height * scale;
        ctx.drawImage(img, (250 - w) / 2 + pos.x, (250 - h) / 2 + pos.y, w, h);
        ctx.restore();
        ctx.beginPath();
        ctx.arc(125, 125, 123, 0, Math.PI * 2);
        ctx.strokeStyle = '#16a34a';
        ctx.lineWidth = 4;
        ctx.stroke();
      }, [img, zoom, pos]);

      const onMouseDown = (e) => { setDragging(true); setDragStart({ x: e.clientX - pos.x, y: e.clientY - pos.y }); };
      const onMouseMove = (e) => { if (dragging) setPos({ x: e.clientX - dragStart.x, y: e.clientY - dragStart.y }); };
      const onMouseUp = () => setDragging(false);

      return (
        <div className="flex flex-col items-center gap-4">
          <p className="text-sm text-gray-500">Drag to position, slider to zoom</p>
          <div className="w-[250px] h-[250px] rounded-full overflow-hidden cursor-move bg-gray-100" onMouseDown={onMouseDown} onMouseMove={onMouseMove} onMouseUp={onMouseUp} onMouseLeave={onMouseUp}>
            <canvas ref={canvasRef} />
          </div>
          <input type="range" min="0.5" max="3" step="0.1" value={zoom} onChange={e => setZoom(parseFloat(e.target.value))} className="w-48" />
          <div className="flex gap-3">
            <button onClick={onCancel} className="px-4 py-2 bg-gray-200 rounded-lg">Cancel</button>
            <button onClick={() => onSave(canvasRef.current.toDataURL('image/jpeg', 0.9))} className="px-4 py-2 bg-green-600 text-white rounded-lg">Save</button>
          </div>
        </div>
      );
    };

    const ImageUpload = ({ currentImage, onImageChange, label, circular = false }) => {
      const inputRef = useRef(null);
      const [temp, setTemp] = useState(null);
      const [showCrop, setShowCrop] = useState(false);

      const onFile = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => { setTemp(reader.result); setShowCrop(true); };
          reader.readAsDataURL(file);
        }
        e.target.value = '';
      };

      if (showCrop && temp) {
        return <ImageCropper image={temp} onSave={(img) => { onImageChange(img); setShowCrop(false); }} onCancel={() => setShowCrop(false)} />;
      }

      return (
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">{label}</label>
          <div className="flex items-center gap-4">
            {currentImage ? <img src={currentImage} className={'w-20 h-20 object-cover border ' + (circular ? 'rounded-full' : 'rounded-lg')} /> : <div className={'w-20 h-20 bg-gray-100 border-2 border-dashed flex items-center justify-center text-gray-400 text-xs ' + (circular ? 'rounded-full' : 'rounded-lg')}>No image</div>}
            <div className="flex flex-col gap-2">
              <button onClick={() => inputRef.current?.click()} className="px-3 py-1 bg-green-600 text-white rounded text-sm">{currentImage ? 'Change' : 'Upload'}</button>
              {currentImage && <button onClick={() => onImageChange(null)} className="px-3 py-1 bg-red-100 text-red-600 rounded text-sm">Remove</button>}
            </div>
          </div>
          <input ref={inputRef} type="file" accept="image/*" onChange={onFile} className="hidden" />
        </div>
      );
    };

    // ==================== MAIN APP ====================
    function RooseveltCamp() {
      const [page, setPage] = useState('home');
      const [user, setUser] = useState(null);
      const [toast, setToast] = useState(null);
      const [loading, setLoading] = useState(true);
      const [showBanner, setShowBanner] = useState(false);
      
      const [content, setContent] = useState(DEFAULT_CONTENT);
      const [counselors, setCounselors] = useState(DEFAULT_COUNSELORS);
      const [registrations, setRegistrations] = useState([]);
      const [users, setUsers] = useState([]);
      const [availability, setAvailability] = useState({});
      const [changeHistory, setChangeHistory] = useState([]);
      const [messages, setMessages] = useState([]);
      
      const [adminTab, setAdminTab] = useState('dashboard');
      const [parentTab, setParentTab] = useState('dashboard');
      
      const isDevEnv = isDev();
      const showToast = useCallback((msg, type = 'success') => setToast({ msg, type }), []);
      const sessionCost = getSessionCost(content);

      useEffect(() => {
        const load = async () => {
          setLoading(true);
          try {
            const cd = await storage.get('camp_content');
            if (cd?.[0]?.data) setContent({ ...DEFAULT_CONTENT, ...cd[0].data });
            const cs = await storage.get('camp_counselors');
            if (cs?.length) setCounselors(cs.map(c => c.data).filter(Boolean).sort((a, b) => (a.order || 0) - (b.order || 0)));
            const rg = await storage.get('camp_registrations');
            if (rg?.length) setRegistrations(rg.map(r => r.data).filter(Boolean));
            const us = await storage.get('camp_registered_users');
            if (us?.[0]?.data) setUsers(Array.isArray(us[0].data) ? us[0].data : []);
            const av = await storage.get('camp_counselor_availability');
            if (av?.[0]?.data) setAvailability(av[0].data);
            const ch = await storage.get('camp_change_history');
            if (ch?.[0]?.data) setChangeHistory(Array.isArray(ch[0].data) ? ch[0].data : []);
            const ms = await storage.get('camp_messages');
            if (ms?.length) setMessages(ms.map(m => m.data).filter(Boolean));
          } catch (e) { console.error('Load error:', e); }
          setLoading(false);
        };
        load();
      }, []);

      const addToHistory = useCallback(async (action, details) => {
        const entry = {
          id: Date.now(),
          timestamp: new Date().toISOString(),
          action,
          details
        };
        const newHistory = [entry, ...changeHistory].slice(0, 100);
        setChangeHistory(newHistory);
        await storage.set('camp_change_history', 'main', newHistory);
      }, [changeHistory]);

      const saveContent = async (c, field = null) => {
        setContent(c);
        await storage.set('camp_content', 'main', c);
        if (field) {
          addToHistory('Content Updated', `Changed "${field}"`);
        }
        showToast('Saved!');
      };

      const saveCounselors = async (cs, action = null) => {
        setCounselors(cs);
        for (const c of cs) await storage.set('camp_counselors', c.id, c);
        if (action) addToHistory('Counselor', action);
        showToast('Saved!');
      };

      const saveReg = async (r, action = null) => {
        const newRegs = registrations.some(x => x.id === r.id) ? registrations.map(x => x.id === r.id ? r : x) : [...registrations, r];
        setRegistrations(newRegs);
        await storage.set('camp_registrations', r.id, r);
        if (action) addToHistory('Registration', action);
      };

      const saveUsers = async (u) => { setUsers(u); await storage.set('camp_registered_users', 'main', u); };
      const saveAvail = async (a) => { setAvailability(a); await storage.set('camp_counselor_availability', 'main', a); };

      const saveMessage = async (msg) => {
        const newMsgs = [...messages, msg];
        setMessages(newMsgs);
        await storage.set('camp_messages', msg.id, msg);
      };

      const markMessageRead = async (msgId, readerEmail) => {
        const updated = messages.map(m => {
          if (m.id === msgId && !m.readBy?.includes(readerEmail)) {
            return { ...m, readBy: [...(m.readBy || []), readerEmail] };
          }
          return m;
        });
        setMessages(updated);
        const msg = updated.find(m => m.id === msgId);
        if (msg) await storage.set('camp_messages', msg.id, msg);
      };

      const getUnreadCount = (email) => {
        return messages.filter(m =>
          (m.to === 'all' || m.to?.includes(email)) &&
          m.from !== email &&
          !m.readBy?.includes(email)
        ).length;
      };

      const getPending = () => registrations.filter(r => r.status === 'pending').length;
      const getApproved = () => registrations.filter(r => r.status === 'approved').length;
      const getCancelled = () => registrations.filter(r => r.status === 'cancelled').length;
      const getUnpaid = () => registrations.filter(r => r.status === 'approved' && r.paymentStatus !== 'paid').length;

      // ==================== NAV ====================
      const Nav = () => (
        <nav className="bg-green-900 text-white shadow-lg">
          <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <div className="font-display text-2xl cursor-pointer" onClick={() => { setPage('home'); setUser(null); }} onDoubleClick={() => !isDevEnv && setShowBanner(p => !p)}>üèÄ ROOSEVELT CAMP</div>
            <div className="flex gap-2 items-center">
              {['home', 'schedule', 'location', 'counselors'].map(p => (
                <button key={p} onClick={() => setPage(p)} className={'px-3 py-1 rounded text-sm capitalize ' + (page === p ? 'bg-green-700' : 'hover:bg-green-800')}>{p}</button>
              ))}
              {user ? (
                <React.Fragment>
                  {user.role === 'admin' ? (
                    <button onClick={() => setPage('admin')} className="text-green-300 text-sm ml-2 hover:text-white hover:underline">
                      Admin
                    </button>
                  ) : (
                    <span className="text-green-300 text-sm ml-2">{user.name}</span>
                  )}
                  <button onClick={() => { setUser(null); setPage('home'); }} className="px-3 py-1 bg-red-600 rounded text-sm">Logout</button>
                </React.Fragment>
              ) : (
                <button onClick={() => setPage('login')} className={'px-3 py-1 rounded text-sm ' + (page === 'login' ? 'bg-green-700' : 'hover:bg-green-800')}>Login</button>
              )}
            </div>
          </div>
        </nav>
      );

      // ==================== HOME ====================
      const Home = () => (
        <div>
          <div className="relative bg-gradient-to-br from-green-800 to-green-900 text-white py-20">
            {content.heroImage && <div className="absolute inset-0 opacity-30" style={{ backgroundImage: `url(${content.heroImage})`, backgroundSize: 'cover' }} />}
            <div className="relative max-w-4xl mx-auto px-4 text-center">
              <h1 className="font-display text-6xl mb-4">{content.heroTitle}</h1>
              <h2 className="font-display text-4xl text-green-200 mb-4">{content.heroSubtitle}</h2>
              <p className="text-xl text-green-100 mb-8">{content.heroTagline}</p>
              <button onClick={() => setPage('login')} className="bg-yellow-500 hover:bg-yellow-400 text-green-900 font-bold text-xl px-8 py-4 rounded-lg">Register Now ‚Üí</button>
            </div>
          </div>
          <div className="max-w-6xl mx-auto px-4 py-12 grid md:grid-cols-3 gap-6">
            <div className="bg-white rounded-xl shadow-lg p-6 border-t-4 border-green-600">
              <div className="text-4xl mb-2">üìÖ</div>
              <h3 className="font-bold text-xl text-green-800">Camp Dates</h3>
              <p className="text-gray-700">{content.campDates}</p>
            </div>
            <div className="bg-white rounded-xl shadow-lg p-6 border-t-4 border-yellow-500">
              <div className="text-4xl mb-2">‚è∞</div>
              <h3 className="font-bold text-xl text-green-800">Sessions</h3>
              <p className="text-gray-700">AM: {content.sessionMorning}</p>
              <p className="text-gray-700">PM: {content.sessionAfternoon}</p>
              <p className="text-green-600 font-bold mt-2">{content.sessionCost}/session</p>
            </div>
            <div className="bg-white rounded-xl shadow-lg p-6 border-t-4 border-orange-500">
              <div className="text-4xl mb-2">üëß</div>
              <h3 className="font-bold text-xl text-green-800">Ages</h3>
              <p className="text-gray-700">{content.ageRange}</p>
            </div>
          </div>
          <div className="bg-gray-50 py-12">
            <div className="max-w-4xl mx-auto px-4 text-center">
              <h2 className="font-display text-4xl text-green-800 mb-6">About Our Camp</h2>
              <p className="text-gray-700 text-lg">{content.aboutText}</p>
            </div>
          </div>
          <div className="max-w-6xl mx-auto px-4 py-12">
            <h2 className="font-display text-4xl text-green-800 text-center mb-8">Our Counselors</h2>
            <div className="grid md:grid-cols-4 gap-6">
              {counselors.filter(c => c.visible).map(c => (
                <div key={c.id} className="bg-white rounded-xl shadow-lg overflow-hidden">
                  <div className="h-32 bg-gradient-to-br from-green-600 to-green-800 flex items-center justify-center">
                    {c.photo ? <img src={c.photo} className="w-24 h-24 rounded-full object-cover border-4 border-white" /> : <div className="w-24 h-24 rounded-full bg-green-200 flex items-center justify-center text-4xl border-4 border-white">{c.name[0]}</div>}
                  </div>
                  <div className="p-4 text-center">
                    <h3 className="font-bold text-green-800">{c.name}</h3>
                    <p className="text-green-600 text-sm">{c.position} ‚Ä¢ {c.year}</p>
                    <p className="text-gray-600 text-sm mt-2">{c.bio}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
          <div className="bg-green-900 text-white py-12 text-center">
            <h2 className="font-display text-4xl mb-6">Contact Us</h2>
            <p className="text-xl">{content.contactEmail} ‚Ä¢ {content.contactPhone}</p>
            <p className="mt-4 text-green-200 whitespace-pre-line">{content.locationAddress}</p>
          </div>
        </div>
      );

      // ==================== SCHEDULE ====================
      const Schedule = () => (
        <div className="min-h-screen bg-amber-50 py-12">
          <div className="max-w-4xl mx-auto px-4">
            <h1 className="font-display text-4xl text-green-800 text-center mb-8">Camp Schedule</h1>

            {/* Sessions */}
            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
              <h2 className="font-bold text-xl text-green-800 mb-4">Daily Sessions</h2>
              <div className="grid md:grid-cols-2 gap-4 mb-6">
                <div className="p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
                  <h3 className="font-bold text-yellow-700">üåÖ Morning Session</h3>
                  <p className="text-lg">{content.sessionMorning}</p>
                  <p className="text-green-600 font-bold">${content.singleSessionCost || 60}/session</p>
                </div>
                <div className="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                  <h3 className="font-bold text-blue-700">‚òÄÔ∏è Afternoon Session</h3>
                  <p className="text-lg">{content.sessionAfternoon}</p>
                  <p className="text-green-600 font-bold">${content.singleSessionCost || 60}/session</p>
                </div>
              </div>
              <p className="text-gray-700 font-medium">{content.campDates}</p>
              <p className="text-sm text-gray-500 mt-2">Camp runs Monday through Friday, starting the Monday after school ends through the Friday before school starts.</p>
            </div>

            {/* Pricing & Discounts */}
            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
              <h2 className="font-bold text-xl text-green-800 mb-4">üí∞ Pricing & Discounts</h2>
              <div className="space-y-3">
                <div className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                  <span>Single Session</span>
                  <span className="font-bold">${content.singleSessionCost || 60}</span>
                </div>
                <div className="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-200">
                  <div>
                    <span className="font-medium">Full Week (10 sessions)</span>
                    <span className="ml-2 text-green-600 text-sm">Save {content.weekDiscount || 10}%!</span>
                  </div>
                  <span className="font-bold text-green-700">${Math.round((content.singleSessionCost || 60) * 10 * (1 - (content.weekDiscount || 10) / 100))}</span>
                </div>
                <div className="flex justify-between items-center p-3 bg-green-100 rounded-lg border border-green-300">
                  <div>
                    <span className="font-medium">2+ Weeks</span>
                    <span className="ml-2 text-green-700 text-sm">Save {content.multiWeekDiscount || 15}%!</span>
                  </div>
                  <span className="font-bold text-green-800">{content.multiWeekDiscount || 15}% off total</span>
                </div>
              </div>
              <p className="text-sm text-gray-500 mt-4">Discounts applied automatically at checkout. You can always add more sessions later!</p>
            </div>

            {/* Policies */}
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h2 className="font-bold text-xl text-green-800 mb-4">üìã Camp Policies</h2>

              <div className="space-y-4">
                <div className="p-4 bg-red-50 rounded-lg border-l-4 border-red-400">
                  <h3 className="font-bold text-red-800 mb-2">üö´ Cancellation Policy</h3>
                  <p className="text-gray-700 text-sm">{content.cancellationPolicy}</p>
                </div>

                <div className="p-4 bg-orange-50 rounded-lg border-l-4 border-orange-400">
                  <h3 className="font-bold text-orange-800 mb-2">‚è∞ Late Pickup Policy</h3>
                  <p className="text-gray-700 text-sm">{content.latePickupPolicy}</p>
                </div>

                <div className="p-4 bg-purple-50 rounded-lg border-l-4 border-purple-400">
                  <h3 className="font-bold text-purple-800 mb-2">üíú Scholarship Assistance</h3>
                  <p className="text-gray-700 text-sm">{content.scholarshipInfo}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      );

      // ==================== LOCATION PAGE ====================
      const Location = () => {
        const fullAddress = `${content.locationAddress}, ${content.locationCity}, ${content.locationState} ${content.locationZip}`;
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(content.locationName + ' ' + fullAddress)}`;
        const mapsEmbedUrl = `https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${encodeURIComponent(content.locationName + ' ' + fullAddress)}`;

        return (
          <div className="min-h-screen bg-amber-50 py-12">
            <div className="max-w-4xl mx-auto px-4">
              <h1 className="font-display text-4xl text-green-800 text-center mb-8">üìç Camp Location</h1>

              {/* Location Card */}
              <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
                {/* Map */}
                <div className="h-64 bg-gray-200 relative">
                  <iframe
                    width="100%"
                    height="100%"
                    frameBorder="0"
                    style={{ border: 0 }}
                    src={`https://www.google.com/maps?q=${encodeURIComponent(content.locationName + ' ' + fullAddress)}&output=embed`}
                    allowFullScreen
                  />
                </div>

                {/* Details */}
                <div className="p-6">
                  <h2 className="font-display text-3xl text-green-800 mb-2">{content.locationName || 'Roosevelt High School'}</h2>

                  <div className="space-y-3 mb-6">
                    <div className="flex items-start gap-3">
                      <span className="text-2xl">üè´</span>
                      <div>
                        <p className="font-medium">{content.locationAddress || '1410 NE 66th St'}</p>
                        <p className="text-gray-600">{content.locationCity || 'Seattle'}, {content.locationState || 'WA'} {content.locationZip || '98115'}</p>
                      </div>
                    </div>

                    {content.locationDetails && (
                      <div className="flex items-start gap-3">
                        <span className="text-2xl">‚ÑπÔ∏è</span>
                        <p className="text-gray-700">{content.locationDetails}</p>
                      </div>
                    )}
                  </div>

                  {/* Copy-friendly address box */}
                  <div className="bg-gray-50 rounded-lg p-4 mb-4">
                    <p className="text-sm text-gray-500 mb-2">üìã Copy this address for GPS/Maps:</p>
                    <p className="font-mono text-gray-800 select-all">{fullAddress}</p>
                  </div>

                  {/* Action buttons */}
                  <div className="flex flex-wrap gap-3">
                    <a
                      href={mapsUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex-1 min-w-[200px] py-3 bg-blue-600 text-white rounded-lg text-center font-medium hover:bg-blue-700"
                    >
                      üó∫Ô∏è Open in Google Maps
                    </a>
                    <a
                      href={`https://maps.apple.com/?q=${encodeURIComponent(fullAddress)}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex-1 min-w-[200px] py-3 bg-gray-800 text-white rounded-lg text-center font-medium hover:bg-gray-900"
                    >
                      üçé Open in Apple Maps
                    </a>
                  </div>
                </div>
              </div>

              {/* Parking & Directions */}
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h2 className="font-bold text-xl text-green-800 mb-4">üöó Parking & Drop-off</h2>
                <div className="space-y-3 text-gray-700">
                  <p>‚Ä¢ <strong>Parking:</strong> Free parking is available in the school parking lot off NE 66th St.</p>
                  <p>‚Ä¢ <strong>Drop-off:</strong> Please drop off campers at the main gymnasium entrance on the east side of the building.</p>
                  <p>‚Ä¢ <strong>Pick-up:</strong> Campers should be picked up at the same location promptly at the end of their session.</p>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // ==================== COUNSELORS PAGE ====================
      const Counselors = () => (
        <div className="min-h-screen bg-amber-50 py-12">
          <div className="max-w-6xl mx-auto px-4">
            <h1 className="font-display text-4xl text-green-800 text-center mb-8">Our Counselors</h1>
            <div className="grid md:grid-cols-4 gap-6">
              {counselors.filter(c => c.visible).map(c => (
                <div key={c.id} className="bg-white rounded-xl shadow-lg overflow-hidden">
                  <div className="h-40 bg-gradient-to-br from-green-600 to-green-800 flex items-center justify-center">
                    {c.photo ? <img src={c.photo} className="w-32 h-32 rounded-full object-cover border-4 border-white" /> : <div className="w-32 h-32 rounded-full bg-green-200 flex items-center justify-center text-5xl border-4 border-white">{c.name[0]}</div>}
                  </div>
                  <div className="p-4 text-center">
                    <h3 className="font-bold text-xl text-green-800">{c.name}</h3>
                    <p className="text-green-600">{c.position} ‚Ä¢ {c.year}</p>
                    <p className="text-gray-600 text-sm mt-2">{c.bio}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );

      // ==================== LOGIN ====================
      const Login = () => {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const [mode, setMode] = useState('login');
        const [name, setName] = useState('');
        const [phone, setPhone] = useState('');

        const handleLogin = () => {
          if (email === 'admin' && password === 'admin') { setUser({ name: 'Admin', role: 'admin' }); setPage('admin'); showToast('Welcome, Admin!'); return; }
          const u = users.find(x => x.email === email && x.password === password);
          if (u) { setUser(u); setPage(u.role === 'counselor' ? 'counselor' : 'parent'); showToast('Welcome!'); return; }
          const c = counselors.find(x => x.email === email);
          if (c) { setUser({ ...c, role: 'counselor' }); setPage('counselor'); showToast('Welcome!'); return; }
          setError('Invalid credentials');
        };

        const handleRegister = async () => {
          if (!name || !email || !phone || !password) { setError('All fields required'); return; }
          if (!isValidPhone(phone)) { setError('Valid phone required'); return; }
          if (users.some(u => u.email === email)) { setError('Email exists'); return; }
          const newUser = { email, name, password, phone: formatPhone(phone), role: 'parent', children: [] };
          await saveUsers([...users, newUser]);
          setUser(newUser);
          setPage('parent');
          showToast('Account created!');
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-green-50 to-green-100 py-12">
            <div className="max-w-md mx-auto px-4">
              <div className="bg-white rounded-2xl shadow-xl p-8">
                <h2 className="font-display text-3xl text-green-800 text-center mb-6">{mode === 'login' ? 'Welcome Back' : 'Create Account'}</h2>
                {error && <div className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-center">{error}</div>}
                
                {mode === 'login' ? (
                  <form autoComplete="off" data-1p-ignore="true" onSubmit={e => e.preventDefault()} className="space-y-4">
                    <input value={email} onChange={e => setEmail(e.target.value)} className="w-full px-4 py-3 border-2 rounded-lg" placeholder="Email" autoComplete="off" data-1p-ignore="true" data-lpignore="true" data-form-type="other" />
                    <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full px-4 py-3 border-2 rounded-lg" placeholder="Password" onKeyDown={e => e.key === 'Enter' && handleLogin()} autoComplete="off" data-1p-ignore="true" data-lpignore="true" data-form-type="other" />
                    <button type="button" onClick={handleLogin} className="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 rounded-lg">Login</button>
                  </form>
                ) : (
                  <form autoComplete="off" data-1p-ignore="true" onSubmit={e => e.preventDefault()} className="space-y-4">
                    <input value={name} onChange={e => setName(e.target.value)} className="w-full px-4 py-3 border-2 rounded-lg" placeholder="Full Name" autoComplete="off" data-1p-ignore="true" data-lpignore="true" data-form-type="other" />
                    <input value={email} onChange={e => setEmail(e.target.value)} className="w-full px-4 py-3 border-2 rounded-lg" placeholder="Email" autoComplete="off" data-1p-ignore="true" data-lpignore="true" data-form-type="other" />
                    <input value={phone} onChange={e => setPhone(formatPhone(e.target.value))} className="w-full px-4 py-3 border-2 rounded-lg" placeholder="Phone" autoComplete="off" data-1p-ignore="true" data-lpignore="true" data-form-type="other" />
                    <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full px-4 py-3 border-2 rounded-lg" placeholder="Password" autoComplete="off" data-1p-ignore="true" data-lpignore="true" data-form-type="other" />
                    <button type="button" onClick={handleRegister} className="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 rounded-lg">Create Account</button>
                  </form>
                )}
                
                <button onClick={() => { setMode(mode === 'login' ? 'register' : 'login'); setError(''); }} className="w-full mt-4 text-green-600 hover:underline">
                  {mode === 'login' ? 'New? Create account ‚Üí' : '‚Üê Back to login'}
                </button>
                <div className="mt-4 p-3 bg-gray-50 rounded-lg text-xs text-gray-500 text-center">Admin: admin / admin</div>
              </div>
            </div>
          </div>
        );
      };

      // ==================== ADMIN ====================
      const Admin = () => {
        const [editCounselor, setEditCounselor] = useState(null);
        const [showModal, setShowModal] = useState(false);

        const updateContent = (field, value) => {
          const newContent = { ...content, [field]: value };
          saveContent(newContent, field);
        };

        return (
          <div className="min-h-screen bg-gray-100">
            <div className="bg-green-800 text-white py-4">
              <div className="max-w-6xl mx-auto px-4">
                <h1 className="font-display text-3xl">Admin Dashboard</h1>
                <p className="text-green-200">Welcome, {user?.name}</p>
              </div>
            </div>

            <div className="bg-white shadow">
              <div className="max-w-6xl mx-auto px-4 flex gap-1 overflow-x-auto">
                {['dashboard', 'registrations', 'parents', 'counselors', 'content', 'history'].map(t => (
                  <button key={t} onClick={() => setAdminTab(t)} className={'px-4 py-3 capitalize border-b-2 whitespace-nowrap ' + (adminTab === t ? 'border-green-600 text-green-700 bg-green-50' : 'border-transparent text-gray-500')}>
                    {t === 'history' ? 'üìú History' : t === 'parents' ? 'üë®‚Äçüë©‚Äçüëß Parents' : t}
                    {t === 'registrations' && getPending() > 0 && <span className="ml-2 bg-red-500 text-white text-xs px-2 rounded-full">{getPending()}</span>}
                    {t === 'parents' && users.length > 0 && <span className="ml-2 bg-blue-500 text-white text-xs px-2 rounded-full">{users.length}</span>}
                  </button>
                ))}
              </div>
            </div>

            <div className="max-w-6xl mx-auto px-4 py-6">
              {adminTab === 'dashboard' && (
                <div className="grid md:grid-cols-4 gap-4">
                  <div className="bg-white rounded-xl shadow p-6 text-center"><div className="text-3xl font-bold text-yellow-600">{getPending()}</div><div className="text-gray-600">Pending</div></div>
                  <div className="bg-white rounded-xl shadow p-6 text-center"><div className="text-3xl font-bold text-green-600">{getApproved()}</div><div className="text-gray-600">Approved</div></div>
                  <div className="bg-white rounded-xl shadow p-6 text-center"><div className="text-3xl font-bold text-red-600">{getUnpaid()}</div><div className="text-gray-600">Unpaid</div></div>
                  <div className="bg-white rounded-xl shadow p-6 text-center"><div className="text-3xl font-bold text-gray-600">{getCancelled()}</div><div className="text-gray-600">Cancelled</div></div>
                </div>
              )}

              {adminTab === 'registrations' && (
                <div className="space-y-6">
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold text-lg text-yellow-700 mb-4">Pending ({getPending()})</h3>
                    {registrations.filter(r => r.status === 'pending').length === 0 ? <p className="text-gray-500">None</p> : (
                      <div className="space-y-3">{registrations.filter(r => r.status === 'pending').map(r => (
                        <div key={r.id} className="border rounded-lg p-4 flex justify-between items-center">
                          <div>
                            <div className="font-bold">{r.childName}</div>
                            <div className="text-sm text-gray-600">{r.parentName} ‚Ä¢ {r.date}</div>
                          </div>
                          <div className="flex gap-2">
                            <button onClick={() => { saveReg({ ...r, status: 'approved' }, `Approved ${r.childName} for ${r.date}`); showToast('Approved!'); }} className="px-3 py-1 bg-green-600 text-white rounded text-sm">Approve</button>
                            <button onClick={() => { saveReg({ ...r, status: 'rejected' }, `Rejected ${r.childName} for ${r.date}`); showToast('Rejected'); }} className="px-3 py-1 bg-red-100 text-red-600 rounded text-sm">Reject</button>
                          </div>
                        </div>
                      ))}</div>
                    )}
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold text-lg text-green-700 mb-4">Approved ({getApproved()})</h3>
                    {registrations.filter(r => r.status === 'approved').length === 0 ? <p className="text-gray-500">None</p> : (
                      <table className="w-full">
                        <thead><tr className="text-left text-sm text-gray-600"><th className="p-2">Child</th><th className="p-2">Parent</th><th className="p-2">Date</th><th className="p-2">Payment</th><th className="p-2">Actions</th></tr></thead>
                        <tbody>{registrations.filter(r => r.status === 'approved').map(r => (
                          <tr key={r.id} className={r.paymentStatus !== 'paid' ? 'bg-red-50' : ''}>
                            <td className="p-2 font-medium">{r.childName}</td>
                            <td className="p-2 text-gray-600">{r.parentName}</td>
                            <td className="p-2 text-gray-600">{r.date}</td>
                            <td className="p-2">
                              <button onClick={() => {
                                const newStatus = r.paymentStatus === 'paid' ? 'unpaid' : 'paid';
                                saveReg({ ...r, paymentStatus: newStatus }, `Marked ${r.childName} as ${newStatus} for ${r.date}`);
                              }} className={'px-2 py-1 rounded text-xs ' + (r.paymentStatus === 'paid' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700')}>
                                {r.paymentStatus || 'unpaid'}
                              </button>
                            </td>
                            <td className="p-2">
                              <button onClick={() => { saveReg({ ...r, status: 'cancelled', cancelledAt: new Date().toISOString() }, `Cancelled ${r.childName} for ${r.date}`); showToast('Cancelled'); }} className="text-red-600 text-sm">Cancel</button>
                            </td>
                          </tr>
                        ))}</tbody>
                      </table>
                    )}
                  </div>
                </div>
              )}

              {adminTab === 'counselors' && (
                <div>
                  <div className="flex justify-between items-center mb-4">
                    <div>
                      <h2 className="font-bold text-xl">Counselors</h2>
                      <p className="text-sm text-gray-500">Use arrows to reorder ‚Ä¢ Changes save automatically</p>
                    </div>
                    <button onClick={() => { setEditCounselor({ name: '', email: '', phone: '', position: '', year: '', bio: '', photo: null, visible: true }); setShowModal(true); }} className="bg-green-600 text-white px-4 py-2 rounded-lg">+ Add</button>
                  </div>
                  <div className="space-y-3">
                    {counselors.map((c, idx) => (
                      <div key={c.id} className="bg-white rounded-xl shadow p-4 flex items-center gap-4">
                        {/* Reorder buttons */}
                        <div className="flex flex-col gap-1">
                          <button
                            onClick={() => {
                              if (idx === 0) return;
                              const newOrder = [...counselors];
                              [newOrder[idx - 1], newOrder[idx]] = [newOrder[idx], newOrder[idx - 1]];
                              const reordered = newOrder.map((co, i) => ({ ...co, order: i }));
                              saveCounselors(reordered, `Moved ${c.name} up`);
                            }}
                            disabled={idx === 0}
                            className={'w-7 h-7 rounded flex items-center justify-center text-sm ' + (idx === 0 ? 'bg-gray-100 text-gray-300 cursor-not-allowed' : 'bg-gray-200 hover:bg-gray-300 text-gray-600')}
                            title="Move up"
                          >‚ñ≤</button>
                          <button
                            onClick={() => {
                              if (idx === counselors.length - 1) return;
                              const newOrder = [...counselors];
                              [newOrder[idx], newOrder[idx + 1]] = [newOrder[idx + 1], newOrder[idx]];
                              const reordered = newOrder.map((co, i) => ({ ...co, order: i }));
                              saveCounselors(reordered, `Moved ${c.name} down`);
                            }}
                            disabled={idx === counselors.length - 1}
                            className={'w-7 h-7 rounded flex items-center justify-center text-sm ' + (idx === counselors.length - 1 ? 'bg-gray-100 text-gray-300 cursor-not-allowed' : 'bg-gray-200 hover:bg-gray-300 text-gray-600')}
                            title="Move down"
                          >‚ñº</button>
                        </div>

                        {/* Position number */}
                        <div className="w-8 h-8 rounded-full bg-green-100 text-green-700 flex items-center justify-center font-bold text-sm">
                          {idx + 1}
                        </div>

                        {/* Photo */}
                        {c.photo ? <img src={c.photo} className="w-14 h-14 rounded-full object-cover" /> : <div className="w-14 h-14 rounded-full bg-green-200 flex items-center justify-center text-xl">{c.name[0]}</div>}

                        {/* Info */}
                        <div className="flex-1">
                          <div className="font-bold">{c.name}</div>
                          <div className="text-sm text-gray-600">{c.position} ‚Ä¢ {c.year}</div>
                          {!c.visible && <span className="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded">Hidden</span>}
                        </div>

                        {/* Actions */}
                        <button onClick={() => { setEditCounselor(c); setShowModal(true); }} className="px-3 py-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 text-sm">Edit</button>
                        <button onClick={() => { if (confirm('Delete ' + c.name + '?')) saveCounselors(counselors.filter(x => x.id !== c.id).map((co, i) => ({ ...co, order: i })), `Deleted counselor ${c.name}`); }} className="px-3 py-1 bg-red-50 text-red-600 rounded hover:bg-red-100 text-sm">Delete</button>
                      </div>
                    ))}
                  </div>
                  {counselors.length === 0 && (
                    <div className="text-center py-12 text-gray-500">
                      <p>No counselors yet. Click "+ Add" to add your first counselor.</p>
                    </div>
                  )}
                </div>
              )}

              {adminTab === 'content' && (
                <div className="space-y-6">
                  <div className="bg-green-100 border-l-4 border-green-600 p-4 rounded-lg">
                    <p className="text-green-800"><strong>Auto-save enabled:</strong> Changes are saved automatically when you click outside the field</p>
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold mb-4">Hero Section</h3>
                    <div className="grid md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Title</label>
                        <StableInput value={content.heroTitle} onSave={(v) => updateContent('heroTitle', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Subtitle</label>
                        <StableInput value={content.heroSubtitle} onSave={(v) => updateContent('heroSubtitle', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div className="md:col-span-2">
                        <label className="block text-sm text-gray-600 mb-1">Tagline</label>
                        <StableInput value={content.heroTagline} onSave={(v) => updateContent('heroTagline', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold mb-4">Details</h3>
                    <div className="grid md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Session Cost</label>
                        <StableInput value={content.sessionCost} onSave={(v) => updateContent('sessionCost', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Venmo Username</label>
                        <StableInput value={content.venmoUsername} onSave={(v) => updateContent('venmoUsername', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Morning Session</label>
                        <StableInput value={content.sessionMorning} onSave={(v) => updateContent('sessionMorning', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Afternoon Session</label>
                        <StableInput value={content.sessionAfternoon} onSave={(v) => updateContent('sessionAfternoon', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Camp Dates</label>
                        <StableInput value={content.campDates} onSave={(v) => updateContent('campDates', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Age Range</label>
                        <StableInput value={content.ageRange} onSave={(v) => updateContent('ageRange', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold mb-4">Contact</h3>
                    <div className="grid md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Email</label>
                        <StableInput value={content.contactEmail} onSave={(v) => updateContent('contactEmail', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">Phone</label>
                        <StableInput value={content.contactPhone} onSave={(v) => updateContent('contactPhone', v)} className="w-full px-3 py-2 border rounded-lg" />
                      </div>
                      <div className="md:col-span-2">
                        <label className="block text-sm text-gray-600 mb-1">Location Address</label>
                        <StableTextarea value={content.locationAddress} onSave={(v) => updateContent('locationAddress', v)} className="w-full px-3 py-2 border rounded-lg" rows={3} />
                      </div>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold mb-4">About</h3>
                    <label className="block text-sm text-gray-600 mb-1">About Text</label>
                    <StableTextarea value={content.aboutText} onSave={(v) => updateContent('aboutText', v)} className="w-full px-3 py-2 border rounded-lg" rows={4} />
                  </div>
                </div>
              )}

              {adminTab === 'parents' && (
                <ParentsTab
                  users={users}
                  registrations={registrations}
                  messages={messages}
                  onSendMessage={saveMessage}
                  onUpdateUsers={saveUsers}
                  onUpdateRegistrations={saveReg}
                  onDeleteRegistration={async (regId) => {
                    setRegistrations(registrations.filter(r => r.id !== regId));
                    await supabase.from('camp_registrations').delete().eq('id', regId);
                  }}
                  showToast={showToast}
                  addToHistory={addToHistory}
                />
              )}

              {adminTab === 'history' && (
                <div className="bg-white rounded-xl shadow p-6">
                  <h3 className="font-bold text-lg text-green-800 mb-4">üìú Change History</h3>
                  {changeHistory.length === 0 ? (
                    <p className="text-gray-500">No changes recorded yet</p>
                  ) : (
                    <div className="space-y-2 max-h-96 overflow-y-auto">
                      {changeHistory.map(entry => (
                        <div key={entry.id} className="flex items-start gap-3 p-3 border rounded-lg hover:bg-gray-50">
                          <div className="text-xs text-gray-400 whitespace-nowrap pt-0.5">
                            {formatTimestamp(entry.timestamp)}
                          </div>
                          <div>
                            <div className="font-medium text-gray-800">{entry.action}</div>
                            <div className="text-sm text-gray-600">{entry.details}</div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </div>

            <Modal isOpen={showModal} onClose={() => setShowModal(false)} title={editCounselor?.id ? 'Edit Counselor' : 'Add Counselor'}>
              {editCounselor && (
                <CounselorEditForm
                  counselor={editCounselor}
                  onSave={(form) => {
                    const isNew = !editCounselor.id;
                    const updated = isNew
                      ? [...counselors, { ...form, id: 'c_' + Date.now(), order: counselors.length }]
                      : counselors.map(c => c.id === editCounselor.id ? { ...form, id: editCounselor.id } : c);
                    const action = isNew ? `Added counselor ${form.name}` : `Updated ${form.name}`;
                    saveCounselors(updated, action);
                    setShowModal(false);
                  }}
                  onCancel={() => setShowModal(false)}
                />
              )}
            </Modal>
          </div>
        );
      };

      // ==================== PARENT ====================
      const Parent = () => {
        const [selectedDates, setSelectedDates] = useState({});
        const [expandedMonths, setExpandedMonths] = useState({});
        const [expandedWeeks, setExpandedWeeks] = useState({ 0: true });
        const [selectedChildren, setSelectedChildren] = useState([]);
        const [showConfirm, setShowConfirm] = useState(null);
        
        const myUser = users.find(u => u.email === user?.email) || user;
        const myChildren = myUser?.children || [];
        const myRegs = registrations.filter(r => r.parentEmail === user?.email && r.status !== 'cancelled');
        const venmoCode = generateVenmoCode(user?.name);
        
        const getAmountDue = () => myRegs.filter(r => r.status === 'approved' && r.paymentStatus !== 'paid').reduce((s, r) => s + (r.totalAmount || sessionCost), 0);
        
        const getMonthWeeks = () => {
          const months = {};
          CAMP_WEEKS.forEach((week, idx) => {
            const m = new Date(week.start + 'T12:00:00').getMonth();
            if (!months[m]) months[m] = { name: ['June', 'July', 'August'][m - 5], weeks: [] };
            months[m].weeks.push({ ...week, idx });
          });
          return months;
        };

        const toggleDate = (date, session) => {
          setSelectedDates(p => {
            const cur = p[date] || [];
            return { ...p, [date]: cur.includes(session) ? cur.filter(s => s !== session) : [...cur, session] };
          });
        };

        const calcTotal = () => Object.values(selectedDates).flat().length * sessionCost * Math.max(1, selectedChildren.length);

        const handleRegister = async () => {
          if (!selectedChildren.length) { showToast('Select children', 'error'); return; }
          const dates = Object.entries(selectedDates).filter(([, s]) => s.length);
          if (!dates.length) { showToast('Select sessions', 'error'); return; }
          
          for (const childId of selectedChildren) {
            const child = myChildren.find(c => c.id === childId);
            for (const [date, sessions] of dates) {
              await saveReg({
                id: `reg_${Date.now()}_${childId}_${date}`,
                childId, childName: child?.name,
                parentEmail: user?.email, parentName: user?.name,
                date, sessions,
                status: 'pending', paymentStatus: 'unpaid',
                totalAmount: sessions.length * sessionCost,
                registeredAt: new Date().toISOString()
              });
            }
          }
          
          setShowConfirm({ children: selectedChildren.map(id => myChildren.find(c => c.id === id)?.name), total: calcTotal(), venmoCode });
          setSelectedDates({});
          setSelectedChildren([]);
        };

        const addChild = async (child) => {
          const updated = { ...myUser, children: [...(myUser.children || []), { ...child, id: 'child_' + Date.now() }] };
          await saveUsers(users.map(u => u.email === myUser.email ? updated : u));
          showToast('Child added!');
        };

        return (
          <div className="min-h-screen bg-amber-50">
            <div className="bg-green-800 text-white py-4">
              <div className="max-w-6xl mx-auto px-4">
                <h1 className="font-display text-3xl">Parent Dashboard</h1>
                <p className="text-green-200">Welcome, {user?.name}</p>
              </div>
            </div>
            
            <div className="bg-white shadow">
              <div className="max-w-6xl mx-auto px-4 flex gap-1">
                {['dashboard', 'register', 'children', 'messages'].map(t => (
                  <button key={t} onClick={() => setParentTab(t)} className={'px-4 py-3 capitalize border-b-2 ' + (parentTab === t ? 'border-green-600 text-green-700 bg-green-50' : 'border-transparent text-gray-500')}>
                    {t === 'messages' ? 'üí¨ Messages' : t}
                    {t === 'messages' && getUnreadCount(user?.email) > 0 && (
                      <span className="ml-2 bg-red-500 text-white text-xs px-2 rounded-full">{getUnreadCount(user?.email)}</span>
                    )}
                  </button>
                ))}
              </div>
            </div>

            <div className="max-w-6xl mx-auto px-4 py-6">
              {parentTab === 'dashboard' && (
                <div className="space-y-6">
                  <div className={'rounded-xl shadow p-6 ' + (getAmountDue() > 0 ? 'bg-blue-50 border-2 border-blue-200' : 'bg-gray-50')}>
                    <h3 className="font-bold text-lg mb-4">Payment</h3>
                    <div className="grid md:grid-cols-2 gap-4 mb-4">
                      <div className="text-center"><p className="text-sm text-gray-600">Due</p><p className="text-2xl font-bold text-red-600">${getAmountDue()}</p></div>
                      <div className="text-center"><p className="text-sm text-gray-600">Your Code</p><p className="text-2xl font-bold text-blue-600">{venmoCode}</p></div>
                    </div>
                    <div className="bg-white rounded-lg p-4">
                      <p><strong>Venmo:</strong> {content.venmoUsername}</p>
                      <p className="text-sm text-gray-600">Include code: <span className="font-mono bg-gray-100 px-2 rounded">{venmoCode}</span></p>
                    </div>
                  </div>
                  
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold text-lg mb-4">My Registrations</h3>
                    {myRegs.length === 0 ? <p className="text-gray-500">None yet</p> : (
                      <div className="space-y-2">{myRegs.map(r => (
                        <div key={r.id} className="flex justify-between p-3 border rounded-lg">
                          <div>
                            <span className="font-medium">{r.childName}</span>
                            <span className="text-gray-500 ml-2">{r.date} ‚Ä¢ {r.sessions?.join(', ')}</span>
                          </div>
                          <div className="flex gap-2">
                            <span className={'px-2 py-0.5 rounded text-xs ' + (r.status === 'approved' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700')}>{r.status}</span>
                            <span className={'px-2 py-0.5 rounded text-xs ' + (r.paymentStatus === 'paid' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700')}>{r.paymentStatus || 'unpaid'}</span>
                          </div>
                        </div>
                      ))}</div>
                    )}
                  </div>
                </div>
              )}

              {parentTab === 'register' && (
                <div className="space-y-6">
                  <div className="bg-white rounded-xl shadow p-6">
                    <h3 className="font-bold text-lg mb-4">Select Children</h3>
                    {myChildren.length === 0 ? <p className="text-gray-500">Add children in the Children tab first</p> : (
                      <div className="flex flex-wrap gap-2">{myChildren.map(c => (
                        <button key={c.id} onClick={() => setSelectedChildren(p => p.includes(c.id) ? p.filter(x => x !== c.id) : [...p, c.id])} className={'px-4 py-2 rounded-lg border-2 ' + (selectedChildren.includes(c.id) ? 'border-green-600 bg-green-50' : 'border-gray-200')}>{c.name}</button>
                      ))}</div>
                    )}
                  </div>
                  
                  <div className="bg-white rounded-xl shadow p-6">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-bold text-lg">Select Dates</h3>
                      <div className="flex gap-2">
                        <button onClick={() => setExpandedMonths({ 5: true, 6: true, 7: true })} className="text-sm text-green-600">Expand All</button>
                        <button onClick={() => { setExpandedMonths({}); setExpandedWeeks({}); }} className="text-sm text-gray-500">Collapse All</button>
                      </div>
                    </div>
                    
                    {Object.entries(getMonthWeeks()).map(([mKey, { name, weeks }]) => (
                      <div key={mKey} className="mb-4">
                        <button onClick={() => setExpandedMonths(p => ({ ...p, [mKey]: !p[mKey] }))} className="w-full flex justify-between p-3 bg-green-100 rounded-lg font-bold text-green-800">
                          <span>{name}</span><span>{expandedMonths[mKey] ? '‚ñº' : '‚ñ∂'}</span>
                        </button>
                        {expandedMonths[mKey] && (
                          <div className="mt-2 pl-4 space-y-2">{weeks.map(({ idx, start, dates }) => (
                            <div key={idx}>
                              <button onClick={() => setExpandedWeeks(p => ({ ...p, [idx]: !p[idx] }))} className="w-full flex justify-between p-2 bg-gray-100 rounded-lg text-gray-700">
                                <span>Week {idx + 1}</span><span>{expandedWeeks[idx] ? '‚ñº' : '‚ñ∂'}</span>
                              </button>
                              {expandedWeeks[idx] && (
                                <div className="grid grid-cols-5 gap-2 mt-2 pl-4">{dates.map(date => {
                                  const d = new Date(date + 'T12:00:00');
                                  const sel = selectedDates[date] || [];
                                  return (
                                    <div key={date} className="border rounded-lg p-2 text-center">
                                      <div className="text-sm font-medium">{['Mon', 'Tue', 'Wed', 'Thu', 'Fri'][d.getDay() - 1]}</div>
                                      <div className="text-xs text-gray-500">{d.getDate()}</div>
                                      <div className="flex flex-col gap-1 mt-1">
                                        <button onClick={() => toggleDate(date, 'morning')} className={'px-2 py-1 rounded text-xs ' + (sel.includes('morning') ? 'bg-yellow-500 text-white' : 'bg-gray-200')}>AM</button>
                                        <button onClick={() => toggleDate(date, 'afternoon')} className={'px-2 py-1 rounded text-xs ' + (sel.includes('afternoon') ? 'bg-blue-500 text-white' : 'bg-gray-200')}>PM</button>
                                      </div>
                                    </div>
                                  );
                                })}</div>
                              )}
                            </div>
                          ))}</div>
                        )}
                      </div>
                    ))}
                  </div>
                  
                  <div className="bg-white rounded-xl shadow p-6">
                    <div className="text-2xl font-bold text-green-700 mb-4">Total: ${calcTotal()}</div>
                    <button onClick={handleRegister} disabled={!selectedChildren.length || !Object.values(selectedDates).flat().length} className="w-full bg-green-700 hover:bg-green-800 disabled:bg-gray-300 text-white font-bold py-3 rounded-lg">Submit Registration</button>
                  </div>
                </div>
              )}

              {parentTab === 'children' && (
                <div className="bg-white rounded-xl shadow p-6">
                  <h3 className="font-bold text-lg mb-4">My Children</h3>
                  {myChildren.length > 0 && (
                    <div className="space-y-4 mb-6">{myChildren.map(c => (
                      <ChildCard
                        key={c.id}
                        child={c}
                        onUpdate={(updatedChild) => {
                          const updated = { ...myUser, children: myUser.children.map(ch => ch.id === updatedChild.id ? updatedChild : ch) };
                          saveUsers(users.map(u => u.email === myUser.email ? updated : u));
                          showToast('Child updated!');
                        }}
                        onDelete={(childId) => {
                          const updated = { ...myUser, children: myUser.children.filter(ch => ch.id !== childId) };
                          saveUsers(users.map(u => u.email === myUser.email ? updated : u));
                          showToast('Child removed');
                        }}
                      />
                    ))}</div>
                  )}
                  <AddChildForm onAdd={addChild} />
                </div>
              )}

              {parentTab === 'messages' && (
                <ParentMessagesTab
                  userEmail={user?.email}
                  userName={user?.name}
                  messages={messages}
                  onSendReply={saveMessage}
                  markAsRead={markMessageRead}
                  showToast={showToast}
                />
              )}
            </div>

            {showConfirm && (
              <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                <div className="bg-white rounded-xl max-w-md w-full p-6 text-center">
                  <div className="text-6xl mb-4">‚úÖ</div>
                  <h2 className="font-display text-2xl text-green-800 mb-4">Registration Submitted!</h2>
                  <p className="mb-2">Children: {showConfirm.children?.join(', ')}</p>
                  <p className="text-2xl font-bold text-green-700 mb-4">Amount Due: ${showConfirm.total}</p>
                  <div className="bg-blue-50 rounded-lg p-4 mb-4">
                    <p className="font-medium">Venmo: {content.venmoUsername}</p>
                    <p className="text-sm">Code: <span className="font-mono bg-white px-2 rounded">{showConfirm.venmoCode}</span></p>
                  </div>
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                    <p className="text-sm text-yellow-800"><strong>‚ö†Ô∏è Spot not confirmed until:</strong></p>
                    <p className="text-sm text-yellow-700">‚úì Payment received AND ‚úì Admin approves</p>
                  </div>
                  <button onClick={() => { setShowConfirm(null); setParentTab('dashboard'); }} className="w-full bg-green-700 text-white font-bold py-3 rounded-lg">View Payment Info</button>
                </div>
              </div>
            )}
          </div>
        );
      };

      const AddChildForm = ({ onAdd, onCancel }) => {
        const [name, setName] = useState('');
        const [birthdate, setBirthdate] = useState('');
        const [grade, setGrade] = useState('');
        const [phone, setPhone] = useState('');
        const [photo, setPhoto] = useState(null);
        const [showCrop, setShowCrop] = useState(false);
        const [tempImg, setTempImg] = useState(null);
        const inputRef = useRef(null);

        const age = calculateAge(birthdate);

        const handleFile = (e) => {
          const file = e.target.files?.[0];
          if (file) {
            const reader = new FileReader();
            reader.onloadend = () => {
              setTempImg(reader.result);
              setShowCrop(true);
            };
            reader.readAsDataURL(file);
          }
          if (e.target) e.target.value = '';
        };

        const handleSubmit = () => {
          if (!name || !birthdate || !grade) return;
          onAdd({ name, birthdate, grade, phone, photo });
          setName(''); setBirthdate(''); setGrade(''); setPhone(''); setPhoto(null);
        };

        if (showCrop && tempImg) {
          return (
            <ImageCropper
              image={tempImg}
              onSave={(img) => { setPhoto(img); setShowCrop(false); }}
              onCancel={() => { setShowCrop(false); setTempImg(null); }}
            />
          );
        }

        return (
          <div className="border-t pt-4 space-y-4">
            <h4 className="font-medium text-lg">Add Child</h4>

            {/* Photo Upload with Face Silhouette Placeholder */}
            <div className="flex justify-center">
              {photo ? (
                <div className="relative">
                  <img src={photo} className="w-24 h-24 rounded-full object-cover border-2 border-green-600" />
                  <button onClick={() => inputRef.current?.click()}
                    className="absolute -bottom-1 -right-1 w-8 h-8 bg-green-600 rounded-full text-white flex items-center justify-center text-sm">‚úé</button>
                  <button onClick={() => setPhoto(null)}
                    className="absolute -top-1 -right-1 w-6 h-6 bg-red-500 rounded-full text-white text-xs flex items-center justify-center">√ó</button>
                </div>
              ) : (
                <div
                  onClick={() => inputRef.current?.click()}
                  className="w-24 h-24 rounded-full bg-gray-200 border-2 border-dashed border-gray-400 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300"
                >
                  <svg className="w-10 h-10 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                  </svg>
                  <span className="text-xs text-gray-500 mt-1">Add Photo</span>
                </div>
              )}
              <input ref={inputRef} type="file" accept="image/*" onChange={handleFile} className="hidden" />
            </div>
            <p className="text-xs text-gray-500 text-center">Photo helps us recognize your child at camp</p>

            {/* Name */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Child's Name *</label>
              <input value={name} onChange={e => setName(e.target.value)}
                className="w-full px-3 py-2 border rounded-lg" placeholder="Full name"
                autoComplete="off" data-1p-ignore="true" data-lpignore="true" data-form-type="other" />
            </div>

            {/* Birthdate & Calculated Age */}
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Birthdate *</label>
                <input type="date" value={birthdate} onChange={e => setBirthdate(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg"
                  max={new Date().toISOString().split('T')[0]} data-1p-ignore="true" data-lpignore="true" data-form-type="other" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Age</label>
                <div className="w-full px-3 py-2 border rounded-lg bg-gray-50 text-gray-700">
                  {age !== null ? `${age} years old` : 'Select birthdate'}
                </div>
              </div>
            </div>

            {/* Grade */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Grade (Fall 2026) *</label>
              <select value={grade} onChange={e => setGrade(e.target.value)}
                className="w-full px-3 py-2 border rounded-lg">
                <option value="">Select grade</option>
                <option value="3rd">3rd Grade</option>
                <option value="4th">4th Grade</option>
                <option value="5th">5th Grade</option>
                <option value="6th">6th Grade</option>
                <option value="7th">7th Grade</option>
                <option value="8th">8th Grade</option>
              </select>
            </div>

            {/* Phone (optional) */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Child's Phone <span className="text-gray-400">(optional)</span>
              </label>
              <input value={phone} onChange={e => setPhone(formatPhone(e.target.value))}
                className="w-full px-3 py-2 border rounded-lg" placeholder="(555) 555-1234"
                autoComplete="off" data-1p-ignore="true" data-lpignore="true" data-form-type="other" />
              <p className="text-xs text-gray-500 mt-1">If your child has a phone for emergencies</p>
            </div>

            {/* Buttons */}
            <div className="flex gap-4 pt-4">
              {onCancel && <button onClick={onCancel} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>}
              <button onClick={handleSubmit} disabled={!name || !birthdate || !grade}
                className="flex-1 py-2 bg-green-600 text-white rounded-lg disabled:bg-gray-300 hover:bg-green-700 disabled:hover:bg-gray-300">
                Add Child
              </button>
            </div>
          </div>
        );
      };

      // ==================== CHILD CARD ====================
      const ChildCard = ({ child, onUpdate, onDelete }) => {
        const inputRef = useRef(null);
        const [tempImg, setTempImg] = useState(null);
        const [showCrop, setShowCrop] = useState(false);
        const [isEditing, setIsEditing] = useState(false);
        const [editForm, setEditForm] = useState({ ...child });
        const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
        const age = calculateAge(child.birthdate);

        const handleFile = (e) => {
          const file = e.target.files?.[0];
          if (file) {
            const reader = new FileReader();
            reader.onloadend = () => { setTempImg(reader.result); setShowCrop(true); };
            reader.readAsDataURL(file);
          }
          if (e.target) e.target.value = '';
        };

        const handleSaveEdit = () => {
          if (!editForm.name || !editForm.birthdate || !editForm.grade) return;
          onUpdate({ ...child, ...editForm });
          setIsEditing(false);
        };

        const handleCancelEdit = () => {
          setEditForm({ ...child });
          setIsEditing(false);
        };

        if (showCrop && tempImg) {
          return (
            <div className="border rounded-lg p-4">
              <ImageCropper
                image={tempImg}
                onSave={(img) => {
                  if (isEditing) {
                    setEditForm({ ...editForm, photo: img });
                  } else {
                    onUpdate({ ...child, photo: img });
                  }
                  setShowCrop(false);
                }}
                onCancel={() => { setShowCrop(false); setTempImg(null); }}
              />
            </div>
          );
        }

        // Delete confirmation dialog
        if (showDeleteConfirm) {
          return (
            <div className="border-2 border-red-300 bg-red-50 rounded-lg p-4">
              <div className="text-center">
                <div className="text-4xl mb-2">‚ö†Ô∏è</div>
                <h4 className="font-bold text-red-800 mb-2">Delete {child.name}?</h4>
                <p className="text-sm text-red-600 mb-4">
                  This will permanently remove this child from your account.
                  Any existing registrations will remain in the system.
                </p>
                <div className="flex gap-3 justify-center">
                  <button
                    onClick={() => setShowDeleteConfirm(false)}
                    className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={() => { onDelete(child.id); setShowDeleteConfirm(false); }}
                    className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                  >
                    Yes, Delete
                  </button>
                </div>
              </div>
            </div>
          );
        }

        // Edit mode
        if (isEditing) {
          return (
            <div className="border-2 border-blue-300 bg-blue-50 rounded-lg p-4">
              <h4 className="font-bold text-blue-800 mb-4">‚úèÔ∏è Edit Child Details</h4>

              {/* Photo */}
              <div className="flex justify-center mb-4">
                {editForm.photo ? (
                  <div className="relative">
                    <img src={editForm.photo} className="w-20 h-20 rounded-full object-cover border-2 border-blue-400" />
                    <button onClick={() => inputRef.current?.click()}
                      className="absolute -bottom-1 -right-1 w-6 h-6 bg-blue-600 rounded-full text-white text-xs flex items-center justify-center">‚úé</button>
                    <button onClick={() => setEditForm({ ...editForm, photo: null })}
                      className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-white text-xs flex items-center justify-center">√ó</button>
                  </div>
                ) : (
                  <div onClick={() => inputRef.current?.click()}
                    className="w-20 h-20 rounded-full bg-gray-200 border-2 border-dashed border-gray-400 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300">
                    <svg className="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    <span className="text-xs text-gray-500">Add</span>
                  </div>
                )}
                <input ref={inputRef} type="file" accept="image/*" onChange={handleFile} className="hidden" />
              </div>

              <div className="space-y-3">
                {/* Name */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                  <input
                    value={editForm.name || ''}
                    onChange={e => setEditForm({ ...editForm, name: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                    placeholder="Child's name"
                    autoComplete="off"
                    data-1p-ignore="true"
                  />
                </div>

                {/* Birthdate & Age */}
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Birthdate *</label>
                    <input
                      type="date"
                      value={editForm.birthdate || ''}
                      onChange={e => setEditForm({ ...editForm, birthdate: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg"
                      max={new Date().toISOString().split('T')[0]}
                      data-1p-ignore="true"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Age</label>
                    <div className="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-700">
                      {calculateAge(editForm.birthdate) !== null ? `${calculateAge(editForm.birthdate)} years old` : 'Select birthdate'}
                    </div>
                  </div>
                </div>

                {/* Grade */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Grade (Fall 2026) *</label>
                  <select
                    value={editForm.grade || ''}
                    onChange={e => setEditForm({ ...editForm, grade: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="">Select grade</option>
                    <option value="3rd">3rd Grade</option>
                    <option value="4th">4th Grade</option>
                    <option value="5th">5th Grade</option>
                    <option value="6th">6th Grade</option>
                    <option value="7th">7th Grade</option>
                    <option value="8th">8th Grade</option>
                  </select>
                </div>

                {/* Phone */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Child's Phone (optional)</label>
                  <input
                    value={editForm.phone || ''}
                    onChange={e => setEditForm({ ...editForm, phone: formatPhone(e.target.value) })}
                    className="w-full px-3 py-2 border rounded-lg"
                    placeholder="(555) 555-1234"
                    autoComplete="off"
                    data-1p-ignore="true"
                  />
                </div>

                {/* Buttons */}
                <div className="flex gap-3 pt-2">
                  <button onClick={handleCancelEdit} className="flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                    Cancel
                  </button>
                  <button
                    onClick={handleSaveEdit}
                    disabled={!editForm.name || !editForm.birthdate || !editForm.grade}
                    className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300"
                  >
                    Save Changes
                  </button>
                </div>
              </div>
            </div>
          );
        }

        // Normal display mode
        return (
          <div className="border rounded-lg p-4 flex items-start gap-4">
            {/* Photo with edit button or face placeholder */}
            <div className="flex-shrink-0">
              {child.photo ? (
                <div className="relative">
                  <img src={child.photo} className="w-20 h-20 rounded-full object-cover border-2 border-green-600" />
                  <button onClick={() => inputRef.current?.click()}
                    className="absolute -bottom-1 -right-1 w-6 h-6 bg-green-600 rounded-full text-white text-xs flex items-center justify-center">‚úé</button>
                </div>
              ) : (
                <div onClick={() => inputRef.current?.click()}
                  className="w-20 h-20 rounded-full bg-gray-200 border-2 border-dashed border-gray-400 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-300">
                  <svg className="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                  </svg>
                  <span className="text-xs text-gray-500">Add</span>
                </div>
              )}
              <input ref={inputRef} type="file" accept="image/*" onChange={handleFile} className="hidden" />
            </div>

            {/* Info */}
            <div className="flex-1">
              <div className="font-bold text-lg">{child.name}</div>
              <div className="text-sm text-gray-600 space-y-1">
                {child.grade && <div>Grade: {child.grade}</div>}
                {child.birthdate && (
                  <div>
                    Birthday: {new Date(child.birthdate + 'T12:00:00').toLocaleDateString()}
                    {age !== null && <span className="text-green-600 font-medium"> ({age} years old)</span>}
                  </div>
                )}
                {child.phone && <div>Phone: {child.phone}</div>}
              </div>
            </div>

            {/* Action buttons */}
            <div className="flex flex-col gap-2">
              <button
                onClick={() => { setEditForm({ ...child }); setIsEditing(true); }}
                className="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 text-sm"
              >
                ‚úèÔ∏è Edit
              </button>
              <button
                onClick={() => setShowDeleteConfirm(true)}
                className="px-3 py-1.5 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 text-sm"
              >
                üóëÔ∏è Delete
              </button>
            </div>
          </div>
        );
      };

      // ==================== COUNSELOR ====================
      const CounselorDash = () => {
        const [month, setMonth] = useState(5);
        const myAvail = availability[user?.email] || {};
        
        const getMonthDates = (m) => CAMP_DATES.filter(d => new Date(d + 'T12:00:00').getMonth() === m);
        
        const getState = (date, session) => {
          const data = myAvail[date];
          if (!data) return null;
          if (data.available?.includes(session)) return 'available';
          if (data.unavailable?.includes(session)) return 'unavailable';
          if (Array.isArray(data) && data.includes(session)) return 'available';
          return null;
        };

        const cycle = async (date, session) => {
          const newAvail = JSON.parse(JSON.stringify(myAvail));
          const state = getState(date, session);
          
          if (!newAvail[date] || Array.isArray(newAvail[date])) {
            newAvail[date] = { available: Array.isArray(newAvail[date]) ? [...newAvail[date]] : [], unavailable: [] };
          }
          
          if (state === null) {
            newAvail[date].available.push(session);
          } else if (state === 'available') {
            newAvail[date].available = newAvail[date].available.filter(s => s !== session);
            newAvail[date].unavailable.push(session);
          } else {
            newAvail[date].unavailable = newAvail[date].unavailable.filter(s => s !== session);
          }
          
          if (!newAvail[date].available?.length && !newAvail[date].unavailable?.length) delete newAvail[date];
          
          await saveAvail({ ...availability, [user?.email]: newAvail });
        };

        return (
          <div className="min-h-screen bg-amber-50">
            <div className="bg-green-800 text-white py-4">
              <div className="max-w-6xl mx-auto px-4">
                <h1 className="font-display text-3xl">Counselor Dashboard</h1>
                <p className="text-green-200">Welcome, {user?.name}</p>
              </div>
            </div>
            
            <div className="max-w-6xl mx-auto px-4 py-6">
              <div className="bg-green-100 border-l-4 border-green-600 p-4 rounded-lg mb-6">
                <p className="text-green-800"><strong>Set availability:</strong> Click to cycle: Available (green) ‚Üí Unavailable (red) ‚Üí Not set (gray)</p>
              </div>
              
              <div className="flex gap-2 mb-6">
                {[{ m: 5, n: 'June' }, { m: 6, n: 'July' }, { m: 7, n: 'August' }].map(({ m, n }) => (
                  <button key={m} onClick={() => setMonth(m)} className={'px-6 py-2 rounded-lg font-medium ' + (month === m ? 'bg-green-600 text-white' : 'bg-white border border-green-600 text-green-700')}>{n}</button>
                ))}
              </div>
              
              <div className="bg-white rounded-xl shadow p-6">
                <div className="grid grid-cols-5 gap-3">
                  {['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].map(d => <div key={d} className="text-center font-bold text-green-800">{d}</div>)}
                  {getMonthDates(month).map(date => {
                    const d = new Date(date + 'T12:00:00');
                    const mState = getState(date, 'morning');
                    const aState = getState(date, 'afternoon');
                    const style = (s) => s === 'available' ? 'bg-green-500 text-white' : s === 'unavailable' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-600';
                    return (
                      <div key={date} className="border rounded-lg p-2">
                        <div className="text-center font-bold text-green-800 mb-2">{d.getDate()}</div>
                        <button onClick={() => cycle(date, 'morning')} className={'w-full py-1 rounded text-xs mb-1 ' + style(mState)}>AM</button>
                        <button onClick={() => cycle(date, 'afternoon')} className={'w-full py-1 rounded text-xs ' + style(aState)}>PM</button>
                      </div>
                    );
                  })}
                </div>
                <div className="mt-4 flex gap-4 justify-center text-sm">
                  <div className="flex items-center gap-2"><div className="w-4 h-4 bg-green-500 rounded" />Available</div>
                  <div className="flex items-center gap-2"><div className="w-4 h-4 bg-red-500 rounded" />Unavailable</div>
                  <div className="flex items-center gap-2"><div className="w-4 h-4 bg-gray-200 rounded" />Not Set</div>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // ==================== ROUTER ====================
      if (loading) return <div className="min-h-screen bg-green-50 flex items-center justify-center"><div className="text-6xl">üèÄ</div></div>;

      return (
        <div className="min-h-screen bg-gray-50">
          <VersionBanner isVisible={isDevEnv || showBanner} isDev={isDevEnv} />
          <Nav />
          {toast && <Toast message={toast.msg} type={toast.type} onDone={() => setToast(null)} />}
          {page === 'home' && <Home />}
          {page === 'schedule' && <Schedule />}
          {page === 'location' && <Location />}
          {page === 'counselors' && <Counselors />}
          {page === 'login' && <Login />}
          {page === 'admin' && user?.role === 'admin' && <Admin />}
          {page === 'parent' && user?.role === 'parent' && <Parent />}
          {page === 'counselor' && user?.role === 'counselor' && <CounselorDash />}
          <footer className="bg-gray-800 text-white py-6 text-center">¬© 2026 Roosevelt High School Girls Basketball</footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<RooseveltCamp />);
  </script>
</body>
</html>
